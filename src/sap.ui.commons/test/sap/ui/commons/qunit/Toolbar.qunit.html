<!DOCTYPE HTML>

<!--
  Tested control/class: sap.ui.commons.Toolbar
  Author: d046011
-->

<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

	<title>Test Page for sap.ui.commons.Toolbar</title>

	<script id="sap-ui-bootstrap"
		      type="text/javascript"
		      src="../../../../../resources/sap-ui-core.js"
		      data-sap-ui-theme="sap_bluecrystal"
		      data-sap-ui-noConflict="true"
		      data-sap-ui-libs="sap.ui.layout,sap.ui.commons">
	</script>
	<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script type="text/javascript">

		// ==================================================
		// test fixture for control properties and events
		// ==================================================
		var bVisible=true,
			iWidth = 300,
			sWidth = iWidth + "px",
			oDesign = sap.ui.commons.ToolbarDesign.Flat,
			bStandalone = true;


		var oToolbar = new sap.ui.commons.Toolbar("Toolbar", {
			visible:bVisible,
			width:sWidth,
			design:oDesign,
			standalone:bStandalone
		});

		oToolbar.placeAt("content");

		var oCtrl;
		function initToolbar() {
			oCtrl.setVisible(bVisible);
			oCtrl.setWidth(sWidth);
			oCtrl.setDesign(oDesign);
			oCtrl.setStandalone(bStandalone);
			oCtrl.destroyItems();// because the same control is used again instead of creating a new Toolbar for each test
			sap.ui.getCore().applyChanges();
		}
		module("Basic", {

			setup: function() {
				oCtrl = sap.ui.getCore().getControl("Toolbar");
				ok(oCtrl);
				ok(jQuery.sap.domById("Toolbar"));
				initToolbar();
			},
			teardown: function() {
				oCtrl = null;
			}
		});

		// ==================================================
		// test property accessor methods
		// ==================================================


		/**
		 * Tests accessor method for property visible of control Toolbar.
		 */
		test("VisibleOk", function() {
			strictEqual(oCtrl.getVisible(), bVisible);
		});

		/**
		 * Tests accessor method for property width of control Toolbar.
		 */
		test("WidthOk", function() {
			strictEqual(oCtrl.getWidth(), sWidth);
		});

		/**
		 * Tests accessor method for property design of control Toolbar.
		 */
		test("DesignOk", function() {
			strictEqual(oCtrl.getDesign(), oDesign);
		});

		/**
		 * Tests accessor method for property standalone of control Toolbar.
		 */
		test("StandaloneOk", function() {
			strictEqual(oCtrl.getStandalone(), bStandalone);
		});


		// ==================================================
		// better tests of properties
		// ==================================================

		/**
		 * Test actual visibility
		 */
		test("Visibility", function() {
			ok(jQuery.sap.domById("Toolbar"), "Toolbar should exist in page");
			oCtrl.setVisible(false);
			sap.ui.getCore().applyChanges();
			equal(jQuery.sap.domById("Toolbar"), null, "Toolbar should not be rendered when set to invisible");
			oCtrl.setVisible(true);
			sap.ui.getCore().applyChanges();
			ok(jQuery.sap.domById("Toolbar"), "Toolbar should exist in page");
		});

		/**
		 * Test actual width
		 */
		test("Width", function() {
			strictEqual(jQuery.sap.domById("Toolbar").offsetWidth, iWidth, "actual width is wrong");
			oCtrl.setWidth("401px");
			sap.ui.getCore().applyChanges();
			strictEqual(jQuery.sap.domById("Toolbar").offsetWidth, 401, "actual width is wrong after change");
			oCtrl.setWidth(sWidth);
			sap.ui.getCore().applyChanges();
			strictEqual(jQuery.sap.domById("Toolbar").offsetWidth, iWidth, "actual width is wrong after change");
		});

		/**
		 * Test Toolbar designs
		 */
		test("ToolbarDesigns", function() {
			var oRootDomRef = jQuery.sap.domById("Toolbar");

			// make sure the initial design is "Flat"
			notStrictEqual(oRootDomRef.className.indexOf("sapUiTbDesignFlat"), -1, "Panel must have sapUiTbDesignFlat");
			strictEqual(oRootDomRef.className.indexOf("sapUiTbDesignTransparent"), -1, "Panel must not have sapUiTbDesignTransparent");
			strictEqual(oRootDomRef.className.indexOf("sapUiTbDesignStandard"), -1, "Panel must not have sapUiTbDesignStandard");

			// now switch to "Transparent" and do the same tests
			oCtrl.setDesign(sap.ui.commons.ToolbarDesign.Transparent);
			sap.ui.getCore().applyChanges();
			var oRootDomRef2 = jQuery.sap.domById(oCtrl.getId());

			// make sure the change worked
			notStrictEqual(oRootDomRef2.className.indexOf("sapUiTbDesignTransparent"), -1, "Panel must have sapUiTbDesignTransparent");
			strictEqual(oRootDomRef2.className.indexOf("sapUiTbDesignFlat"), -1, "Panel must not have sapUiTbDesignFlat");
			strictEqual(oRootDomRef2.className.indexOf("sapUiTbDesignStandard"), -1, "Panel must not have sapUiTbDesignStandard");

			// make sure it is actually transparent
			strictEqual(normalizeColor(jQuery(oRootDomRef2).css("backgroundColor")), "rgba(0,0,0,0)", "Panel root must be transparent");
			strictEqual(normalizeColor(jQuery(oRootDomRef2.firstChild).css("backgroundColor")), "rgba(0,0,0,0)", "Panel firstChild must be transparent");
			strictEqual(normalizeColor(jQuery(oRootDomRef2.firstChild.firstChild).css("backgroundColor")), "rgba(0,0,0,0)", "Panel second-level child must be transparent");

			// now switch back to "Flat"
			oCtrl.setDesign(sap.ui.commons.ToolbarDesign.Flat);
			sap.ui.getCore().applyChanges();
			var oRootDomRef3 = jQuery.sap.domById(oCtrl.getId());

			// make sure the design is "Flat" again
			notStrictEqual(oRootDomRef3.className.indexOf("sapUiTbDesignFlat"), -1, "Panel must have sapUiTbDesignFlat");
			strictEqual(oRootDomRef3.className.indexOf("sapUiTbDesignTransparent"), -1, "Panel must not have sapUiTbDesignTransparent");
			strictEqual(oRootDomRef3.className.indexOf("sapUiTbDesignStandard"), -1, "Panel must not have sapUiTbDesignStandard");
		});

		/**
		 * Test standalone mode
		 */
		test("StandaloneMode", function() {
			// make sure the class sapUiTbStandalone is there
			notStrictEqual(jQuery.sap.domById("Toolbar").className.indexOf("sapUiTbStandalone"), -1, "Panel must have sapUiTbStandalone");

			// now switch to not-standalone mode
			oCtrl.setStandalone(false);
			sap.ui.getCore().applyChanges();
			strictEqual(jQuery.sap.domById("Toolbar").className.indexOf("sapUiTbStandalone"), -1, "Panel must not have sapUiTbStandalone");

			// ...and back again
			oCtrl.setStandalone(true);
			sap.ui.getCore().applyChanges();
			notStrictEqual(jQuery.sap.domById("Toolbar").className.indexOf("sapUiTbStandalone"), -1, "Panel must have sapUiTbStandalone");
		});


		// ==================================================
//		          test "Items" aggregation
		// ==================================================

		test("InitialItems", function() {
			strictEqual(oCtrl.getItems().length, 0, "Toolbar may not have any items initially");
		});

		test("AddOneItem", function() {
			var oBtn = new sap.ui.commons.Button("testButton", {"text":"Test"});
			oCtrl.addItem(oBtn);
			strictEqual(oCtrl.getItems().length, 1, "Toolbar does not have the added item");
			strictEqual(oCtrl.getItems()[0].getId(), "testButton", "Toolbar does not have the added item");
		});

		test("TolerantTypeCheckForItems", function() {
			var oItem = new sap.ui.layout.HorizontalLayout();
			oCtrl.addItem(oItem);
			oCtrl.removeItem(oItem);
			// the above simply must not throw exceptions
			// assertions could be checked but optimizer might remove them
			ok(true, "must not throw exception for aggregations with interface types");
			oItem.destroy();
			sap.ui.getCore().applyChanges();
		});

		/**
		 * Test how the toolbar adapts to its surroundings (width-wise)
		 */
		test("ToolbarAssumesOuterWidth", function() {
			var uiArea = jQuery.sap.domById("content");
			uiArea.style.width = "600px"; // make the parent div have a defined size

			// check whether the "auto"-mode toolbar adapts to the parent
			oCtrl.setWidth("auto");
			sap.ui.getCore().applyChanges();
			strictEqual(oCtrl.getDomRef().offsetWidth, 600, "Toolbar width should be adapted to parent DOM element");

			// clean up
			uiArea.style.width = "auto";
			oCtrl.setWidth(sWidth);
			sap.ui.getCore().applyChanges();
		});

		test("Inner toolbar container has id", function() {
			var sExpectedId = oCtrl.getId() + "-inner";
			ok(document.getElementById(sExpectedId), "The inner container must has an id [" + sExpectedId + "]");
		});

		// ==================================================
		// async1_addItems
		// ==================================================

		module("Overflow by addItems", {
			setup: function() {
				oCtrl = sap.ui.getCore().getControl("Toolbar");
				notStrictEqual(oCtrl, null, "oCtrl must exist");
				notStrictEqual(jQuery.sap.domById("Toolbar"), null, "Toolbar DomRef must exist");
				initToolbar();
			},
			teardown: function() {
				oCtrl = null;
			}
		});

		/**
		 * Toolbar is 300px(sWidth) wide; add one button of 100px width (which will not cause overflow for reasonable margins etc.)
		 */
		test("AddItemsUntilOverflowButtonAppears", function(assert) {
			var done = assert.async();
			oCtrl = sap.ui.getCore().getControl("Toolbar");
			notStrictEqual(oCtrl, null, "oCtrl must exist");

			strictEqual(oCtrl.getDomRef().offsetWidth, iWidth, "Toolbar width is wrong");
			setTimeout(function() {
				verifyOverflowButtonIsNotVisible("none", "Overflow button may not be visible initially");

				// add a button that surely fits
				var oBtn = new sap.ui.commons.Button("testButton", {"text":"Test","width":"100px"});
				oCtrl.addItem(oBtn);
				sap.ui.getCore().applyChanges();
				setTimeout(function() {
					verifyOverflowButtonIsNotVisible("Overflow button may not be visible with only one small item in the toolbar");
					done();
				}, 100);
			}, 400);
		});

		test("AddItemsUntilOverflowButtonAppears2", function(assert) {
			var done = assert.async();
			var oBtn1 = new sap.ui.commons.Button("testButton1", {"text":"Test","width":"100px"});
			// add a large button that surely causes overflow
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"201px"});
			oCtrl.addItem(oBtn1);
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsVisible("block", "Overflow button must be visible when the items are larger than the toolbar width");
				done();
			}, 100);
		});

		test("AddItemsUntilOverflowButtonAppears2_InvisibleItemsDontCount", function(assert) {
			var done = assert.async();
			var oBtn1 = new sap.ui.commons.Button("testButton1", {"text":"Test","width":"100px"});
			// add a large button that would have caused overflow if not invisible
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"201px", "visible" : false});
			oCtrl.addItem(oBtn1);
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsNotVisible("Overflow button must not be visible when adding invisible item(s)");
				done();
			}, 100);
		});

		test("AddItemsUntilOverflowButtonAppears3", function(assert) {
			var done = assert.async();
			// remove last item again
			var oBtn1 = new sap.ui.commons.Button("testButton1", {"text":"Test","width":"100px"});
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"201px"});
			oCtrl.addItem(oBtn1);
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			oCtrl.removeItem(1);
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsNotVisible("Overflow button may not be visible after removing the long button");
				oBtn2.destroy();
				sap.ui.getCore().applyChanges();
				setTimeout(function() {
					done();
				}, 100);
			}, 100);
		});

		// ==================================================
		// async2_resize
		// ==================================================

		module("Overflow due to resizing", {
			setup: function() {
				oCtrl = sap.ui.getCore().getControl("Toolbar");
				notStrictEqual(oCtrl, null, "oCtrl must exist");
				notStrictEqual(jQuery.sap.domById("Toolbar"), null, "Toolbar DomRef must exist");
				initToolbar();
			},
			teardown: function() {
				oCtrl = null;
			}
		});


		/**
		 * Toolbar is 300px (sWidth) wide; add two buttons of 75px width (which will not cause overflow for reasonable margins etc.)
		 * and then resize the toolbar to 199px width, which should trigger the overflow.
		 */
		test("ResizeUntilOverflowButtonAppears", function(assert) {
			var done = assert.async();
			oCtrl = sap.ui.getCore().getControl("Toolbar");
			ok(oCtrl);

			strictEqual(oCtrl.getDomRef().offsetWidth, iWidth, "Toolbar width is wrong");
			verifyOverflowButtonIsNotVisible("Overflow button may not be visible initially");

			// add two buttons that surely fit
			var oBtn = new sap.ui.commons.Button("testButton", {"text":"Test","width":"75px"});
			oCtrl.addItem(oBtn);
			oBtn = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"75px"});
			oCtrl.addItem(oBtn);
			sap.ui.getCore().applyChanges();

			setTimeout(function() {
				verifyOverflowButtonIsNotVisible("Overflow button must not be visible with only two small items in the toolbar");
				done();
			}, 10);
		});

		test("ResizeUntilOverflowButtonAppears2", function(assert) {
			var done = assert.async();
			var oBtn1 = new sap.ui.commons.Button("testButton1", {"text":"Test","width":"75px"});
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"75px"});
			oCtrl.addItem(oBtn1);
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			// resize toolbar to cause overflow
			oCtrl.setWidth("149px");
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsVisible("Overflow button must be visible when the toolbar is resized to a very small size");
				done();
			}, 10);
		});


		test("ResizeUntilOverflowButtonAppears2_InvisibleItemsDontCount", function(assert) {
			var done = assert.async();
			var oBtn1 = new sap.ui.commons.Button("testButton1", {"text":"Test","width":"75px"});
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"75px", "visible" : false});
			oCtrl.addItem(oBtn1);
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			// resize toolbar to cause overflow
			oCtrl.setWidth("149px");
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsNotVisible("Overflow button must not be visible when the toolbar is resized to a size less than total width of all buttons, but larger than total width of visible items only");
				done();
			}, 10);
		});

		test("ResizeUntilOverflowButtonAppears3", function(assert) {
			var done = assert.async();
			var oBtn1 = new sap.ui.commons.Button("testButton1", {"text":"Test","width":"75px"});
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"75px"});
			oCtrl.setWidth("149px");
			oCtrl.addItem(oBtn1);
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			// resize again to avoid overflow
			oCtrl.setWidth(sWidth);
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsNotVisible("Overflow button may not be visible with only two small items in the toolbar");
				setTimeout(function() {
					done();
				}, 100);
			}, 10);
		});

		test("ResizeUntilOverflowButtonAppears3_ToolbarFullHeightSeparatorAtTheBeggining", function(assert) {
			var done = assert.async();
			oCtrl.setWidth("149px");
			var oToolbarSeparator = new sap.ui.commons.ToolbarSeparator({design : sap.ui.commons.ToolbarSeparatorDesign.FullHeight});
			var oBtn1 = new sap.ui.commons.Button("testButton1", {"text":"Test","width":"75px"});
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"75px", "visible" : false});
			oCtrl.addItem(oToolbarSeparator);
			oCtrl.addItem(oBtn1);
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			// resize again to avoid overflow
			oCtrl.setWidth(sWidth);
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsNotVisible("Overflow button may not be visible with one full height separator and two small buttons in the toolbar");
				setTimeout(function() {
					done();
				}, 100);
			}, 450);
		});

		// ==================================================
		// async3_outerWidth
		// ==================================================

		module("outerWidth", {
			setup: function () {
				oCtrl = sap.ui.getCore().getControl("Toolbar");
				notStrictEqual(oCtrl, null, "oCtrl must exist");
				notStrictEqual(jQuery.sap.domById("Toolbar"), null, "Toolbar DomRef must exist");
				initToolbar();
			},
			teardown: function () {
				oCtrl = null;
			}
		});

		/**
		 * Test how the toolbar adapts to size changes of the surroundings (width-wise) and updates the overflow button
		 */
		test("ToolbarAdaptsToOuterWidthAndUpdates", function(assert) {
			var done = assert.async();
			oCtrl = sap.ui.getCore().getControl("Toolbar");
			ok(oCtrl);
			var uiArea = jQuery.sap.domById("content");

			uiArea.style.width = "600px"; // make the parent div have a defined size
			var oBtn = new sap.ui.commons.Button("testButton", {"text":"Test","width":"100px"});
			oCtrl.addItem(oBtn);
			oBtn = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"100px"});
			oCtrl.addItem(oBtn);

			// check whether the "auto"-mode toolbar adapts to the parent and the overflow button is not visible
			oCtrl.setWidth("auto");
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				strictEqual(oCtrl.getDomRef().offsetWidth, 600, "Toolbar width should be adapted to parent DOM element");
				strictEqual(getOverflowDomRef().style.display, "none", "Overflow button may not be visible with only two small items in the toolbar");
				done();
			}, 350);
		});

		test("ToolbarAdaptsToOuterWidthAndUpdates2", function(assert) {
			var done = assert.async();
			oCtrl.setWidth("auto");
			var uiArea = jQuery.sap.domById("content");
			var oBtn1 = new sap.ui.commons.Button("testButton", {"text":"Test","width":"100px"});
			oCtrl.addItem(oBtn1);
			var oBtn2 = new sap.ui.commons.Button("testButton2", {"text":"Test","width":"100px"});
			oCtrl.addItem(oBtn2);
			sap.ui.getCore().applyChanges();
			// make the parent smaller, check toolbar size and visibility of (then required) overflow button
			uiArea.style.width = "199px";

			setTimeout(function() {
					strictEqual(oCtrl.getDomRef().offsetWidth, 199, "Toolbar width should be in sync with parent DOM element");
					strictEqual(getOverflowDomRef().style.display, "block", "Overflow button must be visible once parent has become too small");
					done();
				}, 450);
		});

		// ==================================================
		// async5_overflowMenu
		// ==================================================

		module("Overflow Menu", {
			setup: function () {
				oCtrl = sap.ui.getCore().getControl("Toolbar");
				notStrictEqual(oCtrl, null, "oCtrl must exist");
				notStrictEqual(jQuery.sap.domById("Toolbar"), null, "Toolbar DomRef must exist");
				initToolbar();
			},
			teardown: function () {
				oCtrl = null;
			}
		});

		/**
		 * Tests the overflow menu for a toolbar with many buttons
		 */
		test("existance of menu", function(assert) {
			var done = assert.async();
			oCtrl = sap.ui.getCore().getControl("Toolbar");
			ok(oCtrl);

			// check initial visibility of the overflow popup
			ok((getPopupDomRef()==null)||(getPopupDomRef().style.visibility=="hidden"), "the Popup must be either invisible or not existing at all");

			var aButtons = [];
			for (var i = 0; i < 10; i++) {
				aButtons[i] = new sap.ui.commons.Button("testButton" + i, {"text":"Test","width":"101px"});
				oCtrl.addItem(aButtons[i]);
			}
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				verifyOverflowButtonIsVisible("Overflow button must be visible for 10 items");
				done();
			}, 10);
		});



		// ==================================================
		// helper functions
		// ==================================================

		function getDisplayStyle(element) {
			return jQuery(element).css("display");
		}

		/**
		 * Helper method using internal knowledge of the renderer to get the DomRef of oCtrl's overflow button
		 */
		function getOverflowDomRef() {
			var sOverflowId = oCtrl.getId() + "-mn";
			return jQuery.sap.domById(sOverflowId);
		}

		/**
		 * Returns the overflow popup DomRef for oCtrl or null if it does not exist
		 */
		function getPopupDomRef() {
			var child = jQuery.sap.domById(oCtrl.getId()+"-pu");
			if (child) {
				return child.parentNode;
			} else {
				return null;
			}
		}
		function verifyOverflowButtonIsNotVisible(sErrorMessage) {
			strictEqual(getDisplayStyle(getOverflowDomRef()), "none", sErrorMessage);
		};
		function verifyOverflowButtonIsVisible(sErrorMessage) {
			strictEqual(getDisplayStyle(getOverflowDomRef()), "block", sErrorMessage);
		};
		(function() {

			var RX_HEX_COLOR = /#[0-9a-fA-F]+/;
			var CSS_COLORS = {
					maroon : 'rgb(128,0,0)',
					red : 'rgb(255,0,0)',
					orange : 'rgb(255,165,0)',
					yellow : 'rgb(255,255,0)',
					olive : 'rgb(128,128,0)',
					purple : 'rgb(128,0,128)',
					fuchsia : 'rgb(255,0,255)',
					white : 'rgb(255,255,255)',
					lime : 'rgb(0,255,0)',
					green : 'rgb(0,128,0)',
					navy : 'rgb(0,0,128)',
					blue : 'rgb(0,0,255)',
					aqua : 'rgb(0,255,255)',
					teal : 'rgb(0,128,128)',
					black : 'rgb(0,0,0)',
					silver : 'rgb(192,192,192)',
					gray : 'rgb(128,128,128)',
					transparent : 'rgba(0,0,0,0)'
			};

			normalizeColor = function(sColor) {

				if (CSS_COLORS[sColor])
					return CSS_COLORS[sColor];

				if (sColor.match(RX_HEX_COLOR)) {
					return "rgb(" + parseInt(sColor.substring(1, 3), 16)
					+ "," + parseInt(sColor.substring(3, 5), 16)
					+ "," + parseInt(sColor.substring(5, 7), 16)
					+ ")";
				}

				return sColor.replace(/ /g, "");
			};

		})();

    </script>
  </head>
	<body>
		<h1 id="qunit-header">QUnit page for sap.ui.commons.Toolbar</h1>
		<h2 id="qunit-banner"></h2>
	 	<h2 id="qunit-userAgent"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<ol id="qunit-tests"></ol>
		<div id="content"></div>
	</body>
</html>
