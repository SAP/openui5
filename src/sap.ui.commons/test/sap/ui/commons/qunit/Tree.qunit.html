<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>Tree - sap.ui.commons</title>

    <script id="sap-ui-bootstrap"
			type="text/javascript"
			src="../../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.ui.commons,sap.ui.table" >
		</script>

		<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
		<script src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

		<script language="javascript">

		var sStandardTreeId 	= "tree1";
		var sTransparentTreeId 	= "tree2";

		function createStandardTree () {
			var oTree1 = new sap.ui.commons.Tree(sStandardTreeId, {title:"Tree with Header", width:"90%",height:"300px",showHeader:true, showHorizontalScrollbar:false});

			var oNode11 = new sap.ui.commons.TreeNode("node11", {text:"Root 1",icon:"../images/tree/library.gif"});

			var oNode13 = new sap.ui.commons.TreeNode("node13", {text:"Node 1.1", expanded:false, isSelected: true});

			var oNode15 = new sap.ui.commons.TreeNode("node15", {text:"Node 1.1.1", hasExpander:true});
			oNode15.attachToggleOpenState(function addSubNodes(oEvent){

				var oNode15Child = new sap.ui.commons.TreeNode({text:"Dyna Node"});
				oNode15.addNode(oNode15Child);

			});
			oNode13.addNode(oNode15);

			oNode11.addNode(oNode13);

			var oNode14 = new sap.ui.commons.TreeNode("node14", {text:"Node 1.2",icon:"../images/tree/Image.gif"});

			var oNode16 = new sap.ui.commons.TreeNode("node16", {text:"Node 1.2.1"});

			var oNode17 = new sap.ui.commons.TreeNode("node17", {text:"Really long text for Node 1.2.1.1"});
			oNode16.addNode(oNode17);

			oNode14.addNode(oNode16);

			oNode11.addNode(oNode14);

			oTree1.addNode(oNode11);

			var oNode12 = new sap.ui.commons.TreeNode("node12", {text:"Root 2"});
			oTree1.addNode(oNode12);

		return oTree1;
		}

		function createTransparentTree () {
			var oTree2 = new sap.ui.commons.Tree("tree2", {title:"Tree with Header", width:"200px",height:"300px", showHorizontalScrollbar:false, showHeader:false});

			var oNode21 = new sap.ui.commons.TreeNode("node21", {text:"Root 1"});

			var oNode23 = new sap.ui.commons.TreeNode("node23", {text:"Node 1.1", expanded:false});

			var oNode25 = new sap.ui.commons.TreeNode("node25", {text:"Node 1.1.1"});
			oNode23.addNode(oNode25);

			oNode21.addNode(oNode23);

			var oNode24 = new sap.ui.commons.TreeNode("node24", {text:"Node 1.2"});

			var oNode26 = new sap.ui.commons.TreeNode("node26", {text:"Node 1.2.1"});

			var oNode27 = new sap.ui.commons.TreeNode("node27", {text:"Really long text for Node 1.2.1.1"});
			oNode26.addNode(oNode27);

			oNode24.addNode(oNode26);

			oNode21.addNode(oNode24);

			oTree2.addNode(oNode21);

			var oNode22 = new sap.ui.commons.TreeNode("node22", {text:"Root 2"});
			oTree2.addNode(oNode22);

		return oTree2;
		}

		function createBoundTree () {
			var oModel = new sap.ui.model.json.JSONModel({
				tree: {
					title: "Root",
					children: [
						{
							title: "Node 1",
							children: [
								{
									title: "Node 1.1"
								},
								{
									title: "Node 1.2"
								},
								{
									title: "Node 1.3"
								}
							]
						},
						{
							title: "Node 2"
						},
						{
							title: "Node 3"
						}
					]
				}
			})
			var oTree = new sap.ui.commons.Tree("tree3", {
				title:"Tree with data binding",
				width:"200px",
				height:"300px",
				showHorizontalScrollbar:false,
				showHeader:false,
				nodes: {
					path: "/tree",
					template: new sap.ui.commons.TreeNode({
						text: "{title}"
					}),
					parameters: {
						arrayNames: ["children"]
					}
				},
				models: oModel
			});
			return oTree;
		}

		function createBoundTreeNamedModel () {
			var oModel = new sap.ui.model.json.JSONModel({
				tree: {
					title: "Root",
					children: [
						{
							title: "Node 1",
							children: [
								{
									title: "Node 1.1"
								},
								{
									title: "Node 1.2"
								},
								{
									title: "Node 1.3"
								}
							]
						},
						{
							title: "Node 2"
						},
						{
							title: "Node 3"
						}
					]
				}
			})
			var oTree = new sap.ui.commons.Tree("tree4", {
				title:"Tree with data binding",
				width:"200px",
				height:"300px",
				showHorizontalScrollbar:false,
				showHeader:false,
				nodes: {
					path: "model>/tree",
					template: new sap.ui.commons.TreeNode({
						text: "{model>title}"
					}),
					parameters: {
						arrayNames: ["children"]
					}
				},
				models: {
					model: oModel
				}
			});
			return oTree;
		}


		var oStandardTree = createStandardTree();
		oStandardTree.placeAt("target1");

		var oTransparentTree = createTransparentTree();
		oTransparentTree.placeAt("target2");

		var oBoundTree = createBoundTree();
		oBoundTree.placeAt("target3");

		var oBoundTreeNamedModel = createBoundTreeNamedModel();
		oBoundTreeNamedModel.placeAt("target4");

		function checkSelectedNodes(aNodes, aExpectedIds) {
			var iIndex;
			if (aNodes.length != aExpectedIds.length) {
				return false
			}
			for (var i = 0; i < aNodes.length; i++) {
				iIndex = aExpectedIds.indexOf(aNodes[i].getId());
				if (iIndex >= 0) {
					aExpectedIds.splice(iIndex, 1);
				} else {
					return false;
				}
			}
			return true;
		}

		/******* qUnit Tests *******/
		module("Tree", {
		  setup: function() {

			  oStandardTree.focus();

		  },
		  teardown: function() {
		  	//this.oStandardTree = null;
		  }
		});

		qutils.delayTestStart();

		module("Rendering");

		test("Rendering of Standard tree", function() {

			notEqual(jQuery.sap.domById(sStandardTreeId), null, "Tree is rendered.");

			notEqual(jQuery.sap.domById(sStandardTreeId+ "-Header"), null, "Tree header is there.");

			notEqual(jQuery.sap.domById(sStandardTreeId+ "-TreeCont"), null, "Tree content is there");

		});

		test("Rendering of transparent tree", function() {

			notEqual(jQuery.sap.domById(sTransparentTreeId), null, "Tree is rendered.");

			equal(jQuery.sap.domById(sTransparentTreeId+ "-Header"), null, "Tree header is not there.");

			notEqual(jQuery.sap.domById(sTransparentTreeId+ "-TreeCont"), null, "Tree content is there");
		});

		module("Nodes public methods");

		test("Single Collapse and Expand", function() {


			//Collapse
			var root1 = sap.ui.getCore().getControl("node11");
			var tmp1 = oStandardTree.getNodes()[0];

			ok( root1.getExpanded(), "Root 1 is expanded at first");
			root1.collapse();
			ok( !root1.getExpanded(), "Root 1 is now collapsed");

			//Expand
			var node13 = sap.ui.getCore().getControl("node13");
			ok( !node13.getExpanded(), "Node 1.1 is collapsed at first");
			node13.expand();
			ok( node13.getExpanded(), "Node 1.1 is now expanded");
		});

		test("Node selection legacy", function() {
			oStandardTree.expandAll();
			var initialSelection = sap.ui.getCore().getControl("node13");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected");

			var newSelection = sap.ui.getCore().getControl("node14");
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1.1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected as well");
		});

		test("Node selection single", function() {
			oStandardTree.expandAll();
			oStandardTree.setSelectionMode("Single");

			var initialSelection = sap.ui.getCore().getControl("node13");
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected");

			var newSelection = sap.ui.getCore().getControl("node14");
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1.1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( !newSelection.getIsSelected(), "Node 1.3 is not selected anymore");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected again");
		});

		test("Node selection multi", function() {
			oStandardTree.expandAll();
			oStandardTree.setSelectionMode("Multi");
			var initialSelection = sap.ui.getCore().getControl("node13");
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected");

			var newSelection = sap.ui.getCore().getControl("node14");
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1.1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected as well");
		});

		test("Node selection legacy with context", function() {
			var oModel = new sap.ui.model.json.JSONModel({}),
				oContext = oModel.createBindingContext("/");

			oStandardTree.setBindingContext(oContext);
			oStandardTree.expandAll();
			var initialSelection = sap.ui.getCore().getControl("node13");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected");

			var newSelection = sap.ui.getCore().getControl("node14");
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1.1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected as well");
			oStandardTree.setBindingContext(null);
		});

		test("Node selection single with context", function() {
			var oModel = new sap.ui.model.json.JSONModel({}),
				oContext = oModel.createBindingContext("/");

			oStandardTree.setBindingContext(oContext);
			oStandardTree.expandAll();
			oStandardTree.setSelectionMode("Single");

			var initialSelection = sap.ui.getCore().getControl("node13");
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected");

			var newSelection = sap.ui.getCore().getControl("node14");
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1.1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( !newSelection.getIsSelected(), "Node 1.3 is not selected anymore");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected again");
			oStandardTree.setBindingContext(null);
		});

		test("Node selection multi with context", function() {
			var oModel = new sap.ui.model.json.JSONModel({}),
				oContext = oModel.createBindingContext("/");

			oStandardTree.setBindingContext(oContext);
			oStandardTree.expandAll();
			oStandardTree.setSelectionMode("Multi");
			var initialSelection = sap.ui.getCore().getControl("node13");
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected");

			var newSelection = sap.ui.getCore().getControl("node14");
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1.1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( newSelection.getIsSelected(), "Node 1.3 is now selected");
			ok( initialSelection.getIsSelected(), "Node 1.1 is selected as well");
			oStandardTree.setBindingContext(null);
		});

		test("Node selection single databinding", function() {
			oBoundTree.expandAll();
			oBoundTree.setSelectionMode("Single");

			var initialSelection = oBoundTree.getNodes()[0];
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1 is selected");

			var newSelection = oBoundTree.getNodes()[1];
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 2 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( !newSelection.getIsSelected(), "Node 2 is not selected anymore");
			ok( initialSelection.getIsSelected(), "Node 1 is selected again");

			oBoundTree.getBinding("nodes").refresh();
			initialSelection = oBoundTree.getNodes()[0];
			newSelection = oBoundTree.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after refresh");
			ok( !newSelection.getIsSelected(), "Node 2 is not selected after refresh");

			oBoundTree.getBinding("nodes").refresh();
			initialSelection = oBoundTree.getNodes()[0];
			newSelection = oBoundTree.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after second refresh");
			ok( !newSelection.getIsSelected(), "Node 2 is not selected after second refresh");
		});

		test("Node selection multi databinding", function() {
			oBoundTree.expandAll();
			oBoundTree.setSelectionMode("Multi");
			var initialSelection = oBoundTree.getNodes()[0];
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1 is selected");

			var newSelection = oBoundTree.getNodes()[1];
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 2 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( newSelection.getIsSelected(), "Node 1 is now selected");
			ok( initialSelection.getIsSelected(), "Node 2 is selected as well");

			oBoundTree.getBinding("nodes").refresh();
			initialSelection = oBoundTree.getNodes()[0];
			newSelection = oBoundTree.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after refresh");
			ok( newSelection.getIsSelected(), "Node 2 is selected after refresh");

			oBoundTree.getBinding("nodes").refresh();
			initialSelection = oBoundTree.getNodes()[0];
			newSelection = oBoundTree.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after second refresh");
			ok( newSelection.getIsSelected(), "Node 2 is selected after second refresh");

		});

		test("Node selection single databinding with named model", function() {
			oBoundTreeNamedModel.expandAll();
			oBoundTreeNamedModel.setSelectionMode("Single");

			var initialSelection = oBoundTreeNamedModel.getNodes()[0];
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1 is selected");

			var newSelection = oBoundTreeNamedModel.getNodes()[1];
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 2 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( !newSelection.getIsSelected(), "Node 2 is not selected anymore");
			ok( initialSelection.getIsSelected(), "Node 1 is selected again");

			oBoundTreeNamedModel.getBinding("nodes").refresh();
			initialSelection = oBoundTreeNamedModel.getNodes()[0];
			newSelection = oBoundTreeNamedModel.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after refresh");
			ok( !newSelection.getIsSelected(), "Node 2 is not selected after refresh");

			oBoundTreeNamedModel.getBinding("nodes").refresh();
			initialSelection = oBoundTreeNamedModel.getNodes()[0];
			newSelection = oBoundTreeNamedModel.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after second refresh");
			ok( !newSelection.getIsSelected(), "Node 2 is not selected after second refresh");
		});

		test("Node selection multi databinding with named model", function() {
			oBoundTreeNamedModel.expandAll();
			oBoundTreeNamedModel.setSelectionMode("Multi");
			var initialSelection = oBoundTreeNamedModel.getNodes()[0];
			initialSelection.select();
			ok( initialSelection.getIsSelected(), "Node 1 is selected");

			var newSelection = oBoundTreeNamedModel.getNodes()[1];
			newSelection.select();
			ok( newSelection.getIsSelected(), "Node 2 is now selected");
			ok( !initialSelection.getIsSelected(), "Node 1 is not selected anymore");

			initialSelection.setIsSelected(true);
			ok( newSelection.getIsSelected(), "Node 1 is now selected");
			ok( initialSelection.getIsSelected(), "Node 2 is selected as well");

			oBoundTreeNamedModel.getBinding("nodes").refresh();
			initialSelection = oBoundTreeNamedModel.getNodes()[0];
			newSelection = oBoundTreeNamedModel.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after refresh");
			ok( newSelection.getIsSelected(), "Node 2 is selected after refresh");

			oBoundTreeNamedModel.getBinding("nodes").refresh();
			initialSelection = oBoundTreeNamedModel.getNodes()[0];
			newSelection = oBoundTreeNamedModel.getNodes()[1];
			ok( initialSelection.getIsSelected(), "Node 1 is selected after second refresh");
			ok( newSelection.getIsSelected(), "Node 2 is selected after second refresh");

		});

		test("Node selection events single", function() {
			var handler,
				node12 = sap.ui.getCore().getControl("node12"),
				node16 = sap.ui.getCore().getControl("node16"),
				node17 = sap.ui.getCore().getControl("node17");
			oStandardTree.setSelectionMode("Single");
			node12.select();

			handler = function(oEvent) {
				equal(oEvent.getParameter("node").getId(), "node16", "Event parameter contains Node 1.2.1")
			};
			oStandardTree.attachSelect(handler);
			qutils.triggerEvent("click", node16.getDomRef().firstChild, {button: 0});
			oStandardTree.detachSelect(handler);
			ok( node16.getIsSelected(), "Node 1.2.1 is selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( !node12.getIsSelected(), "Root 2 is not selected");

			handler = function(oEvent) {
				equal(oEvent.getParameter("node").getId(), "node12", "Event parameter contains Root 2")
			};
			oStandardTree.attachSelect(handler);
			qutils.triggerEvent("click", node12.getDomRef().firstChild, {button: 0});
			oStandardTree.detachSelect(handler);
			ok( !node16.getIsSelected(), "Node 1.2.1 is selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( node12.getIsSelected(), "Root 2 is not selected");
		});

		test("Node selection events multi", function() {
			var handler,
				node12 = sap.ui.getCore().getControl("node12"),
				node16 = sap.ui.getCore().getControl("node16"),
				node17 = sap.ui.getCore().getControl("node17");
			oStandardTree.setSelectionMode("Multi");

			// Selection without modifiers
			node12.select();

			handler = function(oEvent) {
				ok(checkSelectedNodes(oEvent.getParameter("nodes"), ["node16"]), "Selected nodes as expected");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node16.getDomRef().firstChild, {button: 0});
			oStandardTree.detachSelectionChange(handler);
			ok( node16.getIsSelected(), "Node 1.2.1 is selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( !node12.getIsSelected(), "Root 2 is not selected");

			handler = function(oEvent) {
				ok(checkSelectedNodes(oEvent.getParameter("nodes"), ["node12"]), "Selected nodes as expected");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node12.getDomRef().firstChild, {button: 0});
			oStandardTree.detachSelectionChange(handler);
			ok( !node16.getIsSelected(), "Node 1.2.1 is selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( node12.getIsSelected(), "Root 2 is not selected");

			// Selection with Ctrl-Key
			node12.select();

			handler = function(oEvent) {
				equal(oEvent.getParameter("nodes").length, 0, "Event parameter nodes contains 0 entries");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node12.getDomRef().firstChild, {button: 0, ctrlKey: true});
			oStandardTree.detachSelectionChange(handler);
			ok( !node16.getIsSelected(), "Node 1.2.1 is not selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( !node12.getIsSelected(), "Root 2 is not selected");

			handler = function(oEvent) {
				ok(checkSelectedNodes(oEvent.getParameter("nodes"), ["node12"]), "Selected nodes as expected");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node12.getDomRef().firstChild, {button: 0, ctrlKey: true});
			oStandardTree.detachSelectionChange(handler);
			ok( !node16.getIsSelected(), "Node 1.2.1 is not selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( node12.getIsSelected(), "Root 2 is selected");

			handler = function(oEvent) {
				ok(checkSelectedNodes(oEvent.getParameter("nodes"), ["node12", "node16"]), "Selected nodes as expected");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node16.getDomRef().firstChild, {button: 0, ctrlKey: true});
			oStandardTree.detachSelectionChange(handler);
			ok( node16.getIsSelected(), "Node 1.2.1 is selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( node12.getIsSelected(), "Root 2 is selected");

			// Selection with Shift-Key
			node16.select();

			handler = function(oEvent) {
				ok(checkSelectedNodes(oEvent.getParameter("nodes"), ["node12","node16","node17"]), "Selected nodes as expected");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node12.getDomRef().firstChild, {button: 0, shiftKey: true});
			oStandardTree.detachSelectionChange(handler);
			ok( node16.getIsSelected(), "Node 1.2.1 is selected");
			ok( node17.getIsSelected(), "Node 1.2.1.1 is selected");
			ok( node12.getIsSelected(), "Root 2 is selected");

			handler = function(oEvent) {
				ok(checkSelectedNodes(oEvent.getParameter("nodes"), ["node12"]), "Selected nodes as expected");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node12.getDomRef().firstChild, {button: 0});
			oStandardTree.detachSelectionChange(handler);
			ok( !node16.getIsSelected(), "Node 1.2.1 is not selected");
			ok( !node17.getIsSelected(), "Node 1.2.1.1 is not selected");
			ok( node12.getIsSelected(), "Root 2 is selected");

			handler = function(oEvent) {
				ok(checkSelectedNodes(oEvent.getParameter("nodes"), ["node12","node16","node17"]), "Selected nodes as expected");
			};
			oStandardTree.attachSelectionChange(handler);
			qutils.triggerEvent("click", node16.getDomRef().firstChild, {button: 0, shiftKey: true});
			oStandardTree.detachSelectionChange(handler);
			ok( node16.getIsSelected(), "Node 1.2.1 is selected");
			ok( node17.getIsSelected(), "Node 1.2.1.1 is selected");
			ok( node12.getIsSelected(), "Root 2 is selected");

		});


		module("Tree public methods");

		test("Collapse all", function() {

			oStandardTree.collapseAll();

			var foundNodeExpanded = false;
			var aNodes = oStandardTree.getNodes();

			//TODO: check only 1st level
			for(var i=0;i<aNodes.length;i++){
				if(aNodes[i].getExpanded()){
					foundNodeExpanded = true;
				}
			}
			ok( !foundNodeExpanded, "All nodes are now collapsed");
		});

		test("Expand all", function() {

			oStandardTree.expandAll();

			var foundNodeCollapsed = false;
			var aNodes = oStandardTree.getNodes();

			//TODO: check only 1st level!
			for(var i=0;i<aNodes.length;i++){
				if(!aNodes[i].getExpanded()){
					foundNodeCollapsed = true;
				}
			}
			ok( !foundNodeCollapsed, "All nodes are now expanded");
		});

		module("Keyboard support");

		test("Space/Enter", function() {
			oStandardTree.expandAll();

			qutils.triggerKeyboardEvent("node11", jQuery.sap.KeyCodes.ENTER, false, false, false);

			equal( oStandardTree.getSelection().getId(), "node11",  "New selection is set");

		});

		// FIXME: test doesn't work in headless PhantomJS test cycle => commented out!
		if (!sap.ui.Device.browser.phantomJS) {
			asyncTest("Arrow keys", function() {
				sap.ui.getCore().getControl("node11").focus();

				setTimeout(function(){
					qutils.triggerKeyboardEvent(sStandardTreeId, jQuery.sap.KeyCodes.ARROW_DOWN, false, false, false);
					setTimeout(function(){
						equal( jQuery(document.activeElement).first().attr("id"), "node13",  "Focus is down one node");
						qutils.triggerKeyboardEvent(sStandardTreeId, jQuery.sap.KeyCodes.ARROW_UP, false, false, false);
						setTimeout(function(){
							equal( jQuery(document.activeElement).first().attr("id"), "node11",  "Focus is up one node");
							qutils.triggerKeyboardEvent("node11", jQuery.sap.KeyCodes.ARROW_LEFT, false, false, false);
							setTimeout(function(){
								equal( sap.ui.getCore().getControl("node11").getExpanded(), false,  "Node is collapsed");
								qutils.triggerKeyboardEvent("node11", jQuery.sap.KeyCodes.ARROW_RIGHT, false, false, false);
								setTimeout(function(){
									equal( sap.ui.getCore().getControl("node11").getExpanded(), true,  "Node is expanded");
									start();
								}, 100);
							}, 100);
						}, 100);
					}, 100);
				}, 100);
			});
		}

		test("Plus/Minus", function() {

			qutils.triggerKeyboardEvent("node11", jQuery.sap.KeyCodes.NUMPAD_MINUS, false, false, false);

			ok( !sap.ui.getCore().getControl("node11").getExpanded(), "Root is collapsed");

			qutils.triggerKeyboardEvent("node11", jQuery.sap.KeyCodes.NUMPAD_PLUS, false, false, false);

			ok( sap.ui.getCore().getControl("node11").getExpanded(), "Root is expanded");

		});

		test("Asterisk", function() {

			qutils.triggerKeyboardEvent(sStandardTreeId, jQuery.sap.KeyCodes.NUMPAD_ASTERISK, false, false, false);

			var foundNodeExpanded = false;
			var aNodes = oStandardTree.getNodes();

			//TODO: check only 1st level
			for(var i=0;i<aNodes.length;i++){
				if(aNodes[i].getExpanded()){
					foundNodeExpanded = true;
				}
			}
			ok( !foundNodeExpanded, "All nodes are now collapsed");

			qutils.triggerKeyboardEvent(sStandardTreeId, jQuery.sap.KeyCodes.NUMPAD_ASTERISK, false, false, false);

			var foundNodeCollapsed = false;
			var aNodes = oStandardTree.getNodes();

			//TODO: check only 1st level!
			for(var i=0;i<aNodes.length;i++){
				if(!aNodes[i].getExpanded()){
					foundNodeCollapsed = true;
				}
			}
			ok( !foundNodeCollapsed, "All nodes are now expanded");

		});

		test("Home/End", function() {

			sap.ui.getCore().getControl("node13").focus();

			qutils.triggerKeyboardEvent("node13", jQuery.sap.KeyCodes.END, false, false, false);

			equal( jQuery(document.activeElement).first().attr("id"), "node14",  "Focus moved to last sibling");

			qutils.triggerKeyboardEvent("node14", jQuery.sap.KeyCodes.HOME, false, false, false);

			equal( jQuery(document.activeElement).first().attr("id"), "node13",  "Focus moved to first sibling");



		});

		test("Ctrl+Home/Ctrl+End", function() {

			sap.ui.getCore().getControl("node13").focus();

			qutils.triggerKeyboardEvent("node13", jQuery.sap.KeyCodes.END, false, false, true);

			equal( jQuery(document.activeElement).first().attr("id"), "node12",  "Focus moved to last node");

			qutils.triggerKeyboardEvent("node12", jQuery.sap.KeyCodes.HOME, false, false, true);

			equal( jQuery(document.activeElement).first().attr("id"), "node11",  "Focus moved to first node");



		});

		module("Nodes expand and collapse", {
			beforeEach: function () {
				//system under test
				this.oTree = new sap.ui.commons.Tree("trtree", {
					nodes: [
						new sap.ui.commons.TreeNode("trnode1", {
							text: "n1",
							expanded: true,
							nodes: [
								new sap.ui.commons.TreeNode("trnode11", {
									text: "n11",
									expanded: true,
									nodes: [
										new sap.ui.commons.TreeNode("trnode111", {
											text: "n111",
											expanded: true
										}),
										new sap.ui.commons.TreeNode("trnode112", {
											text: "n112",
											expanded: true
										})
									]
								}),
								new sap.ui.commons.TreeNode("trnode12", {
									text: "n12",
									expanded: true
								})
							]
						}),
						new sap.ui.commons.TreeNode("trnode2", {
							text: "n2",
							expanded: true,
							nodes: [
								new sap.ui.commons.TreeNode("trnode21", {
									text: "n21",
									expanded: true,
									nodes: [
										new sap.ui.commons.TreeNode("trnode211", {
											text: "n211",
											expanded: true
										}),
										new sap.ui.commons.TreeNode("trnode212", {
											text: "n212",
											expanded: true
										})
									]
								}),
								new sap.ui.commons.TreeNode("trnode22", {
									text: "n22",
									expanded: true
								})
							]
						})
					]
				});
				this.oTree.setTitle("Tree");
				this.oTree.setWidth("100%");
				this.oTree.setHeight("auto");
				this.oTree.setSelectionMode(sap.ui.commons.TreeSelectionMode.Multi);

				//arrange
				this.oTree.placeAt("target4");
				sap.ui.getCore().applyChanges();
			},
			afterEach: function() {
				this.oTree.destroy();
				this.oTree = null;
			}
		});

		test("Selection is adjusted only once for the real target node on collapse", function() {
			var oAdjustSelectionSpy = this.spy(this.oTree, "_adjustSelectionOnCollapsing"),
				oTargetNode = sap.ui.getCore().byId("trnode1"),
				oSelectedChildNode = sap.ui.getCore().byId("trnode111");

			//Act
			oSelectedChildNode.setIsSelected(true);
			oTargetNode.collapse(true);

			//Assert
			equal(oAdjustSelectionSpy.callCount, 1, "Selection is adjusted only once.");
			ok(oAdjustSelectionSpy.calledWith(oTargetNode), "Selection is adjusted starting from collapsed target node.");

			oAdjustSelectionSpy.restore();
		});

		test("Selection is adjusted only once for the real target node on expand", function() {
			var oAdjustSelectionSpy = this.spy(sap.ui.commons.Tree.prototype, "_adjustSelectionOnExpanding"),
					oTargetNode = sap.ui.getCore().byId("trnode1"),
					oSelectedChildNode = sap.ui.getCore().byId("trnode111");

			//Act
			oSelectedChildNode.setIsSelected(true);
			this.oTree.collapseAll();
			oTargetNode.expand(true);

			//Assert
			equal(oAdjustSelectionSpy.callCount, 1, "Selection is adjusted only once.");
			ok(oAdjustSelectionSpy.calledWith(oTargetNode), "Selection is adjusted starting from expanded target node.");
		});

		test("Animating only when collapse is not propagated to children", function() {
			var oJqueryShowSpy = this.spy(jQuery.fn, "hide"),
				oTargetNode = sap.ui.getCore().byId("trnode1");

			oTargetNode.collapse(true);
			equal(oJqueryShowSpy.callCount, 2, "All nodes with children hide.");
			equal(oJqueryShowSpy.args[0].length, 0, "Node1 hides without animation.");
			equal(oJqueryShowSpy.args[1].length, 0, "Node11 hides without animation.");
		});

		test("Store references to the selected hidden children", function() {
			var oDeepTree = new sap.ui.commons.Tree("tr2tree", {
				nodes: [
					new sap.ui.commons.TreeNode("tr2node1", {
						text: "n1",
						expanded: true,
						nodes: [
							new sap.ui.commons.TreeNode("tr2node11", {
								text: "n11",
								expanded: true,
								nodes: [
									new sap.ui.commons.TreeNode("tr2node111", {
										text: "n111",
										expanded: true,
										nodes: [
											new sap.ui.commons.TreeNode("tr2node1111", {
												text: "n1111",
												expanded: true
											})
										]
									})

								]
							})
						]
					})
				]
			});
			oDeepTree.setWidth("100%");
			oDeepTree.setHeight("auto");
			oDeepTree.placeAt("target4");
			sap.ui.getCore().applyChanges();

			var oNode1 = sap.ui.getCore().byId("tr2node1");
			var oNode11 = sap.ui.getCore().byId("tr2node11");
			var oNode111 = sap.ui.getCore().byId("tr2node111");
			var oNode1111 = sap.ui.getCore().byId("tr2node1111");

			oNode1111.select();
			oDeepTree.collapseAll();

			this.stub(sap.ui.commons.TreeNode, "ANIMATION_DURATION", 0);
			oNode1.expand();

			equal(oNode1.getSelectedForNodes().length, 0, "References of its selected hidden children removed when expanded.");
			equal(oNode11.getSelectedForNodes().length, 1, "Node references propagated to the first collapsed parent of the selected hidden children.");
			equal(oNode11.getSelectedForNodes()[0], "tr2node1111", "Node references propagated to the first collapsed parent of the selected hidden children.");
			equal(oNode111.getSelectedForNodes().length, 0, "Node references not propagated to the other collapsed parents of the selected hidden children.");

			oDeepTree.destroy();
		});

		module("Data binding", {
			beforeEach: function () {
				this.oTree = new sap.ui.commons.Tree({
					showHeader: false,
					showHeaderIcons: false,
					showHorizontalScrollbar: true,
					selectionMode: sap.ui.commons.TreeSelectionMode.Single
				});
				this.oTree.setModel(new sap.ui.model.json.JSONModel({
					children : [
						{
							bShow : true,
							text : "node 1",
							children : [
								{
									bShow : true,
									text : "node 11"
								},
								{
									bShow : true,
									text : "node 12"
								},
								{
									bShow : true,
									text : "node 13"
								}
							]
						},
						{
							bShow : false,
							text : "node 2",
							children : [
								{
									bShow : true,
									text : "node 21"
								},
								{
									bShow : true,
									text : "node 22"
								},
								{
									bShow : true,
									text : "node 23"
								}
							]
						},
						{
							bShow : true,
							text : "node 3",
							children : [
								{
									bShow : true,
									text : "node 31"
								},
								{
									bShow : false,
									text : "node 32"
								},
								{
									bShow : false,
									text : "node 33"
								}
							]
						}
					]
				}));
				this.oTree.bindNodes({
					path : "/",
					template : new sap.ui.commons.TreeNode({
						text : {
							path : "text"
						}
					}),
					parameters : { arrayNames : [ "children" ] }
				});
				this.oTree.placeAt("target5");
				sap.ui.getCore().applyChanges();
				this.fnSelectionChangeHandler = function (oEvent) {
					this.oSelectionChangeEventStorage = jQuery.extend({}, oEvent);
				}.bind(this);
				this.spySelectNodeHandler = sinon.spy(sap.ui.commons.TreeNode.prototype, "fireSelected");
				this.sandbox = sinon.sandbox;
				this.spySelectionChangeHandler = sinon.spy(this.fnSelectionChangeHandler);
				this.oTree.attachEvent('selectionChange', this.spySelectionChangeHandler);
			},
			afterEach: function () {
				this.oTree.destroy();
				this.fnSelectionChangeHandler = null;
				this.oSelectionChangeEventStorage = null;
				this.spySelectNodeHandler = null;
				this.sandbox.restore();
			},
			applyFilter: function (sShowValue) {
				var aFiltersToApply = [];
				switch (sShowValue) {
					case "True":
						aFiltersToApply.push(new sap.ui.model.Filter('bShow', sap.ui.model.FilterOperator.EQ, true));
						break;
					case "False":
						aFiltersToApply.push(new sap.ui.model.Filter('bShow', sap.ui.model.FilterOperator.EQ, false));
						break;
					default:
						aFiltersToApply = [
							new sap.ui.model.Filter('bShow', sap.ui.model.FilterOperator.EQ, true),
							new sap.ui.model.Filter('bShow', sap.ui.model.FilterOperator.EQ, false)
						];
						break;
				}
				this.oTree.getBinding("nodes").filter(aFiltersToApply);
			}
		});

		test("Selection is cleared on data model filtering", function () {
			//arrange
			var oTreeNodes = this.oTree.getAggregation("nodes"),
				oNodeToSelect = oTreeNodes[1].getNodes()[1]; // node 2-2

			this.oTree.setSelection(oNodeToSelect, false, sap.ui.commons.TreeSelectionMode.Single ,true);
			sap.ui.getCore().applyChanges();
			//assert
			strictEqual(this.spySelectNodeHandler.callCount, 1, "TreeNode select event was fired successfully");
			ok(this.spySelectionChangeHandler.calledOnce, "Tree selection change event was fired successfully");
			equal(this.oSelectionChangeEventStorage.mParameters.nodes[0], oNodeToSelect, "Tree selection change event was fired with correct node parameter");
			equal(this.oSelectionChangeEventStorage.mParameters.nodeContexts[0], this.oTree.getNodeContext(oNodeToSelect), "Tree selection change event was fired with correct nodeContexts parameter");
			strictEqual(this.oTree.getSelection(), oNodeToSelect, "The correct node was selected");
			//arrange
			this.applyFilter("False");
			sap.ui.getCore().applyChanges();
			//assert
			strictEqual(this.spySelectNodeHandler.callCount, 1, "TreeNode select event was not fired on data model filtering");
			equal(this.oSelectionChangeEventStorage.mParameters.nodes[0], null, "Tree selection change event was fired with correct node parameter");
			equal(this.oSelectionChangeEventStorage.mParameters.nodeContexts[0], null, "Tree selection change event was fired with correct nodeContexts parameter");
			strictEqual(this.oTree.getSelection(), null, "getSelection() returned null when performing data model filtering");
			//arrange
			this.applyFilter("Reset"); //reset the filters and data to its original state
			sap.ui.getCore().applyChanges();
			//assert
			strictEqual(this.spySelectNodeHandler.callCount, 1, "TreeNode select event was not fired on data model filtering");
			equal(this.oSelectionChangeEventStorage.mParameters.nodes[0], null, "Tree selection change event was fired with correct node parameter");
			equal(this.oSelectionChangeEventStorage.mParameters.nodeContexts[0], null, "Tree selection change event was fired with correct nodeContexts parameter");
			strictEqual(this.oTree.getSelection(), null, "getSelection() returned null when performing data model filtering");
			//arrange
			this.oTree.setSelection(oNodeToSelect, false, sap.ui.commons.TreeSelectionMode.Single ,true); //select the same (2-2) node
			sap.ui.getCore().applyChanges();
			//assert
			strictEqual(this.spySelectNodeHandler.callCount, 2, "Tree selection change was fired on data model filtering");
			equal(this.oSelectionChangeEventStorage.mParameters.nodes[0], oNodeToSelect, "Tree selection change event was fired with correct node parameter");
			equal(this.oSelectionChangeEventStorage.mParameters.nodeContexts[0], this.oTree.getNodeContext(oNodeToSelect), "Tree selection change event was fired with correct nodeContexts parameter");
			strictEqual(this.oTree.getSelection(), oNodeToSelect, "getSelection() returned null when performing data model filtering");
			//arrange
			this.applyFilter("True");
			sap.ui.getCore().applyChanges();
			//assert
			strictEqual(this.spySelectNodeHandler.callCount, 2, "TreeNode select event was not fired on data model filtering");
			equal(this.oSelectionChangeEventStorage.mParameters.nodes[0], null, "Tree selection change event was fired with correct node parameter");
			equal(this.oSelectionChangeEventStorage.mParameters.nodeContexts[0], null, "Tree selection change event was fired with correct nodeContexts parameter");
			strictEqual(this.oTree.getSelection(), null, "getSelection() returned null when performing data model filtering");
		});
		</script>
	</head>
	<body>
		<h1 id="qunit-header">qUnit Page for Tree Testing</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="qunit-fixture"></div>
		<div id="target1"></div>
		<div id="target2"></div>
		<div id="target3"></div>
		<div id="target4"></div>
		<div id="target5"></div>
	</body>
</html>
