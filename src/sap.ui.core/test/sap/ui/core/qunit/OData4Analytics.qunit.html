<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Initialization -->
<script src="../shared-config.js"></script>
<script id="sap-ui-bootstrap"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-libs="sap.ui.commons">

</script>

<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<!--[if IE]>
	<script src="../../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
<![endif]-->
<script src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- Fake Service Implementaton -->
<script src="analytics/o4aFakeService.js"></script>
<!-- Fake Service Content -->
<script src="analytics/o4aMetadata.js"></script>

<!-- Test functions -->
<script>

	jQuery.sap.require("sap.ui.model.analytics.odata4analytics");
	var odata4analytics = sap.ui.model.analytics.odata4analytics;

	//start the fake service
	var sCompleteServiceURI = "http://o4aFakeService:8080/";
	o4aFakeService.fake({
		baseURI: sCompleteServiceURI
	});

	function getModelInstance(sServiceURI) {
		// TODO removeShared MetaData?
		sServiceURI = sServiceURI || sCompleteServiceURI;

		//set base URI for the fake service if necessray
		o4aFakeService.setBaseURI(sServiceURI);

		return new odata4analytics.Model({
			oModel: new sap.ui.model.odata.ODataModel(sServiceURI)
		});
	}

	function getQueryResultRequest() {
		var oModel = getModelInstance(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		oParamRequest = new odata4analytics.ParameterizationRequest(oQueryResult.getParameterization());

		oParamRequest.setParameterValue("P_ControllingArea", "US01");
		oParamRequest.setParameterValue("P_CostCenter", "");
		oParamRequest.setParameterValue("P_CostCenterTo", "");

		var oQueryResultRequest = new odata4analytics.QueryResultRequest(oQueryResult);
		oQueryResultRequest.setParameterizationRequest(oParamRequest);
		return oQueryResultRequest;
	}

	QUnit.module("Instantiation");

	QUnit.test("Create Model-Instance", function(assert) {
		var oModel = getModelInstance();
		// check if model could be wrapped
		assert.ok(oModel, "OData Model should be wrapped.");
	});

	QUnit.module("Results");

	QUnit.test("Get names of all query results offered by the service", function(assert) {
		var oModel = getModelInstance(),
		aQueryResultNames = oModel.getAllQueryResultNames();

		assert.strictEqual(aQueryResultNames[0], "ActualPlannedCostsResults", "First Query Result Name is 'ActualPlannedCostsResults'.");
		assert.strictEqual(aQueryResultNames.length, 1, "Number of interpreted Query Results is correct.")
	});

	QUnit.test("Get all query results", function(assert) {
		var oModel = getModelInstance(),
		mQueryResults = oModel.getAllQueryResults();

		assert.ok(mQueryResults, "Query results object could be loaded.");
		assert.ok(mQueryResults["ActualPlannedCostsResults"], "Expected query results were loaded.");
		assert.ok(mQueryResults["ActualPlannedCostsResults"] instanceof odata4analytics.QueryResult, "Query Result 'ActualPlannedCosts' is an instance of odata4analytics.QueryResult.");
	});

	QUnit.test("Find query result by name", function(assert) {
		var oModel = getModelInstance(), mQueryResults = oModel.getAllQueryResults(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults");

		assert.ok(oQueryResult, "Query result 'ActualPlannedCostsResults' could be found.");
		assert.deepEqual(oQueryResult, mQueryResults["ActualPlannedCostsResults"], "Query Result 'ActualPlannedCostsResults' was fetched by name.");
	});

	QUnit.module("Introspection");

	QUnit.test("Get all parameter names", function(assert) {
		var oModel = getModelInstance(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		oParameterization = oQueryResult.getParameterization(),
		aParameterNames = oParameterization.getAllParameterNames();

		assert.ok(jQuery.isArray(aParameterNames), "Parameter names were loaded.");
		assert.strictEqual(aParameterNames.length, 3, "Number of Parameters should be 3.");
	});

	QUnit.test("Try to fetch parameters from the parameterization", function(assert) {
		var oModel = getModelInstance(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		oParameterization = oQueryResult.getParameterization(),
		oParameter = oParameterization.findParameterByName("P_CostCenter");

		assert.ok(oParameter instanceof odata4analytics.Parameter, "Parameter could be fetched by name.");
		assert.strictEqual(oParameter.getProperty().type, "Edm.String", "Parameter should be of type 'Edm.String'.");
	});

	QUnit.test("Fetch peer boundary of an interval boundary parameter", function(assert) {
		var oModel = getModelInstance();
		var oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults");

		var oParameter = oQueryResult.getParameterization().findParameterByName("P_CostCenter");
		assert.ok(oParameter.isIntervalBoundary(), "Parameter "+oParameter.getName()+" is correctly marked as interval boundary.");

		var oPeerBoundaryIntervalParameter = oParameter.getPeerIntervalBoundaryParameter();
		assert.ok(oPeerBoundaryIntervalParameter, "Parameter "+oParameter.getName()+" has expected peer parameter "+oPeerBoundaryIntervalParameter.getName()+".");
	});

	QUnit.test("Get all dimension names", function(assert) {
		var oModel = getModelInstance(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		aDimensionNames = oQueryResult.getAllDimensionNames();

		assert.ok(jQuery.isArray(aDimensionNames), "getAllDimensionNames returned an Array.");
		assert.strictEqual(aDimensionNames.length, 9, "Number of Dimensions should be '9'.");
		assert.strictEqual(aDimensionNames[0], "ControllingArea", "Access to the dimension array returns the expected values (1/2).");
		assert.strictEqual(aDimensionNames[8], "Currency", "Access to the dimension array returns the expected values (2/2).");
	});

	QUnit.test("Try to fetch specific dimensions from the query result", function(assert) {
		var oModel = getModelInstance(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		oDimensionByName = oQueryResult.findDimensionByName("Currency"),
		oDimensionByAccess = oQueryResult.getAllDimensions()["Currency"];

		assert.ok(oDimensionByName instanceof odata4analytics.Dimension, "Check if Dimension object was retrieved.");
		assert.ok(oDimensionByAccess instanceof odata4analytics.Dimension, "Check if Dimension object was retrieved.");

		assert.strictEqual(oDimensionByAccess.getName(), "Currency", "Introspection check on dimensionByAccess.");
		assert.strictEqual(oDimensionByName.getKeyProperty().name, "Currency", "Introspection check on dimensionByAccess.");

		assert.deepEqual(oDimensionByName, oDimensionByAccess, "Retrieving dimensions by 'Name' and through 'Access' should be deliver the same result.");
	});

	QUnit.test("Getting attribute names from Dimensions", function(assert) {
		var oModel = getModelInstance(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		oDimensionByName = oQueryResult.findDimensionByName("ControllingArea"),
		aDimensionAttributeNames = oDimensionByName.getAllAttributeNames();

		assert.ok(jQuery.isArray(aDimensionAttributeNames), "Attribute names Array could be retrieved.");

		assert.strictEqual(aDimensionAttributeNames[0], "ControllingAreaText", "Attribute ControllingAreaText found for ControllingArea.");

		// edge cases, should be undefined
		assert.strictEqual(oDimensionByName.findAttributeByName(), undefined, "Calling findAttributeByName with no parameters should return 'undefined'.");
		assert.strictEqual(oDimensionByName.findAttributeByName("nonexisting-attribute"), undefined, "Calling findAttributeByName with invalid attribute name should return 'undefined'.");
		assert.strictEqual(oDimensionByName.findAttributeByName(null), undefined, "Calling findAttributeByName with 'null' should return 'undefined'.");
	});

	QUnit.test("Get all measure names", function(assert) {
		var oModel = getModelInstance(), oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		aMeasureNames = oQueryResult.getAllMeasureNames();

		assert.ok(jQuery.isArray(aMeasureNames), "getAllMeasureNames returned an Array.");
		assert.strictEqual(aMeasureNames.length, 4, "Number of Measures should be '4'.");
		assert.strictEqual(aMeasureNames[0], "ActualCosts", "Access to the dimension array returns the expected values (1/2).");
		assert.strictEqual(aMeasureNames[3], "ActualPlannedCostsPercentage", "Access to the dimension array returns the expected values (2/2).");
	});

	QUnit.test("Try to fetch specific measures from the query result", function(assert) {
		var oModel = getModelInstance(),
		oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"),
		oMeasureByName = oQueryResult.findMeasureByName("ActualCosts"),
		oMeasureByAccess = oQueryResult.getAllMeasures()["ActualCosts"];

		assert.ok(oMeasureByName instanceof odata4analytics.Measure, "Check if Measure object was retrieved.");
		assert.ok(oMeasureByAccess instanceof odata4analytics.Measure, "Check if Measure object was retrieved.");

		assert.strictEqual(oMeasureByAccess.getName(), "ActualCosts", "Introspection check on measureByAccess.");
		assert.strictEqual(oMeasureByName.getUnitProperty().name, "Currency", "Introspection check on measureByAccess.");

		assert.deepEqual(oMeasureByName, oMeasureByAccess, "Retrieving dimensions by 'Name' and through 'Access' should be deliver the same result.");
	});

	QUnit.test("Get all attribute names", function(assert) {
		var oQueryResult = getModelInstance().findQueryResultByName("ActualPlannedCostsResults");
		var oDimension = oQueryResult.findDimensionByName("ControllingArea");
		var aAttributeNames = oDimension.getAllAttributeNames();

		assert.ok(jQuery.isArray(aAttributeNames), "getAllAttributeNames returned an Array.");
		assert.strictEqual(aAttributeNames.length, 1, "Number of Attributes should be '3'.");
		assert.strictEqual(aAttributeNames[0], "ControllingAreaText", "Access to the dimension array returns the expected values.");
	});

	QUnit.test("Try to fetch specific attributes", function(assert) {

		var oQueryResult = getModelInstance().findQueryResultByName("ActualPlannedCostsResults");
		var oDimension = oQueryResult.findDimensionByName("ControllingArea");
		var oAttributeByName = oDimension.findAttributeByName("ControllingAreaText");
		var oAttributeByAccess = oDimension.getAllAttributes()["ControllingAreaText"];

		assert.ok(oAttributeByName instanceof odata4analytics.DimensionAttribute, "Check if Attribute object was retrieved.");
		assert.ok(oAttributeByAccess instanceof odata4analytics.DimensionAttribute, "Check if Attribute object was retrieved.");

		assert.strictEqual(oAttributeByAccess.getName(), "ControllingAreaText", "Introspection check on attributeByAccess.");
		assert.strictEqual(oAttributeByName.getName(), "ControllingAreaText", "Introspection check on attributeByName.");

		assert.deepEqual(oAttributeByName, oAttributeByAccess, "Retrieving dimensions by 'Name' and through 'Access' should be deliver the same result.");
	});

	QUnit.test("Determine which properties of a query result are updatable", function(assert) {
		var oQueryResult = getModelInstance().findQueryResultByName("ActualPlannedCostsResults");

		var oUpdatablePropertyNames = oQueryResult.getEntitySet().getUpdatablePropertyNameSet();
		var iPropertyCount = 0;
		var iDimensionCount = 0;
		var iMeasureCount = 0;
		var iUpdatablePropertyCount = 0;
		for ( var sPropName in oUpdatablePropertyNames) {
			iUpdatablePropertyCount++;
			if ((oUpdatable = oQueryResult.findMeasureByName(sPropName))) {
				// is a measure
				if (oUpdatable.isUpdatable) {
					assert.ok(oUpdatable.isUpdatable, sPropName + " is an updatable measure.");
					iMeasureCount++;
				}
			} else if ((oUpdatable = oQueryResult.findDimensionByName(sPropName))) {
				// is a dimension
				assert.ok(oUpdatable, sPropName + " is an updatable dimension.");
				iDimensionCount++;
			} else {
				// is only a property
				assert.ok(sPropName, sPropName + " is an updatable property.");
				iPropertyCount++;
			}
		}
		var iCount = iPropertyCount + iDimensionCount + iMeasureCount;
		assert.equal(iUpdatablePropertyCount, iCount, "getUpdatablePropertyNameSet() delivered correct a count.")
	});


	QUnit.test("Access query with hierarchy from entity type", function(assert) {
		var oQueryResult = getModelInstance().findQueryResultByName("ActualPlannedCostsResults");
		var sHierarchyDimensionName = "CostCenter";

		var aHierPropNames = oQueryResult.getEntityType().getAllHierarchyPropertyNames();
		assert.ok(jQuery.isArray(aHierPropNames) &&  typeof aHierPropNames[0] === "string", "Hierarchy property names correctly fetched.");
		var oHierarchy = oQueryResult.getEntityType().getHierarchy("ControllingArea");
		assert.ok(!!oHierarchy, "Hierarchy correctly fetched.");

	});

	QUnit.test("Access hierarchy from dimension", function(assert) {
		var oQueryResult = getModelInstance().findQueryResultByName("ActualPlannedCostsResults");

		var sHierarchyDimensionName = "CostCenter";
		var sOtherDimensionName = "ControllingArea";

		var oDimension = oQueryResult.findDimensionByName(sHierarchyDimensionName);
		assert.ok(!!oDimension, "Dimension correctly fetched.");
		var oHierarchy = oDimension.getHierarchy("CostCenter");
		assert.ok(!!oHierarchy, "Hierarchy correctly fetched.");

		var oDimension = oQueryResult.findDimensionByName(sOtherDimensionName); // negative
		// test
		assert.ok(!!oDimension, "Dimension correctly fetched.");
		var oHierarchy = oDimension.getHierarchy("ControllingArea");
		assert.ok(!!oHierarchy, "Hierarchy correctly fetched.");

	});

	QUnit.module("Parametrization");

	QUnit.test("Create request for query parameterization", function(assert) {
		var oModel = getModelInstance(), oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults"), oParamRequest = new odata4analytics.ParameterizationRequest(oQueryResult.getParameterization());

		var sURIToParamEntitySetRelative = oParamRequest.getURIToParameterizationEntitySet(), sURIToParamEntitySetAbsolute = oParamRequest.getURIToParameterizationEntitySet(sCompleteServiceURI);

		assert.strictEqual(sURIToParamEntitySetRelative, "/ActualPlannedCosts", "Relative URI to Parameterization Entity Set is correct.");
		assert.strictEqual(sURIToParamEntitySetAbsolute, sCompleteServiceURI + "/ActualPlannedCosts", "Absolute URI to Parameterization Entity Set is correct.");

		assert.throws(function() {
			oParamRequest.setParameterValue("blub", "a");
		}, "Setting an invalid Parameter throws an Exception.");

		assert.throws(function() {
			oParamRequest.getURIToParameterizationEntry();
		}, "Getting the parameterization URI for incomplete parameter assignments throws an Exception.");
	});

	QUnit.test("Create request with parameters, no aggregation level and no measueres selected", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();

		var sRefURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results";
		var sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefURI, "URI correctly constructed. ");

		var aDimNames = oQueryResultRequest.getAggregationLevel();
		assert.ok(jQuery.isEmptyObject(aDimNames), "No aggregation level set.");

		var aMeasNames = oQueryResultRequest.getMeasureNames();
		assert.ok(jQuery.isEmptyObject(aMeasNames), "No measues selected.");
	});

	QUnit.module("Requesting")

	QUnit.test("Create request for query results", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();

		oQueryResultRequest.setAggregationLevel([
			"ControllingArea"
		]);
		oQueryResultRequest.addToAggregationLevel([
			"CostCenter"
		]);
		var exception = "ID is not a valid dimension name";
		assert.throws(function() {
			oQueryResultRequest.addToAggregationLevel([
				"ID"
			]);
		}, "Adding wrong dimension throws exception. ");

		oQueryResultRequest.includeDimensionKeyTextAttributes(null, true, true);
		oQueryResultRequest.includeDimensionKeyTextAttributes("ControllingArea", true, false);

		oQueryResultRequest.setMeasures(); // all measures!
		oQueryResultRequest.includeMeasureRawFormattedValueUnit(null, false, true);
		oQueryResultRequest.includeMeasureRawFormattedValueUnit("ActualPlannedCostsDifference", true, false);
		var sRefSetURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results";
		var sSetURI = oQueryResultRequest.getURIToQueryResultEntitySet();
		assert.strictEqual(sSetURI, sRefSetURI, "QueryResultEntitySet URI correctly constructed.");

		var sRefEntriesURI = sRefSetURI + "?$select=ControllingArea,CostCenter,CostCenterText,ActualPlannedCostsDifference,id";
		oQueryResultRequest.setRequestOptions(true);
		var sEntriesURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sEntriesURI, sRefEntriesURI, "QueryResultEntries URI correctly constructed.");

		var aRefDimNames = [
			"ControllingArea", "CostCenter"
		];
		var aDimNames = oQueryResultRequest.getAggregationLevel();
		assert.deepEqual(aDimNames, aRefDimNames, "Aggregation levels correctly set.");

		var aRefMeasNames = [
			"ActualCosts", "PlannedCosts", "ActualPlannedCostsDifference", "ActualPlannedCostsPercentage"
		];
		var aMeasNames = oQueryResultRequest.getMeasureNames();
		assert.deepEqual(aMeasNames, aRefMeasNames, "Measures correctly set.");
	});

	QUnit.test("Create filter expressions on the query result", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();

		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		oFilterExpression.addCondition("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1000");
		oFilterExpression.addSetCondition("Currency", [
			"EUR", "USD", "GBP"
		]);
		oFilterExpression.addCondition("CostCenter", sap.ui.model.FilterOperator.BT, "100-1000", "200-3000");

		var sRefFilterOptionString = "(CostCenter eq %27100-1000%27 or (CostCenter ge %27100-1000%27 and CostCenter le %27200-3000%27)) and (Currency eq %27EUR%27 or Currency eq %27USD%27 or Currency eq %27GBP%27)";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sSetURI, sRefSetURI, "FilterExpression URI correctly constructed.");
		assert.ok(sFilterOptionString.match(/CostCenter eq %27100-1000%27/g).length == 1, "Repeated input of equal filter expression is ignored.");

		var sRefSetURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results";
		var sSetURI = oQueryResultRequest.getURIToQueryResultEntitySet();
		assert.strictEqual(sSetURI, sRefSetURI, "QueryResultEntitySet URI correctly constructed.");

		var sRefEntriesURI = sRefSetURI + "?$filter=(CostCenter eq %27100-1000%27 or (CostCenter ge %27100-1000%27 and CostCenter le %27200-3000%27)) and (Currency eq %27EUR%27 or Currency eq %27USD%27 or Currency eq %27GBP%27)";
		var sEntriesURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sEntriesURI, sRefEntriesURI, "QueryResultEntries URI correctly constructed.");
	});

	QUnit.test("Fetch value help for some parameters with filter", function(assert) {
		var oModel = getModelInstance();
		var oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults");

		var oParameter = oQueryResult.getParameterization().findParameterByName("P_CostCenter");
		assert.ok(oParameter, "Parameter was found.");
		//TODO fails with current metadata
// 		assert.ok(oParameter.isValueSetAvailable(), "ValueSet for parameter is available.");

		// 1. plain list
		var oParamValueSetRequest = new odata4analytics.ParameterValueSetRequest(oParameter);
		oParamValueSetRequest.includeParameterText(true);
		var sRefParameterValueSetURI = "/ActualPlannedCosts?$select=P_CostCenter";
		var sParameterValueSetURI = oParamValueSetRequest.getURIToParameterValueSetEntries();
		assert.strictEqual(sParameterValueSetURI, sRefParameterValueSetURI, "ParamValueSet URI correctly constructed.");

		// 2. filtered list
		var oBaseParameter = oQueryResult.getParameterization().findParameterByName("P_ControllingArea");
		assert.ok(oBaseParameter, "Succeeded to look up object for parameter ControllingArea");

		var oFilterExpression = oParamValueSetRequest.getFilterExpression();
		assert.ok(oFilterExpression, "Filter expression found.");
		oFilterExpression.addCondition(oBaseParameter.getName(), sap.ui.model.FilterOperator.EQ, "US01");
		var sRefFilterOptionString = "(P_ControllingArea eq %27US01%27)";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterExpression URI correctly constructed.");

		var sURIToPVS = oParamValueSetRequest.getURIToParameterValueSetEntries();
		var sRefURIToPVS = "/ActualPlannedCosts?$select=P_CostCenter&$filter=(P_ControllingArea eq %27US01%27)";
		assert.strictEqual(sURIToPVS, sRefURIToPVS, "URI to param value set correctly constructed.");
	});

	QUnit.test("Fetch value help for some query result dimension", function(assert) {
		var oModel = getModelInstance();
		var oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults");
		var oParamRequest = new odata4analytics.ParameterizationRequest(oQueryResult.getParameterization());

		oParamRequest.setParameterValue("P_ControllingArea", "US01");
		oParamRequest.setParameterValue("P_CostCenter", "");
		oParamRequest.setParameterValue("P_CostCenterTo", "");

		var oDimension = oQueryResult.findDimensionByName("CostCenter");

		// 1. plain list
		var oDimMemberSetRequest = new odata4analytics.DimensionMemberSetRequest(oDimension, oParamRequest, false);
		oDimMemberSetRequest.includeDimensionTextAttributes(true);
		var sRefURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results?$select=CostCenter,CostCenterText";
		var sURI = oDimMemberSetRequest.getURIToDimensionMemberEntries();
		assert.strictEqual(sURI, sRefURI, "Dimension members were found.");

		// 2. filtered list
		var oBaseDim = oQueryResult.findDimensionByName("ControllingArea");
		var oFilterExpression = oDimMemberSetRequest.getFilterExpression();
		oFilterExpression.addCondition(oBaseDim.getName(), sap.ui.model.FilterOperator.EQ, "US01");
		sRefURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results?$select=CostCenter,CostCenterText&$filter=(ControllingArea eq %27US01%27)";
		sURI = oDimMemberSetRequest.getURIToDimensionMemberEntries();
		assert.strictEqual(sURI, sRefURI, "Dimension members were found filtered.");
	});

	QUnit.test("Create sorting expressions on the query result", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();

		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		assert.ok(oFilterExpression instanceof odata4analytics.FilterExpression, "FilterExpression instance created.");
		var oSortExpression = oQueryResultRequest.getSortExpression();
		assert.ok(oSortExpression instanceof odata4analytics.SortExpression, "SortExpression instance created.");

		oQueryResultRequest.setAggregationLevel([
			"ControllingArea", "CostCenter"
		]);
		oQueryResultRequest.setMeasures();

		oSortExpression.addSorter("CostCenter", odata4analytics.SortOrder.Ascending);

		oFilterExpression.addSetCondition("Currency", [
			"EUR", "USD", "GBP"
		]);
		oFilterExpression.addCondition("CostCenter", sap.ui.model.FilterOperator.BT, "100-1000", "200-3000");

		var sRefBaseURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results?$select=ControllingArea,CostCenter,ActualCosts,PlannedCosts,ActualPlannedCostsDifference,ActualPlannedCostsPercentage&$filter=";

		var sRefFilterOptionString = "((CostCenter ge %27100-1000%27 and CostCenter le %27200-3000%27)) and (Currency eq %27EUR%27 or Currency eq %27USD%27 or Currency eq %27GBP%27)";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterOptionString correctly constructed.");

		sRefBaseURI += sRefFilterOptionString;

		var sSorterString = "&$orderby=CostCenter asc";
		var sEntriesURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sEntriesURI, sRefBaseURI + sSorterString, "QueryResultEntries URI correctly constructed.");

		oSortExpression.addSorter("ControllingArea", odata4analytics.SortOrder.Descending);
		sSorterString = "&$orderby=CostCenter asc,ControllingArea desc";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sSorterString, "QueryResultEntries URI correctly constructed with 2 sorters.");

		oSortExpression.removeSorter("ControllingArea");
		sSorterString = "&$orderby=CostCenter asc";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sSorterString, "QueryResultEntries URI correctly constructed with 1 sorter.");

		oSortExpression.clear();
		sSorterString = "";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sSorterString, "QueryResultEntries URI correctly constructed without sorters.");
	});

	QUnit.test("Fetch value help for some parameter with sorting", function(assert) {
		var oModel = getModelInstance();
		var oQueryResult = oModel.findQueryResultByName("ActualPlannedCostsResults");
		oParamRequest = new odata4analytics.ParameterizationRequest(oQueryResult.getParameterization());

		var oQueryResultRequest = new odata4analytics.QueryResultRequest(oQueryResult);
		oQueryResultRequest.setParameterizationRequest(oParamRequest);

		var oParameter = oQueryResult.getParameterization().findParameterByName("P_ControllingArea");
		assert.ok(oParameter, "Parameter was found.");
		//TODO fails with current metadata
// 		assert.ok(oParameter.isValueSetAvailable(), "ValueSet for parameter is available.");

		// 1. plain list
		var oParamValueSetRequest = new odata4analytics.ParameterValueSetRequest(oParameter);
		oParamValueSetRequest.includeParameterText(true);
		var sRefParameterValueSetURI = "/ActualPlannedCosts?$select=P_ControllingArea";
		var sParameterValueSetURI = oParamValueSetRequest.getURIToParameterValueSetEntries();
		assert.strictEqual(sParameterValueSetURI, sRefParameterValueSetURI, "ParamValueSet URI correctly constructed.");

		// 2. sorted list
		var oBaseParameter = oQueryResult.getParameterization().findParameterByName("P_ControllingArea");
		assert.ok(oBaseParameter, "Succeeded to look up object for parameter ControllingArea");
		//TODO make this work
// 		var oSortExpression = oQueryResultRequest.getSortExpression();
// 		oSortExpression.addSorter("P_ControllingArea", odata4analytics.SortOrder.Ascending);
// 		var sURIToPVS = oParamValueSetRequest.getURIToParameterValueSetEntries();
// 		var sRefURIToPVS = "";
// 		assert.strictEqual(sURIToPVS, sRefURIToPVS, "URI to param value set correctly constructed.");

	});

	QUnit.test("Add paging and a count to the query result", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();

		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		var oSortExpression = oQueryResultRequest.getSortExpression();

		oQueryResultRequest.setAggregationLevel([
			"ControllingArea", "CostCenter"
		]);
		oQueryResultRequest.setMeasures();

		oSortExpression.addSorter("CostCenter", odata4analytics.SortOrder.Ascending);
		oSortExpression.addSorter("ControllingArea", odata4analytics.SortOrder.Descending);
		oFilterExpression.addSetCondition("Currency", [
			"EUR", "USD", "GBP"
		]);
		oFilterExpression.addCondition("CostCenter", sap.ui.model.FilterOperator.BT, "100-1000", "200-3000");

		var sRefBaseURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results?$select=ControllingArea,CostCenter,ActualCosts,PlannedCosts,ActualPlannedCostsDifference,ActualPlannedCostsPercentage&$filter=";

		var sRefFilterOptionString = "((CostCenter ge %27100-1000%27 and CostCenter le %27200-3000%27)) and (Currency eq %27EUR%27 or Currency eq %27USD%27 or Currency eq %27GBP%27)";
		oQueryResultRequest.setResultPageBoundaries(1, 10);
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterOptionString correctly constructed.");

		sRefBaseURI += sRefFilterOptionString;
		var sRefCountURI = "&$orderby=CostCenter asc,ControllingArea desc&$top=10&$inlinecount=allpages";
		oQueryResultRequest.setRequestOptions(null, true);
		var sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sRefCountURI, "QueryResultEntries URI correctly constructed with PageBoundaries from 1 to 10.");

		oQueryResultRequest.setResultPageBoundaries(null, 500);
		sRefCountURI = "&$orderby=CostCenter asc,ControllingArea desc&$top=500&$inlinecount=allpages";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sRefCountURI, "QueryResultEntries URI correctly constructed with PageBoundaries up to 500.");

		oQueryResultRequest.setResultPageBoundaries(500, null);
		sRefCountURI = "&$orderby=CostCenter asc,ControllingArea desc&$skip=499&$inlinecount=allpages";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sRefCountURI, "QueryResultEntries URI correctly constructed with PageBoundaries from 500");

		oQueryResultRequest.setResultPageBoundaries(500, 500);
		sRefCountURI = "&$orderby=CostCenter asc,ControllingArea desc&$top=1&$skip=499&$inlinecount=allpages";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sRefCountURI, "QueryResultEntries URI correctly constructed with PageBoundaries from 500 to 500.");

		oQueryResultRequest.setResultPageBoundaries(null, null);
		sRefCountURI = "&$orderby=CostCenter asc,ControllingArea desc&$inlinecount=allpages";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefBaseURI + sRefCountURI, "QueryResultEntries URI correctly constructed without PageBoundaries.");
	});

	QUnit.module("UI5 Multi Filters")

	QUnit.test("Combining with some simple condition", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();
		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		var oFilter1 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "GBP");
		var oFilter2 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "USD");
		var oFilter3 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "EUR");
		var oMultiFilter = new sap.ui.model.Filter(aFilters = [
			oFilter1, oFilter2, oFilter3
		], bAnd = false);
		oFilterExpression.addUI5FilterConditions([
			oMultiFilter
		]);
		oFilterExpression.addSetCondition("CostCenter", [
			"100-1000", "100-1100"
		]);

		var aUI5FilterArray = oFilterExpression.getExpressionAsUI5FilterArray();
		assert.ok((aUI5FilterArray instanceof Array && aUI5FilterArray[0] instanceof sap.ui.model.Filter), "UI5 filter array correctly constructed.");

		var sRefFilterOptionString = "(CostCenter eq %27100-1000%27 or CostCenter eq %27100-1100%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterOptionString correctly constructed.");
	});

	QUnit.test("Combining with other UI5 filters on same sPath", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();
		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		var oFilter1 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "GBP");
		var oFilter2 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "USD");
		var oFilter3 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "EUR");

		var oMultiFilter = new sap.ui.model.Filter(aFilters = [
			oFilter1, oFilter2, oFilter3
		], bAnd = false);
		oFilterExpression.addUI5FilterConditions([
			oMultiFilter
		]);
		oFilterExpression.addUI5FilterConditions([
			new sap.ui.model.Filter("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1000"), new sap.ui.model.Filter("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1100")
		]);

		var aUI5FilterArray = oFilterExpression.getExpressionAsUI5FilterArray();
		assert.ok((aUI5FilterArray instanceof Array && aUI5FilterArray[0] instanceof sap.ui.model.Filter), "UI5 filter array correctly constructed.");

		var sRefFilterOptionString = "(CostCenter eq %27100-1000%27 or CostCenter eq %27100-1100%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterOptionString correctly constructed.");

		sRefSetURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results?$filter=(CostCenter eq %27100-1000%27 or CostCenter eq %27100-1100%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefSetURI, "QueryResultEntries URI correctly constructed.");
	});

	QUnit.test("Combining with other UI5 filters on different sPaths", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();
		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		var oFilter1 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "GBP");
		var oFilter2 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "USD");
		var oFilter3 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "EUR");

		var oMultiFilter = new sap.ui.model.Filter(aFilters = [
			oFilter1, oFilter2, oFilter3
		], bAnd = false);
		oFilterExpression.addUI5FilterConditions([
			oMultiFilter
		]);
		oFilterExpression.addUI5FilterConditions([
			new sap.ui.model.Filter("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1000"), new sap.ui.model.Filter("ControllingArea", sap.ui.model.FilterOperator.EQ, "US01")
		]);

		var aUI5FilterArray = oFilterExpression.getExpressionAsUI5FilterArray();
		assert.ok((aUI5FilterArray instanceof Array && aUI5FilterArray[0] instanceof sap.ui.model.Filter), "UI5 filter array correctly constructed.");

		var sRefFilterOptionString = "(ControllingArea eq %27US01%27) and (CostCenter eq %27100-1000%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterOptionString correctly constructed.");

		sRefSetURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results?$filter=(ControllingArea eq %27US01%27) and (CostCenter eq %27100-1000%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefSetURI, "QueryResultEntries URI correctly constructed.");
	});

	QUnit.test("Tests 1-3 together", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();
		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		var oFilter1 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "GBP");
		var oFilter2 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "USD");
		var oFilter3 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "EUR");

		var oMultiFilter = new sap.ui.model.Filter(aFilters = [
			oFilter1, oFilter2, oFilter3
		], bAnd = false);
		oFilterExpression.addUI5FilterConditions([
			oMultiFilter
		]);
		oFilterExpression.addUI5FilterConditions([
			new sap.ui.model.Filter("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1000"), new sap.ui.model.Filter("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1100"), new sap.ui.model.Filter("ControllingArea", sap.ui.model.FilterOperator.EQ, "US01")
		]);
		var aUI5FilterArray = oFilterExpression.getExpressionAsUI5FilterArray();

		assert.ok((aUI5FilterArray instanceof Array && aUI5FilterArray[0] instanceof sap.ui.model.Filter), "UI5 filter array correctly constructed.");

		var sRefFilterOptionString = "(ControllingArea eq %27US01%27) and (CostCenter eq %27100-1000%27 or CostCenter eq %27100-1100%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterOptionString correctly constructed.");

		var oRefProps = oFilterExpression.getReferencedProperties();

		sRefSetURI = "/ActualPlannedCosts(P_ControllingArea=%27US01%27,P_CostCenter=%27%27,P_CostCenterTo=%27%27)/Results?$filter=(ControllingArea eq %27US01%27) and (CostCenter eq %27100-1000%27 or CostCenter eq %27100-1100%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		sSetURI = oQueryResultRequest.getURIToQueryResultEntries();
		assert.strictEqual(sSetURI, sRefSetURI, "QueryResultEntries URI correctly constructed.");
	});

	QUnit.test(" Multiple UI5 filter arrays are combined with AND", function(assert) {
		var oQueryResultRequest = getQueryResultRequest();
		var oFilterExpression = oQueryResultRequest.getFilterExpression();
		var oFilter1 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "GBP");
		var oFilter2 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "USD");
		var oFilter3 = new sap.ui.model.Filter("Currency", sap.ui.model.FilterOperator.EQ, "EUR");

		var oMultiFilter = new sap.ui.model.Filter(aFilters = [
			oFilter1, oFilter2, oFilter3
		], bAnd = false);
		oFilterExpression.addUI5FilterConditions([
			oMultiFilter
		]);
		oFilterExpression.addUI5FilterConditions([
			new sap.ui.model.Filter("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1100"), new sap.ui.model.Filter("ControllingArea", sap.ui.model.FilterOperator.EQ, "US01")
		]);
		oFilterExpression.addUI5FilterConditions([
			new sap.ui.model.Filter("CostCenter", sap.ui.model.FilterOperator.EQ, "100-1000"), new sap.ui.model.Filter("ControllingArea", sap.ui.model.FilterOperator.EQ, "US02")
		]);

		var aUI5FilterArray = oFilterExpression.getExpressionAsUI5FilterArray();
		assert.ok((aUI5FilterArray instanceof Array && aUI5FilterArray[0] instanceof sap.ui.model.Filter), "UI5 filter array correctly constructed.");

		var sRefFilterOptionString = "(ControllingArea eq %27US01%27 or ControllingArea eq %27US02%27) and (CostCenter eq %27100-1100%27 or CostCenter eq %27100-1000%27) and (((Currency eq %27GBP%27) or (Currency eq %27USD%27) or (Currency eq %27EUR%27)))";
		var sFilterOptionString = oFilterExpression.getURIFilterOptionValue();
		assert.strictEqual(sFilterOptionString, sRefFilterOptionString, "FilterOptionString correctly constructed.");
	});
</script>
</head>
<body>
	<h1 id="qunit-header">QUnit tests: Data binding odata4analytics.js</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<ol id="qunit-tests"></ol>
	<br>
	<div id="target1"></div>
	<div id="target2"></div>
</body>
</html>
