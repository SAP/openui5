<!DOCTYPE HTML>

<!-- 
  Tested sap.ui.model.odata.ODataModel
  Author: d050084
-->

<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script>
	//fix IE 11 bug 
	window.ActiveXObject = undefined;
</script>
<!-- Initialization -->
<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-libs="sap.ui.commons,sap.ui.table,sap.m">
	</script>

<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css"
	media="screen" />
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>

<!-- Test functions -->
<script language="javascript">
	
	jQuery.sap.require("sap.ui.core.util.MockServer");

	var sServiceUri = "/SalesOrderSrv/";
	var sDataRootPath =  "testdata/SalesOrder/";
	var oModel, spy;
	
	var oMockServer = new sap.ui.core.util.MockServer({
		rootUri: sServiceUri
	});
	
	function initServer() {
		oMockServer.simulate("testdata/SalesOrder/metadata.xml", sDataRootPath);
		oMockServer.start();
	}
	
	function stopServer() {
		oMockServer.stop();
	}
	
	function initModel(bJSON, sUpdateMethod) {
		bJSON = bJSON !== false;
		return new sap.ui.model.odata.v2.ODataModel(sServiceUri, {json: bJSON, defaultUpdateMethod : sUpdateMethod});
	}

	function removeSharedMetadata() {
		var sURI = sServiceUri.replace(/\/$/, "");
		if (sap.ui.model.odata.v2.ODataModel.mServiceData
				&& sap.ui.model.odata.v2.ODataModel.mServiceData[sURI]) {
			delete sap.ui.model.odata.v2.ODataModel.mServiceData[sURI].oMetadata;
		}
	}
	
	/**
	 * Removes all shared Metadata
	 */
	function cleanServiceDataCache() {
		sap.ui.model.odata.v2.ODataModel.mServiceData = {};
	}
	
	module("ODataModelV2 XML", {
		setup : function() {
			initServer();
			oModel = initModel(false);
		},
		teardown : function() {
			oModel = undefined;
			removeSharedMetadata();
			stopServer();
		}
	});

	asyncTest("read XML", function() {
		oModel.read("/ProductSet", {
			success : function() {
				equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "Flyer", "absolute path without context");
				oModel.createBindingContext("/ProductSet('AD-1000')", null, function(newContext) {
					equal(newContext.getProperty("Name"), "Flyer", "relative path with context");
					start(); // resume normal testing
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});
	
	module("ODataModelV2 JSON", {
		setup : function() {
			initServer();
			oModel = initModel();
		},
		teardown : function() {
			oModel = undefined;
			removeSharedMetadata();
			stopServer();
		}
	});

	test("Mockserver initialisation",  function(){
		ok(oMockServer,"MockServer created");
		ok(oMockServer.isStarted(), "Mock server is started");
	});
	
	asyncTest("test init Model", function() {
		oModel = initModel(true);	
		var fnTest = function() {
			ok(true, "metadataloaded");
			start();
		}
		oModel.attachMetadataLoaded(this, fnTest);
	});
	
	asyncTest("read JSON", function() {
		oModel.read("/ProductSet", {
			success : function() {
				equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "Flyer", "absolute path without context");
				oModel.createBindingContext("/ProductSet('AD-1000')", null, function(newContext) {
					equal(newContext.getProperty("Name"), "Flyer", "relative path with context");
					start(); // resume normal testing
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});

	asyncTest("test oDataModel read with URLParams and headers JSON", function() {
		oModel.read("/ProductSet", {
			urlParameters : {
				"$top" : "1",
				"$skip" : "1"
			},
			headers : {
				"myCustomHeader" : "xyz"
			},
			success : function(oData, oResponse) {
				ok(oData.results.length === 1, "length check");
				var oP = oModel
						.getProperty("/ProductSet('HT-1000')");
				ok(oP, "one entry loaded");
				ok(oP.Name === "Notebook Basic 15",
						"one entry loaded");
				start();
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});
	
	asyncTest("test metadata promise", function() {
		oModel = initModel(true);
		
		var oPromise = oModel.metadataLoaded();
		ok(oPromise, "promise exists");
		oPromise.then(function(result){
			ok(true, "Promise resolved");
			start();
		}, function(){
			ok(false, "Promise rejected");
		});
	});
	
	asyncTest("test metadata promise and refresh", function() {
		oModel = initModel(true);
		
		var oPromise = oModel.metadataLoaded();
		ok(oPromise, "promise exists");
		oPromise.then(function(result){
			ok(true, "Promise resolved");
			var oNewP = oModel.refreshMetadata();
			ok(oNewP, "oNewP promise exists");
			return oNewP;
		}, function(){
			ok(false, "Promise rejected");
		})
		.then(function(result){
			ok(true, "oNewP Promise resolved");
			var oNewP2 = oModel.refreshMetadata();
			ok(oNewP2, "oNewP2 promise exists");
			return oNewP2;
		}, function(){
			ok(false, "oNewP Promise rejected");
		})
		.then(function(result){
			ok(true, "oNewP2 Promise resolved");
			start();
		}, function(){
			ok(false, "oNewP2 Promise rejected");
		});
	});
	
	asyncTest("test metadata promise rejected refresh", function() {
		
		var sTempService = sServiceUri;
		sServiceUri = "/doesnotWork/";
		oModel = initModel();
		var oPromise = oModel.metadataLoaded();
		ok(oPromise, "promise exists");
		oPromise.then(function(result){
			ok(false, "Promise resolved which should not happen");
		}, function(){
			ok(false, "Promise rejected which should never happen");
		});
		
		var oNewP = oModel.refreshMetadata();
		ok(oNewP, "oNewP promise exists");
		oNewP.then(function(result){
			ok(false, "oNewP Promise resolved");
		}, function(){
			ok(true, "oNewP Promise rejected");
			removeSharedMetadata();
			sServiceUri = sTempService;
			start();
		});
		
	});
	
	asyncTest("test metadata promise rejected refresh and resolve", function() {
		cleanServiceDataCache();
		
		var sTempService = sServiceUri;
		sServiceUri = "/doesnotWork/";
		oModel = initModel();
		
		var oPromise = oModel.metadataLoaded();
		ok(oPromise, "promise exists");
		oPromise.then(function(result){
			ok(true, "Promise resolved after metadata url is fixed");
		}, function(){
			ok(false, "Promise rejected which should never happen");
		});
		
		var oNewP = oModel.refreshMetadata();
		ok(oNewP, "oNewP promise exists");
		oNewP.then(function(result){
			ok(false, "oNewP Promise resolved");
		}, function(){
			ok(true, "oNewP Promise rejected");
			// fix url
			oModel.oMetadata.sUrl = sTempService + "$metadata";
			var oNewP2 = oModel.refreshMetadata();
			ok(oNewP2, "oNewP2 promise exists");
			return oNewP2;
		})	
		.then(function(result){
			ok(true, "oNewP2 Promise resolved");
			removeSharedMetadata();		
			sServiceUri = sTempService;
			start();
		}, function(){
			ok(false, "oNewP2 Promise rejected");
		});
		
	});
	
	asyncTest("test metadata promise ok then refresh failed", function() {
		
		oModel = initModel(true);

		var sTempService = sServiceUri;
		var oPromise = oModel.metadataLoaded();
		ok(oPromise, "promise exists");
		oPromise.then(function(result){
			ok(true, "Promise resolved");
			sServiceUri = "/doesnotWork/";
			oModel.oMetadata.sUrl = sServiceUri + "$metadata";
			var oNewP = oModel.refreshMetadata();
			ok(oNewP, "oNewP promise exists");
			return oNewP;
		}, function(){
			ok(false, "Promise rejected which should never happen");
		})
		.then(function(result){
			ok(false, "oNewP Promise resolved");
		}, function(){
			ok(true, "oNewP Promise rejected");
			removeSharedMetadata();
			sServiceUri = sTempService;
			start();
		});
	});
	
	asyncTest("test metadata promise ok then refresh failed then refresh ok", function() {
		
		oModel = initModel(true);

		var oPromise = oModel.metadataLoaded();
		var sTempService = sServiceUri;
		ok(oPromise, "promise exists");
		oPromise.then(function(result){
			ok(true, "Promise resolved");
			sServiceUri = "/doesnotWork/";
			oModel.oMetadata.sUrl = sServiceUri + "$metadata";
			var oNewP = oModel.refreshMetadata();
			ok(oNewP, "oNewP promise exists");
			return oNewP;
		}, function(){
			ok(false, "Promise rejected which should never happen");
		})
		.then(function(result){
			ok(false, "oNewP Promise resolved");
		}, function(){
			ok(true, "oNewP Promise rejected");
			// fix url
			oModel.oMetadata.sUrl = sTempService + "$metadata";
			var oNewP2 = oModel.refreshMetadata();
			ok(oNewP2, "oNewP promise exists");
			return oNewP2;
		})
		.then(function(result){
			ok(true, "oNewP2 Promise resolved");
			removeSharedMetadata();
			sServiceUri = sTempService;
			start();
		}, function(){
			ok(false, "oNewP2 Promise rejected");
		});

	});

	asyncTest("test oDataModel read filter test", function() {
		oModel.read("/ProductSet", {
			filters : [ new sap.ui.model.Filter("ProductID", "EQ",
					"HT-1000") ],
			success : function(oData, oResponse) {
				ok(oData.results.length === 1, "length check");
				var oP = oModel.getProperty("/ProductSet('HT-1000')");
				ok(oP, "one entry loaded");
				ok(oP.Name === "Notebook Basic 15", "one entry loaded");
				start();
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});
	
	asyncTest("test oDataModel read count request with filter test", function() {
		oModel.read("/ProductSet/$count", {
			filters : [ new sap.ui.model.Filter("ProductID", "EQ",
					"HT-1000") ],
			success : function(oData, oResponse) {
				ok(oData === "1", "length check");
				start();
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});

	asyncTest("test oDataModel read sort test", function() {
		oModel.read("/ProductSet", {
			sorters : [ new sap.ui.model.Sorter("ProductID", true) ],
			filters : [ new sap.ui.model.Filter("ProductID", "EQ", "HT-1000"),
					new sap.ui.model.Filter("ProductID", "EQ", "AD-1000"),
					new sap.ui.model.Filter("ProductID", "EQ", "HT-1041") ],
			success : function(oData, oResponse) {
				ok(oData.results.length === 3, "length check");
				ok(oData.results[0].ProductID === "HT-1041", "sort check");
				ok(oData.results[1].ProductID === "HT-1000", "sort check");
				ok(oData.results[2].ProductID === "AD-1000", "sort check");

				start();
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

	});

	asyncTest("test oDataModel read error test", function() {
		oModel.read("/ProductXYSet", {
			success : function(oData, oResponse) {
				ok(false, "request succeeded...error expected");
			},
			error : function(oError) {
				ok(oError.statusCode === "404", "error code");
				ok(true, "request failed");
				start();
			}
		});
	});

	asyncTest("test oDataModel remove error test", function() {
		oModel.remove("/ProductSet('Error')", {
			success : function(oData, oResponse) {
				ok(false, "request succeeded...error expected");
			},
			error : function(oError) {
				ok(oError, "error succeeded");
				start();
			}
		});
	});

	asyncTest("test oDataModel remove error test batch off", function() {
		oModel.setUseBatch(false);
		oModel.remove("/ProductSet('Error')", {
			success : function(oData, oResponse) {
				ok(false, "request succeeded...error expected");
			},
			error : function(oError) {
				ok(oError, "error succeeded");
				start();
			}
		});
	});

	
	asyncTest("test oDataModel read with no batchgroup ids", function() {
		var iCount = 0;
		var bRead1 = false;
		var bRead2 = false;
		
		oModel.read("/ProductSet", {
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		oModel.read("/ContactSet", {
			success : function(oData, oResponse) {
				bRead2 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 1 && bRead1 && bRead2) {
				ok(true, "requests with no ids should should be combined in a single batch request");
				start();
			}
		});
	});

	asyncTest("test oDataModel read with different batchgroup ids", function() {
		var iCount = 0;
		var bRead1 = false;
		var bRead2 = false;
		
		oModel.read("/ProductSet", {
			batchGroupId : "myId1",
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		oModel.read("/ContactSet", {
			batchGroupId : "myId2",
			success : function(oData, oResponse) {
				bRead2 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bRead1 && bRead2) {
				ok(true, "requests with different ids should be in separate batch requests");
				start();
			}
		});
	});

	asyncTest("test oDataModel read with same batchGroupIds", function() {
		var iCount = 0;
		var bRead1 = false;
		var bRead2 = false;
		
		oModel.read("/ProductSet", {
			batchGroupId : "myId",
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		oModel.read("/ContactSet", {
			batchGroupId : "myId",
			success : function(oData, oResponse) {
				bRead2 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		oModel.attachBatchRequestCompleted(
			this,
			function(test) {
				iCount++;
				if (iCount === 1 && bRead1 && bRead2) {
					ok(true, "requests with same id should be combined in a batch request");
					start();
				}
			});
	});

	asyncTest("test oDataModel read deferred with batchGroupId", function() {
		oModel.setDeferredBatchGroups([ "myId" ]);
		oModel.read("/ProductSet", {
			batchGroupId : "myId",
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				start();
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.submitChanges();
	});

	asyncTest("test oDataModel read deferred with default batchGroupIds", function() {
		var iCount = 0;
		var bRead1 = false;
		var bRead2 = false;
		
		oModel.setDeferredBatchGroups([ undefined ]);
		oModel.read("/ProductSet", {
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.read("/ContactSet", {
			success : function(oData, oResponse) {
				bRead2 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 1 && bRead1 && bRead2) {
				ok(true, "requests with same default id should be combined in a batch request");
				start();
			}
		});
		oModel.submitChanges();
	});

	asyncTest("test oDataModel read deferred with same batchGroupIds", function() {
		var iCount = 0;
		var bRead1 = false;
		var bRead2 = false;
				
		oModel.setDeferredBatchGroups([ "myId1" ]);
		oModel.read("/ProductSet", {
			batchGroupId : "myId1",
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.read("/ContactSet", {
			batchGroupId : "myId1",
			success : function(oData, oResponse) {
				bRead2 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 1 && bRead1 && bRead2) {
				ok(true, "requests with same id should be combined in a batch request");
				start();
			}
		});
		oModel.submitChanges();
	});

	asyncTest("test oDataModel read deferred with different batchGroupIds", function() {
		var iCount = 0;
		var bRead1 = false;
		var bRead2 = false;
		
		oModel.setDeferredBatchGroups([ "myId1", "myId2" ]);
		oModel.read("/ProductSet", {
			batchGroupId : "myId1",
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.read("/ContactSet", {
			batchGroupId : "myId2",
			success : function(oData, oResponse) {
				bRead2 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
				iCount++;
				if (iCount === 2 && bRead1 && bRead2) {
					ok(true, "requests with different ids should be in separate batch requests");
					start();
				}
			});
		oModel.submitChanges();
	});

	asyncTest("test oDataModel read deferred with batchGroupId and submitChanges callback handler test", function() {
		var bSuccess = false;
		oModel.setDeferredBatchGroups([ "myId" ]);
		oModel.read("/ProductSet", {
			batchGroupId : "myId",
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	
		oModel.submitChanges({
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				ok(bSuccess, "callback handler of internal request should have been called")
				start();
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});

	asyncTest("test oDataModel bind Object", function() {
		var iCount = 0;
		var oTxt = new sap.ui.commons.TextField({
			value : "{Category}"
		});
		oTxt.placeAt("target1");
		oTxt.setModel(oModel);
		oTxt.bindObject("/VH_CategorySet('Headsets')");

		var fnCheck = function() {
			iCount++;
			ok(iCount === 1, "request performed");
			equal(oModel.getProperty("/VH_CategorySet('Headsets')/Category"), "Headsets", "Category loaded check");
			oTxt.destroy();
			oModel.detachBatchRequestCompleted(fnCheck);
			start();
		}
		oModel.attachBatchRequestCompleted(this, fnCheck);
	});

	asyncTest("test oDataModel read and bind Object", function() {
		var iCount = 0;
		var oTxt = new sap.ui.commons.TextField({
			value : "{Category}"
		});
		oTxt.placeAt("target1");
		oTxt.setModel(oModel);

		oModel.read("/VH_CategorySet", {
			batchGroupId : "myId",
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bSuccess = true;

				equal(oModel.getProperty("/VH_CategorySet('Headsets')/Category"), "Headsets", "Category loaded check");
				// should not fire a request as data is already loaded by read above
				oTxt.bindObject("/VH_CategorySet('Headsets')");

				var fnCheck = function(oEvent) {
					iCount++;
					if (iCount === 2) {
						ok(false, "request performed but should not go out as data already loaded by read request before");
					}
					oTxt.destroy();
					oModel.detachBatchRequestCompleted(fnCheck);
					start();
				}
				oModel.attachBatchRequestCompleted(
					this, fnCheck
				);
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});

	var initTable = function(mEntities) {
		var oTable = new sap.ui.table.Table();
		for (var i = 0; i < mEntities.categories.properties.length; i++) {
			oTable.addColumn(new sap.ui.table.Column().setLabel(
					new sap.ui.commons.Label({
						text : mEntities.categories.properties[i]
					})).setTemplate(
					new sap.ui.commons.TextField().bindProperty("value",
							mEntities.categories.properties[i]))
					.setFilterProperty(mEntities.categories.properties[i]));
		}
		return oTable;
	}

	asyncTest("test oDataModel listbinding with table", function() {
		var iCount = 0;

		var mEntities = {
			categories : {
				collection : "/VH_CategorySet",
				properties : [ "Category" ]
			}
		}
		var oTable = initTable(mEntities);

		oTable.placeAt("target1");

		oTable.setModel(oModel);

		oTable.bindRows({
			path : mEntities.categories.collection
		});

		var fnCheck = function() {
			iCount++;
			ok(iCount === 1, "request performed");
			equal(
					oModel
							.getProperty("/VH_CategorySet('Beamers')/Category"),
					"Beamers", "Category loaded check");
			equal(
					oModel
							.getProperty("/VH_CategorySet('Headsets')/Category"),
					"Headsets", "Category loaded check");
			ok(oTable.getBinding('rows').getLength() >= 2,
					"Category size check");
			oTable.destroy();
			oModel.detachBatchRequestCompleted(fnCheck);
			start();

		}
		oModel.attachBatchRequestCompleted(this, fnCheck);
	});

	asyncTest("test oDataModel listbinding with aggregation binding and read in default batch group", function() {
		var iCallCount = 0;
		var bRead1 = false;
		var mEntities = {
			categories : {
				collection : "/VH_CategorySet",
				properties : [ "Category" ]
			}
		}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");
		sap.ui.getCore().applyChanges();
		oTable.setModel(oModel);
		oTable.bindRows({
			path : mEntities.categories.collection
		});
		oModel.read("/VH_CategorySet", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bRead1 = true;
				iCallCount++;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		var fnCheck = function() {
			iCallCount++;

			if (iCallCount === 2 && bRead1) {
				ok(true, "request Completed event 1x (==1 request) and succesHandler from read should be called 1x");
				equal(oModel.getProperty("/VH_CategorySet('Beamers')/Category"), "Beamers", "Category loaded check");
				equal(oModel.getProperty("/VH_CategorySet('Headsets')/Category"), "Headsets", "Category loaded check");
				ok(oTable.getBinding('rows').getLength() >= 2, "Category size check");
				oTable.destroy();
				oModel.detachBatchRequestCompleted(fnCheck);
				start();
			}
		}
		oModel.attachBatchRequestCompleted(this, fnCheck);
	});

	asyncTest("test oDataModel listbinding with aggregation binding and read in different batch groups", function() {
		var iCallCount = 0;
		var bRead1 = false;
		var mEntities = {
			categories : {
				collection : "/VH_CategorySet",
				properties : [ "Category" ]
			}
		}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");

		oTable.setModel(oModel);
		
		oTable.bindRows({
			path : mEntities.categories.collection,
			batchGroupId : "myId1"
		});
		oModel.read("/ProductSet", {
			batchGroupId : "myId2",
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
				iCallCount++;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		var fnCheck = function() {
			iCallCount++;
			if (iCallCount === 3 && bRead1) {
				ok(true, "requestCompleted event 2x (==2 requests) and read succes handler should be called 1x");
				equal(oModel.getProperty("/VH_CategorySet('Beamers')/Category"), "Beamers", "Category loaded check");
				equal(oModel.getProperty("/VH_CategorySet('Headsets')/Category"), "Headsets", "Category loaded check");
				ok(oTable.getBinding('rows').getLength() >= 2, "Category size check");
				oTable.destroy();
				oModel.detachBatchRequestCompleted(fnCheck);
				start();
			}
		}
		oModel.attachBatchRequestCompleted(this, fnCheck);
	});

	asyncTest("test oDataModel listbinding with aggregation binding and read in different deferred batch groups", function() {
		var iCallCount = 0;
		var bRead1 = false;
		var mEntities = {
			categories : {
				collection : "/VH_CategorySet",
				properties : [ "Category" ]
			}
		}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");
		oModel.setDeferredBatchGroups([ "myId1", "myId2" ]);
		oTable.setModel(oModel);
		oTable.bindRows({
			path : mEntities.categories.collection,
			batchGroupId : "myId1",
		});
		oModel.read("/ProductSet", {
			batchGroupId : "myId2",
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
				iCallCount++;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		var fnCheck = function(mArguments) {
			iCallCount++;
			if (iCallCount === 3 && bRead1) {
				ok(true, "requestCompleted event 2x (==2 requests) and read succes handler should be called 1x");
				equal(oModel.getProperty("/VH_CategorySet('Beamers')/Category"), "Beamers", "Category loaded check");
				equal(oModel.getProperty("/VH_CategorySet('Headsets')/Category"), "Headsets", "Category loaded check");
				ok(oTable.getBinding('rows').getLength() >= 2, "Category size check");
				oTable.destroy();
				oModel.detachBatchRequestCompleted(fnCheck);
				start();
			}
		}
		oModel.attachBatchRequestCompleted(this, fnCheck);
		oModel.submitChanges();
	});

	asyncTest("test oDataModel use batch off option", function() {
		var iCount = 0;
		var bRead1 = false;
		var bRead2 = false;
		oModel.setUseBatch(false);

		oModel.attachRequestCompleted(this,function(test) {
			iCount++;
			if (iCount === 2 && bRead1 && bRead2) {
				ok(true, "requests with same default id should be in 2 non batch requests");
				start();
			}
		});

		oModel.read("/ProductSet", {
			success : function(oData, oResponse) {
				bRead1 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.read("/VH_CategorySet", {
			success : function(oData, oResponse) {
				bRead2 = true;
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	});

	module("ODataModelV2 write", {
		setup : function() {
			initServer();
			oModel = initModel();
			oModel.setRefreshAfterChange(false);
		},
		teardown : function() {
			oModel = undefined;
			removeSharedMetadata();
			stopServer();
		}
	});

	asyncTest("test oDataModel update", function() {
		var iCount = 0;

		oModel.update("/ProductSet('AD-1000')", {
			Name : "Test"
		}, {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				iCount++;
				start();
			},
			error : function(oError) {
				ok(false, "request failed");
				start();
			},
			merge : true,
			eTag : "*"
		});
	});

	asyncTest("test oDataModel update Read default batchgroup", function() {
		var bUpdate = false;
		var bRead = false;

		oModel.update("/ProductSet('AD-1000')", {
			Name : "Hello"
		}, {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bUpdate = true;
			},
			error : function(oError) {
				ok(false, "request failed");
				start();
			},
			merge : true,
			eTag : "*"
		});

		oModel.read("/ProductSet('AD-1000')", {
			success : function(oData, oResponse) {
				ok(bUpdate, "update should have been called first");
				equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "Hello", "check read change");
				bRead = true;
			},
			error : function(oError) {
				ok(false, "request failed");
				start();
			}
		});
		
		oModel.attachBatchRequestCompleted(this, function(test) {
			if (bRead && bUpdate) {
				ok(true, "requests with same default id should be in 1 batch requests");
				start();
			}
		});
	});

	asyncTest("test oDataModel update and read in different batchgroups",function() {
		var iCount = 0;
		var bUpdate = false;
		var bRead = false;
		
		oModel.update("/ProductSet('AD-1000')", {
				Name : "Hello2"
		    }, {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bUpdate = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			merge: true,
			eTag: "*",
			batchGroupId: "myId1"
		});
		
		oModel.read("/ProductSet('AD-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bRead = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId2"
		});
		
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bRead && bUpdate) {
					ok(true, "requests with same default id should be in 1 batch requests");
					start();
			}
		});
	});
	
	asyncTest("test oDataModel update and 2 read in different deferred and non deferred batchgroups", function() {
		var iCount = 0;
		var bUpdate = false;
		var bRead = false;
		var bRead2 = false;
		oModel.setDeferredBatchGroups(["myId1", "myId2"]);
				
		oModel.update("/ProductSet('AD-1000')", {
				Name : "Hello2"
		    }, {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bUpdate = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			merge: true,
			eTag: "*",
			batchGroupId: "myId1"
		});
		
		oModel.read("/ProductSet('AD-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bRead = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId2"
		});
		
		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bRead2 = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
			
		});
		oModel.submitChanges();

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
		
			if (iCount === 3 && bRead && bUpdate && bRead2) {
					ok(true, "requests with same default id should be in 1 batch requests");
					start();
			}
		});
	});
	
	asyncTest("test oDataModel create", function() {
		var iCount = 0;
		var bCreate = false;

		oModel.create("/ProductSet", {
			"ProductID":"AD-1111",
			"TypeCode":"AD",
			"Category":"Computer system accessories",
			"Name":"Test",
			"NameLanguage":"E",
			"Description":"Flyer for our product palette",
			"DescriptionLanguage":"E",
			"SupplierID":"0100000015",
			"SupplierName":"Robert Brown Entertainment",
			"TaxTarifCode":1,
			"MeasureUnit":"EA",
			"WeightMeasure":"0.01",
			"WeightUnit":"KG",
			"CurrencyCode":"CAD",
			"Price":"0.0",
			"Width":"0.46",
			"Depth":"0.3",
			"Height":"0.03",
			"DimUnit":"M",
			"CreatedAt":"\/Date(1413795983000)\/",
			"ChangedAt":"\/Date(1413795983000)\/"
		    }, {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oData.Name, "Test", "response check");
				equal(oModel.getProperty("/ProductSet('AD-1111')/Name"), "Test", "new data should already be imorpted into model");
				bCreate = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
				
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 1 && bCreate) {
					ok(true, "requests with same default id should be in 1 batch requests");
					start();
			}
		});
	});
	
	asyncTest("test oDataModel delete", function() {
		var iCount = 0;
		var bRemove = false;

		oModel.remove("/ProductSet('AD-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), undefined, "new data should already be imorpted into model");
				bRemove = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			eTag: "*"
		});
		
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 1 && bRemove) {
					ok(true, "requests with same default id should be in 1 batch requests");
					start();
			}
		});
	});
	
	asyncTest("test oDataModel READ and delete in different batch groups, DELETE deferred", function() {
		var iCount = 0;
		var bRead = false;
		var bRemove = false;
		oModel.setDeferredBatchGroups(["myId2"]);
		oModel.read("/ProductSet('AD-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "Flyer", "data read check");
				bRead = true;
				oModel.submitChanges();
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId1"
		});
		
		
		oModel.remove("/ProductSet('AD-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), undefined, "data should also have been removed from the model");
				bRemove = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			eTag: "*",
			batchGroupId: "myId2"
		});
					
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 2 && bRemove && bRead) {
					ok(true, "requests with same default id should be in 1 batch requests");
					start();
			}
		});
	});

	asyncTest("test oDataModel Two Way", function() {
		var iCount = 0;
		var bMetadataLoaded = false;
		var bsetProp = false;
		oModel.setDefaultBindingMode("TwoWay");
				
		// make request non deferred...
		oModel.setChangeBatchGroups({
			"*" : {batchgroupId : "myId"}
			
		});

		var mEntities = {
				categories: { 
					collection: "/ProductSet", 
					properties: ["Name"]
				}
			}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");
		
		oTable.setModel(oModel);
		bMetadataLoaded = true;
		oTable.bindRows({path:mEntities.categories.collection});
	
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 1 && bMetadataLoaded){ // bind rows should have been loaded
				bSetProp = oModel.setProperty("/ProductSet('AD-1000')/Name", "NewValue");
				
			}
			
			if (iCount === 2 && bSetProp) {
				equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "NewValue", "Two Way check");
				start();
			}
		});
	});
	
	asyncTest("test oDataModel Two Way deferred with using changeBatchGroups", function() {
		var iCount = 0;
		var bMetadataLoaded = false;
		var bsetProp = false;
		oModel.setDefaultBindingMode("TwoWay");
		oModel.setDeferredBatchGroups(["myId"]);
		oModel.setChangeBatchGroups({
					"Product": {
			 			batchGroupId: "myId",  
			  			changeSetId: "Test",
			  			single: true
			 		}});
		var mEntities = {
				categories: { 
					collection: "/ProductSet", 
					properties: ["Name"]
				}
			}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");
		
		oTable.setModel(oModel);
		bMetadataLoaded = true;
		oTable.bindRows({path:mEntities.categories.collection});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 1 && bMetadataLoaded){ // bind rows should have been loaded
				bSetProp = oModel.setProperty("/ProductSet('AD-1000')/Name", "NewValue");
				ok(oModel.hasPendingChanges(), "Pending changes test");
				oModel.submitChanges({success: function(oParams){
					ok(true, "request called");
					ok(bSetProp, "set Property succesful");
					equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "NewValue", "Two Way check");
					ok(!oModel.hasPendingChanges(), "Pending changes test");
					start();
				}});
			}
		});
	});
	
	asyncTest("test oDataModel Two Way 2 changes deferred with using changeBatchGroups and single=true (= 2 changesets)", function() {
		var iCount = 0;
		var bMetadataLoaded = false;
		var bsetProp = false;
		var bsetProp2 = false;
		oModel.setDefaultBindingMode("TwoWay");
		oModel.setDeferredBatchGroups(["myId"]);
		oModel.setChangeBatchGroups({
			"Product": {
	 			batchGroupId: "myId",  
	  			changeSetId: "Test",
	  			single: true
	 		}
		});
		var mEntities = {
			categories: { 
				collection: "/ProductSet", 
				properties: ["Name"]
			}
		}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");
		
		oTable.setModel(oModel);
		bMetadataLoaded = true;
		oTable.bindRows({path:mEntities.categories.collection});
		
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 1 && bMetadataLoaded){ // bind rows should have been loaded
				bSetProp = oModel.setProperty("/ProductSet('AD-1000')/Name", "NewValue");
				bSetProp2 = oModel.setProperty("/ProductSet('HT-1000')/Name", "NewValue2");
				ok(oModel.hasPendingChanges(), "Pending changes test");
				oModel.submitChanges({success: function(oParams){
					ok(true, "request called");
					ok(bSetProp, "set property successful");
					ok(bSetProp2, "set property successful");
					equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "NewValue", "Two Way check");
					equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "NewValue2", "Two Way check");
					
					equal(oParams.__batchResponses.length,2, "should be 2 changesets");
					equal(oParams.__batchResponses[0].__changeResponses.length,1, "should be 1 response");
					equal(oParams.__batchResponses[0].__changeResponses[0].statusCode,"204", "statuscode OK");
					equal(oParams.__batchResponses[1].__changeResponses.length,1, "should be 1 response");
					equal(oParams.__batchResponses[1].__changeResponses[0].statusCode,"204", "statuscode OK");
					
					ok(!oModel.hasPendingChanges(), "Pending changes test");
					start();
				}});
			}
		});
	});
	
	asyncTest("test oDataModel Two Way 2 changes deferred with using changeBatchGroups and single=false (= 1 changeset)", function() {
		var iCount = 0;
		var bMetadataLoaded = false;
		var bsetProp = false;
		var bsetProp2 = false;
		oModel.setDefaultBindingMode("TwoWay");
		oModel.setDeferredBatchGroups(["myId"]);
		oModel.setChangeBatchGroups({
					"Product": {
			 			batchGroupId: "myId",  
			  			changeSetId: "Test",
			  			single: false
			 		}});
		var mEntities = {
				categories: { 
					collection: "/ProductSet", 
					properties: ["Name"]
				}
			}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");
		
		oTable.setModel(oModel);
		bMetadataLoaded = true;
		oTable.bindRows({path:mEntities.categories.collection});
		
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 1 && bMetadataLoaded){ // bind rows should have been loaded
				bSetProp = oModel.setProperty("/ProductSet('AD-1000')/Name", "NewValue");
				bSetProp2 = oModel.setProperty("/ProductSet('HT-1000')/Name", "NewValue2");
				ok(oModel.hasPendingChanges(), "Pending changes test");
				oModel.submitChanges({success: function(oParams){
					ok(true, "request called");
					ok(bSetProp, "set property successful");
					ok(bSetProp2, "set property successful");
					equal(oModel.getProperty("/ProductSet('AD-1000')/Name"), "NewValue", "Two Way check");
					equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "NewValue2", "Two Way check");
					
					equal(oParams.__batchResponses.length,1, "should be 1 changesets");
					equal(oParams.__batchResponses[0].__changeResponses.length,2, "should be 2 responses");
					equal(oParams.__batchResponses[0].__changeResponses[0].statusCode,"204", "statuscode OK");
					equal(oParams.__batchResponses[0].__changeResponses[1].statusCode,"204", "statuscode OK");
					
					ok(!oModel.hasPendingChanges(), "Pending changes test");
					start();
				}});
			}
		});
	});
	
	asyncTest("test oDataModel list binding", function() {
		var iCount = 0;
		var bMetadataLoaded = false;
		oModel.setDefaultBindingMode("TwoWay");

		var mEntities = {
				categories: { 
					collection: "/ProductSet", 
					properties: ["Name"]
				}
			}
		var oTable = initTable(mEntities);
		oTable.placeAt("target1");
		
		oTable.setModel(oModel);
		bMetadataLoaded = true;
		oTable.bindRows({path:mEntities.categories.collection});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;

			if (iCount === 1 && bMetadataLoaded){ // bind rows should have been loaded
				var oBinding = oTable.getBinding('rows');
				equal(oBinding.sPath, "/ProductSet", "path check");
				equal(oBinding.getLength(), 115, "length check");
				ok(oBinding.getContexts(), "context check");
				ok(oBinding.sCountMode, "Request", "count mode check");
				start();
			}

		});
	});
		
	asyncTest("test oDataModel setProperty with non deferred requests", function() {
		var iCount = 0;
		var bRead = false;
		var bSetProp = false;
		
		// make request non deferred...
		oModel.setChangeBatchGroups({
			"*" : {batchgroupId : "myId"}
			
		});

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bRead = true;
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				start();
			}
		});
	});
	
	asyncTest("test oDataModel setProperty without batch", function() {
		var iCount = 0;
		var bRead = false;
		var bSetProp = false;
		oModel.setUseBatch(false);
		
		// make request non deferred...
		oModel.setChangeBatchGroups({
			"*" : {batchgroupId : "myId"}
			
		});
		
		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bRead = true;
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				start();
			}
		});
	});
	
	asyncTest("test oDataModel setProperty deferred", function() {
		var iCount = 0;
		var bRead = false;
		var bSetProp = false;
		var bSuccess = false;

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
							"Product": {
					 			batchGroupId: "myId",  
					  			changeSetId: "Test",
					  			single: true
					 		}});
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						bSuccess = true;
					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				start();
			}
		});
	});
	
	asyncTest("test oDataModel setProperty aka MERGE and GET in same batch deferred", function() {
		var iCount = 0;
		var bRead = false;
		var bRead2 = false;
		var bSetProp = false;
		var bSuccess = false;

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/TypeCode"), "PR", "check typecode");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
							"Product": {
					 			batchGroupId: "myId",  
					  			changeSetId: "Test",
					  			single: true
					 		}});
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				oModel.read("/ProductSet('HT-1000')", {
					batchGroupId : "myId",
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bRead2 = true;
						
					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
				oModel.submitChanges({
					success : function(oData, oResponse) {
						bSuccess = true;
					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
	
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead && bRead2 && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/TypeCode"), "PR", "check typecode");
				start();
			}
		});
	});
		
	asyncTest("test oDataModel two Way MERGE delta change batch on", function() {
		var iCount = 0;
		var bRead = false;
		var bRead2 = false;
		var bSetProp = false;
		var bSuccess = false;

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
					"Product" : {
						batchGroupId : "myId",
						changeSetId : "Test",
						single : true
					}
				});
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Price", "4445.6");
				oModel.read("/ProductSet('HT-1000')", {
					batchGroupId : "myId",
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bRead2 = true;

					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
				spy = sinon.spy(oModel, "_processChange");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						equal(spy.callCount, 1, "processChange call count");
						var oRequest = spy.returnValues[0];
						equal(oRequest.method, "MERGE", "request method");
						equal(oRequest.requestUri, "ProductSet('HT-1000')", "request URI");
						equal(oRequest.data.Name, "xy", "request payload name");
						equal(oRequest.data.Price, "4445.6", "request payload price");
						equal(oRequest.data.CurrencyCode, "EUR", "request payload currencyCode." +  
								"Should be also here because price is a currency and has sap:unit = currency code");
						var iCount = 0;
						jQuery.each(oRequest.data, function(iIndex, oValue) {
							iCount++;
						});
						equal(iCount, 4, "request payload number of properties");
						spy.restore();
						bSuccess = true;
					},
					error : function(oError) {
						spy.restore();
						ok(false, "request failed");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead && bRead2 && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "4445.6", "check price");
				spy.restore();
				start();
			}
		});

	});
	
	asyncTest("test oDataModel two Way MERGE delta change batch on with sap:unit modified", function() {
		var iCount = 0;
		var bRead = false;
		var bRead2 = false;
		var bSetProp = false;
		var bSuccess = false;

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
					"Product" : {
						batchGroupId : "myId",
						changeSetId : "Test",
						single : true
					}
				});
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Price", "4445.6");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/CurrencyCode", "USD");
				oModel.read("/ProductSet('HT-1000')", {
					batchGroupId : "myId",
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bRead2 = true;

					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
				spy = sinon.spy(oModel, "_processChange");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						equal(spy.callCount, 1, "processChange call count");
						var oRequest = spy.returnValues[0];
						equal(oRequest.method, "MERGE", "request method");
						equal(oRequest.requestUri, "ProductSet('HT-1000')", "request URI");
						equal(oRequest.data.Name, "xy", "request payload name");
						equal(oRequest.data.Price, "4445.6", "request payload price");
						equal(oRequest.data.CurrencyCode, "USD", "request payload currencyCode." +  
								"Should be also here because price is a currency and has sap:unit = currency code");
						var iCount = 0;
						jQuery.each(oRequest.data, function(iIndex, oValue) {
							iCount++;
						});
						equal(iCount, 4, "request payload number of properties");
						spy.restore();
						bSuccess = true;
					},
					error : function(oError) {
						spy.restore();
						ok(false, "request failed");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead && bRead2 && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "4445.6", "check price");
				spy.restore();
				start();
			}
		});

	});

	asyncTest("test oDataModel two Way MERGE delta change batch off", function() {
		var iCount = 0;
		var bRead = false;
		var bSetProp = false;
		var bSuccess = false;
		oModel.setUseBatch(false);

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				bRead = true;

				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Price", "4445.8");
				spy = sinon.spy(oModel, "_processChange");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						ok(false, "should not be called if batch off");
						spy.restore();
					},
					error : function(oError) {
						spy.restore();
						ok(false, "should not be called if batch off");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(spy.callCount, 1, "processChange call count");
				var oRequest = spy.returnValues[0];
				equal(oRequest.method, "POST", "request method");
				equal(oRequest.headers['x-http-method'], "MERGE", "request method");
				equal(oRequest.requestUri,"/SalesOrderSrv/ProductSet('HT-1000')",
						"request URI");
				equal(oRequest.data.Name, "xy", "request payload name");
				equal(oRequest.data.Price, "4445.8", "request payload price");
				equal(oRequest.data.CurrencyCode, "EUR", "request payload currencyCode." +  
				"Should be also here because price is a currency and has sap:unit = currency code");
				var iCount2 = 0;
				jQuery.each(oRequest.data, function(iIndex, oValue) {
					iCount2++;
				});
				equal(iCount2, 4, "request payload number of properties");
				spy.restore();
				start();
			}
		});

	});

	asyncTest("test oDataModel two Way submitChanges with PUT option and batch on", function() {
		var iCount = 0;
		var bRead = false;
		var bRead2 = false;
		var bSetProp = false;
		var bSuccess = false;

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
					"Product" : {
						batchGroupId : "myId",
						changeSetId : "Test",
						single : true
					}
				});
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Price", "4445.6");
				oModel.read("/ProductSet('HT-1000')", {
					batchGroupId : "myId",
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bRead2 = true;

					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
				spy = sinon.spy(oModel, "_processChange");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						equal(spy.callCount, 1, "processChange call count");
						var oRequest = spy.returnValues[0];
						equal(oRequest.method, "PUT", "request method");
						ok(oRequest.headers['x-http-method'] === undefined, "request method header should not be present");
						equal(oRequest.requestUri, "ProductSet('HT-1000')", "request URI");
						equal(oRequest.data.Name, "xy", "request payload name");
						equal(oRequest.data.Price, "4445.6", "request payload price");
						equal(oRequest.data.CurrencyCode, "EUR",
								"request payload currency code should be there and not changed!!!");
						var iCount = 0;
						jQuery.each(oRequest.data, function(iIndex, oValue) {
							iCount++;
						});
						equal(iCount, 22, "request payload number of properties");
						spy.restore();
						bSuccess = true;
					},
					error : function(oError) {
						spy.restore();
						ok(false, "request failed");
					},
					merge : false
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead && bRead2 && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "4445.6", "check price");
				spy.restore();
				start();
			}
		});
	});
	
	asyncTest("test oDataModel two Way submitChanges with defaultUpdateMethod= PUT option and batch on", function() {
		var iCount = 0;
		var bRead = false;
		var bRead2 = false;
		var bSetProp = false;
		var bSuccess = false;

		oModel = initModel(true, sap.ui.model.odata.UpdateMethod.Put);
		
		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
					"Product" : {
						batchGroupId : "myId",
						changeSetId : "Test",
						single : true
					}
				});
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Price", "4445.6");
				oModel.read("/ProductSet('HT-1000')", {
					batchGroupId : "myId",
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bRead2 = true;

					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
				spy = sinon.spy(oModel, "_processChange");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						equal(spy.callCount, 1, "processChange call count");
						var oRequest = spy.returnValues[0];
						equal(oRequest.method, "PUT", "request method");
						ok(oRequest.headers['x-http-method'] === undefined, "request method header should not be present");
						equal(oRequest.requestUri, "ProductSet('HT-1000')", "request URI");
						equal(oRequest.data.Name, "xy", "request payload name");
						equal(oRequest.data.Price, "4445.6", "request payload price");
						equal(oRequest.data.CurrencyCode, "EUR",
								"request payload currency code should be there and not changed!!!");
						var iCount = 0;
						jQuery.each(oRequest.data, function(iIndex, oValue) {
							iCount++;
						});
						equal(iCount, 22, "request payload number of properties");
						spy.restore();
						bSuccess = true;
					},
					error : function(oError) {
						spy.restore();
						ok(false, "request failed");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead && bRead2 && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "xy", "check changed name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "4445.6", "check price");
				spy.restore();
				start();
			}
		});
	});

	asyncTest("test oDataModel two Way submitChanges with PUT option and batch off", function() {
		var iCount = 0;
		var bRead = false;
		var bSetProp = false;
		var bSuccess = false;
		oModel = initModel();
		oModel.setUseBatch(false);

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;

				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Price", "4445.8");
				spy = sinon.spy(oModel, "_processChange");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						ok(false, "should not be called if batch off");
						spy.restore();
					},
					error : function(oError) {
						spy.restore();
						ok(false, "should not be called if batch off");
					},
					merge : false
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(spy.callCount, 1, "processChange call count");
				var oRequest = spy.returnValues[0];
				equal(oRequest.method, "PUT", "request method");
				ok(oRequest.headers['x-http-method'] === undefined, "request method header should not be present");
				equal(oRequest.requestUri,"/SalesOrderSrv/ProductSet('HT-1000')", "request URI");
				equal(oRequest.data.Name, "xy", "request payload name");
				equal(oRequest.data.Price, "4445.8", "request payload price");
				equal(oRequest.data.CurrencyCode, "EUR", "request payload currency code should be there and not changed!!!");
				var iCount2 = 0;
				jQuery.each(oRequest.data, function(iIndex, oValue) {
					iCount2++;
				});
				equal(iCount2, 22, "request payload number of properties ");
				spy.restore();
				start();
			}
		});
	});
	
	asyncTest("test oDataModel two Way submitChanges with defaultUpdateMethod = PUT option and batch off", function() {
		var iCount = 0;
		var bRead = false;
		var bSetProp = false;
		var bSuccess = false;
		oModel = initModel(true, sap.ui.model.odata.UpdateMethod.PUT);
		oModel.setUseBatch(false);

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;

				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Name", "xy");
				bSetProp = oModel.setProperty("/ProductSet('HT-1000')/Price", "4445.8");
				spy = sinon.spy(oModel, "_processChange");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						ok(false, "should not be called if batch off");
						spy.restore();
					},
					error : function(oError) {
						spy.restore();
						ok(false, "should not be called if batch off");
					},
					merge : false
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSetProp && bRead) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(spy.callCount, 1, "processChange call count");
				var oRequest = spy.returnValues[0];
				equal(oRequest.method, "PUT", "request method");
				ok(oRequest.headers['x-http-method'] === undefined, "request method header should not be present");
				equal(oRequest.requestUri,"/SalesOrderSrv/ProductSet('HT-1000')", "request URI");
				equal(oRequest.data.Name, "xy", "request payload name");
				equal(oRequest.data.Price, "4445.8", "request payload price");
				equal(oRequest.data.CurrencyCode, "EUR", "request payload currency code should be there and not changed!!!");
				var iCount2 = 0;
				jQuery.each(oRequest.data, function(iIndex, oValue) {
					iCount2++;
				});
				equal(iCount2, 22, "request payload number of properties ");
				spy.restore();
				start();
			}
		});
	});
	
	asyncTest("test oDataModel update with defaultUpdateMethod= MERGE option and batch on", function() {
		var iCount = 0;
		var bRead = false;
		var bRead2 = false;
		var bSetProp = false;
		var bSuccess = false;

		oModel = initModel(true); // default should be merge
		
		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
					"Product" : {
						batchGroupId : "myId",
						changeSetId : "Test",
						single : true
					}
				});
				oModel.update("/ProductSet('HT-1000')", {
					Name : "Test"
				    }, {
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
					},
					error : function(oError) {
						ok(false, "request failed");
					},
					eTag: "*",
					batchGroupId: "myId"
				});
				oModel.read("/ProductSet('HT-1000')", {
					batchGroupId : "myId",
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bRead2 = true;

					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
				spy = sinon.spy(oModel, "_submitBatchRequest");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						equal(spy.callCount, 1, "processChange call count");
						var oRequest = spy.args[0][1][0][0].request;
						equal(oRequest.method, "MERGE", "request method");
						ok(oRequest.headers['x-http-method'] === undefined, "request method header should not be present");
						equal(oRequest.requestUri, "ProductSet('HT-1000')", "request URI");
						equal(oRequest.data.Name, "Test", "request payload name");
						var iCount = 0;
						jQuery.each(oRequest.data, function(iIndex, oValue) {
							iCount++;
						});
						equal(iCount, 1, "request payload number of properties");
						spy.restore();
						bSuccess = true;
					},
					error : function(oError) {
						spy.restore();
						ok(false, "request failed");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bRead && bRead2 && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Test", "check changed name");
				spy.restore();
				start();
			}
		});
	});
	
	asyncTest("test oDataModel update with defaultUpdateMethod= PUT option and batch on", function() {
		var iCount = 0;
		var bRead = false;
		var bRead2 = false;
		var bSuccess = false;

		oModel = initModel(true, sap.ui.model.odata.UpdateMethod.Put);
		
		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;
				oModel.setDeferredBatchGroups(["myId"]);
				oModel.setChangeBatchGroups({
					"Product" : {
						batchGroupId : "myId",
						changeSetId : "Test",
						single : true
					}
				});
				oModel.update("/ProductSet('HT-1000')", {
					Name : "Test"
				    }, {
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
					},
					error : function(oError) {
						ok(false, "request failed");
					},
					eTag: "*",
					batchGroupId: "myId"
				});
				oModel.read("/ProductSet('HT-1000')", {
					batchGroupId : "myId",
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bRead2 = true;

					},
					error : function(oError) {
						ok(false, "request failed");
					}
				});
				spy = sinon.spy(oModel, "_submitBatchRequest");
				oModel.submitChanges({
					success : function(oData, oResponse) {
						equal(spy.callCount, 1, "processChange call count");
						var oRequest = spy.args[0][1][0][0].request;
						equal(oRequest.method, "PUT", "request method");
						ok(oRequest.headers['x-http-method'] === undefined, "request method header should not be present");
						equal(oRequest.requestUri, "ProductSet('HT-1000')", "request URI");
						equal(oRequest.data.Name, "Test", "request payload name");
						var iCount = 0;
						jQuery.each(oRequest.data, function(iIndex, oValue) {
							iCount++;
						});
						equal(iCount, 1, "request payload number of properties");
						spy.restore();
						bSuccess = true;
					},
					error : function(oError) {
						spy.restore();
						ok(false, "request failed");
					}
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bRead && bRead2 && bSuccess) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Test", "check changed name");
				spy.restore();
				start();
			}
		});
	});
	
	asyncTest("test oDataModel update with defaultUpdateMethod = MERGE option and batch off", function() {
		var iCount = 0;
		var bRead = false;
		var bSuccess = false;
		var bUpdate = false;
		oModel = initModel(true, sap.ui.model.odata.UpdateMethod.Merge);
		oModel.setUseBatch(false);

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;

				spy = sinon.spy(oModel, "_submitSingleRequest");
				oModel.update("/ProductSet('HT-1000')", {
					Name : "Test3"
				    }, {
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bUpdate = true;
					},
					error : function(oError) {
						ok(false, "request failed");
					},
					eTag: "*",
					batchGroupId: "myId"
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bUpdate && bRead) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(spy.callCount, 1, "call count");
				var oRequest = spy.args[0][0];
				equal(oRequest.method, "POST", "request method");
				ok(oRequest.headers['x-http-method'] === "MERGE", "request method header should not be present");
				equal(oRequest.requestUri,"/SalesOrderSrv/ProductSet('HT-1000')", "request URI");
				equal(oRequest.data.Name, "Test3", "request payload name");
				var iCount2 = 0;
				jQuery.each(oRequest.data, function(iIndex, oValue) {
					iCount2++;
				});
				equal(iCount2, 1, "request payload number of properties ");
				spy.restore();
				start();
			}
		});
	});
	
	asyncTest("test oDataModel update with defaultUpdateMethod = PUT option and batch off", function() {
		var iCount = 0;
		var bRead = false;
		var bSetProp = false;
		var bUpdate = false;
		oModel = initModel(true, sap.ui.model.odata.UpdateMethod.Put);
		oModel.setUseBatch(false);

		oModel.read("/ProductSet('HT-1000')", {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Name"), "Notebook Basic 15", "check name");
				equal(oModel.getProperty("/ProductSet('HT-1000')/Price"), "956.0", "check price");
				equal(oModel.getProperty("/ProductSet('HT-1000')/CurrencyCode"), "EUR", "check price");
				bRead = true;

				spy = sinon.spy(oModel, "_submitSingleRequest");
				oModel.update("/ProductSet('HT-1000')", {
					Name : "Test2"
				    }, {
					success : function(oData, oResponse) {
						ok(true, "request succeeded");
						bUpdate = true;
					},
					error : function(oError) {
						ok(false, "request failed");
					},
					eTag: "*",
					batchGroupId: "myId"
				});
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});

		oModel.attachRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bUpdate && bRead) {
				ok(!oModel.hasPendingChanges(), "pending changes should be false now!");
				equal(spy.callCount, 1, "call count");
				var oRequest = spy.args[0][0];
				equal(oRequest.method, "PUT", "request method");
				ok(oRequest.headers['x-http-method'] === undefined, "request method header should not be present");
				equal(oRequest.requestUri,"/SalesOrderSrv/ProductSet('HT-1000')", "request URI");
				equal(oRequest.data.Name, "Test2", "request payload name");
				var iCount2 = 0;
				jQuery.each(oRequest.data, function(iIndex, oValue) {
					iCount2++;
				});
				equal(iCount2, 1, "request payload number of properties ");
				spy.restore();
				start();
			}
		});
	});
	
	asyncTest("test oDataModel createEntry and setProperty deferred", function() {
		var iCount = 0;
		var bSuccess1 = false;
		var bSuccess2 = false;
		var oContext;
		
		oModel.setDeferredBatchGroups(["myId"]);
		oModel.setChangeBatchGroups({
			"Product": {
	 			batchGroupId: "myId",  
	  			changeSetId: "Test",
	  			single: true
	 		}
		});
		var fnTest = function(){
			oContext = oModel.createEntry("/ProductSet", {properties: {
					"ProductID":"AD-1234",
					"TypeCode":"AD",
					"Category":"Computer system accessories",
					"Name":"TestEntry",
					"NameLanguage":"E",
					"Description":"Flyer for our product palette",
					"DescriptionLanguage":"E",
					"SupplierID":"0100000015",
					"SupplierName":"Robert Brown Entertainment",
					"TaxTarifCode":1,
					"MeasureUnit":"EA",
					"WeightMeasure":"0.01",
					"WeightUnit":"KG",
					"CurrencyCode":"CAD",
					"Price":"0.0",
					"Width":"0.46",
					"Depth":"0.3",
					"Height":"0.03",
					"DimUnit":"M"
			}, batchGroupId: "myId"});
			
			equal(oModel.getProperty("Name",oContext), "TestEntry", "check virtual entry name");
			ok(oModel.setProperty("Name","newName1", oContext), "modify entry...should not lead to a second request");
			equal(oModel.getProperty("Name",oContext), "newName1", "check virtual entry name");
			
			oModel.submitChanges({
				success : function(oData, oResponse) {
					bSuccess1 = true;
					equal(oModel.getProperty("Name",oContext), "newName1", "check virtual entry name");
					ok(oModel.setProperty("Name","newName2", oContext), "modify entry");
					equal(oModel.getProperty("Name",oContext), "newName2", "check virtual entry name");
					oModel.submitChanges({
						success : function(oData, oResponse) {
							bSuccess2 = true;
							equal(oModel.getProperty("Name",oContext), "newName2", "check virtual entry name");
						},
						error : function(oError) {
							ok(false, "request failed");
						}
					});
				},
				error : function(oError) {
					ok(false, "request failed");
				}
			});
		};
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 2 && bSuccess1 && bSuccess2) {
				start();	
			}
		});
		oModel.attachMetadataLoaded(this, function() {
			fnTest();
		});
	});
	
	asyncTest("test oDataModel createEntry", function() {
		var iCount = 0;
		var oContext;
		
		// make request non deferred...
		oModel.setChangeBatchGroups({
			"*" : {batchgroupId : "myId"}
			
		});

		var fnTest = function(){
			ok(true, "metadata loaded");
			oContext = oModel.createEntry("/ProductSet", {properties: {
					"ProductID":"AD-1234",
					"TypeCode":"AD",
					"Category":"Computer system accessories",
					"Name":"TestEntry",
					"NameLanguage":"E",
					"Description":"Flyer for our product palette",
					"DescriptionLanguage":"E",
					"SupplierID":"0100000015",
					"SupplierName":"Robert Brown Entertainment",
					"TaxTarifCode":1,
					"MeasureUnit":"EA",
					"WeightMeasure":"0.01",
					"WeightUnit":"KG",
					"CurrencyCode":"CAD",
					"Price":"0.0",
					"Width":"0.46",
					"Depth":"0.3",
					"Height":"0.03",
					"DimUnit":"M",
					"CreatedAt":"\/Date(1413795983000)\/",
					"ChangedAt":"\/Date(1413795983000)\/"
			}});
			equal(oModel.getProperty("Name",oContext), "TestEntry", "check virtual entry name");
			ok(oModel.setProperty("Name","newName", oContext), "modify entry");
			equal(oModel.getProperty("Name",oContext), "newName", "check virtual entry name");
			oModel.submitChanges();
		};
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 1) {
				start();	
			}
		});
		oModel.attachMetadataLoaded(this, function() {
			fnTest();
		});
	});
	
	asyncTest("test oDataModel createEntry and deleteCreatedEntry", function() {
		var oContext;
		
		oModel.setDeferredBatchGroups(["myId"]);
		oModel.setChangeBatchGroups({
			"Product": {
				batchGroupId: "myId",  
				changeSetId: "Test",
				single: true
			}
		});
		
		var fnTest = function(){
			oContext = oModel.createEntry("/ProductSet", {properties: {
					"ProductID":"AD-1234",
					"TypeCode":"AD",
					"Category":"Computer system accessories",
					"Name":"TestEntry",
					"NameLanguage":"E",
					"Description":"Flyer for our product palette",
					"DescriptionLanguage":"E",
					"SupplierID":"0100000015",
					"SupplierName":"Robert Brown Entertainment",
					"TaxTarifCode":1,
					"MeasureUnit":"EA",
					"WeightMeasure":"0.01",
					"WeightUnit":"KG",
					"CurrencyCode":"CAD",
					"Price":"0.0",
					"Width":"0.46",
					"Depth":"0.3",
					"Height":"0.03",
					"DimUnit":"M"
			}, batchGroupId: "myId"});
	
			oModel.deleteCreatedEntry(oContext);
			oModel.submitChanges({
				success : function(oData, oResponse) {
					ok(false, "should not land here");
				},
				error : function(oError) {
					ok(false, "should not land here");
				}
			});
			jQuery.sap.delayedCall(500, this, function() {
				ok(true, 'no request sent');
				start();
			});
		};
		oModel.attachBatchRequestCompleted(this, function(test) {
			ok(false, "should not land here");
		});
		oModel.attachMetadataLoaded(this, function() {
			fnTest();
		});
	});
	
	asyncTest("test oDataModel 2 times createEntry and one deleteCreatedEntry", function() {
		var oContext, oContext2;
		
		oModel.setDeferredBatchGroups(["myId"]);
		oModel.setChangeBatchGroups({
			"Product": {
				batchGroupId: "myId",  
				changeSetId: "Test",
				single: true
			}
		});
		
		var fnTest = function(){
			oContext = oModel.createEntry("/ProductSet", {properties: {
					"ProductID":"AD-1234",
					"TypeCode":"AD",
					"Category":"Computer system accessories",
					"Name":"TestEntry",
					"NameLanguage":"E",
					"Description":"Flyer for our product palette",
					"DescriptionLanguage":"E",
					"SupplierID":"0100000015",
					"SupplierName":"Robert Brown Entertainment",
					"TaxTarifCode":1,
					"MeasureUnit":"EA",
					"WeightMeasure":"0.01",
					"WeightUnit":"KG",
					"CurrencyCode":"CAD",
					"Price":"0.0",
					"Width":"0.46",
					"Depth":"0.3",
					"Height":"0.03",
					"DimUnit":"M"
			}, batchGroupId: "myId"});
	
			oModel.deleteCreatedEntry(oContext);
			
			oContext2 = oModel.createEntry("/ProductSet", {properties: {
				"ProductID":"AD-1235",
				"TypeCode":"AD",
				"Category":"Computer system accessories",
				"Name":"TestEntry",
				"NameLanguage":"E",
				"Description":"Flyer for our product palette",
				"DescriptionLanguage":"E",
				"SupplierID":"0100000015",
				"SupplierName":"Robert Brown Entertainment",
				"TaxTarifCode":1,
				"MeasureUnit":"EA",
				"WeightMeasure":"0.01",
				"WeightUnit":"KG",
				"CurrencyCode":"CAD",
				"Price":"0.0",
				"Width":"0.46",
				"Depth":"0.3",
				"Height":"0.03",
				"DimUnit":"M"
		}, batchGroupId: "myId"});
			
			oModel.submitChanges({
				success : function(oData, oResponse) {
					ok(true, "should land here");
				},
				error : function(oError) {
					ok(false, "should not land here");
				}
			});

		};
		oModel.attachBatchRequestCompleted(this, function(oEvent) {
			ok(true, "should land here");
			var aRequests = oEvent.getParameter('requests');
			equal(aRequests.length, 1, "should contain one request");
			equal(aRequests[0].success, true, "request successful");
			equal(aRequests[0].url, "ProductSet", "request successful");
			equal(aRequests[0].response.statusCode, "201", "response code");
			start();
		});
		oModel.attachMetadataLoaded(this, function() {
			fnTest();
		});
	});
	
	module("ODataModelV2 Eventing", {
		setup : function() {
			initServer();
			oModel = initModel();
		},
		teardown : function() {
			oModel = undefined;
			removeSharedMetadata();
			stopServer();
		}
	});
	
	asyncTest("test eventing when using read with batch on", function() {
		var bSuccess = false;
		var iReqComp = 0;
		var iReqSent = 0;
		var sReqId = null;
	
		oModel.read("/ProductSet", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		oModel.attachBatchRequestSent(this, function(oEvent) {
			equal(oEvent.getId(), "batchRequestSent", "event id check");
			ok(oEvent.getParameter('url'), "Param check: url");
			ok(oEvent.getParameter('url').indexOf("$batch") !== -1, "Param check: url should be batch");
			equal(oEvent.getParameter('method'), "POST" , "Param check: method");
			equal(oEvent.getParameter('async'), true , "Param check: async");
			equal(oEvent.getParameter('headers').Accept, "application/json", "Param check: headers");
			ok(oEvent.getParameter('headers')['x-csrf-token'], "Param check: token");
			var aRequests = oEvent.getParameter('requests');
			ok(aRequests.length == 1, "should contain one request");
			equal(aRequests[0].method, "GET", "internal request, Param Check: method");
			equal(aRequests[0].url, "ProductSet", "internal request, Param Check: url");
			equal(aRequests[0].headers.Accept, "application/json", "internal request Param check: headers");
			
			equal(typeof(oEvent.getParameter('ID')), "string", "Param check: id");
			sReqId = oEvent.getParameter('ID');
			iReqSent++;
		});
		
		oModel.attachBatchRequestCompleted(this, function(oEvent) {
			iReqComp++;
			if (iReqComp === 1 && iReqSent === 1 && bSuccess) {
				ok(true, "eventing performed correctly");
				
				equal(oEvent.getId(), "batchRequestCompleted", "event id check");
				ok(oEvent.getParameter('url').indexOf("$batch") !== -1, "Param check: url should be batch");
				ok(oEvent.getParameter('url'), "Param check: url");
				ok(oEvent.getParameter('success'), "Param check: success");
				equal(oEvent.getParameter('method'), "POST" , "Param check: method");
				equal(oEvent.getParameter('async'), true , "Param check: async");
				equal(oEvent.getParameter('headers').Accept, "application/json", true , "Param check: headers");
				ok(oEvent.getParameter('headers')['x-csrf-token'], "Param check: token");
				var aRequests = oEvent.getParameter('requests');
				ok(aRequests.length == 1, "should contain one request");
				equal(aRequests[0].method, "GET", "internal request, Param Check: method");
				equal(aRequests[0].url, "ProductSet", "internal request, Param Check: url");
				equal(aRequests[0].headers.Accept, "application/json", "internal request Param check: headers");
				
				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 202, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "Accepted", "oResponse Param check: statusCode");
				
				// check internal response
				var aRequests = oEvent.getParameter('requests');
				equal(aRequests[0].response.statusCode, "200", "internal response, Param Check: statusCode");
				equal(aRequests[0].response.statusText, "OK", "internal response, Param Check: statusText");
				
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId, "Check Request ID");
				start();
			}
		});
	});

	asyncTest("test eventing when using read and internal error with batch on", function() {
		var iReqComp = 0;
		var iReqSent = 0;
		var iReqFailed = 0;
		var sReqId = null;
		oModel.read("/ProductXYSet", {
			success : function(oData, oResponse) {
				ok(false, "request succeeded...error expected");
			},
			error : function(oError) {
				ok(oError.statusCode === "404", "error code");
				ok(true, "request failed");
			}
		});
		
		oModel.attachBatchRequestFailed(this, function(oEvent) {
			iReqFailed++;
			ok(false, "batch request itself should have no errors");
		});
		
		oModel.attachBatchRequestSent(this, function(oEvent) {
			iReqSent++;
			
			equal(oEvent.getId(), "batchRequestSent", "event id check");
			ok(oEvent.getParameter('url'), "Param check: url");
			ok(oEvent.getParameter('url').indexOf("$batch") !== -1, "Param check: url should be batch");
			equal(oEvent.getParameter('method'), "POST" , "Param check: method");
			equal(oEvent.getParameter('async'), true , "Param check: async");
			equal(oEvent.getParameter('headers').Accept, "application/json", "Param check: headers");
			ok(oEvent.getParameter('headers')['x-csrf-token'], "Param check: token");
			var aRequests = oEvent.getParameter('requests');
			ok(aRequests.length == 1, "should contain one request");
			equal(aRequests[0].method, "GET", "internal request, Param Check: method");
			equal(aRequests[0].url, "ProductXYSet", "internal request, Param Check: url");
			equal(aRequests[0].headers.Accept, "application/json", "internal request Param check: headers");
			
			sReqId = oEvent.getParameter('ID');
		});
		
		oModel.attachBatchRequestCompleted(this, function(oEvent) {
			iReqComp++;
			if (iReqComp === 1 && iReqSent === 1 && iReqFailed == 0) {
				ok(true, "eventing performed correctly");
				ok(oEvent.getParameter('success'), "should be true for batch request itself!");
				equal(oEvent.getParameter('method'), "POST" , "Param check: method");
				
				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 202, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "Accepted", "oResponse Param check: statusCode");
				
				// check internal response
				var aRequests = oEvent.getParameter('requests');
				ok(aRequests.length == 1, "should contain one request");
				equal(aRequests[0].method, "GET", "internal request, Param Check: method");
				equal(aRequests[0].url, "ProductXYSet", "internal request, Param Check: url");
				equal(aRequests[0].headers.Accept, "application/json", "internal request Param check: headers");
				equal(aRequests[0].response.statusCode, "404", "internal response, Param Check: statusCode");
				equal(aRequests[0].response.statusText, "Not Found", "internal response, Param Check: statusText");
				
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId, "Check Request ID");
				start();
			}
		});
	});

	asyncTest("test eventing when using read and error with batch on", function() {
		var iReqComp = 0;
		var iReqSent = 0;
		var iReqFailed = 0;
		var sReqId = null;
		oModel.setDeferredBatchGroups([ "myId1" ]);
		oModel.read("/ProductSet", {
			success : function(oData, oResponse) {
				ok(false, "request succeeded...error expected");
			},
			error : function(oError) {
				equal(oError.statusCode, 404, "error code");
				ok(true, "request failed");
			},
			batchGroupId: "myId1"
		});
		// make internal batch request fail
		oModel.sServiceUrl = "/notWorking";
		oModel.submitChanges();
		
		oModel.attachBatchRequestFailed(this, function(oEvent) {
			equal(oEvent.getId(), "batchRequestFailed", "event id check");
			iReqFailed++;
			if (iReqFailed == 1 && iReqComp === 1 && iReqSent === 1 ) {
				ok(!oEvent.getParameter('success'), "should be false for batch request itself!");
				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 404, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "Not Found", "oResponse Param check: statusText");
				
				// check internal response
				var aRequests = oEvent.getParameter('requests');
				ok(aRequests.length == 1, "should contain one request");
				equal(aRequests[0].method, "GET", "internal request, Param Check: method");
				equal(aRequests[0].url, "ProductSet", "internal request, Param Check: url");
				equal(aRequests[0].response, undefined, "internal response not there");
				
				start();
			}
		});
		
		oModel.attachBatchRequestSent(this, function(oEvent) {
			iReqSent++;
			
			equal(oEvent.getId(), "batchRequestSent", "event id check");
			ok(oEvent.getParameter('url'), "Param check: url");
			ok(oEvent.getParameter('url').indexOf("$batch") !== -1, "Param check: url should be batch");
			equal(oEvent.getParameter('method'), "POST" , "Param check: method");
			equal(oEvent.getParameter('async'), true , "Param check: async");
			equal(oEvent.getParameter('headers').Accept, "application/json", "Param check: headers");
			var aRequests = oEvent.getParameter('requests');
			ok(aRequests.length == 1, "should contain one request");
			equal(aRequests[0].method, "GET", "internal request, Param Check: method");
			equal(aRequests[0].url, "ProductSet", "internal request, Param Check: url");
			equal(aRequests[0].headers.Accept, "application/json", "internal request Param check: headers");
			
			sReqId = oEvent.getParameter('ID');
		});
		
		oModel.attachBatchRequestCompleted(this, function(oEvent) {
			iReqComp++;
			if (iReqComp === 1 && iReqSent === 1 && iReqFailed == 0) {
				ok(true, "eventing performed correctly");
				ok(!oEvent.getParameter('success'), "should be false for batch request itself!");
				equal(oEvent.getParameter('method'), "POST" , "Param check: method");
				
				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 404, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "Not Found", "oResponse Param check: statusText");
				
				// check internal response
				var aRequests = oEvent.getParameter('requests');
				ok(aRequests.length == 1, "should contain one request");
				equal(aRequests[0].method, "GET", "internal request, Param Check: method");
				equal(aRequests[0].url, "ProductSet", "internal request, Param Check: url");
				equal(aRequests[0].response, undefined, "internal response not there");
				
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId, "Check Request ID");
			}
		});
	});
	
	asyncTest("test eventing when using read with batch off", function() {
		var bSuccess = false;
		var iReqComp = 0;
		var iReqSent = 0;
		var sReqId = null;
		oModel.setUseBatch(false);
		oModel.read("/ProductSet", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		oModel.attachRequestSent(this, function(oEvent) {
			equal(oEvent.getId(), "requestSent", "event id check");
			ok(oEvent.getParameter('url'), "Param check: url");
			ok(oEvent.getParameter('url').indexOf("ProductSet") !== -1, "Param check: url should be non batch");
			equal(oEvent.getParameter('method'), "GET" , "Param check: method");
			equal(oEvent.getParameter('async'), true , "Param check: async");
			equal(oEvent.getParameter('headers').Accept, "application/json", true , "Param check: headers");
			
			equal(typeof(oEvent.getParameter('ID')), "string", "Param check: id");
			sReqId = oEvent.getParameter('ID');
			iReqSent++;
		});
		
		oModel.attachRequestCompleted(this, function(oEvent) {
			iReqComp++;
			if (iReqComp === 1 && iReqSent === 1 && bSuccess) {
				ok(true, "eventing performed correctly");
				
				equal(oEvent.getId(), "requestCompleted", "event id check");
				ok(oEvent.getParameter('url'), "Param check: url");
				ok(oEvent.getParameter('url').indexOf("ProductSet") !== -1, "Param check: url should be non batch");
				ok(oEvent.getParameter('success'), "Param check: success");
				equal(oEvent.getParameter('method'), "GET" , "Param check: method");
				equal(oEvent.getParameter('async'), true , "Param check: async");
				equal(oEvent.getParameter('headers').Accept, "application/json", true , "Param check: headers");

				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 200, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "OK", "oResponse Param check: statusCode");
				
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId, "Check Request ID");
				start();
			}
		});
	});
	
	asyncTest("test eventing when using read and error batch off", function() {
		var iReqComp = 0;
		var iReqSent = 0;
		var iReqFailed = 0;
		var sReqId = null;
		oModel.setUseBatch(false);
		
		oModel.attachRequestFailed(this, function(oEvent) {
			iReqFailed++;
			if (iReqSent === 1 && iReqFailed === 1 && iReqComp === 1) {
				equal(oEvent.getId(), "requestFailed", "event id check");
				ok(true, "eventing performed correctly");
				equal(oEvent.getParameter('method'), "GET" , "Param check: method");
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId, "Check Request ID");
				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 404, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "Not Found", "oResponse Param check: statusCode");
				
				start();
			}
		});
		
		oModel.attachRequestSent(this, function(oEvent) {
			iReqSent++;
			equal(oEvent.getId(), "requestSent", "event id check");
			ok(oEvent.getParameter('url'), "Param check: url");
			ok(oEvent.getParameter('url').indexOf("ProductXYSet") !== -1, "Param check: url should be non batch");
			equal(oEvent.getParameter('method'), "GET" , "Param check: method");
			equal(oEvent.getParameter('async'), true , "Param check: async");
			equal(oEvent.getParameter('headers').Accept, "application/json", true , "Param check: headers");
			
			ok(oEvent.getParameter('ID') !== null, "Check Request ID");
			sReqId = oEvent.getParameter('ID');
		});
		
		oModel.attachRequestCompleted(this, function(oEvent) {
			iReqComp++;
			if (iReqComp === 1 && iReqSent === 1 && iReqFailed === 0) {
				ok(true, "eventing performed correctly");
				ok(!oEvent.getParameter('success'), " should be false!");
				equal(oEvent.getParameter('method'), "GET" , "Param check: method");							
				equal(oEvent.getId(), "requestCompleted", "event id check");
				ok(oEvent.getParameter('url'), "Param check: url");
				ok(oEvent.getParameter('url').indexOf("ProductXYSet") !== -1, "Param check: url should be non batch");
				equal(oEvent.getParameter('async'), true , "Param check: async");
				equal(oEvent.getParameter('headers').Accept, "application/json", true , "Param check: headers");

				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 404, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "Not Found", "oResponse Param check: statusCode");
				
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId, "Check Request ID");
			}
		});
		
		oModel.read("/ProductXYSet", {
			success : function(oData, oResponse) {
				ok(false, "request succeeded...error expected");
			},
			error : function(oError) {
				ok(oError.statusCode === 404, "error code");
				ok(true, "request failed");
			}
		});
	});	
	
	asyncTest("test eventing when using multiple requests with batch on", function() {
		var bSuccess = false;
		var iReqComp = 0;
		var iReqSent = 0;
		var sReqId = null;
		oModel.read("/ProductSet('HT-1001')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId1"
		});
		oModel.read("/ProductSet('AD-1000')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId1"
		});
		oModel.update("/ProductSet('HT-1000')", {
			Name : "Test"
		    }, {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			merge: true,
			eTag: "*",
			batchGroupId: "myId1"
		});
		oModel.attachBatchRequestSent(this, function(oEvent) {
			equal(oEvent.getId(), "batchRequestSent", "event id check");
			ok(oEvent.getParameter('url'), "Param check: url");
			ok(oEvent.getParameter('url').indexOf("$batch") !== -1, "Param check: url should be batch");
			equal(oEvent.getParameter('method'), "POST" , "Param check: method");
			equal(oEvent.getParameter('async'), true , "Param check: async");

			var aRequests = oEvent.getParameter('requests');
			ok(aRequests.length == 3, "should contain 3 requests");
			equal(aRequests[0].method, "MERGE", "internal request, Param Check: method");
			equal(aRequests[0].url, "ProductSet('HT-1000')", "internal request, Param Check: url");
			equal(aRequests[0].headers.Accept, "application/json", "internal request Param check: headers");
			
			equal(aRequests[1].method, "GET", "internal request, Param Check: method");
			equal(aRequests[1].url, "ProductSet('HT-1001')", "internal request, Param Check: url");
			equal(aRequests[1].headers.Accept, "application/json", "internal request Param check: headers");
			
			equal(aRequests[2].method, "GET", "internal request, Param Check: method");
			equal(aRequests[2].url, "ProductSet('AD-1000')", "internal request, Param Check: url");
			equal(aRequests[2].headers.Accept, "application/json", "internal request Param check: headers");
			
			
			equal(typeof(oEvent.getParameter('ID')), "string", "Param check: id");
			sReqId = oEvent.getParameter('ID');
			iReqSent++;
		});
		
		oModel.attachBatchRequestCompleted(this, function(oEvent) {
			iReqComp++;
			if (iReqComp === 1 && iReqSent === 1 && bSuccess) {
				ok(true, "eventing performed correctly");
				
				equal(oEvent.getId(), "batchRequestCompleted", "event id check");
				ok(oEvent.getParameter('url').indexOf("$batch") !== -1, "Param check: url should be batch");
				ok(oEvent.getParameter('url'), "Param check: url");
				ok(oEvent.getParameter('success'), "Param check: success");
				equal(oEvent.getParameter('method'), "POST" , "Param check: method");
				equal(oEvent.getParameter('async'), true , "Param check: async");
				equal(oEvent.getParameter('headers').Accept, "application/json", true , "Param check: headers");
				ok(oEvent.getParameter('headers')['x-csrf-token'], "Param check: token");
				var aRequests = oEvent.getParameter('requests');
				
				ok(aRequests.length == 3, "should contain 3 requests");
				
				equal(aRequests[0].method, "MERGE", "internal request, Param Check: method");
				equal(aRequests[0].url, "ProductSet('HT-1000')", "internal request, Param Check: url");
				equal(aRequests[0].headers.Accept, "application/json", "internal request Param check: headers");
				
				equal(aRequests[1].method, "GET", "internal request, Param Check: method");
				equal(aRequests[1].url, "ProductSet('HT-1001')", "internal request, Param Check: url");
				equal(aRequests[1].headers.Accept, "application/json", "internal request Param check: headers");
				
				equal(aRequests[2].method, "GET", "internal request, Param Check: method");
				equal(aRequests[2].url, "ProductSet('AD-1000')", "internal request, Param Check: url");
				equal(aRequests[2].headers.Accept, "application/json", "internal request Param check: headers");
				
				//check response
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 202, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "Accepted", "oResponse Param check: statusCode");
				
				// check internal responses
				equal(aRequests[0].response.statusCode, "204", "internal response, Param Check: statusCode");
				equal(aRequests[0].response.statusText, "No Content", "internal response, Param Check: statusText");
				
				equal(aRequests[1].response.statusCode, "200", "internal response, Param Check: statusCode");
				equal(aRequests[1].response.statusText, "OK", "internal response, Param Check: statusText");
				
				equal(aRequests[2].response.statusCode, "200", "internal response, Param Check: statusCode");
				equal(aRequests[2].response.statusText, "OK", "internal response, Param Check: statusText");
				
				
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId, "Check Request ID");
				start();
			}
		});
	});
	
	asyncTest("test eventing when using multiple requests with batch off", function() {
		var bSuccess = false;
		var sReqId1 = null;
		var sReqId2 = null;
		var sReqId3 = null;
		var iCount1 = 0;
		var iCount2 = 0;
		oModel.setUseBatch(false);
		oModel.read("/ProductSet('HT-1001')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId1"
		});
		oModel.read("/ProductSet('AD-1000')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId1"
		});
		oModel.update("/ProductSet('HT-1000')", {
			Name : "Test"
		    }, {
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			merge: true,
			eTag: "*",
			batchGroupId: "myId1"
		});
		oModel.attachRequestSent(this, function(oEvent) {
			iCount1++;
			if (iCount1 == 1) {
				ok(oEvent.getParameter('url').indexOf("HT-1000") !== -1, "Param check: url should be non batch");
				equal(oEvent.getParameter('method'), "POST" , "Param check: method");
				equal(oEvent.getParameter('headers')['x-http-method'], "MERGE" , "Param check: method");
				equal(typeof(oEvent.getParameter('ID')), "string", "Param check: id");
				sReqId3 = oEvent.getParameter('ID');
			}
			
			if (iCount1 == 2) {
				ok(oEvent.getParameter('url').indexOf("HT-1001") !== -1, "Param check: url should be non batch");
				equal(oEvent.getParameter('method'), "GET" , "Param check: method");
				equal(typeof(oEvent.getParameter('ID')), "string", "Param check: id");
				sReqId1 = oEvent.getParameter('ID');
			}
			
			if (iCount1 == 3) {
				ok(oEvent.getParameter('url').indexOf("AD-1000") !== -1, "Param check: url should be non batch");
				equal(oEvent.getParameter('method'), "GET" , "Param check: method");
				equal(typeof(oEvent.getParameter('ID')), "string", "Param check: id");
				sReqId2 = oEvent.getParameter('ID');
			}
			

		});
		
		oModel.attachRequestCompleted(this, function(oEvent) {
								
			equal(oEvent.getId(), "requestCompleted", "event id check");
		
			ok(oEvent.getParameter('success'), "Param check: success");
			
			if (oEvent.getParameter('url').indexOf("HT-1001") !== -1) {
				ok(oEvent.getParameter('url').indexOf("HT-1001") !== -1, "Param check: url should be non batch");
				equal(oEvent.getParameter('method'), "GET" , "Param check: method");
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 200, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "OK", "oResponse Param check: statusCode");
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId1, "Check Request ID");
				iCount2 ++;
			}
			
			if (oEvent.getParameter('url').indexOf("AD-1000") !== -1) {
				ok(oEvent.getParameter('url').indexOf("AD-1000") !== -1, "Param check: url should be non batch");
				equal(oEvent.getParameter('method'), "GET" , "Param check: method");
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 200, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "OK", "oResponse Param check: statusCode");
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId2, "Check Request ID");
				iCount2 ++;
			}
			
			if (oEvent.getParameter('url').indexOf("HT-1000") !== -1) {
				equal(oEvent.getParameter('method'), "POST" , "Param check: method");
				equal(oEvent.getParameter('headers')['x-http-method'], "MERGE" , "Param check: method");
				var oResponse = oEvent.getParameter('response');
				ok(oResponse.headers !== undefined, "oResponse Param check: headers");
				equal(oResponse.statusCode, 204, "oResponse Param check: statusCode");
				equal(oResponse.statusText, "No Content", "oResponse Param check: statusCode");
				ok(oEvent.getParameter('ID') !== null, "Check Request ID");
				equal(oEvent.getParameter('ID'), sReqId3, "Check Request ID");
				iCount2 ++;
			}
			
			
			if (iCount2 == 3) {
				start();
			}
		});
	});
	
	module("ODataModelV2 abort requests", {
		setup : function() {
			initServer();
			oModel = initModel();
		},
		teardown : function() {
			oModel = undefined;
			cleanServiceDataCache();
			stopServer();
		}
	});
	
	asyncTest("test abort of request in batch request", function() {
		var bSuccess = false;
		var oAbort = {};
		oModel.read("/ProductSet('HT-1001')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
			batchGroupId: "myId1"
		});
		oAbort = oModel.read("/ProductSet('AD-1000')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(true, "error callback of aborted request is called");
			},
			batchGroupId: "myId1"
		});
		oAbort.abort();

		oModel.attachBatchRequestCompleted(this, function(oEvent) {
			equal(oEvent.getParameter('requests').length, 1, "number of requests check");
			equal(oEvent.getParameter('requests')[0].url, "ProductSet('HT-1001')" , "Param check: url");
			start();
		});
	});
	
	asyncTest("test abort of deferred batch request", function() {
		var bSuccess = false;
		var oAbort = {};
		oModel.setDeferredBatchGroups([ "myId1" ]);
		oModel.read("/ProductSet('HT-1001')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(true, "error callback of aborted request is called");
			},
			batchGroupId: "myId1"
		});
		oModel.read("/ProductSet('AD-1000')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(true, "error callback of aborted request is called");
			},
			batchGroupId: "myId1"
		});
		oAbort = oModel.submitChanges({success: function(oParams){
			ok(false, "request should be aborted");
		}, error: function(oEvent){
			ok(true, "request should be aborted");
		}});
		oAbort.abort();

		oModel.attachBatchRequestCompleted(this, function(oEvent) {
			ok(true, "request should be aborted");
			equal(oEvent.getParameter('success'), false, "request completed with success false");
			start();
		});
	});

	asyncTest("test abort of request in non batch request", function() {
		var bSuccess = false;
		var oAbort = {};
		oModel.setUseBatch(false);
		oModel.read("/ProductSet('HT-1001')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(false, "request failed");
			},
		});
		oAbort = oModel.read("/ProductSet('AD-1000')", {
			success : function() {
				bSuccess = true;
			},
			error : function(oError) {
				ok(true, "error callback of aborted request is called");
			},
		});
		oAbort.abort();

		oModel.attachRequestCompleted(this, function(oEvent) {
			if (oEvent.getParameter('success')){
				ok(oEvent.getParameter('url').indexOf("ProductSet('HT-1001')") !== -1, "Param check: url");						
			} else {
				ok(false, "aborted request should have never been sent");
			}
			if (bSuccess){
				start();						
			}
		});
	});
	asyncTest("test oDataModel checkupdate/dataReceived event order", function() {
		var iCount = 0;
		var iChange = 0;
		var iReceived = 0;
		var bRead1 = false;
		var bRead2 = false;
		var oInput1, oInput2;
		
		oInput1 = new sap.m.Input();
		oInput1.setModel(oModel);
		oInput2 = new sap.m.Input();
		oInput2.setModel(oModel);
		
		var fnChange = function(oEvent) {
			iChange++;
		}
		var fnDataReceived = function(oEvent) {
			ok(iChange == 2, "checkupdate done");
			iReceived++;
			if (iReceived == 2) {
				ok(true, "dataReceived after checkUpdate");
			}
		}
		
		oInput1.bindElement({path:"/ProductSet('AD-1000')", batchGroupId:1, events:{change: fnChange, dataReceived: fnDataReceived}});
		oInput2.bindElement({path:"/ProductSet('HT-1000')", batchGroupId:1, events:{change: fnChange, dataReceived: fnDataReceived}});
		
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 1 ) {
				ok(true, "batch request completed");
				start();
			}
		});
	});
	
	asyncTest("test oDataModel checkupdate/dataReceived event order - data already loaded", function() {
		var iCount = 0;
		var iChange = 0;
		var iReceived = 0;
		var oInput1, oInput2;
		
		oInput1 = new sap.m.Input();
		oInput1.setModel(oModel);
		oInput2 = new sap.m.Input();
		oInput2.setModel(oModel);
		
		var fnChange = function(oEvent) {
			iChange++;
			if (iChange == 2) {
				ok(true, "checkupdate done");
				start();
			}
		}
		var fnDataReceived = function(oEvent) {
			ok(false, "no data retrieval necessary");
		}
	
		oModel.read("/ProductSet('AD-1000')", {
			batchGroupId : "myId1",
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		oModel.read("/ProductSet('HT-1000')", {
			batchGroupId : "myId1",
			success : function(oData, oResponse) {
				ok(true, "request succeeded");
			},
			error : function(oError) {
				ok(false, "request failed");
			}
		});
		
		var fnBind = function() {
			oInput1.bindElement({path:"/ProductSet('AD-1000')", batchGroupId:1, events:{change: fnChange, dataReceived: fnDataReceived}});
			oInput2.bindElement({path:"/ProductSet('HT-1000')", batchGroupId:1, events:{change: fnChange, dataReceived: fnDataReceived}});
		};
		
		oModel.attachBatchRequestCompleted(this, function(test) {
			iCount++;
			if (iCount === 1 ) {
				ok(true, "read batch request completed");
				fnBind();
			}
			if (iCount > 1 ) {
				ok(false, "data already loaded: No further request necessary");
			}
		});
	});
	
	asyncTest("test oDataModel dataReceived event count", function() {
		var iCount = 0;
		var oInput1;
		
		oInput1 = new sap.m.Input();
		oInput1.setModel(oModel);
	
		new sap.m.Input({
			models: oModel,
			objectBindings: {
				undefined: {
					path: "/ProductSet('HT-1000')",
					events: {
						dataReceived: function() {
							ok(iCount == 0, "dataReceived called once");
							iCount++;
							oModel.setProperty("/ProductSet('HT-1000')/Name", "Test");
							start();
						}
					}
				}
			},
			value: "{Name}"
		})
	});
	
	asyncTest("test oDataModel listbinding with table - event order change/dataReceived", function() {
		var iCount = 0,
			iChange = 0,
			iReceived = 0;

		var mEntities = {
				categories: { 
					collection: "/VH_CategorySet", 
					properties: ["Category"]
				}
			}
		var oTable = initTable(mEntities);
		
		oTable.placeAt("target1");
		
		oTable.setModel(oModel);
		
		var fnChange = function(oEvent) {
			iChange++;
		}
		var fnDataReceived = function(oEvent) {
			ok(iChange == 1, "checkupdate done");
			iReceived++;
			if (iReceived == 1) {
				ok(true, "dataReceived after checkUpdate");
			}
		}
		
		oTable.bindRows({path:mEntities.categories.collection, events:{change: fnChange, dataReceived: fnDataReceived}});
		var fnCheck = function() {
			ok(oTable.getBinding('rows').getLength() >= 2, "Category size check");
			oTable.destroy();
			start();
		}
		oModel.attachBatchRequestCompleted(this, fnCheck);
	});
	
	asyncTest("test oDataModel listbinding with table - event order change/dataReceived - data already loaded", function() {
		var iCount = 0,
			iChange = 0,
			iReceived = 0;

		var mEntities = {
				categories: { 
					collection: "/VH_CategorySet", 
					properties: ["Category"]
				}
			}
		var oTable = initTable(mEntities);
		
		oTable.placeAt("target1");
		
		oTable.setModel(oModel);
		
		var fnChange = function(oEvent) {
			iChange++;
		}
		var fnDataReceived = function(oEvent) {
			ok(iChange == 1, "checkupdate done");
			iReceived++;
			if (iReceived == 1) {
				ok(true, "dataReceived after checkUpdate");
				oTable.destroy();
				start();
			}
		}
		
		oTable.bindRows({path:mEntities.categories.collection, events:{change: fnChange, dataReceived: fnDataReceived}});
		var fnCheck = function() {
			iCount++;
			if (iCount <= 2) {
				ok(true, "request completed");
			} else {
				ok(false, "too many requests");
			}
		}
		oModel.attachBatchRequestCompleted(this, fnCheck);
		
		var fnLoad = function() {
			oModel.read("/VH_CategorySet", {
				success : function(oData, oResponse) {
					ok(true, "request succeeded");
					fnTest();
				},
				error : function(oError) {
					ok(false, "request failed");
				}
			});
		};
	});
	asyncTest("test oDataModel createEntry, submit fails, change again and submit", function() {
		var iCount = 0;
		var oContext;
		
		oModel.setDeferredBatchGroups(["myId"]);
		oModel.setChangeBatchGroups({
					"Product": {
			 			batchGroupId: "myId",  
			  			changeSetId: "Test",
			  			single: false
			 		}});
		
		var fnChange = function() {
			oModel.setProperty("TypeCode","AD", oContext);
			oModel.setProperty("Category","Computer system accessories", oContext);
			oModel.setProperty("Name","TestEntry", oContext);
			oModel.setProperty("NameLanguage","E", oContext);
			oModel.setProperty("Description","Flyer for our product palette", oContext);
			oModel.setProperty("DescriptionLanguage","E", oContext);
			oModel.setProperty("SupplierID","0100000015", oContext);
			oModel.setProperty("SupplierName","Robert Brown Entertainment", oContext);
			oModel.setProperty("TaxTarifCode",1, oContext);
			oModel.setProperty("MeasureUnit","EA", oContext);
			oModel.setProperty("WeightMeasure","0.01", oContext);
			oModel.setProperty("WeightUnit","KG", oContext);
			oModel.setProperty("CurrencyCode","CAD", oContext);
			oModel.setProperty("Price","0.0", oContext);
			oModel.setProperty("Width","0.46", oContext);
			oModel.setProperty("Depth","0.3", oContext);
			oModel.setProperty("Height","0.03", oContext);
			oModel.setProperty("DimUnit","M", oContext);
			oModel.submitChanges({
				success : function(oData, oResponse) {
					ok(true, "$batch successful");
					ok(oData.__batchResponses.length === 1, "One response found");
					if (!oData.__batchResponses[0].message) {
						ok(true, "creation successful");
						start();
					}
				},
				error : function(oError) {
					ok(false, "creation failed");
				}
			});
		};
		
		var fnTest = function(){
			oContext = oModel.createEntry("/ProductSet", {properties: {
				"ProductID":"AD-12345",
			}, batchGroupId: "myId"});
			
			oModel.submitChanges({
				success : function(oData, oResponse) {
					ok(true, "$batch successful");
					ok(oData.__batchResponses.length === 1, "One response found");
					//MockServer does not really fail so we create a message
					oData.__batchResponses[0].message = "error";
					if (oData.__batchResponses[0].message) {
						ok(true, "creation failed");
						fnChange();
					}
				},
				error : function(oError) {
					ok(false, "should not land here");
				}
			});
		};
		
		oModel.attachMetadataLoaded(this, fnTest);
	});
	
	asyncTest("test oDataModel callFunction: Parameter without mode", function() {
		var iCount = 0;
		var oContext;
		
		oModel.callFunction("/SalesOrder_InvoiceCreated",{method:"POST",urlParameters:{"SalesOrderID":"test"}})
		
		oModel.attachRequestSent(this, function(oEventInfo) {
			ok(oEventInfo.getParameter("url") === "SalesOrder_InvoiceCreated?SalesOrderID='test'");
			start();	
		});
	});
	
	asyncTest("test oDataModel callFunction: Parameter with mode", function() {
		var iCount = 0;
		var oContext;
		
		oModel.callFunction("/SalesOrder_Confirm",{method:"POST",urlParameters:{"SalesOrderID":"test"}})
		
		oModel.attachRequestSent(this, function(oEventInfo) {
			ok(oEventInfo.getParameter("url") === "SalesOrder_Confirm?SalesOrderID='test'");
			start();	
		});
	});
	
	asyncTest("test oDataModel callFunction: invalid parameter", function() {
		var iCount = 0;
		var oContext;
		
		oModel.callFunction("/SalesOrder_Confirm",{method:"POST",urlParameters:{"Test":"test"}})
		
		oModel.attachRequestSent(this, function(oEventInfo) {
			ok(oEventInfo.getParameter("url") === "SalesOrder_Confirm");
			start();	
		});
	});
	
	asyncTest("test getETag", 3, function(){
		oInput = new sap.m.Input();
		oInput.setModel(oModel);
		oInput.bindElement("/ProductSet('AD-1000')");
		var fnHandler = function() {
			var oContext = oInput.getBindingContext();
			//as mockServer does not provide an ETag we fake one
			oContext.getObject().__metadata.etag = "someEtag";
			ok(oContext, "Context exists");
			ok(oModel.getETag(oContext.getObject()), "eTag exists");
			ok(oModel.getETag(oContext.getPath()), "eTag exists");
			oInput.getElementBinding().detachChange(fnHandler);
			oInput.unbindElement();
			oInput.setBindingContext(null);
			start();
		}
		oInput.getElementBinding().attachChange(fnHandler);
	});
	</script>

</head>
<body>
<h1 id="qunit-header">QUnit tests: Data binding OData Model (V2)</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<div id="qunit-testrunner-toolbar"></div>
<ol id="qunit-tests"></ol>
<br>
<div id="target1"></div>
<div id="target2"></div>
</body>
</html>
