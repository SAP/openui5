<!DOCTYPE HTML>

<!--
  Tested sap.ui.model.Binding
-->

<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">

<!-- Initialization -->
<script src="../shared-config.js"></script>
<script id="sap-ui-bootstrap"
	src="../../../../../resources/sap-ui-core.js" >
	</script>

<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css"
	media="screen" />
<script
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>

<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<!--[if IE]>
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
<![endif]-->
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- This test is not running against the real Northwind service, but a fake service based on
     Sinon.SJ FakeXHR. To run on the real service instead please comment out the following line. -->
<script type="text/javascript" src="ODataModelFakeService.js"></script>

<!-- Test functions -->
<script charset="utf-8"> // IE needs this :-/
	var sUri = "http://services.odata.org/V3/Northwind/Northwind.svc/";
	sUri = "../../../../../proxy/http/" + sUri.replace("http://","");

	sap.ui.core.Control.extend("sap.ui.core.TestControl", {
		metadata : {
		  // ---- control specific ----
		  library : "sap.ui.core",
		  properties : {
			value : {type: "string", group: "Appearance", defaultValue: ""},
			other : {type: "string", group: "Appearance", defaultValue: ""}
		  },
		  aggregations : {
		  	children : {type : "sap.ui.core.TestControl" }
		  }
		},

		renderer : function() {}

	});

	var oModel1 = new sap.ui.model.json.JSONModel({
    	value : "1"
    });
    var oModel2 = new sap.ui.model.json.JSONModel({
    	value : "2"
    });
    var oModel3 = new sap.ui.model.json.JSONModel({
    	value : "3"
    });
    var oModel4 = new sap.ui.model.json.JSONModel({
    	data: ["0","1","2"]
    });
    var oModel5 = new sap.ui.model.odata.v2.ODataModel(sUri);

    var uiArea,ctrl,child;
    QUnit.module("Propagation listener", {
		beforeEach : function() {
			var oDiv = jQuery("<div></div>").appendTo("#uiAreas");
			uiArea = sap.ui.getCore().createUIArea(oDiv[0]);

			mPropagationInfo = {};

			fnChange = function(oEvent) {
				mPropagationInfo[oEvent.getSource().getId()] ? mPropagationInfo[oEvent.getSource().getId()]++ : mPropagationInfo[oEvent.getSource().getId()] = 1;
			};

			uiArea.attachModelContextChange(fnChange);
			sap.ui.getCore().setModel(oModel1);
			child = new sap.ui.core.TestControl({
				value : "{/value}"
			});
			child.attachModelContextChange(fnChange);
			ctrl = new sap.ui.core.TestControl({
				value : "{/value}",
				children : [child]
			});
			ctrl.attachModelContextChange(fnChange);
			ctrl.placeAt(uiArea.getId());
		},

		afterEach : function() {
			uiArea.detachModelContextChange(fnChange);
			ctrl.destroy();
			ctrl = null;
			child = null;
			iPropagationCounter = 0;
			sap.ui.getCore().setModel();
		}
	});

    QUnit.test("add Propagation Listener", function(assert) {
    	fnPropListener = function(data, object) {
			assert.ok(data, "data passed");
			assert.equal(data.myData, "myData", "data object passed with data");
			assert.ok(object instanceof sap.ui.base.ManagedObject, "ManagedObject passed");
		}.bind(null,{myData:"myData"});
		var spy = sinon.spy(window, "fnPropListener");
    	ctrl.addPropagationListener(fnPropListener);
    	assert.ok(spy.callCount === 2, "Propagation listener called for every control");
    	var oChild2 = new sap.ui.core.TestControl({
			value : "{/value}",
			children : [child]
		});
    	ctrl.addAggregation("children", oChild2);
    	assert.ok(spy.callCount === 4, "Propagation listener called for new control and its child");
    	fnPropListener.restore();
    });

    QUnit.test("remove Propagation Listener", function(assert) {
    	fnPropListener = function(data, object) {
    		assert.ok(data, "data passed");
			assert.equal(data.myData, "myData", "data object passed with data");
			assert.ok(object instanceof sap.ui.base.ManagedObject, "ManagedObject passed");
		}.bind(null,{myData:"myData"});
    	ctrl.addPropagationListener(fnPropListener);
		var spy = sinon.spy(window, "fnPropListener");
    	ctrl.removePropagationListener(fnPropListener);
    	assert.ok(spy.callCount === 0, "Propagation listener not called");
    	var oChild2 = new sap.ui.core.TestControl({
			value : "{/value}",
			children : [child]
		});
    	ctrl.addAggregation("children", oChild2);
    	assert.ok(spy.callCount === 0, "Propagation listener not called");
    	fnPropListener.restore();
    });

    QUnit.test("propagation Listener and models/bindings", function(assert) {
    	fnPropListener = function(data, object) {
		}.bind(null,{myData:"myData"});
    	ctrl.addPropagationListener(fnPropListener);
		var spy = sinon.spy(window, "fnPropListener");
		ctrl.setModel(oModel2);
    	assert.ok(spy.callCount === 0, "Propagation listener not called on setModel");
    	ctrl.setBindingContext(oModel2.createBindingContext("/value"));
    	assert.ok(spy.callCount === 0, "Propagation listener not called on setBindingContext");
    	ctrl.bindElement("/value");
    	assert.ok(spy.callCount === 0, "Propagation listener not called on bindElement");
    	fnPropListener.restore();
    });

	QUnit.module("Model propagation", {
		beforeEach : function() {
			var oDiv = jQuery("<div></div>").appendTo("#uiAreas");
			uiArea = sap.ui.getCore().createUIArea(oDiv[0]);

			mPropagationInfo = {};

			fnChange = function(oEvent) {
				mPropagationInfo[oEvent.getSource().getId()] ? mPropagationInfo[oEvent.getSource().getId()]++ : mPropagationInfo[oEvent.getSource().getId()] = 1;
			};

			uiArea.attachModelContextChange(fnChange);
			sap.ui.getCore().setModel(oModel1);
			child = new sap.ui.core.TestControl({
				value : "{/value}"
			});
			child.attachModelContextChange(fnChange);
			ctrl = new sap.ui.core.TestControl({
				value : "{/value}",
				children : [child]
			});
			ctrl.attachModelContextChange(fnChange);
			ctrl.placeAt(uiArea.getId());
		},

		afterEach : function() {
			uiArea.detachModelContextChange(fnChange);
			ctrl.destroy();
			ctrl = null;
			child = null;
			iPropagationCounter = 0;
			sap.ui.getCore().setModel();
		}
	});

	QUnit.test("Model propagated from Core", function(assert) {
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(uiArea.getModel(), oModel1, "effective model of UIArea should be from Core");
		assert.equal(ctrl.getModel(), oModel1, "effective model of Root Control should be from Core");
		assert.equal(child.getModel(), oModel1, "effective model of Nested Control should be from Core");
		assert.equal(ctrl.getValue(), "1", "value of Root Control should be inherited from Core model");
		assert.equal(child.getValue(), "1", "value of Nested Control should be inherited from Core model");

		// setting the same model again should have no effect
		var oCtrlBindingBefore = ctrl.getBinding("value");
		var oChildBindingBefore = child.getBinding("value");
		sap.ui.getCore().setModel(oModel1);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fired on child");
		mPropagationInfo = {};

		assert.equal(uiArea.getModel(), oModel1, "effective model of UIArea still should be from Core");
		assert.equal(ctrl.getModel(), oModel1, "effective model of Root Control still should be from Core");
		assert.equal(child.getModel(), oModel1, "effective model of Nested Control still should be from Core");
		assert.equal(ctrl.getValue(), "1", "value of Root Control still should be inherited from Core model");
		assert.equal(child.getValue(), "1", "value of Nested Control still should be inherited from Core model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");

		// model change in Core should be reflected in UIArea and controls
		sap.ui.getCore().setModel(oModel3);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");

		assert.equal(uiArea.getModel(), oModel3, "new model should have been propagated from Core to UIArea");
		assert.equal(ctrl.getModel(), oModel3, "new model should have been propagated from Core to Root Control");
		assert.equal(child.getModel(), oModel3, "new model should have been propagated from Core to Nested Control");
		assert.equal(ctrl.getValue(), "3", "new value should be inherited from Core model");
		assert.equal(child.getValue(), "3", "new value should be inherited from Core model");
		assert.ok(oCtrlBindingBefore !== ctrl.getBinding("value"), "binding should have changed");
		assert.ok(oChildBindingBefore !== child.getBinding("value"), "binding should have changed");
	});

	QUnit.test("Model propagated from UIArea", function(assert) {
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		uiArea.setModel(oModel2);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel2, "model should be inherited from UIArea model");
		assert.equal(child.getModel(), oModel2, "model should be inherited from UIArea model");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from UIArea model");
		assert.equal(child.getValue(), "2", "value should be inherited from UIArea model");

		// setting the same model again should have no effect
		var oCtrlBindingBefore = ctrl.getBinding("value");
		var oChildBindingBefore = child.getBinding("value");
		uiArea.setModel(oModel2);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fired on child");

		assert.equal(uiArea.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(ctrl.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(child.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from UIArea model");
		assert.equal(child.getValue(), "2", "value should be inherited from UIArea model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");

		// model change in Core should not be reflected in UIArea and controls
		sap.ui.getCore().setModel(oModel2);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fired on child");

		assert.equal(uiArea.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(ctrl.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(child.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from UIArea model");
		assert.equal(child.getValue(), "2", "value should be inherited from UIArea model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");

		// model change in Core should not be reflected in UIArea and controls
		sap.ui.getCore().setModel(oModel3);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(uiArea.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(ctrl.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(child.getModel(), oModel2, "model should have been propagated from UIArea");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from UIArea model");
		assert.equal(child.getValue(), "2", "value should be inherited from UIArea model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");
		sap.ui.getCore().setModel(oModel1);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		// model change in UIArea should be reflected in UIArea and controls
		uiArea.setModel(oModel3);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(uiArea.getModel(), oModel3, "model should have been propagated from UIArea");
		assert.equal(ctrl.getModel(), oModel3, "model should have been propagated from UIArea");
		assert.equal(child.getModel(), oModel3, "model should have been propagated from UIArea");
		assert.equal(ctrl.getValue(), "3", "value should be inherited from UIArea model");
		assert.equal(child.getValue(), "3", "value should be inherited from UIArea model");
		assert.ok(oCtrlBindingBefore !== ctrl.getBinding("value"), "binding should have changed");
		assert.ok(oChildBindingBefore !== child.getBinding("value"), "binding should have changed");

		// after removing the model from the UIArea, Core model should be effective again
		var oCtrlBindingBefore = ctrl.getBinding("value");
		var oChildBindingBefore = child.getBinding("value");
		uiArea.setModel();
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(uiArea.getModel(), oModel1, "model should have been propagated from Core");
		assert.equal(ctrl.getModel(), oModel1, "model should have been propagated from Core");
		assert.equal(child.getModel(), oModel1, "model should have been propagated from Core");
		assert.equal(ctrl.getValue(), "1", "value should be inherited from Core model");
		assert.equal(child.getValue(), "1", "value should be inherited from UIArea model");
		assert.ok(oCtrlBindingBefore !== ctrl.getBinding("value"), "binding should have changed");
		assert.ok(oChildBindingBefore !== child.getBinding("value"), "binding should have changed");

	});

	QUnit.test("Model propagated from parent", function(assert) {
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		ctrl.setModel(oModel2);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel2, "model should be inherited from UIArea model");
		assert.equal(child.getModel(), oModel2, "model should be inherited from UIArea model");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from UIArea model");
		assert.equal(child.getValue(), "2", "value should be inherited from UIArea model");

		// setting the same model again should have no effect
		var oCtrlBindingBefore = ctrl.getBinding("value");
		var oChildBindingBefore = child.getBinding("value");
		ctrl.setModel(oModel2);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fired on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel2, "model should have been propagated from parent");
		assert.equal(child.getModel(), oModel2, "model should have been propagated from parent");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from parent model");
		assert.equal(child.getValue(), "2", "value should be inherited from parent model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");

		// model change in UIArea should not be reflected in child
		uiArea.setModel(oModel3);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel2, "model should have been propagated from parent");
		assert.equal(child.getModel(), oModel2, "model should have been propagated from parent");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from parent model");
		assert.equal(child.getValue(), "2", "value should be inherited from parent model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");

		// model change in Core should not be reflected in child
		sap.ui.getCore().setModel(oModel3);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fired on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel2, "model should have been propagated from parent");
		assert.equal(child.getModel(), oModel2, "model should have been propagated from parent");
		assert.equal(ctrl.getValue(), "2", "value should be inherited from parent model");
		assert.equal(child.getValue(), "2", "value should be inherited from parent model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");

		// model change in parent should be reflected in child
		ctrl.setModel(oModel3);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event fired on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event fired on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel3, "model should have been propagated from parent");
		assert.equal(child.getModel(), oModel3, "model should have been propagated from parent");
		assert.equal(ctrl.getValue(), "3", "value should be inherited from parent model");
		assert.equal(child.getValue(), "3", "value should be inherited from parent model");
		assert.ok(oCtrlBindingBefore !== ctrl.getBinding("value"), "binding should have changed");
		assert.ok(oChildBindingBefore !== child.getBinding("value"), "binding should have changed");

		// after removing the model from the parent, UIArea model should be effective again
		var oCtrlBindingBefore = ctrl.getBinding("value");
		var oChildBindingBefore = child.getBinding("value");
		ctrl.setModel();
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event fired on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event fired on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel3, "model should have been propagated from UIArea");
		assert.equal(child.getModel(), oModel3, "model should have been propagated from UIArea");
		assert.equal(ctrl.getValue(), "3", "value should be inherited from UIArea model");
		assert.equal(child.getValue(), "3", "value should be inherited from UIArea model");
		assert.ok(oCtrlBindingBefore === ctrl.getBinding("value"), "binding should not have changed");
		assert.ok(oChildBindingBefore === child.getBinding("value"), "binding should not have changed");
	});

	QUnit.test("Model propagated from UIArea", function(assert){
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		var oBindingBefore = ctrl.getBinding("value");
		ctrl.setModel(oModel2);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		var oBindingAfter = ctrl.getBinding("value");
		assert.equal(ctrl.getValue(), "2", "value should not be inherited from core model ");
	});

	QUnit.test("override core model", function(assert){
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		ctrl.setModel(oModel2);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		var oBindingBefore = ctrl.getBinding("value");
		sap.ui.getCore().setModel(oModel3);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		var oBindingAfter = ctrl.getBinding("value");
		assert.equal(ctrl.getValue(), "2", "value still should not be inherited from core model ");
		assert.ok(oBindingBefore === oBindingAfter, "binding should not change as it is not affected");
	});

	QUnit.test("remove content from uiArea: no models set", function(assert){
		var done = assert.async();
		sap.ui.getCore().setModel();
		mPropagationInfo = {};

		content = uiArea.removeAllContent();
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fired on child");
		mPropagationInfo = {};

		assert.ok(!ctrl.getModel(), "no model set on ctrl");
		assert.ok(!child.getModel(), "no model set on child");
		assert.ok(!uiArea.getModel(), "no model set on uiArea");

		var oBindingBefore = ctrl.getBinding("value");
		sap.ui.getCore().setModel(oModel3);
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fired on child");
		mPropagationInfo = {};

		uiArea.addContent(content[0]);
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};

		assert.equal(ctrl.getModel(), oModel3, "model should have been propagated from UIArea");
		assert.equal(child.getModel(), oModel3, "model should have been propagated from control");
		assert.equal(uiArea.getModel(), oModel3, "model should have been propagated from core");

		ctrl.removeAllChildren();
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
		assert.ok(!mPropagationInfo[child.getId()], "ModelContextChange event not fire on child - should happen async");
		mPropagationInfo = {};
		setTimeout(function() {
			assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
			assert.ok(!mPropagationInfo[ctrl.getId()], "ModelContextChange event not fired on ctrl");
			assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child - should happen async");
			done();
		},0);
	});

	QUnit.test("remove content from uiArea: model set", function(assert){

		uiArea.removeContent();
		assert.ok(mPropagationInfo[uiArea.getId()] === 1, "ModelContextChange event on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event on child");
		mPropagationInfo = {};
	});

	QUnit.test("Move child / remove child: async setParent null propagation", function(assert) {
		var done = assert.async();
		//remove from parent
		var moveCtrl = uiArea.removeContent(ctrl);

		// check for expected modifications: not yet propagated
		assert.ok(child.getParent() != null, "parent shouldn't be null");
		assert.ok(ctrl.getParent() == null, "parent should be null");
		assert.ok(child.getModel() != null, "child should have a default model");
		assert.ok(ctrl.getModel() == null, "ctrl should have no model");
		assert.ok(child.getBinding("value") != null, "child should have a binding for the default model");
		assert.ok(child.oPropagatedProperties !== ctrl.oPropagatedProperties, "child should no longer inherit propagatedProperties 1:1 from ctrl");
		assert.ok(ctrl.oPropagatedProperties === sap.ui.base.ManagedObject._oEmptyPropagatedProperties, "ctrl has no propagated properties");

		//simulate a move by sync adding the control again
		uiArea.addContent(moveCtrl);

		setTimeout(function() {
			// check for expected modifications
			assert.ok(child.getParent() != null, "parent shouldn't be null");
			assert.ok(ctrl.getParent() != null, "parent shouldn't be null");
			assert.ok(child.getModel() != null, "child should have a default model");
			assert.ok(ctrl.getModel() != null, "ctrl should have a default model");
			assert.ok(child.getBinding("value") != null, "child should have a binding for the default model");
			assert.ok(child.oPropagatedProperties === ctrl.oPropagatedProperties, "child should no longer inherit propagatedProperties 1:1 from ctrl");

			// remove from parent - no move
			var moveCtrl = uiArea.removeContent(ctrl);
			// check for expected modifications: not yet propagated
			assert.ok(child.getParent() != null, "parent shouldn't be null");
			assert.ok(ctrl.getParent() == null, "parent should be null");
			assert.ok(child.getModel() != null, "child should have a default model");
			assert.ok(ctrl.getModel() == null, "ctrl should have no model");
			assert.ok(child.getBinding("value") != null, "child should have a binding for the default model");
			assert.ok(child.oPropagatedProperties !== ctrl.oPropagatedProperties, "child should no longer inherit propagatedProperties 1:1 from ctrl");
			assert.ok(ctrl.oPropagatedProperties === sap.ui.base.ManagedObject._oEmptyPropagatedProperties, "ctrl has no propagated properties");

			setTimeout(function() {
				// check for expected modifications: async propagation done
				assert.ok(ctrl.getParent() == null, "parent should be null");
				assert.ok(child.getModel() == null, "child shouldn't have a default model");
				assert.ok(ctrl.getModel() == null, "ctrl shouldn't have a default model");
				assert.ok(child.getBinding("value") == null, "child shouldn't have a binding for the default model");
				assert.ok(child.oPropagatedProperties === sap.ui.base.ManagedObject._oEmptyPropagatedProperties, "child should no longer inherit propagatedProperties 1:1 from ctrl");
				assert.ok(ctrl.oPropagatedProperties === sap.ui.base.ManagedObject._oEmptyPropagatedProperties, "ctrl should no longer inherit propagatedProperties 1:1 from ctrl");
				done();
			}, 0);
		}, 0);
	});

	QUnit.module("More Complex Updates", {
		beforeEach : function() {
			sap.ui.getCore().setModel(oModel1);
			uiArea = sap.ui.getCore().createUIArea("content");
			uiArea.setModel(null);
			child = new sap.ui.core.TestControl({
				value : { parts : [ "/value", "m2>/value" ], formatter : function(a,b) { return a + ":" + b; } },
				other : "{m2>/value}"
			});
			ctrl = new sap.ui.core.TestControl({
				value : { parts : [ "m2>/value", "/value" ], formatter : function(a,b) { return a + ":" + b; } },
				other : "{/value}",
				children : [child]
			});
			ctrl.placeAt("content");
		},

		afterEach : function() {
			sap.ui.getCore().setModel(null, "m2");
			ctrl.destroy();
			ctrl = null;
			child = null;
		}
	});

	QUnit.test("incomplete binding context", function(assert){
		assert.ok(!!ctrl.getBindingInfo("value"), "control should have binding info for 'value'");
		assert.ok(!ctrl.getBinding("value"), "control must not have a binding for 'value'");
		assert.ok(!!ctrl.getBindingInfo("other"), "control should have binding info for 'other'");
		assert.ok(!!ctrl.getBinding("other"), "control should have a binding for 'other'");
		assert.ok(!!child.getBindingInfo("value"), "child should have binding info");
		assert.ok(!child.getBinding("value"), "child must not have a binding for 'value'");
		assert.ok(!!child.getBindingInfo("other"), "child should have binding info for 'other'");
		assert.ok(!child.getBinding("other"), "child must not have a binding for 'other'");
		sap.ui.getCore().setModel(oModel2, "m2");
		assert.ok(!!ctrl.getBinding("value"), "control now should have a binding");
		assert.ok(!!ctrl.getBinding("other"), "control now should have a binding");
		assert.ok(!!child.getBinding("value"), "child now should have a binding");
		assert.ok(!!child.getBinding("other"), "child now should have a binding");
		sap.ui.getCore().setModel(null);
		assert.ok(!ctrl.getBinding("value"), "control should no longer have a binding for 'value'");
		assert.ok(!ctrl.getBinding("other"), "control should no longer have a binding for 'other'");
		assert.ok(!child.getBinding("value"), "child should no longer have a binding for 'value'");
		assert.ok(!!child.getBinding("other"), "child still should have a binding for 'other'");
		ctrl.setModel(oModel1);
		assert.ok(!!ctrl.getBinding("value"), "control now should have a binding");
		assert.ok(!!ctrl.getBinding("other"), "control now should have a binding");
		assert.ok(!!child.getBinding("value"), "child now should have a binding");
		assert.ok(!!child.getBinding("other"), "child now should have a binding");
	});

	QUnit.test("Multiple References to Same Model", function(assert) {

		// default model and m2 are set to the same model instance
		sap.ui.getCore().setModel(oModel1, "m2");
		// bindings should be complete now
		assert.ok(!!ctrl.getBindingInfo("value"), "control should have binding info for 'value'");
		assert.ok(!!ctrl.getBinding("value"), "control should have a binding for 'value'");
		assert.ok(!!ctrl.getBindingInfo("other"), "control should have binding info for 'other'");
		assert.ok(!!ctrl.getBinding("other"), "control should have a binding for 'other'");
		assert.ok(!!child.getBindingInfo("value"), "child should have binding info for 'value'");
		assert.ok(!!child.getBinding("value"), "child should have a binding for 'value'");
		assert.ok(!!child.getBindingInfo("other"), "child should have binding info for 'other'");
		assert.ok(!!child.getBinding("other"), "child should have a binding for 'other'");

		// now remove one instance (the named one)
		sap.ui.getCore().setModel(null, "m2");

		// only bindings that used m2 must be invalidated
		assert.ok(!ctrl.getBinding("value"), "control must not have a binding for 'value'");
		assert.ok(!!ctrl.getBinding("other"), "control still should have a binding for 'other");
		assert.ok(!child.getBinding("value"), "child must not have a binding for 'value'");
		assert.ok(!child.getBinding("other"), "child must not have a binding for 'other'");
	});

	QUnit.test("Remove from Parent", function(assert) {
		//check preconditions
		assert.equal(ctrl.getModel(), oModel1, "ctrl should inherit model1 from Core");
		assert.equal(child.getModel(), oModel1, "child should inherit model1 from ctrl");
		assert.ok(child.oPropagatedProperties === ctrl.oPropagatedProperties, "child should inherit propagatedProperties 1:1 from ctrl");

		// now remove from parent
		ctrl.removeChild(child);

		// check for expected modifications
		assert.ok(child.getParent() == null, "parent should be null");
		assert.ok(child.getModel() == null, "child shouldn't have a default model");
		assert.ok(child.getBinding("value") == null, "child shouldn't have a binding for the default model");
		assert.ok(child.oPropagatedProperties !== ctrl.oPropagatedProperties, "child should no longer inherit propagatedProperties 1:1 from ctrl");
	});

	QUnit.test("Changing Parent", function(assert) {
		var oNewParent = new sap.ui.core.TestControl({
			value : { parts : [ "m2>/value", "/value" ], formatter : function(a,b) { return a + ":" + b; } },
			other : "{/value}"
		});
		oNewParent.setModel(oModel2);

		//check preconditions
		assert.equal(ctrl.getModel(), oModel1, "ctrl should inherit model1 from Core");
		assert.equal(child.getModel(), oModel1, "child should inherit model1 from ctrl");
		assert.ok(child.oPropagatedProperties === ctrl.oPropagatedProperties, "child should inherit propagatedProperties 1:1 from ctrl");

		// now modify parent
		oNewParent.addChild(child);

		// check for expected modifications
		assert.ok(child.getParent() === oNewParent, "parent should have changed");
		assert.equal(child.getModel(), oModel2, "child should inherit model1 from newParent");
		assert.ok(ctrl.getModel() === oModel1, "ctrl still should inherit model from Core");
		assert.ok(child.oPropagatedProperties !== ctrl.oPropagatedProperties, "child should no longer inherit propagatedProperties 1:1 from ctrl");
	});

	QUnit.module("Context Binding", {
		beforeEach : function() {
			mPropagationInfo = {};
			fnChange = function(oEvent) {
				mPropagationInfo[oEvent.getSource().getId()] ? mPropagationInfo[oEvent.getSource().getId()]++ : mPropagationInfo[oEvent.getSource().getId()] = 1;
			};
			uiArea = sap.ui.getCore().createUIArea("content");
			uiArea.attachModelContextChange(fnChange);

			sap.ui.getCore().setModel(oModel4);

			child = new sap.ui.core.TestControl({
				value : "{}",
			});
			child.attachModelContextChange(fnChange);
			ctrl = new sap.ui.core.TestControl({
				value : "{}",
				children : [child]
			});
			ctrl.attachModelContextChange(fnChange);
			ctrl.placeAt("content");
		},

		afterEach : function() {
			sap.ui.getCore().setModel(null);
			ctrl.destroy();
			ctrl = null;
			child = null;
		}
	});
/*
	QUnit.test("Binding/Model types", function(assert) {
		var done = assert.async();
		oModel5.metadataLoaded().then(function(){
			var child = new sap.ui.core.TestControl({
				objectBindings: "Suppliers(1)",
				value: "{CompanyName}"

			});
			var ctrl = new sap.ui.core.TestControl({
				children : [child]
			});
			var spy = sinon.spy(oModel5, "read");
			ctrl.setModel(oModel4);
			child.setModel(oModel5);
			assert.ok(!child.getValue(), "Value should not be resolved");
			var oJSONContext = oModel4.createBindingContext("/");
			child.setBindingContext(oJSONContext);
			assert.ok(spy.callCount === 0, "no request should be sent");
			oModel5.read.restore();
			done();
		});
	});
*/
	QUnit.test("Binding/Model types 2", function(assert) {
		var done = assert.async();
		oModel5.metadataLoaded().then(function(){
			var ctrl3 = new sap.ui.core.TestControl({
				objectBindings: "Suppliers(1)",
				value: "{CompanyName}"
			});
			var ctrl2 = new sap.ui.core.TestControl({
				models: oModel5,
				children: [ctrl3]
			});
			var ctrl = new sap.ui.core.TestControl({
				children : [ctrl2]
			});

			var spy = sinon.spy(oModel5, "read");
			ctrl.setModel(oModel4);
			assert.ok(!ctrl3.getValue(), "Value should not be resolved");
			var oJSONContext = oModel4.createBindingContext("/");
			ctrl.setBindingContext(oJSONContext);
			assert.ok(spy.callCount === 0, "no request should be sent");
			oModel5.read.restore();
			done();
		});
	});

	QUnit.test("Context binding instance", function(assert) {
		mPropagationInfo = {};
		ctrl.bindElement("/data");
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event fired on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event fired on child");
		mPropagationInfo = {};

		assert.ok(ctrl.getElementBinding() instanceof sap.ui.model.ContextBinding, "ContextBinding should exist");
		assert.ok(child.getBindingContext() === ctrl.getBindingContext(), "Context should be propagated");
		assert.ok(child.getBindingContext().getPath() === "/data", "Context path should be '/data'");

		ctrl.unbindElement();
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event fired on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event fired on child");
		mPropagationInfo = {};

		assert.ok(!ctrl.getElementBinding(), "ContextBinding should be deleted");
		assert.ok(!ctrl.getBindingContext(), "No binding context should exist");
		assert.ok(!child.getBindingContext(), "No binding context should exist");

		ctrl.bindElement("/nodata");
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event fired on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event fired on child");
		mPropagationInfo = {};

		assert.ok(child.getBindingContext().getPath() === "/nodata", "Context path should be '/nodata'");
		ctrl.bindElement("/data");
		assert.ok(!mPropagationInfo[uiArea.getId()], "ModelContextChange event not fired on uiArea");
		assert.ok(mPropagationInfo[ctrl.getId()] === 1, "ModelContextChange event fired on ctrl");
		assert.ok(mPropagationInfo[child.getId()] === 1, "ModelContextChange event fired on child");
		mPropagationInfo = {};

		assert.ok(child.getBindingContext().getPath() === "/data", "Context path should be '/data'");
	});
	QUnit.test("Context binding values", function(assert) {
		ctrl.bindElement("/data/0/");
		assert.ok(child.getValue() === "0", "Value should be resolved");
		ctrl.bindElement("/data/2/");
		assert.ok(child.getValue() === "2", "Value should be resolved");
		ctrl.unbindElement();
		assert.ok(!child.getValue(), "Value should be cleared");
	});

	</script>

</head>
<body>
<h1 id="qunit-header">QUnit tests: Data binding JSON Bindings</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<div id="qunit-testrunner-toolbar"></div>
<ol id="qunit-tests"></ol>
<br>
<div id="content"></div>
<div id="uiAreas"></div>
</body>
</html>
