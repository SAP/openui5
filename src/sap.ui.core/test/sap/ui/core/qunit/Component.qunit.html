<!DOCTYPE HTML>

<!--
  Tested class: sap.ui.core.Component, sap.ui.core.UIComponent
-->

<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>QUnit test: Component</title>
	<script id="sap-ui-bootstrap"
		type="text/javascript"
		src="../../../../../resources/sap-ui-core.js"
		data-sap-ui-theme="sap_bluecrystal"
		data-sap-ui-libs="sap.m"
		data-sap-ui-language="en"
		data-sap-ui-noConflict="true">
	</script>
<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css"
	media="screen" />
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

	<!-- Initialization -->
	<script>
	sinon.config.useFakeTimers = false;
	jQuery.sap.require("sap.ui.qunit.qunit-coverage");

	QUnit.config.autostart = false;
	jQuery(document).ready(function() {
		QUnit.start();
	});
	jQuery.sap.registerModulePath("samples.components", "../../../../../test-resources/sap/ui/core/samples/components/");
	var oCompCont1 = new sap.ui.core.ComponentContainer("CompCont1", {
		name: "samples.components.button",
		id: "myButton",
		settings: {
			text: "Text changed through settings",
			componentData: {
				"foo": "bar"
			}
		}
	});
	oCompCont1.placeAt("comparea1");

	var oComp = sap.ui.getCore().createComponent({
		name: "samples.components.verticalLayout",
		id: "vLayout",
		componentData: {
			"foo": "bar"
		}
	});

	var oCompCont = new sap.ui.core.ComponentContainer("ContVLayout", {
		component : oComp
	});
	oCompCont.placeAt("comparea2");

	//******************************************************
	//Test preparation for custom component configuration
	jQuery.sap.require("sap.ui.core.Component");
	sap.ui.core.Component.extend("test.comp1.Component", {
		metadata: {
			"properties" : {
				"test" : "string"
			},
			"my.custom.config" : {
				"property1" : "value1",
				"property2" : "value2"
			}
		}
	});
	test.comp1.Component.extend("test.comp2.Component", {
		metadata: {
			"my.custom.config" : {
				"property1" : "value3"
			}
		}
	});
	//******************************************************


 	module("Basic Components");

	test("Simple Component Instance", function(){
		ok(document.getElementById("CompCont1"));
		var elem = jQuery.sap.byId("__component0---mybutn");
		equal(elem.text(), "Text changed through settings", "Settings applied");
	});

	test("Nested Components", function(){
		ok(document.getElementById("ContVLayout"));
		//check for ids of nested elements
		ok(document.getElementById("vLayout---myLayout"));
		ok(document.getElementById("vLayout---nB"));
		ok(document.getElementById("vLayout---myTF"));
		ok(document.getElementById("vLayout---ContButton"));
		ok(document.getElementById("vLayout---ContButton-uiarea"));
		ok(document.getElementById("vLayout---comp_button---mybutn"));
	});

	test("Components Metadata", function(){
		var includes = ["css/vlayout.css","/js/includeme.js"];
		var components =  ["samples.components.styledbutton"];
		equal(oComp.getMetadata().getVersion(), "1.0", "Version retrieved");
		deepEqual(oComp.getMetadata().getIncludes(), includes, "Includes Array retrieved");
		notEqual(oComp.getMetadata().getDependencies(), null, "Dependencies retrieved");
		deepEqual(oComp.getMetadata().getComponents(), components, "Child components retrieved");
		equal(oComp.getMetadata().getUI5Version(), "1.13.0", "UI5 Version retrieved");
	});

	test("Components Metadata - Custom Configuration Entry", function(){
		var oSuccessMerged = test.comp2.Component.getMetadata().getCustomEntry("my.custom.config", true);
		var oSuccessUnMerged = test.comp2.Component.getMetadata().getCustomEntry("my.custom.config", false);
		var oFail = test.comp2.Component.getMetadata().getCustomEntry("properties");

		ok(!oFail, "Standard metadata can not be accessed.");
		equal(oSuccessMerged.property1, "value3", "Property 1 merged and overridden.");
		equal(oSuccessMerged.property2, "value2", "Property 2 merged and but not overridden.");
		equal(oSuccessUnMerged.property1, "value3", "Property 1 not merged.");
		ok(!oSuccessUnMerged.property2, "Property 2 not merged (does not exist).");
	});

	test("Components Metadata - Load from file", function(){
		jQuery.sap.require("samples.components.loadfromfile.Component");
		var oMetadata = samples.components.loadfromfile.Component.getMetadata();

		deepEqual(oMetadata.getIncludes(), ["css/includeme.css", "js/includeme.js"], "Includes are available.");
		ok(oMetadata.hasProperty("prop1"), "Property 'prop1' available.");
	});

	test("Components Includes", function(){
		ok((typeof foo == 'function'), "function foo from included js exists");
		sFontSize = "4px";
		foo("comparea2", sFontSize);
		var sSize = jQuery("#comparea2").css('font-size');
		equal(sSize, sFontSize, "function from JS include invoked");
		equal(jQuery.sap.byId("vLayout---myTF").css("padding-left"), "321px", "CSS from include applied");
	});

	test("Factory Function", function(){
		var oComponent = sap.ui.component(oComp.getId());
		equal(oComponent, oComp, "Factory function returns the same instance!");
		oComponent = sap.ui.component({
			name: "samples.components.verticalLayout",
			id: "factoryVLayout"
		});
		ok(!!oComponent, "Component has been created!");
		equal(oComponent.getMetadata(), oComp.getMetadata(), "Component is equal!");
	});

	test("Component Data", function(){
		ok(!!oComp.getComponentData(), "Component has component data");
		equal(oComp.getComponentData().foo, "bar", "Component data is correct");
		var oComponent = sap.ui.getCore().getComponent(oCompCont1.getComponent());
		ok(!!oComponent.getComponentData(), "Component has component data");
		equal(oComponent.getComponentData().foo, "bar", "Component data is correct");
	});

 	module("Creation Context");

	test("Basic Test", function(){
		// check that the layout has the reference to the component
		var oLayout = oComp.byId("myLayout");
		var sRefComponentId = oLayout._sOwnerId; // INTERNAL ONLY!
		equal(oComp.getId(), sRefComponentId, "The nested control has the correct component context");
		// check the nested component having the ID of the parent component
		var oNestedComponentContainer = oComp.byId("ContButton");
		var sNestedComponentId = oNestedComponentContainer.getComponent();
		var oNestedComponent = sap.ui.component(sNestedComponentId);
		equal(sRefComponentId, sap.ui.core.Component.getOwnerIdFor(oNestedComponent), "The nested component has the correct component context");
		// check the control in the nested component to have the correct component context
		var oNestedControl = oNestedComponent.byId("mybutn");
		equal(sNestedComponentId, oNestedControl._sOwnerId, "The nested control has the correct component context"); // INTERNAL ONLY!
	});

	QUnit.module("Routing", {
		beforeEach : function () {
			// System under test
			this.oComponent = sap.ui.getCore().createComponent({
				name: "samples.components.routing"
			});
			this.oComponent.init();
		}
	});

	QUnit.test("Should create a custom router class", function(assert) {
		//Act
		var oRouter = this.oComponent.getRouter();

		//Assert
		assert.ok(oRouter instanceof samples.components.routing.RouterExtension, "the created router was an extension");
		assert.strictEqual(oRouter._oConfig.targetParent, this.oComponent.oView.getId(), "the viewid is the targetParent");

		//Cleanup
		this.oComponent.destroy();
		assert.ok(oRouter.bIsDestroyed, "Router got destroyed when the component is destroyed");
	});

	QUnit.test("Should return the targets instance of the router", function (assert) {
		//Act - initialize the component to create the router
		var oTargets = this.oComponent.getTargets();

		//Assert
		assert.ok(oTargets, "the component created targets");
		var oTarget = oTargets.getTarget("myTarget");
		assert.ok(oTarget, "the component created a target instance");
		assert.strictEqual(oTarget._oOptions.rootView, this.oComponent.oView.getId(), "the viewid is the rootView");

		//Cleanup
		this.oComponent.destroy();
		assert.ok(oTargets.bIsDestroyed, "Targets got destroyed when the component is destroyed");
	});

	module("Routing", {
		setup : function () {
			// System under test
			this.oComponent = sap.ui.getCore().createComponent({
				name: "samples.components.targets"
			});
			this.oComponent.init();
		}
	});

	QUnit.test("Should create the targets instance standalone", function (assert) {
		//Act - initialize the component to create the router
		var oTargets = this.oComponent.getTargets();
		var oViews = this.oComponent._oViews;

		//Assert
		assert.ok(oTargets, "the component created targets");
		var oTarget = oTargets.getTarget("myTarget");
		assert.ok(oTarget, "the component created a target instance");
		assert.strictEqual(oTarget._oOptions.rootView, this.oComponent.oView.getId(), "the viewid is the rootView");
		assert.strictEqual(oViews._oComponent, this.oComponent, "the views instance knows its component");

		//Cleanup
		this.oComponent.destroy();
		assert.ok(oTargets.bIsDestroyed, "Targets got destroyed when the component is destroyed");
		assert.ok(oViews.bIsDestroyed, "Views created by the component got destroyed");
	});

	QUnit.module("Root control", {
		beforeEach : function () {
			// System under test
			this.oComponent = sap.ui.getCore().createComponent({
				name: "samples.components.routing"
			});
		}
	});

	QUnit.test("Should get the root control", function (assert) {
		//Act
		var oRootControl = this.oComponent.getAggregation("rootControl");

		//Assert
		assert.strictEqual(this.oComponent._oViewWhileInit, oRootControl, "the root control is available in the init function");
		assert.strictEqual(this.oComponent.oView, oRootControl, "the returned control is the rootView");
		assert.strictEqual(this.oComponent._oViewWhileCeateContent, null, "in the create content the control is still null");

		//Cleanup
		this.oComponent.destroy();
		assert.ok(oRootControl.bIsDestroyed, "Root control got destroyed when the component is destroyed");
	});


	QUnit.module("Manifest First", {
		beforeEach : function() {

			//setup fake server
			var oManifest = this.oManifest = {
				"sap.app" : {
					"id" : "samples.components.button"
				}
			};
			var oAltManifest1 = this.oAltManifest1 = {
				"sap.app" : {
					"id" : "samples.components.config"
				}
			};

			var oAltManifest2 = this.oAltManifest2 = {
				"sap.app" : {
					"id" : "samples.components.oneview"
				}
			};

			var oServer = this.oServer = sinon.sandbox.useFakeServer();

			oServer.xhr.useFilters = true;
			oServer.xhr.filters = [];
			oServer.xhr.addFilter(function(method, url) {
				return ("/anylocation/manifest.json" !== url && "/anyotherlocation1/manifest.json" !== url && "/anyotherlocation2/manifest.json" !== url);
			});

			oServer.autoRespond = true;
			oServer.respondWith("GET", "/anylocation/manifest.json", [
				200,
				{
					"Content-Type": "application/json"
				},
				JSON.stringify(oManifest)
			]);
			oServer.respondWith("GET", "/anyotherlocation1/manifest.json", [
				200,
				{
					"Content-Type": "application/json"
				},
				JSON.stringify(oAltManifest1)
			]);
			oServer.respondWith("GET", "/anyotherlocation2/manifest.json", [
				200,
				{
					"Content-Type": "application/json"
				},
				JSON.stringify(oAltManifest2)
			]);

		},
		afterEach : function() {}
	});


	QUnit.test("Manifest delegation to component instance (sync)", function(assert) {

		var oServer = this.oServer, oManifest = this.oManifest;

		//start test
		var oComponent = sap.ui.component({
			manifestUrl : "/anylocation/manifest.json"
		});

		assert.ok(oComponent.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
		assert.ok(oComponent.getManifest(), "Manifest is available");
		assert.deepEqual(oComponent.getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");

		var sAcceptLanguage = oServer.requests && oServer.requests[0] && oServer.requests[0].requestHeaders && oServer.requests[0].requestHeaders["Accept-Language"];
		assert.equal(sAcceptLanguage, "en", "Manifest was requested with proper language");

	});

	QUnit.test("Manifest delegation to component instance (sync, delayed instantiation)", function(assert) {

		var oServer = this.oServer, oManifest = this.oManifest;

		//start test
		var fnComponentClass = sap.ui.component.load({
			manifestUrl : "/anylocation/manifest.json"
		});

		assert.ok(fnComponentClass.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
		assert.ok(fnComponentClass.getMetadata().getManifest(), "Manifest is available");
		assert.deepEqual(fnComponentClass.getMetadata().getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");
		assert.throws(function() {
			fnComponentClass.extend("new.Component", {});
		}, new Error("Extending Components created by Manifest is not supported!"), "Extend should raise an exception");

		var oComponent = new fnComponentClass();

		assert.ok(oComponent.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
		assert.ok(oComponent.getManifest(), "Manifest is available");
		assert.deepEqual(oComponent.getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");

		var sAcceptLanguage = oServer.requests && oServer.requests[0] && oServer.requests[0].requestHeaders && oServer.requests[0].requestHeaders["Accept-Language"];
		assert.equal(sAcceptLanguage, "en", "Manifest was requested with proper language");

	});

	QUnit.test("Manifest delegation to component instance (async)", function(assert) {

		var oServer = this.oServer, oManifest = this.oManifest;

		//start test
		var done = assert.async();
		sap.ui.component({
			manifestUrl : "/anylocation/manifest.json",
			async : true
		}).then(function(oComponent) {

			assert.ok(oComponent.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
			assert.ok(oComponent.getManifest(), "Manifest is available");
			assert.deepEqual(oComponent.getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");

			var sAcceptLanguage = oServer.requests && oServer.requests[0] && oServer.requests[0].requestHeaders && oServer.requests[0].requestHeaders["Accept-Language"];
			assert.equal(sAcceptLanguage, "en", "Manifest was requested with proper language");

			done();

		});

	});

	QUnit.test("Manifest delegation to component instance (async, delayed instantiation)", function(assert) {

		var oServer = this.oServer, oManifest = this.oManifest;

		//start test
		var done = assert.async();
		sap.ui.component.load({
			manifestUrl : "/anylocation/manifest.json",
			async : true
		}).then(function(fnComponentClass) {

			assert.ok(fnComponentClass.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
			assert.ok(fnComponentClass.getMetadata().getManifest(), "Manifest is available");
			assert.deepEqual(fnComponentClass.getMetadata().getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");
			assert.throws(function() {
				fnComponentClass.extend("new.Component", {});
			}, new Error("Extending Components created by Manifest is not supported!"), "Extend should raise an exception");

			var oComponent = new fnComponentClass();

			assert.ok(oComponent.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
			assert.ok(oComponent.getManifest(), "Manifest is available");
			assert.deepEqual(oComponent.getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");

			var sAcceptLanguage = oServer.requests && oServer.requests[0] && oServer.requests[0].requestHeaders && oServer.requests[0].requestHeaders["Accept-Language"];
			assert.equal(sAcceptLanguage, "en", "Manifest was requested with proper language");

			done();

		});

	});

	QUnit.test("Alternate URL for component (sync)", function(assert) {

		var oServer = this.oServer, oManifest = this.oAltManifest1;

		// create an invalid registration for samples.components.config to see that the "url" parameter works
		jQuery.sap.registerModulePath("samples.components.config", "../../../../../test-resources/invalid/");

		//start test
		var fnComponentClass = sap.ui.component.load({
			manifestUrl : "/anyotherlocation1/manifest.json",
			url : "../../../../../test-resources/sap/ui/core/samples/components/config/"
		});

		assert.ok(fnComponentClass.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
		assert.ok(fnComponentClass.getMetadata().getManifest(), "Manifest is available");
		assert.deepEqual(fnComponentClass.getMetadata().getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");
		assert.throws(function() {
			fnComponentClass.extend("new.Component", {});
		}, new Error("Extending Components created by Manifest is not supported!"), "Extend should raise an exception");

		var oComponent = new fnComponentClass();

		assert.ok(oComponent.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
		assert.ok(oComponent.getManifest(), "Manifest is available");
		assert.deepEqual(oComponent.getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");

		var sAcceptLanguage = oServer.requests && oServer.requests[0] && oServer.requests[0].requestHeaders && oServer.requests[0].requestHeaders["Accept-Language"];
		assert.equal(sAcceptLanguage, "en", "Manifest was requested with proper language");

	});

	QUnit.test("Alternate URL for component (async)", function(assert) {

		var oServer = this.oServer, oManifest = this.oAltManifest2;

		// create an invalid registration for samples.components.config to see that the "url" parameter works
		jQuery.sap.registerModulePath("samples.components.oneview", "../../../../../test-resources/invalid/");

		//start test
		var done = assert.async();
		sap.ui.component.load({
			manifestUrl : "/anyotherlocation2/manifest.json",
			url : "../../../../../test-resources/sap/ui/core/samples/components/oneview/",
			async : true
		}).then(function(fnComponentClass) {

			assert.ok(fnComponentClass.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
			assert.ok(fnComponentClass.getMetadata().getManifest(), "Manifest is available");
			assert.deepEqual(fnComponentClass.getMetadata().getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");
			assert.throws(function() {
				fnComponentClass.extend("new.Component", {});
			}, new Error("Extending Components created by Manifest is not supported!"), "Extend should raise an exception");

			var oComponent = new fnComponentClass();

			assert.ok(oComponent.getMetadata() instanceof sap.ui.core.UIComponentMetadata, "The metadata is instance of UIComponentMetadata");
			assert.ok(oComponent.getManifest(), "Manifest is available");
			assert.deepEqual(oComponent.getManifest(), oManifest, "Manifest matches the manifest behind manifestUrl");

			var sAcceptLanguage = oServer.requests && oServer.requests[0] && oServer.requests[0].requestHeaders && oServer.requests[0].requestHeaders["Accept-Language"];
			assert.equal(sAcceptLanguage, "en", "Manifest was requested with proper language");

			done();

		});

	});

	QUnit.test("load component callback", function(assert) {
		var done = assert.async();

		var oAsyncHints = {
			libs: ["sap.ui.core"],
			requests: [{ name: "sap.ui.fl.changes", reference: "componentName" }]
		};

		// install a manifest load callback hook
		sap.ui.core.Component._fnLoadComponentCallback = function(oConfig) {
			assert.ok(true, "sap.ui.core.Component._fnLoadComponentCallback called!");
			// assert deep equals instead of equals due to a jQuery.extend(true, {}, oConfig)
			assert.deepEqual(oConfig.asyncHints, oAsyncHints, "sap.ui.core.Component._fnLoadComponentCallback oConfig passed!");
			done();
		};

		// start test
		sap.ui.component({
			manifestUrl : "./testdata/components/async/manifestcomp/manifest.json",
			async: true,
			asyncHints: oAsyncHints
		});
	});


	</script>
	</head>
	<body><h1 id="qunit-header">QUnit tests: Components</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<ol id="qunit-tests"></ol>
		<br>
		<div id="comparea1"></div>
		<div id="comparea2"></div>
	</body>
</html>
