<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>QUnit Page for sap.ui.test.matchers.LabelFor</title>

    <script
            src="../../../../../../../resources/sap-ui-core.js"
            data-sap-ui-libs="sap.m">
    </script>
    <script src="../../_includeQUnit.js"></script>

    <script>
        jQuery.sap.require("sap.ui.qunit.qunit-junit");
        jQuery.sap.require("sap.ui.qunit.qunit-coverage");
        jQuery.sap.require("sap.ui.thirdparty.sinon");
        jQuery.sap.require("sap.ui.thirdparty.sinon-qunit");

        QUnit.config.autostart = false;

        sap.ui.require([
            "sap/ui/test/matchers/LabelFor",
            "sap/m/Input",
            "sap/m/Label",
            "sap/m/Button",
            "sap/ui/model/resource/ResourceModel",
            "sap/m/App",
            "sap/m/Page",
            "sap/ui/layout/form/SimpleForm"
        ], function (LabelFor, Input, Label, Button, ResourceModel, App, Page, SimpleForm) {

            QUnit.module("LabelFor", {
                beforeEach: function () {
                    var sInputId = "first_name";
                    this.oInput = new Input({id: sInputId});
                    this.oLabel = new Label({id: "name_label" ,text: "First name", labelFor: this.oInput});
                    this.oModel = new ResourceModel({ bundleUrl: "./I18NText.properties" });

                    this.oLabelWithNoInput = new Label({id: "no_input", text: "No input", labelFor: {}});
                    this.oInvisibleLabel = new Label({
                        id: "invisible_label",
                        text: "I am invisible",
                        labelFor: this.oInput,
                        visible: false
                    });

                    this.oLabeli18n = new Label({id: "i18n_label", text: "{i18n>labelText}", labelFor: this.oInput});

                    this.oFormInput = new Input({id: "form_input"});
                    this.oForm = new SimpleForm({
                        id: "form",
                        content:
                        [
                            new Label({id: "form_label", text: "form input", labelFor: this.oFormInput}),
                            this.oFormInput

                        ]
                    });

                    this.oButton = new Button({id: "button", text: "Button"});
                    this.oLabelForButton = new Label({
                        id: "label_for_button",
                        text: "Label for button",
                        labelFor: this.oButton});

                    this.oApp = new App().addPage(new Page({
                        title: "LabelFor matcher",
                        content: [
                            this.oLabel,
                            this.oInput,
                            this.oLabelWithNoInput,
                            this.oInvisibleLabel,
                            this.oLabeli18n,
                            this.oForm,
                            this.oButton,
                            this.oLabelForButton
                        ]
                    })).setModel(this.oModel, "i18n").placeAt("qunit-fixture");

                    sap.ui.getCore().applyChanges();
                },
                afterEach: function () {
                    this.oApp.destroy();
                }
            });

            QUnit.test("Should match input labeled with given text", function(assert) {
                var oMatcher = new LabelFor({text: "First name"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(bResult, "Matches with the given text");
            });

            QUnit.test("Shouldn't match input labeled with given text", function(assert) {
                var oMatcher = new LabelFor({text: "Last name"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(!bResult, "Did not match with given text");
            });

            QUnit.test("Should match input labeled with given key", function(assert) {
                var oMatcher = new LabelFor({key: "labelText"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(bResult, "Matches with given key");
            });

            QUnit.test("Should not match input labeled with given key", function(assert) {
                var oMatcher = new LabelFor({key: "noKey"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(!bResult, "Did not match with given key");
            });

            QUnit.test("Should match input labeled with given key and model name", function(assert) {
                var oMatcher = new LabelFor({key: "labelText", modelName: "i18n"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(bResult, "Matches with given key and model name");
            });

            QUnit.test("Should not match input labeled with given key and model name", function(assert) {
                var oMatcher = new LabelFor({key: "fooLabel", modelName: "notExistingModel"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(!bResult, "Did not match with given key and model name");
            });

            QUnit.test("Should fail because of combination of key and text", function(assert) {
                assert.throws(function () {
                    new LabelFor({key: "fooLabel", text: "label"}).isMatching(this.oInput);
                }, new Error("Combination of text and key properties is not possible"), 'Throws error.');
            });

            QUnit.test("Should fail because of no key and no label text", function(assert) {
                assert.throws(function() {
                    new LabelFor().isMatching(this.oInput);
                }, new Error("No label text or key found"), "Throws error");
            });

            QUnit.test("Should not match label with given text but no input for it", function(assert) {
                var oMatcher = new LabelFor({text: "No input"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(!bResult, "Did not match labeled input");
            });

            QUnit.test("Should not match invisible label", function (assert) {
                var oMatcher = new LabelFor({text: "I am invisible"});
                var bResult = oMatcher.isMatching(this.oInput);
                assert.ok(bResult, "Did not Match invisible label");
            });

            QUnit.test("Should not match with given text", function(assert) {
                var sLabelText = "foo";
                var oMatcher = new LabelFor({text: sLabelText});
                var oDebugSpy = this.spy(oMatcher._oLogger, "debug");

                var bResult = oMatcher.isMatching(this.oInput);

                assert.ok(!bResult, "Did not match");
                sinon.assert.calledWith(oDebugSpy, "No label with text: " + sLabelText + " for control: " + this.oInput);
                sinon.assert.calledOnce(oDebugSpy);
            });

            QUnit.test("Should not match with given key", function(assert) {
                var sKey = "foo";
                var oMatcher = new LabelFor({key: sKey});
                var oDebugSpy = this.spy(oMatcher._oLogger, "debug");

                var bResult = oMatcher.isMatching(this.oInput);

                assert.ok(!bResult, "Did not match");
                sinon.assert.calledWith(oDebugSpy, "No label with key: " + sKey + " for control: " + this.oInput);
            });

            QUnit.test("Should match input in form by given label text", function(assert) {
                var oMatcher = new LabelFor({text: "form input"});
                var bResult = oMatcher.isMatching(this.oFormInput);
                assert.ok(bResult, "Match input in form");
            })

            QUnit.test("Should match button associated with label", function(assert) {
                var oMatcher = new LabelFor({text: "Label for button"});
                var bResult = oMatcher.isMatching(this.oButton);
                assert.ok(bResult, "Match button");
            });

            QUnit.start();

        });

    </script>
</head>

<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>
</body>

</html>
