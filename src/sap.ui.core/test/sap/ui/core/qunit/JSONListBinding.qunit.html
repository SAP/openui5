<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">

<!-- Initialization -->
<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-language="en_US">
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>

<!-- Test functions -->
<script language="javascript" charset="utf-8"> // IE needs this :-/

	var oModel;
	var testData;
	var bindings;

	function setup(){
		// reset bindings
		bindings = new Array();
		testData = {
			teamMembers:[
				{firstName:"Andreas", lastName:"Klark", gender:"male"},
				{firstName:"Peter", lastName:"Miller", gender:"male"},
				{firstName:"Gina", lastName:"Rush", gender:"female"},
				{firstName:"Steave", lastName:"Ander", gender:"male"},
				{firstName:"Michael", lastName:"Spring", gender:"male"},
				{firstName:"Marc", lastName:"Green", gender:"male"},
				{firstName:"Frank", lastName:"Wallace", gender: null}
			],
			teamMembersNew:[
				{firstName:"Andreas", lastName:"Klark", gender:"male"},
				{firstName:"Gina", lastName:"Rush", gender:"female"},
				{firstName:"Steave", lastName:"Ander", gender:"male"},
				{firstName:"Michael", lastName:"Grey", gender:"male"},
				{firstName:"Michael", lastName:"Spring", gender:"male"},
				{firstName:"Marc", lastName:"Green", gender:"male"},
				{firstName:"Peter", lastName:"Franklin", gender:"male"}
			],
			filterData:[
				{form:"Original", string:"ẛ̣", representation:"\\u1E9B\\u0323"},
				{form:"NFC", string:"ẛ̣", representation:"\\u1E9B\\u0323"},
				{form:"NFD", string:"ẛ̣", representation:"\\u017F\\u0323\\u0307"},
				{form:"NFKC", string:"ṩ", representation:"\\u1E69"},
				{form:"NFKD", string:"ṩ", representation:"\\u0073\\u0323\\u0307"},
			],
			sortData:[
				{word: "Fuß"},
				{word: "Füssen"},
				{word: "Füße"},
				{word: "Fußball"},
				{word: "Fussel"},
				{word: "Funzel"}
			],
			"root":[
				{
					"name": "item1",
					"nodes": [
						{
							"name": "subitem1",
							"nodes": [
								{ "name": "subsubitem1" },
								{ "name": "subsubitem2" }
							]
						},
						{
							"name": "subitem2",
							"collapsed": true,
							"nodes": [
								{ "name": "subsubitem3" }
							]
						}
					]
				},
				{
					"name": "item2",
					"nodes": [
						{ "name": "subitem3" }
					]
				}
			],
			map : {
				first : {lastName : "Dente", name : "Al", checked : true, linkText : "www.sap.com", href : "http://www.sap.com", rating : 4},
				second : {lastName : "Friese", name : "Andy", checked : true, linkText : "www.spiegel.de", href : "http://www.spiegel.de", rating : 2},
				third : {lastName : "Mann", name : "Anita", checked : false, linkText : "www.kicker.de", href : "http://www.kicker.de", rating : 3}
			}
		};
		oModel = new sap.ui.model.json.JSONModel();
		oModel.setData(testData);
		sap.ui.getCore().setModel(oModel);

	};

	function createListBinding(sPath, oContext){
		// create binding
		bindings = new Array();
		if (typeof sPath === "object") {
			bindings[0] = oModel.bindList(sPath.path, sPath.context, sPath.sorters, sPath.filters, sPath.parameters, sPath.events);
		} else {
			bindings[0] = oModel.bindList(sPath, oContext);
		}
	};

	function callBackOnChange(){
		ok(true,"ChangeEvent fired");
	};

	module("Listbinding getContexts", {
		beforeEach: function() {
			setup();
			createListBinding("/teamMembers", "");
		}
	});

	test("method", function(){
		equal(bindings.length, 1, "amount of ListBindings");
		var listBinding = bindings[0];
		equal(listBinding.getPath(), "/teamMembers", "ListBinding path");
		equal(listBinding.getModel(), oModel, "ListBinding model");
		equal(listBinding.getLength(), 7, "ListBinding getLength");
		equal(listBinding.isLengthFinal(), true, "ListBinding isLengthFinal");

		jQuery(listBinding.getContexts()).each(function(i, context){
			equal(context.getPath(), "/teamMembers/" + i, "ListBinding context");
		});

	});

	test("wrong path", function(){
		createListBinding("/xyz", "");
		ok(bindings);
		equal(bindings.length, 1, "amount of ListBindings");
		var listBinding = bindings[0];
		ok(listBinding);
		equal(listBinding.getPath(), "/xyz", "ListBinding path");
		equal(listBinding.getModel(), oModel, "ListBinding model");
		equal(listBinding.getContexts().length, 0, "ListBinding get Contexts with wrong path");
	});

	test("wrong path and checkUpdate", function(){
		createListBinding("teamMembers", "");

		equal(bindings.length, 1, "amount of ListBindings");
		var listBinding = bindings[0];
		equal(listBinding.getPath(), "teamMembers", "ListBinding path");
		equal(listBinding.getModel(), oModel, "ListBinding model");

		listBinding.getModel().createBindingContext("/xyz",null, function(oContext){
			listBinding.setContext(oContext);
			listBinding.checkUpdate();
			equal(listBinding.getPath(), "teamMembers", "ListBinding path");
			ok(listBinding.getContext() == oContext, "ListBinding context");
			equal(listBinding.getContexts().length, 0, "ListBinding contexts");
		});
	});

	test("getCurrentContexts", function(){
		var listBinding = bindings[0],
			contexts = listBinding.getContexts(0,5),
			currentContexts = listBinding.getCurrentContexts();

		equal(currentContexts.length, 5, "Current contexts should contain 5 items");
		jQuery(currentContexts).each(function(i, context){
			equal(context.getPath(), "/teamMembers/" + i, "ListBinding context");
		});
	});

	test("extended change detection", function(){
		var listBinding = bindings[0];
		listBinding.enableExtendedChangeDetection();

		var	contexts = listBinding.getContexts(0,5),
			currentContexts = listBinding.getCurrentContexts();

		equal(currentContexts.length, 5, "Current contexts should contain 5 items");
		jQuery(currentContexts).each(function(i, context){
			equal(context.getPath(), "/teamMembers/" + i, "ListBinding context");
		});

		testData.teamMembers[4].gender = "female";
		listBinding.checkUpdate();

		currentContexts = listBinding.getCurrentContexts();
		equal(currentContexts.length, 5, "Current contexts should contain 5 items");
		jQuery(currentContexts).each(function(i, context){
			equal(context.getPath(), "/teamMembers/" + i, "ListBinding context");
		});

		contexts = listBinding.getContexts(0,5);
		equal(contexts.diff.length, 2, "Delta information is available");
	});

	module("Listbinding refresh", {
		beforeEach: function() {
			setup();
			createListBinding("/teamMembers", "");
			this.oBinding = oModel.bindList("/teamMembers");
			this.oBinding.initialize();
		},
		afterEach: function() {
			this.oBinding.destroy();
		}
	});

	test("method", 3, function() {
		equal(this.oBinding.getLength(), 7, "ListBinding returns correct length");
		this.oBinding.attachChange(function() {
			ok(true, "ListBinding fires change event when changed");
		});
		testData.teamMembers.push({firstName:"Jonas", lastName:"Janus", gender:"male"});
		this.oBinding.refresh();
		equal(this.oBinding.getLength(), 8, "ListBinding returns changed length");
	});

	test("getContexts", 1, function() {
		var aContexts = this.oBinding.getContexts(0,5);
		equal(aContexts.length, 5, "ListBinding returns correct amount of contexts");
		this.oBinding.attachChange(function() {
			ok(false, "ListBinding fires no change event, as changed data is outside visible range");
		});
		testData.teamMembers[6].firstName = "Jonas";
		this.oBinding.refresh();
	});

	test("extended change detection and getContexts", 1, function() {
		this.oBinding.enableExtendedChangeDetection();
		var aContexts = this.oBinding.getContexts(0,5);
		equal(aContexts.length, 5, "ListBinding returns correct amount of contexts");
		this.oBinding.attachChange(function() {
			ok(false, "ListBinding fires no change event, as changed data is outside visible range");
		});
		testData.teamMembers[6].firstName = "Jonas";
		this.oBinding.refresh();
	});

	test("getContexts und length change", 3, function() {
		var aContexts = this.oBinding.getContexts(0,5);
		equal(aContexts.length, 5, "ListBinding returns correct amount of contexts");
		this.oBinding.attachChange(function() {
			ok(true, "ListBinding fires change event, as length has changed");
		});
		testData.teamMembers.push({firstName:"Jonas", lastName:"Janus", gender:"male"});
		this.oBinding.refresh();
		equal(this.oBinding.getLength(), 8, "ListBinding returns changed length");
	});

	test("extended change detection, getContexts und length change", 3, function() {
		this.oBinding.enableExtendedChangeDetection();
		var aContexts = this.oBinding.getContexts(0,5);
		equal(aContexts.length, 5, "ListBinding returns correct amount of contexts");
		this.oBinding.attachChange(function() {
			ok(true, "ListBinding fires change event, as length has changed");
		});
		testData.teamMembers.push({firstName:"Jonas", lastName:"Janus", gender:"male"});
		this.oBinding.refresh();
		equal(this.oBinding.getLength(), 8, "ListBinding returns changed length");
	});

	module("Listbinding sort", {
		beforeEach: function() {
			setup();
		}
	});

	// should also work with other ListBinding implementations
	test("method", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];

		equal(listBinding.oList[0].firstName, "Andreas", "ListBinding before sort");
		equal(listBinding.oList[1].firstName, "Peter", "ListBinding before sort");
		equal(listBinding.oList[2].firstName, "Gina", "ListBinding before sort");
		equal(listBinding.oList[3].firstName, "Steave", "ListBinding before sort");
		equal(listBinding.oList[4].firstName, "Michael", "ListBinding before sort");
		equal(listBinding.oList[5].firstName, "Marc", "ListBinding before sort");
		equal(listBinding.oList[6].firstName, "Frank", "ListBinding before sort");

		var oSorter = new sap.ui.model.Sorter("firstName", false);
		listBinding.sort(oSorter);

		var sortedContexts = listBinding.getContexts();
		var sorted = [];
		jQuery(sortedContexts).each(function(i, oContext){
			sorted[i] = oContext.getProperty("firstName");
		});

		equal(sorted[0], "Andreas", "ListBinding after sort");
		equal(sorted[1], "Frank", "ListBinding after sort");
		equal(sorted[2], "Gina", "ListBinding after sort");
		equal(sorted[3], "Marc", "ListBinding after sort");
		equal(sorted[4], "Michael", "ListBinding after sort");
		equal(sorted[5], "Peter", "ListBinding after sort");
		equal(sorted[6], "Steave", "ListBinding after sort");

		//descending
		oSorter = new sap.ui.model.Sorter("firstName", true);
		listBinding.sort(oSorter);

		sortedContexts = listBinding.getContexts();
		jQuery(sortedContexts).each(function(i, oContext){
			sorted[i] = oContext.getProperty("firstName");
		});

		equal(sorted[0], "Steave", "ListBinding after sort");
		equal(sorted[1], "Peter", "ListBinding after sort");
		equal(sorted[2], "Michael", "ListBinding after sort");
		equal(sorted[3], "Marc", "ListBinding after sort");
		equal(sorted[4], "Gina", "ListBinding after sort");
		equal(sorted[5], "Frank", "ListBinding after sort");
		equal(sorted[6], "Andreas", "ListBinding after sort");

	});

	test("invalid binding", function(){
		createListBinding("/unknown");

		var listBinding = bindings[0];
		listBinding.sort();
		expect(0);
	});

	// should also work with other ListBinding implementations
	test("locale sort", function(){
		createListBinding("/sortData");

		var listBinding = bindings[0];

		var oSorter = new sap.ui.model.Sorter("word", false);
		listBinding.sort(oSorter);

		var sortedContexts = listBinding.getContexts();
		var sorted = [];
		jQuery(sortedContexts).each(function(i, context){
			sorted[i] = oModel.getProperty("word", context);
		});

		equal(sorted[0], "Funzel", "ListBinding after sort");
		equal(sorted[1], "Fuß", "ListBinding after sort");
		equal(sorted[2], "Fußball", "ListBinding after sort");
		// browsers have differnt ideas about lexical sorting
		if (sap.ui.Device.browser.chrome && sap.ui.Device.browser.version < 24.0) {
			equal(sorted[3], "Fussel", "ListBinding after sort");
			equal(sorted[4], "Füße", "ListBinding after sort");
		}
		else {
			equal(sorted[3], "Füße", "ListBinding after sort");
			equal(sorted[4], "Fussel", "ListBinding after sort");
		}
		equal(sorted[5], "Füssen", "ListBinding after sort");

	});

	test("multi sort", function(){
		createListBinding("/teamMembersNew");

		var listBinding = bindings[0];

		var oSorter = [
			new sap.ui.model.Sorter("firstName", false),
			new sap.ui.model.Sorter("lastName", false)
		];
		listBinding.sort(oSorter);

		var sortedContexts = listBinding.getContexts();
		var sortedFirstName = [];
		var sortedLastName = [];
		jQuery(sortedContexts).each(function(i, context){
			sortedFirstName[i] = oModel.getProperty("firstName", context);
			sortedLastName[i] = oModel.getProperty("lastName", context);
		});

		equal(sortedFirstName[0], "Andreas", "ListBinding after multi sort");
		equal(sortedLastName[0], "Klark", "ListBinding after multi sort");
		equal(sortedFirstName[1], "Gina", "ListBinding after multi sort");
		equal(sortedLastName[1], "Rush", "ListBinding after multi sort");
		equal(sortedFirstName[2], "Marc", "ListBinding after multi sort");
		equal(sortedLastName[2], "Green", "ListBinding after multi sort");
		equal(sortedFirstName[3], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[3], "Grey", "ListBinding after multi sort");
		equal(sortedFirstName[4], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[4], "Spring", "ListBinding after multi sort");
		equal(sortedFirstName[5], "Peter", "ListBinding after multi sort");
		equal(sortedLastName[5], "Franklin", "ListBinding after multi sort");
		equal(sortedFirstName[6], "Steave", "ListBinding after multi sort");
		equal(sortedLastName[6], "Ander", "ListBinding after multi sort");

		oSorter = [
			new sap.ui.model.Sorter("firstName", false),
			new sap.ui.model.Sorter("lastName", true)
		];
		listBinding.sort(oSorter);

		sortedContexts = listBinding.getContexts();
		sortedFirstName = [];
		sortedLastName = [];
		jQuery(sortedContexts).each(function(i, context){
			sortedFirstName[i] = oModel.getProperty("firstName", context);
			sortedLastName[i] = oModel.getProperty("lastName", context);
		});

		equal(sortedFirstName[0], "Andreas", "ListBinding after multi sort");
		equal(sortedLastName[0], "Klark", "ListBinding after multi sort");
		equal(sortedFirstName[1], "Gina", "ListBinding after multi sort");
		equal(sortedLastName[1], "Rush", "ListBinding after multi sort");
		equal(sortedFirstName[2], "Marc", "ListBinding after multi sort");
		equal(sortedLastName[2], "Green", "ListBinding after multi sort");
		equal(sortedFirstName[3], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[3], "Spring", "ListBinding after multi sort");
		equal(sortedFirstName[4], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[4], "Grey", "ListBinding after multi sort");
		equal(sortedFirstName[5], "Peter", "ListBinding after multi sort");
		equal(sortedLastName[5], "Franklin", "ListBinding after multi sort");
		equal(sortedFirstName[6], "Steave", "ListBinding after multi sort");
		equal(sortedLastName[6], "Ander", "ListBinding after multi sort");

		oSorter = [
			new sap.ui.model.Sorter("firstName", true),
			new sap.ui.model.Sorter("lastName", false)
		];
		listBinding.sort(oSorter);

		sortedContexts = listBinding.getContexts();
		sortedFirstName = [];
		sortedLastName = [];
		jQuery(sortedContexts).each(function(i, context){
			sortedFirstName[i] = oModel.getProperty("firstName", context);
			sortedLastName[i] = oModel.getProperty("lastName", context);
		});

		equal(sortedFirstName[0], "Steave", "ListBinding after multi sort");
		equal(sortedLastName[0], "Ander", "ListBinding after multi sort");
		equal(sortedFirstName[1], "Peter", "ListBinding after multi sort");
		equal(sortedLastName[1], "Franklin", "ListBinding after multi sort");
		equal(sortedFirstName[2], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[2], "Grey", "ListBinding after multi sort");
		equal(sortedFirstName[3], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[3], "Spring", "ListBinding after multi sort");
		equal(sortedFirstName[4], "Marc", "ListBinding after multi sort");
		equal(sortedLastName[4], "Green", "ListBinding after multi sort");
		equal(sortedFirstName[5], "Gina", "ListBinding after multi sort");
		equal(sortedLastName[5], "Rush", "ListBinding after multi sort");
		equal(sortedFirstName[6], "Andreas", "ListBinding after multi sort");
		equal(sortedLastName[6], "Klark", "ListBinding after multi sort");

		oSorter = [
			new sap.ui.model.Sorter("gender", false),
			new sap.ui.model.Sorter("firstName", true),
			new sap.ui.model.Sorter("lastName", true)
		];
		listBinding.sort(oSorter);

		sortedContexts = listBinding.getContexts();
		sortedFirstName = [];
		sortedLastName = [];
		jQuery(sortedContexts).each(function(i, context){
			sortedFirstName[i] = oModel.getProperty("firstName", context);
			sortedLastName[i] = oModel.getProperty("lastName", context);
		});

		equal(sortedFirstName[0], "Gina", "ListBinding after multi sort");
		equal(sortedLastName[0], "Rush", "ListBinding after multi sort");
		equal(sortedFirstName[1], "Steave", "ListBinding after multi sort");
		equal(sortedLastName[1], "Ander", "ListBinding after multi sort");
		equal(sortedFirstName[2], "Peter", "ListBinding after multi sort");
		equal(sortedLastName[2], "Franklin", "ListBinding after multi sort");
		equal(sortedFirstName[3], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[3], "Spring", "ListBinding after multi sort");
		equal(sortedFirstName[4], "Michael", "ListBinding after multi sort");
		equal(sortedLastName[4], "Grey", "ListBinding after multi sort");
		equal(sortedFirstName[5], "Marc", "ListBinding after multi sort");
		equal(sortedLastName[5], "Green", "ListBinding after multi sort");
		equal(sortedFirstName[6], "Andreas", "ListBinding after multi sort");
		equal(sortedLastName[6], "Klark", "ListBinding after multi sort");
	});

	// test for custom compare function
	test("custom sort", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];
		var oSorter = new sap.ui.model.Sorter("firstName", false, false, function(a, b) {
			a = a.substr(1);
			b = b.substr(1);
			if (a < b) {
				return -1;
			}
			if (a > b) {
				return 1;
			}
			return 0;
		});
		listBinding.sort(oSorter);

		var sortedContexts = listBinding.getContexts();
		var sorted = [];
		jQuery(sortedContexts).each(function(i, context){
			sorted[i] = oModel.getProperty("firstName",context);
		});

		equal(sorted[0], "Marc", "ListBinding after sort");
		equal(sorted[1], "Peter", "ListBinding after sort");
		equal(sorted[2], "Michael", "ListBinding after sort");
		equal(sorted[3], "Gina", "ListBinding after sort");
		equal(sorted[4], "Andreas", "ListBinding after sort");
		equal(sorted[5], "Frank", "ListBinding after sort");
		equal(sorted[6], "Steave", "ListBinding after sort");
	});

	test("change event test", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];
		var attach = false;
		listBinding.attachChange(myFnCallback);

		var oSorter = new sap.ui.model.Sorter("firstName", true);
		listBinding.sort(oSorter, true);

		function myFnCallback(oEvent){
			var sReason = oEvent.getParameter('reason');
			if (sReason === "sort"){
				attach = true;
			}
		};

		listBinding.detachChange(myFnCallback);

		ok(attach, "change event fired with sorter");
	});

	module("Listbinding filter", {
		beforeEach: function() {
			setup();
			createListBinding("/teamMembers", "");
		}
	});

	test("method", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];

		//check EQ
		var oFilter = new sap.ui.model.Filter("gender", sap.ui.model.FilterOperator.EQ, null);
		listBinding.filter([oFilter]);
		var filteredContexts = listBinding.getContexts();
		var filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 1, "ListBinding filtered length");
		equal(filtered[0].gender, null, "ListBinding filter value");

		// NE, contains
		oFilter = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.NE, "Peter");
		var oFilter2 = new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.Contains, "a");
		listBinding.filter([oFilter, oFilter2]);
		filteredContexts = listBinding.getContexts();
		filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 3, "ListBinding filtered length");
		equal(filtered[0].firstName, "Andreas", "ListBinding filter value");
		equal(filtered[1].firstName, "Steave", "ListBinding filter value");
		equal(filtered[2].firstName, "Frank", "ListBinding filter value");

		// between
		oFilter = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.BT, "A","G");
		listBinding.filter([oFilter]);
		filteredContexts = listBinding.getContexts();
		filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 2, "ListBinding filtered length");
		equal(filtered[0].firstName, "Andreas", "ListBinding filter value");
		equal(filtered[1].firstName, "Frank", "ListBinding filter value");

		// startsWith, endsWith
		oFilter = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.StartsWith, "M");
		oFilter2 = new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.EndsWith, "n");
		listBinding.filter([oFilter, oFilter2]);
		filteredContexts = listBinding.getContexts();
		filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 1, "ListBinding filtered length");
		equal(filtered[0].firstName, "Marc", "ListBinding filter value");

	});

	test("invalid binding", function(){
		createListBinding("/unknown");

		var listBinding = bindings[0];
		listBinding.filter([]);
		expect(0);
	});

	test("without array", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];

		//check EQ
		var oFilter = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.EQ, "Peter");
		listBinding.filter(oFilter);
		var filteredContexts = listBinding.getContexts();
		var filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 1, "ListBinding filtered length");
		equal(filtered[0].firstName, "Peter", "ListBinding filter value");

		// between
		oFilter = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.BT, "A","G");
		listBinding.filter(oFilter);
		filteredContexts = listBinding.getContexts();
		filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 2, "ListBinding filtered length");
		equal(filtered[0].firstName, "Andreas", "ListBinding filter value");
		equal(filtered[1].firstName, "Frank", "ListBinding filter value");

	});

	test("complex filters", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];

		//check OR
		var oFilter1 = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.EQ, "Peter");
		var oFilter2 = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.EQ, "Frank");
		listBinding.filter([oFilter1, oFilter2]);
		var filteredContexts = listBinding.getContexts();
		var filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 2, "ListBinding filtered length");
		equal(filtered[0].firstName, "Peter", "ListBinding filter value");
		equal(filtered[1].firstName, "Frank", "ListBinding filter value");

		//check OR & AND
		var oFilter3 = new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.EQ, "Wallace");
		var oFilter4 = new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.EQ, "Rush");
		listBinding.filter([oFilter1, oFilter2, oFilter3, oFilter4]);
		var filteredContexts = listBinding.getContexts();
		var filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 1, "ListBinding filtered length");
		equal(filtered[0].firstName, "Frank", "ListBinding filter value");

	});

	test("multi filters", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];

		//check (gender != female AND (lastName = Green OR (firstName = Peter OR firstName = Frank OR firstName = Gina)))
		var oFilter1 = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.EQ, "Peter");
		var oFilter2 = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.EQ, "Frank");
		var oFilter3 = new sap.ui.model.Filter("firstName", sap.ui.model.FilterOperator.EQ, "Gina");
		var oMultiFilter1 = new sap.ui.model.Filter([oFilter1, oFilter2, oFilter3], false);
		var oFilter4 = new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.EQ, "Green");
		var oMultiFilter2 = new sap.ui.model.Filter([oMultiFilter1, oFilter4], false);
		var oFilter5 = new sap.ui.model.Filter("gender", sap.ui.model.FilterOperator.NE, "female");
		var oMultiFilter3 = new sap.ui.model.Filter([oMultiFilter2, oFilter5], true);
		listBinding.filter(oMultiFilter3);
		var filteredContexts = listBinding.getContexts();
		var filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 3, "ListBinding filtered length");
		equal(filtered[0].firstName, "Peter", "ListBinding filter value");
		equal(filtered[1].firstName, "Marc", "ListBinding filter value");
		equal(filtered[2].firstName, "Frank", "ListBinding filter value");

	});

	test("test function", function() {
		createListBinding("/teamMembers");

		var listBinding = bindings[0];

		var oFilter = new sap.ui.model.Filter("firstName", function(sValue) {
			return (sValue.indexOf("A") !== -1 && sValue.indexOf("G") === 0);
		});

		listBinding.filter(oFilter);
		var filteredContexts = listBinding.getContexts();
		var filtered = [];
		jQuery(filteredContexts).each(function(i, context){
			filtered[i] = oModel.getProperty(context.getPath());
		});
		equal(filtered.length, 1, "ListBinding filtered length");
		equal(filtered[0].firstName, "Gina", "ListBinding filter value");
	});

	test("change event", function(){
		createListBinding("/teamMembers");

		var listBinding = bindings[0];
		var attach = false;
		listBinding.attachChange(myFnCallback);

		var oFilter = new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.EQ, "Wallace");
		var oFilter2 = new sap.ui.model.Filter("lastName", sap.ui.model.FilterOperator.EQ, "Rush");
		listBinding.filter([oFilter, oFilter2]);

		function myFnCallback(oEvent){
			var sReason = oEvent.getParameter("reason");
			if (sReason === "filter"){
				attach = true;
			}
		};

		listBinding.detachChange(myFnCallback);

		ok(attach, "change event fired with filter");
	});

	// only relevant for browsers supporting this
	if (String.prototype.normalize) {
		test("normalization", function() {
			createListBinding("/filterData");

			var mFilters = {}, listBinding = bindings[0];

			mFilters["NFC"] = new sap.ui.model.Filter("string", sap.ui.model.FilterOperator.EQ, "\u1E9B\u0323");
			mFilters["NFD"] = new sap.ui.model.Filter("string", sap.ui.model.FilterOperator.EQ, "\u017F\u0323\u0307");
			// "NFKC" and "NFKD" are not supported for filter

			function fnTest(sProp, sVal) {
				listBinding.filter(sVal);
				var filteredContexts = listBinding.getContexts();
				var filtered = [];
				jQuery(filteredContexts).each(function(i, context){
					filtered[i] = oModel.getProperty(context.getPath());
				});
				equal(filtered.length, 3, "Filter working for " + sProp);
			}

			jQuery.each(mFilters, fnTest);
		});
	}

	module("Listbinding general", {
		beforeEach: function() {
			setup();
		}
	});

	test("with map, not array", function(){
		var aKeysInMap = ["first", "second", "third"];
		createListBinding("/map");

		equal(bindings.length, 1, "amount of ListBindings");
		var listBinding = bindings[0];
		equal(listBinding.getPath(), "/map", "ListBinding path");
		equal(listBinding.getModel(), oModel, "ListBinding model");
		equal(listBinding.getLength(), 3, "ListBinding getLength");
		equal(listBinding.isLengthFinal(), true, "ListBinding isLengthFinal");

		jQuery(listBinding.getContexts()).each(function(i, context){
			equal(context.getPath(), "/map/" + aKeysInMap[i], "ListBinding context");
		});

	});

	test("nested array structure", function(){
		createListBinding("/root");
		var binding = bindings[0];
		var contexts = binding.getContexts();
		ok(jQuery.isArray(contexts));
		equal(contexts.length, 2);
		equal(oModel.getProperty("name",contexts[0]), "item1");
		equal(oModel.getProperty("nodes",contexts[0]).length, 2);
		equal(oModel.getProperty("/root/0/nodes/0/nodes/1").name, "subsubitem2");
		ok(oModel.getProperty("/root/0/nodes/1").collapsed);
		equal(oModel.getProperty("name",contexts[1]), "item2");
		equal(oModel.getProperty("nodes",contexts[1]).length, 1);
		equal(oModel.getProperty("nodes/0",contexts[1]).name, "subitem3");
	});

	test("nested array structure", function(){
		bindings[0] = oModel.bindList("/root");
		bindings[1] = oModel.bindList("/root/0/nodes");
		bindings[2] = oModel.bindList("/root/1/nodes");

		var binding = bindings[1];
		var contexts = binding.getContexts();
		ok(jQuery.isArray(contexts));
		equal(contexts.length, 2);
		equal(oModel.getProperty("name",contexts[0]), "subitem1");
		equal(oModel.getProperty("name",contexts[1]), "subitem2");

		binding = bindings[2];
		contexts = binding.getContexts();
		equal(contexts.length, 1);
		equal(oModel.getProperty("name", contexts[0]), "subitem3");

		// check if nodes from different listbindings are the same/have the same reference
		equal(oModel.getProperty("nodes/0/name", bindings[0].getContexts()[0]), "subitem1");
		equal(oModel.getProperty("name",bindings[1].getContexts()[0]), "subitem1");
		ok(jQuery.sap.equal(bindings[0].oList[0].nodes[0], bindings[1].oList[0]));

		equal(oModel.getProperty("nodes/0/name",bindings[0].getContexts()[1]), "subitem3");
		equal(oModel.getProperty("name",bindings[2].getContexts()[0]), "subitem3");
		ok(jQuery.sap.equal(bindings[0].oList[1].nodes[0], bindings[2].oList[0]));
	});

	test("getDistinctValues", function(){
		createListBinding("/teamMembers");
		var binding = bindings[0],
			distinctValues;

		distinctValues = binding.getDistinctValues("firstName");
		ok(jQuery.isArray(distinctValues), "Result is an array");
		equal(distinctValues.length, 7, "Number of distinct values");
		equal(distinctValues[0], "Andreas", "Distinct value content");
		equal(distinctValues[6], "Frank", "Distinct value content");

		distinctValues = binding.getDistinctValues("gender");
		ok(jQuery.isArray(distinctValues), "Result is an array");
		equal(distinctValues.length, 3, "Number of distinct values");
		equal(distinctValues[0], "male", "Distinct value content");
		equal(distinctValues[1], "female", "Distinct value content");
		equal(distinctValues[2], null, "Distinct value content");

	});

	test("setSizeLimit", function(){
		var aManyItems = [];
		for (var i = 0; i < 200; i++) {
			aManyItems.push(i);
		}
		var oModel = new sap.ui.model.json.JSONModel(aManyItems),
			oListBinding = oModel.bindList("/"),
			aContexts;

		aContext = oListBinding.getContexts();
		equal(aContext.length, 100, "Default size limit 100");

		oModel.setSizeLimit(150);
		aContext = oListBinding.getContexts();
		equal(aContext.length, 150, "Custom size limit 150");
	});

	test("getLength", function(){
		createListBinding("/teamMembers");

		equal(bindings.length, 1, "amount of ListBindings");
		var listBinding = bindings[0];
		equal(listBinding.getPath(), "/teamMembers", "ListBinding path");
		equal(listBinding.getModel(), oModel, "ListBinding model");

		equal(listBinding.getLength(), testData.teamMembers.length, "ListBinding length");

	});

	test("set new data with no merge and check update and getContexts test", function(){
		createListBinding("/teamMembers", "");

		equal(bindings.length, 1, "amount of ListBindings");
		var listBinding = bindings[0];
		listBinding.attachChange(fnFunc);
		function fnFunc(){
			equal(listBinding.getPath(), "/teamMembers", "ListBinding path");
			equal(listBinding.getContexts().length, 0, "ListBinding contexts length");
			equal(listBinding.getModel().oData, newData, "ListBinding model");
			equal(listBinding.getModel().getProperty("/test/0/firstName"), "Andreas", "model new property value");
			listBinding.detachChange(fnFunc);
		}
		equal(listBinding.getPath(), "/teamMembers", "ListBinding path");
		ok(listBinding.getModel() === oModel, "ListBinding model");
		// does not work...recursion because bining is set on model
		//equal(listBinding.getModel(), oModel, "ListBinding model");
		var newData = {
			test:[
				{ firstName:"Andreas", lastName:"Klark", gender:"male" }
			]
		};
		listBinding.getModel().setData(newData, false);
	});

	module("Listbinding diff calculation", {
		beforeEach: function() {
			setup();
			this.oModel = new sap.ui.model.json.JSONModel(testData.teamMembers);
			this.oListBinding = this.oModel.bindList("/");
		},
		afterEach: function() {
			this.oModel.destroy();
			this.oListBinding.destroy();
		}
	});

	test("setData delta", function() {
		this.oListBinding.enableExtendedChangeDetection();
		var aContexts = this.oListBinding.getContexts(0, 10);
		this.oModel.setData(testData.teamMembersNew);
		aContexts = this.oListBinding.getContexts(0, 10);
		deepEqual(aContexts.diff, [
			{ index : 1, type : "delete" },
			{ index : 3, type : "insert" },
			{ index : 6, type : "delete" },
			{ index : 6, type : "insert" }
		], "Replace new data");
	});

	test("setProperty delta", function() {
		this.oListBinding.enableExtendedChangeDetection();
		var aContexts = this.oListBinding.getContexts(0, 10);
		this.oModel.setProperty("/4/firstName", "Paul");
		aContexts = this.oListBinding.getContexts(0, 10);
		deepEqual(aContexts.diff, [
			{ index : 4, type : "delete" },
			{ index : 4, type : "insert" }
		], "Replace one property");
		this.oModel.setProperty("/4", {
			firstName : "Peter",
			lastName : "Johnson",
			gender : "male"
		});
		aContexts = this.oListBinding.getContexts(0, 10);
		deepEqual(aContexts.diff, [
			{ index : 4, type : "delete" },
			{ index : 4, type : "insert" }
		], "Replace whole entry");
		aContexts = this.oListBinding.getContexts(0, 10);
		deepEqual(aContexts.diff, [], "Nothing changed");
	});

	test("setProperty delta with cyclic references", function() {
		this.oListBinding.enableExtendedChangeDetection();
		var aContexts = this.oListBinding.getContexts(0, 10);
		this.oModel.setProperty("/4/firstName", new sap.ui.model.type.Date());
		aContexts = this.oListBinding.getContexts(0, 10);
		equal(aContexts.diff, undefined, "No diff for data with cyclic references");
		this.oModel.setProperty("/4/firstName", "Peter");
	});

	test("setProperty delta with key", function() {
		this.oListBinding.enableExtendedChangeDetection(false, "lastName");
		var aContexts = this.oListBinding.getContexts(0, 10);
		this.oModel.setProperty("/4/firstName", "Paul");
		aContexts = this.oListBinding.getContexts(0, 10);
		deepEqual(aContexts.diff, [], "No diff detected, as key didn't change");
		this.oModel.setProperty("/4", {
			firstName : "Peter",
			lastName : "Johnson",
			gender : "male"
		});
		aContexts = this.oListBinding.getContexts(0, 10);
		deepEqual(aContexts.diff, [
			{ index : 4, type : "delete" },
			{ index : 4, type : "insert" }
		], "Replace whole entry");
		aContexts = this.oListBinding.getContexts(0, 10);
		deepEqual(aContexts.diff, [], "Nothing changed");
	});


	module("Listbinding suspend/resume", {
		beforeEach: function() {
			setup();
			this.oData = testData.teamMembers.slice(0);
			this.oModel = new sap.ui.model.json.JSONModel(this.oData);
			this.oListBinding = this.oModel.bindList("/");
			this.oListBinding.attachChange(function() {});
		},
		afterEach: function() {
			this.oModel.destroy();
			this.oListBinding.destroy();
		}
	});

	test("suspend/resume", function() {
		var oLB = this.oListBinding;
		equal(oLB.getContexts().length, 7, "Binding has length 7 initially");
		this.oData.push({firstName:"Peter", lastName:"Franklin", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 8, "Binding has length 8 after adding an entry");
		oLB.suspend();
		this.oData.push({firstName:"Michael", lastName:"Peterson", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 8, "Binding still has length 8 as it is suspended");
		oLB.resume();
		equal(oLB.getContexts().length, 9, "Binding has length 9 after calling resume");
	});

	test("suspend/resume with filter/sort", function() {
		var oLB = this.oListBinding;
		equal(oLB.getContexts().length, 7, "Binding has length 7 initially");
		this.oData.push({firstName:"Peter", lastName:"Franklin", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 8, "Binding has length 8 after adding an entry");
		oLB.suspend();
		this.oData.push({firstName:"Michael", lastName:"Peterson", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 8, "Binding still has length 8 as it is suspended");
		oLB.sort(new sap.ui.model.Sorter("firstName"));
		equal(oLB.getContexts().length, 9, "Binding has length 9 after sorting");
		this.oData.push({firstName:"Michael", lastName:"Bubble", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 9, "Binding still has length 9 as it is suspended");
		oLB.filter([new sap.ui.model.Filter("firstName", "EQ", "Michael")]);
		equal(oLB.getContexts().length, 3, "Binding has length 3 after filtering");
		oLB.resume();
		equal(oLB.getContexts().length, 3, "Binding still has length 3 after calling resume");
	});

	test("suspend/resume with refresh", function() {
		var oLB = this.oListBinding;
		equal(oLB.getContexts().length, 7, "Binding has length 7 initially");
		this.oData.push({firstName:"Peter", lastName:"Franklin", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 8, "Binding has length 8 after adding an entry");
		oLB.suspend();
		this.oData.push({firstName:"Michael", lastName:"Peterson", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 8, "Binding still has length 8 as it is suspended");
		this.oModel.refresh(true);
		equal(oLB.getContexts().length, 9, "Binding has length 9 after force refresh");
		this.oData.push({firstName:"Michael", lastName:"Peterson", gender:"male"});
		this.oModel.refresh();
		equal(oLB.getContexts().length, 9, "Binding still has length 9 as it is suspended");
		oLB.resume();
		equal(oLB.getContexts().length, 10, "Binding still has length 10 after calling resume");
	});



	</script>

</head>
<body>
<h1 id="qunit-header">QUnit tests: JSON List Binding</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<div id="qunit-testrunner-toolbar"></div>
<ol id="qunit-tests"></ol>
</body>
</html>
