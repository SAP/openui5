<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<!-- Initialization -->
<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal"></script>

<script type="text/javascript">
	jQuery.sap.require("sap.ui.core.util.MockServer");
</script>
<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- Test functions -->
<script language="javascript">

	sinon.config.useFakeTimers = false;

	jQuery.sap.require("sap.ui.model.odata.v2.ODataModel");
	jQuery.sap.require("sap.ui.model.odata.ODataTreeBindingAdapter");
	
	//Initialize mock servers
	
	//Mock server for use with navigation properties
	var oNavPropMockServer = new sap.ui.core.util.MockServer({
		rootUri: '/navprop/'
	});
	oNavPropMockServer.simulate("../../core/qunit/model/metadata_odtb.xml", "../../core/qunit/model/odtb/");
	
	//MockServer for use with annotated tree
	var oAnnotationMockServer = new sap.ui.core.util.MockServer({
		rootUri: '/metadata/'
	});
	oAnnotationMockServer.simulate("../../core/qunit/model/metadata_odtbmd.xml", "../../core/qunit/model/odtbmd/");

	/**
	 * Clean-Up Hierarchy Annotation Mockdata/Metadata
	 * This is necessary because, the V1 ODataTreeBinding implements routines not conform to the Hierarchy Annotation Spec.
	 */
	var aAnnotationsMockdata = oAnnotationMockServer._oMockdata.GLAccountHierarchyInChartOfAccountsLiSet;
	for (var i = 0; i < aAnnotationsMockdata.length; i++) {
		//convert string based level properties (NUMC fields) to real numbers
		aAnnotationsMockdata[i].FinStatementHierarchyLevelVal = parseInt(aAnnotationsMockdata[i].FinStatementHierarchyLevelVal, 10);
	}
	
	// create a dummy AMD fdefine to check if shim works for datajs
	window.define = function() {
		throw Error("define should not be called");
	}
	window.define.amd = { vendor : "SAPUI5 QUnit Test" } ;

	var oModel, oBinding;

	function createTreeBindingAdapter(sPath, oContext, aFilters, mParameters){
		// create binding
		oBinding = oModel.bindTree(sPath, oContext, aFilters, mParameters).initialize();
		//applying the odata tree binding adapter to the binding
		sap.ui.model.odata.ODataTreeBindingAdapter.apply(oBinding);
	};

	module("ODataTreeBindingAdapter with navigation properties", {
		setup: function() {
			oNavPropMockServer.start();
			oModel = new sap.ui.model.odata.v2.ODataModel('/navprop/', { useBatch: true });
		},
		teardown: function() {
			oNavPropMockServer.stop();
			delete oModel;
		}
	});

	test("Properties", function(){
		createTreeBindingAdapter("/Employees(2)", null, [], {
			navigation: {}
		});
		equal(oBinding.getPath(), "/Employees(2)", "TreeBinding path");
		equal(oBinding.getModel(), oModel, "TreeBinding model");
		ok(oBinding instanceof sap.ui.model.odata.v2.ODataTreeBinding, "treeBinding class check");
	});

	asyncTest("getRootContexts getNodeContexts", function(){
		oModel.attachMetadataLoaded(function() {	
			createTreeBindingAdapter("/Employees(2)", null, [], {
				navigation: {
					Employees: "Employees1",
					Employees1: "Employees1"
				},
				displayRootNode: false
			});
	
			var oContext;
	
			var handler1 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 5);
	
				equal(aContexts.length, 5, "TreeBinding rootContexts length");
	
				oContext = aContexts[0];
				equal(oModel.getProperty("FirstName", oContext), "Nancy", "TreeBinding root content");
				equal(oModel.getProperty("LastName", oContext), "Davolio", "TreeBinding root content");
				
				oContext = aContexts[1];
				equal(oModel.getProperty("FirstName", oContext), "Janet", "TreeBinding root content");
				equal(oModel.getProperty("LastName", oContext), "Leverling", "TreeBinding root content");
				
				oContext = aContexts[2];
				equal(oModel.getProperty("FirstName", oContext), "Margaret", "TreeBinding root content");
				equal(oModel.getProperty("LastName", oContext), "Peacock", "TreeBinding root content");
				
				oContext = aContexts[3];
				equal(oModel.getProperty("FirstName", oContext), "Steven", "TreeBinding root content");
				equal(oModel.getProperty("LastName", oContext), "Buchanan", "TreeBinding root content");
				
				oContext = aContexts[4];
				equal(oModel.getProperty("FirstName", oContext), "Laura", "TreeBinding root content");
				equal(oModel.getProperty("LastName", oContext), "Callahan", "TreeBinding root content");
				
				oBinding.detachChange(handler1);
				
				var expandHandler = function () {
					oBinding.detachChange(expandHandler);
					oBinding.attachChange(handler2);
					oBinding.getContexts(0, 10);
				};
				oBinding.attachChange(expandHandler);
				oBinding.expand(3);
				
			};
			
			var handler2 = function(oEvent) {
				oBinding.detachChange(handler2);
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 10);
				
				var oContext = oBinding.getContextByIndex(3);
				equal(aContexts.length, 8, "TreeBinding nodeContexts length is 8");
				equal(oBinding.getChildCount(oContext), 3, "TreeBinding childcount");
				
				oContext = oBinding.getContextByIndex(4);
				equal(oModel.getProperty("FirstName", oContext), "Michael", "TreeBinding node content");
				equal(oModel.getProperty("LastName", oContext), "Suyama", "TreeBinding node content");
				
				oContext = oBinding.getContextByIndex(5);
				equal(oModel.getProperty("FirstName", oContext), "Robert", "TreeBinding node content");
				equal(oModel.getProperty("LastName", oContext), "King", "TreeBinding node content");
				
				oContext = oBinding.getContextByIndex(6);
				equal(oModel.getProperty("FirstName", oContext), "Anne", "TreeBinding node content");
				equal(oModel.getProperty("LastName", oContext), "Dodsworth", "TreeBinding node content");
				
				
				start();
			}
			
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 10);
		});
	});
	
	asyncTest("Display root node", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/Employees(2)", null, [], {
				navigation: {
					Employees: "Employees1",
					Employees1: "Employees1"
				},
				displayRootNode: true
			});
	
			var oContext;
	
			var handler1 = function(oEvent) {
				oBinding.detachChange(handler1);
				
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 10);
	
				equal(aContexts.length, 1, "# of root contexts = 1");
	
				oContext = aContexts[0];
				equal(oModel.getProperty("FirstName", oContext), "Andrew", "Root context values are correct");
				equal(oModel.getProperty("LastName", oContext), "Fuller", "Root context values are correct");
	
				function fnExpandHandler () {
					oBinding.detachChange(fnExpandHandler);
					
					//rebuild tree
					oBinding.attachChange(fnChangeHandlerAfterExpand);
					oBinding.getContexts(0, 10);
				}
				
				function fnChangeHandlerAfterExpand () {
					aContexts = oBinding.getContexts(0, 10);
					
					equal(aContexts.length, 6, "Length of returned contexts should be 6");
					
					oContext = aContexts[0];
					equal(oModel.getProperty("FirstName", oContext), "Andrew", "Root context values are correct");
					
					oContext = aContexts[1];
					equal(oModel.getProperty("FirstName", oContext), "Nancy", "[1] is correct");
					
					oContext = aContexts[2];
					equal(oModel.getProperty("FirstName", oContext), "Janet", "[2] is correct");
					
					oContext = aContexts[3];
					equal(oModel.getProperty("FirstName", oContext), "Margaret", "[3] is correct");
					
					oContext = aContexts[4];
					equal(oModel.getProperty("FirstName", oContext), "Steven", "[4] is correct");
					
					oContext = aContexts[5];
					equal(oModel.getProperty("FirstName", oContext), "Laura", "[5] is correct");
					
					start();
				}
				
				oBinding.attachChange(fnExpandHandler);
				oBinding.expand(0);
				
			};

			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 10);
		});
	});
	
	asyncTest("Number of expanded levels", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/Employees(2)", null, [], {
				navigation: {
					Employees: "Employees1",
					Employees1: "Employees1"
				},
				displayRootNode: true,
				numberOfExpandedLevels: 2
			});
			
			function fnChangeHandler1 (oEvent) {
				oBinding.detachChange(fnChangeHandler1);
				
				oBinding.attachChange(fnChangeHandler2);
				var aContexts = oBinding.getContexts(0, 10);
				
			}
			
			function fnChangeHandler2 () {
				oBinding.detachChange(fnChangeHandler2);
				
				oBinding.attachChange(fnChangeHandler3);
				var aContexts = oBinding.getContexts(0, 10);
				
			}
			
			function fnChangeHandler3 () {
				oBinding.detachChange(fnChangeHandler3);
				
				var aContexts = oBinding.getContexts(0, 10);
				
				var oContext;
				
				equal(aContexts.length, 9, "# of contexts after autoExpand = 2 should be 9");
				
				oContext = aContexts[0];
				equal(oModel.getProperty("FirstName", oContext), "Andrew", "First node is correct");
				
				//Steven should be there and expanded
				oContext = oBinding.getContextByIndex(4);
				equal(oModel.getProperty("FirstName", oContext), "Steven", "Hello Steven");
				equal(oBinding.isExpanded(4), true, "Steven is expanded");
				equal(oBinding.getChildCount(oContext), 3, "Steven has 3 children");
				
				// children of steven check
				oContext = oBinding.getContextByIndex(7);
				var oNode = oBinding.findNode(7);
				equal(oModel.getProperty("FirstName", oContext), "Anne", "Hello Anne");
				equal(oNode.level, 2, "Anne sits on level 2");
				
				// children of laura check
				oContext = oBinding.getContextByIndex(8);
				oNode = oBinding.findNode(8);
				equal(oModel.getProperty("FirstName", oContext), "Laura", "Hello Laura");
				equal(oNode.level, 1, "Laura sits on level 1");
				
				start();
			}
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 10);
		});
	});

	asyncTest("Bind to Collection", function(){
		oModel.attachMetadataLoaded(function() {	
			createTreeBindingAdapter("/Employees", null, [], {
				navigation: {
					Employees: "Employees1",
					Employees1: "Employees1"
				},
				displayRootNode: true
			});
	
			var oContext;
	
			var handler1 = function(oEvent) {
				oBinding.detachChange(handler1);
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 10);
	
				equal(aContexts.length, 9, "TreeBinding rootContexts length");
	
				oContext = aContexts[0];
				equal(oModel.getProperty("FirstName", oContext), "Nancy", "Nancy");
				
				oContext = aContexts[5];
				equal(oModel.getProperty("FirstName", oContext), "Michael", "Michael");
				
				oContext = aContexts[8];
				equal(oModel.getProperty("FirstName", oContext), "Anne", "Anne");
				
				//oContext = oBinding.getContextByIndex(1);
				
				//expand andrew
				oBinding.attachChange(handler2);
				oBinding.expand(1);
			}
			
			function handler2 () {
				oBinding.detachChange(handler2);
				oBinding.attachChange(handler3);
				var aContexts = oBinding.getContexts(0, 10);
			}
			
			function handler3 () {
				oBinding.detachChange(handler3);
				
				var aContexts = oBinding.getContexts(0, 10);
				
				equal(aContexts.length, 10, "Requested 10 results, even though more data is there");
				equal(oBinding.getLength(), 14, "Expected Binding length of 14 is correct");
				
				//check if Janet is now "visible"
				var oContextJanet1 = oBinding.getContextByIndex(3);
				equal(oModel.getProperty("FirstName", oContextJanet1), "Janet", "Janet is at position 3");
				
				//duplicate node, also Janet
				var oContextJanet2 = oBinding.getContextByIndex(7);
				equal(oModel.getProperty("FirstName", oContextJanet2), "Janet", "Janet is also at position 7");
				
				//check if the contexts are the same
				deepEqual(oContextJanet1, oContextJanet2, "Janets contexts are the same");
				
				//nodes however should have different node ids
				notEqual(oBinding.findNode(3).groupID, oBinding.findNode(7).groupID, "Janets groupIDs are different");
				
				start();
			}
	
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 10);
		});
	});

	asyncTest("Refresh", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/Employees(2)", null, [], {
				navigation: {
					Employees: "Employees1",
					Employees1: "Employees1"
				},
				
				displayRootNode: true
			});
			
			var oContext;
			
			function handler1 (oEvent) {
				oBinding.detachChange(handler1);
				
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 10);
				
				equal(aContexts.length, 1, "10 requested, only 1 returned");
				
				oBinding.attachChange(handler2);
				oBinding.expand(0); //andrew
			};
			
			function handler2 (oEvent) {
				oBinding.detachChange(handler2);
				
				oBinding.attachChange(handler3);
				oBinding.getContexts(0,10); //rebuild tree
			}
			
			function handler3 () {
				oBinding.detachChange(handler3);
				
				oBinding.getContexts(0,10); //rebuild tree
				
				equal(oBinding.oFinalLengths["/Employees(2)/Employees1"], true, "Length is final");
				
				oBinding.attachChange(handler4);
				oBinding.setSelectedIndex(4); //select steven
				oBinding.expand(4); //expand steven
			}
			
			function handler4 (oEvent) {
				oBinding.detachChange(handler4);
				
				oBinding.attachChange(handler5);
				oBinding.getContexts(0, 10);
			}
			
			function handler5 () {
				oBinding.detachChange(handler5);
				
				oBinding.getContexts(0, 10); //rebuild tree
				
				//collapse steven again
				oBinding.collapse(4);
				oBinding.getContexts(0, 10); //rebuild tree
				
				ok(oBinding._mTreeState.expanded["/Employees(2)/"], "Andrew is expanded in Expanded Map");
				ok(oBinding._mTreeState.collapsed["/Employees(2)/Employees(5)/"], "Steven is collapsed in Collapsed Map");
				ok(oBinding._mTreeState.selected["/Employees(2)/Employees(5)/"], "Steven is selected in Selected Map");
				
				equal(oBinding._iPageSize, 10, "Default page size should be 10");
				
				oBinding.attachRefresh(refreshHandler);
				oBinding.refresh();
			}
			
			var refreshHandler = function () {
				deepEqual(oBinding._mTreeState.expanded, {}, "Expanded Map is empty");
				deepEqual(oBinding._mTreeState.collapsed, {}, "Collapsed Map is empty");
				deepEqual(oBinding._mTreeState.selected, {}, "Selected Map is empty");
				
				equal(oBinding._iPageSize, 0, "Default page size reseted");
				equal(oBinding._oRootNode, undefined, "Root node is lost");
				
				deepEqual(oBinding.oKeys, {}, "Keys object has been reset");
				deepEqual(oBinding.oLengths, {}, "Lengths object has value for root");
				deepEqual(oBinding.oFinalLengths, {}, "FinalLengths object has value for root");
				start();
			};
	
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 10);
		});
	});
	
	/**
	 * Adapter tests with annotations!
	 */	
	module("ODataTreeBindingAdapter with annotations", {
		setup: function() {
			oAnnotationMockServer.start();
			oModel = new sap.ui.model.odata.v2.ODataModel('/metadata/', {useBatch:true});
		},
		teardown: function() {
			oAnnotationMockServer.stop();
			delete oModel;
		}
	});
	
	/**
	 * Expands a mock tree to level 3
	 */
	var prebuildTree = function(fnTreeBuiltCallback) {
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", [], null, {
				displayRootNode: true,
				numberOfExpandedLevels: 2,
				rootLevel: 1
			});
			var handler1 = function(oEvent) {
				oBinding.detachChange(handler1);
				// contexts should be loaded now
				oBinding.attachChange(handler2);
				oBinding.getContexts(0, 100);
			};
			
			var handler2 = function (oEvent) {
				oBinding.detachChange(handler2);
				oBinding.attachChange(handler3);
				oBinding.getContexts(0, 100);
			};
			
			var handler3 = function (oEvent) {
				oBinding.detachChange(handler3);
				oBinding.getContexts(0, 100);
				fnTreeBuiltCallback();
			};
			
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 100);
		});
	};
	
	asyncTest("Properties", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null, [], {
				navigation: {}
			});
			ok(oBinding.findNode, "Check if ODataTreeBinding was enhanced by the Adapter.");
			equal(oBinding.bHasTreeAnnotations, true, "TreeBinding Metadata should be available");
			equal(oBinding.iRootLevel, 0, "Root Level should be 0 by default");
			equal(oBinding.iNumberOfExpandedLevels, 0, "number of expanded levels should be 0 by default");
			start();
		});
	});
	
	asyncTest("TreeBinding getContexts() calls, facading getRootContexts and getNodeContexts on the TreeBinding", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null, [], {
				rootLevel: 2
			});
			
			var oContext;
			
			var handler1 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 9);
				equal(aContexts.length, 9, "TreeBinding rootContexts length");
				
				oContext = aContexts[0];
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "Level of 1st child should be 2");
				equal(oModel.getProperty("HierarchyNode", oContext), "000002", "HierarchyNode ID of 1st child should be set correctly");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "ParentNode ID of 1st child should be correct node");
				
				oContext = aContexts[1];
				equal(oModel.getProperty("HierarchyNode", oContext), "000362", "HierarchyNode ID of 2nd child should be set correctly");
				
				oContext = aContexts[8];
				equal(oModel.getProperty("HierarchyNode", oContext), "001180", "HierarchyNode ID of last child should be set correctly");
				
				oBinding.detachChange(handler1);
				
				start();
			};
		
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 9);
		});
	});
	
	asyncTest("Display root node, node on level 1 should be there", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", [], null, {
				displayRootNode: true,
				rootLevel: 1
			});
			
			var oContext;
			
			var handler1 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 1);
				
				equal(aContexts.length, 1, "TreeBinding rootContexts length");
				
				oContext = aContexts[0];
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 1, "1st root child level check");
				equal(oModel.getProperty("HierarchyNode", oContext), "000001", "1st root child HierarchyNode check");
				
				oBinding.detachChange(handler1);
				
				var fnExpandChangeHandler = function () {
					oBinding.detachChange(fnExpandChangeHandler);
					oBinding.attachChange(handler2);
					var aContexts = oBinding.getContexts(0, 10);
				};
				
				oBinding.attachChange(fnExpandChangeHandler);
				oBinding.expand(0);
				
			};
			
			var handler2 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(1, 9);
				
				equal(aContexts.length, 9, "Check if getContexts returned the expected length for expanded 1st node");
				equal(oBinding.getChildCount(oContext), 9, "ChildCount of expanded 1st node");
				
				oContext = aContexts[0];
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "Level check on 1st child (0.0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "000002", "HierarchyNode check on 1st child (0.0)");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "ParentNode check on 1st child (0.0)");
				
				oContext = aContexts[1];
				equal(oModel.getProperty("HierarchyNode", oContext), "000362", "HierarchyNode check on 2nd child (0.1)");
				
				oContext = aContexts[8];
				equal(oModel.getProperty("HierarchyNode", oContext), "001180", "HierarchyNode check on last child (0.8)");
				
				oBinding.detachChange(handler2);
				start();
			}
			
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 1);
		});
	});
	
	asyncTest("Pagesize increasing", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", [], null, {
				displayRootNode: true,
				rootLevel: 1
			});
			
			var oContext;
			
			var handler1 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 10);
				
				equal(aContexts.length, 1, "TreeBinding rootContexts length, 10 requested, only 1 node present");
				
				equal(oBinding._iPageSize, 10, "PageSize must be 10, since 10 requested by getContexts");
				
				oContext = aContexts[0];
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 1, "1st root child level check");
				equal(oModel.getProperty("HierarchyNode", oContext), "000001", "1st root child HierarchyNode check");
				
				oBinding.detachChange(handler1);
				
				var fnExpandChangeHandler = function () {
					oBinding.detachChange(fnExpandChangeHandler);
					oBinding.attachChange(handler2);
					var aContexts = oBinding.getContexts(1, 3);
				};
				
				oBinding.attachChange(fnExpandChangeHandler);
				oBinding.expand(0);
				
			};
			
			var handler2 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(1, 3);
				
				equal(oBinding._iPageSize, 10, "PageSize must still be 10, since 10 was requested by getContexts earlier");
				
				equal(aContexts.length, 3, "Check if getContexts returned the expected length for expanded 1st node");
				equal(oBinding.getChildCount(oContext), 9, "ChildCount of expanded 1st node");
				
				// row index 4 must be present due to higher page size (10) although not requested by latest getContexts call
				oContext = oBinding.getContextByIndex(4);
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "Level check on 1st child (0.0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "001073", "HierarchyNode check on 1st child (0.0)");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "ParentNode check on 1st child (0.0)");
				
				oBinding.detachChange(handler2);
				start();
			}
			
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 10);
		});
	});
	
	asyncTest("Pagesize not decreasing", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", [], null, {
				displayRootNode: true,
				rootLevel: 1
			});
			
			var oContext;
			
			var handler1 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(0, 1);
				
				equal(aContexts.length, 1, "TreeBinding rootContexts length, 10 requested, only 1 node present");
				
				equal(oBinding._iPageSize, 1, "PageSize must be 1, since 1 requested by getContexts");
				
				oContext = aContexts[0];
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 1, "1st root child level check");
				equal(oModel.getProperty("HierarchyNode", oContext), "000001", "1st root child HierarchyNode check");
				
				oBinding.detachChange(handler1);
				
				var fnExpandChangeHandler = function () {
					oBinding.detachChange(fnExpandChangeHandler);
					oBinding.attachChange(handler2);
					var aContexts = oBinding.getContexts(1, 5);
				};
				
				oBinding.attachChange(fnExpandChangeHandler);
				oBinding.expand(0);
				
			};
			
			var handler2 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(1, 5);
				
				equal(oBinding._iPageSize, 5, "PageSize must now be 5, since 5 was requested by latest getContexts call and is higher than the first getContexts call");
				
				equal(aContexts.length, 5, "Check if getContexts returned the expected length for expanded 1st node");
				equal(oBinding.getChildCount(oContext), 9, "ChildCount of expanded 1st node");
				
				oContext = oBinding.getContextByIndex(4);
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "Level check on 1st child (0.0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "001073", "HierarchyNode check on 1st child (0.0)");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "ParentNode check on 1st child (0.0)");

				oContext = oBinding.getContextByIndex(6);
				equal(oContext, null, "Context at row index 6 still missing.")
				
				oBinding.detachChange(handler2);
				start();
			}
			
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 1);
		});
	});
	
	asyncTest("Sequential expand over 3 levels", function(){
		oModel.attachMetadataLoaded(function() {
			var oContext;
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", [], null, {
				displayRootNode: true,
				numberOfExpandedLevels: 2,
				rootLevel: 1
			});
			
			var oContext;
			
			var handler1 = function(oEvent) {
				oBinding.detachChange(handler1);
				
				// contexts should be loaded now
				oBinding.attachChange(handler2);
				
				var aContexts = oBinding.getContexts(0, 1);
				
				equal(aContexts.length, 1, "TreeBinding rootContexts length is 1, only 1 root loaded");
				
				//Level 0
				oContext = aContexts[0];
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 1, "Level of root node (0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "000001", "HierarchyNode of root node");
				equal(oModel.getProperty("FinancialStatementItem", oContext), "INT", "Content-Item of root node");
			};
			
			var handler2 = function (oEvent) {
				oBinding.detachChange(handler2);
				
				oBinding.attachChange(handler3);
				var aContexts = oBinding.getContexts(1, 9);
				
				equal(aContexts.length, 9, "TreeBinding nodeContexts length is 9, 9 children of first root node");
				
				oContext = aContexts[0];
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "Level of first child of root (0.0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "000002", "HierarchyNode of first child of root (0.0)");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "ParentNode of first child of root (0.0), should be the root node id");
			};
			
			var handler3 = function (oEvent) {
				oBinding.detachChange(handler3);
				
				var aSubContexts = oBinding.getContexts(2, 7);
				
				equal(aSubContexts.length, 7, "TreeBinding nodeContexts length is 7, 7 children of the first root child");
				
				oContext = aSubContexts[0];
				equal(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 3, "Grandchild of root (0.0.0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "000003", "HierarchyNode of Grandchild (0.0.0)");
				equal(oModel.getProperty("ParentNode", oContext), "000002", "ParentNode of GrandChild, should be first child of root node");
				
				// check if the next collected node is a sibling of the first
				// otherwise we would have expanded too far
				oContext = aSubContexts[1];
				equal(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 3, "2nd Grandchild of root (0.0.0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "000008", "HierarchyNode of 2nd Grandchild (0.0.1)");
				equal(oModel.getProperty("ParentNode", oContext), "000002", "ParentNode of 2nd GrandChild, should be first child of root node");
				
				start();
			};
			
			oBinding.attachChange(handler1);
			oBinding.getContexts(0, 20);
		});
	});
	
	asyncTest("Manual expand", function(){
		
		oModel.attachMetadataLoaded(function() {
			var oContext;
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", [], null, {
				rootLevel: 1,
				collapseRecursive: false
			});
			
			// self (de)registering handler helper
			// used to circumvent double change handlers due to expand/collapse calls
			var createChangeHandler = function (fnCallback) {
				var fn = function () {
					oBinding.detachChange(fn);
					oBinding.attachChange(fnCallback);
				
					oBinding.getContexts(0, 100);
				};
				return fn;
			};
			
			//nothing expanded
			var fnChangeHandler1 = function() {
				oBinding.detachChange(fnChangeHandler1);
				
				var aContexts = oBinding.getContexts(0, 100);
				
				oBinding.attachChange(createChangeHandler(fnChangeHandler2));
				
				//expand root node
				oBinding.expand(0);
			};
			
			// expanded root 0
			var fnChangeHandler2 = function() {
				oBinding.detachChange(fnChangeHandler2);

				var aContexts = oBinding.getContexts(0, 100);
				
				oContext = oBinding.getContextByIndex(9);
				equal(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "Level check for (0.9)");
				equal(oModel.getProperty("HierarchyNode", oContext), "001180", "HierarchyNode check for (0.9)");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "ParentNode check for (0.9)");
				
				oBinding.attachChange(createChangeHandler(fnChangeHandler3));
				
				oBinding.expand(9);
			};
			
			//expanded 0.9
			var fnChangeHandler3 = function() {
				oBinding.detachChange(fnChangeHandler3);
				
				var aContexts = oBinding.getContexts(0, 100);
				
				oContext = oBinding.getContextByIndex(10);
				equal(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 3, "Level check (0.9.0)");
				equal(oModel.getProperty("HierarchyNode", oContext), "001181", "HierarchyNode check (0.9.0)");
				equal(oModel.getProperty("ParentNode", oContext), "001180", "ParentNode check (0.9.0)");
				
				oBinding.attachChange(createChangeHandler(fnChangeHandler4));
				
				oBinding.expand(10);
			};

			//expanded 0.9.1
			var fnChangeHandler4 = function() {
				oBinding.detachChange(fnChangeHandler4);
				
				var aContexts = oBinding.getContexts(0, 100);
				
				oContext = oBinding.getContextByIndex(12);
				equal(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 4, "Level check (0.9.0.1)");
				equal(oModel.getProperty("HierarchyNode", oContext), "001193", "HierarchyNode check (0.9.0.1)");
				equal(oModel.getProperty("ParentNode", oContext), "001181", "ParentNode check (0.9.0.1)");
				
				ok(oBinding._mTreeState.expanded["/"], "Artificial Root node should be expanded");
				ok(oBinding._mTreeState.expanded["/000001/"], "1st Level node should be expanded");
				ok(oBinding._mTreeState.expanded["/000001/001180/"], "2nd Level node should be expanded");
				ok(oBinding._mTreeState.expanded["/000001/001180/001181/"], "3rd Level node should be expanded");
				
				deepEqual(oBinding._mTreeState.collapsed, {}, "No nodes should be collapsed");
				
				//collapsing to level 2 (no change handler, because we do not load data anymore)
				oBinding.collapseToLevel(2);
				
				aContexts = oBinding.getContexts(0, 100); //rebuild the tree, as usual
				
				ok(oBinding._mTreeState.expanded["/"], "Artificial Root node should be expanded");
				ok(oBinding._mTreeState.expanded["/000001/"], "1st Level node should be expanded");
				ok(oBinding._mTreeState.expanded["/000001/001180/"], "2nd Level node should be expanded");
				ok(!oBinding._mTreeState.expanded["/000001/001180/001181/"], "3rd Level node is NOT in the expanded map");
				
				ok(oBinding._mTreeState.collapsed["/000001/001180/001181/"], "3rd Level node is now in the collapsed map");
				
				//finally collapse the whole tree
				oBinding.collapseToLevel(0);
				aContexts = oBinding.getContexts(0, 100); //rebuild the tree, as usual
				
				oContext = oBinding.getContextByIndex(0);
				equal(oModel.getProperty("HierarchyNode", oContext), "000001", "HierarchyNode check for root node, everything is still there");
				equal(oBinding.isExpanded(0), false, "Root node is also collapsed now");
				
				ok(oBinding._mTreeState.expanded["/"], "Artificial Root node should still be expanded");
				ok(!oBinding._mTreeState.expanded["/000001/"], "1st Level node should NOT be expanded");
				//this node is still expanded, because collapseRecursive is set to false
				ok(oBinding._mTreeState.expanded["/000001/001180/"], "2nd Level node should still be expanded (collapseRecursive = false)");
				
				ok(oBinding._mTreeState.collapsed["/000001/"], "Root node is now in the collapsed map");
				ok(oBinding._mTreeState.collapsed["/000001/001180/001181/"], "3rd Level node is still in the collapsed map");
				
				// switch on collapseRecursive mode
				oBinding.setCollapseRecursive(true);
				
				// re-expand the root node and check if the expanded states are still correct
				oBinding.expandToLevel(1);
				deepEqual(oBinding._mTreeState.collapsed, {}, "No nodes should be collapsed now, just before expanding to level X");
				aContexts = oBinding.getContexts(0, 100); //rebuild the tree, as usual
				
				equal(oBinding.isExpanded(0), true, "root is expanded again");
				equal(oBinding.isExpanded(8), false, "sibling of the 2nd level node is not expanded");
				equal(oBinding.isExpanded(9), true, "2nd level node is still expanded");
				equal(oBinding.isExpanded(10), false, "3nd level node is not expanded");
				
				//collapse all again, this time recursive
				oBinding.collapseToLevel(0);
				
				//expand again
				oBinding.expandToLevel(1);
				
				aContexts = oBinding.getContexts(0, 100); //rebuild the tree, as usual
				
				ok(oBinding._mTreeState.expanded["/"], "Artificial Root node should still be expanded");
				ok(oBinding._mTreeState.expanded["/000001/"], "1st Level node should be expanded again");
				//this node is still expanded, because collapseRecursive is set to false
				ok(!oBinding._mTreeState.expanded["/000001/001180/"], "2nd Level node should NOT be expanded (collapseRecursive = true)");

				oBinding.attachChange(fnChangeHandler5);
				oBinding.expand(1);
			};

			// check for correct change reasons in event
			var fnChangeHandler5 = function(oEvent) {
				oBinding.detachChange(fnChangeHandler5);
				equal(oEvent.getParameter("reason"), "expand", "Change Reason expand is set");
				oBinding.attachChange(fnChangeHandler6);
				oBinding.collapse(1);
			};

			var fnChangeHandler6 = function(oEvent) {
				oBinding.detachChange(fnChangeHandler6);
				equal(oEvent.getParameter("reason"), "collapse", "Change Reason expand is set");
				start();
			};
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 100);
			
		});
	});
	
	/**
	 * To keep this test simple, we omit the change handler called after each collapse() or expand() call
	 * Data should already be present, since prebuildTree already requested a big set
	 */
	asyncTest("Collapse in auto expand", function(){
		prebuildTree(function () {
			var oContext;
			
			var changeHandlerSpy = sinon.spy(oBinding, "_fireChange");
			
			//activate the recursive collapsing
			oBinding.setCollapseRecursive(true);
			
			// 2nd row
			oContext = oBinding.getContextByIndex(2);
			equal(oContext.getProperty("HierarchyNode"), "000003", "2nd row is correct");
			
			//3rd row
			oContext = oBinding.getContextByIndex(3);
			equal(oContext.getProperty("HierarchyNode"), "000008", "3rdd row is correct");
			
			//nothing should happen, node is already collapsed
			oBinding.collapse(2);
			
			//retrigger tree building after collapse
			oBinding.getContexts(0, 100);
			
			//recheck 2nd row
			oContext = oBinding.getContextByIndex(2);
			equal(oContext.getProperty("HierarchyNode"), "000003", "2nd row did not change");
			
			//recheck 3rd row
			oContext = oBinding.getContextByIndex(3);
			equal(oContext.getProperty("HierarchyNode"), "000008", "3rdd row did not change");
			
			//collapse 2nd row
			oBinding.collapse(1);
			
			//rebuild the tree
			oBinding.getContexts(0,100);
			
			//check 1st row, should now be a collapsed node
			oContext = oBinding.getContextByIndex(1);
			equal(oContext.getProperty("HierarchyNode"), "000002", "1st row is still correct");
			equal(oBinding.isExpanded(1), false, "1st row is collapsed");
			
			//recheck 2nd row, should now have changed
			oContext = oBinding.getContextByIndex(2);
			equal(oContext.getProperty("HierarchyNode"), "000362", "2nd row changed after collapsing");
			equal(oBinding.isExpanded(2), true, "node on 2nd row is still expanded");
			
			//collapse top level node
			oBinding.collapse(0);
			oBinding.getContexts(0, 100);
			
			//check top level node
			oContext = oBinding.getContextByIndex(0);
			equal(oContext.getProperty("HierarchyNode"), "000001", "0th row did not changed after collapsing");
			equal(oBinding.isExpanded(0), false, "node on 0th row is now collapsed");
			
			//1st row should now be missing (only one root node)
			oContext = oBinding.getContextByIndex(1);
			equal(oContext, null, "1st row does not exist anymore");
			
			//expand top level node again
			oBinding.expand(0);
			oBinding.getContexts(0, 100);
			
			//top level root node should be expanded
			oContext = oBinding.getContextByIndex(0);
			equal(oBinding.isExpanded(0), true, "node on 0th row is now expanded (again)");
			
			//check for recursive collapsing
			oContext = oBinding.getContextByIndex(1);
			equal(oBinding.isExpanded(1), false, "2nd row/first root child is still collapsed");
			equal(oContext.getProperty("HierarchyNode"), "000002", "1st row is still the correct node");
			
			oContext = oBinding.getContextByIndex(2);
			equal(oBinding.isExpanded(2), false, "3nd row/second root child is now also collapsed");
			equal(oContext.getProperty("HierarchyNode"), "000362", "2nd row is still the correct node");
			
			//check for shifted nodes, the 3rd row should be on level 2, since the 2nd row is not collapsed anymore
			oContext = oBinding.getContextByIndex(3);
			equal(oContext.getProperty("HierarchyNode"), "000682", "3nd row is still the correct node");
			
			equal(changeHandlerSpy.callCount, 4, "Change event fired correctly");
			
			start();
		});
	});
	
	asyncTest("Top-Level Paging", function() {
		oModel.attachMetadataLoaded(function() {
			var oContext;
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 2
			});
	
			var handler1 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(1, 4);
	
				equal(aContexts.length, 4, "getContexts(1, 4) returned 4 contexts");
				
				oContext = oBinding.getContextByIndex(0);
				equal(oContext, null, "Context for row index 0 must be null, it was not loaded yet."); 
				
				oContext = oBinding.getContextByIndex(1);
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "Level Check for 1st returned context");
				equal(oModel.getProperty("HierarchyNode", oContext), "000362", "HierarchyNode Check for 1st returned context");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "ParentNode Check for 1st returned context");
				
				deepEqual(oContext, aContexts[0], "First returned context is the same as the one returned by getContextByIndex(1)");
				
				oContext = oBinding.getContextByIndex(2);
				equal(oModel.getProperty("HierarchyNode", oContext), "000682", "TreeBinding node content");
				
				oContext = oBinding.getContextByIndex(3);
				equal(oModel.getProperty("HierarchyNode", oContext), "001073", "TreeBinding node content");
				
				oContext = oBinding.getContextByIndex(4);
				equal(oModel.getProperty("HierarchyNode", oContext), "001131", "TreeBinding node content");
				
				oBinding.detachChange(handler1);
				
				oBinding.attachChange(handler2);
				oBinding.getContexts(5, 3);
			};
	
			var handler2 = function(oEvent) {
				// contexts should be now loaded
				var aContexts = oBinding.getContexts(5, 3);
				
				equal(aContexts.length, 3, "getContexts(5, 3) returned 3 contexts");
				
				oContext = oBinding.getContextByIndex(1);
				equal(oModel.getProperty("HierarchyNode", oContext), "000362", "Context for index 1 should still be the same after paging");
				
				notDeepEqual(oContext, aContexts[0], "getContextByIndex(1) returns a different context than getContexts(5, 3)[0]");
				
				//first context
				oContext = oBinding.getContextByIndex(5);
				deepEqual(oContext, aContexts[0], "getContextByIndex(1) returns the same context as getContexts(5, 3)[0]");
				strictEqual(oModel.getProperty("FinStatementHierarchyLevelVal", oContext), 2, "TreeBinding node content");
				equal(oModel.getProperty("HierarchyNode", oContext), "001136", "TreeBinding node content");
				equal(oModel.getProperty("ParentNode", oContext), "000001", "TreeBinding node content");
				
				//second context
				oContext = oBinding.getContextByIndex(6);
				deepEqual(oContext, aContexts[1], "getContextByIndex(6) returns the same context as getContexts(5, 3)[1]");
				equal(oModel.getProperty("HierarchyNode", oContext), "001153", "TreeBinding node content");
				
				//last context
				oContext = oBinding.getContextByIndex(7);
				deepEqual(oContext, aContexts[2], "getContextByIndex(7) returns the same context as getContexts(5, 3)[3]");
				equal(oModel.getProperty("HierarchyNode", oContext), "001179", "TreeBinding node content");
				
				// gap at the beginning should still be there
				oContext = oBinding.getContextByIndex(0);
				equal(oContext, null, "Context at row index 0 still missing.");
				
				// gap at the end should still be there
				oContext = oBinding.getContextByIndex(8);
				equal(oContext, null, "Context at row index 8 still missing.");
				
				oBinding.detachChange(handler2);
				start();
			}
			
			oBinding.attachChange(handler1);
			oBinding.getContexts(1, 4);
		});
	});
	
	asyncTest("Check Filtering not supported", function() {
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 1
			});
			var iWarningCount = 0,
				sMessage = "";
			
			sinon.stub(jQuery.sap.log, "warning", function(sMsg) {
				iWarningCount++;
				sMessage = sMsg;
			});
			
			oBinding.filter(new sap.ui.model.Filter("ParentNode", "EQ", "000000"));
			equal(iWarningCount, 1, "One warning (that filtering is not enabled) should have fired");
			equal(sMessage, "Filtering is currently not possible in the ODataTreeBinding", "Check warning message");
			jQuery.sap.log.warning.restore();
			start();
		});
	});

	asyncTest("RootNodeID - displayRootNode = true", function () {
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 5,
				rootNodeID: "000001",
				displayRootNode: true
			});
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 10);
			
			function fnChangeHandler1 () {
				oBinding.detachChange(fnChangeHandler1);
				var aContexts = oBinding.getContexts(0, 10);
				
				var oContext = aContexts[0];
				equal(oContext.getProperty("HierarchyNode"), "000001", "Correct root node retrieved.");
				equal(aContexts.length, 1, "Returned context must be 1.");
				equal(oBinding.getLength(), 1, "Length of binding must be 1.");
				
				start();
			}
			
		});

	});
	
	asyncTest("RootNodeID - displayRootNode = false, with (backend side) missing root node", function () {
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 5,
				rootNodeID: "000000",
				displayRootNode: false
			});
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 10);
			
			function fnChangeHandler1 () {
				oBinding.detachChange(fnChangeHandler1);
				var aContexts = oBinding.getContexts(0, 10);
				
				var oContext = aContexts[0];
				equal(oContext.getProperty("HierarchyNode"), "000001", "Correct root node retrieved.");
				equal(aContexts.length, 1, "Returned context must be 1.");
				equal(oBinding.getLength(), 1, "Length of binding must be 1.");
				
				start();
			}
			
		});
	});
	
	/**
	 * This test stems from a bug with an endless loop.
	 * When the backend returns no data for the given root node id, it should not break.
	 */
	asyncTest("RootNodeID - displayRootNode = true, with (backend side) missing root node", function () {
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 5,
				rootNodeID: "000000",
				displayRootNode: true
			});
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 10);
			
			function fnChangeHandler1 () {
				oBinding.detachChange(fnChangeHandler1);
				var aContexts = oBinding.getContexts(0, 10);
				
				// the backend didn't return a root node -> the binding should still be empty
				equal(aContexts.length, 0, "Returned context must be 0.");
				equal(oBinding.getLength(), 0, "Length of binding must be 0.");
				
				start();
			}
			
		});
	});
	
	asyncTest("RootNodeID - displayRootNode = false, root nodes exists", function () {
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 5,
				rootNodeID: "000001",
				displayRootNode: false
			});
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 10);
			
			function fnChangeHandler1 () {
				oBinding.detachChange(fnChangeHandler1);
				var aContexts = oBinding.getContexts(0, 10);
				
				var oContext = aContexts[0];
				equal(oContext.getProperty("HierarchyNode"), "000002", "Correct first top level node retrieved.");
				equal(aContexts.length, 9, "Returned context must be 9.");
				equal(oBinding.getLength(), 9, "Length of binding must be 9.");
				
				var oContext = aContexts[8];
				equal(oContext.getProperty("HierarchyNode"), "001180", "Correct last top level node retrieved.");
				
				start();
			}
			
		});

	});
	
	asyncTest("RootNodeID - displayRootNode = true, numberOfExpandedLevels = 1", function () {
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 5,
				rootNodeID: "000001",
				displayRootNode: true,
				numberOfExpandedLevels: 1
			});
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 1);
			
			function fnChangeHandler1 () {
				oBinding.detachChange(fnChangeHandler1);
				var aContexts = oBinding.getContexts(0, 5);
				
				var oContext = aContexts[0];
				equal(oContext.getProperty("HierarchyNode"), "000001", "Correct root node retrieved.");
				equal(aContexts.length, 1, "Returned context must be 1.");
				equal(oBinding.getLength(), 1, "Length of binding must be 1.");
				
				oBinding.attachChange(fnChangeHandler2);
			}
			
			function fnChangeHandler2() {
				oBinding.detachChange(fnChangeHandler2);
				var aContexts = oBinding.getContexts(0, 5);
				
				var oContext = aContexts[1];
				equal(oContext.getProperty("HierarchyNode"), "000002", "Correct root node retrieved.");
				equal(aContexts.length, 5, "Returned context must be 5.");
				equal(oBinding.getLength(), 10, "Length of binding must be 10.");
				
				start();
			}
			
		});
	});
	
	/**
	 * To keep this test simple, we omit the change handler called after each collapse() or expand() call
	 * Data should already be present, since prebuildTree already requested a big set
	 */
	asyncTest("SelectAll, Deselect All", function(){
		prebuildTree(function () {
			var oContext;
			
			// all selection deeper than level 1 should be deselected
			oBinding.collapseToLevel(1);
			oBinding.getContexts(0, 100);
			
			var fnSelectionChangeHandler1 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler1);
				equal(oEvent.mParameters.leadIndex, oBinding.getLength() - 1, "Event: leadIndex should be Binding length - 1");
				equal(oEvent.mParameters.oldIndex, -1, "Event: oldIndex should be -1");
				equal(oEvent.mParameters.rowIndices.length, 10, "Event: length of changedIndices should be 10");
			};
			
			var fnSelectionChangeHandler2 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler2);
				equal(oEvent.mParameters.leadIndex, - 1, "Event: leadIndex should be - 1");
				equal(oEvent.mParameters.oldIndex, oBinding.getLength() - 1, "Event: oldIndex should be Binding length -1");
				equal(oEvent.mParameters.rowIndices.length, 10, "Event: length of changedIndices should be 10");
			};
			
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler1);
			oBinding.selectAll();
			
			var aSelectedIndices = oBinding.getSelectedIndices();
			// number of nodes on Level 1 and 2 --> 10
			equal(aSelectedIndices.length, 10, "Number of selected Nodes after collapsing to level 1 must be 10");

			// check that selectAllMode is removed
			equal(oBinding._oRootNode.nodeState.selectAllMode, true, "After selectAll, selectAllMode of root node is true");
			
			var aSelectedContexts = oBinding.getSelectedContexts();
			equal(aSelectedIndices.length, aSelectedContexts.length, "Number of selected contexts and indeces must be the same");
			
			var oContext = aSelectedContexts[1];
			equal(oContext.getProperty("HierarchyNode"), "000002", "Number of selected contexts and indeces must be the same");
			
			var iLeadIndex = oBinding.getSelectedIndex();
			equal(iLeadIndex, oBinding.getLength() - 1, "LeadIndex must be last node/context of the known/paged tree in SelectAll case");
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler2);
			oBinding.clearSelection();
			var aSelectedIndices = oBinding.getSelectedIndices();
			equal(aSelectedIndices.length, 0, "There should be no selection after clearSelection");

			// check that selectAllMode is removed
			equal(oBinding._oRootNode.nodeState.selectAllMode, false, "After clearSelection, selectAllMode of root node is false");

			iLeadIndex = oBinding.getSelectedIndex();
			equal(iLeadIndex, - 1, "LeadIndex must be -1 if there is no selection");
			
			start();
		});
	});
	
	/**
	 * To keep this test simple, we omit the change handler called after each collapse() or expand() call
	 * Data should already be present, since prebuildTree already requested a big set
	 */
	asyncTest("Select single nodes", function(){
		prebuildTree(function () {
			var oContext;
			
			oBinding.collapseToLevel(1);
			oBinding.getContexts(0, 100);
			
			var fnSelectionChangeHandler1 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler1);
				equal(oEvent.mParameters.leadIndex, 1, "Event: leadIndex should be 1");
				equal(oEvent.mParameters.oldIndex, -1, "Event: oldIndex should be -1");
				equal(oEvent.mParameters.rowIndices.length, 1, "Event: length of changedIndices should be 1");
				equal(oEvent.mParameters.rowIndices[0], 1, "Event: changedIndices[0] should be 1");
			};
			
			var fnSelectionChangeHandler2 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler2);
				equal(oEvent.mParameters.leadIndex, 9, "Event: leadIndex should be 9");
				equal(oEvent.mParameters.oldIndex, 1, "Event: oldIndex should be 1");
				equal(oEvent.mParameters.rowIndices.length, 2, "Event: changedIndices should be 2");
				equal(oEvent.mParameters.rowIndices[0], 1, "Event: changedIndices[0] should be 1");
				equal(oEvent.mParameters.rowIndices[0], 1, "Event: changedIndices[1] should be 9");
			};
			
			var fnSelectionChangeHandler3 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler3);
				equal(oEvent.mParameters.leadIndex, 9, "Event: leadIndex should be 9");
				equal(oEvent.mParameters.oldIndex, 9, "Event: oldIndex should be 9");
				equal(oEvent.mParameters.rowIndices.length, 0, "Event: changedIndices should be undefined");
			};
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler1);
			oBinding.setSelectedIndex(1);
			var oContext = oBinding.getContextByIndex(oBinding.getSelectedIndex());
			var aSelectedContexts = oBinding.getSelectedContexts();
			equal(aSelectedContexts.length, 1, "One node should be selected");
			deepEqual(oContext, aSelectedContexts[0], "Contexts should equal");
			equal(oContext.getProperty("HierarchyNode"), "000002", "Second Node should be selected");
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler2);
			oBinding.setSelectedIndex(9);
			var oContext = oBinding.getContextByIndex(oBinding.getSelectedIndex());
			var aSelectedContexts = oBinding.getSelectedContexts();
			equal(aSelectedContexts.length, 1, "Still only one node should be selected");
			deepEqual(oContext, aSelectedContexts[0], "Contexts should still equal");
			equal(oContext.getProperty("HierarchyNode"), "001180", "Last Node should be selected");
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler3);
			oBinding.setSelectedIndex(9);
			var oContext = oBinding.getContextByIndex(oBinding.getSelectedIndex());
			var aSelectedContexts = oBinding.getSelectedContexts();
			equal(aSelectedContexts.length, 1, "Still only one node should be selected");
			deepEqual(oContext, aSelectedContexts[0], "Contexts should still equal");
			equal(oContext.getProperty("HierarchyNode"), "001180", "Last Node should be selected");
			
			start();
		});
	});
	
	asyncTest("Add Selection Interval", function(){
		prebuildTree(function () {
			var oContext;
			
			oBinding.collapseToLevel(1);
			oBinding.expand(1);
			oBinding.expand(2);
			oBinding.expand(3);
			oBinding.getContexts(0, 100);
			
			var fnSelectionChangeHandler1 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler1);
				equal(oEvent.mParameters.leadIndex, 10, "Event: leadIndex should be 10");
				equal(oEvent.mParameters.oldIndex, -1, "Event: oldIndex should be -1");
				equal(oEvent.mParameters.rowIndices.length, 8, "Event: length of changedIndices should be 8");
				equal(oEvent.mParameters.rowIndices[0], 3, "Event: first changedIndices[0] should be 3");
				equal(oEvent.mParameters.rowIndices[7], 10, "Event: last changedIndices[7] should be 10");
			};
			
			var fnSelectionChangeHandler2 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler2);
				equal(oEvent.mParameters.leadIndex, 16, "Event: leadIndex should be 16");
				equal(oEvent.mParameters.oldIndex, 10, "Event: oldIndex should be 10");
				equal(oEvent.mParameters.rowIndices.length, 3, "Event: length of changedIndices should be 3");
				equal(oEvent.mParameters.rowIndices[0], 14, "Event: first changedIndices[0] should be 14");
				equal(oEvent.mParameters.rowIndices[2], 16, "Event: last changedIndices[2] should be 16");
			};
			
			var fnSelectionChangeHandler3 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler3);
				equal(oEvent.mParameters.leadIndex, 15, "Event: leadIndex should be 15");
				equal(oEvent.mParameters.oldIndex, 16, "Event: oldIndex should be 16");
				equal(oEvent.mParameters.rowIndices.length, 3, "Event: length of changedIndices should be 3");
				equal(oEvent.mParameters.rowIndices[0], 11, "Event: first changedIndices[0] should be 11");
				equal(oEvent.mParameters.rowIndices[2], 13, "Event: last changedIndices[2] should be 13");
			};
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler1);
			oBinding.addSelectionInterval(3, 10);
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler2);
			oBinding.addSelectionInterval(14, 16);
			
			var aSelectedIndices = oBinding.getSelectedIndices();
			deepEqual(aSelectedIndices, [3, 4, 5, 6, 7, 8, 9, 10, 14, 15, 16], "Selected indices array is correct");
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler3);
			oBinding.addSelectionInterval(9, 15);
			
			aSelectedIndices = oBinding.getSelectedIndices();
			deepEqual(aSelectedIndices, [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16], "Selected indices array is correct, after selecting additional indices");
			
			start();
		});
	});
	
	asyncTest("Set Selection Interval", function(){
		prebuildTree(function () {
			var oContext;
			
			oBinding.collapseToLevel(1);
			oBinding.getContexts(0, 100);
			oBinding.expand(3);
			oBinding.expand(2);
			oBinding.expand(1);
			oBinding.getContexts(0, 100);
			
			var fnSelectionChangeHandler1 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler1);
				equal(oEvent.mParameters.leadIndex, 15, "Event: leadIndex should be 15");
				equal(oEvent.mParameters.oldIndex, 17, "Event: oldIndex should be 17");
				equal(oEvent.mParameters.rowIndices.length, 9, "Event: length of changedIndices should be 9");
				
				deepEqual(oEvent.mParameters.rowIndices, [3, 4, 8, 9, 10, 11, 12, 16, 17], "Changed indices after setSelectionInterval is correct");
			};
			
			var fnSelectionChangeHandler2 = function(oEvent) {
				oBinding.detachSelectionChanged(fnSelectionChangeHandler2);
				equal(oEvent.mParameters.leadIndex, 0, "Event: leadIndex should be 0");
				equal(oEvent.mParameters.oldIndex, 15, "Event: oldIndex should be 15");
				equal(oEvent.mParameters.rowIndices.length, 12, "Event: length of changedIndices should be 12");
				
				deepEqual(oEvent.mParameters.rowIndices, [0, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], "Changed indices after setSelectedIndex is correct");
			};
			
			oBinding.addSelectionInterval(3, 7);
			oBinding.addSelectionInterval(13, 17);
			
			var aSelectedIndices = oBinding.getSelectedIndices();
			deepEqual(aSelectedIndices, [3, 4, 5, 6, 7, /*8, 9, 10, 11, 12,*/ 13, 14, 15, 16, 17], "Selected indices array is correct, after selecting additional indices");
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler1);
			oBinding.setSelectionInterval(5, 15);
			
			aSelectedIndices = oBinding.getSelectedIndices();
			deepEqual(aSelectedIndices, [5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], "Selected indices array is correct, after setting the selection");
			
			oBinding.attachSelectionChanged(fnSelectionChangeHandler2);
			oBinding.setSelectedIndex(0);
			
			equal(oBinding.getSelectedIndex(), 0, "Lead Index is 0");
			aSelectedIndices = oBinding.getSelectedIndices();
			deepEqual(aSelectedIndices, [0], "Selected indices array is correct, only one entry (0)");
			
			equal(oBinding.findNode(5).selected, undefined, "Index 1 should not be selected anymore.");
			
			start();
		});
	});
	
	asyncTest("SelectAll with Paging and Expand", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 2
			});
			
			var fnChangeHandler1 = function(oEvent) {
				oBinding.detachChange(fnChangeHandler1);
				var aContexts = oBinding.getContexts(0, 2);
				oBinding.selectAll();
				
				oBinding.attachChange(fnChangeHandler2);
				oBinding.getContexts(2, 2); // perform paging
			};
			
			var fnChangeHandler2 = function(oEvent) {
				oBinding.detachChange(fnChangeHandler2);
				var aContexts = oBinding.getContexts(0, 4);
				
				var aSelectedIndices = oBinding.getSelectedIndices();
				deepEqual(aSelectedIndices, [0, 1, 2, 3], "Selected indices after paging ok");
				
				// now expand first node
				oBinding.attachChange(fnChangeHandler3);
				oBinding.expand(0);
			};
			
			var fnChangeHandler3 = function(oEvent) {
				oBinding.detachChange(fnChangeHandler3);
				oBinding.attachChange(fnChangeHandler4);
				oBinding.getContexts(0, 4);
			}
			
			var fnChangeHandler4 = function(oEvent) {
				oBinding.detachChange(fnChangeHandler4);
				var aContexts = oBinding.getContexts(0, 4);
				
				var aSelectedIndices = oBinding.getSelectedIndices();
				deepEqual(aSelectedIndices, [0, 8, 9, 10], "Selected indices after expand ok");
				
				start();
			};
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 2);
		});
	});
	
	
	asyncTest("Sorting with stable expand states", function(){
		oModel.attachMetadataLoaded(function() {
			createTreeBindingAdapter("/GLAccountHierarchyInChartOfAccountsSet(P_MANDT='902',P_VERSN='INT',P_KTOPL='INT')/Result", null,null, {
				rootLevel: 2,
				displayRootNode: false
			});
			
			//initial load
			function fnChangeHandler1 () {
				oBinding.detachChange(fnChangeHandler1);
				var aContexts = oBinding.getContexts(0, 100);
				
				oBinding.attachChange(fnChangeHandler2);
				oBinding.expand(2);
				oBinding.expand(0);
				//trigger reload
				oBinding.getContexts(0, 100);
			}
			
			//change after expand
			function fnChangeHandler2(oEvent) {
				
				if (oEvent.getParameter("reason") === "expand") {
					return;
				}
				
				oBinding.detachChange(fnChangeHandler2);
				var aContexts = oBinding.getContexts(0, 100);
				
				oBinding.attachRefresh(fnRefreshHandler);
				//sort descending
				oBinding.sort(new sap.ui.model.Sorter("HierarchyNode", true));
			}
			
			//refresh after sort()
			function fnRefreshHandler() {
				oBinding.detachRefresh(fnRefreshHandler);
				
				ok(oBinding._mTreeState.expanded["/000682/"], "NodeState for 000682 still there.");
				ok(oBinding._mTreeState.expanded["/000002/"], "NodeState for 000002 still there.");
				equal(oBinding._mTreeState.expanded["/000682/"].expanded, true, "Node 000682 is still expanded after sorting.");
				equal(oBinding._mTreeState.expanded["/000002/"].expanded, true, "Node 000002 is still expanded after sorting.");
					
				start();
			}
			
			oBinding.attachChange(fnChangeHandler1);
			oBinding.getContexts(0, 100);
			
		});
	});
	
	</script>

</head>
<body>
	<h1 id="qunit-header">QUnit tests: ODataTreeBindingAdapter</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<ol id="qunit-tests"></ol>
</body>
</html>
