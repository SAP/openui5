<!DOCTYPE HTML>

<!--
  Tested class: sap.ui.table.Table
-->

<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="utf-8">

	<title>qUnit Page for sap.ui.table.Table</title>
	<script id="sap-ui-bootstrap"
		type="text/javascript"
		src="../../../../../resources/sap-ui-core.js"
		data-sap-ui-theme="sap_bluecrystal"
		data-sap-ui-noConflict="true"
	    data-sap-ui-libs="sap.m,sap.ui.core,sap.ui.commons,sap.ui.table" >
	</script>
	<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-coverage.js" data-sap-ui-cover-only="sap/ui/table"></script>

	<script  language="javascript">
	jQuery.sap.require("sap.ui.thirdparty.sinon");
	jQuery.sap.require("sap.ui.thirdparty.sinon-qunit");
	jQuery.sap.require("sap.ui.thirdparty.sinon-ie");

	var personImg = "../images/Person.png",
		jobPosImg = "../images/JobPosition.png",
		oTable;

	// TABLE TEST DATA
	var aData = [
		{lastName: "Dente", name: "Al", checked: true, linkText: "www.sap.com", href: "http://www.sap.com", src: personImg, gender: "male", rating: 4, money: 3.45},
		{lastName: "Friese", name: "Andy", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: jobPosImg, gender: "male", rating: 2, money: 4.64},
		{lastName: "Mann", name: "Anita", checked: false, linkText: "www.kicker.de", href: "http://www.kicker.de", src: personImg, gender: "female", rating: 3, money: 7.34},
		{lastName: "Schutt", name: "Doris", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "female", rating: 4, money: 1.46},
		{lastName: "Open", name: "Doris", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "female", rating: 2, money: 32.76},
		{lastName: "Dewit", name: "Kenya", checked: false, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "female", rating: 3, money: 5.67},
		{lastName: "Zar", name: "Lou", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 1, money: 9.35},
		{lastName: "Burr", name: "Tim", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: jobPosImg, gender: "male", rating: 2, money: 10.12},
		{lastName: "Hughes", name: "Tish", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 5, money: 85.23},
		{lastName: "Town", name: "Mo", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 3, money: 4521},
		{lastName: "Case", name: "Justin", checked: false, linkText: "www.sap.com", href: "http://www.sap.com", src: personImg, gender: "male", rating: 3, money: 4563.3},
		{lastName: "Time", name: "Justin", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 4, money: 665.4},
		{lastName: "Barr", name: "Sandy", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 2, money: 334.4},
		{lastName: "Poole", name: "Gene", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: jobPosImg, gender: "male", rating: 1, money: 964.3},
		{lastName: "Ander", name: "Corey", checked: false, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 5, money: 2.34},
		{lastName: "Early", name: "Brighton", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 3, money: 8.45},
		{lastName: "Noring", name: "Constance", checked: true, linkText: "www.sap.com", href: "http://www.sap.com", src: personImg, gender: "female", rating: 4, money: 53.45},
		{lastName: "O'Lantern", name: "Jack", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 2, money: 76.34},
		{lastName: "Tress", name: "Matt", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: jobPosImg, gender: "male", rating: 4, money: 234.23},
		{lastName: "Turner", name: "Paige", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "female", rating: 3, money: 953.3}
	];

	var aOrgData = jQuery.extend(true, [], aData);
	for (var i = 0; i < 9; i++) {
		aData = aData.concat(jQuery.extend(true, [], aOrgData));
	}

	for (var i = 0, l = aData.length; i < l; i++) {
		aData[i].lastName += " - " + i;
	}

	function createTable(oConfig, fnCreateColumns, sModelName) {
		var oControl,
			sBindingPrefix = (sModelName ? sModelName + ">" : "");

		oTable = new sap.ui.table.Table("table", oConfig);

		if (!fnCreateColumns) {
			fnCreateColumns = function(oTable) {
				var oControl = new sap.ui.commons.TextView().bindProperty("text", sBindingPrefix + "lastName");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Last Name"}), template: oControl, sortProperty: "lastName", filterProperty: "lastName", width: "200px"}));
				oControl = new sap.ui.commons.TextField().bindProperty("value", sBindingPrefix + "name");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "First Name"}), template: oControl, sortProperty: "name", filterProperty: "name", width: "100px", autoResizable: true}));
				oControl = new sap.ui.commons.CheckBox().bindProperty("checked", sBindingPrefix + "checked");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Checked"}), template: oControl, sortProperty: "checked", filterProperty: "checked", width: "75px", hAlign: "Center"}));
				oControl = new sap.ui.commons.Link().bindProperty("text", sBindingPrefix + "linkText").bindProperty("href", "href");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Web Site"}), template: oControl, sortProperty: "linkText", filterProperty: "linkText"}));
				oControl = new sap.ui.commons.Image().bindProperty("src", sBindingPrefix + "src").setAlt("Test123").setTooltip("Hello World");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Image"}), template: oControl, width: "75px", hAlign: "Center"}));
				oControl = new sap.ui.commons.ComboBox().bindProperty("value", sBindingPrefix + "gender");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Gender"}), template: oControl, sortProperty: "gender", filterProperty: "gender", showSortMenuEntry: false}));
				oControl = new sap.ui.commons.RatingIndicator().bindProperty("value", sBindingPrefix + "rating");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Rating"}), template: oControl, sortProperty: "rating", filterProperty: "rating", showFilterMenuEntry: false}));
				var floatType = new sap.ui.model.type.Float({
					decimalSeparator: ",",
					groupingSeparator: "."
				});
				oControl = new sap.ui.commons.TextField().bindProperty("value", sBindingPrefix + "money", floatType);
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Money"}), template: oControl, sortProperty: "money", filterProperty: "money", filterType: floatType, width: "100px"}));
			}
		}
		fnCreateColumns(oTable);

		var oModel = new sap.ui.model.json.JSONModel();
		oModel.setData({modelData: aData});
		oTable.setModel(oModel, sModelName);
		oTable.bindRows(sBindingPrefix + "/modelData");

		oTable.placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();
	}

	function destroyTable() {
		oTable.destroy();
		sap.ui.getCore().applyChanges();
	}

	function creatSortingTableData() {
		var aData = [
		      		{lastName: "Dente", name: "Al", checked: true, linkText: "www.sap.com", href: "http://www.sap.com", src: personImg, gender: "male", rating: 4, money: 3.45},
		      		{lastName: "Friese", name: "Andy", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: jobPosImg, gender: "male", rating: 2, money: 4.64},
		      		{lastName: "Mann", name: "Anita", checked: false, linkText: "www.kicker.de", href: "http://www.kicker.de", src: personImg, gender: "female", rating: 3, money: 7.34},
		      		{lastName: "Case", name: "Justin", checked: false, linkText: "www.sap.com", href: "http://www.sap.com", src: personImg, gender: "male", rating: 3, money: 4563.3},
		      		{lastName: "Time", name: "Justin", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "male", rating: 4, money: 665.4},
		      		{lastName: "Schutt", name: "Doris", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "female", rating: 4, money: 1.46},
		      		{lastName: "Open", name: "Doris", checked: true, linkText: "www.spiegel.de", href: "http://www.spiegel.de", src: personImg, gender: "female", rating: 2, money: 32.76}
		      	];

		 var oModel = new sap.ui.model.json.JSONModel();
		 oModel.setData({modelData: aData});
		 oTable.setModel(oModel);
	}

	function sortTable() {
		var aColumns = oTable.getColumns(),
			fSorting = sap.ui.table.SortOrder;
		oTable.sort(aColumns[1], fSorting.Ascending, false);
		oTable.sort(aColumns[0], fSorting.Ascending, true);
	}

	//********** Tests start********************************************
	qutils.delayTestStart();

	module("Basic checks", {
		setup: function() {
			createTable({
				firstVisibleRow: 5,
				visibleRowCount: 7,
				title: "TABLEHEADER",
				footer: "Footer",
				selectionMode: sap.ui.table.SelectionMode.Single,
				toolbar: new sap.ui.commons.Toolbar({
					items: [
						new sap.ui.commons.Button({
							text: "Modify Table Properties..."
						})
					]
				})
			})
		},
		teardown: destroyTable
	});

	test("Properties", 8, function() {
		equal(jQuery.sap.byId("__view0").text(), "TABLEHEADER", "Title of Table is correct!");
		equal(jQuery.sap.byId("__toolbar0").find("button").text(), "Modify Table Properties...", "Toolbar and toolbar button are correct!");
		equal(jQuery.sap.byId("__view1").text(), "Footer", "Title of Table is correct!");
		equal(oTable.getSelectionMode(), "Single", "Selection mode is Single!");
		equal(oTable.getSelectedIndex(), -1, "Selected Index is -1!");
		equal(jQuery(".sapUiTableCtrl tr").length - 1, oTable.getVisibleRowCount(), "Visible Row Count correct!");
		equal(jQuery(".sapUiTableRowHdr").length, oTable.getVisibleRowCount(), "Visible Row Count correct!");
		equal(5, oTable.getFirstVisibleRow(), "First Visible Row correct!");
	});

	test("Filter", function() {
		var oColFirstName = oTable.getColumns()[1];
		var oColMoney = oTable.getColumns()[7];

		equals(oTable.getBinding("rows").iLength, 200, "RowCount beforeFiltering ok");
		oTable.filter(oColFirstName, "M*");

		// check that the column menu filter input field was updated
		var oMenu = oColFirstName.getMenu();
		// open and close the menu to let it generate its items
		oMenu.open();
		oMenu.close();

		var oFilterField = sap.ui.getCore().byId(oMenu.getId() + "-filter");
		if (oFilterField) {
			equals(oFilterField.getValue(), "M*", "Filter value is M* in column menu");
			oTable.filter(oColFirstName, "D*");
			equals(oFilterField.getValue(), "D*", "Filter value is M* in column menu");
		}

		equals(oTable.getBinding("rows").iLength, 20, "RowCount after filtering FirstName 'M*'");
		oTable.filter(oColFirstName, "Mo*");
		equals(oTable.getBinding("rows").iLength, 10, "RowCount after filtering FirstName 'Mo*''");
		equals(oColFirstName.getFiltered(), true, "Column FirstName is filtered");
		oTable.filter(oColFirstName, "");
		equals(oColFirstName.getFiltered(), false, "Column FirstName is not filtered anymore filtered");
		equals(oTable.getBinding("rows").iLength, 200, "RowCount after removing filter");

		oTable.filter(oColMoney, ">10");
		equals(oTable.getBinding("rows").iLength, 120, "RowCount after filtering money >10");
		oTable.filter(oColMoney, "> 123,45");
		equals(oTable.getBinding("rows").iLength, 70, "RowCount after filtering money >123,45");
		oTable.filter(oColMoney, "<50,55");
		equals(oTable.getBinding("rows").iLength, 100, "RowCount after filtering money <50,55");
		oTable.filter(oColMoney, "9.35");
		equals(oTable.getBinding("rows").iLength, 0, "RowCount after filtering money 9.35");
		oTable.filter(oColMoney, "5,67");
		equals(oTable.getBinding("rows").iLength, 10, "RowCount after filtering money 5,67");
		oTable.filter(oColMoney, "= 32,7600");
		equals(oTable.getBinding("rows").iLength, 10, "RowCount after filtering money = 32,7600");
		equals(oColMoney.getFiltered(), true, "Column Money is filtered");
		oTable.filter(oColFirstName, "Do*");
		equals(oTable.getBinding("rows").iLength, 10, "RowCount after filtering FirstName 'Do*' and money 32,76");
		equals(oColFirstName.getFiltered() && oColMoney.getFiltered(), true, "Column FirstName and Money are filtered");
		oTable.filter(oColFirstName, "Mo*");
		equals(oTable.getBinding("rows").iLength, 0, "RowCount after filtering FirstName 'Mo*' and money 32,76");
		oTable.filter(oColFirstName, "");
		oTable.filter(oColMoney, "");
		equals(oColFirstName.getFiltered() && oColMoney.getFiltered(), false, "Column FirstName and Money are not filtered anymore");
		equals(oTable.getBinding("rows").iLength, 200, "RowCount after removing filter");
	});

	test("SelectionMode", function() {
		oTable.setSelectionMode(sap.ui.table.SelectionMode.Multi);
		equals(oTable.getSelectionMode(), "MultiToggle", "Selection mode is MultiToggle although Multi was set!");

		// check selection mode none without columns BCP: 1570822620
		oTable.removeAllColumns();
		oTable.setSelectionMode(sap.ui.table.SelectionMode.None);
		equals(oTable.getSelectionMode(), "None", "Selection mode is None!");
	});

	test("SelectedIndex", 1, function() {
		oTable.setSelectedIndex(8);
		equals(oTable.getSelectedIndex(), 8, "Selected Index is 8!");
	});

	test("Check Selection of Last fixedBottomRow", 1, function() {
		oTable.setFixedBottomRowCount(3);
		var aRows = oTable.getRows();
		var oLastRow = aRows[aRows.length - 1];
		var $LastRow = oLastRow.getDomRefs(true);
		if ($LastRow.rowSelector) {
			$LastRow.rowSelector.click();
			equals(oTable.getSelectedIndex(), 199, "Selected Index is 199");
		}
	});

	test("Check that marked events are not handled by Table", function(oAssert) {
		var fnStub = this.stub(oTable, "_findAndfireCellEvent", jQuery.noop);

		var tmpEvent = jQuery.Event("click");
		oTable.onclick(tmpEvent);
		oAssert.strictEqual(fnStub.callCount, 1, "Stub was called");

		tmpEvent.setMarked();
		oTable.onclick(tmpEvent);
		oAssert.strictEqual(fnStub.callCount, 1, "Stub was not called");
	});

	test("VisibleRowCount", 1, function() {
		oTable.setVisibleRowCount(8);
		equals( oTable.getVisibleRowCount(), 8, "Visible Row Count is set correct!");
	});

	test("EnableColumnReordering", 1, function() {
		oTable.setEnableColumnReordering(true);
		equals(oTable.getEnableColumnReordering(),true,"Reordering is allowed");
	});

	test("FirstVisibleRow", 1, function() {
		oTable.setFirstVisibleRow(4, false);
		sap.ui.getCore().applyChanges();
		equals(oTable.getFirstVisibleRow(), 4, "First Visible Row correct!");
	});

	test("ColumnHeaderHeight", 2, function() {
		oTable.setColumnHeaderHeight(100);
		sap.ui.getCore().applyChanges();
		equals(oTable.$().find(".sapUiTableColHdrCnt").height(), 100, "ColumnHeaderHeight ok");
		oTable.setColumnHeaderHeight(0);
		sap.ui.getCore().applyChanges();
		ok(oTable.$().find(".sapUiTableColHdrCnt").height() < 100, "ColumnHeaderHeight ok");
	});

	test("ColumnHeaderVisible", 2, function() {
		oTable.setColumnHeaderVisible(false);
		sap.ui.getCore().applyChanges();
		equals(oTable.$().find(".sapUiTableColHdrCnt").is(":visible"), false, "ColumnHeaderVisible ok");
		oTable.setColumnHeaderVisible(true);
		sap.ui.getCore().applyChanges();
		equals(oTable.$().find(".sapUiTableColHdrCnt").is(":visible"), true, "ColumnHeaderVisible ok");
	});

	test("RowHeight", 2, function() {
		oTable.setRowHeight(50);
		sap.ui.getCore().applyChanges();
		equals(oTable.$().find("tr[data-sap-ui-rowindex]").height(), 50, "RowHeight ok");
		oTable.setRowHeight(0);
		sap.ui.getCore().applyChanges();
		ok(oTable.$().find("tr[data-sap-ui-rowindex]").height() < 100, "RowHeight ok");
	});
	
	test("TableExtensions", 6, function(assert) {
		assert.ok(oTable._bExtensionsInitialized, "Extensions initialized");
		assert.ok(typeof oTable._getPointerExtension === "function", "Getter for PointerExtension");
		assert.ok(typeof oTable._getAccExtension === "function", "Getter for AccExtension");
		assert.ok(typeof oTable._getAccRenderExtension === "function", "Getter for AccRenderExtension");
		assert.ok(typeof oTable._getKeyboardExtension === "function", "Getter for KeyboardExtension");
		oTable.destroy();
		assert.ok(!oTable._bExtensionsInitialized, "Extensions cleaned up");
		try {
			oTable.destroy();
		} catch(e) {
			assert.ok(false, "Duplicate call of destroy should not raise errors.");
		}
	});

	module("Column operations", {
		setup: function() {
			createTable();
		},
		teardown: function() {
			destroyTable();
		}
	});

	test("ColumnMenu", 5, function() {
		var oColumn = oTable.getColumns()[1];
		var oMenu = oColumn.getMenu();
		ok(oMenu !== null, "Column menu is not null");
		ok(oMenu instanceof sap.ui.table.ColumnMenu, "Column menu is instance of sap.ui.table.ColumnMenu");
		oMenu.open();
		ok(oMenu.getItems().length > 0, "Column menu has more than one item");
		oMenu.close();

		//Check column without sort
		oColumn = oTable.getColumns()[5];
		oMenu = oColumn.getMenu();
		oMenu.open();
		equals(oMenu.getItems().length, 1, "Column menu without sort has only one fitler item");
		oMenu.close();

		//Check column without filter
		oColumn = oTable.getColumns()[6];
		oMenu = oColumn.getMenu();
		oMenu.open();
		equals(oMenu.getItems().length, 2, "Column menu without filter has only two sort items");
		oMenu.close();
	});

	test("ColumnMenuOpen Event", function() {
		var oColumn = oTable.getColumns()[1];
		var oMenu = oColumn.getMenu();
		var fnHandler = function(oEvent) {
			deepEqual(oEvent.getSource(), oColumn, "Correct Event Source");
			deepEqual(oEvent.getParameter("menu"), oMenu, "Correct Column Menu Parameter");
		};

		var fnHandlerPreventDefault = function(oEvent) {
			oEvent.preventDefault();
		};

		oColumn.attachColumnMenuOpen(fnHandler);
		oColumn._openMenu();
		equals(oMenu.getPopup().getOpenState(), sap.ui.core.OpenState.OPEN, "ColumnMenu open");
		oMenu.close();
		oColumn.detachColumnMenuOpen(fnHandler);

		oColumn.attachColumnMenuOpen(fnHandlerPreventDefault);
		oColumn._openMenu();
		equals(oMenu.getPopup().getOpenState(), sap.ui.core.OpenState.CLOSED, "PreventDefault, ColumnMenu not open");
		oColumn.detachColumnMenuOpen(fnHandlerPreventDefault);
	});

	test("ColumnVisibilityEvent", 4, function() {
		oTable.setShowColumnVisibilityMenu(true);

		oTable.attachColumnVisibility(function(oEvent) {
			var oEventColumn = oEvent.getParameter("column");

			if (oEventColumn === oColumn0) {
				ok(true, "ColumnVisibility event fired for lastName column.");
				oEvent.preventDefault();
			} else if (oEventColumn === oColumn1) {
				ok(true, "ColumnVisibility event fired for firstName column.");
			} else {
				ok(false, "ColumnVisibility event fired for wrong column (" + oEventColumn.getId() + ").");
			}

		});

		var oColumn1 = oTable.getColumns()[1];
		var oColumn0 = oTable.getColumns()[0];
		var oMenu = oColumn1.getMenu();
		var sVisibilityMenuItemId = oColumn1.getMenu().getId() + "-column-visibilty";

		oMenu.open();
		qutils.triggerMouseEvent(sVisibilityMenuItemId, "click");
		qutils.triggerMouseEvent(sVisibilityMenuItemId + "-menu-item-0", "click");

		equal(oColumn0.getVisible(), true, "lastName column should be still visible (preventDefault)");

		oMenu.open();
		qutils.triggerMouseEvent(sVisibilityMenuItemId, "click");
		qutils.triggerMouseEvent(sVisibilityMenuItemId + "-menu-item-1", "click");

		equal(oColumn1.getVisible(), false, "firstName column should be invisible (no preventDefault)");

	});

	test("CustomColumnMenu", 1, function() {
		var oCustomMenu = new sap.ui.commons.Menu("custom-menu");
		var oColumn = oTable.getColumns()[1];
		oCustomMenu.addItem(new sap.ui.commons.MenuItem({
			text:"Custom Menu"
		}));
		oColumn.setMenu(oCustomMenu);
		ok(oColumn.getMenu() === oCustomMenu, "Custom menu equals set column menu");
	});

	test("Resize column", function() {
		var oColumn = oTable.getColumns()[1],
			sResizeHandlerId = oTable.getId() + '-rsz';

		var iResizeHandlerLeftInitial = jQuery("#" + sResizeHandlerId).position().left;
		// resizer should be way out of screen when the table gets rendered
		equals(iResizeHandlerLeftInitial, "0", "Resizer is at the correct initial position");

		var iResizeHandlerTop = Math.floor(oColumn.getDomRef().getBoundingClientRect().top + 100);
		equals(oColumn.getWidth(), "100px", "Check column width before resize");

		// resizer gets positioned when hovering a column -> move mouse to column
		var oParams = {};
		oParams.clientX = Math.floor(oColumn.getDomRef().getBoundingClientRect().left + 10);
		oParams.clientY = iResizeHandlerTop;
		qutils.triggerEvent("mousemove", oColumn.getId(), oParams);

		// resizer should now be positioned at the column end, while the center of the resizer is at the column border
		var iResizeHandlerLeft = jQuery("#" + sResizeHandlerId).position().left;
		var $column = jQuery(oColumn.getDomRef());

		var iContainerMargin = parseInt(jQuery(".sapUiTableCtrlScr").css("margin-left"));

		equals(iResizeHandlerLeft, iContainerMargin + $column.position().left + $column.width() + Math.floor(jQuery("#" + sResizeHandlerId).width() / 2), "Resizer is at the correct position");
		equals(oTable._iLastHoveredColumnIndex, 1, "Hovered column index is 1");

		// drag resizer to resize column
		qutils.triggerMouseEvent(sResizeHandlerId, "mousedown", 1, 1, iResizeHandlerLeft, iResizeHandlerTop, 0 );
		qutils.triggerMouseEvent(sResizeHandlerId, "mousemove", 1, 1, iResizeHandlerLeft + 97, iResizeHandlerTop, 0 );
		qutils.triggerMouseEvent(sResizeHandlerId, "mouseup", 1, 1, iResizeHandlerLeft + 97, iResizeHandlerTop, 0 );

		equals(oColumn.getWidth(), "196px", "Check column width after resize");

		// columns which are not resizeable should not be considered when the resizer gets positioned
		oTable.getColumns()[1].setResizable(false);
		sap.ui.getCore().applyChanges();

		var oParams = {};
		oParams.clientX = Math.floor(oColumn.getDomRef().getBoundingClientRect().left + 10);
		oParams.clientY = iResizeHandlerTop;
		qutils.triggerEvent("mousemove", oColumn.getId(), oParams);

		iResizeHandlerLeft = jQuery("#" + sResizeHandlerId).position().left;
		equals(iResizeHandlerLeft, "0", "Resizer is at the initial position");

		// other columns should still be resizable
		oColumn = oTable.getColumns()[2];
		$column = jQuery(oColumn.getDomRef());

		oParams.clientX = Math.floor(oColumn.getDomRef().getBoundingClientRect().left + 10);
		oParams.clientY = iResizeHandlerTop;
		qutils.triggerEvent("mousemove", oColumn.getId(), oParams);
		iResizeHandlerLeft = jQuery("#" + sResizeHandlerId).position().left;
		equals(iResizeHandlerLeft, iContainerMargin + $column.position().left + $column.width() + Math.floor(jQuery("#" + sResizeHandlerId).width() / 2), "Resizer is at the correct position");
	});

	test("AutomaticColumnResize", function(){

		expect(2);
		var oColumn = oTable.getColumns()[1];
		var resizer = oTable.getId() + '-rsz';
		equals(oColumn.getWidth(), "100px", "check column width before resize");
		equals(oColumn.getAutoResizable(), true, "check if column is indeed autoresizable at all");

		var oParams = {};
		oParams.clientX = Math.floor(oColumn.getDomRef().getBoundingClientRect().left + 10);
		oParams.clientY = Math.floor(oColumn.getDomRef().getBoundingClientRect().top + 100);
		qutils.triggerEvent("mousemove", oColumn.getId(), oParams);

		qutils.triggerMouseEvent(resizer, "click");
		qutils.triggerMouseEvent(resizer, "click");
		/*var newSize = oTable._calculateAutomaticColumnWidth(1);
		equals(oColumn.getWidth(), newSize + "px", "check column width after resize");*/
	});

	module("Column filtering", {
		setup: function() {
			createTable({
				visibleRowCount: 5
			}, function(oTable) {
				var oControl = new sap.ui.commons.TextView().bindProperty("text", "lastName");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Last Name"}), template: oControl, sortProperty: "lastName", filterProperty: "lastName", filterValue:"Dente", filtered: true}));
			})
		},
		teardown: destroyTable
	});

	test("Menu & initial filter: references", 4, function() {
		var oColumn = oTable.getColumns()[0];
		var oMenu = oColumn.getMenu();
		ok(oMenu !== null, "Column menu is not null");
		ok(oMenu instanceof sap.ui.table.ColumnMenu, "Column menu is instance of sap.ui.table.ColumnMenu");
		ok(oMenu._oColumn instanceof sap.ui.table.Column, "Internal reference to column is set");
		ok(oMenu._oTable instanceof sap.ui.table.Table, "Internal reference to table is set");
	});

	module("Navigation Paginator", {
		setup: function() {
			createTable({
				navigationMode: sap.ui.table.NavigationMode.Paginator,
				visibleRowCount: 13
			});
		},
		teardown: function() {
			destroyTable();
		}
	});

	test("After initialization", function() {
		var $table = oTable.$();
		equal($table.find('#table-paginator').length, 0, 'The paginator does not exist - OK, since it is deprecated');

		equal(oTable.getNavigationMode(), sap.ui.table.NavigationMode.Scrollbar , "NavigationMode defaulted to Scrollbar");
		oTable.setNavigationMode(sap.ui.table.NavigationMode.Paginator);
		equal(oTable.getNavigationMode(), sap.ui.table.NavigationMode.Scrollbar , "NavigationMode defaulted to Scrollbar after explicitly setting it to Paginator");
		oTable.setProperty("navigationMode", sap.ui.table.NavigationMode.Paginator);
		equal(oTable.getNavigationMode(), sap.ui.table.NavigationMode.Paginator , "Set navigationMode via generic setProperty sill works");
		sap.ui.getCore().applyChanges();
		$table = oTable.$();
		equal($table.find('#table-paginator').length, 1, 'Paginator is getting rendered when navigationMode is set by setProperty');
		oTable._oPaginator.getDomRef("-lastPageLink").click();
		equal(oTable.getFirstVisibleRow(), 195 , "Navigation to last page OK");
	});

	module("VisibleRowcountMode Auto", {
		setup: function() {
			
			createTable({
				visibleRowCountMode: sap.ui.table.VisibleRowCountMode.Auto
			});
		},
		teardown: function() {
			destroyTable();
			document.getElementById("qunit-fixture").style.height = "";
		}
	});

	asyncTest("After initialization", function(){
		var fnTest = function() {
			oTable.attachEvent("_rowsUpdated", fnTest2);
		};

		var fnTest2 = function() {
			equal(oTable.getVisibleRowCount(), 27, "Expected visibleRowCount: 27, Is: " + oTable.getVisibleRowCount());
			start();
		};

		oTable.attachEventOnce("_rowsUpdated", fnTest);
		document.getElementById("qunit-fixture").style.height = "800px";
	});

	module("Fixed columns", {
		setup: function() {
			createTable({
				fixedColumnCount: 2,
				width: '500px'
			});
		},
		teardown: function() {
			destroyTable();
		}
	});

	test("After initialization", function(){
		var $table = oTable.$();
		equals(oTable.getFixedColumnCount(), 2, "Fixed column count correct");
		equals($table.find('.sapUiTableCtrlFixed .sapUiTableCtrlCol th').length, 3, "Fixed tabled has 3 Columns");
		equals($table.find('.sapUiTableCtrlScroll .sapUiTableCtrlCol th').length, 7, "Scroll tabled has 7 Columns");
		equals(jQuery(oTable.getDomRef("hsb")).css('margin-left'), "325px", "Horizontal scrollbar has correct left margin");
	});

	test("Hide one column in fixed area", function() {
		oTable.getColumns()[1].setVisible(false);
		sap.ui.getCore().applyChanges();
		var $table = oTable.$();
		equals(oTable.getFixedColumnCount(), 2, "Fixed column count correct");
		equals($table.find('.sapUiTableCtrlFixed .sapUiTableCtrlCol th').length, 2, "Fixed tabled has 2 Columns");
		equals($table.find('.sapUiTableCtrlScroll .sapUiTableCtrlCol th').length, 7, "Scroll tabled has 7 Columns");
		equals(jQuery(oTable.getDomRef("hsb")).css('margin-left'), "225px", "Horizontal scrollbar has correct left margin");
	});

	test("Hide one column in scroll area", function() {
		oTable.getColumns()[5].setVisible(false);
		sap.ui.getCore().applyChanges();
		var $table = oTable.$();
		equals(oTable.getFixedColumnCount(), 2, "Fixed column count correct");
		equals($table.find('.sapUiTableCtrlFixed .sapUiTableCtrlCol th').length, 3, "Fixed tabled has 6 Columns");
		equals($table.find('.sapUiTableCtrlScroll .sapUiTableCtrlCol th').length, 6, "Scroll tabled has 3 Columns");
		equals(jQuery(oTable.getDomRef("hsb")).css('margin-left'), "325px", "Horizontal scrollbar has correct left margin");
	});

	test("No fixed column used, when table is too small.", function() {
		oTable.setFixedColumnCount(3);
		oTable.setWidth("400px");

		sap.ui.getCore().applyChanges();
		
		equals(oTable.getFixedColumnCount(), 0, "No Fixed Columns used");
		equals(oTable.getProperty("fixedColumnCount"), 3, "Orignal fixed column count is 3");

		oTable.setWidth("500px");

		sap.ui.getCore().applyChanges();

		equals(oTable.getFixedColumnCount(), 3, "Fixed Column Count is 3 again");
	});

	module("API assertions", {
		setup: function() {
			createTable({
				visibleRowCount: 10,
				width: "100px",
				firstVisibleRow: 1
			});
		},
		teardown: function () {
			destroyTable();
		}
	});

	test("Scrollbars can be accessed by inheriting controls", function(assert) {
		var oHsb = oTable.getDomRef(sap.ui.table.SharedDomRef.HorizontalScrollBar);
		var oVsb = oTable.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar);
		assert.ok(oHsb);
		assert.ok(oVsb);

		oHsb.scrollLeft = 5;

		assert.equal(oVsb.scrollTop, 28, "ScrollTop can be set and read.");
		assert.equal(oHsb.scrollLeft, 5, "ScrollLeft can be set and read.");
	});

	module("Fixed rows and columns", {
		setup: function() {
			createTable({
				fixedRowCount: 2,
				fixedColumnCount: 2,
				visibleRowCount: 8
			});
		},
		teardown: function () {
			destroyTable();
		}
	});

	test("After initialization", function() {
		var $table = oTable.$();
		equals(oTable.getFixedRowCount(), 2, "Fixed row count correct");
		equals($table.find('.sapUiTableCtrlFixed.sapUiTableCtrlRowFixed .sapUiTableCtrlCol th').length, 3, "Top left tabled has 3 Columns");
		equals($table.find('.sapUiTableCtrlFixed.sapUiTableCtrlRowScroll .sapUiTableCtrlCol th').length, 3, "Bottom left tabled has 3 Columns");
		equals($table.find('.sapUiTableCtrlScroll.sapUiTableCtrlRowFixed .sapUiTableCtrlCol th').length, 7, "Top right tabled has 7 Columns");
		equals($table.find('.sapUiTableCtrlScroll.sapUiTableCtrlRowScroll .sapUiTableCtrlCol th').length, 7, "Bottom right tabled has 7 Columns");
		equals($table.find('.sapUiTableCtrlFixed.sapUiTableCtrlRowFixed tbody tr').length, 2, "Top left tabled has 2 rows");
		equals($table.find('.sapUiTableCtrlFixed.sapUiTableCtrlRowScroll tbody tr').length, 6, "Bottom left tabled has 6 rows");
		equals($table.find('.sapUiTableCtrlScroll.sapUiTableCtrlRowFixed tbody tr').length, 2, "Top right tabled has 2 rows");
		equals($table.find('.sapUiTableCtrlScroll.sapUiTableCtrlRowScroll tbody tr').length, 6, "Bottom right tabled has 6 rows");
		equals($table.find('.sapUiTableVSb').css('top'), ($table.find('.sapUiTableRowHdr').filter(':eq(2)')[0].offsetTop - 1) + "px", "Vertical scrollbar has correct top padding");
	});

	module("Fixed top and bottom rows and columns", {
		setup: function() {
			createTable({
				fixedRowCount: 2,
				fixedBottomRowCount: 2,
				fixedColumnCount: 2,
				visibleRowCount: 8
			});
		},
		teardown: function () {
			destroyTable();
		}
	});

	test("After initialization", function() {
		var $table = oTable.$();
		equals(oTable.getFixedRowCount(), 2, "Fixed row count correct");
		equals(oTable.getFixedBottomRowCount(), 2, "Fixed bottom row count correct");
		equals(oTable.getFixedColumnCount(), 2, "Fixed column count correct");
		equals($table.find('.sapUiTableCtrlScrFixed .sapUiTableCtrlRowFixed .sapUiTableCtrlCol th').length, 3, "Left fixed table has 2 columns + dummy rowsel");
		equals($table.find('.sapUiTableCtrlScrFixed .sapUiTableCtrlRowScroll .sapUiTableCtrlCol th').length, 3, "Left scroll table has 2 columns + dummy rowsel");
		equals($table.find('.sapUiTableCtrlScrFixed .sapUiTableCtrlRowFixedBottom .sapUiTableCtrlCol th').length, 3, "Left fixed bottom table has 2 columns + dummy rowsel");
		equals($table.find('.sapUiTableCtrlScr .sapUiTableCtrlRowFixed .sapUiTableCtrlCol th').length, 7, "Right table has 6 columns + dummy rowsel");
		equals($table.find('.sapUiTableCtrlScr .sapUiTableCtrlRowScroll .sapUiTableCtrlCol th').length, 7, "Right scroll table has 6 columns + dummy rowsel");
		equals($table.find('.sapUiTableCtrlScr .sapUiTableCtrlRowFixedBottom .sapUiTableCtrlCol th').length, 7, "Right fixed bottom table has 6 columns + dummy rowsel");
		equals($table.find('.sapUiTableCtrlScrFixed .sapUiTableCtrlRowFixed tbody tr').length, 2, "Left fixed table has 2 rows");
		equals($table.find('.sapUiTableCtrlScr .sapUiTableCtrlRowFixed tbody tr').length, 2, "Right table has 2 rows");
		equals($table.find('.sapUiTableCtrlScrFixed .sapUiTableCtrlRowScroll tbody tr').length, 4, "Left scroll table has 4 rows");
		equals($table.find('.sapUiTableCtrlScr .sapUiTableCtrlRowScroll tbody tr').length, 4, "Right scroll table has 4 rows");
		equals($table.find('.sapUiTableCtrlScrFixed .sapUiTableCtrlRowFixedBottom tbody tr').length, 2, "Left fixed bottom table has 2 rows");
		equals($table.find('.sapUiTableCtrlScr .sapUiTableCtrlRowFixedBottom tbody tr').length, 2, "Right fixed bottom table has 2 rows");
		equals($table.find('.sapUiTableVSb').css('top'), ($table.find('.sapUiTableCtrl.sapUiTableCtrlRowScroll.sapUiTableCtrlScroll')[0].offsetTop - 1) + "px", "Vertical scrollbar has correct top padding");
		equals($table.find('.sapUiTableVSb').css('height'), ($table.find('.sapUiTableCtrl.sapUiTableCtrlRowScroll.sapUiTableCtrlScroll')[0].offsetHeight) + "px", "Vertical scrollbar has correct height");
	});

	QUnit.test("Sanity check for fixed rows", function(assert) {
		oTable.setVisibleRowCount(10);
		oTable.setFixedRowCount(1);
		assert.equal(oTable.getFixedRowCount(), 1,
						"Set(visible: 10, *fixed: 1, fixedBottom: 1), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedBottomRowCount(1);
		assert.equal(oTable.getFixedBottomRowCount(), 1,
						"Set(visible: 10, fixed: 1, *fixedBottom: 1), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedRowCount(8);
		assert.equal(oTable.getFixedRowCount(), 8,
						"Set(visible: 10, *fixed: 8, fixedBottom: 1), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedRowCount(9);
		assert.equal(oTable.getFixedRowCount(), 8,
						"Set(visible: 10, *fixed: 9 (expect 8), fixedBottom: 1), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedRowCount(0);
		assert.equal(oTable.getFixedRowCount(), 0,
						"Set(visible: 10, *fixed: 0, fixedBottom: 1), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedRowCount(10);
		assert.equal(oTable.getFixedRowCount(), 0,
						"Set(visible: 10, *fixed: 10 (expect 0), fixedBottom: 1), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedBottomRowCount(5);
		assert.equal(oTable.getFixedBottomRowCount(), 5,
						"Set(visible: 10, fixed: 0, *fixedBottom: 5), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedBottomRowCount(9);
		assert.equal(oTable.getFixedBottomRowCount(), 9,
						"Set(visible: 10, fixed: 0, *fixedBottom: 9), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedBottomRowCount(10);
		assert.equal(oTable.getFixedBottomRowCount(), 9,
						"Set(visible: 10, fixed: 0, *fixedBottom: 10 (expect 9)), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedBottomRowCount(11);
		assert.equal(oTable.getFixedBottomRowCount(), 9,
						"Set(visible: 10, fixed: 0, *fixedBottom: 11 (expect 9)), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedBottomRowCount(3);
		oTable.setFixedRowCount(3);

		assert.equal(oTable.getFixedBottomRowCount(), 3,
						"Set(visible: 10, fixed: 3, *fixedBottom: 3), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		assert.equal(oTable.getFixedRowCount(), 3,
						"Set(visible: 10, *fixed: 3, fixedBottom: 3), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setVisibleRowCount(8);
		assert.equal(oTable.getVisibleRowCount(), 8,
						"Set(*visible: 8, fixed: 3, fixedBottom: 3), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setVisibleRowCount(7);
		assert.equal(oTable.getVisibleRowCount(), 7,
						"Set(*visible: 7, fixed: 3, fixedBottom: 3), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setVisibleRowCount(6);
		assert.equal(oTable.getVisibleRowCount(), 7,
						"Set(*visible: 6 (expect 7), fixed: 3, fixedBottom: 3), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setVisibleRowCount(5);
		assert.equal(oTable.getVisibleRowCount(), 7,
						"Set(*visible: 5 (expect 7), fixed: 3, fixedBottom: 3), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

		oTable.setFixedRowCount(0);
		oTable.setVisibleRowCount(5);
		assert.equal(oTable.getVisibleRowCount(), 5,
						"Set(*visible: 5, fixed: 3, fixedBottom: 3), " +
						"Get(visible: " + oTable.getVisibleRowCount() + ", fixed: " + oTable.getFixedRowCount() + ", fixedBottom: " + oTable.getFixedBottomRowCount() + ")");

	});


	module("Multiple header rows", {
		setup: function() {
			createTable({}, function(oTable) {
				var oControl = new sap.ui.commons.TextView().bindProperty("text", "lastName");
				var oColumn = new sap.ui.table.Column({multiLabels: [
						new sap.ui.commons.Label({text: "Last Name"}),
						new sap.ui.commons.Label({text: "Second level header"})
					], template: oControl, sortProperty: "lastName", filterProperty: "lastName"});
				oTable.addColumn(oColumn);
				oControl = new sap.ui.commons.TextField().bindProperty("value", "name");
				oTable.addColumn(new sap.ui.table.Column({multiLabels: [
						new sap.ui.commons.Label({text: "First Name", textAlign: "Right"}),
						new sap.ui.commons.Label({text: "Name of the person"})
					], template: oControl, sortProperty: "name", filterProperty: "name"}));
				oControl = new sap.ui.commons.CheckBox().bindProperty("checked", "checked");
				oTable.addColumn(new sap.ui.table.Column({label: new sap.ui.commons.Label({text: "Checked (very long label text to show wrapping behavior)"}), template: oControl, sortProperty: "checked", filterProperty: "checked", hAlign: "Center"}));
			});
		},
		teardown: function () {
			destroyTable();
		}
	});

	test("Headers", 1, function() {
		equal(jQuery.sap.byId("table").find(".sapUiTableColHdr .sapUiTableCol").length, 6, "Total count of headers");
	});

	test("Equal widths", 3, function() {
		var $Table = jQuery.sap.byId("table");
		var $Head1 = $Table.find(".sapUiTableColHdr:eq(0)");
		var $Head2 = $Table.find(".sapUiTableColHdr:eq(1)");
		equal($Head1.find(".sapUiTableCol:eq(0)").width(), $Head2.find(".sapUiTableCol:eq(0)").width(), "First column headers have equal width");
		equal($Head1.find(".sapUiTableCol:eq(1)").width(), $Head2.find(".sapUiTableCol:eq(1)").width(), "Second column headers have equal width");
		equal($Head1.find(".sapUiTableCol:eq(2)").width(), $Head2.find(".sapUiTableCol:eq(2)").width(), "Third column headers have equal width");
	});

	module("Table with extension", {
		setup: function() {
			createTable({
				extension: [
					new sap.ui.commons.Button("extensionButton", {
						text: 'Click me!'
					})
				]
			})
		},
		teardown: destroyTable
	});

	test("After initialization", function(){
		var $table = oTable.$();
		$button = $table.find('.sapUiTableExt').find('#extensionButton');
		equals(oTable.getExtension().length, 1, "Table has 1 extension");
		equals($button.length, 1, "Button in extension is rendered");
		equals(sap.ui.getCore().byId($button.attr('id')).getText(), 'Click me!', "The correct button is rendered");
	});

	module("Invisible table", {
		setup: function() {
			createTable({
				visible: false
			})
		},
		teardown: destroyTable
	});

	test("After initialization", function(){
		var $table = oTable.$();
		equal($table.children().length, 0, 'No table content is rendered');
	});

	var oExport = null;

	module("Data export", {
		setup: function() {
			createTable({}, null, "myModel");
			oTable.filter(oTable.getColumns()[1], "Al");

			jQuery.sap.require("sap.ui.core.util.ExportTypeCSV");
			oExport = oTable.exportData({
				exportType: new sap.ui.core.util.ExportTypeCSV()
			});
		},
		teardown: function() {
			oExport.destroy();
			oExport = null;
			destroyTable();
		}
	});

	asyncTest("Export filtered table with named model", function() {
		oExport
		.generate()
		.done(function(sContent) {
			var sExpected =
			"Last Name,First Name,Checked,Web Site,Gender,Rating,Money\r\n" +
			"Dente - 0,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 20,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 40,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 60,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 80,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 100,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 120,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 140,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 160,Al,true,www.sap.com,male,4,3.45\r\n" +
			"Dente - 180,Al,true,www.sap.com,male,4,3.45";
			equal(sContent, sExpected, "Generated file content should be correct.");
		})
		.fail(function() {
			ok(false, 'Generate should not fail.');
		})
		.always(function() {
			start();
		});
	});

	module("Toolbar");
	test("Table toolbar should have the transparent design by default without changing the design property", function() {
		var oTB = new sap.m.Toolbar(),
			oTable = new sap.ui.table.Table({
				toolbar: oTB
			}).placeAt("qunit-fixture");

		sap.ui.getCore().applyChanges();

		strictEqual(sap.m.ToolbarDesign.Auto, oTB.getDesign(), "Design property of the Toolbar is Auto");
		strictEqual(sap.m.ToolbarDesign.Transparent, oTB.getActiveDesign(), "Active design of the Toolbar is Transparent");

		oTable.destroy();
	});

	test("Table should respect the design property of the Toolbar when it is set", function() {
		var oTB = new sap.m.Toolbar({
				design: "Solid"
			}),
			oTable = new sap.ui.table.Table({
				toolbar: oTB
			}).placeAt("qunit-fixture");

		sap.ui.getCore().applyChanges();

		strictEqual(sap.m.ToolbarDesign.Solid, oTB.getDesign(), "Design property of the Toolbar is Solid");
		strictEqual(sap.m.ToolbarDesign.Solid, oTB.getActiveDesign(), "Active design of the Toolbar is Solid as well");

		oTable.destroy();
	});

	module("Sorting", {
		setup: function() {
			createTable({
				title: "TABLEHEADER",
				footer: "Footer"
			})
		},
		teardown: destroyTable
	});

	asyncTest("Multi-columns sorting", function() {
		creatSortingTableData();

		var fnHandler = function() {
			var aSortedColumns = oTable.getSortedColumns();

			if (aSortedColumns.length === 2) {

				strictEqual(aSortedColumns[0].getSortProperty(), "name", "check column name.");
				strictEqual(aSortedColumns[1].getSortProperty(), "lastName", "check column name.");

				strictEqual(oTable.getRows()[3].getCells()[0].getText(), "Open", "second sorting column works.");
				strictEqual(oTable.getRows()[3].getCells()[1].getValue(), "Doris", "first sorting column works.");

				oTable.detachEvent("_rowsUpdated", fnHandler);
				start();
			}
		};

		oTable.attachEvent("_rowsUpdated", fnHandler);
		sortTable();
	});

	asyncTest("Sort Icon", function() {
		creatSortingTableData();

		var fnHandler = function() {
			var aSortedColumns = oTable.getSortedColumns();
			var cell;

			if (aSortedColumns.length === 2) {
				cell = aSortedColumns[0].$().find(".sapUiTableColCell");
				ok(cell.hasClass("sapUiTableColSF"), "Icons are shown");
				ok(cell.hasClass("sapUiTableColSorted"), "Sort icon is shown");
				ok(!cell.hasClass("sapUiTableColSortedD"), "sort icon is ascending");

				cell = aSortedColumns[1].$().find(".sapUiTableColCell");
				ok(cell.hasClass("sapUiTableColSF"), "Icons are shown");
				ok(cell.hasClass("sapUiTableColSorted"), "Sort icon is shown");
				ok(cell.hasClass("sapUiTableColSortedD"), "sort icon is descending");

				oTable.detachEvent("_rowsUpdated", fnHandler);
				start();
			}
		};

		oTable.attachEvent("_rowsUpdated", fnHandler);
		var aColumns = oTable.getColumns();
		oTable.sort(aColumns[0], sap.ui.table.SortOrder.Ascending, false);
		oTable.sort(aColumns[1], sap.ui.table.SortOrder.Descending, true);
	});

	asyncTest("remove column", function() {
		creatSortingTableData();
		var oRemovedColumn;

		var fnHandler = function() {
			var aSortedColumns = oTable.getSortedColumns();

			if (aSortedColumns.length === 2) {
				oTable.detachEvent("_rowsUpdated", fnHandler);
				oRemovedColumn = oTable.removeColumn(oTable.getSortedColumns()[0]);
				oTable.attachEvent("_rowsUpdated", fnHandler2);
			}
		};

		var fnHandler2 = function() {
			var aSortedColumns = oTable.getSortedColumns();
			strictEqual(aSortedColumns.length, 1, "sorted column deletion.");
			strictEqual(oRemovedColumn.getSortProperty(), "name", "first name is removed");
			strictEqual(aSortedColumns[0].getSortProperty(), "lastName", "second column becomes the first column.");
			oTable.detachEvent("_rowsUpdated", fnHandler2);
			start();
		};

		oTable.attachEvent("_rowsUpdated", fnHandler);
		sortTable();
		sap.ui.getCore().applyChanges();
	});


	asyncTest("remove all columns", function() {
		creatSortingTableData();

		var fnHandler = function() {

			var aSortedColumns = oTable.getSortedColumns();

			if (aSortedColumns.length === 2) {
				oTable.detachEvent("_rowsUpdated", fnHandler);
				oTable.removeAllColumns();
				oTable.attachEvent("_rowsUpdated", fnHandler2);
			}
		};

		var fnHandler2 = function() {
			oTable.detachEvent("_rowsUpdated", fnHandler2);
			var aSortedColumns = oTable.getSortedColumns();
			strictEqual(aSortedColumns.length, 0, "sorted column deletion.");
			start();
		};

		oTable.attachEvent("_rowsUpdated", fnHandler);
		sortTable();
		sap.ui.getCore().applyChanges();
	});


	asyncTest("destroy columns", function() {
		creatSortingTableData();

		var fnHandler = function() {

			var aSortedColumns = oTable.getSortedColumns();

			if (aSortedColumns.length === 2) {
				oTable.detachEvent("_rowsUpdated", fnHandler);
				oTable.destroyColumns();
				oTable.attachEvent("_rowsUpdated", fnHandler2);
			}
		};

		var fnHandler2 = function() {
			oTable.detachEvent("_rowsUpdated", fnHandler2);
			var aSortedColumns = oTable.getSortedColumns();
			strictEqual(aSortedColumns.length, 0, "sorted column deletion.");
			start();
		};

		oTable.attachEvent("_rowsUpdated", fnHandler);
		sortTable();
		sap.ui.getCore().applyChanges();
	});

	asyncTest("change column order", function() {
		creatSortingTableData();
		var oRemovedColumn;

		var fnHandler = function() {

			var aSortedColumns = oTable.getSortedColumns();

			if (aSortedColumns.length === 2) {
				oTable.detachEvent("_rowsUpdated", fnHandler);
				oTable._iNewColPos = 0;
				oRemovedColumn = oTable.removeColumn(aSortedColumns[1]);

				oTable.attachEvent("_rowsUpdated", fnHandler2);
			}
		};

		var fnHandler2 = function() {
			oTable.detachEvent("_rowsUpdated", fnHandler2);
			oTable.insertColumn(oRemovedColumn, oTable._iNewColPos);
			delete oTable._iNewColPos;
			oTable.attachEvent("_rowsUpdated", fnHandler3);
		};

		var fnHandler3 = function() {

			var aSortedColumns = oTable.getSortedColumns();
			strictEqual(aSortedColumns.length, 2, "2 sorted columns.");
			strictEqual(aSortedColumns[0].getSortProperty(), "name", "first name stays in first sorted column");
			strictEqual(aSortedColumns[1].getSortProperty(), "lastName", "last name stays in second sorted column");
			oTable.detachEvent("_rowsUpdated", fnHandler3);
			start();
		};

		oTable.attachEvent("_rowsUpdated", fnHandler);
		sortTable();
		sap.ui.getCore().applyChanges();
	});

	module("Performance improvements", {
		setup: function() {
			createTable();
		},
		teardown: destroyTable
	});

	test("Prevent re-rendering on setEnableBusyIndicator", function() {
		var spy = this.spy();
		oTable.addEventDelegate({onAfterRendering: spy});

		// act
		oTable.setEnableBusyIndicator(true);
		sap.ui.getCore().applyChanges();

		// assertions
		sinon.assert.notCalled(spy);
		assert.ok(oTable.getEnableBusyIndicator(), "The overwritten function still works");
	});

	module("Binding", {
		setup: function() {
			createTable();
		},
		teardown: destroyTable
	});

	test("BindRows", function() {
		var spy = this.spy(oTable, "destroyRows");
		// bind rows again, binding could be resolved because model is set
		oTable.bindRows(oTable.getBindingInfo("rows"));

		// bind rows to different model which is not yet set
		oTable.bindRows("otherModel>/root");
		// bind rows again. Binding was not yet resolved
		oTable.bindRows("otherModel>/root");
		// destroy rows must not be called
		sinon.assert.notCalled(spy);
	});

	module("Callbacks", {
		teardown: destroyTable
	});

	asyncTest("_updateTableCell callback", function() {
		var iCallCountUpdateTableCellOnTable = 0;
		var iCallCountUpdateTableCell = 0;
		var fnTest = function() {
			assert.equal(iCallCountUpdateTableCellOnTable, 20, "UpdateTableCell callback called on table ok");
			assert.equal(iCallCountUpdateTableCell, 20, "UpdateTableCell callback called on cell ok");
			oTable.attachEventOnce("_rowsUpdated", fnTestScroll);
			oTable.setFirstVisibleRow(5);
		};

		var fnTestScroll = function() {
			assert.equal(iCallCountUpdateTableCellOnTable, 40, "UpdateTableCell callback called on table ok");
			assert.equal(iCallCountUpdateTableCell, 40, "UpdateTableCell callback called on cell ok");
			start();
		}

		// create a dummy control for this test which has _updateTableCell implemented
		var oRenderer = new sap.ui.commons.TextView().getRenderer();
		var TextView = sap.ui.commons.TextView.extend("sap.ui.table.qunitTextView", {renderer: oRenderer});
		TextView.prototype._updateTableCell = function() { iCallCountUpdateTableCell++; };

		oTable = new sap.ui.table.Table({columns: [
			new sap.ui.table.Column({template: new TextView()}),
			new sap.ui.table.Column({template: new TextView()})
		]});

		// implement _updateTableCell for table instance
		oTable._updateTableCell = function(){ iCallCountUpdateTableCellOnTable++; };

		oTable.attachEventOnce("_rowsUpdated", fnTest);
		var oModel = new sap.ui.model.json.JSONModel();
		oModel.setData({modelData: aData});
		oTable.setModel(oModel);
		oTable.bindRows("/modelData");

		oTable.placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();
	});

	module("Events", {
		setup: function() {
			createTable();
		},
		teardown: destroyTable
	});

	test("RowSelectionChange", 35, function() {
		var sTestCase = "";
		var fnHandler = function(oEvent) {
			switch(sTestCase) {
				case "userSelectAll":
					assert.equal(oEvent.getParameter("selectAll"), true, sTestCase + ": Parameter selectAll correct");
					assert.equal(oEvent.getParameter("userInteraction"), true, sTestCase + ": Parameter userInteraction correct");
					assert.equal(oEvent.getParameter("rowIndex"), 0, sTestCase + ": Parameter rowIndex correct");
					assert.equal(oEvent.getParameter("rowContext"), oTable.getContextByIndex(0), sTestCase + ": Parameter rowContext correct");
					assert.deepEqual(oEvent.getParameter("rowIndices"), Array.apply(0, Array(200)).map(function(c, i){return i;}), sTestCase + ": Parameter rowIndices correct");
					break;
				case "userClearSelectAll":
					assert.equal(oEvent.getParameter("selectAll"), undefined, sTestCase + ": Parameter selectAll correct");
					assert.equal(oEvent.getParameter("userInteraction"), true, sTestCase + ": Parameter userInteraction correct");
					assert.equal(oEvent.getParameter("rowIndex"), -1, sTestCase + ": Parameter rowIndex correct");
					assert.equal(oEvent.getParameter("rowContext"), undefined, sTestCase + ": Parameter rowContext correct");
					assert.deepEqual(oEvent.getParameter("rowIndices"),Array.apply(0, Array(200)).map(function(c, i){return i;}), sTestCase + ": Parameter rowIndices correct");
					break;
				case "APISelectAll":
					assert.equal(oEvent.getParameter("selectAll"), true, sTestCase + ": Parameter selectAll correct");
					assert.equal(oEvent.getParameter("userInteraction"), false, sTestCase + ": Parameter userInteraction correct");
					assert.equal(oEvent.getParameter("rowIndex"), 0, sTestCase + ": Parameter rowIndex correct");
					assert.equal(oEvent.getParameter("rowContext"), oTable.getContextByIndex(0), sTestCase + ": Parameter rowContext correct");
					assert.deepEqual(oEvent.getParameter("rowIndices"), Array.apply(0, Array(200)).map(function(c, i){return i;}), sTestCase + ": Parameter rowIndices correct");
					break;
				case "APIClearSelectAll":
					assert.equal(oEvent.getParameter("selectAll"), undefined, sTestCase + ": Parameter selectAll correct");
					assert.equal(oEvent.getParameter("userInteraction"), false, sTestCase + ": Parameter userInteraction correct");
					assert.equal(oEvent.getParameter("rowIndex"), -1, sTestCase + ": Parameter rowIndex correct");
					assert.equal(oEvent.getParameter("rowContext"), undefined, sTestCase + ": Parameter rowContext correct");
					assert.deepEqual(oEvent.getParameter("rowIndices"), Array.apply(0, Array(200)).map(function(c, i){return i;}), sTestCase + ": Parameter rowIndices correct");
					break;
				case "userSetSelectedIndex":
					assert.equal(oEvent.getParameter("selectAll"), undefined, sTestCase + ": Parameter selectAll correct");
					assert.equal(oEvent.getParameter("userInteraction"), true, sTestCase + ": Parameter userInteraction correct");
					assert.equal(oEvent.getParameter("rowIndex"), 0, sTestCase + ": Parameter rowIndex correct");
					assert.equal(oEvent.getParameter("rowContext"), oTable.getContextByIndex(0), sTestCase + ": Parameter rowContext correct");
					assert.deepEqual(oEvent.getParameter("rowIndices"), [0], sTestCase + ": Parameter rowIndices correct");
					break;
				case "userUnsetSelectedIndex":
					assert.equal(oEvent.getParameter("selectAll"), undefined, sTestCase + ": Parameter selectAll correct");
					assert.equal(oEvent.getParameter("userInteraction"), true, sTestCase + ": Parameter userInteraction correct");
					assert.equal(oEvent.getParameter("rowIndex"), 0, sTestCase + ": Parameter rowIndex correct");
					assert.equal(oEvent.getParameter("rowContext"), oTable.getContextByIndex(0), sTestCase + ": Parameter rowContext correct");
					assert.deepEqual(oEvent.getParameter("rowIndices"), [0], sTestCase + ": Parameter rowIndices correct");
					break;
				case "APISetSelectedIndex":
					assert.equal(oEvent.getParameter("selectAll"), undefined, sTestCase + ": Parameter selectAll correct");
					assert.equal(oEvent.getParameter("userInteraction"), false, sTestCase + ": Parameter userInteraction correct");
					assert.equal(oEvent.getParameter("rowIndex"), 0, sTestCase + ": Parameter rowIndex correct");
					assert.equal(oEvent.getParameter("rowContext"), oTable.getContextByIndex(0), sTestCase + ": Parameter rowContext correct");
					assert.deepEqual(oEvent.getParameter("rowIndices"), [0], sTestCase + ": Parameter rowIndices correct");
					break;
			}

		};

		oTable.attachRowSelectionChange(fnHandler);

		sTestCase = "userSelectAll";
		jQuery(oTable.getDomRef("selall")).click();
		sTestCase = "userClearSelectAll";
		jQuery(oTable.getDomRef("selall")).click();

		sTestCase = "APISelectAll";
		oTable.selectAll();
		sTestCase = "APIClearSelectAll";
		oTable.clearSelection();

		sTestCase = "userSetSelectedIndex";
		jQuery("#" + oTable.getId() + "-rowsel0").click();
		sTestCase = "userUnsetSelectedIndex";
		jQuery("#" + oTable.getId() + "-rowsel0").click();

		sTestCase = "APISetSelectedIndex";
		oTable.setSelectedIndex(0);
	});

	</script>
</head>
<body class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for sap.ui.table.Table</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="qunit-fixture"></div>
</body>
</html>
