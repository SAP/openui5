<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>QUnit page for sap.tnt.NavigationList</title>
	<script src="../shared-config.js"></script>
	<script id="sap-ui-bootstrap"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.m, sap.tnt" src="../../../../resources/sap-ui-core.js">
	</script>

	<link rel="stylesheet" type="text/css" media="screen"
		  href="../../../../resources/sap/ui/thirdparty/qunit.css"/>

	<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>
	<script src="../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
	<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script>
		sinon.config.useFakeTimers = true;

		//create JSON model instance
		var oModel = new sap.ui.model.json.JSONModel();


		// create and add app
		var oApp = new sap.m.App("myApp", {initialPage: "navigationListPage"});
		oApp.placeAt("qunit-fixture");

		var oPage = new sap.m.Page("navigationListPage", {
			title: "Navigation List"
		});
		oApp.addPage(oPage);

		function getNavigationList() {
			return new sap.tnt.NavigationList({
				items: [
					new sap.tnt.NavigationListItem({
						text: 'Root 1',
						icon: 'sap-icon://employee',
						items: [
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Disabled Child',
								enabled: false
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							})
						]
					}),
					new sap.tnt.NavigationListItem({
						text: 'Disabled Root',
						enabled: false,
						icon: 'sap-icon://employee',
						items: [
							new sap.tnt.NavigationListItem({
								text: 'Child 1',
								enabled: false
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							})
						]
					}),
					new sap.tnt.NavigationListItem({
						text: 'Root 2',
						icon: 'sap-icon://employee',
						items: [
							new sap.tnt.NavigationListItem({
								text: 'Child 1',
								enabled: false
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							})
						]
					}),
					new sap.tnt.NavigationListItem({
						text: 'Root 3',
						icon: 'sap-icon://employee',
						items: [
							new sap.tnt.NavigationListItem({
								text: 'Child 1'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 2'
							}),
							new sap.tnt.NavigationListItem({
								text: 'Child 3'
							})
						]
					})
				]
			});
		}

		QUnit.module("API and Rendering", {
			beforeEach: function () {
				this.navigationList = getNavigationList();
				oPage.addContent(this.navigationList);

				sap.ui.getCore().applyChanges();
			},
			afterEach: function () {
				this.navigationList.destroy();
				this.navigationList = null;
			}
		});

		QUnit.test("rendered", function (assert) {
			assert.strictEqual(this.navigationList.$().length, 1, "should render");
		});

		QUnit.test("created", function (assert) {
			assert.ok(sap.ui.getCore().byId(this.navigationList.getId()), "created");
		});

		QUnit.test("contains elements and classes", function (assert) {
			assert.ok(this.navigationList.$().hasClass('sapTntNavLI'), "sapTntNavLI class is set");
			assert.ok(this.navigationList.$().children().length == 4, "groups number is correct");
			assert.ok(this.navigationList.$().children()[0].children[1].children.length == 3, "first group children are ok");
		});

		QUnit.test("list.setExpanded(false)", function (assert) {

			assert.ok(this.navigationList.$().hasClass('sapTntNavLICollapsed') == false, "expanded mode is ok");

			this.navigationList.setExpanded(false);
			sap.ui.getCore().applyChanges();

			assert.ok(this.navigationList.$().hasClass('sapTntNavLICollapsed'), "collapsed mode is ok");
		});

		QUnit.test("group.setExpanded(false)", function (assert) {

			assert.ok(jQuery(this.navigationList.$().children()[2].children[1]).hasClass('sapTntNavLIHiddenGroupItems') == false, "sapTntNavLIHiddenGroupItems class is not set");

			this.navigationList.getItems()[2].setExpanded(false);
			sap.ui.getCore().applyChanges();

			assert.ok(jQuery(this.navigationList.$().children()[2].children[1]).hasClass('sapTntNavLIHiddenGroupItems'), "sapTntNavLIHiddenGroupItems class is set");
		});


		QUnit.module("Interaction", {
			beforeEach: function () {
				this.navigationList = getNavigationList();
				oPage.addContent(this.navigationList);

				sap.ui.getCore().applyChanges();
			},
			afterEach: function () {
				this.navigationList.destroy();
				this.navigationList = null;
			}
		});

		QUnit.test("click group expander", function (assert) {

			assert.ok(jQuery(this.navigationList.$().children()[0].children[1]).hasClass('sapTntNavLIHiddenGroupItems') == false, "sapTntNavLIHiddenGroupItems class is not set");

			var $groupIcon = jQuery('.sapTntNavLI .sapTntNavLIExpandIcon').first();

			$groupIcon.trigger('tap');

			sap.ui.getCore().applyChanges();

			// wait 500ms
			this.clock.tick(500);

			assert.ok(jQuery(this.navigationList.$().children()[0].children[1]).hasClass('sapTntNavLIHiddenGroupItems'), "sapTntNavLIHiddenGroupItems class is set");
		});

		QUnit.test("select group", function (assert) {

			var bPassedArg,
				fnEventSpy = sinon.spy(function (oEvent) {
					bPassedArg = oEvent.getParameter('item');
				});

			this.navigationList.attachItemSelect(fnEventSpy);

			assert.ok(jQuery(this.navigationList.$().children()[0].children[1]).hasClass('sapTntNavLIItemSelected') == false, "sapTntNavLIItemSelected class is not set");

			var $group = jQuery('.sapTntNavLI li div').first();

			$group.trigger('tap');

			sap.ui.getCore().applyChanges();

			// wait 500ms
			this.clock.tick(500);

			assert.ok(jQuery(this.navigationList.$().children()[0]).hasClass('sapTntNavLIItemSelected'), "sapTntNavLIItemSelected class is set");

			assert.strictEqual(fnEventSpy.callCount, 1, "should fire select event once");
			assert.strictEqual(bPassedArg.getText(), 'Root 1', "should pass the first item as argument");
		});

		QUnit.test("select group item", function (assert) {

			var bPassedArg,
					fnEventSpy = sinon.spy(function (oEvent) {
						bPassedArg = oEvent.getParameter('item');
					});

			this.navigationList.attachItemSelect(fnEventSpy);

			var $groupItem = jQuery('.sapTntNavLI .sapTntNavLIGroupItem').first();

			assert.ok($groupItem.hasClass('sapTntNavLIItemSelected') == false, "sapTntNavLIItemSelected class is not set");

			$groupItem.trigger('tap');

			sap.ui.getCore().applyChanges();

			// wait 500ms
			this.clock.tick(500);

			assert.ok($groupItem.hasClass('sapTntNavLIItemSelected'), "sapTntNavLIItemSelected class is set");

			assert.strictEqual(fnEventSpy.callCount, 1, "should fire select event once");
			assert.strictEqual(bPassedArg.getText(), 'Child 1', "should pass the first group item as argument");
		});

		QUnit.test("popup list", function (assert) {

			assert.ok(jQuery('.sapTntNavLIPopup').length == 0, "popup list is not shown");
			assert.ok(!this.navigationList._popover, "should have no popover reference");

			this.navigationList.setExpanded(false);
			sap.ui.getCore().applyChanges();

			var $item = jQuery('.sapTntNavLI .sapTntNavLIGroup').first();
			$item.trigger('tap');

			sap.ui.getCore().applyChanges();

			// wait 500ms
			this.clock.tick(500);

			assert.ok(jQuery('.sapTntNavLIPopup').length == 1, "popup list is shown");
			assert.ok(this.navigationList._popover, "should save popover reference");

			var $groupItem = jQuery('.sapTntNavLI .sapTntNavLIGroupItem').first();
			var popover = $groupItem.closest('.sapMPopover').control()[0];

			assert.ok(popover.oPopup.getOpenState() === sap.ui.core.OpenState.OPEN, "should change popover status to OPEN");

			$groupItem.trigger('tap');

			sap.ui.getCore().applyChanges();

			// wait 500ms
			this.clock.tick(500);

			assert.ok(popover.bIsDestroyed, "popover should be destroyed");
			assert.ok(!this.navigationList._popover, "should clean popover reference");
		});

		QUnit.module("Tab navigation and ARIA settings", {
			beforeEach: function () {
				this.navigationList = getNavigationList();
				oPage.addContent(this.navigationList);

				sap.ui.getCore().applyChanges();
			},
			afterEach: function () {
				this.navigationList.destroy();
				this.navigationList = null;
			}
		});

		QUnit.test('Tab navigation', function (assert) {

			this.navigationList.$().find('li:not(.sapTntNavLIGroupItem)').each(function (index, item) {
				assert.ok(item.getAttribute('tabIndex') === null, 'first level "li" element does not have a tab index.');
			});

			this.navigationList.$().find('div.sapTntNavLIGroup:not(.sapTntNavLIItemDisabled)').each(function (index, item) {
				assert.equal(item.getAttribute('tabIndex'), '-1', jQuery(item).text() + ' has a tab index.');
			});

			this.navigationList.$().find('div.sapTntNavLIGroup.sapTntNavLIItemDisabled').each(function (index, item) {
				assert.ok(item.getAttribute('tabIndex') == null, jQuery(item).text() + ' does not have a tab index');
			});

			this.navigationList.$().find('li.sapTntNavLIGroupItem:not(.sapTntNavLIItemDisabled)').each(function (index, item) {
				assert.equal(item.getAttribute('tabIndex'), '-1', jQuery(item).text() + ' has a tab index.');
			});

			this.navigationList.$().find('li.sapTntNavLIGroupItem.sapTntNavLIItemDisabled').each(function (index, item) {
				assert.ok(item.getAttribute('tabIndex') === null, 'Disabled ' + jQuery(item).text() + ' does not have a tab index.');
			});
		});

		QUnit.test('ARIA', function (assert) {

			this.navigationList.$().find('li:not(.sapTntNavLIGroupItem)').each(function (index, item) {
				assert.ok(item.getAttribute('aria-level') === null, 'first level "li" element does not have ARIA attributes.');
			});

			this.navigationList.$().find('div.sapTntNavLIGroup').each(function (index, item) {
				assert.equal(item.getAttribute('aria-level'), '1', jQuery(item).text() + ' has  ARIA attributes.');
			});


			this.navigationList.$().find('li.sapTntNavLIGroupItem').each(function (index, item) {
				assert.equal(item.getAttribute('aria-level'), '2', jQuery(item).text() + ' has ARIA attributes.');
			});

		});

	</script>
</head>
<body class="sapUiBody">
<div id="qunit"></div>
<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
