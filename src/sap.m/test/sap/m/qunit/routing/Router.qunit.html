<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>qUnit Page for sap.m.routing.Router</title>

		<script src="../../../../../resources/sap-ui-core.js"
				data-sap-ui-libs="sap.m"
				data-sap-ui-resourceroots='{"test": "./", "sap.ui.demo.app" : "../../webapp/"}'>
		</script>

		<script>
			(function () {
				jQuery.sap.require("sap.ui.qunit.qunit-css");
				jQuery.sap.require("sap.ui.thirdparty.qunit");
				jQuery.sap.require("sap.ui.qunit.qunit-junit");
				if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
					jQuery.sap.require("sap.ui.qunit.qunit-coverage");
				}
				jQuery.sap.require("sap.ui.thirdparty.sinon");
				jQuery.sap.require("sap.ui.thirdparty.sinon-qunit");

				//signals does a ducktype to determine if node.js is running. We have to set module to undefined when we include signals
				var original = module;
				module = undefined;


				sap.ui.require([
							"sap/m/routing/Router",
							"sap/m/routing/TargetHandler",
							"sap/m/NavContainer",
							"sap/m/SplitContainer",
							"sap/m/Page",
							"sap/ui/core/routing/Views",
							"test/commonIntegrationTests"
						],
						function (Router, TargetHandler, NavContainer, SplitContainer, Page, Views, integrationTests) {
							"use strict";

							module = original;


							QUnit.module("Construction and destruction");

							QUnit.test("Should pass the targetHandler to the targets instance", function (assert) {
								// System under test
								var oRouter = new Router(null, null, null, {});

								// Assert
								assert.strictEqual(oRouter._oTargets._oTargetHandler, oRouter._oTargetHandler, "Did pass the target handler");

								oRouter.destroy();
							});

							QUnit.module("add and execute navigations", {
								setup: function () {
									this.oStartPage = new Page();
									this.oNavContainer = new NavContainer({
										pages: this.oStartPage
									});
									this.sPattern = "some/{eventData}";
									this.oToPage = new Page();
									this.oTargetConfiguration = {
										targetControl: this.oNavContainer.getId(),
										transition: "flip",
										viewLevel: 5,
										transitionParameters: { some: "parameter"}
									};
									// System under test
									this.oRouter = new sap.m.routing.Router({
												myRoute: {
													pattern: this.sPattern,
													target: "myTarget"
												}
											},
											{
												targetAggregation: "pages"
											},
											null,
											{
												myTarget: this.oTargetConfiguration
											});
								},
								teardown: function () {
									this.oNavContainer.destroy();
									this.oToPage.destroy();
									this.oStartPage.destroy();
									this.oRouter.destroy();
								}
							});

							QUnit.test("Should do a forward navigation", function () {
								//Arrange
								var that = this,
										oToSpy = this.spy(this.oNavContainer, "to"),
										oNavigateSpy = this.spy(this.oRouter._oTargetHandler, "navigate");

								this.stub(Views.prototype, "getView", function () {
									return that.oToPage;
								});

								//Act
								this.oRouter.parse("some/myData");

								//Assert
								strictEqual(oToSpy.callCount, 1, "did call the 'to' function on the oNavContainer instance");
								sinon.assert.calledWithExactly(oToSpy, this.oToPage.getId(), this.oTargetConfiguration.transition, { eventData: "myData"}, this.oTargetConfiguration.transitionParameters);

								strictEqual(oNavigateSpy.callCount, 1, "did call the 'navigate' function on the TargetHandler instance");
								sinon.assert.calledWithExactly(oNavigateSpy, {
									askHistory: true,
									navigationIdentifier: "myRoute",
									viewLevel: 5
								});
							});

							///////////////////////////////////////////////////////
							/// Integation test
							///////////////////////////////////////////////////////
							module("Integration tests");

							function createViewAndController(sName) {
								sap.ui.controller(sName, {});
								sap.ui.jsview(sName, {
									createContent: function () {
									},
									getController: function () {
										return sap.ui.controller(sName);
									}
								});

								return sap.ui.jsview(sName);
							}

							QUnit.test("Should pass some data to the navContainer", function (assert) {
								//Arrange
								var oSplitContainer = new SplitContainer({
											masterPages: [createViewAndController("InitialMaster")]
										}),
										oRouter = new Router({
											"Master": {
												targetControl: oSplitContainer.getId(),
												pattern: "{id}",
												view: "Master",
												viewType: "JS",
												targetAggregation: "masterPages"
											}
										}),
										data = null;

								this.stub(sap.ui.Device.system, "phone", false);

								// views
								createViewAndController("Master");

								oRouter.getView("Master", "JS").addEventDelegate({
									onBeforeShow: function (oEvent) {
										data = oEvent.data.id;
									}
								});

								// Act
								oRouter.parse("5");

								// Assert
								assert.strictEqual(data, "5", "should pass 5 to the page");

								// Cleanup
								oRouter.destroy();
							});

							integrationTests.start({
								setup: function (oConfig) {
									var oRouter = new Router(oConfig);

									this.oRouter = oRouter;
									return oRouter;
								},
								act: function (sPatternOrName) {
									this.oRouter.parse(sPatternOrName);
								},
								teardown: function () {
									this.oRouter.destroy();
								}
							});

						});
			})();
		</script>
	</head>
<body>
	<h1 id="qunit-header">qUnit Page for sap.m.routing.Router</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<ol id="qunit-tests"></ol>
</body>
</html>