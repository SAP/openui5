<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="utf-8">
		<title>Test Page for sap.m.MessageToast</title>
		<script src="../shared-config.js"></script>
		<script id="sap-ui-bootstrap"
				data-sap-ui-noConflict="true"
				data-sap-ui-libs="sap.m"
				src="../../../../resources/sap-ui-core.js">
		</script>
		<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
		<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script src="../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
		<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>

		<script>
			var oApp = new sap.m.App("myApp", {
				initialPage: "page1"
			});

			var oPage = new sap.m.Page("page1", {
				title: "MessageToast Control"
			});

			oApp.addPage(oPage);
			oApp.placeAt("content");

			QUnit.config.autostart = false;
			sap.ui.test.qunit.delayTestStart();

			var getBoxSizing = function($DomRef) {
				return $DomRef.css("box-sizing") || $DomRef.css("-webkit-box-sizing") || $DomRef.css("-moz-box-sizing");
			};

			var getContentElements = function($DomRef) {
				// return jQuery object of elements for controls rendered in MessageToast
				// current implementation: MessageToast child: sap.m.Flexbox, grandchild: flexbox item, great-granchild: control passed to MessageToast.show in oContent. The elements we're interested in are those of the controls in oContent
				return $DomRef.children().children().children();
			};

			var wait = function(oClock, iTime) {
				// reusable pattern for fake timer tick
				// default clock and time
				var iTime = iTime ? iTime : 2000,
					oClock = oClock ? oClock : sinon.useFakeTimers();
				oClock.tick(iTime);
				oClock.restore();
			};

			var getToasts = function() {
				// helper function to get reference to all currently open message toasts - storing this as a variable is fine unless a toast is closed, or a new one opened - -in which case we need to get the elements again
				return jQuery(".sapMMessageToast");
			};

			/* =========================================================== */
			/* HTML module                                                 */
			/* =========================================================== */

			QUnit.module("HTML");

			QUnit.test("rendering", function(assert) {

				// use fake timers instead of asynch test.
				var oClock = sinon.useFakeTimers();

				// act
				sap.m.MessageToast.show("message toast 1");

				// arrange
				var $MessageToast = getToasts().eq(0);

				// assert
				assert.ok($MessageToast.length, "The message toast HTML DIV element exist");
				assert.strictEqual($MessageToast[0].style.width, "15em", "Default MessageToast width is 15em");
				assert.strictEqual($MessageToast.css("visibility"), "visible", "After calling the sap.m.MessageToast.show(): the MessageToast is visible");
				assert.strictEqual($MessageToast.css("position"), "absolute", "Position absolute");
				assert.strictEqual($MessageToast.attr("aria-label"), " ", "The aria-labelledby is set");
				assert.strictEqual(getBoxSizing($MessageToast), "border-box", "Is using old box model");
				assert.strictEqual(typeof $MessageToast.css("box-shadow"), "string", "Is using box shadow");
				assert.strictEqual($MessageToast.css("text-align"), "center", "The text is centered");
				assert.strictEqual($MessageToast.css("text-overflow"), "ellipsis", "ellipsis");
				assert.strictEqual($MessageToast.attr("role"), "alert", "The role is set");
				assert.strictEqual($MessageToast.css("white-space"), "pre-line", "The message has the correct white-space style for supporting line break");

				// wait for render - use fake timers instead of asynch test.
				wait(oClock);

				// content has a single element with text
				assert.strictEqual(getContentElements($MessageToast).text(), "message toast 1", "The message toast displays the correct text");

				// cleanup - remove message toast, we're finished with it. enables us to refer to a new message toast later without grabbing this one
				$MessageToast.remove();
			});

			QUnit.test("Custom content - single control", function(assert) {

				// assert

				// use fake timers instead of asynch test.
				var oClock = sinon.useFakeTimers();

				// button control for display in toast
				oContentButton1 = new sap.m.Button({
						text: "button 1",
						type: "Emphasized"
					}
				// add space between the buttons
				).addStyleClass("sapUiSmallMarginBegin");

				// act
				sap.m.MessageToast.show(oContentButton1);

				// wait for render - use fake timers instead of asynch test.
				wait(oClock);

				// get all child elements
				var $Content = getContentElements(getToasts());

				// assert

				assert.ok(oContentButton1.getDomRef(), "Button is rendered");
				assert.strictEqual(oContentButton1.getDomRef(), $Content.get(0), "Button 1 DomRef rendered as the toast's content");
				assert.strictEqual($Content.get().length, 1, "Ensure there aren't further elements");

				// cleanup
				getToasts().remove();

			});

			QUnit.test("Custom content - multiple controls", function(assert) {

				// arrange

				// use fake timers instead of asynch test.
				var oClock = sinon.useFakeTimers();

				// text control for display in toast
				var oContentText1 = new sap.m.Text({
					text: "message toast 4",
					textAlign: "Center"
				}),

				// button control for display in toast
				oContentButton2 = new sap.m.Button({
						text: "button 2",
						type: "Emphasized"
					}
				// add space between the buttons
				).addStyleClass("sapUiSmallMarginBegin");

				// act
				sap.m.MessageToast.show([oContentText1, oContentButton2]);

				// wait for render - use fake timers instead of asynch test.
				wait(oClock);

				// get just content elements from toast
				var $Content = getContentElements(getToasts());

				// assert
				assert.ok(oContentText1.getDomRef(), "Text 1 is rendered");
				assert.ok(oContentButton2.getDomRef(), "Button 2 is rendered");
				assert.strictEqual(oContentText1.getDomRef(), $Content.get(0), "Text 1 DomRef rendered as the toast's first content element");
				assert.strictEqual(oContentButton2.getDomRef(), $Content.get(1), "Button 2 DomRef rendered as the toast's second content element");
				assert.strictEqual($Content.get().length, 2, "Ensure there aren't further elements");

				// cleanup
				getToasts().remove();
			});

			/* =========================================================== */
			/* API module                                                  */
			/* =========================================================== */

			QUnit.module("API methods");

			QUnit.test("Close", function(assert) {

				// Test that MessageToast.close closes the correct message toast

				// arrange

				// Check there's no toast
				assert.strictEqual(getToasts().length, 0, "check there are no open toasts before we start")

				// Show 2 toasts, close one, then the second
				var oContentButton3 = new sap.m.Button({text: "button 3"}),
				oContentButton4 = new sap.m.Button({
					text: "button 4",
					press: function(oEvent){
						sap.m.MessageToast.close(oEvent.getSource());
					}
				});

				var oClock = sinon.useFakeTimers();

				sap.m.MessageToast.show(oContentButton3, {duration: 10000, animationDuration: 0});
				sap.m.MessageToast.show(oContentButton4, {duration: 10000, animationDuration: 0});

				wait(oClock);

				//Check we have two toasts open
				assert.strictEqual(getToasts().length, 2, "both toasts are open");

				//Close the first one
				sap.m.MessageToast.close(oContentButton3);

				//Check toast with button 4 is the only one left
				assert.strictEqual(getToasts().length, 1, "one toast has closed");
				assert.strictEqual(getContentElements(getToasts()).get(0), oContentButton4.getDomRef(), "toast with button 4 is still open");

				//Close toast with button 4 by firing press event
				oContentButton4.firePress();

				// check the second toast closed
				assert.strictEqual(getToasts().length, 0, "both toasts have closed");
			});

			QUnit.module("Validate options");

			/* ------------------------------ */
			/* duration                       */
			/* ------------------------------ */

			var isFiniteInteger = function(sTestName, vValue) {
				QUnit.test(sTestName, function(assert) {

					// arrange
					var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

					// act
					sap.m.MessageToast._isFiniteInteger(vValue);

					// assert
					assert.ok(fnErrorSpy.calledOnce, '"duration" needs to be a finite positive nonzero integer, jQuery.sap.log.error() method must be called exactly once');

					// cleanup
					fnErrorSpy.restore();
				});
			};

			isFiniteInteger("duration", "2000");
			isFiniteInteger("duration", 0);
			isFiniteInteger("duration", -3);
			isFiniteInteger("duration", NaN);
			isFiniteInteger("duration", Infinity);
			isFiniteInteger("duration", -3000);
			isFiniteInteger("duration", -0.3000);
			isFiniteInteger("duration", 0.00000000000009);

			/* ------------------------------ */
			/* width                          */
			/* ------------------------------ */

			QUnit.test("width", function(assert) {

				// arrange
				var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

				// act
				sap.m.MessageToast._validateWidth("16");

				// assert
				assert.ok(fnErrorSpy.calledOnce, '"width" should be type of "sap.ui.core/CSSSize"');

				// cleanup
				fnErrorSpy.restore();
			});

			/* ------------------------------------------ */
			/* test for valid docking positions my and at */
			/* ------------------------------------------ */

			var isDockPosition = function(sTestName, vValue, iNumberOfErrors) {
				QUnit.test(sTestName, function(assert) {

					// arrange
					var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

					// act
					sap.m.MessageToast._validateDockPosition(vValue);

					// assert
					assert.strictEqual(fnErrorSpy.callCount, iNumberOfErrors, '"' + vValue + '"' + ' should be type of "sap.ui.core.Popup.Dock"');

					// cleanup
					fnErrorSpy.restore();
				});
			};

			isDockPosition("my", "begin top", 0);
			isDockPosition("my", "begin center", 0);
			isDockPosition("my", "begin bottom", 0);
			isDockPosition("my", "left top", 0);
			isDockPosition("my", "left center", 0);
			isDockPosition("my", "left bottom", 0);
			isDockPosition("my", "center top", 0);
			isDockPosition("my", "center bottom", 0);
			isDockPosition("my", "right top", 0);
			isDockPosition("my", "right center", 0);
			isDockPosition("my", "right bottom", 0);
			isDockPosition("my", "end top", 0);
			isDockPosition("my", "end center", 0);
			isDockPosition("my", "end bottom", 0);
			isDockPosition("my", "center other", 1);
			isDockPosition("at", "center center2", 1);

			/* ------------------------------ */
			/* of                             */
			/* ------------------------------ */

			var isValidOf = function(sTestName, vValue, iNumberOfErrors) {
				QUnit.test(sTestName, function(assert) {

					// arrange
					var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

					// act
					sap.m.MessageToast._validateOf(vValue);

					// assert
					assert.strictEqual(fnErrorSpy.callCount, iNumberOfErrors, '"of" needs to be an instance of sap.ui.core.Control or an Element or a jQuery object or the window');

					// cleanup
					fnErrorSpy.restore();
				});
			};

			isValidOf("of", sap.ui.getCore().byId("myApp"), 0);
			isValidOf("of", jQuery("html")[0], 0);
			isValidOf("of", jQuery("html"), 0);
			isValidOf("of", window, 0);

			isValidOf("of", undefined, 1);
			isValidOf("of", "undefined", 1);
			isValidOf("of", document, 1);

			/* ------------------------------ */
			/* offset                         */
			/* ------------------------------ */

			QUnit.test("offset", function(assert) {

				// arrange
				var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

				// act
				sap.m.MessageToast._validateOffset(50);

				// assert
				assert.ok(fnErrorSpy.calledOnce, '"offset" should be type of "string"');

				// cleanup
				fnErrorSpy.restore();
			});

			/* ------------------------------ */
			/* collision                      */
			/* ------------------------------ */

			var isValidCollision = function(sTestName, vValue, iNumberOfErrors) {
				QUnit.test(sTestName, function(assert) {

					// arrange
					var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

					// act
					sap.m.MessageToast._validateCollision(vValue);

					// assert
					assert.strictEqual(fnErrorSpy.callCount, iNumberOfErrors, '"collision" needs to be a single value “fit”, “flip” or “none”, or a pair for horizontal and vertical e.g. "fit flip”, "fit none"');

					// cleanup
					fnErrorSpy.restore();
				});
			};

			isValidCollision("collision", "fit", 0);
			isValidCollision("collision", "flip", 0);
			isValidCollision("collision", "none", 0);
			isValidCollision("collision", "flipfit", 0);
			isValidCollision("collision", "flipflip", 0);
			isValidCollision("collision", "flip flip", 0);
			isValidCollision("collision", "flip fit", 0);
			isValidCollision("collision", "fitflip", 0);
			isValidCollision("collision", "fitfit", 0);
			isValidCollision("collision", "fit fit", 0);
			isValidCollision("collision", "fit flip", 0);
			isValidCollision("collision", "fit fit fit", 1);
			isValidCollision("collision", "flip2", 1);
			isValidCollision("collision", "fit1 fit2", 1);

			/* ------------------------------ */
			/* onClose                        */
			/* ------------------------------ */

			var isValidOnCloseFn = function (sTestName, vValue, iNumberOfErrors) {
				QUnit.test(sTestName, function(assert) {

					// arrange
					var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

					// act
					sap.m.MessageToast._validateOnClose(vValue);

					// assert
					assert.strictEqual(fnErrorSpy.callCount, iNumberOfErrors, '"onClose"' + ' should be a function or null');

					// cleanup
					fnErrorSpy.restore();
				});
			};

			isValidOnCloseFn("onClose", function() {}, 0);
			isValidOnCloseFn("onClose", null, 0);
			isValidOnCloseFn("onClose", {}, 1);

			/* ------------------------------ */
			/* autoClose                      */
			/* ------------------------------ */

			var isValidAutoCloseValue = function(sTestName, vValue, iNumberOfErrors) {
				QUnit.test(sTestName, function(assert) {

					// arrange
					var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

					// act
					sap.m.MessageToast._validateAutoClose(vValue);

					// assert
					assert.strictEqual(fnErrorSpy.callCount, iNumberOfErrors, '"autoClose"' + ' should be a boolean');

					// cleanup
					fnErrorSpy.restore();
				});
			};

			isValidAutoCloseValue("autoClose", true, 0);
			isValidAutoCloseValue("autoClose", false, 0);
			isValidAutoCloseValue("autoClose", {}, 1);

			/* ------------------------------ */
			/* animationTimingFunction        */
			/* ------------------------------ */

			var isValidAnimationTimingFunction = function(sTestName, vValue, iNumberOfErrors) {
				QUnit.test(sTestName, function(assert) {

					// arrange
					var fnErrorSpy = sinon.spy(jQuery.sap.log, "error");

					// act
					sap.m.MessageToast._validateAnimationTimingFunction(vValue);

					// assert
					assert.strictEqual(fnErrorSpy.callCount, iNumberOfErrors, '"animationTimingFunction"' + ' should be a string, expected values: ' + ["ease", "linear", "ease-in", "ease-out", "ease-in-out"].toString());

					// cleanup
					fnErrorSpy.restore();
				});
			};

			isValidAnimationTimingFunction("animationTimingFunction", "ease", 0);
			isValidAnimationTimingFunction("animationTimingFunction", "linear", 0);
			isValidAnimationTimingFunction("animationTimingFunction", "ease-in", 0);
			isValidAnimationTimingFunction("animationTimingFunction", "ease-out", 0);
			isValidAnimationTimingFunction("animationTimingFunction", "ease-in-out", 0);
			isValidAnimationTimingFunction("animationTimingFunction", "ease1", 1);
			isValidAnimationTimingFunction("animationTimingFunction", "ease ease", 1);

			/* ------------------------------ */
			/* animationDuration              */
			/* ------------------------------ */

			isFiniteInteger("animationDuration", "1");
			isFiniteInteger("animationDuration", -3);
			isFiniteInteger("animationDuration", NaN);
			isFiniteInteger("animationDuration", Infinity);
			isFiniteInteger("animationDuration", -3000);
			isFiniteInteger("animationDuration", -0.3000);
			isFiniteInteger("animationDuration", 0.00000000000009);

			/* ------------------------------ */
			/* closeOnBrowserNavigation       */
			/* ------------------------------ */

			var fnCloseOnBrowserNavigationTestCase = function(bCloseOnBrowserNavigation) {
				QUnit.test("closeOnBrowserNavigation", function(assert) {

					// arrange
					var fnAddPopoverInstanceSpy = sinon.spy(sap.m.InstanceManager, "addPopoverInstance");

					// act
					sap.m.MessageToast.show("message toast 2", {
						my: "end top",
						at: "end top",
						closeOnBrowserNavigation: bCloseOnBrowserNavigation
					});

					// assert
					assert.strictEqual(fnAddPopoverInstanceSpy.callCount, bCloseOnBrowserNavigation ? 1 : 0);

					// cleanup
					fnAddPopoverInstanceSpy.restore();
				});
			};

			fnCloseOnBrowserNavigationTestCase(true);
			fnCloseOnBrowserNavigationTestCase(false);

			/* =========================================================== */
			/* Events module                                               */
			/* =========================================================== */

			QUnit.module("Events");

			var hasEventListeners = function(oDomRef, sEventType, b) {
				QUnit.test("Listeners", function(assert) {
					var aResizeEventListeners = jQuery._data(oDomRef, "events")[sEventType];
					var bBoundedListeners = aResizeEventListeners.some(function(oResizeEventListener) {
						return oResizeEventListener.namespace === "sapMMessageToast";
					});

					assert.strictEqual(bBoundedListeners, b, "Listener to the " + '"' + sEventType + '" event deregistered');
				});
			};

			QUnit.test("Mousedown on SVG element should not throw exception", function (assert) {
				var done = assert.async();
				var oSvgCircle = new sap.ui.core.HTML({
					content: '<svg id="svg-circle" height="100" width="100">' +
								'<circle cx="50" cy="50" r="40" fill="red"></circle>' +
							'</svg>'
				});

				oPage.addContent(oSvgCircle);
				sap.ui.getCore().applyChanges();

				sap.m.MessageToast.show("test", {
					onClose: function () {
						assert.ok(true, "Message toast closed with no error thrown");
						done();
					}
				});

				sap.m.MessageToast._handleMouseDownEvent(jQuery.Event("mousedown", {
					target: document.getElementById("svg-circle")
				}));

				oSvgCircle.destroy();
			});

			QUnit.test("Callback", function(assert) {
				var done = assert.async();
				setTimeout(function() {

					// arrange
					var fnCloseSpy = sinon.spy();

					// act
					sap.m.MessageToast.show("message toast 3", {
						my: "center center",
						at: "center center",
						onClose: fnCloseSpy
					});

					setTimeout(function() {

						// assert
						assert.ok(fnCloseSpy.calledOn(sap.m.MessageToast), 'onClose callback was called with the correct context');
						hasEventListeners(window, "resize", false);
						hasEventListeners(document, "mousedown", false);
						hasEventListeners(document, "touchstart", false);

						// start the test
						done();
					}, 7000);
				}, 0);
			});
		</script>
	</head>
	<body id="body" class="sapUiBody">
		<h1 id="qunit-header">QUnit tests: sap.m.MessageToast</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<ol id="qunit-tests"></ol>
		<div id="content"></div>
	</body>
</html>
