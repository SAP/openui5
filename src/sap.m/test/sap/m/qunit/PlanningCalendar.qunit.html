<!DOCTYPE HTML>

<!--
  Tested control/class: sap.m.PlanningCalendar
-->

<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>PlanningCalendar - sap.m</title>
	<link rel="shortcut icon" type="image/x-icon" href="../images/controls/sap.m.PlanningCalendar.gif">
	<script src="../shared-config.js"></script>
	<script id="sap-ui-bootstrap"
			src="../../../../resources/sap-ui-core.js"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.m, sap.ui.unified"
			data-sap-ui-language="en_GB">
	//Make sure that changing the sap-ui-language is reflected into the tests as well, as the tests are bound to en_GB
	</script>
	<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
	<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script src="../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
	<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>
	<!--[if IE]>
	<script src="../../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
	<![endif]-->

	<style>
		.width300 {
			width: 300px;
		}
		.width600 {
			width: 600px;
		}
		.width1024{
			width: 1024px;
		}
	</style>

	<!-- Test functions -->
	<script>

		jQuery.sap.require("sap.ui.model.type.Date");
		jQuery.sap.require("sap.ui.unified.calendar.CalendarDate");
		jQuery.sap.require("sap.ui.unified.DateTypeRange");
		jQuery.sap.require("sap.ui.unified.CalendarLegend");
		jQuery.sap.require("sap.ui.unified.CalendarLegendRenderer");
		jQuery.sap.require("sap.m.PlanningCalendarLegend");
		jQuery.sap.require("sap.ui.unified.CalendarAppointment");
		jQuery.sap.require("sap.ui.unified.CalendarLegendItem");

		var CalendarDate = sap.ui.unified.calendar.CalendarDate,
			DateTypeRange = sap.ui.unified.DateTypeRange,
			CalendarLegend = sap.ui.unified.CalendarLegend,
			CalendarLegendRenderer = sap.ui.unified.CalendarLegendRenderer,
			PlanningCalendarLegend = sap.m.PlanningCalendarLegend,
			CalendarLegendItem = sap.ui.unified.CalendarLegendItem,
			CalendarAppointment = sap.ui.unified.CalendarAppointment,
			CalendarIntervalType = sap.ui.unified.CalendarIntervalType,
			CalendarDayType = sap.ui.unified.CalendarDayType,
			GroupAppointmentsMode = sap.ui.unified.GroupAppointmentsMode,
			oFormatYyyyMMddHHmm = sap.ui.core.format.DateFormat.getInstance({pattern: "yyyyMMddHHmm"}),
			oFormatYyyyMMdd = sap.ui.core.format.DateFormat.getInstance({pattern: "yyyyMMdd"}),
			/*the SUT won't be destroyed when single test is run*/
			bSkipDestroy = !!jQuery.sap.getUriParameters().get("testId");

		var createToolbarContent = function(sSearchFieldId, sButtonId) {
			oSearchField1 = new sap.m.SearchField(sSearchFieldId, {
				width: "10rem",
				search: function(oEvent) {
					alert("Search!");
				}
			});

			oButton1 = new sap.m.Button(sButtonId, {
				icon: "sap-icon://sap-ui5",
				type: sap.m.ButtonType.Transparent,
				press: function(oEvent) {
					alert("UI5 Button pressed");
				}
			});
		};

		var oSelectedAppointment,
			sDomRefId;
		var handleAppointmentSelect = function(oEvent){
			oSelectedAppointment = oEvent.getParameter("appointment");
			sDomRefId = oEvent.getParameter("domRefId");
		};

		var bRowSelectionChange = false;
		var aChangedRows;
		var handleRowSelectionChange = function(oEvent){
			bRowSelectionChange = true;
			aChangedRows = oEvent.getParameter("rows");
		};

		var bStartDateChange = false;
		var handleStartDateChange = function(oEvent){
			bStartDateChange = true;
		};

		var bViewChange = false;
		var handleViewChange = function(oEvent){
			bViewChange = true;

		};

		var bIntervalSelect = false;
		var oIntervalStartDate;
		var oIntervalEndDate;
		var bSubInterval;
		var oIntervalRow;
		var handleIntervalSelect = function(oEvent){
			bIntervalSelect = true;
			oIntervalStartDate = oEvent.getParameter("startDate");
			oIntervalEndDate = oEvent.getParameter("endDate");
			bSubInterval = oEvent.getParameter("bubInterval");
			oIntervalRow = oEvent.getParameter("row");
		};
		var oPCStartDate = new Date("2015", "0", "1", "08", "00");

		var createPlanningCalendar = function(sID, oSearchField, oButton, oParamStartDate, sViewKey, oLegend, aSpecialDates, aRows) {

			if (!aSpecialDates || !aSpecialDates.length) {
				aSpecialDates = [
					new DateTypeRange(sID + "SD1", {
						startDate: new Date(2015, 0, 6),
						type: CalendarDayType.Type01,
						tooltip: "Heilige 3 KÃ¶nige"
					}),
					new DateTypeRange(sID + "SD2", {
						startDate: new Date(2015, 0, 1, 12, 00),
						endDate: new Date(2015, 0, 1, 14, 00),
						type: CalendarDayType.Type02,
						tooltip: "Lunch"
					})
				]
			}

			if (!aRows) {
				aRows = [new sap.m.PlanningCalendarRow(sID + "-Row1", {
					icon: "sap-icon://employee",
					title: "Max Mustermann",
					text: "Musterteam",
					tooltip: "Header tooltip",
					intervalHeaders: [ new CalendarAppointment(sID + "-R1H1",{
						startDate: new Date("2015", "0", "1", "09", "00"),
						endDate: new Date("2015", "0", "1", "11", "00"),
						type: CalendarDayType.Type02,
						color: "#FF0000",
						title: "SAPUI5",
						tooltip: "Test",
						icon: "sap-icon://sap-ui5"
					})
					],
					appointments: [ new CalendarAppointment(sID + "-R1A1", {
						startDate: oPCStartDate,
						endDate: new Date("2015", "0", "1", "09", "00"),
						type: CalendarDayType.Type01,
						color: "#FF00FF",
						title: "App 1",
						icon: "../../ui/unified/images/m_01.png",
						tooltip: "Tooltip",
						text: "Text"
					}),
						new CalendarAppointment(sID + "-R1A2", {
							startDate: new Date("2015", "0", "1", "07", "00"),
							endDate: oPCStartDate,
							type: CalendarDayType.Type02,
							title: "App 2",
							icon: "sap-icon://home",
							tooltip: "Tooltip",
							text: "Text",
							tentative: true
						}),
						new CalendarAppointment(sID + "-R1A3", {
							startDate: new Date("2015", "0", "2", "08", "30"),
							endDate: new Date("2015", "0", "2", "09", "30"),
							type: CalendarDayType.Type03,
							title: "App3",
							icon: "sap-icon://home",
							tooltip: "Tooltip"
						}),
						new CalendarAppointment(sID + "-R1A4", {
							startDate: new Date("2014", "6", "1", "0", "0"),
							endDate: new Date("2014", "6", "2", "0", "0"),
							type: CalendarDayType.Type04,
							title: "Meeting 4",
							tooltip: "Tooltip 4",
							selected: true
						})
					],
				}),
					new sap.m.PlanningCalendarRow(sID + "-Row2", {
						icon: "../../ui/unified/images/m_01.png",
						title: "Edward",
						text: "the great",
						tooltip: "Header tooltip",
						nonWorkingDays: [2,3],
						nonWorkingHours: [11, 12],
						intervalHeaders: [ new CalendarAppointment(sID + "-R2H1",{
							startDate: new Date("2015", "0", "2", "00", "00"),
							endDate: new Date("2015", "0", "2", "23", "59"),
							type: CalendarDayType.Type01,
							title: "SAPUI5",
							tooltip: "Test",
							icon: "sap-icon://sap-ui5"
						})
						],
						appointments: [ new CalendarAppointment(sID + "-R2A1", {
							startDate: new Date("2015", "0", "1", "00", "00"),
							endDate: new Date("2015", "0", "2", "23", "59"),
							type: CalendarDayType.Type01,
							title: "App 1",
							tooltip: "Tooltip",
							text: "Text"
						})
						]
					})
			]
			}

			var oTC = new sap.m.PlanningCalendar(sID, {
				startDate: oParamStartDate || oPCStartDate,
				legend: oLegend,
				rows: aRows,
				specialDates: aSpecialDates,
				toolbarContent: [oSearchField, oButton],
				appointmentSelect: handleAppointmentSelect,
				startDateChange: handleStartDateChange,
				rowSelectionChange: handleRowSelectionChange,
				viewChange: handleViewChange,
				intervalSelect: handleIntervalSelect
			});
			if (sViewKey) {
				oTC.setViewKey(sViewKey);
			}

			return oTC;
		};

		var initPlanningCalendar = function(sID, sSearchFieldId, sButtonId) {
			var oTC = sap.ui.getCore().byId(sID);
			var oUIArea;
			if(oTC) {
				oTC.removeAllToolbarContent();
				oUIArea = oTC.getUIArea();
				oTC.destroy();
			}

			if(!sap.ui.getCore().byId(sSearchFieldId)) {
				createToolbarContent(sSearchFieldId, sButtonId);
			}

			oTC = createPlanningCalendar(sID, oSearchField1, oButton1);

			if(oUIArea) {
				oTC.placeAt(oUIArea.getId());
			}

			sap.ui.getCore().applyChanges();

			return oTC;

		};

		var _getListItem = function(oRow) {
			return sap.ui.getCore().byId(oRow.getId() + "-CLI");
		};

		var _getRowHeader = function(oRow) {
			var oListItem = _getListItem(oRow);

			return oListItem ? oListItem.getHeader() : null;
		};

		var _getRowTimeline = function(oRow) {
			var oListItem = _getListItem(oRow);

			return oListItem ? oListItem.getTimeline() : null;
		};

		var _switchToView = function(sViewName, oPC) {
			var oRb = sap.ui.getCore().getLibraryResourceBundle("sap.m"),
				mIntervalStringsMap = {},
				i = 0,
				sIntervalTypeDropdownId,
				sIntervalTypeDropdownLabelId,
				sViewI18Name,
				sErrMsg;

			mIntervalStringsMap[CalendarIntervalType.Hour] = "PLANNINGCALENDAR_HOURS";
			mIntervalStringsMap[CalendarIntervalType.Day] = "PLANNINGCALENDAR_DAYS";
			mIntervalStringsMap[CalendarIntervalType.Month] = "PLANNINGCALENDAR_MONTHS";
			mIntervalStringsMap[CalendarIntervalType.Week] = "PLANNINGCALENDAR_WEEK";
			mIntervalStringsMap[CalendarIntervalType.OneMonth] = "PLANNINGCALENDAR_ONE_MONTH";

			sViewI18Name = oRb.getText(mIntervalStringsMap[sViewName]);
			assert.ok(sViewI18Name, "There must be internationalized string corresponding to the viewName " + sViewName);

			sIntervalTypeDropdownId = oPC.getId() + "-IntType",
				sIntervalTypeDropdownLabelId = sIntervalTypeDropdownId + "-label";

			if (jQuery("#" + sIntervalTypeDropdownLabelId).text().toLowerCase() === sViewI18Name.toLowerCase()) {
				return;
			}
			qutils.triggerKeydown(sIntervalTypeDropdownId, "HOME");

			do {
				i++;
				if (jQuery("#" + sIntervalTypeDropdownLabelId).text().toLowerCase() == sViewI18Name.toLowerCase()) {
					qutils.triggerKeydown(sIntervalTypeDropdownId, "ENTER");
					return;
				}
				qutils.triggerKeydown(sIntervalTypeDropdownId, "ARROW_DOWN");
			} while (i < 5);

			sErrMsg = "Cannot switch to view " + sViewName;
			assert.ok(false, sErrMsg);
			throw sErrMsg;
		};

		var _switchToDate = function(oPC, oInterval, iDay, iMonth, iYear) {
			var sIntervalId = oInterval.getId(),
				bWizardUsesDaysPicker = (oPC.getViewKey() === "Days" || oPC.getViewKey() === "1 Week" || oPC.getViewKey() === "Hours"),
				sCalendarPickerId = sIntervalId + "--Cal",
				sCalendarPickerYearId = sCalendarPickerId + "--YP",
				sCalendarPickerMonthId = sCalendarPickerId + "--MP",
				sDate;

			qutils.triggerEvent("click", sIntervalId + "--Head-B1");

			if (iYear != undefined) {
				qutils.triggerEvent("click", sCalendarPickerId + "--Head-B2");
				$Date = jQuery("#" + sCalendarPickerYearId + "-y" + iYear + "0101");
				// click on Year button inside calendar picker
				$Date.focus();
				qutils.triggerKeyboardEvent($Date[0], jQuery.sap.KeyCodes.ENTER, false, false, false);
			}

			if (iMonth != undefined) {
				if (bWizardUsesDaysPicker) { //we want to choose month, but the day picker is opened. Click on the month button atop
					// click on Month button inside calendar picker
					qutils.triggerEvent("click", sCalendarPickerId + "--Head-B1");
				}

				// click on required month
				$Date = jQuery("#" + sCalendarPickerMonthId + "-m" + iMonth);
				$Date.focus();
				qutils.triggerKeyboardEvent($Date[0], jQuery.sap.KeyCodes.ENTER, false, false, false);
			}

			if (bWizardUsesDaysPicker && iDay != undefined) {
				// click on 14 of September
				sDate = sap.ui.core.format.DateFormat().getInstance({pattern: "yyyymmdd"}).format(new Date(iYear, iMonth, iDay));
				$Date = jQuery("#" + sCalendarPickerId + "--Month0-" + sDate);
				$Date.focus();
				qutils.triggerKeyboardEvent($Date[0], jQuery.sap.KeyCodes.ENTER, false, false, false);
			}
		};

	/*	var _switchToMonth = function(oPC, iMonth) {
			var oMonthPicker = oPC.getAggregation("table").getAggregation("infoToolbar").getContent()[1].getAggregation("monthPicker");
			oMonthPicker.setMonth(iMonth);
			oMonthPicker.fireSelect();
		};

		var _switchToYear = function(oPC, iYear) {
			var oYearPicker = oPC.getAggregation("table").getAggregation("infoToolbar").getContent()[1].getAggregation("yearPicker");
			oYearPicker.setYear(iYear);
			oYearPicker.fireSelect();
		};*/

		var _clickTodayButton = function(oPC) {
			var sTodayButtonId = _getTodayButton.call(this, oPC).getId();
			qutils.triggerEvent("tap", sTodayButtonId);
		};

		var _getTodayButton = function(oPC) {
			return sap.ui.getCore().byId(oPC.getId() + "-Today");
		};

		var _getChangeMonthButtonText = function(oPC) {
			return jQuery("#" + oPC.getId() + "-" + _getIntervalPrefix.call(this, oPC) + "--Head-B1").text();
		};

		//Verifies that given dates are "displayed" in the Planning Calendar
		//and month name(s) in the button is as expected
		var _assertDatesAreVisible = function(aDates, oPC, sMessagePrefix) {
			var sDaysSelector = oPC.getId() + "-" + _getIntervalId.call(this, oPC) + "-days",
				iAvailableDays = jQuery('#' + sDaysSelector).children().length,
				oFirstDate = aDates[0],
				oLastDate = aDates[aDates.length - 1],
				sExpectedDateRange = _formatDate.call(this, oFirstDate) + "-" + _formatDate.call(this, oLastDate),
				oMonthDateFormat = sap.ui.core.format.DateFormat.getDateInstance({pattern: "MMMM"}),
				oYearDateFormat = sap.ui.core.format.DateFormat.getDateInstance({pattern: "YYYY"}),
				oLocaleData = new sap.ui.core.LocaleData(sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale()),
				sIntervalPattern = oLocaleData.getIntervalPattern(),
				sExpectedMonthName,
				sExpectedYear;

			sMessagePrefix+= ": expected dates: " + sExpectedDateRange;

			assert.equal(iAvailableDays, aDates.length, sMessagePrefix + ": Planning Calendar should show certain amount of days: ");
			if (aDates.length >= 2 && oFirstDate.getMonth() !== oLastDate.getMonth()) {
				sExpectedMonthName =  sIntervalPattern.replace(/\{0\}/, oMonthDateFormat.format(oFirstDate)).replace(/\{1\}/, oMonthDateFormat.format(oLastDate));
			} else {
				sExpectedMonthName = oMonthDateFormat.format(oFirstDate);
			}

			sExpectedYear = oYearDateFormat.format(oLastDate);

			assert.equal(_getChangeMonthButtonText.call(this, oPC), sExpectedMonthName + " " + sExpectedYear, sMessagePrefix + ": Change month button should have certain text of " +
				sExpectedMonthName + ", current text: " + _getChangeMonthButtonText.call(this, oPC));

			aDates.forEach(function (oDate) {
				_assertDateIsVisible.call(this, oDate, oPC, sMessagePrefix);
			}.bind(this));
		};

		//Verifies that given Date is "displayed" in the Planning Calendar
		var _assertDateIsVisible = function(oDate, oPC, sMessagePrefix) {
			var that = this;

			function convertDate2DomId(oDate, sPrefix) {
				return sPrefix + "-" + oDate.getFullYear() + _padTo10.call(that, oDate.getMonth() + 1) + _padTo10.call(that, oDate.getDate());
			}

			var sDayId = convertDate2DomId(oDate, oPC.getId() + "-" + _getIntervalId.call(this, oPC));
			assert.equal(jQuery("#" + sDayId).length, 1, sMessagePrefix + ": Date " + _formatDate.call(this, oDate) + " should be visible (" + sDayId + ")");
		};

		//Verifies that given hour for given date is "displayed" in the Planning Calendar
		var _assertHourIsVisible = function(oDate, oPC, sMessagePrefix) {
			var that = this;

			function convertHourInDate2DomId(oDate, sPrefix) {
				return sPrefix + "-" + oDate.getFullYear() + _padTo10.call(that, oDate.getMonth() + 1) + _padTo10.call(that, oDate.getDate()) + _padTo10.call(that, oDate.getHours()) + "00";
			}

			var sHourInDayId = convertHourInDate2DomId(oDate, oPC.getId() + "-" + _getIntervalId.call(this, oPC));
			assert.equal(jQuery("#" + sHourInDayId).length, 1, sMessagePrefix + ": Hour " + _formatDateHour.call(this, oDate) + " should be visible (" + sHourInDayId + ")");
		};

		var _assertHoursAreVisible = function(aDates, oPC, sMessagePrefix) {
			var iAvailableDays = jQuery('#' + oPC.getId() + "-"+ _getIntervalId.call(this, oPC) + "-times").children().length,
				sExpectedDateRange = _formatDateHour.call(this, aDates[0]) + "-" + _formatDateHour.call(this, aDates[aDates.length-1]);

			sMessagePrefix+= ": expected hours: " + sExpectedDateRange;
			assert.equal(iAvailableDays, aDates.length, sMessagePrefix + ": Planning Calendar should show certain amount of hours: ");

			aDates.forEach(function (oDate) {
				_assertHourIsVisible.call(this, oDate, oPC, sMessagePrefix);
			}.bind(this));
		};

		var _assertFocus = function(oTarget) {
			assert.strictEqual(document.activeElement.id, oTarget && oTarget.id, "Element with id: " + oTarget.id + " should be focused");
		};

		var _formatDate = function(oDate) {
			return sap.ui.core.format.DateFormat.getDateInstance({pattern: "dd.MM.yyyy"}).format(oDate);
		};

		var _formatDateHour = function(oDate) {
			return sap.ui.core.format.DateFormat.getDateInstance({pattern: "dd.MM.yyyy hh:mm"}).format(oDate);
		};

		var _padTo10 = function(i) {
			return (i > 9 ? i : "0" + i);
		};

		var _getIntervalId = function(oPC) {
			return _getIntervalPrefix.call(this, oPC) + "--" + _getIntervalSuffix.call(this, oPC);
		};

		var _getIntervalPrefix = function(oPC) {
			switch (oPC.getViewKey()) {
				case CalendarIntervalType.Hour:
					return "TimeInt";
					break;
				case CalendarIntervalType.Day:
					return "DateInt";
					break;
				case CalendarIntervalType.Week:
					return "WeekInt";
					break;
				case CalendarIntervalType.Month:
					return "MonthInt";
					break;
				case CalendarIntervalType.OneMonth:
					return "OneMonthInt";
					break;
				default:
					throw "Unknown viewKey:" + oPC.getViewKey();
			}
		};

		var _getIntervalSuffix = function(oPC) {
			switch (oPC.getViewKey()) {
				case CalendarIntervalType.Hour:
					return "TimesRow";
					break;
				case CalendarIntervalType.Day:
					return "Month0";
					break;
				case CalendarIntervalType.Week:
					return "Month0";
					break;
				case CalendarIntervalType.Month:
					return "MonthsRow";
					break;
				case CalendarIntervalType.OneMonth:
					return "Month0";
					break;
				default:
					throw "Unknown viewKey:" + oPC.getViewKey();
			}
		};

		var _navBackward = function(oPC) {
			var sIdBackButton = oPC.getId() + "-" +  _getIntervalPrefix.call(this, oPC) + "--Head-prev";
			qutils.triggerEvent("click", sIdBackButton);
		};

		var _navForward = function(oPC) {
			var  sIdForwardButton = oPC.getId() + "-" +  _getIntervalPrefix.call(this, oPC) + "--Head-next";
			qutils.triggerEvent("click", sIdForwardButton);
		};

		var _navFocusPrev = function(oTarget) {
			qutils.triggerKeydown(oTarget.id, "ARROW_LEFT");
			sap.ui.getCore().applyChanges();
			return this.oPC2IntervalRow._oItemNavigation.getFocusedDomRef();
		};

		var _navFocusNext = function(oTarget) {
			qutils.triggerKeydown(oTarget.id, "ARROW_RIGHT");
			sap.ui.getCore().applyChanges();
			return this.oPC2IntervalRow._oItemNavigation.getFocusedDomRef();
		};

		/**
		 * Creates special dates, based on the view type (@CalendarIntervalType) by using CalendarDayType in the range
		 * provided by [@iTypeBegin, @iTypeEnd].
		 * @returns For Hours View: Special dates for as mucch hours as the range of types provides, each with 59 mins.
		 * For Days, 1Week and 1 Month -
		 **/
		function _createSpecialDates(iTypeBegin, iTypeEnd, sCalendarIntervalType, oStartDate) {
			var sTypeName = "",
				oSpecialDateStart,
				oSpecialDateEnd,
				aResult = [];

			oSpecialDateStart = new Date(oStartDate.getTime());
			oSpecialDateEnd = createEndDate(sCalendarIntervalType, oSpecialDateStart);

			for (var i = iTypeBegin; i <= iTypeEnd; i++) {
				sTypeName = i.toString();
				sTypeName = sTypeName.length === 1 ? "0" + sTypeName : sTypeName;
				sTypeName = "Type" + sTypeName;
				if (!CalendarDayType[sTypeName]) {
					throw "Test error: invalid type " + sTypeName
				}
				sTypeName = CalendarDayType[sTypeName];
				aResult.push(new DateTypeRange({
					type: sTypeName,
					startDate: new Date(oSpecialDateStart.getTime()),
					endDate: new Date(oSpecialDateEnd.getTime()),
				}));

				oSpecialDateStart = getNextStartDate(sCalendarIntervalType, oSpecialDateStart);
				oSpecialDateEnd = createEndDate(sCalendarIntervalType, oSpecialDateStart);
			}

			function getNextStartDate(sCalendarIntervalType, oDate1) {
				var oTempDate = new Date(oDate1.getTime());

				switch (sCalendarIntervalType) {
					case CalendarIntervalType.Hour:
					{
						oTempDate.setHours(oTempDate.getHours() + 1);
						break;
					}
					case CalendarIntervalType.Day:
					case CalendarIntervalType.Week:
					case CalendarIntervalType.OneMonth:
					{
						oTempDate.setDate(oTempDate.getDate() + 1);
						break;
					}
					case CalendarIntervalType.Month:
					{
						oTempDate.setMonth(oTempDate.getMonth() + 1);
						break;
					}
					default: throw "Invalid CalendarIntervalType: " + sCalendarIntervalType;
				}
				return oTempDate;
			}
			function createEndDate(sCalendarIntervalType, oStartDate) {
				var oEndDate = new Date(oStartDate.getTime());

				switch (sCalendarIntervalType) {
					case CalendarIntervalType.Hour:
					{
						oEndDate.setMinutes(59);
						break;
					}
					case CalendarIntervalType.Day:
					case CalendarIntervalType.Week:
					case CalendarIntervalType.OneMonth:
					{
						oEndDate.setHours(23, 59, 59);
						break;
					}
					case CalendarIntervalType.Month:
					{
						oEndDate.setDate(getLastMonthDate(oStartDate));
						break;
					}
					default: throw "Invalid CalendarIntervalType: " + sCalendarIntervalType;
				}
				return oEndDate;
			}

			function getLastMonthDate(oDate) {
				var oTempDate = new Date(oDate.getTime());
				oTempDate.setMonth(oTempDate.getMonth() + 1);
				oTempDate.setDate(0);
				return oTempDate.getDate();
			}
			return aResult;
		};


		var _createAppointmentsOfTypes = function(iTypeBegin, iTypeEnd, oStartDate) {
			var sTypeName = "",
				oAppStartDate,
				oAppEndDate,
				aResult = [];

			oAppStartDate = new Date(oStartDate.getTime());
			oAppEndDate = new Date(oAppStartDate.getTime());
			oAppEndDate.setMinutes(oAppStartDate.getMinutes() + 10);  //appointments duration

			for (var i = iTypeBegin; i <= iTypeEnd; i++) {
				sTypeName = i.toString();
				sTypeName = sTypeName.length === 1 ? "0" + sTypeName : sTypeName;
				sTypeName = "Type" + sTypeName;
				if (!CalendarDayType[sTypeName]) {
					throw "Test error: invalid type " + sTypeName
				}
				sTypeName = CalendarDayType[sTypeName];
				aResult.push(new CalendarAppointment({
					type: sTypeName,
					startDate: new Date(oAppStartDate.getTime()),
					endDate: new Date(oAppEndDate.getTime())
				}));
				oAppStartDate.setMinutes(oAppStartDate.getMinutes() + 30);// 2appointments per hour
				oAppEndDate = new Date(oAppStartDate.getTime());
				oAppEndDate.setMinutes(oAppStartDate.getMinutes() + 10); //appointments duration
			}
			return aResult;
		};

		var oSearchField1, oButton1;
		createToolbarContent("SF1", "B1");
		var oPC1 = createPlanningCalendar("PC1", oSearchField1, oButton1);
		oPC1.placeAt("uiArea1");

		qutils.delayTestStart();

		QUnit.module("internal controls");

		QUnit.test("PlanningCalendarRow", function(assert) {
			var oRow = sap.ui.getCore().byId("PC1-Row1");
			assert.ok(_getListItem(oRow), "ColumnListItem exist");
			assert.equal(_getListItem(oRow).getCells().length, 2, "row has 2 columns")

			var oRowHeader = _getRowHeader(oRow);
			assert.ok(oRowHeader, "row header exist");
			assert.equal(oRowHeader.getTitle(), oRow.getTitle(), "row header Title");
			assert.equal(oRowHeader.getIcon(), oRow.getIcon(), "row header icon");
			assert.equal(oRowHeader.getDescription(), oRow.getText(), "row header Text");

			assert.ok(_getRowTimeline(oRow), "CalendarRow exist");
			assert.ok(_getRowTimeline(oRow) instanceof sap.ui.unified.CalendarRow, "CalendarRow control");

			var oTimeline = _getRowTimeline(oRow);
			assert.ok(!oTimeline.getNonWorkingDays(), "Row1: CalendarRow - nonWorkingDays");
			assert.ok(!oTimeline.getNonWorkingHours(), "Row1: CalendarRow - nonWorkingHours");

			oRow = sap.ui.getCore().byId("PC1-Row2");
			oTimeline = _getRowTimeline(oRow);
			assert.ok(jQuery.sap.equal(oTimeline.getNonWorkingDays(), [2, 3]), "Row2: CalendarRow - nonWorkingDays");
			assert.ok(jQuery.sap.equal(oTimeline.getNonWorkingHours(), [11, 12]), "Row2: CalendarRow - nonWorkingHours");
		});

		QUnit.test("PlanningCalendarRow's customData is used", function () {
			// Prepare
			var oCustomData = new sap.ui.core.CustomData();

			// Act
			var oPCRow = new sap.m.PlanningCalendarRow({
				customData: oCustomData
			});
			var oPC = new sap.m.PlanningCalendar();
			oPC.addRow(oPCRow);

			// Assert
			assert.deepEqual(_getListItem(oPCRow).getCustomData(), oPCRow.getCustomData(),
				"getCustomData of PlanningCalendarRow is used by internal ColumnListItem");

		});

		QUnit.test("Table", function(assert) {
			var oTable = sap.ui.getCore().byId("PC1-Table");

			assert.equal(oTable.getColumns().length, 2, "Table columns");
			assert.equal(oTable.getItems().length, 2, "Table rows");
			assert.equal(oTable.getItems()[0].getId(), "PC1-Row1-CLI", "Table row1 is first row");

			assert.ok(oTable.getHeaderToolbar(), "HeaderToolbar exist");
			assert.equal(oTable.getHeaderToolbar().getContent().length, 2, "HeaderToolbar items");
			assert.equal(oTable.getHeaderToolbar().getContent()[0].getId(), "SF1", "HeaderToolbar: searchField exist");
			assert.equal(oTable.getHeaderToolbar().getContent()[1].getId(), "B1", "HeaderToolbar: application button exist");

			assert.ok(oTable.getInfoToolbar(), "InfoToolbar exist");
			assert.equal(oTable.getInfoToolbar().getContent().length, 2, "InfoToolbar items");
			assert.equal(oTable.getInfoToolbar().getContent()[0].getId(), "PC1-CalHead", "InfoToolbar: Calendar head exist");
			assert.equal(oTable.getInfoToolbar().getContent()[1].getId(), "PC1-TimeInt", "InfoToolbar: CalendarTimeInterval exist");

			var oCalHead = sap.ui.getCore().byId("PC1-CalHead");
			assert.equal(oCalHead.getToolbar().getId(), "PC1-HeaderToolbar", "Calendar head: Toolbar exist");

			var oHeaderToolbar = sap.ui.getCore().byId("PC1-HeaderToolbar");
			assert.equal(oHeaderToolbar.getContent().length, 2, "HeaderToolbar items");
			assert.equal(oHeaderToolbar.getContent()[0].getId(), "PC1-IntType", "Calendar head Toolbar: IntervalType-select exist");
			assert.equal(oHeaderToolbar.getContent()[1].getId(), "PC1-Today", "Calendar head Toolbar: today button exist");
		});

		QUnit.module("rendering");

		QUnit.test("table", function(assert) {
			var oTable = sap.ui.getCore().byId("PC1-Table");

			assert.ok(oTable.getDomRef(), "Table rendered");
			assert.ok(jQuery("#PC1-Row1-Head").get(0), "Row1 Header rendered");
			assert.ok(jQuery("#PC1-Row1-CalRow").get(0), "Row1 CalendarRow rendered");
			assert.ok(jQuery("#PC1-Row2-Head").get(0), "Row2 Header rendered");
			assert.ok(jQuery("#PC1-Row2-CalRow").get(0), "Row2 CalendarRow rendered");

			assert.ok(jQuery("#PC1-Toolbar").get(0), "Table header toolbar rendered");
			assert.ok(jQuery("#SF1").get(0), "SearchField rendered");
			assert.ok(jQuery("#B1").get(0), "application button rendered");

			assert.ok(jQuery("#PC1-InfoToolbar").get(0), "Table info toolbar rendered");
			assert.ok(jQuery("#PC1-CalHead").get(0), "Calendar header rendered");
			assert.ok(jQuery("#PC1-HeaderToolbar").get(0), "Calendar header toolbar rendered");
			assert.ok(jQuery("#PC1-IntType").get(0), "IntervalType select rendered");
			assert.ok(jQuery("#PC1-Today").get(0), "Today button rendered");
			assert.ok(jQuery("#PC1-TimeInt").get(0), "CalendarTimeInterval rendered");
		});

		QUnit.test("Appointments", function(assert) {
			assert.ok(jQuery("#PC1-R1H1").get(0), "Row1: IntervalHeader1 rendered");
			assert.ok(jQuery("#PC1-R1A1").get(0), "Row1: Appointment1 rendered");
			assert.ok(!jQuery("#PC1-R1A2").get(0), "Row1: Appointment2 not rendered");
			assert.ok(!jQuery("#PC1-R1A3").get(0), "Row1: Appointment3 not rendered");
			assert.ok(!jQuery("#PC1-R1A4").get(0), "Row1: Appointment4 not rendered");
			assert.ok(!jQuery("#PC1-R2H1").get(0), "Row2: IntervalHeader1 rendered");
			assert.ok(jQuery("#PC1-R2A1").get(0), "Row2: Appointment1 rendered");
		});

		function _getCssColorProperty (oJQuerySet, sCssPropertyName) {
			return /rgb\(\s*(\d+),\s*(\d+),\s*(\d+)\s*\)/.exec(oJQuerySet.css(sCssPropertyName));
		}

		function _getBorderColorPropertyName () {
			if (sap.ui.getCore().getConfiguration().getRTL()) {
				return "border-right-color";
			}
			return "border-left-color";
		}

		function _checkColor (oExtractedRGB, oExpectedRGB, sLabel) {
			assert.equal(oExtractedRGB[1], oExpectedRGB.R, sLabel + " (RED)");
			assert.equal(oExtractedRGB[2], oExpectedRGB.G, sLabel + " (GREEN)");
			assert.equal(oExtractedRGB[3], oExpectedRGB.B, sLabel + " (BLUE)");
		}

		QUnit.test("Check custom colors in Appointments", function (assert) {
			var oAppointment$ = jQuery("#PC1-R1A1");
			assert.ok(!oAppointment$.hasClass("sapUiCalendarAppType01"), "Row1: Color setting prevents default formatting");
			var oBorderColor = _getCssColorProperty(oAppointment$, _getBorderColorPropertyName());
			assert.ok(oBorderColor, "Row1: Appointment1 has a border color");
			_checkColor(oBorderColor, {R: 255, G: 0, B: 255}, "Row1: Appointment1 has the right custom border color");
		});

		QUnit.test("Check custom colors in IntervalHeader", function (assert) {
			var oIntervalHeader$ = jQuery("#PC1-R1H1");
			var oBorderColor;
			assert.ok(!oIntervalHeader$.hasClass("sapUiCalendarRowAppsIntHeadType02"), "Row2: Color setting prevents default formatting");
			oBorderColor = _getCssColorProperty(oIntervalHeader$, _getBorderColorPropertyName());
			assert.ok(oBorderColor, "Row2: IntervalHeader1 has a border color");
			_checkColor(oBorderColor, {R: 255, G:0, B: 0}, "Row2: IntervalHeader1 has the right custom border color");
		});

		QUnit.module("rendering - Hours View", {
			beforeEach: function () {
				this.oPC = createPlanningCalendar("PC3", new sap.m.SearchField(), new sap.m.Button());

			},
			afterEach: function () {
				this.oPC.destroy();
			},
			prepareTest: function (sTargetElementId) {
				this.oPC.placeAt(sTargetElementId);
				sap.ui.getCore().applyChanges();
			}
		});
		/*
		 2675
		 */
		QUnit.test("checks for the number of hours on small screen", function(assert) {
			//Arrange
			this.prepareTest("smallUiArea");
			//Act
			_switchToView(CalendarIntervalType.Hour, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), 600, "width is set to 600px"); // this is only for check that width of the screen is set to 600 px
			assert.equal(jQuery("#PC3-TimeInt--TimesRow-times").find('.sapUiCalItem').length , 6, "hours are 6");
		});
		/*
		 2683
		 */
		QUnit.test("checks for the number of hours on big screen", function(assert) {
			//Arrange
			this.prepareTest("bigUiArea");
			//Act
			_switchToView(CalendarIntervalType.Hour, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "1024", "width is set to 1024 px"); // this is only for check that width of the screen is set to 1024 px
			assert.equal(jQuery("#PC3-TimeInt--TimesRow-times").find('.sapUiCalItem').length , 12, "hours are 12");
		});
		QUnit.module("rendering - Days View", {
			beforeEach: function () {
				this.oPC = createPlanningCalendar("PC3", new sap.m.SearchField(), new sap.m.Button());

			},
			afterEach: function () {
				this.oPC.destroy();
			},
			prepareTest: function (sTargetElementId) {
				this.oPC.placeAt(sTargetElementId);
				sap.ui.getCore().applyChanges();
			}
		});
		/*
		 2678
		 */
		QUnit.test("checks for the number of days on small screen on Days View", function(assert) {
			//Arrange
			this.prepareTest("smallUiArea");
			//Act
			_switchToView(CalendarIntervalType.Day, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "600", "width is set to 600px"); // this is only for check that width of the screen is set to 600 px
			assert.equal(jQuery("#PC3-DateInt--Month0-days .sapUiCalItem").length , 7, "days are 7");
		});
		/*
		 2677
		 */
		QUnit.test("checks for the number of days on big screen on Days View", function(assert) {
			//Arrange
			this.prepareTest("bigUiArea");
			//Act
			_switchToView(CalendarIntervalType.Day, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "1024", "width is set to 1024 px"); // this is only for check that width of the screen is set to 1024 px
			assert.equal(jQuery("#PC3-DateInt--Month0-days .sapUiCalItem").length , 14, "days are 14");
		});
		QUnit.module("rendering - Months View", {
			beforeEach: function () {
				this.oPC = createPlanningCalendar("PC3", new sap.m.SearchField(), new sap.m.Button());
			},
			afterEach: function () {
				this.oPC.destroy();
			},
			prepareTest: function (sTargetElementId) {
				this.oPC.placeAt(sTargetElementId);
				sap.ui.getCore().applyChanges();
			}
		});
		/*
		 2688
		 */
		QUnit.test("checks for the number of months on very small screen", function(assert) {
			//Arrange
			this.prepareTest("verySmallUiArea");
			//Act
			_switchToView(CalendarIntervalType.Month, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "300", "width is set to 300px"); // this is only for check that width of the screen is set to 300 px
			assert.equal(jQuery("#PC3-MonthInt--MonthsRow-months .sapUiCalItem").length , 3, "months are 3");
		});
		/*
		 2687
		 */
		QUnit.test("checks for the number of months on small screen", function(assert) {
			//Arrange
			this.prepareTest("smallUiArea");
			//Act
			_switchToView(CalendarIntervalType.Month, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "600", "width is set to 600px"); // this is only for check that width of the screen is set to 600 px
			assert.equal(jQuery("#PC3-MonthInt--MonthsRow-months .sapUiCalItem").length , 6, "months are 6");
		});
		/*
		 2686
		 */
		QUnit.test("checks for the number of months on big screen", function(assert) {
			//Arrange
			this.prepareTest("bigUiArea");
			//Act
			_switchToView(CalendarIntervalType.Month, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "1024", "width is set to 1024 px"); // this is only for check that width of the screen is set to 1024 px
			assert.equal(jQuery("#PC3-MonthInt--MonthsRow-months .sapUiCalItem").length , 12, "months are 12");
		});
		QUnit.module("rendering - 1Week View", {
			beforeEach: function () {
				this.oPC = createPlanningCalendar("PC3", new sap.m.SearchField(), new sap.m.Button());

			},
			afterEach: function () {
				this.oPC.destroy();
			},
			prepareTest: function (sTargetElementId) {
				this.oPC.placeAt(sTargetElementId);
				sap.ui.getCore().applyChanges();
			}
		});
		/*
		 2696
		 */
		QUnit.test("checks for the number of days on small screen on 1Week View", function(assert) {
			//Arrange
			this.prepareTest("smallUiArea");
			//Act
			_switchToView(CalendarIntervalType.Week, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "600", "width is set to 600px"); // this is only for check that width of the screen is set to 600 px
			assert.equal(jQuery("#PC3-WeekInt--Month0-days .sapUiCalItem").length , 7, "days are 7");
		});
		/*
		 2695
		 */
		QUnit.test("checks for the number of days on big screen on 1Week View", function(assert) {
			//Arrange
			this.prepareTest("bigUiArea");
			//Act
			_switchToView(CalendarIntervalType.Week, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "1024", "width is set to 1024 px");  // this is only for check that width of the screen is set to 1024 px
			assert.equal(jQuery("#PC3-WeekInt--Month0-days .sapUiCalItem").length , 7, "days are 7");
		});
		QUnit.module("rendering - 1Month View", {
			beforeEach: function () {
				this.oPC = createPlanningCalendar("PC3", new sap.m.SearchField(), new sap.m.Button());

			},
			afterEach: function () {
				this.oPC.destroy();
			},
			prepareTest: function (sTargetElementId) {
				this.oPC.placeAt(sTargetElementId);
				sap.ui.getCore().applyChanges();
			}
		});
		/*
		 2703
		 */
		QUnit.test("checks for the number of days on small screen", function(assert) {
			//Arrange
			this.prepareTest("smallUiArea");
			//Act
			_switchToView(CalendarIntervalType.OneMonth, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "600", "width is set to 600px"); // this is only for check that width of the screen is set to 600 px
			assert.equal(jQuery("#PC3-OneMonthInt--Month0-days .sapUiCalItem").length , 35, "days are 35");
		});
		/*
		 2702
		 */
		QUnit.test("checks for the number of days on big screen", function(assert) {
			//Arrange
			this.prepareTest("bigUiArea");
			//Act
			_switchToView(CalendarIntervalType.OneMonth, this.oPC);
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.$().outerWidth(), "1024", "width is set to 1024 px"); // this is only for check that width of the screen is set to 1024 px
			assert.equal(jQuery("#PC3-OneMonthInt--Month0-days .sapUiCalItem").length , 31, "days are 31");
		});


		QUnit.module("Setters");

		QUnit.test("startDate", function(assert) {
			var oExpectedDate = new Date("2015", "0", "1", "08", "00");
			var iStartTime = oPC1.getStartDate().getTime();
			assert.equal(oExpectedDate.getTime(), iStartTime, "Start date is OK");
			assert.equal(sap.ui.getCore().byId("PC1-TimeInt").getStartDate().getTime(), iStartTime, "CalendarTimeInterval Start date");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getStartDate().getTime(), iStartTime, "CalendarRow1 Start date");
			assert.equal(sap.ui.getCore().byId("PC1-Row2-CalRow").getStartDate().getTime(), iStartTime, "CalendarRow2 Start date");

			oExpectedDate = new Date("2015", "0", "1", "07", "00");
			oPC1.setStartDate(new Date("2015", "0", "1", "07", "00"));
			sap.ui.getCore().applyChanges();
			iStartTime = oPC1.getStartDate().getTime();
			assert.equal(oExpectedDate.getTime(), iStartTime, "Start date is OK");
			assert.equal(sap.ui.getCore().byId("PC1-TimeInt").getStartDate().getTime(), iStartTime, "CalendarTimeInterval Start date");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getStartDate().getTime(), iStartTime, "CalendarRow1 Start date");
			assert.equal(sap.ui.getCore().byId("PC1-Row2-CalRow").getStartDate().getTime(), iStartTime, "CalendarRow2 Start date");
			assert.ok(jQuery("#PC1-R1A1").get(0), "Row1: Appointment1 still rendered");
			assert.ok(jQuery("#PC1-R1A2").get(0), "Row1: Appointment2 now rendered");
		});

		QUnit.test("viewKey", function(assert) {
			var sViewKey = oPC1.getViewKey();
			assert.equal(sViewKey, CalendarIntervalType.Hour, "Default ViewKey")
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getIntervalType(), CalendarIntervalType.Hour, "CalendarRow1 intervalType");
			assert.equal(sap.ui.getCore().byId("PC1-Row2-CalRow").getIntervalType(), CalendarIntervalType.Hour, "CalendarRow2 intervalType");
			assert.ok(!sap.ui.getCore().byId("PC1-DateInt"), "CalendarDateInterval control not exist");
			assert.ok(!sap.ui.getCore().byId("PC1-MonthInt"), "CalendarMonthInterval control not exist");

			oPC1.setViewKey(CalendarIntervalType.Day);
			sap.ui.getCore().applyChanges();
			sViewKey = oPC1.getViewKey();
			assert.equal(sViewKey, CalendarIntervalType.Day, "Default ViewKey");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getIntervalType(), CalendarIntervalType.Day, "CalendarRow1 intervalType");
			assert.equal(sap.ui.getCore().byId("PC1-Row2-CalRow").getIntervalType(), CalendarIntervalType.Day, "CalendarRow2 intervalType");
			assert.ok(sap.ui.getCore().byId("PC1-TimeInt"), "CalendarTimeInterval control still exist");
			assert.ok(sap.ui.getCore().byId("PC1-DateInt"), "CalendarDateInterval control now exist");
			assert.ok(!sap.ui.getCore().byId("PC1-MonthInt"), "CalendarMonthInterval control not exist");
			assert.ok(!jQuery("#PC1-TimeInt").get(0), "CalendarTimeInterval not rendered");
			assert.ok(jQuery("#PC1-DateInt").get(0), "CalendarDateInterval rendered");

			oPC1.setViewKey(CalendarIntervalType.Month);
			sap.ui.getCore().applyChanges();
			sViewKey = oPC1.getViewKey();
			assert.equal(sViewKey, CalendarIntervalType.Month, "Default ViewKey");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getIntervalType(), CalendarIntervalType.Month, "CalendarRow1 intervalType");
			assert.equal(sap.ui.getCore().byId("PC1-Row2-CalRow").getIntervalType(), CalendarIntervalType.Month, "CalendarRow2 intervalType");
			assert.ok(sap.ui.getCore().byId("PC1-TimeInt"), "CalendarTimeInterval control still exist");
			assert.ok(sap.ui.getCore().byId("PC1-DateInt"), "CalendarDateInterval control now exist");
			assert.ok(sap.ui.getCore().byId("PC1-MonthInt"), "CalendarMonthInterval control not exist");
			assert.ok(!jQuery("#PC1-TimeInt").get(0), "CalendarTimeInterval not rendered");
			assert.ok(!jQuery("#PC1-DateInt").get(0), "CalendarDateInterval not rendered");
			assert.ok(jQuery("#PC1-MonthInt").get(0), "CalendarMonthInterval rendered");
		});

		QUnit.test("singleSelection", function(assert) {
			var oTable = sap.ui.getCore().byId("PC1-Table");
			assert.ok(oPC1.getSingleSelection(), "Single selection is default");
			assert.equal(oTable.getMode(), sap.m.ListMode.SingleSelectMaster, "Table selection mode");
			assert.ok(!sap.ui.getCore().byId("PC1-All"), "Select All CheckBox not exits")

			oPC1.setSingleSelection(false);
			sap.ui.getCore().applyChanges();
			assert.ok(!oPC1.getSingleSelection(), "Single selection not set");
			assert.equal(oTable.getMode(), sap.m.ListMode.MultiSelect, "Table selection mode");
			assert.ok(sap.ui.getCore().byId("PC1-All"), "Select All CheckBox exits")
			assert.ok(jQuery("#PC1-All").get(0), "Select All CheckBox rendered");

			oPC1.setSingleSelection(true);
			sap.ui.getCore().applyChanges();
			assert.ok(sap.ui.getCore().byId("PC1-All"), "Select All CheckBox stillexits")
			assert.ok(!jQuery("#PC1-All").get(0), "Select All CheckBox not rendered");
		});

		QUnit.test("width", function(assert) {
			assert.ok(!oPC1.getWidth(), "no width set ad default");
			var sStyle = oPC1.$().attr("style") || "";
			assert.ok(sStyle.search("width") < 0, "no width set on DOM")

			oPC1.setWidth("90%");
			sap.ui.getCore().applyChanges();
			var sStyle = oPC1.$().attr("style") || "";
			var aTest = sStyle.match(/width:(\s?)(\d+(.?)(\d+))/);
			var iWidth = aTest? aTest[2] : 0;
			assert.equal(iWidth, 90 + "", "width set on DOM");
		});

		QUnit.test("height", function(assert) {
			assert.ok(!oPC1.getHeight(), "no height set ad default");
			var sStyle = oPC1.$().attr("style") || "";
			assert.ok(sStyle.search("height") < 0, "no height set on DOM")

			oPC1.setHeight("90%");
			sap.ui.getCore().applyChanges();
			var sStyle = oPC1.$().attr("style") || "";
			var aTest = sStyle.match(/height:(\s?)(\d+(.?)(\d+))/);
			var iheight = aTest? aTest[2] : 0;
			assert.equal(iheight, 90 + "", "height set on DOM");
		});

		QUnit.test("showIntervalHeaders", function(assert) {
			assert.ok(oPC1.getShowIntervalHeaders(), "ShowIntervalHeaders is enabled by default");
			assert.ok(oPC1.getShowEmptyIntervalHeaders(), "ShowEmptyIntervalHeaders is enabled by default");
			var aRows = oPC1.getRows();
			for(var i = 0; i < aRows.length; i++) {
				assert.ok(_getRowTimeline(aRows[i]).getShowIntervalHeaders(), "Row " + i + ": ShowIntervalHeaders set");
				assert.ok(_getRowTimeline(aRows[i]).getShowEmptyIntervalHeaders(), "Row " + i + ": ShowEmptyIntervalHeaders set");
			}

			oPC1.setShowIntervalHeaders(false);
			oPC1.setShowEmptyIntervalHeaders(false);
			sap.ui.getCore().applyChanges();
			for(var i = 0; i < aRows.length; i++) {
				assert.ok(!_getRowTimeline(aRows[i]).getShowIntervalHeaders(), "Row " + i + ": ShowIntervalHeaders not set");
				assert.ok(!_getRowTimeline(aRows[i]).getShowEmptyIntervalHeaders(), "Row " + i + ": ShowEmptyIntervalHeaders not set");
			}

			oPC1.setShowIntervalHeaders(true);
			oPC1.setShowEmptyIntervalHeaders(true);
			sap.ui.getCore().applyChanges();
		});

		QUnit.test("groupAppointmentsMode", function (assert) {
			//Assert: default value
			assert.equal(oPC1.getGroupAppointmentsMode(), GroupAppointmentsMode.Collapsed, "GroupAppointmentsMode is set to 'Collapsed' by default");
			var aRows = oPC1.getRows();
			for(var i = 0; i < aRows.length; i++) {
				assert.ok(_getRowTimeline(aRows[i]).getGroupAppointmentsMode(), "CalendarRow " + i + ": GroupAppointmentsMode is set to 'Collapsed'");
			}

			// Act
			oPC1.setGroupAppointmentsMode(GroupAppointmentsMode.Expanded);
			sap.ui.getCore().applyChanges();
			// Assert
			assert.equal(oPC1.getGroupAppointmentsMode(), GroupAppointmentsMode.Expanded, "GroupAppointmentsMode is set to 'Expanded'");
			for(var i = 0; i < aRows.length; i++) {
				assert.equal(_getRowTimeline(aRows[i]).getGroupAppointmentsMode(), GroupAppointmentsMode.Expanded, "CalendarRow " + i + ": GroupAppointmentsMode is set to 'Expanded'");
			}

			// Cleanup
			oPC1.setGroupAppointmentsMode(GroupAppointmentsMode.Collapsed);
			sap.ui.getCore().applyChanges();
		});

		QUnit.test("appointmentsReducedHeight", function(assert) {
			assert.ok(!oPC1.getAppointmentsReducedHeight(), "AppointmentsReducedHeight is disabled by default");
			var aRows = oPC1.getRows();
			for(var i = 0; i < aRows.length; i++) {
				assert.ok(!_getRowTimeline(aRows[i]).getAppointmentsReducedHeight(), "Row " + i + ": AppointmentsReducedHeight not set");
			}

			oPC1.setAppointmentsReducedHeight(true);
			sap.ui.getCore().applyChanges();
			for(var i = 0; i < aRows.length; i++) {
				assert.ok(_getRowTimeline(aRows[i]).getAppointmentsReducedHeight(), "Row " + i + ": AppointmentsReducedHeight set");
			}

			oPC1.setAppointmentsReducedHeight(false);
			sap.ui.getCore().applyChanges();
		});

		QUnit.test("appointmentsVisualization", function(assert) {
			assert.equal(oPC1.getAppointmentsVisualization(), sap.ui.unified.CalendarAppointmentVisualization.Standard, "AppointmentVisualization default set");
			var aRows = oPC1.getRows();
			for(var i = 0; i < aRows.length; i++) {
				assert.equal(_getRowTimeline(aRows[i]).getAppointmentsVisualization(), sap.ui.unified.CalendarAppointmentVisualization.Standard, "Row " + i + ": AppointmentVisualization default set");
			}

			oPC1.setAppointmentsVisualization(sap.ui.unified.CalendarAppointmentVisualization.Filled);
			sap.ui.getCore().applyChanges();
			for(var i = 0; i < aRows.length; i++) {
				assert.equal(_getRowTimeline(aRows[i]).getAppointmentsVisualization(), sap.ui.unified.CalendarAppointmentVisualization.Filled, "Row " + i + ": AppointmentVisualization Filled set");
			}

			oPC1.setAppointmentsVisualization(sap.ui.unified.CalendarAppointmentVisualization.Standard);
			sap.ui.getCore().applyChanges();
		});

		QUnit.test("showRowHeaders", function(assert) {
			function getAppointmentsColumn() {
				return oPC1.getAggregation("table").getColumns()[1];
			}
			//Assert
			assert.ok(oPC1.getShowRowHeaders(), "ShowRowHeaders is enabled by default");
			assert.equal(getAppointmentsColumn().getDemandPopin(), true, "By Default appointments column is in Popin mode");
			assert.equal(getAppointmentsColumn().getMinScreenWidth().toLowerCase(), sap.m.ScreenSize.Desktop.toLowerCase(),
					"By Default appointments column has minScreenWidth set to sap.m.ScreenSize.Desktop");

			//Act
			oPC1.setShowRowHeaders(false);
			sap.ui.getCore().applyChanges();

			//Assert
			assert.ok(!jQuery("#PC1-Row1-Head").is(":visible"), "Row1 Header not visible");
			assert.equal(getAppointmentsColumn().getDemandPopin(), false, "If showRowHeaders is false, appointments Column is NOT in Popin mode");
			assert.equal(getAppointmentsColumn().getMinScreenWidth(), "",
					"If showRowHeaders is false appointments column has minScreenWidth is empty");

			//Act
			oPC1.setShowRowHeaders(true);
			sap.ui.getCore().applyChanges();

			//Assert
			assert.ok(jQuery("#PC1-Row1-Head").is(":visible"), "Row1 Header visible");
			assert.equal(getAppointmentsColumn().getDemandPopin(), true, "If showRowHeaders is set to true, appointments column is in Popin mode");
			assert.equal(getAppointmentsColumn().getMinScreenWidth().toLowerCase(), sap.m.ScreenSize.Desktop.toLowerCase(),
					"If showRowHeaders is set to true, appointments column has minScreenWidth set to sap.m.ScreenSize.Desktop");
		});

		QUnit.test("noDataText", function(assert) {
			var oTable = sap.ui.getCore().byId("PC1-Table");
			assert.ok(!oPC1.getNoDataText(), "noDataText empty by default");
			assert.ok(!oTable.getProperty("noDataText"), "noDataText of table empty by default"); // use getProperty("noDataText") because getter is overwritten in ListBase

			oPC1.setNoDataText("Test");
			sap.ui.getCore().applyChanges();
			assert.equal(oPC1.getNoDataText(), "Test", "noDataText set");
			assert.equal(oTable.getProperty("noDataText"), "Test", "noDataText set on table");

			oPC1.setNoDataText(null);
			sap.ui.getCore().applyChanges();
		});

		QUnit.test("minDate/maxDate", function(assert) {
			assert.ok(!oPC1.getMinDate(), "no minDate set by default");
			assert.ok(!sap.ui.getCore().byId("PC1-TimeInt").getMinDate(), "CalendarTimeInterval no minDate set by default");
			assert.ok(!sap.ui.getCore().byId("PC1-DateInt").getMinDate(), "CalendarDateInterval no minDate set by default");
			assert.ok(!sap.ui.getCore().byId("PC1-MonthInt").getMinDate(), "CalendarMonthInterval no minDate set by default");

			assert.ok(!oPC1.getMaxDate(), "no maxDate set by default");
			assert.ok(!sap.ui.getCore().byId("PC1-TimeInt").getMaxDate(), "CalendarTimeInterval no maxDate set by default");
			assert.ok(!sap.ui.getCore().byId("PC1-DateInt").getMaxDate(), "CalendarDateInterval no maxDate set by default");
			assert.ok(!sap.ui.getCore().byId("PC1-MonthInt").getMaxDate(), "CalendarMonthInterval no maxDate set by default");

			var oMinDate = new Date(2000, 0 , 1, 0, 0, 0);
			oPC1.setMinDate(oMinDate);
			assert.ok(jQuery.sap.equal(oMinDate, oPC1.getMinDate()), "no minDate set");
			assert.ok(jQuery.sap.equal(oMinDate, sap.ui.getCore().byId("PC1-TimeInt").getMinDate()), "CalendarTimeInterval minDate set");
			assert.ok(jQuery.sap.equal(oMinDate, sap.ui.getCore().byId("PC1-DateInt").getMinDate()), "CalendarDateInterval minDate set");
			assert.ok(jQuery.sap.equal(oMinDate, sap.ui.getCore().byId("PC1-MonthInt").getMinDate()), "CalendarMonthInterval minDate set");

			var oMaxDate = new Date(2050, 11 , 31, 23, 59, 59);
			oPC1.setMaxDate(oMaxDate);
			assert.ok(jQuery.sap.equal(oMaxDate, oPC1.getMaxDate()), "no minDate set");
			assert.ok(jQuery.sap.equal(oMaxDate, sap.ui.getCore().byId("PC1-TimeInt").getMaxDate()), "CalendarTimeInterval maxDate set");
			assert.ok(jQuery.sap.equal(oMaxDate, sap.ui.getCore().byId("PC1-DateInt").getMaxDate()), "CalendarDateInterval maxDate set");
			assert.ok(jQuery.sap.equal(oMaxDate, sap.ui.getCore().byId("PC1-MonthInt").getMaxDate()), "CalendarMonthInterval maxDate set");

			oPC1.setMinDate();
			assert.ok(!oPC1.getMinDate(), "no minDate set");
			assert.ok(!sap.ui.getCore().byId("PC1-TimeInt").getMinDate(), "CalendarTimeInterval no minDate");
			assert.ok(!sap.ui.getCore().byId("PC1-DateInt").getMinDate(), "CalendarDateInterval no minDate");
			assert.ok(!sap.ui.getCore().byId("PC1-MonthInt").getMinDate(), "CalendarMonthInterval no minDate");

			oPC1.setMaxDate();
			assert.ok(!oPC1.getMaxDate(), "no maxDate");
			assert.ok(!sap.ui.getCore().byId("PC1-TimeInt").getMaxDate(), "CalendarTimeInterval no maxDate");
			assert.ok(!sap.ui.getCore().byId("PC1-DateInt").getMaxDate(), "CalendarDateInterval no maxDate");
			assert.ok(!sap.ui.getCore().byId("PC1-MonthInt").getMaxDate(), "CalendarMonthInterval no maxDate");
		});

		QUnit.test("rows", function(assert) {
			var oTable = sap.ui.getCore().byId("PC1-Table");
			assert.equal(oPC1.getRows().length, 2, "PlanningCalendarRows assigned");
			var iIntervals = 12;
			if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[0]) {
				iIntervals = 3;
			}else if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[1]) {
				iIntervals = 6;
			}

			var oRow = new sap.m.PlanningCalendarRow("NewRow", {
				icon: "sap-icon://employee",
				title: "new Row"
			});
			oPC1.addRow(oRow);
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getItems().length, 3, "Table rows");
			assert.equal(oTable.getItems()[2].getId(), "NewRow-CLI", "new row added to table");
			assert.ok(jQuery("#NewRow-Head").get(0), "new row Header rendered");
			assert.ok(jQuery("#NewRow-CalRow").get(0), "new row CalendarRow rendered");
			assert.equal(_getRowTimeline(oRow).getStartDate().getTime(), oPC1.getStartDate().getTime(), "Start date of CalendarRow");
			assert.equal(_getRowTimeline(oRow).getIntervalType(), CalendarIntervalType.Month, "IntervalType of CalendarRow");
			assert.equal(_getRowTimeline(oRow).getIntervals(), iIntervals, "Intervals of CalendarRow");

			oPC1.removeRow(oRow);
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getItems().length, 2, "Table rows");
			assert.ok(!jQuery("#NewRow-Head").get(0), "new row Header not rendered");
			assert.ok(!jQuery("#NewRow-CalRow").get(0), "new row CalendarRow not rendered");

			oPC1.insertRow(oRow, 1);
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getItems().length, 3, "Table rows");
			assert.equal(oTable.getItems()[1].getId(), "NewRow-CLI", "new row added to table");
			assert.ok(jQuery("#NewRow-Head").get(0), "new row Header rendered");
			assert.ok(jQuery("#NewRow-CalRow").get(0), "new row CalendarRow rendered");
			assert.equal(_getRowTimeline(oRow).getStartDate().getTime(), oPC1.getStartDate().getTime(), "Start date of CalendarRow");
			assert.equal(_getRowTimeline(oRow).getIntervalType(), CalendarIntervalType.Month, "IntervalType of CalendarRow");
			assert.equal(_getRowTimeline(oRow).getIntervals(), iIntervals, "Intervals of CalendarRow");

			var aRemoved = oPC1.removeAllRows();
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getItems().length, 0, "Table rows removed");
			assert.equal(aRemoved.length, 3, "3 rows removed");

			for(var i = 0; i < aRemoved.length; i++) {
				aRemoved[i].destroy();
			}

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
			oTable = sap.ui.getCore().byId("PC1-Table");

			oPC1.destroyRows();
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getItems().length, 0, "Table rows destroyed");
			assert.ok(!sap.ui.getCore().byId("PC1-Row1"), "Row1 destroyed");

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
		});

		QUnit.test("toolbarContent", function(assert) {
			var oButton = new sap.m.Button("BX", {
				icon: "sap-icon://home",
				type: sap.m.ButtonType.Transparent
			});

			var oTable = sap.ui.getCore().byId("PC1-Table");

			oPC1.addToolbarContent(oButton);
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getHeaderToolbar().getContent().length, 3, "HeaderToolbar items");
			assert.equal(oTable.getHeaderToolbar().getContent()[2].getId(), "BX", "HeaderToolbar: new button exist");
			assert.ok(jQuery("#BX").get(0), "new button rendered");

			oPC1.removeToolbarContent(oButton);
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getHeaderToolbar().getContent().length, 2, "HeaderToolbar items");
			assert.ok(!jQuery("#BX").get(0), "new button not rendered");

			oPC1.insertToolbarContent(oButton, 0);
			sap.ui.getCore().applyChanges();
			assert.equal(oTable.getHeaderToolbar().getContent().length, 3, "HeaderToolbar items");
			assert.equal(oTable.getHeaderToolbar().getContent()[0].getId(), "BX", "HeaderToolbar: new button exist");
			assert.ok(jQuery("#BX").get(0), "new button rendered");

			var aRemoved = oPC1.removeAllToolbarContent();
			sap.ui.getCore().applyChanges();
			assert.ok(!oTable.getHeaderToolbar(), "No HeaderToolbar exist on table");
			assert.equal(oPC1._oToolbar.getContent().length, 0, "HeaderToolbar items");
			assert.ok(!jQuery("#BX").get(0), "new button not rendered");
			assert.equal(aRemoved.length, 3, "3 controls removed");

			for(var i = 0; i < aRemoved.length; i++) {
				aRemoved[i].destroy();
			}

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
			oTable = sap.ui.getCore().byId("PC1-Table");

			oPC1.destroyToolbarContent();
			sap.ui.getCore().applyChanges();
			assert.ok(!oTable.getHeaderToolbar(), "No HeaderToolbar exist on table");
			assert.equal(oPC1._oToolbar.getContent().length, 0, "HeaderToolbar items");
			assert.ok(!sap.ui.getCore().byId("SF1"), "SearchField destroyed");

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
		});

		QUnit.test("views", function(assert) {
			assert.equal(oPC1.getViews().length, 0, "no views set in aggregation per default");

			oPC1.setViewKey("D");
			var oView = new sap.m.PlanningCalendarView("View-H", {
				key: "H",
				intervalType: CalendarIntervalType.Hour,
				description: "View1",
				intervalsS: 1,
				intervalsM: 2,
				intervalsL: 3
			});
			oPC1.addView(oView);
			oView = new sap.m.PlanningCalendarView("View-D", {
				key: "D",
				intervalType: CalendarIntervalType.Day,
				description: "View2",
				intervalsS: 2,
				intervalsM: 4,
				intervalsL: 6,
				showSubIntervals: true
			});
			oPC1.addView(oView);
			sap.ui.getCore().applyChanges();
			assert.equal(oPC1.getViews().length, 2, "2 views set");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getIntervalType(), CalendarIntervalType.Day, "CalendarRow1 intervalType");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getShowSubIntervals(), true, "CalendarRow1 subIntervals");
			if(jQuery("#PC1").outerWidth() > 1100) {
				assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getIntervals(), 6, "CalendarRow1 intervals");
			}
			assert.ok(!jQuery("#PC1-TimeInt").get(0), "CalendarTimeInterval not rendered");
			assert.ok(jQuery("#PC1-DateInt").get(0), "CalendarDateInterval rendered");

			oView.setIntervalsL(5);
			sap.ui.getCore().applyChanges();
			if(jQuery("#PC1").outerWidth() > 1100) {
				assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getIntervals(), 5, "CalendarRow1 intervals");
			}

			oPC1.destroyViews();
			oPC1.setViewKey(CalendarIntervalType.Hour);
			sap.ui.getCore().applyChanges();
			assert.equal(oPC1.getViews().length, 0, "no views set in aggregation");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getIntervalType(), CalendarIntervalType.Hour, "CalendarRow1 intervalType");
			assert.equal(sap.ui.getCore().byId("PC1-Row1-CalRow").getShowSubIntervals(), false, "CalendarRow1 subIntervals");
		});

		QUnit.test("specialDates", function(assert) {
			var oTimeInterval = sap.ui.getCore().byId("PC1-TimeInt");
			assert.equal(oTimeInterval.getSpecialDates().length, 2, "TimeInterval gets SpecialDates from PlanningCalendar");
			assert.ok(jQuery("#PC1-TimeInt--TimesRow-201501011200").hasClass("sapUiCalItemType02"), "SpecialDate rendered");

			oPC1.addSpecialDate(new DateTypeRange("SD1", {
				startDate: new Date(2015, 0, 1, 15, 30),
				type: CalendarDayType.Type01,
				tooltip: "Test"
			}));
			sap.ui.getCore().applyChanges();
			assert.ok(jQuery("#PC1-TimeInt--TimesRow-201501011500").hasClass("sapUiCalItemType01"), "new SpecialDate rendered");

			oPC1.insertSpecialDate(new DateTypeRange("SD2", {
				startDate: new Date(2015, 0, 1, 16, 30),
				type: CalendarDayType.Type01,
				tooltip: "Test"
			}), 1);
			sap.ui.getCore().applyChanges();
			assert.ok(jQuery("#PC1-TimeInt--TimesRow-201501011600").hasClass("sapUiCalItemType01"), "new SpecialDate rendered");

			var oSD = oPC1.removeSpecialDate("SD1");
			sap.ui.getCore().applyChanges();
			assert.ok(!jQuery("#PC1-TimeInt--TimesRow-201501011500").hasClass("sapUiCalItemType01"), "new SpecialDate not longer rendered");
			oSD.destroy();

			var aRemoved = oPC1.removeAllSpecialDates();
			sap.ui.getCore().applyChanges();
			assert.equal(aRemoved.length, 3, "3 specialDates removed");
			assert.ok(!jQuery("#PC1-TimeInt--TimesRow-201501011200").hasClass("sapUiCalItemType02"), "SpecialDate not longer rendered");
			assert.ok(!jQuery("#PC1-TimeInt--TimesRow-201501011600").hasClass("sapUiCalItemType01"), "new SpecialDate not longer rendered");

			for(var i = 0; i < aRemoved.length; i++) {
				aRemoved[i].destroy();
			}

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
			assert.ok(jQuery("#PC1-TimeInt--TimesRow-201501011200").hasClass("sapUiCalItemType02"), "SpecialDate rendered again");

			oPC1.destroySpecialDates();
			sap.ui.getCore().applyChanges();
			assert.ok(!jQuery("#PC1-TimeInt--TimesRow-201501011200").hasClass("sapUiCalItemType02"), "SpecialDate not longer rendered");
		});

		QUnit.test("Row header", function(assert) {
			var oRow = sap.ui.getCore().byId("PC1-Row1");
			var oRowHeader = _getRowHeader(oRow);

			oRow.setTitle("Test");
			oRow.setText("Test");
			oRow.setIcon("sap-icon://sap-ui5");
			sap.ui.getCore().applyChanges();
			assert.equal(oRowHeader.getTitle(), "Test", "row header Title");
			assert.equal(oRowHeader.getDescription(), "Test", "row header Text");
			assert.equal(oRowHeader.getIcon(), "sap-icon://sap-ui5", "row header icon");
		});

		QUnit.test("Row nonWorkingIntervals", function(assert) {
			var oRow = sap.ui.getCore().byId("PC1-Row1");
			var oTimeline = _getRowTimeline(oRow);

			oRow.setNonWorkingDays([2, 3]);
			oRow.setNonWorkingHours([11, 12]);
			sap.ui.getCore().applyChanges();
			assert.ok(jQuery.sap.equal(oTimeline.getNonWorkingDays(), [2, 3]), "CalendarRow - nonWorkingDays");
			assert.ok(jQuery.sap.equal(oTimeline.getNonWorkingHours(), [11, 12]), "CalendarRow - nonWorkingHours");
		});

		QUnit.test("Row selected", function(assert) {
			var oRow = sap.ui.getCore().byId("PC1-Row1");
			var oColumnListItem = _getListItem(oRow);
			assert.ok(!oRow.getSelected(), "Row not selected as default");
			assert.ok(!oColumnListItem.getSelected(), "ColumnListItem not selected as default");

			oRow.setSelected(true)
			sap.ui.getCore().applyChanges();
			assert.ok(oRow.getSelected(), "Row now selected");
			assert.ok(oColumnListItem.getSelected(), "ColumnListItem now selected");
		});

		QUnit.test("Row appointments", function(assert) {
			var oRow = sap.ui.getCore().byId("PC1-Row1");
			var oTimeline = _getRowTimeline(oRow);
			assert.ok(jQuery.sap.equal(oRow.getAppointments(), oTimeline.getAppointments()), "CalendarRow appointments");
			assert.equal(oRow.getAppointments().length, 4, "number of appointments");

			var oAppointment = new CalendarAppointment("NewAppointment", {
				startDate: new Date("2015", "0", "1", "12", "00"),
				endDate: new Date("2015", "0", "1", "15", "00"),
				type: CalendarDayType.Type10,
				title: "New",
				text: "Appointment",
				tooltip: "Test",
				icon: "sap-icon://sap-ui5"
			});

			oRow.addAppointment(oAppointment);
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getAppointments().length, 5, "number of appointments after add");
			assert.equal(oRow.getAppointments()[4].getId(), "NewAppointment", "position of new appointments in array");
			assert.ok(oAppointment.getDomRef(), "Appointment rendered");

			oRow.removeAppointment(oAppointment);
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getAppointments().length, 4, "number of appointments after remove");
			assert.ok(!oAppointment.getDomRef(), "Appointment not rendered");

			oRow.insertAppointment(oAppointment, 1);
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getAppointments().length, 5, "number of appointments after insert");
			assert.equal(oRow.getAppointments()[1].getId(), "NewAppointment", "position of new appointments in array");
			assert.ok(oAppointment.getDomRef(), "Appointment rendered");

			var aRemoved =oRow.removeAllAppointments();
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getAppointments().length, 0, "number of appointments after remove all");
			assert.ok(oAppointment, "Appointment still exist");
			assert.ok(!oAppointment.getDomRef(), "Appointment not rendered");
			for(var i = 0; i < aRemoved.length; i++) {
				aRemoved[i].destroy();
			}

			oRow = sap.ui.getCore().byId("PC1-Row2");
			oTimeline = _getRowTimeline(oRow);
			assert.ok(sap.ui.getCore().byId("PC1-R2A1"), "Appointment exist before destroy");
			oRow.destroyAppointments();
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getAppointments().length, 0, "number of appointments after destroy");
			assert.ok(!sap.ui.getCore().byId("PC1-R2A1"), "Appointment destroyed");

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
		});

		QUnit.test("Row intervalHeaders", function(assert) {
			var oRow = sap.ui.getCore().byId("PC1-Row1");
			var oTimeline = _getRowTimeline(oRow);
			assert.ok(jQuery.sap.equal(oRow.getIntervalHeaders(), oTimeline.getIntervalHeaders()), "CalendarRow IntervalHeaders");
			assert.equal(oRow.getIntervalHeaders().length, 1, "number of IntervalHeaders");

			var oIntervalHeader = new CalendarAppointment("NewIntervalHeader", {
				startDate: new Date("2015", "0", "1", "12", "00"),
				endDate: new Date("2015", "0", "1", "15", "00"),
				type: CalendarDayType.Type10,
				title: "New",
				tooltip: "Test",
				icon: "sap-icon://sap-ui5"
			});

			oRow.addIntervalHeader(oIntervalHeader);
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getIntervalHeaders().length, 2, "number of IntervalHeaders after add");
			assert.equal(oRow.getIntervalHeaders()[1].getId(), "NewIntervalHeader", "position of new IntervalHeaders in array");
			assert.ok(oIntervalHeader.getDomRef(), "IntervalHeader rendered");

			oRow.removeIntervalHeader(oIntervalHeader);
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getIntervalHeaders().length, 1, "number of IntervalHeaders after remove");
			assert.ok(!oIntervalHeader.getDomRef(), "IntervalHeader not rendered");

			oRow.insertIntervalHeader(oIntervalHeader, 0);
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getIntervalHeaders().length, 2, "number of IntervalHeaders after insert");
			assert.equal(oRow.getIntervalHeaders()[0].getId(), "NewIntervalHeader", "position of new IntervalHeaders in array");
			assert.ok(oIntervalHeader.getDomRef(), "IntervalHeader rendered");

			var aRemoved =oRow.removeAllIntervalHeaders();
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getIntervalHeaders().length, 0, "number of IntervalHeaders after remove all");
			assert.ok(oIntervalHeader, "IntervalHeader still exist");
			assert.ok(!oIntervalHeader.getDomRef(), "IntervalHeader not rendered");
			for(var i = 0; i < aRemoved.length; i++) {
				aRemoved[i].destroy();
			}

			oRow = sap.ui.getCore().byId("PC1-Row2");
			assert.ok(sap.ui.getCore().byId("PC1-R2H1"), "IntervalHeader exist before destroy");
			oRow.destroyIntervalHeaders();
			sap.ui.getCore().applyChanges();
			assert.equal(oRow.getIntervalHeaders().length, 0, "number of IntervalHeaders after destroy");
			assert.ok(!sap.ui.getCore().byId("PC1-R2H1"), "IntervalHeader destroyed");

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
		});

		QUnit.test("legend works with sap.ui.unified.CalendarLegend", function () {
			// arrange
			var oLegendItem = new CalendarLegendItem({
					type: "Type01",
					text: "Text 2"
				}),
				oPC = createPlanningCalendar(
					"invalidationExample",
					new sap.m.SearchField(),
					new sap.m.Button(),
					new Date(Date.UTC(2015, 0, 7)),
					CalendarIntervalType.Week,
					new CalendarLegend({
						items: [oLegendItem]
					})
				);

			// act
			oPC.placeAt("uiArea2");
			sap.ui.getCore().applyChanges();

			var aRows = oPC.getRows();
			var oTimeline = _getRowTimeline(aRows[0]);

			// assert
			assert.equal(oTimeline.getRenderer().getLegendItems(oTimeline).length, 1,  "Legend items should be returned");

			// cleanup
			oPC.destroy();
		});

		QUnit.test("setCustomAppointmentsSorterCallback allows the app dev to custom sort the appointments via the setter", function
				(assert) {
			//arrange
			var oPC = createPlanningCalendar("PC4", new sap.m.SearchField(), new sap.m.Button()),
				fnCustom = function() {};

			//assert
			assert.notOk(oPC._fnCustomSortedAppointments, "there is not a custom sort");

			//act
			oPC.setCustomAppointmentsSorterCallback(fnCustom);

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), oPC._fnCustomSortedAppointments, "there is a custom sort");
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), fnCustom,
					"getCustomAppointmentsSorterCallback() returns the given custom function");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("customAppointmentsSorterCallback(function) in the constructor", function (assert) {
			//arrange & act
			var fnCustom = function() {},
				oPC = new sap.m.PlanningCalendar({
				customAppointmentsSorterCallback: fnCustom
			});

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), oPC._fnCustomSortedAppointments, "when a fn is set to setCustomAppointmentsSorterCallback, the sort is custom");
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), fnCustom, "getCustomAppointmentsSorterCallback() returns the given custom function");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("customAppointmentsSorterCallback(number) in the constructor", function (assert) {
			//arrange & act
			var oPC = new sap.m.PlanningCalendar({
				customAppointmentsSorterCallback: 1
			});

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), undefined,
					"when a number is set to setCustomAppointmentsSorterCallback, the sort is the default one");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("customAppointmentsSorterCallback(string) in the constructor", function (assert) {
			//arrange & act
			var oPC = new sap.m.PlanningCalendar({
				customAppointmentsSorterCallback: "string is not allowed"
			});

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), undefined,
					"when a string is set to setCustomAppointmentsSorterCallback, the sort is the default one");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("setCustomAppointmentsSorterCallback(function)", function (assert) {
			//arrange & act
			var fnCustom = function() {},
				oPC = new sap.m.PlanningCalendar({});

			oPC.setCustomAppointmentsSorterCallback(fnCustom);

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), oPC._fnCustomSortedAppointments, "when a fn is set to setCustomAppointmentsSorterCallback, the sort is custom");
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), fnCustom, "getCustomAppointmentsSorterCallback() returns the given custom function");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("setCustomAppointmentsSorterCallback(number)", function (assert) {
			//arrange & act
			var oPC = new sap.m.PlanningCalendar();

			oPC.setCustomAppointmentsSorterCallback(1);

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), undefined,
					"when a number is set to setCustomAppointmentsSorterCallback, the sort is the default one");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("setCustomAppointmentsSorterCallback(string)", function (assert) {
			//arrange & act
			var oPC = new sap.m.PlanningCalendar();

			oPC.setCustomAppointmentsSorterCallback("string is not allowed");

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), undefined,
					"when a string is set to setCustomAppointmentsSorterCallback, the sort is the default one");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("setCustomAppointmentsSorterCallback(null)", function (assert) {
			//arrange & act
			var fnCustom = function() {},
				oPC = new sap.m.PlanningCalendar({
					customAppointmentsSorterCallback: fnCustom
				});

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), fnCustom,
					"getCustomAppointmentsSorterCallback() returns the given custom function");

			//act
			oPC.setCustomAppointmentsSorterCallback(null);

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), null, "the custom sort is removed");

		});

		QUnit.test("when sortAppointmentsCustomSemantic is set to undefined, the sort is the default one", function
				(assert) {
			//act
			var oPC = new sap.m.PlanningCalendar({});
			oPC.setCustomAppointmentsSorterCallback(undefined);

			//assert
			assert.equal(oPC._fnCustomSortedAppointments === undefined, true, "there is not a custom sort");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("when a function is set to setCustomAppointmentsSorterCallback, it's called", function (assert) {
			//arrange

			var oPC = createPlanningCalendar("PC5", oSearchField1, oButton1),
					oSortSpy = this.spy(),
					iAppointments = _getAppointmentsCount(oPC);

			//act
			oPC.setCustomAppointmentsSorterCallback(oSortSpy);
			oPC.placeAt('uiArea3');
			sap.ui.getCore().applyChanges();

			//assert
			assert.ok (oSortSpy.callCount > iAppointments, "the custom sort function is called, appointments: " +
			iAppointments + ", setCustomAppointmentsSorterCallback is called " + oSortSpy.callCount + " times");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("when setCustomAppointmentsSorterCallback after rendering, it's setting the new custom sorter", function (assert) {
			//arrange
			var fnCustom = function() {},
				fnCustom2 = function() {},
				oPC = new sap.m.PlanningCalendar({
					customAppointmentsSorterCallback: fnCustom
				});
			oPC.placeAt('uiArea3');
			sap.ui.getCore().applyChanges();

			//act
			oPC.setCustomAppointmentsSorterCallback(fnCustom2);
			sap.ui.getCore().applyChanges();

			//assert
			assert.deepEqual(oPC.getCustomAppointmentsSorterCallback(), fnCustom2, "the second sorter function is set");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("when a new row is added to a PlanningCalendar with a custom sort function set, the row has also custom function set", function (assert) {
			//arrange
			var fnCustom = function() {},
				oPC = new sap.m.PlanningCalendar({
					customAppointmentsSorterCallback: fnCustom
				}),
				oRow = new sap.m.PlanningCalendarRow();
			oPC.placeAt('uiArea3');
			sap.ui.getCore().applyChanges();

			//act
			oPC.addRow(oRow);
			sap.ui.getCore().applyChanges();

			//assert
			assert.ok(_getRowTimeline(oRow)._fnCustomSortedAppointments, "the custom sorter function is set");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("when a new row is inserted to a PlanningCalendar with a custom sort function set, the row has also custom function set", function (assert) {
			//arrange
			var fnCustom = function() {},
					oPC = new sap.m.PlanningCalendar({
						customAppointmentsSorterCallback: fnCustom
					}),
					oRow = new sap.m.PlanningCalendarRow();
			oPC.placeAt('uiArea3');
			sap.ui.getCore().applyChanges();

			//act
			oPC.insertRow(oRow);
			sap.ui.getCore().applyChanges();

			//assert
			assert.ok(_getRowTimeline(oRow)._fnCustomSortedAppointments, "the custom sorter function is set");

			//cleanup
			oPC.destroy();
		});

		QUnit.test("Sticky header", function () {
			// arrange
			var oInfoToolbar,
				oToolbar,
				oPC = createPlanningCalendar(
					"invalidationExample",
					new sap.m.SearchField(),
					new sap.m.Button(),
					new Date(Date.UTC(2015, 0, 7)),
					CalendarIntervalType.Week
				);

			// act
			oPC.placeAt("uiArea2");
			sap.ui.getCore().applyChanges();

			// assert
			assert.ok(!oPC.$("InfoToolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class shouldn't be set on the info bar");
			assert.ok(!oPC.$("Toolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class shouldn't be set on the toolbar");

			// act
			oPC.setStickyHeader(true);
			sap.ui.getCore().applyChanges();

			// assert
			assert.ok(oPC.$("InfoToolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class should be set on the info bar");
			assert.ok(oPC.$("Toolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class should be set on the toolbar");

			// act
			oPC.setStickyHeader(false);
			sap.ui.getCore().applyChanges();

			// assert
			assert.ok(!oPC.$("InfoToolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class shouldn't be set on the info bar");
			assert.ok(!oPC.$("Toolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class shouldn't be set on the toolbar");

			// cleanup
			oPC.destroy();
		});


		QUnit.module("NonWorking Special Dates", {
			beforeEach: function() {
				this.oPC = createPlanningCalendar("PCNonWorking", new sap.m.SearchField(), new sap.m.Button()),
						this.oSpecialDate = new DateTypeRange({
							startDate: new Date(2015, 0, 1, 15, 30),
							type: CalendarDayType.NonWorking
						});
				this.oSecondSpecialDate = new DateTypeRange({
					startDate: new Date(2015, 1, 2, 15, 30),
					type: CalendarDayType.NonWorking
				});
				this.oPC.placeAt("uiArea2");
			},
			afterEach: function() {
				//Cleanup
				this.oPC.destroy();
			}
		});

		QUnit.test("Insert non working special date", function(assert) {
			//Prepare
			this.oPC.addSpecialDate(this.oSpecialDate);

			//Act
			this.oPC.insertSpecialDate(this.oSecondSpecialDate, 0);
			//Assert
			assert.equal(this.oPC.indexOfAggregation("specialDates", this.oSecondSpecialDate), 0, "Insert special dates at index 0 position it at the 0th index");

		});

		QUnit.test("Remove non working special date", function(assert) {
			//Prepare
			this.oPC.addSpecialDate(this.oSpecialDate);

			//Act
			this.oPC.removeSpecialDate(this.oSpecialDate);
			//Assert
			assert.equal(this.oPC.indexOfAggregation("specialDates", this.oSecondSpecialDate), -1, "Special date is removed");
		});

		QUnit.test("Remove all non working special date", function(assert) {
			this.oPC.addSpecialDate(this.oSpecialDate);
			//Act
			this.oPC.removeAllSpecialDates();
			//Assert
			assert.equal(this.oPC.indexOfAggregation("specialDates", this.oSecondSpecialDate), -1, "Special date is removed");
		});

		QUnit.module("Special Dates per PlanningCalendarRow", {
			beforeEach: function() {
				this.oPC = createPlanningCalendar("PCSpecialDatesInRows", new sap.m.SearchField(), new sap.m.Button());
				this.oDateNW = new DateTypeRange({
					startDate: new Date(2015, 0, 1),
					type: sap.ui.unified.CalendarDayType.NonWorking
				});
				this.oSpecialDateRangeNW = new DateTypeRange({
					startDate: new Date(2015, 0, 14),
					endDate: new Date (2015, 0, 14),
					type: sap.ui.unified.CalendarDayType.NonWorking
				});
				this.oSpecialDateRangeType04 = new DateTypeRange({
					startDate: new Date(2015, 0, 7),
					endDate: new Date (2015, 0, 9),
					type: sap.ui.unified.CalendarDayType.Type04
				});
				this.oPC.placeAt("uiArea2");
			},
			afterEach: function() {
				//Cleanup
				this.oPC.destroy();
			},

			_assertSpecialDatesEmpty: function() {
				// Checks that aggregation "specialDates" is empty for each PlanningCalendarRow
				this.oPC.getAggregation("rows").forEach(function (oRow) {
					assert.ok(!oRow.getAggregation("specialDates") ||
							oRow.getAggregation("specialDates").length === 0,
							"PlanningCalendarRow should have no items in its aggregation specialDates");
				});
			},

			_assertIsSpecialDateAvailable: function(oDate, oSecondDate, oThirdDate) {
				// assuming that in the first PCRow there are no items in the specialDates aggregation set
				// assuming that in the second PCRow there are 2 specialDates set to the aggregation - one with only startDate set of type NonWorking
				// and one with startDate and endDate of type 04.
				var oRowNoWork = this.oPC.getAggregation("rows")[1].getAggregation("specialDates");

				assert.equal(this.oPC.getAggregation("rows")[0].getAggregation("specialDates").length, 0, "first PlanningCalendarRow should have no items in its aggregation specialDates");
				assert.equal(oRowNoWork.length, 3, " second PlanningCalendarRow should have 3 items in its aggregation specialDates");
				assert.equal(oRowNoWork[0].getStartDate().toString(), oDate.getStartDate().toString(), "the right start of the special date is set");
				assert.equal(oRowNoWork[0].getEndDate(), null, "the special date should have no endDate");
				assert.equal(oRowNoWork[0].getType(), sap.ui.unified.CalendarDayType.NonWorking, "the special date should be of type NonWorking");
				assert.equal(oRowNoWork[1].getStartDate().toString(), oSecondDate.getStartDate().toString(), "the right start of the special date range is set");
				assert.equal(oRowNoWork[1].getEndDate().toString(), oSecondDate.getEndDate().toString(), "the right end of the special date range is set");
				assert.equal(oRowNoWork[1].getType(), sap.ui.unified.CalendarDayType.NonWorking, "the special date should be of type NonWorking");
				assert.equal(oRowNoWork[2].getStartDate().toString(), oThirdDate.getStartDate().toString(), "the right start of the special date range is set");
				assert.equal(oRowNoWork[2].getEndDate().toString(), oThirdDate.getEndDate().toString(), "the right end of the special date range is set");
				assert.equal(oRowNoWork[2].getType(), sap.ui.unified.CalendarDayType.Type04, "the special date should be of type Type04");
			},

			_assertIsClassNoWorkAvailable: function () {
				var aIntervals = jQuery("#PCSpecialDatesInRows-Row2-CalRow-Apps").children(".sapUiCalendarRowAppsInt");

				assert.ok(jQuery(aIntervals[0]).hasClass("sapUiCalendarRowAppsNoWork"), "interval0 has class sapUiCalendarRowAppsNoWork because it is a special date");
				assert.ok(!jQuery(aIntervals[1]).hasClass("sapUiCalendarRowAppsNoWork"), "interval0 has no class sapUiCalendarRowAppsNoWork");
				assert.ok(!jQuery(aIntervals[2]).hasClass("sapUiCalendarRowAppsNoWork"), "interval02 has no class sapUiCalendarRowAppsNoWork");
				assert.ok(!jQuery(aIntervals[3]).hasClass("sapUiCalendarRowAppsNoWork"), "interval03 has no class sapUiCalendarRowAppsNoWork");
				assert.ok(!jQuery(aIntervals[4]).hasClass("sapUiCalendarRowAppsNoWork"), "interval04 has no class sapUiCalendarRowAppsNoWork");
				assert.ok(jQuery(aIntervals[5]).hasClass("sapUiCalendarRowAppsNoWork"), "interval05 has class sapUiCalendarRowAppsNoWork because it is a non-working day");
				assert.ok(jQuery(aIntervals[6]).hasClass("sapUiCalendarRowAppsNoWork"), "interval06 has class sapUiCalendarRowAppsNoWork because it is a non-working day");
				assert.ok(!jQuery(aIntervals[7]).hasClass("sapUiCalendarRowAppsNoWork"), "interval07 has no class sapUiCalendarRowAppsNoWork");
				assert.ok(!jQuery(aIntervals[8]).hasClass("sapUiCalendarRowAppsNoWork"), "interval08 has no class sapUiCalendarRowAppsNoWork, because it is a special date of other type than non-working");
				assert.ok(!jQuery(aIntervals[9]).hasClass("sapUiCalendarRowAppsNoWork"), "interval09 has no class sapUiCalendarRowAppsNoWork, because it is a special date of other type than non-working");
				assert.ok(!jQuery(aIntervals[10]).hasClass("sapUiCalendarRowAppsNoWork"), "interval10 has no class sapUiCalendarRowAppsNoWork");
				assert.ok(!jQuery(aIntervals[11]).hasClass("sapUiCalendarRowAppsNoWork"), "interval11 has no class sapUiCalendarRowAppsNoWork");
				assert.ok(jQuery(aIntervals[12]).hasClass("sapUiCalendarRowAppsNoWork"), "interval12 has class sapUiCalendarRowAppsNoWork because it is a non-working day");
				assert.ok(jQuery(aIntervals[13]).hasClass("sapUiCalendarRowAppsNoWork"), "interval13 has class sapUiCalendarRowAppsNoWork because it is a non-working day and a special date");
			},

			_assertIsClassNoWorkNotAvailable: function () {
				var aIntervals = jQuery("#PCSpecialDatesInRows-Row2-CalRow-Apps").children(".sapUiCalendarRowAppsInt");
				for (var i = 0; i < aIntervals.length; i++) {
					if (i === 5 || i === 6 || i === 12 || i === 13) {
						assert.ok(jQuery(aIntervals[i]).hasClass("sapUiCalendarRowAppsNoWork"), "interval" + i + " has class sapUiCalendarRowAppsNoWork because it is a non-working day");
					} else {
						assert.ok(!jQuery(aIntervals[i]).hasClass("sapUiCalendarRowAppsNoWork"), "interval" + i + " has no class sapUiCalendarRowAppsNoWork");
					}
				}
			}
		});

		QUnit.test("Add a special date to a row", function(assert) {
			//Act
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oDateNW);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeNW);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeType04);
			this.oPC.setViewKey("Day");
			sap.ui.getCore().applyChanges();
			//Assert
			this._assertIsSpecialDateAvailable(this.oDateNW, this.oSpecialDateRangeNW, this.oSpecialDateRangeType04);
			this._assertIsClassNoWorkAvailable();
		});

		QUnit.test("Insert a special date in a row", function(assert) {
			//Prepare
			this.oPC.getAggregation("rows")[1].insertSpecialDate(this.oSpecialDateRangeType04);
			this.oPC.getAggregation("rows")[1].insertSpecialDate(this.oSpecialDateRangeNW);
			//Act
			this.oPC.getAggregation("rows")[1].insertSpecialDate(this.oDateNW, 0);
			this.oPC.setViewKey("Day");
			sap.ui.getCore().applyChanges();
			//Assert
			assert.equal(this.oPC.getAggregation("rows")[1].indexOfAggregation("specialDates", this.oDateNW), 0, "Insert a special date at index 0");
			this._assertIsSpecialDateAvailable(this.oDateNW, this.oSpecialDateRangeNW, this.oSpecialDateRangeType04);
			this._assertIsClassNoWorkAvailable();
		});

		QUnit.test("Remove a special date from a row", function(assert) {
			//Prepare
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oDateNW);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeType04);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeNW);
			//Act
			this.oPC.getAggregation("rows")[1].removeSpecialDate(this.oDateNW);
			this.oPC.getAggregation("rows")[1].removeSpecialDate(this.oSpecialDateRangeType04);
			this.oPC.getAggregation("rows")[1].removeSpecialDate(this.oSpecialDateRangeNW);
			this.oPC.setViewKey("Day");
			sap.ui.getCore().applyChanges();
			//Assert
			this._assertSpecialDatesEmpty();
			this._assertIsClassNoWorkNotAvailable();
		});

		QUnit.test("Remove all special dates in a row", function(assert) {
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oDateNW);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeType04);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeNW);
			//Act
			this.oPC.getAggregation("rows")[1].removeAllSpecialDates();
			this.oPC.setViewKey("Day");
			sap.ui.getCore().applyChanges();
			//Assert
			this._assertSpecialDatesEmpty();
			this._assertIsClassNoWorkNotAvailable();
		});

		QUnit.test("Destroy all special dates from a row", function(assert) {
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oDateNW);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeType04);
			this.oPC.getAggregation("rows")[1].addSpecialDate(this.oSpecialDateRangeNW);
			//Act
			this.oPC.getAggregation("rows")[1].destroySpecialDates();
			this.oPC.setViewKey("Day");
			sap.ui.getCore().applyChanges();
			//Assert
			this._assertSpecialDatesEmpty();
			this._assertIsClassNoWorkNotAvailable();
		});

		QUnit.module("events");

		QUnit.test("appointmentSelect", function(assert) {
			oSelectedAppointment = undefined;
			qutils.triggerEvent("tap", "PC1-R1A1");
			assert.equal(oSelectedAppointment.getId(), "PC1-R1A1", "appointmentSelect event fired and appointment returned");
			assert.ok(sap.ui.getCore().byId("PC1-R1A1").getSelected(), "Appointment is selected");
			assert.equal(sDomRefId, "PC1-R1A1", "sDomRefId returns the right ID of the appointment if clicked on the whole appointment");
			qutils.triggerEvent("tap", "PC1-R1A1-Title");
			assert.equal(sDomRefId, "PC1-R1A1", "sDomRefId returns the right ID of the appointment if clicked on the title of the appointment");
			qutils.triggerEvent("tap", "PC1-R1A1-Text");
			assert.equal(sDomRefId, "PC1-R1A1", "sDomRefId returns the right ID of the appointment if clicked on the text of the appointment");
			oPC1.setViewKey(CalendarIntervalType.Month);
			sap.ui.getCore().applyChanges();
			qutils.triggerEvent("tap", "PC1-Row1-CalRow-Group0");
			assert.equal(sDomRefId, "PC1-Row1-CalRow-Group0", "sDomRefId returns the right ID of the group appointment");
			oPC1.setViewKey(CalendarIntervalType.Hours);
			sap.ui.getCore().applyChanges();
			oSelectedAppointment = undefined;
		});

		QUnit.test("rowSelectionChange", function(assert) {
			assert.equal(oPC1.getSelectedRows().length, 0, "No rows selected");

			bRowSelectionChange = false;
			aChangedRows = undefined;
			qutils.triggerEvent("tap", "PC1-Row1-CLI_cell0");
			assert.ok(bRowSelectionChange, "rowSelectionChange fired");
			assert.equal(aChangedRows.length, 1, "one row changed");
			assert.equal(aChangedRows[0].getId(), "PC1-Row1", "Row1 changed");
			assert.ok(sap.ui.getCore().byId("PC1-Row1").getSelected(), "Row1 is selected");
			assert.equal(oPC1.getSelectedRows().length, 1, "one row selected");

			bRowSelectionChange = false;
			aChangedRows = undefined;

			qutils.triggerEvent("tap", "PC1-Row2-CLI_cell0");
			assert.ok(bRowSelectionChange, "rowSelectionChange fired");
			assert.equal(aChangedRows.length, 2, "two row changed");
			assert.equal(aChangedRows[0].getId(), "PC1-Row1", "Row1 changed");
			assert.equal(aChangedRows[1].getId(), "PC1-Row2", "Row2 changed");
			assert.ok(!sap.ui.getCore().byId("PC1-Row1").getSelected(), "Row1 is not selected");
			assert.ok(sap.ui.getCore().byId("PC1-Row2").getSelected(), "Row2 is selected");
			assert.equal(oPC1.getSelectedRows().length, 1, "one row selected");

			bRowSelectionChange = false;
			aChangedRows = undefined;
			oPC1.setSingleSelection(false);
			sap.ui.getCore().applyChanges();
			qutils.triggerEvent("tap", "PC1-All");
			assert.ok(bRowSelectionChange, "rowSelectionChange fired");
			assert.equal(aChangedRows.length, 1, "one row changed");
			assert.equal(aChangedRows[0].getId(), "PC1-Row1", "Row1 changed");
			assert.ok(sap.ui.getCore().byId("PC1-Row1").getSelected(), "Row1 is selected");
			assert.ok(sap.ui.getCore().byId("PC1-Row2").getSelected(), "Row2 is selected");
			assert.equal(oPC1.getSelectedRows().length, 2, "2 row selected");

			bRowSelectionChange = false;
			aChangedRows = undefined;
			oPC1.setSingleSelection(true);
			sap.ui.getCore().applyChanges();
			assert.ok(!bRowSelectionChange, "rowSelectionChange not fired");
			assert.ok(!sap.ui.getCore().byId("PC1-Row1").getSelected(), "Row1 is not selected");
			assert.ok(!sap.ui.getCore().byId("PC1-Row2").getSelected(), "Row2 is not selected");
			assert.equal(oPC1.getSelectedRows().length, 0, "No row selected");

			bRowSelectionChange = false;
			aChangedRows = undefined;

		});

		QUnit.test("startDateChange", function(assert) {
			bStartDateChange = false;
			// via navigation on CalendarTimeInterval
			qutils.triggerEvent("click", "PC1-TimeInt--Head-prev");
			assert.ok(bStartDateChange, "startDateChange fired");
			var oStartDate = oPC1.getStartDate();
			var oExpectedDate = new Date("2014", "11", "31", "20", "00");
			if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[0]) {
				oExpectedDate = new Date("2015", "0", "1", "02", "00");
			}else if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[1]) {
				oExpectedDate = new Date("2015", "0", "1", "02", "00");
			}
			assert.equal(oExpectedDate.getTime(), oStartDate.getTime(), "Start date is OK");

			bStartDateChange = false;
			// via navigation on CalendarDateInterval
			oPC1.setViewKey(CalendarIntervalType.Day);
			sap.ui.getCore().applyChanges();
			qutils.triggerEvent("click", "PC1-DateInt--Head-prev");
			assert.ok(bStartDateChange, "startDateChange fired");
			oStartDate = oPC1.getStartDate();
			oExpectedDate = new Date("2014", "11", "17", "00", "00");
			if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[0]) {
				oExpectedDate = new Date("2014", "11", "25", "00", "00");
			}else if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[1]) {
				oExpectedDate = new Date("2014", "11", "25", "00", "00");
			}
			assert.equal(oExpectedDate.getTime(), oStartDate.getTime(), "Start date is OK");

			bStartDateChange = false;
			// via navigation on CalendarMonthInterval
			oPC1.setViewKey(CalendarIntervalType.Month);
			sap.ui.getCore().applyChanges();
			qutils.triggerEvent("click", "PC1-MonthInt--Head-prev");
			assert.ok(bStartDateChange, "startDateChange fired");
			oStartDate = oPC1.getStartDate();
			oExpectedDate = new Date("2013", "11", "01", "00", "00");
			if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[0]) {
				oExpectedDate = new Date("2014", "08", "01", "00", "00");
			}else if(jQuery("#PC1").outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[1]) {
				oExpectedDate = new Date("2014", "05", "01", "00", "00");
			}
			assert.equal(oExpectedDate.getTime(), oStartDate.getTime(), "Start date is OK");

			bStartDateChange = false;

			//change view
			oPC1.setViewKey(CalendarIntervalType.Hour);
			sap.ui.getCore().applyChanges();
			jQuery("#PC1-IntType").focus();
			qutils.triggerKeydown("PC1-IntType", "ARROW_DOWN"); //to Days
			qutils.triggerKeydown("PC1-IntType", "ARROW_DOWN"); //to Months
			qutils.triggerKeydown("PC1-IntType", "ARROW_DOWN"); //to Week
			qutils.triggerKeydown("PC1-IntType", "ENTER");
			sap.ui.getCore().applyChanges();
			assert.ok(bStartDateChange, "startDateChange fired when view is switched to Week");
			bStartDateChange = false;

			oPC1.setViewKey(CalendarIntervalType.Hour);
			sap.ui.getCore().applyChanges();

			bStartDateChange = false;
			// via today button
			qutils.triggerEvent("tap", "PC1-Today");
			assert.ok(bStartDateChange, "startDateChange fired");
			oStartDate = oPC1.getStartDate();
			oExpectedDate = new Date();
			assert.equal(oExpectedDate.getFullYear(), oStartDate.getFullYear(), "Start date is OK");
			assert.equal(oExpectedDate.getMonth(), oStartDate.getMonth(), "Start date is OK");
			assert.equal(oExpectedDate.getDate(), oStartDate.getDate(), "Start date is OK");
			// If more tests are about to be added here, please consider that last date is the current one.

			oPC1 = initPlanningCalendar("PC1", "SF1", "B1");
		});

		QUnit.test("viewChange", function(assert) {
			bViewChange = false;
			jQuery("#PC1-IntType").focus();
			qutils.triggerKeyboardEvent("PC1-IntType", "ARROW_DOWN");
			qutils.triggerKeyboardEvent("PC1-IntType", "ENTER");
			sap.ui.getCore().applyChanges();
			assert.ok(bViewChange, "viewChange fired");

			oPC1.setViewKey(CalendarIntervalType.Hour);
			sap.ui.getCore().applyChanges();
		});

		QUnit.test("intervalselect", function (assert) {

			// Start with hour view
			oPC1.setViewKey(CalendarIntervalType.Hour);

			bIntervalSelect = false;
			oIntervalStartDate = undefined;
			oIntervalEndDate = undefined;
			bSubInterval = undefined,
			oIntervalRow = undefined,
			jQuery("#PC1-TimeInt--TimesRow-201501011200").focus();
			qutils.triggerKeyboardEvent("PC1-TimeInt--TimesRow-201501011200", "ENTER");
			sap.ui.getCore().applyChanges();
			assert.ok(bIntervalSelect, "intervalSelect fired");
			assert.equal(oFormatYyyyMMddHHmm.format(oIntervalStartDate), "201501011200", "interval start date returned");
			assert.equal(oFormatYyyyMMddHHmm.format(oIntervalEndDate), "201501011259", "interval end date returned");
			assert.ok(!bSubInterval, "No sub-interval");
			assert.ok(!oIntervalRow, "No row");
			assert.ok(!jQuery("#PC1-TimeInt--TimesRow-201501011200").hasClass("sapUiCalItemSel"), "interval not longer selected");

			bIntervalSelect = false;
			oIntervalStartDate = undefined;
			oIntervalEndDate = undefined;
			bSubInterval = undefined,
			oIntervalRow = undefined,
			qutils.triggerEvent("tap", "PC1-Row1-CalRow-AppsInt3");
			assert.ok(bIntervalSelect, "intervalSelect fired");
			assert.equal(oFormatYyyyMMddHHmm.format(oIntervalStartDate), "201501011100", "interval start date returned");
			assert.equal(oFormatYyyyMMddHHmm.format(oIntervalEndDate), "201501011159", "interval end date returned");
			assert.ok(!bSubInterval, "No sub-interval");
			assert.equal(oIntervalRow.getId(), "PC1-Row1", "row returned");
		});

		QUnit.test("rowHeaderClick", function (assert) {
			// Arrange
			var oSpy,
				oSecondRow = oPC1.getRows()[1], // Get second row
				handleRowHeaderClick = function (oEvent) {
					var oRow = oEvent.getParameter("row");

					// Assert
					assert.ok(oRow, "There must be a returned row");
					assert.ok(oRow instanceof sap.m.PlanningCalendarRow, "Returned row must derive from sap.m.PlanningCalendarRow");
					assert.strictEqual(oRow, oSecondRow, "Returned row must be reference to the second row");
				};

			oSpy = sinon.spy(handleRowHeaderClick);
			oPC1.attachEvent("rowHeaderClick", oSpy);

			// Act - click on the second row header
			qutils.triggerEvent("click", "PC1-Row2-Head-content");

			// Assert
			assert.strictEqual(oSpy.callCount, 1, "Event method must be called once");

			// Cleanup
			oPC1.detachEvent("rowHeaderClick", oSpy);
		});

		QUnit.module("Proxy calls", {
			beforeEach: function () {
				this.sut = createPlanningCalendar("invalidationExample", new sap.m.SearchField(), new sap.m.Button(), new Date(2015, 0, 7), CalendarIntervalType.Week);
				this.sutInterval = this.sut.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
				this.sut.placeAt('uiArea2');
				sap.ui.getCore().applyChanges();
			},
			afterEach: function () {
				this.sut.destroy();
				this.sut = undefined;
			}
		});

		QUnit.test("Calling 'invalidate()' on PlanningCalendar invokes its interval child 'invalidate()'", function (assert) {
			//prepare
			var oPCInvalidateSpy = this.spy(this.sut, 'invalidate'),
				oIntervalInvalidateSpy = this.spy(this.sutInterval, 'invalidate');

			//act
			this.sut._bDateRangeChanged = true;
			this.sut.invalidate();
			//assert
			assert.strictEqual(oPCInvalidateSpy.callCount, 1, "'PlanningCalendar invalidate()' was called once");
			assert.strictEqual(oIntervalInvalidateSpy.callCount, 1, "'CalendarWeekInterval invalidate()' was called once");
			assert.ok(oPCInvalidateSpy.callCount == oIntervalInvalidateSpy.callCount == 1, "Both methods are called exact (1) time");
		});

		QUnit.test("Calling 'exit()' on PlanningCalendar invokes its interval child 'destroy()'", function (assert) {
			//prepare
			var oPCExitSpy = this.spy(this.sut, 'exit'),
				oIntervalDestroySpy = this.spy(this.sutInterval, 'destroy');

			//act
			this.sut.exit();
			//assert
			assert.strictEqual(oPCExitSpy.callCount, 1, "'PlanningCalendar exit()' was called once");
			assert.strictEqual(oIntervalDestroySpy.callCount, 1, "'CalendarWeekInterval destroy()' was called once");
			assert.ok(oPCExitSpy.callCount == oIntervalDestroySpy.callCount == 1, "Both methods are called exact (1) time");
		});

		QUnit.test("'_handleCalendarSelect()' invokes its internal child methods 'fireSelect()'", function (assert) {
			//prepare
			var oMonth = this.sutInterval.getAggregation('month')[0],
				oMonthSelectSpy = this.spy(oMonth, 'fireSelect'),
				oCalendarSelectSpy = this.spy(this.sutInterval, 'fireSelect'),
				oPlanningCalendarIntervalSelectSpy = this.spy(this.sut, 'fireIntervalSelect'),
				aIntervalDomChilds = oMonth.$('days').children(),
				oFirstCalendarIntervalItem = aIntervalDomChilds[0],
				oStartDate = this.sut.getStartDate(),
				oEndDate = new Date(oStartDate.getTime());

			//act
			oEndDate.setDate(oStartDate.getDate() + 1);
			qutils.triggerKeydown(oFirstCalendarIntervalItem, "ENTER", false, false, false);
			sap.ui.getCore().applyChanges();
			//assert
			assert.strictEqual(oMonthSelectSpy.callCount, 1, "MonthSelect fired once");
			assert.strictEqual(oCalendarSelectSpy.callCount, 1, "CalendarSelect fired once");
			assert.strictEqual(oPlanningCalendarIntervalSelectSpy.callCount, 1, "PlanningCalendar IntervalSelect fired once");
		});

		QUnit.module("Private API", {
			beforeEach: function () {
				this.sut = createPlanningCalendar("invalidationExample", new sap.m.SearchField(), new sap.m.Button(), new Date(Date.UTC(2015, 0, 7)), CalendarIntervalType.Week);
				this.sutInterval = this.sut.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
				this.sut.placeAt('uiArea2');
				sap.ui.getCore().applyChanges();
			},
			afterEach: function () {
				this.sut.destroy();
				this.sut = undefined;
			}
		});

		QUnit.test("'_updateTodayButtonState()' has correct output", function (assert) {
			//prepare
			var _dateMatchesVisibleRangeSpy = this.spy(this.sut, '_dateMatchesVisibleRange');
			//act
			this.sut._updateTodayButtonState();
			//assert
			assert.strictEqual(_dateMatchesVisibleRangeSpy.callCount, 1, "'_dateMatchesVisibleRangeSpy()' was called once");
		});

		QUnit.test("today button enabled state is updated when the view is changed", function(assert) {
			//arrange
			this.sut.setViewKey(CalendarIntervalType.Day);
			this.sut.setStartDate(new Date());
			var oEnabledSpy = this.spy(this.sut._oTodayButton, 'setEnabled');

			//act
			this.sut.setViewKey(CalendarIntervalType.OneMonth);

			//assert
			assert.strictEqual(oEnabledSpy.called, true, 'today button state is updated');
			assert.strictEqual(oEnabledSpy.lastCall.args[0], false, 'today button state is updated correctly');
		});

		QUnit.test("'_dateMatchesVisibleRange()' has correct output" , function (assert) {
			//prepare
			var sViewKey = this.sut.getViewKey(),
				oView = this.sut._getView(sViewKey),
				iIntervals = this.sut._getIntervals(oView),
				oStartDate = this.sut.getStartDate(),
				oDate = new Date(oStartDate.getTime());

			//act
			oDate.setUTCDate(oStartDate.getUTCDate() - iIntervals);
			for (var iIndex = 1; iIndex < iIntervals * 3; iIndex++) {
				if (iIndex > iIntervals && iIndex <= iIntervals * 2) {
					assert.ok(this.sut._dateMatchesVisibleRange(oDate, sViewKey), "Date '" + oDate + "' is visible on the current viewport");
				} else {
					assert.notOk(this.sut._dateMatchesVisibleRange(oDate, sViewKey), "Date '" + oDate + "' is NOT visible on the current viewport");
				}
				oDate.setUTCDate(oDate.getUTCDate() + 1);
			}
		});

		QUnit.test("'_getViews()' has correct output", function (assert) {
			//prepare
			var sViewKey = this.sut.getViewKey(),
				oWeekView = this.sut._getView(sViewKey);
			//The act of this test is done in the module beforeEach
			//assert
			assert.strictEqual(Object.keys(this.sut._oViews).length, 5, "Correct number (5) of views assigned to PlanningCalendar");
			assert.strictEqual(oWeekView.getIntervalsS(), 7, "Correct number (7) intervals for S screen sizes");
			assert.strictEqual(oWeekView.getIntervalsM(), 7, "Correct number (7) intervals for M screen sizes");
			assert.strictEqual(oWeekView.getIntervalsL(), 7, "Correct number (7) intervals for L screen sizes");
		});

		QUnit.test("'_onRowDeselectAppointment' behaves correctly when deselecting not existing appointments", function (assert) {
			//prepare
			var oSetPropertySpy;
			_getRowTimeline(this.sut.getRows()[0]).aSelectedAppointments.push("dummy appointment");
			oSetPropertySpy = this.spy(sap.ui.base.ManagedObject.prototype, "setProperty");

			//act
			this.sut._onRowDeselectAppointment();

			//assert
			assert.strictEqual(oSetPropertySpy.callCount, 0, "If the appointment does not exist, setProperty is not called");

			//cleanup
			oSetPropertySpy.restore();

		});

		QUnit.module("Interaction", {
			beforeEach: function() {
				var oSearchField = new sap.m.SearchField(),
						oButton = new sap.m.Button();
				this.o1Sep2016MidOfWeek = new Date(2016, 8, 1, 1);
				this.o10Sep2016Morning = new Date(2016, 8, 10, 9);
				this.o10Sep2016 = new Date(2016, 8, 10);
				this.oPC2 = createPlanningCalendar("startDateAtTheMiddleOfTheWeek", oSearchField, oButton, this.o1Sep2016MidOfWeek,
						CalendarIntervalType.Week);
				this.oPC2.placeAt("uiArea1");
				sap.ui.getCore().applyChanges();
				this.oPC2Interval = this.oPC2.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
				this.oPC2IntervalRow = this.oPC2Interval.getAggregation('month')[0];
			},
			afterEach: function() {
				if (!bSkipDestroy) {
					this.oPC2.destroy();
				}
			}
		});

		QUnit.test("keyboard navigation", function(assert) {
			// test here only interaction between rows, other things are tested on CalendarRow
			var fnDone = assert.async();

			jQuery("#PC1-R1A1").focus();
			assert.equal(document.activeElement.id, "PC1-R1A1", "Appointment1 focused");
			qutils.triggerKeydown("PC1-R1A1", "END");
			assert.equal(document.activeElement.id, "PC1-R2A1", "Appointment1 focused");

			qutils.triggerKeydown("PC1-R2A1", "HOME");
			sap.ui.getCore().applyChanges();

			setTimeout(function(){
				assert.equal(document.activeElement.id, "PC1-R1A2", "Appointment2 focused");
				qutils.triggerKeydown("PC1-R1A1", "ARROW_DOWN");
				assert.equal(document.activeElement.id, "PC1-R2A1", "Appointment1 focused");
				qutils.triggerKeydown("PC1-R1A1", "ARROW_UP");
				sap.ui.getCore().applyChanges();
				assert.equal(document.activeElement.id, "PC1-R1A2", "Appointment2 focused");
				fnDone();
			}, 0);

		});


		QUnit.test("keyboard navigation HOME & END for 1 Month view", function(assert) {
			_switchToView(CalendarIntervalType.OneMonth, this.oPC2);
			this.oPC2.setStartDate(this.o1Sep2016MidOfWeek);
			this.oPC2.rerender();
			var sMonthIdPrefix = this.oPC2.getId() + "-OneMonthInt--Month0-";

			jQuery("#" +  sMonthIdPrefix + "20160901").focus();
			assert.equal(document.activeElement.id, sMonthIdPrefix + "20160901", "1st of September focused");

			qutils.triggerKeydown(sMonthIdPrefix + "20160901", "END");
			sap.ui.getCore().applyChanges();
			assert.equal(document.activeElement.id,  sMonthIdPrefix + "20160930", "30 of September focused");

			qutils.triggerKeydown(sMonthIdPrefix + "20160930", "HOME");
			sap.ui.getCore().applyChanges();
			assert.equal(document.activeElement.id, sMonthIdPrefix + "20160901", "1st of September focused");

			jQuery("#" +  sMonthIdPrefix + "20160910").focus();
			assert.equal(document.activeElement.id, sMonthIdPrefix + "20160910", "10th of September focused");

			qutils.triggerKeydown(sMonthIdPrefix + "20160910", "END");
			sap.ui.getCore().applyChanges();
			assert.equal(document.activeElement.id,  sMonthIdPrefix + "20160930", "30 of September focused");
		});

		QUnit.test("keyboard navigation ARROW_RIGHT for 1 Month view at the border of 2 months", function (assert) {
			// Prepare
			var oApp1stOct2016 = new CalendarAppointment("app1stOct2016", {
				startDate: new Date(2016, 9, 1, 17),
				endDate: new Date(2016, 9, 1, 18)
			}), $30Sep, $1stOct;


			this.oPC2.getRows()[0].addAppointment(oApp1stOct2016);
			_switchToView(CalendarIntervalType.OneMonth, this.oPC2);
			this.oPC2.setStartDate(this.o1Sep2016MidOfWeek);
			sap.ui.getCore().applyChanges();

			// Get days
			this.oPC2Interval = this.oPC2.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
			this.oPC2IntervalRow = this.oPC2Interval.getAggregation('month')[0];

			aDays = this.oPC2IntervalRow.$("days").children();
			$30Sep = aDays[29];
			$1stOct = aDays[30];

			// Act
			// Focus 30th of Sep, 2016 and move right via keyboard, expect appointment for 1 of Oct to be visible once
			// the view is switched to October
			qutils.triggerEvent("mousedown", $30Sep); //focus should be done via mouse events, since this is the way Month.js handles focusing
			qutils.triggerEvent("mouseup", $30Sep);
			_navFocusNext.call(this, $1stOct);

			// Assert
			aDays = this.oPC2IntervalRow.$("days").children();
			$1stOct = aDays[0];

			assert.ok(oApp1stOct2016.getDomRef(), "Once moved to October, the 1st appoint. should be visible");
			assert.equal($1stOct.getAttribute("data-sap-day"), "20161001", "Once moved to October, the first day of the month is moved to the beginning of the CalendarOneMonthInterval");

		});

		QUnit.test("When start date is defined the planning calendar should shift to the first day of the week that includes the start date ", function(assert) {
			//assert initial state
			_assertDatesAreVisible.call(this, [
						new Date(2016, 7, 29),
						new Date(2016, 7, 30),
						new Date(2016, 7, 31),
						new Date(2016, 8, 1),
						new Date(2016, 8, 2),
						new Date(2016, 8, 3),
						new Date(2016, 8, 4)],
					this.oPC2, "Initially set start date");
			//act
			this.oPC2.setStartDate(this.o10Sep2016);
			sap.ui.getCore().applyChanges();

			//assert
			_assertDatesAreVisible.call(this, [
						new Date(2016, 8, 5),
						new Date(2016, 8, 6),
						new Date(2016, 8, 7),
						new Date(2016, 8, 8),
						new Date(2016, 8, 9),
						new Date(2016, 8, 10),
						new Date(2016, 8, 11)],
					this.oPC2, "StartDate modified afterwards");
		});

		QUnit.test("Navigation backward via back button", function(assert) {
			//act
			_navBackward.call(this, this.oPC2);//one week before week 29th of August 2016 - 4th of September, 2016

			//assert
			_assertDatesAreVisible.call(this, [
						new Date(2016, 7, 22),
						new Date(2016, 7, 23),
						new Date(2016, 7, 24),
						new Date(2016, 7, 25),
						new Date(2016, 7, 26),
						new Date(2016, 7, 27),
						new Date(2016, 7, 28)],
					this.oPC2, "Initially navigating back once");

			//act
			_navBackward.call(this, this.oPC2);//two weeks before

			//assert
			_assertDatesAreVisible.call(this, [
						new Date(2016, 7, 15),
						new Date(2016, 7, 16),
						new Date(2016, 7, 17),
						new Date(2016, 7, 18),
						new Date(2016, 7, 19),
						new Date(2016, 7, 20),
						new Date(2016, 7, 21)],
					this.oPC2, "Navigating back twice");
		});


		QUnit.test("Navigation backward via keyboard left arrow (outside the current visible area)", function(assert) {
			var $Days = this.oPC2IntervalRow.$("days"),
					aDays = $Days.children(),
					oNextTarget = aDays[0],
					oSelf = this,
					fnDone = assert.async();
			//Focus 29th of Aug (week 29 Aug - 4 Sep), 2016 and move left via keyboard 4 times, expect 22 -28 Aug 2016
			//act
			aDays.eq(0).focus();
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				oNextTarget = _navFocusPrev.call(oSelf, oNextTarget);
				_assertFocus.call(oSelf, oNextTarget);
				setTimeout(function () {
					oNextTarget = _navFocusPrev.call(oSelf, oNextTarget);
					_assertFocus.call(oSelf, oNextTarget);
					setTimeout(function () {
						oNextTarget = _navFocusPrev.call(oSelf, oNextTarget);
						_assertFocus.call(oSelf, oNextTarget);
						setTimeout(function () {
							oNextTarget = _navFocusPrev.call(oSelf, oNextTarget);
							_assertFocus.call(oSelf, oNextTarget);
							setTimeout(function () {
								_assertDatesAreVisible.call(oSelf, [
									new Date(2016, 7, 22),
									new Date(2016, 7, 23),
									new Date(2016, 7, 24),
									new Date(2016, 7, 25),
									new Date(2016, 7, 26),
									new Date(2016, 7, 27),
									new Date(2016, 7, 28)
								], oSelf.oPC2, "Navigated to the correct viewport");
								fnDone();
							}, 0);
						}, 0);
					}, 0);
				}, 0);
			}, 0);
		});

		QUnit.test("Navigation backward via keyboard left arrow (outside the current visible area) at the border of the DST (Nov->Oct)", function(assert) {
			//prepare
			var oOriginalFormatLocale = sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale(),
					sOriginalFormatLocale = oOriginalFormatLocale.getLanguage() + "_" +  oOriginalFormatLocale.getRegion(),
					$Days,
					aDays,
					oNextTarget,
					oSelf = this,
					fnDone = assert.async();

			sap.ui.getCore().getConfiguration().setFormatLocale("en-US");
			this.oPC2.setStartDate(new Date("2014", "10", "5", "08", "00"));
			this.oPC2.rerender();

			$Days = this.oPC2IntervalRow.$("days");
			aDays = $Days.children();
			oNextTarget = aDays[0];

			//Act - focus 2nd of Nov (week 02 Nov - 8 Nov), 2014 and move left via keyboard once, expect 26 Oct - 1 Nov 2014
			aDays.eq(0).focus();
			sap.ui.getCore().applyChanges();
			setTimeout(function() {
				oNextTarget = _navFocusPrev.call(oSelf, oNextTarget);
				_assertFocus.call(oSelf, oNextTarget);
					_assertDatesAreVisible.call(oSelf, [
						new Date(2014, 9, 26),
						new Date(2014, 9, 27),
						new Date(2014, 9, 28),
						new Date(2014, 9, 29),
						new Date(2014, 9, 30),
						new Date(2014, 9, 31),
						new Date(2014, 10, 1)
					], oSelf.oPC2, "Navigated to the correct viewport");
					sap.ui.getCore().getConfiguration().setFormatLocale(sOriginalFormatLocale);
					fnDone();
			}, 0);
		});

		QUnit.test("Navigation forward via forward button", function(assert) {
			//act
			_navForward.call(this, this.oPC2);//one week after week 29th of August 2016 - 4th of September, 2016

			//assert
			_assertDatesAreVisible.call(this, [
						new Date(2016, 8, 5),
						new Date(2016, 8, 6),
						new Date(2016, 8, 7),
						new Date(2016, 8, 8),
						new Date(2016, 8, 9),
						new Date(2016, 8, 10),
						new Date(2016, 8, 11)],
					this.oPC2, "Navigating forward once");

			//act
			_navForward.call(this, this.oPC2);//two weeks after

			//assert
			_assertDatesAreVisible.call(this, [
						new Date(2016, 8, 12),
						new Date(2016, 8, 13),
						new Date(2016, 8, 14),
						new Date(2016, 8, 15),
						new Date(2016, 8, 16),
						new Date(2016, 8, 17),
						new Date(2016, 8, 18)],
					this.oPC2, "Navigating forward twice");
		});

		QUnit.test("Navigation forward via keyboard right (outside the current visible area)", function(assert) {
			var $Days = this.oPC2IntervalRow.$("days"),
					aDays = $Days.children(),
					oNextTarget = aDays[aDays.length-1],
					oSelf = this,
					fnDone = assert.async();
			//Focus 4th of Sep, 2016 (week 29 Aug-4 Sep) and move right via keyboard 4 times, expect 5 -11 Sep 2016
			//act
			aDays.eq(aDays.length-1).focus();
			sap.ui.getCore().applyChanges();

			setTimeout(function() {
				oNextTarget = _navFocusNext.call(oSelf, oNextTarget);
				_assertFocus.call(oSelf, oNextTarget);
				setTimeout(function () {
					oNextTarget = _navFocusNext.call(oSelf, oNextTarget);
					_assertFocus.call(oSelf, oNextTarget);
					setTimeout(function () {
						oNextTarget = _navFocusNext.call(oSelf, oNextTarget);
						_assertFocus.call(oSelf, oNextTarget);
						setTimeout(function () {
							oNextTarget = _navFocusNext.call(oSelf, oNextTarget);
							_assertFocus.call(oSelf, oNextTarget);
							setTimeout(function () {
								_assertDatesAreVisible.call(oSelf, [
									new Date(2016, 8, 5),
									new Date(2016, 8, 6),
									new Date(2016, 8, 7),
									new Date(2016, 8, 8),
									new Date(2016, 8, 9),
									new Date(2016, 8, 10),
									new Date(2016, 8, 11)
								], oSelf.oPC2, "Navigated to the correct viewport");
								fnDone();
							}, 0);
						}, 0);
					}, 0);
				}, 0);
			}, 0);
		});

		QUnit.test("Navigation forward in week view where next week starts at 1st January (locale en_US)", function(assert) {
			var $Days,
				aDays,
				oNextTarget,
				oSelf = this,
				fnDone = assert.async(),
				oOriginalFormatLocale = sap.ui.getCore().getConfiguration().getFormatLocale();

			//arrange
			sap.ui.getCore().getConfiguration().setFormatLocale('en_US');
			this.oPC2.setStartDate(new Date(2016, 11, 31));
			this.oPC2.setViewKey(sap.ui.unified.CalendarIntervalType.Week);

			$Days = this.oPC2IntervalRow.$("days");
			aDays = $Days.children();
			oNextTarget = aDays[aDays.length-1];

			//act
			aDays.eq(aDays.length-1).focus();
			sap.ui.getCore().applyChanges();

			_navFocusNext.call(this, oNextTarget);
			setTimeout(function() {
				//assert
				_assertDatesAreVisible.call(oSelf, [
					new Date(2017, 0, 1),
					new Date(2017, 0, 2),
					new Date(2017, 0, 3),
					new Date(2017, 0, 4),
					new Date(2017, 0, 5),
					new Date(2017, 0, 6),
					new Date(2017, 0, 7)
				], oSelf.oPC2, "Navigated to 1st of January");

				//clear
				sap.ui.getCore().getConfiguration().setFormatLocale(oOriginalFormatLocale);
				fnDone();
			}, 0);
		});

		QUnit.test("Navigation backward and forward", function(assert) {
			var i;
			//act
			for (i = 0; i < 10; i++) {
				_navForward.call(this, this.oPC2);
			}
			for (i = 0; i < 9; i++) {
				_navBackward.call(this, this.oPC2);
			}
			//Expected is one week after the initial - Sep 5th, 2016 - Sep 11th, 2016

			//assert
			_assertDatesAreVisible.call(this, [
						new Date(2016, 8, 5),
						new Date(2016, 8, 6),
						new Date(2016, 8, 7),
						new Date(2016, 8, 8),
						new Date(2016, 8, 9),
						new Date(2016, 8, 10),
						new Date(2016, 8, 11)],
					this.oPC2, "Navigating forward once");
		});

		QUnit.test("Selecting the visible dates from the previous/next month in the calendar picker", function (assert) {
			// Prepare
			var oApp30Aug2016 = new CalendarAppointment("app30Aug2016", {
				startDate: new Date(2016, 7, 30, 6),
				endDate: new Date(2016, 7, 30, 10)
			}), oApp2ndSept2016 = new CalendarAppointment("app2ndSept2016", {
				startDate: new Date(2016, 8, 2, 6),
				endDate: new Date(2016, 8, 2, 10)
			}), aDays, $FirstInterval;

			this.oPC2.getRows()[0].addAppointment(oApp30Aug2016);
			this.oPC2.getRows()[0].addAppointment(oApp2ndSept2016);

			// Act
			_switchToView(CalendarIntervalType.Hour, this.oPC2);
			sap.ui.getCore().applyChanges();

			qutils.triggerEvent("click", "startDateAtTheMiddleOfTheWeek-TimeInt--Head-B1");
			qutils.triggerEvent("mousedown", "startDateAtTheMiddleOfTheWeek-TimeInt--Cal--Month0-20160902");
			qutils.triggerEvent("mouseup", "startDateAtTheMiddleOfTheWeek-TimeInt--Cal--Month0-20160902");
			sap.ui.getCore().applyChanges();

			this.oPC2Interval = this.oPC2.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
			this.oPC2IntervalRow = this.oPC2Interval.getAggregation('timesRow');
			aDays = this.oPC2IntervalRow.$("times").children();
			$FirstInterval = aDays[0];

			// Assert
			assert.ok(oApp2ndSept2016.getDomRef(), "Once moved to date of previous/next month, the appointment there should be visible");
			assert.equal($FirstInterval.getAttribute("data-sap-time"), "201609020100", "Once clicked on a date from the visible range of the previous/next month, the PlanningCalendar is displaying the right view.");

			// Act
			_switchToView(CalendarIntervalType.Day, this.oPC2);
			sap.ui.getCore().applyChanges();

			qutils.triggerEvent("click", "startDateAtTheMiddleOfTheWeek-DateInt--Head-B1");
			qutils.triggerEvent("mousedown", "startDateAtTheMiddleOfTheWeek-DateInt--Cal--Month0-20160830");
			qutils.triggerEvent("mouseup", "startDateAtTheMiddleOfTheWeek-DateInt--Cal--Month0-20160830");
			sap.ui.getCore().applyChanges();

			this.oPC2Interval = this.oPC2.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
			this.oPC2IntervalRow = this.oPC2Interval.getAggregation('month')[0];
			aDays = this.oPC2IntervalRow.$("days").children();
			$FirstInterval = aDays[0];

			// Assert
			assert.ok(oApp30Aug2016.getDomRef(), "Once moved to date of previous/next month, the appointment there should be visible");
			assert.equal($FirstInterval.getAttribute("data-sap-day"), "20160830", "Once clicked on a date from the visible range of the previous/next month, the PlanningCalendar is displaying the right view.");

			// Act
			_switchToView(CalendarIntervalType.Week, this.oPC2);
			sap.ui.getCore().applyChanges();

			qutils.triggerEvent("click", "startDateAtTheMiddleOfTheWeek-WeekInt--Head-next");
			qutils.triggerEvent("click", "startDateAtTheMiddleOfTheWeek-WeekInt--Head-B1");
			qutils.triggerEvent("mousedown", "startDateAtTheMiddleOfTheWeek-WeekInt--Cal--Month0-20160830");
			qutils.triggerEvent("mouseup", "startDateAtTheMiddleOfTheWeek-WeekInt--Cal--Month0-20160830");
			sap.ui.getCore().applyChanges();

			this.oPC2Interval = this.oPC2.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
			this.oPC2IntervalRow = this.oPC2Interval.getAggregation('month')[0];
			aDays = this.oPC2IntervalRow.$("days").children();
			$FirstInterval = aDays[0];

			// Assert
			assert.ok(oApp30Aug2016.getDomRef(), "Once moved to date of previous month/next, the appointment there should be visible");
			assert.equal($FirstInterval.getAttribute("data-sap-day"), "20160829", "Once clicked on a date from the visible range of the previous/next month, the PlanningCalendar is displaying the right view.");
		});

		QUnit.test("'Today' button should be disabled when current day is visible", function(assert) {
			//assert
			assert.equal(_getTodayButton.call(this, this.oPC2).getEnabled(), true, "Today button should be enabled as current day IS NOT visible");

			//act
			this.oPC2.setStartDate(new Date());
			//assert
			assert.equal(_getTodayButton.call(this, this.oPC2).getEnabled(), false, "Today button should not be enabled  as current day IS visible");
		});

		QUnit.test("Clicking 'Today' button navigates to the week of the current day", function (assert) {
			//prepare
			var oFakeNow = this.o10Sep2016,
					clock = sinon.useFakeTimers(oFakeNow.getTime());
			this.oPC2.rerender(); //start date is 1st of September 2016

			assert.equal(_getTodayButton.call(this, this.oPC2).getEnabled(), true, "Today button should be enabled as current day IS NOT visible");
			//act
			_clickTodayButton.call(this, this.oPC2);
			assert.equal(_getTodayButton.call(this, this.oPC2).getEnabled(), false, "Today button should not be enabled as current day IS visible");

			_assertDatesAreVisible.call(this, [
						new Date(2016, 8, 5),
						new Date(2016, 8, 6),
						new Date(2016, 8, 7),
						new Date(2016, 8, 8),
						new Date(2016, 8, 9),
						new Date(2016, 8, 10),
						new Date(2016, 8, 11)],
					this.oPC2, "StartDate modified afterwards");
			//assert
			assert.equal(_getTodayButton.call(this, this.oPC2).getEnabled(), false, "Today button should not be enabled as current day IS visible");
			//cleanup
			clock.restore();

		});

		QUnit.test("Clicking 'Today' button in week view then changing back to hours shows the hours unchanged", function (assert) {
			//act
			var oFakeNow = new Date(2016, 8, 1, 3),
					clock = sinon.useFakeTimers(oFakeNow.getTime()),
					aExpectedVisibleHours = [];
			this.oPC2.setStartDate(this.o10Sep2016Morning);
			clock.tick(10); //start date is 10st of September 2016 09:00

			//act
			_clickTodayButton.call(this, this.oPC2);
			clock.tick(10);

			_switchToView.call(this, CalendarIntervalType.Hour, this.oPC2);
			clock.tick(10);

			//assert
			iInterval = jQuery("#" + this.oPC2.getId()).outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[1] ? 6 : 12;

			//assert
			if (iInterval === 12) { //Hours View large
				aExpectedVisibleHours = [
							new Date(2016, 7, 29, 9),
							new Date(2016, 7, 29, 10),
							new Date(2016, 7, 29, 11),
							new Date(2016, 7, 29, 12),
							new Date(2016, 7, 29, 13),
							new Date(2016, 7, 29, 14),
							new Date(2016, 7, 29, 15),
							new Date(2016, 7, 29, 16),
							new Date(2016, 7, 29, 17),
							new Date(2016, 7, 29, 18),
							new Date(2016, 7, 29, 19),
							new Date(2016, 7, 29, 20)];
			} else {
				aExpectedVisibleHours = [
							new Date(2016, 7, 29, 9),
							new Date(2016, 7, 29, 10),
							new Date(2016, 7, 29, 11),
							new Date(2016, 7, 29, 12),
							new Date(2016, 7, 29, 13),
							new Date(2016, 7, 29, 14)];
			}

			_assertHoursAreVisible.call(this, aExpectedVisibleHours, this.oPC2,
					"10 Sept 2016, 09:00: Weeks->Today(01 Sep, 00:00)->Hours");

			//cleanup
			clock.restore();
		});

		QUnit.test("'Today' button visibility works only with week view", function (assert) {
			//prepare
			var oFakeNow = this.o10Sep2016,
					clock = sinon.useFakeTimers(oFakeNow.getTime());
			this.oPC2.rerender(); //start date is 1st of September 2016

			//act
			_clickTodayButton.call(this, this.oPC2);
			clock.tick(10);
			_switchToView.call(this, CalendarIntervalType.Hour, this.oPC2);
			clock.tick(10);

			//assert
			assert.equal(_getTodayButton.call(this, this.oPC2).getEnabled(), true, "Today button should be enabled for non 'week' views although 'today' is in visible area");

			//act
			_switchToView.call(this, CalendarIntervalType.Week, this.oPC2);
			clock.tick(10);

			//assert
			assert.equal(_getTodayButton.call(this, this.oPC2).getEnabled(), false, "Today button should not be enabled for non 'week' views when switched back from hours view");

			//cleanup
			clock.restore();
		});

		QUnit.test("If view changed from Week->Hours, we see hours for first day of the previously shown week", function (assert) {
			var iInterval;
			//startDate 1st of september 2016(Thursday)->show hours for the 1st day of week 29 Aug 2016 (Monday)
			 //prepare
			_switchToView.call(this, CalendarIntervalType.Hour, this.oPC2);
			sap.ui.getCore().applyChanges();

			iInterval = jQuery("#" + this.oPC2.getId()).outerWidth() < sap.ui.Device.media._predefinedRangeSets[sap.ui.Device.media.RANGESETS.SAP_STANDARD_EXTENDED].points[1] ? 6 : 12;

			//assert
			if (iInterval === 12) { //Hours View large
				_assertHoursAreVisible.call(this, [
							new Date(2016, 7, 29, 1),
							new Date(2016, 7, 29, 2),
							new Date(2016, 7, 29, 3),
							new Date(2016, 7, 29, 4),
							new Date(2016, 7, 29, 5),
							new Date(2016, 7, 29, 6),
							new Date(2016, 7, 29, 7),
							new Date(2016, 7, 29, 8),
							new Date(2016, 7, 29, 9),
							new Date(2016, 7, 29, 10),
							new Date(2016, 7, 29, 11),
							new Date(2016, 7, 29, 12)],
						this.oPC2, "1 Sept 2016, 01:00: Weeks->Hours");
			} else { //6, Hours View small - 6
				_assertHoursAreVisible.call(this, [
					new Date(2016, 7, 29, 1),
					new Date(2016, 7, 29, 2),
					new Date(2016, 7, 29, 3),
					new Date(2016, 7, 29, 4),
					new Date(2016, 7, 29, 5),
					new Date(2016, 7, 29, 6)],
						this.oPC2, "1 Sept 2016, 01:00: Weeks->Hours");
			}

		});


		QUnit.test("Week view - click on different dates keeps the focus and week", function(assert) {
			//Prepare
			var aWeekDays = this.oPC2IntervalRow.$("days").children();

			//Act
			aWeekDays.eq(1).focus();
			sap.ui.getCore().applyChanges();
			aWeekDays.eq(2).focus();
			sap.ui.getCore().applyChanges();
			aWeekDays.eq(3).focus();
			sap.ui.getCore().applyChanges();

			//Assert
			_assertFocus.call(this, aWeekDays[3]);
			//assert initial state
			_assertDatesAreVisible.call(this, [
						new Date(2016, 7, 29),
						new Date(2016, 7, 30),
						new Date(2016, 7, 31),
						new Date(2016, 8, 1),
						new Date(2016, 8, 2),
						new Date(2016, 8, 3),
						new Date(2016, 8, 4)],
					this.oPC2, "Initial week should not be changed");
		});

		QUnit.module("OneMonth view", {
			beforeEach: function() {
				var oSearchField = new sap.m.SearchField(),
						oButton = new sap.m.Button();
				this.o14Sep2016MidOfMonth = new Date(2016, 8, 14);
				this.o10Feb2016 = new Date(2016, 1, 10);
				this.oPC = createPlanningCalendar("oneMonthPlanningCalendar", oSearchField, oButton, this.o14Sep2016MidOfMonth,
						CalendarIntervalType.OneMonth);
				this.oPC.placeAt("uiArea1");
				sap.ui.getCore().applyChanges();
				this.oPCInterval = this.oPC.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
			},

			afterEach: function() {
				if (!bSkipDestroy) {
					this.oPC.destroy();
				}
			},

			_assertIntervalHasClass: function (iInterval, oPC, sCSSClass) {
				var iIntervalIndex = iInterval - 1;
				var oFirstCalendarRow = this._getFirstRow(oPC);
				var sIntervalId = oFirstCalendarRow.getId() + "-AppsInt" + iIntervalIndex.toString();

				assert.ok(jQuery("#" + sIntervalId).hasClass(sCSSClass), "Interval " + iInterval + " should have class " + sCSSClass + " applied");
			},

			_getFirstRow: function(oPC) {
				return oPC.getAggregation("table").getItems()[0].getCells()[1];
			},

			_get1stInNextMonth: function(oDate) {
				if (oDate.getMonth() == 11) {
					var oNext = new Date(oDate.getFullYear() + 1, 0, 1);
				} else {
					var oNext = new Date(oDate.getFullYear(), oDate.getMonth() + 1, 1);
				}

				return oNext;
			},

			_getNextDay: function(oDate) {
				var oNext = new Date(oDate);
				oNext.setDate(oNext.getDate()+1);

				return oNext;
			},

			_getIntervalDom: function(oRow, iInterval) {
				var iIntervalIndex = iInterval - 1;
				var sIntervalId = oRow.getId() + "-AppsInt" + iIntervalIndex.toString();

				return document.getElementById(sIntervalId);
			},

			_clickInterval: function(oRow, iInterval) {
				jQuery(this._getIntervalDom(oRow, iInterval)).trigger('tap');
			},

			_clickAppointment: function(oAppointment) {
				oAppointment.$().trigger('tap');
			}
		});

		QUnit.test('OneMonth item is in the select', function(assert) {
			//act and assert
			_switchToView.call(this, CalendarIntervalType.OneMonth, this.oPC);
		});

		QUnit.test('interval shows 31 days', function(assert) {
			//assert
			assert.equal(this.oPCInterval.getStartDate().getMonth(), 8, 'it is september');
			assert.equal(this.oPCInterval.getDays(), 31, 'interval has 31 days in september');
			//act - change to february
			_switchToDate(this.oPC, this.oPCInterval, 1, 1, this.oPCInterval.getStartDate().getFullYear());

			//assert
			assert.equal(this.oPCInterval.getStartDate().getMonth(), 1, 'it is february');
			assert.equal(this.oPCInterval.getDays(), 31, 'interval has 31 days in february');
		});

		QUnit.test('start day is the first day of the month', function(assert) {
			//assert
			assert.equal(this.oPCInterval.getStartDate().getMonth(), 8, 'it is september');
			assert.equal(this.oPCInterval.getStartDate().getDate(), 1, 'interval starts at 1st of september');

			//act - change to 5th of june
			_switchToDate(this.oPC, this.oPCInterval, 5, 5, this.oPCInterval.getStartDate().getFullYear());

			//assert
			assert.equal(this.oPCInterval.getStartDate().getMonth(), 5, 'it is june');
			assert.equal(this.oPCInterval.getStartDate().getDate(), 1, 'interval starts at 1st of june');
		});

		QUnit.test('last days belong to the next month', function(assert) {
			//assert
			var o1Oct2016 = this._get1stInNextMonth(this.o14Sep2016MidOfMonth);
			var o1Mar2016 = this._get1stInNextMonth(this.o10Feb2016);
			var o2Mar2016 = this._getNextDay(o1Mar2016);

			_assertDateIsVisible.call(this, o1Oct2016, this.oPC, '');

			//act - change to 5th of february
			_switchToDate(this.oPC, this.oPCInterval, 5, 1, this.oPCInterval.getStartDate().getFullYear());

			//assert
			_assertDateIsVisible.call(this, o1Mar2016, this.oPC, '');
			_assertDateIsVisible.call(this, o2Mar2016, this.oPC, '');
		});

		QUnit.test('last days look different', function(assert) {
			//assert
			this._assertIntervalHasClass(31, this.oPC, 'sapUiCalItemOtherMonth'); //check that Oct 1 is disabled
		});

		QUnit.test('last days display appointments', function(assert) {
			var oAppointment1July2014 = sap.ui.getCore().byId(this.oPC.getId() + "-R1A4");

			//act
			_switchToDate(this.oPC, this.oPCInterval, this.oPCInterval.getStartDate().getDate(), 5, 2014);
			sap.ui.getCore().applyChanges();

			//assert
			assert.ok(oAppointment1July2014.getDomRef(), "appointment is rendered");
		});

		QUnit.test('intervalSelect fires correctly', function(assert) {
			var oRow = this._getFirstRow(this.oPC);
			var eventParams = {};
			bIntervalSelect = false;

			oRow.attachIntervalSelect(function(oEvent) {
				eventParams = oEvent.getParameters();
			});

			//act
			this._clickInterval(oRow, 31); //click first row of next month's first day - 1 Oct 2016

			//assert
			assert.equal(eventParams.startDate.getMonth(), 9, 'start date is in october');
			assert.equal(eventParams.startDate.getDate(), 1, 'start date is 1st day of the month');

			assert.equal(eventParams.endDate.getMonth(), 9, 'end date is in october');
			assert.equal(eventParams.endDate.getDate(), 1, 'end date is 1st day of the month');

			assert.equal(eventParams.subInterval, false, 'selected interval is not a sub-interval');
			assert.ok(!bIntervalSelect,
					"intervalSelect was not fired because the click was on the next month's first days and this serves as navigation, not selection");
		});

		QUnit.test('select fires correctly', function(assert) {
			var oRow = this._getFirstRow(this.oPC);
			var eventParams = {};
			oRow.attachSelect(function(oEvent) {
				eventParams = oEvent.getParameters();
			});
			var oAppointment1July2014 = sap.ui.getCore().byId(this.oPC.getId() + "-R1A4");

			//act
			_switchToDate(this.oPC, this.oPCInterval, this.oPCInterval.getStartDate().getDate(), 5, 2014);
			sap.ui.getCore().applyChanges();

			//act
			this._clickAppointment(oAppointment1July2014);

			//assert
			assert.equal(eventParams.appointment, oAppointment1July2014, 'appointment is the same that was clicked');
			assert.equal(eventParams.multiSelect, false, 'multiSelect is correct');
		});

		QUnit.test('last days intervals navigate to the next month', function(assert) {
			//act
			this._clickInterval(this._getFirstRow(this.oPC), 31); //click first row of next month's first day - 1 Oct 2016

			//assert
			assert.equal(this.oPC.getStartDate().getMonth(), 9, 'month changed to october');
		});

		QUnit.test('navigate backward with the arrows', function(assert) {
			//act
			_navBackward.call(this, this.oPC);

			//assert
			assert.equal(this.oPC.getStartDate().getMonth(), 7, 'month changed to august');
			assert.equal(this.oPC.getStartDate().getDate(), 1, 'start date is 1st');
		});

		QUnit.test('navigate forward with the arrows', function(assert) {
			//act
			_navForward.call(this, this.oPC);

			//assert
			assert.equal(this.oPC.getStartDate().getMonth(), 9, 'month changed to october');
			assert.equal(this.oPC.getStartDate().getDate(), 1, 'start date is 1st');
		});

		QUnit.test('today button is disabled when today is visible', function(assert) {
			var oToday = new Date();
			var oTodayBtn = _getTodayButton.call(this, this.oPC);

			//assert
			assert.equal(oTodayBtn.getEnabled(), true, 'today button is enabled');

			//act
			//_switchDate....
			_switchToDate(this.oPC, this.oPCInterval, this.oPCInterval.getStartDate().getDate(), oToday.getMonth(), oToday.getFullYear());

			//assert
			assert.equal(oTodayBtn.getEnabled(), false, 'today button is disabled when today is visible');
		});

		QUnit.test('clicking today navigates to todays month', function(assert) {
			var oToday = new Date();

			//act
			_clickTodayButton.call(this, this.oPC);

			//assert
			assert.equal(this.oPC.getStartDate().getFullYear(), oToday.getFullYear(), 'year is correct');
			assert.equal(this.oPC.getStartDate().getMonth(), oToday.getMonth(), 'month is correct');
			assert.equal(this.oPC.getStartDate().getDate(), 1, 'date is correct');
		});

		QUnit.test('switch to hours view shows the first hours of the month', function(assert) {
			//act
			_switchToView.call(this, CalendarIntervalType.Hour, this.oPC);

			//assert
			assert.equal(this.oPC.getStartDate().getFullYear(), 2016, 'year is the same');
			assert.equal(this.oPC.getStartDate().getMonth(), 8, 'month is the same');
			assert.equal(this.oPC.getStartDate().getDate(), 1, 'date is 1st');
			assert.equal(this.oPC.getStartDate().getHours(), 0, 'starts from midnight');
		});

		QUnit.test('switch to days view starts from 1st', function(assert) {
			//act
			_switchToView.call(this, CalendarIntervalType.Day, this.oPC);

			//assert
			assert.equal(this.oPC.getStartDate().getFullYear(), 2016, 'year is the same');
			assert.equal(this.oPC.getStartDate().getMonth(), 8, 'month is the same');
			assert.equal(this.oPC.getStartDate().getDate(), 1, 'date is 1st');
		});

		QUnit.test('switch to month view starts from the same month', function(assert) {
			//act
			_switchToView.call(this, CalendarIntervalType.Month, this.oPC);

			//assert
			assert.equal(this.oPC.getStartDate().getFullYear(), 2016, 'year is the same');
			assert.equal(this.oPC.getStartDate().getMonth(), 8, 'month is the same');
		});

		QUnit.test("checks for sapUiCalOneMonthInt class", function(assert) {
			//Assert
			assert.ok(this.oPCInterval.$().hasClass("sapUiCalOneMonthInt"), "sapUiCalOneMonthInt is rendered");
		});

		QUnit.test("Has sticky header on big size", function () {

			//act
			_switchToView.call(this, CalendarIntervalType.Month, this.oPC);
			this.oPC.setStickyHeader(true);
			sap.ui.getCore().applyChanges();

			// assert
			assert.ok(this.oPC.$("InfoToolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class should be set on the info bar");
			assert.ok(this.oPC.$("Toolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class should be set on the toolbar");
		});

		QUnit.module("OneMonth view (size S)", {
			beforeEach: function () {
				this._simulateMobileEnvironment();
				this.o14Sep2016MidOfMonth = new Date(2016, 8, 14);
			},
			afterEach: function () {
				this._restoreDesktopEnvironment();
				this._destroyCalendar();
				this.o14Sep2016MidOfMonth = undefined;
			},
			_simulateMobileEnvironment: function () {
				this.oDeviceJsStub = sinon.sandbox.stub(sap.ui.Device, "system", {phone: true});
				jQuery("html").addClass("sapUiMedia-Std-Phone sapUiMedia-StdExt-Phone");
				jQuery("html").removeClass("sapUiMedia-Std-Desktop sapUiMedia-StdExt-Desktop");
			},
			_restoreDesktopEnvironment: function () {
				this.oDeviceJsStub.restore();
				jQuery("html").addClass("sapUiMedia-Std-Desktop sapUiMedia-StdExt-Desktop");
				jQuery("html").removeClass("sapUiMedia-Std-Phone sapUiMedia-StdExt-Phone");
			},
			_createCalendar: function (oStartDate) {
				this._oPC = createPlanningCalendar("_oPC", new sap.m.SearchField(), new sap.m.Button(), (oStartDate || this.o14Sep2016MidOfMonth), CalendarIntervalType.OneMonth);
				this._oPC.placeAt('uiArea3');
				this._oPCOneMonthInterval = this._oPC.getAggregation('table').getAggregation('infoToolbar').getContent()[1];
				sap.ui.getCore().applyChanges();
			},
			_destroyCalendar: function () {
				if (this._oPC) {
					this._oPC.destroy();
					this._oPC = undefined;
				}
			}
		});

		QUnit.test("'setViewKeys()' setter calls 'OneMonthInterval._setDisplayMode()' with correct 'iSize' parameter", function (assert) {
			//arrange
			var oSetDisplayModeSpy = this.spy(sap.ui.unified.CalendarOneMonthInterval.prototype, "_setDisplayMode"),
				iPhoneSize = 0;

			this._createCalendar();
			//assert
			assert.strictEqual(oSetDisplayModeSpy.callCount, 3, "'_setDisplayMode()' is called correct number of times"); //viewKey setter + onBeforeRendering + resizeHandler
			assert.strictEqual(oSetDisplayModeSpy.getCall(0).args[0], iPhoneSize, "The correct mode value is set");
		});

		QUnit.test("'setViewKeys()' setter calls 'setStartDate()' setter with an auto switched to 1st day of the month date", function (assert) {
			//arrange
			var oStartDateSetterSpy = this.spy(sap.m.PlanningCalendar.prototype, "setStartDate");
			this._createCalendar();
			//assert
			assert.strictEqual(oStartDateSetterSpy.callCount, 3, "'setStartDate()' setter is called correct number of times"); //init + startDate setter + OneMonth adjustment.
			assert.strictEqual(oStartDateSetterSpy.getCall(1).args[0].getTime(), this.o14Sep2016MidOfMonth.getTime(), "The correct date is auto adjusted for the first day of month");
			assert.strictEqual(oStartDateSetterSpy.getCall(2).args[0].getTime(), new Date(2016, 8, 1).getTime(), "The correct date is auto adjusted for the first day of month");
		});

		QUnit.test("'setStartDate()' setter calls '_setRowsStartDate()' with correct date parameter", function (assert) {
			//arrange
			this._createCalendar();
			var oSetRowsStartDateSpy = this.spy(this._oPC, "_setRowsStartDate");

			//act
			this._oPC.setStartDate(new Date(2015, 3, 5));

			//assert
			assert.strictEqual(oSetRowsStartDateSpy.callCount, 1, "'_setRowsStartDate()' is called only once");
			assert.strictEqual(oSetRowsStartDateSpy.getCall(0).args[0].getTime(), new Date(2015, 3, 1).getTime(), "'_setRowsStartDate()' is called with correct parameter");
		});

		QUnit.test("_setRowsStartDate", function(assert) {
			var oTestDate = new Date(5, 5, 5);
			this._createCalendar();
			this._oPC._setRowsStartDate(oTestDate);
			assert.equal(_getRowTimeline(this._oPC.getRows()[0]).getStartDate().getTime(), oTestDate.getTime(), 'row 1 start date');
			assert.equal(_getRowTimeline(this._oPC.getRows()[1]).getStartDate().getTime(), oTestDate.getTime(), 'row 2 start date');
		});

		QUnit.test("'_handleTodayPress()' event handler adjust the startDate to the 1st day of month", function (assert) {
			//arrange
			var oHandleTodayPressSpy = this.spy(sap.m.PlanningCalendar.prototype, "_handleTodayPress"),
				oSetStartDateSpy;

			this._createCalendar();
			//set date outside the current month
			this._oPC.setStartDate(new Date(2000, 0, 1));
			oSetStartDateSpy = this.spy(this._oPC, "setStartDate");
			qutils.triggerEvent('tap', this._oPC._oTodayButton.getDomRef());
			//assert
			assert.strictEqual(oHandleTodayPressSpy.callCount, 1, "'_handleTodayPress()' handler is called once");
			assert.strictEqual(oSetStartDateSpy.callCount, 1, "'setStartDate()' setter is called once");
			//clear
			oHandleTodayPressSpy.restore();
			oSetStartDateSpy.restore();
		});

		QUnit.test("'_handleCalendarSelect()' event handler adjust the startDate to the 1st day of month", function (assert) {
			//arrange
			var oHandleCalendarSelectSpy = this.spy(sap.m.PlanningCalendar.prototype, "_handleCalendarSelect"),
				oPCInterval,
				oPCIntervalMonth;

			this._createCalendar();
			oPCInterval = this._oPC.getAggregation('table').getAggregation('infoToolbar').getContent()[1];
			oPCIntervalMonth = oPCInterval.getAggregation('month')[0];
			var $EventTarget = oPCIntervalMonth.$('days').children().eq(0),
				oEvent = { clientX: 100, clientY: 100, target: $EventTarget.children().get(0) },
				oMouseDownEvent = jQuery.Event("mousedown", oEvent),
				oMouseUpEvent = jQuery.Event("mouseup", oEvent);

			//Calendar selection is implemented on 'mouseup' event so to test this you have to simulate 'mousedown' + 'mouseup' event sequence
			$EventTarget.trigger(oMouseDownEvent);
			$EventTarget.trigger(oMouseUpEvent);
			//assert
			assert.strictEqual(oHandleCalendarSelectSpy.callCount, 1, "'_handleStartDateChange()' event handler is called once");
			//clean
			oHandleCalendarSelectSpy.restore();
		});

		QUnit.test("'CalendarOneMonthInterval._createMonth()'", function (assert) {
			//arrange
			var oOneMonthIntervalCreateMonthSpy = this.spy(sap.ui.unified.CalendarOneMonthInterval.prototype, "_createMonth"),
				oDateIntervalCreateMonthSpy = this.spy(sap.ui.unified.CalendarDateInterval.prototype, "_createMonth"),
				fnGetFullMonthId = function (oPC) {
					return oPC.getId() + "-" + _getIntervalId(oPC);
				};

			this._createCalendar();
			//assert
			assert.strictEqual(oDateIntervalCreateMonthSpy.callCount, 0, "'CalendarDateInterval._createMonth()' method was NOT called");
			assert.strictEqual(oOneMonthIntervalCreateMonthSpy.callCount, 1, "'CalendarOneMonthInterval._createMonth()' method was overridden and called");
			assert.strictEqual(oOneMonthIntervalCreateMonthSpy.getCall(0).args[0], fnGetFullMonthId(this._oPC), "'CalendarOneMonthInterval._createMonth()' was called with correct parameters");
			//clean
			oOneMonthIntervalCreateMonthSpy.restore();
		});

		QUnit.test("'OneMonthDatesRow.init()' calls its super class 'init()' and sets its internal private property 'iMode' to the default value '2'", function (assert) {
			//arrange
			var oOneMonthDatesRow = sap.ui.unified.calendar.OneMonthDatesRow,
				oOneMonthDatesRowSpy = this.spy(oOneMonthDatesRow.prototype, "init"),
				oDatesRowSpy = this.spy(sap.ui.unified.calendar.DatesRow.prototype, "init");

			this._createCalendar();
			//assert
			assert.strictEqual(oOneMonthDatesRowSpy.callCount, 1, "'OneMonthDatesRow.init()' method was called once");
			assert.strictEqual(oDatesRowSpy.callCount, 1, "'OneMonthDatesRow.init()' method was called once");
			assert.ok(oOneMonthDatesRowSpy.calledBefore(oDatesRowSpy), "The call sequence is as expected");
			assert.strictEqual(this._oPCOneMonthInterval.getAggregation("month")[0].iMode, 2, "'OneMonthDatesRow.init()' correctly set the internal 'iMode' property to its default value");
			//clean
			oOneMonthDatesRowSpy.restore();
			oDatesRowSpy.restore();
		});

		QUnit.test("'OneMonthDatesRow.setMode()' updates the iMode property", function (assert) {
			//arrange
			this._createCalendar();
			//assert
			assert.strictEqual(this._oPCOneMonthInterval.getAggregation("month")[0].iMode, 2, "'OneMonthDatesRow.init()' correctly sets the internal 'iMode' property to its default value");
			//arrange
			this._oPCOneMonthInterval.getAggregation("month")[0].setMode(0);
			//assert
			assert.strictEqual(this._oPCOneMonthInterval.getAggregation("month")[0].iMode, 0, "'OneMonthDatesRow.setMode()' sets the internal 'iMode' property as expected");
			//arrange
			this._oPCOneMonthInterval.getAggregation("month")[0].setMode(1);
			//assert
			assert.strictEqual(this._oPCOneMonthInterval.getAggregation("month")[0].iMode, 1, "'OneMonthDatesRow.setMode()' sets the internal 'iMode' property as expected");
		});

		QUnit.test("'OneMonthDatesRow.setDate()' setter with a date calls its super class 'setDate()' setter", function (assert) {
			//arrange
			var oOneMonthDatesRowSpy = this.spy(sap.ui.unified.calendar.OneMonthDatesRow.prototype, "setDate"),
				oDatesRowSpy = this.spy(sap.ui.unified.calendar.DatesRow.prototype, "setDate"),
				oVisibleDate = new CalendarDate(2016, 8, 10),
				oOutsideVisibleRangeDate = new CalendarDate(2015, 3, 20);

			this._createCalendar();
			this._oPCOneMonthInterval._bNoRangeCheck = false;
			this._oPCOneMonthInterval._setStartDate(oVisibleDate, true, false);
			//assert
			assert.strictEqual(oOneMonthDatesRowSpy.callCount, 1, "'OneMonthDatesRow.setDate()' method was called once");
			assert.strictEqual(oDatesRowSpy.callCount, 1, "'DatesRow.setDate()' method was called once");
			//arrange
			this._oPCOneMonthInterval._setStartDate(oOutsideVisibleRangeDate, true, false);
			//assert
			assert.strictEqual(oOneMonthDatesRowSpy.callCount, 2, "'OneMonthDatesRow.setDate()' method was called once");
			assert.strictEqual(oDatesRowSpy.callCount, 2, "'DatesRow.setDate()' method was called once");
			//clean
			oOneMonthDatesRowSpy.restore();
			oDatesRowSpy.restore();
		});

		QUnit.test("'CalendarRow.Renderer' calls its 'renderSingleDayInterval()'", function (assert) {
			//arrange
			/* CalendarRowInPCRenderer renderer is not exposed to the public, so obtain it via its parent */
			var oRow = new sap.m.PlanningCalendarRow(),
				oPC = new sap.m.PlanningCalendar({ rows: [oRow] }),
				oTimelineRenderer = _getRowTimeline(oRow).getRenderer(),
				oTimelineRendererSpy = this.spy(oTimelineRenderer, "renderSingleDayInterval");

			this._createCalendar();
			//assert
			assert.strictEqual(oTimelineRendererSpy.callCount, 2, "'renderSingleDayInterval()' is called as expected"); //Two rows
			//clean
			oTimelineRendererSpy.restore();
		});

		QUnit.test("Appointment select is fired", function (assert) {
			//arrange
			this._createCalendar();
			this._oPC.setStartDate(new Date(2015, 0, 1));
			this._oPC.placeAt("smallUiArea");
			sap.ui.getCore().applyChanges();

			oSelectedAppointment = undefined;
			qutils.triggerEvent("tap", "_oPC-R1A1");

			//act & assert
			assert.equal(oSelectedAppointment.getId(), "_oPC-R1A1", "appointmentSelect event fired and appointment returned");
			assert.ok(sap.ui.getCore().byId("_oPC-R1A1").getSelected(), "Appointment is selected");
			qutils.triggerEvent("tap", "_oPC-R1A2");
			assert.ok(!(sap.ui.getCore().byId("_oPC-R1A1").getSelected()),
					"Appointment 1 is deselected because another one is selected");
			assert.ok(sap.ui.getCore().byId("_oPC-R1A2").getSelected(), "Appointment 2 is selected");
			assert.equal(this._oPC.getSelectedAppointments().length, 1, "One appointment is selected");
			qutils.triggerEvent("tap", "_oPC-R1A2");
			assert.ok(!(sap.ui.getCore().byId("_oPC-R1A1").getSelected()),
					"Appointment 2 is deselected after a second click on it");
			assert.equal(this._oPC.getSelectedAppointments().length, 0, "No appointment is selected");

			//CTRL key included
			qutils.triggerEvent("tap", "_oPC-R1A2");
			sap.ui.test.qunit.triggerEvent("tap", sap.ui.getCore().byId("_oPC-R1A1").getDomRef(), {target :
					sap.ui.getCore().byId("_oPC-R1A1").getDomRef(), ctrlKey: true});
			assert.equal(this._oPC.getSelectedAppointments().length, 2, "Two appointments are selected");
			sap.ui.test.qunit.triggerEvent("tap", sap.ui.getCore().byId("_oPC-R1A1").getDomRef(), {target :
					sap.ui.getCore().byId("_oPC-R1A1").getDomRef(), ctrlKey: true});
			assert.equal(this._oPC.getSelectedAppointments().length, 1,
					"When deselecting an appointment while pressing CTRL key, only this particular appointment is deselected");
			sap.ui.test.qunit.triggerEvent("tap", sap.ui.getCore().byId("_oPC-R1A1").getDomRef(), {target :
					sap.ui.getCore().byId("_oPC-R1A1").getDomRef(), ctrlKey: true});
			qutils.triggerEvent("tap", "_oPC-R1A2");
			assert.equal(this._oPC.getSelectedAppointments().length, 0,
					"When deselecting an appointment without pressing CTRL key all selections are gone");

			// clean
			oSelectedAppointment = undefined;
		});

		QUnit.test("No sticky header on phone size", function () {
			//arrange
			this._createCalendar();

			//act
			this._oPC.setStickyHeader(true);
			sap.ui.getCore().applyChanges();

			// assert
			assert.ok(!this._oPC.$("InfoToolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class shouldn't be set on the info bar");
			assert.ok(!this._oPC.$("Toolbar").hasClass("sapMPlanCalStickyHeader"), "sticky class shouldn't be set on the toolbar");
		});

		QUnit.module("ARIA", {
			beforeEach: function() {

				this.sOldLanguage = sap.ui.getCore().getConfiguration().getLanguage();
				sap.ui.getCore().getConfiguration().setLanguage("en-US");//due to text strings for built-in CalendarDayType texts

				this.oLegend = new PlanningCalendarLegend({
					items: [
						new CalendarLegendItem({
							type: CalendarDayType.Type01,
							text: "National Holidays"
						})],
					appointmentItems: [
						new CalendarLegendItem({
							type: CalendarDayType.Type01,
							text: "Type Private Appointment"
						})
					]
				});

				this.oLegendWithItemsTypes01UpToTypes10 = new PlanningCalendarLegend({
					items: createLegendItems(1, 10, "National Holidays"),
					appointmentItems:  createLegendItems(1, 10, "Type Private Appointment")
				});

				this._testAriaAppointmentsAndSpecialDatesIfLegendIsDestroyed = function(sIntervalType, fnExtendSut) {
					//Prepare
					var sMessagePrefix = "After legend is destroyed",
						aAppointments = _createAppointmentsOfTypes(1, 20, new Date(2015, 0, 1, 19)),
						aSpecialDates = _createSpecialDates(1, 20,  sIntervalType, new Date(2015, 0, 1, 19)),
						oSut = createPlanningCalendar("accPC-LegendDestoyed", new sap.m.SearchField(), new sap.m.Button(),
							new Date(2015, 0, 1, 19),
							null, /*View key*/
							this.oLegendWithItemsTypes01UpToTypes10,
							aSpecialDates,
							[new sap.m.PlanningCalendarRow({
								icon: "sap-icon://employee",
								title: "Max Mustermann",
								text: "Musterteam",
								tooltip: "Header tooltip",
								appointments: aAppointments
							})]);

					oSut.setViewKey(sIntervalType);
					if (fnExtendSut) {
						fnExtendSut(oSut);
					}
					oSut.placeAt("bigUiArea");
					sap.ui.getCore().applyChanges();

					//Act
					this.oLegendWithItemsTypes01UpToTypes10.destroy();
					sap.ui.getCore().applyChanges();

					//Assert
					//Appointments

					this.assertAppointmentsWithoutConnectedLegendHaveDefaultAriaLabelledBy(aAppointments, sMessagePrefix);

					//Special Dates
					this.assertSpecialDatesWithoutConnectedLegendHaveDefaultAriaDescribedBy(aSpecialDates, oSut, sMessagePrefix);

					//Cleanup
					this.destroySut(oSut);
				};

				this._testAriaAppointmentsAndSpecialDates = function(sIntervalType, fnExtendSut) {
					//Prepare
					var sMessagePrefix = "Initial legend is available",
						aAppointments = _createAppointmentsOfTypes(1, 20, new Date(2015, 0, 1, 19)),
						aSpecialDates = _createSpecialDates(1, 20,  sIntervalType, new Date(2015, 0, 1, 19)),
						oSut = createPlanningCalendar("accPC", new sap.m.SearchField(), new sap.m.Button(),
							new Date(2015, 0, 1, 19),
							null, /*View key*/
							this.oLegendWithItemsTypes01UpToTypes10,
							aSpecialDates,
							[new sap.m.PlanningCalendarRow({
								icon: "sap-icon://employee",
								title: "Max Mustermann",
								text: "Musterteam",
								tooltip: "Header tooltip",
								appointments: aAppointments
							})]),
						aAppointmentsWithLegend = aAppointments.slice(0, 10) /* used legend has items for types01 to types10*/,
						aAppointmentsWithoutLegend = aAppointments.slice(10),
						aSpecialDatesWithLegend = aSpecialDates.slice(0, 10) /* used legend has items for types01 to types10*/,
						aSpecialDatesWithoutLegend = aSpecialDates.slice(10);

					oSut.setViewKey(sIntervalType);
					if (fnExtendSut) {
						fnExtendSut(oSut);
					}

					//Act
					oSut.placeAt("bigUiArea");
					sap.ui.getCore().applyChanges();

					//Assert
					//Appointments
					this.assertAppointmentsConnectedToLegendHaveLegendTextAsAriaLabelledByText(aAppointmentsWithLegend, sMessagePrefix);
					this.assertAppointmentsWithoutConnectedLegendHaveDefaultAriaLabelledBy(aAppointmentsWithoutLegend, sMessagePrefix);

					//Special Dates
					this.assertSpecialDatesConnectedToLegendHaveLegendTextAsAriaLabel(aSpecialDatesWithLegend, oSut, sMessagePrefix);
					this.assertSpecialDatesWithoutConnectedLegendHaveDefaultAriaDescribedBy(aSpecialDatesWithoutLegend, oSut, sMessagePrefix);

					//Cleanup
					this.destroySut(oSut);
				};

				this.assertAppointmentsConnectedToLegendHaveLegendTextAsAriaLabelledByText = function(aAppointmentsWithLegend, sMsgPref) {
					aAppointmentsWithLegend.forEach(function (oApp, iIndex) {
						var sLegendItemText = this.oLegendWithItemsTypes01UpToTypes10.getAppointmentItems()[iIndex].getText(),
							sAriaLabelledByText = oApp.$().find(".sapUiInvisibleText").text();

						assert.ok(sAriaLabelledByText.indexOf(sLegendItemText) >= 0, sMsgPref +
							": Appointment of type " + oApp.getType() + " starting at "+ oFormatYyyyMMddHHmm.format(oApp.getStartDate()) +
							" should be aria-labelled by hidden element with text '" + sLegendItemText + "'. Current aria-labelledby text: " + sAriaLabelledByText);
					}, this);
				};

				this.assertAppointmentsWithoutConnectedLegendHaveDefaultAriaLabelledBy = function(aAppointmentsWithoutLegend, sMsgPref) {
					aAppointmentsWithoutLegend.forEach(function (oApp) {
						var sBuiltInTypeText = CalendarLegendRenderer.typeARIATexts[oApp.getType()].getText(),
							sAriaLabelledByText = oApp.$().find(".sapUiInvisibleText").text();

						assert.ok(sAriaLabelledByText.indexOf(sBuiltInTypeText) >= 0, sMsgPref +
							": Appointment of type " + oApp.getType() + " starting at " + oFormatYyyyMMddHHmm.format(oApp.getStartDate()) +
							" should be aria-labelled by hidden element with text '" + sBuiltInTypeText + "'. Current aria-labelledby text: " + sAriaLabelledByText);
					}, this);
				};

				this.assertSpecialDatesConnectedToLegendHaveLegendTextAsAriaLabel = function(oSpecialDatesWithLegend, oSutPC, sMsgPref) {
					var oFormat = oSutPC.getViewKey() === CalendarIntervalType.Hour ? oFormatYyyyMMddHHmm : oFormatYyyyMMdd;
					oSpecialDatesWithLegend.forEach(function (oSpecialDate) {
						var sSpecialDate = oFormat.format(oSpecialDate.getStartDate()),
							sSpecialDateSelector = "#" + oSutPC.getId() + "-" + _getIntervalId(oSutPC) + "-" + sSpecialDate,
							$specialDate,
							sAriaLabel;

						if (!jQuery(sSpecialDateSelector).length) {
							_navForward(oSutPC); // the special date might be on the next page
						}
						$specialDate = jQuery(sSpecialDateSelector);
						assert.ok($specialDate.length, sMsgPref + ": Special Date " + sSpecialDate + " should be available in the DOM");

						sAriaLabel = $specialDate.attr("aria-label");
						assert.ok(sAriaLabel && sAriaLabel.indexOf("National Holidays for type " + oSpecialDate.getType()) >= 0,
							sMsgPref + ": Special date " + sSpecialDate + " of type CalendarDayType." + oSpecialDate.getType() +
							" should has aria-label with value containing the corresponding legend item's text." +
							" Current aria-label: " + sAriaLabel);
					});
				};

				this.assertSpecialDatesWithoutConnectedLegendHaveDefaultAriaDescribedBy = function(aSpecialDatesWithoutLegend, oSutPC, sMsgPref) {
					var oFormat = oSutPC.getViewKey() === CalendarIntervalType.Hour ? oFormatYyyyMMddHHmm : oFormatYyyyMMdd;
					aSpecialDatesWithoutLegend.forEach(function (oSpecialDate, iIndex) {
						var sSpecialDate = oFormat.format(oSpecialDate.getStartDate()),
							sSpecialDateSelector = "#"+ oSutPC.getId() + "-" + _getIntervalId(oSutPC) + "-" + sSpecialDate,
							$specialDate,
							sAriaDescribedBy;

						if (!jQuery(sSpecialDateSelector).length) {
							_navForward(oSutPC); // the special date might be on the next page
						}
						$specialDate = jQuery(sSpecialDateSelector);
						assert.ok($specialDate.length, sMsgPref + ": Special Date " + sSpecialDate + " should be available in the DOM");

						sAriaDescribedBy = $specialDate.attr("aria-describedby");

						assert.ok(sAriaDescribedBy && sAriaDescribedBy.indexOf(CalendarLegendRenderer.typeARIATexts[oSpecialDate.getType()].getId()) >= 0,
							sMsgPref + ": Special date " + sSpecialDate + " of type CalendarDayType." + oSpecialDate.getType() +
							" should be describedBy built-in text for this type. Current aria-describedby: " + sAriaDescribedBy);
					});
				};

				this.destroySut = function(oSut) {
					if (!bSkipDestroy) {
						oSut.destroy();
					}
				};
				function createLegendItems(iFrom, iTo, sTextPattern) {
					var sTypeName = "",
						aResult = [];

					for (var i = iFrom; i <= iTo; i++) {
						sTypeName = i.toString();
						sTypeName = sTypeName.length === 1 ? "0"+ sTypeName : sTypeName;
						sTypeName = "Type" + sTypeName;

						if (!CalendarDayType[sTypeName]) {
							throw "Test error: invalid type " + sTypeName
						}

						sTypeName = CalendarDayType[sTypeName];
						aResult.push(new CalendarLegendItem({
							type: sTypeName,
							text: sTextPattern + " for type " + sTypeName
						}));
					}
					return aResult;
				}
			},
			afterEach: function() {
				if (!bSkipDestroy) {
					this.oLegend.destroy();
					this.oLegendWithItemsTypes01UpToTypes10.destroy();
				}
				sap.ui.getCore().getConfiguration().setLanguage(this.sOldLanguage);
			}
		});

		QUnit.test("Week day and date aria", function(assert) {
			//Prepare
			var oSut = createPlanningCalendar("PC", new sap.m.SearchField(), new sap.m.Button(), new Date(2015, 0, 1)),
				oFormatDate = sap.ui.core.format.DateFormat.getInstance({style: "long", calendarType: "Gregorian"}),
				oDate = new CalendarDate(2015, 0, 2, sap.ui.core.CalendarType.Gregorian),
				sAriaDate = oFormatDate.format(oDate.toUTCJSDate(), true),
				aWeekDaysWide = oFormatDate.oLocaleData.getDaysStandAlone("wide", "Gregorian"),
				sWeekDayAriaText = aWeekDaysWide[5],
				sExpectedAria = sWeekDayAriaText + " " + sAriaDate;

			//Act
			oSut.setViewKey(CalendarIntervalType.Day);
			oSut.placeAt('uiArea1');
			sap.ui.getCore().applyChanges();

			//Assert
			assert.strictEqual(jQuery("#" + oSut.getId() + "-DateInt--Month0-20150102").attr("aria-label"), sExpectedAria,
				"Correct week day and date aria are written");
		});

		//Aria appointments & special dates for Hours view
		QUnit.test("Hours view: appointments and special dates", function (assert) {
			this._testAriaAppointmentsAndSpecialDates(CalendarIntervalType.Hour);
			this._testAriaAppointmentsAndSpecialDatesIfLegendIsDestroyed(CalendarIntervalType.Hour);
		});

		QUnit.test("Days view: appointments and special dates", function (assert) {
			this._testAriaAppointmentsAndSpecialDates(CalendarIntervalType.Day);
			this._testAriaAppointmentsAndSpecialDatesIfLegendIsDestroyed(CalendarIntervalType.Day);
		});

		QUnit.test("1 Week view: appointments and special dates", function (assert) {
			this._testAriaAppointmentsAndSpecialDates(CalendarIntervalType.Week);
			this._testAriaAppointmentsAndSpecialDatesIfLegendIsDestroyed(CalendarIntervalType.Week);
		});

		QUnit.test("1 Month view: appointments and special dates", function (assert) {
			this._testAriaAppointmentsAndSpecialDates(CalendarIntervalType.OneMonth);
			this._testAriaAppointmentsAndSpecialDatesIfLegendIsDestroyed(CalendarIntervalType.OneMonth);
		});

		QUnit.test("Months view: appointments and special dates", function (assert) {
			var fnExtendSut = function (oSutPC) {
				oSutPC.setGroupAppointmentsMode(GroupAppointmentsMode.Expanded)
			};
			this._testAriaAppointmentsAndSpecialDates(CalendarIntervalType.Month, fnExtendSut);
			this._testAriaAppointmentsAndSpecialDatesIfLegendIsDestroyed(CalendarIntervalType.Month, fnExtendSut);
		});

		QUnit.module("views", {
			beforeEach: function () {
				this.oPC = new sap.m.PlanningCalendar();
			},
			afterEach: function () {
				this.oPC.destroy();
				this.oPC = null;
			}
		});

		QUnit.test("Toggle view select visibility", function (assert) {
			// Assert
			assert.strictEqual(this.oPC._oIntervalTypeSelect.getVisible(), true, "By default the planning calendar is " +
					"created with multiple predefined views so the internal select control should be visible");

			// Act
			// Note: adding a view removes all the predefined views leaving us with only one view for the control
			this.oPC.addView(
				new sap.m.PlanningCalendarView({
					key: "test",
					intervalType: CalendarIntervalType.Day,
					description: "test",
					intervalsS: 7,
					intervalsM: 7,
					intervalsL: 7
				})
			);
			// Note: updating to the current view key because adding a new view removes all the previous views and
			// the old key is not valid any more
			this.oPC.setViewKey("test");

			// Calling here the onBeforeRendering method to force the update without rendering the control
			this.oPC.onBeforeRendering();

			// Assert
			assert.strictEqual(this.oPC._oIntervalTypeSelect.getVisible(), false, "When having only one view the view " +
					"select should not be visible");
		});

		QUnit.test("default built-in views", function (assert) {
			var aViewKey = sap.m.PlanningCalendarBuiltInView.Hour;
			this.oPC.placeAt('qunit-fixture');
			sap.ui.getCore().applyChanges();
			assert.equal(this.oPC._oIntervalTypeSelect.getItems().length, 5, "By default the planning calendar is " +
				"created with 5 predefined views");
			assert.equal(this.oPC.getViews().length, 0, "By default in the planning calendar there are no custom views");
			assert.equal(this.oPC.getViewKey(), aViewKey, "By default the planning calendar view key is hour");
		});

		QUnit.test("setting the property builtInViews with two arguments", function (assert) {
			var oItemKey,
				aViewType = sap.m.PlanningCalendarBuiltInView,
				aViewKey = sap.m.PlanningCalendarBuiltInView.Day;
			this.oPC.placeAt('qunit-fixture');
			sap.ui.getCore().applyChanges();

			this.oPC.setBuiltInViews([aViewType.Day, aViewType.Hour]);
			sap.ui.getCore().applyChanges();

			// Note: updating to the current view key because adding a new view or setting the builtInViews property
			// with items removes all the previous views and the old key is not valid any more
			this.oPC.setViewKey(aViewType.Day);
			assert.equal(this.oPC._oIntervalTypeSelect.getItems().length, 2, "When the buildInViews property is set with " +
				"two views, only they are shown to the end user.");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[0].getKey();
			assert.equal(oItemKey, aViewType.Day, "The key of the first view is OK");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[1].getKey();
			assert.equal(oItemKey, aViewType.Hour, "The key of the second view is OK");
			assert.equal(this.oPC.getViews().length, 0, "By default in the planning calendar there are no custom views");
			assert.equal(this.oPC.getViewKey(), aViewKey, "When builtInViews property is set, the view key of the " +
				"planning calendar is the first assigned");
		});

		QUnit.test("setting the property builtInViews with no arguments", function (assert) {
			var oItemKey,
				aViewType = sap.m.PlanningCalendarBuiltInView,
				aViewKey = sap.m.PlanningCalendarBuiltInView.Hour;
			this.oPC.placeAt('qunit-fixture');
			sap.ui.getCore().applyChanges();

			this.oPC.setBuiltInViews([]);
			sap.ui.getCore().applyChanges();
			assert.equal(this.oPC._oIntervalTypeSelect.getItems().length, 5, "When the buildInViews property is set with " +
				"an empty array, the PlanningCalendar is showing the 5 predefined views");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[0].getKey();
			assert.equal(oItemKey, aViewType.Hour, "The key of the first view is OK");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[1].getKey();
			assert.equal(oItemKey, aViewType.Day, "The key of the second view is OK");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[2].getKey();
			assert.equal(oItemKey, aViewType.Month, "The key of the third view is OK");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[3].getKey();
			assert.equal(oItemKey, aViewType.Week, "The key of the fourth view is OK");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[4].getKey();
			assert.equal(oItemKey, aViewType.OneMonth, "The key of the fifth view is OK");
			assert.equal(this.oPC.getViews().length, 0, "By default in the planning calendar there are no custom views");
			assert.equal(this.oPC.getViewKey(), aViewKey, "When builtInViews property is set to empty array, " +
				"the view key of the planning calendar is the default one - hour");
		});

		QUnit.test("with custom view", function (assert) {
			var oItemKey;
			this.oPC.placeAt('qunit-fixture');
			sap.ui.getCore().applyChanges();
			this.oPC.addView(
				new sap.m.PlanningCalendarView({
					key: "test",
					intervalType: CalendarIntervalType.Day,
					description: "test",
					intervalsS: 7,
					intervalsM: 7,
					intervalsL: 7
				})
			);
			// Note: updating to the current view key because adding a new view or setting the builtInViews property
			// with items removes all the previous views and the old key is not valid any more
			this.oPC.setViewKey("test");
			sap.ui.getCore().applyChanges();
			assert.equal(this.oPC._oIntervalTypeSelect.getItems().length, 1, "When the buildInViews property is set with " +
				"two views and there is a custom view, the PlanningCalendar is showing 3 views");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[0].getKey();
			assert.equal(oItemKey, "test", "The key of the first view is OK");
			assert.equal(this.oPC.getViews().length, 1, "When set, the there are views in the getViews array");
		});

		QUnit.test("adding custom views and setting the property builtInViews with two arguments", function (assert) {
			var oItemKey,
				aViewType = sap.m.PlanningCalendarBuiltInView,
				aViewKey = sap.m.PlanningCalendarBuiltInView.Day;
			this.oPC.placeAt('qunit-fixture');
			sap.ui.getCore().applyChanges();

			this.oPC.addView(
				new sap.m.PlanningCalendarView({
					key: "test",
					intervalType: CalendarIntervalType.Day,
					description: "test",
					intervalsS: 7,
					intervalsM: 7,
					intervalsL: 7
				})
			);
			// Note: updating to the current view key because adding a new view or setting the builtInViews property
			// with items removes all the previous views and the old key is not valid any more
			this.oPC.setViewKey("test");
			sap.ui.getCore().applyChanges();
			assert.equal(this.oPC._oIntervalTypeSelect.getItems().length, 1, "When the buildInViews property is set with " +
				"two views and there is a custom view, the PlanningCalendar is showing 3 views");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[0].getKey();
			assert.equal(oItemKey, "test", "The key of the first view is OK");

			this.oPC.setBuiltInViews([aViewType.Day, aViewType.Hour]);
			sap.ui.getCore().applyChanges();

			assert.equal(this.oPC._oIntervalTypeSelect.getItems().length, 3, "When the buildInViews property is set with " +
				"two views and there is a custom view, the PlanningCalendar is showing 3 views");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[0].getKey();
			assert.equal(oItemKey, aViewType.Day, "The key of the first view is OK");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[1].getKey();
			assert.equal(oItemKey, aViewType.Hour, "The key of the second view is OK");
			oItemKey = this.oPC._oIntervalTypeSelect.getItems()[2].getKey();
			assert.equal(oItemKey, "test", "The key of the third view is OK");
			assert.equal(this.oPC.getViews().length, 1, "When set, the there are views in the getViews array");
			assert.equal(this.oPC.getViewKey(), aViewKey, "When builtInViews property is set, the view key of the " +
				"planning calendar is the first assigned");
		});

		QUnit.module('CalendarAppointment');

		QUnit.test('_getComparer', function(assert) {
			var aAppInfos = [
				new CalendarAppointment({
					startDate: new Date(2015, 0, 2, 8, 0),
					endDate: new Date(2015, 0, 2, 10, 0),
					title: "3"
				}),
				new CalendarAppointment({
					startDate: new Date(2015, 0, 1, 8, 0),
					endDate: new Date(2015, 0, 3, 10, 0),
					title: "1"
				}),
				new CalendarAppointment({
					startDate: new Date(2014, 11, 31, 8, 0),
					endDate: new Date(2015, 0, 2, 11, 0),
					title: "2"
				}),
				new CalendarAppointment({
					startDate: new Date(2015, 0, 2, 9, 0),
					endDate: new Date(2015, 0, 2, 12, 0),
					title: "4"
				}),
				new CalendarAppointment({
					startDate: new Date(2015, 0, 1, 7, 0),
					endDate: new Date(2015, 0, 3, 5, 0),
					title: "0"
				})
			].map(function(appointment) {
				return { appointment: appointment };
			});

			var aSortedInfos = aAppInfos.sort(CalendarAppointment._getComparer(new Date(2015, 0, 2)));
			assert.equal(aSortedInfos[0].appointment.getTitle(), "0", 'item sorted correctly');
			assert.equal(aSortedInfos[1].appointment.getTitle(), "1", 'item sorted correctly');
			assert.equal(aSortedInfos[2].appointment.getTitle(), "2", 'item sorted correctly');
			assert.equal(aSortedInfos[3].appointment.getTitle(), "3", 'item sorted correctly');
		});

		QUnit.test('_getDateRangeIntersectionText', function(assert) {
			var aAppInfos = [
					new CalendarAppointment({
						startDate: new Date(2015, 0, 3, 8, 0),
						endDate: new Date(2015, 0, 3, 10, 0)
					}),
					new CalendarAppointment({
						startDate: new Date(2015, 0, 1, 8, 0),
						endDate: new Date(2015, 0, 3, 10, 0)
					}),
					new CalendarAppointment({
						startDate: new Date(2014, 11, 31, 8, 0),
						endDate: new Date(2015, 0, 2, 11, 0)
					}),
					new CalendarAppointment({
						startDate: new Date(2015, 0, 2, 9, 0),
						endDate: new Date(2015, 0, 4, 12, 0)
					}),
					new CalendarAppointment({
						startDate: new Date(2015, 0, 2, 7, 0),
						endDate: new Date(2015, 0, 2, 15, 0)
					})
				],
				oCurrentlyDisplayedDate = new Date(2015, 0, 2),
				oTimeFormat = sap.ui.core.format.DateFormat.getTimeInstance({pattern: 'HH:mm'}),
				oResourceBundle = sap.ui.getCore().getLibraryResourceBundle("sap.m");

			assert.equal(aAppInfos[0]._getDateRangeIntersectionText(oCurrentlyDisplayedDate), '');
			assert.equal(aAppInfos[1]._getDateRangeIntersectionText(oCurrentlyDisplayedDate),
				oResourceBundle.getText('PLANNINGCALENDAR_ALLDAY'));
			assert.equal(aAppInfos[2]._getDateRangeIntersectionText(oCurrentlyDisplayedDate),
				oResourceBundle.getText('PLANNINGCALENDAR_UNTIL', [oTimeFormat.format(aAppInfos[2].getEndDate())]));
			assert.equal(aAppInfos[3]._getDateRangeIntersectionText(oCurrentlyDisplayedDate),
				oTimeFormat.format(aAppInfos[3].getStartDate()));
			assert.equal(aAppInfos[4]._getDateRangeIntersectionText(oCurrentlyDisplayedDate),
				oTimeFormat.format(aAppInfos[4].getStartDate()) + ' - ' + oTimeFormat.format(aAppInfos[4].getEndDate()));

		});

		QUnit.module('showDayNamesLine', {
			beforeEach: function () {
				this.oPC = new sap.m.PlanningCalendar("OPC");
				this.oPC.placeAt('uiArea1');
			},

			afterEach: function () {
				this.oPC.destroy();
				this.oPC = null;
			}
		});

		QUnit.test("test default value", function (assert) {
			var oCalDateInt;

			this.oPC.setViewKey(CalendarIntervalType.Day);
			sap.ui.getCore().applyChanges();
			oCalDateInt = sap.ui.getCore().byId("OPC-DateInt");
			assert.equal(oCalDateInt.getShowDayNamesLine(), false, "the default property of the CalendarDateInterval in the days view is false");

			this.oPC.setViewKey(CalendarIntervalType.Week);
			sap.ui.getCore().applyChanges();
			oCalDateInt = sap.ui.getCore().byId("OPC-WeekInt");
			assert.equal(oCalDateInt.getShowDayNamesLine(), false, "the default property of the CalendarWeekInterval in the week view is false");

			this.oPC.setViewKey(CalendarIntervalType.OneMonth);
			sap.ui.getCore().applyChanges();
			oCalDateInt = sap.ui.getCore().byId("OPC-OneMonthInt");
			assert.equal(oCalDateInt.getShowDayNamesLine(), false, "the default property of the CalendarOneMonthInterval in the one month view is false");

		});

		QUnit.test("Toggle showDayNamesLine", function (assert) {
			var oCalDateInt,
				oCalWeekInt,
				oCalOneMonthInt;
			//initialize the views
			this.oPC.setViewKey(CalendarIntervalType.Day);
			this.oPC.setViewKey(CalendarIntervalType.Week);
			this.oPC.setViewKey(CalendarIntervalType.OneMonth);
			this.oPC.setViewKey(CalendarIntervalType.Hour);
			sap.ui.getCore().applyChanges();

			oCalDateInt = sap.ui.getCore().byId("OPC-DateInt");
			oCalWeekInt = sap.ui.getCore().byId("OPC-WeekInt");
			oCalOneMonthInt = sap.ui.getCore().byId("OPC-OneMonthInt");

			this.oPC.setShowDayNamesLine(true);
			assert.equal(oCalDateInt.getShowDayNamesLine(), true, "the property is passed to the CalendarDateInterval in the days view after setting the property to the Hour view");

			assert.equal(oCalWeekInt.getShowDayNamesLine(), true, "the property is passed to the CalendarWeekInterval in the week view after setting the property to the Hour view");

			assert.equal(oCalOneMonthInt.getShowDayNamesLine(), true, "the property is passed to the CalendarOneMonthInterval in the one month view after setting the property to the Hour view");

			this.oPC.setViewKey(CalendarIntervalType.Day);
			sap.ui.getCore().applyChanges();
			this.oPC.setShowDayNamesLine(false);
			assert.equal(oCalDateInt.getShowDayNamesLine(), false, "the property is passed to the CalendarDateInterval in the days view after setting the property to the Day view");

			assert.equal(oCalWeekInt.getShowDayNamesLine(), false, "the property is passed to the CalendarWeekInterval in the week view after setting the property to the Day view");

			assert.equal(oCalOneMonthInt.getShowDayNamesLine(), false, "the property is passed to the CalendarOneMonthInterval in the one month view after setting the property to the Day view");

			this.oPC.setViewKey(CalendarIntervalType.Week);
			sap.ui.getCore().applyChanges();
			this.oPC.setShowDayNamesLine(true);
			assert.equal(oCalDateInt.getShowDayNamesLine(), true, "the property is passed to the CalendarDateInterval in the days view after setting the property to the Week view");

			assert.equal(oCalWeekInt.getShowDayNamesLine(), true, "the property is passed to the CalendarWeekInterval in the week view after setting the property to the Week view");

			assert.equal(oCalOneMonthInt.getShowDayNamesLine(), true, "the property is passed to the CalendarOneMonthInterval in the one month view after setting the property to the Week view");

			this.oPC.setViewKey(CalendarIntervalType.OneMonth);
			sap.ui.getCore().applyChanges();
			this.oPC.setShowDayNamesLine(false);
			assert.equal(oCalDateInt.getShowDayNamesLine(), false, "the property is passed to the CalendarDateInterval in the days view after setting the property to the OneMonth view");

			assert.equal(oCalWeekInt.getShowDayNamesLine(), false, "the property is passed to the CalendarWeekInterval in the week view after setting the property to the OneMonth view");

			assert.equal(oCalOneMonthInt.getShowDayNamesLine(), false, "the property is passed to the CalendarOneMonthInterval in the one month view after setting the property to the OneMonth view");

		});

		QUnit.module('Destroy', {
			beforeEach: function () {
				this.oPC = new sap.m.PlanningCalendar();
				this.oPC.placeAt('uiArea1');
			},
			afterEach: function () {
				this.oPC.destroy();
				this.oPC = null;
			}
		});

		QUnit.test("When the control is destroyed there's no need of custom invalidation logic", function (assert) {
			//define
			var oControlInvalidateSpy = this.spy(sap.ui.core.Control.prototype, "invalidate");

			//act
			this.oPC.addSpecialDate(new DateTypeRange({startDate: new Date(), tooltip: "test"}));
			this.oPC._bIsBeingDestroyed = true;
			this.oPC.invalidate();

			//assert
			assert.strictEqual(oControlInvalidateSpy.callCount, 1,
					"When _bIsBeingDestroyed is true only the Control's 'invalidate' is executed and not our extra logic");

			//cleanup
			oControlInvalidateSpy.restore();
			this.oPC._bIsBeingDestroyed = false;
		});

		QUnit.module("WeekNumbers");

		QUnit.test("setViewKey -> Days - propagates showWeekNumbers property", function(assert) {
			//arrange
			var oPC = new sap.m.PlanningCalendar({
					showWeekNumbers: false
				}),
				oSetShowWeekNumbersSpy = this.spy(sap.ui.unified.CalendarDateInterval.prototype, "setShowWeekNumbers");

			//act
			oPC.setViewKey(sap.ui.unified.CalendarIntervalType.Day);

			//assert
			assert.ok(oSetShowWeekNumbersSpy.calledOnce, "Planning Calendar propagated the showWeekNumbers property");
			assert.ok(oSetShowWeekNumbersSpy.calledWith(false), "setter called with the right arguments");

			//clean
			oPC.destroy();
		});

		QUnit.test("_viewAllowsWeekNumbers", function(assert) {
			//arrange
			var oPC = new sap.m.PlanningCalendar();

			//act, assert
			assert.equal(oPC._viewAllowsWeekNumbers(sap.ui.unified.CalendarIntervalType.Hour), false, "is not supported for Hour view");
			assert.equal(oPC._viewAllowsWeekNumbers(sap.ui.unified.CalendarIntervalType.Day), true, "is supported for Day view");
			assert.equal(oPC._viewAllowsWeekNumbers(sap.ui.unified.CalendarIntervalType.Week), true, "is supported for Week view");
			assert.equal(oPC._viewAllowsWeekNumbers(sap.ui.unified.CalendarIntervalType.Month), false, "is not supported for Month view");
			assert.equal(oPC._viewAllowsWeekNumbers(sap.ui.unified.CalendarIntervalType.OneMonth), true, "is supported for OneMonth view");

			//clean
			oPC.destroy();
		});

		QUnit.test("_getIntervalInstanceByViewKey", function(assert) {
			//arrange
			var oPC = new sap.m.PlanningCalendar();

			//act, assert
			assert.ok(!oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Hour), "never returns an instance for Hours view");
			assert.ok(!oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Day), "returns no instance for Day view, it was not created yet");
			assert.ok(!oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Week), "returns no instance for Week view, it was not created yet");
			assert.ok(!oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Month), "never returns an instance for Month view");
			assert.ok(!oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.OneMonth), "returns no instance for OneMonth view, it was not created yet");

			//act
			oPC.setViewKey(sap.ui.unified.CalendarIntervalType.Hour);
			oPC.setViewKey(sap.ui.unified.CalendarIntervalType.Day);
			oPC.setViewKey(sap.ui.unified.CalendarIntervalType.Week);
			oPC.setViewKey(sap.ui.unified.CalendarIntervalType.Month);
			oPC.setViewKey(sap.ui.unified.CalendarIntervalType.OneMonth);

			//assert
			assert.ok(!oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Hour), "never returns an instance for Hours view");
			assert.ok(oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Day), "returns an instance for Day view");
			assert.ok(oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Week), "returns an instance for Week view");
			assert.ok(!oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.Month), "never returns an instance for Month view");
			assert.ok(oPC._getIntervalInstanceByViewKey(sap.ui.unified.CalendarIntervalType.OneMonth), "returns an instance for OneMonth view");

			//clean
			oPC.destroy();
		});

		QUnit.module("Drag and Drop");

		QUnit.test("_calcNewHoursAppPos: Calculate new position of the appointment in 'Hours' view", function(assert) {
			//arrange
			var oPCRow = new sap.m.PlanningCalendar(),
				oRowStartDate = new Date(2017, 10, 13),
				oAppStartDate = new Date(2017, 10, 13, 1, 0, 0),
				oAppEndDate = new Date(2017, 10, 13, 2, 0, 0),
				newAppPos;

			//act
			newAppPos = oPCRow._calcNewHoursAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 10);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2017, 10, 13, 5, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 13, 6, 0, 0), "Correct new end position");

			//act
			newAppPos = oPCRow._calcNewHoursAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 16);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2017, 10, 13, 8, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 13, 9, 0, 0), "Correct new end position");

			//act
			newAppPos = oPCRow._calcNewHoursAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 8);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2017, 10, 13, 4, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 13, 5, 0, 0), "Correct new end position");

			//clean
			oPCRow.destroy();
		});

		QUnit.test("_calcNewDaysAppPos: Calculate new position of the appointment in 'Days' view", function(assert) {
			//arrange
			var oPCRow = new sap.m.PlanningCalendar(),
				oRowStartDate = new Date(2017, 10, 13),
				oAppStartDate = new Date(2017, 10, 15, 1, 0, 0),
				oAppEndDate = new Date(2017, 10, 15, 2, 0, 0),
				newAppPos;

			//act
			newAppPos = oPCRow._calcNewDaysAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 4);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2017, 10, 17, 1, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 17, 2, 0, 0), "Correct new end position");

			//act
			newAppPos = oPCRow._calcNewDaysAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 3);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2017, 10, 16, 1, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 16, 2, 0, 0), "Correct new end position");

			//act
			newAppPos = oPCRow._calcNewDaysAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 6);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2017, 10, 19, 1, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 19, 2, 0, 0), "Correct new end position");

			//clean
			oPCRow.destroy();
		});

		QUnit.test("_calcNewMonthsAppPos: Calculate new position of the appointment in 'Months' view", function(assert) {
			//arrange
			var oPCRow = new sap.m.PlanningCalendar(),
				oRowStartDate = new Date(2017, 10, 13),
				oAppStartDate = new Date(2017, 11, 13, 1, 0, 0),
				oAppEndDate = new Date(2017, 11, 13, 2, 0, 0),
				newAppPos;

			//act
			newAppPos = oPCRow._calcNewMonthsAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 3);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2018, 1, 13, 1, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2018, 1, 13, 2, 0, 0), "Correct new end position");

			//act
			newAppPos = oPCRow._calcNewMonthsAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 1);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2017, 11, 13, 1, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 11, 13, 2, 0, 0), "Correct new end position");

			//act
			newAppPos = oPCRow._calcNewMonthsAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 2);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2018, 0, 13, 1, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2018, 0, 13, 2, 0, 0), "Correct new end position");

			//clean
			oPCRow.destroy();
		});

		QUnit.test("_calcNewMonthsAppPos: Calculate new position of the appointment in 'Months' view when row start day is different than the appointment's day", function (assert) {
			//arrange
			var oPCRow = new sap.m.PlanningCalendar(),
					oRowStartDate = new Date(2017, 10, 13),
					oAppStartDate = new Date(2017, 11, 14, 1, 0, 0),
					oAppEndDate = new Date(2017, 11, 14, 2, 0, 0),
					newAppPos;

			//act
			newAppPos = oPCRow._calcNewMonthsAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 3);

			//assert
			assert.deepEqual(newAppPos.startDate, new Date(2018, 1, 14, 1, 0, 0), "Correct new start position");
			assert.deepEqual(newAppPos.endDate, new Date(2018, 1, 14, 2, 0, 0), "Correct new end position");

			//clean
			oPCRow.destroy();
		});

		QUnit.test("setEnableAppointmentsDragAndDrop", function(assert) {
			//arrange
			var oPC = new sap.m.PlanningCalendar(),
				oPCRow1 = new sap.m.PlanningCalendarRow("row1"),
				oPCRow2 = new sap.m.PlanningCalendarRow("row2");

			oPC.addRow(oPCRow1);
			oPC.addRow(oPCRow2);

			//act
			oPCRow1.setEnableAppointmentsDragAndDrop(true);

			var oDragConfig = oPCRow1.getDragDropConfig();
			var oDropConfig = _getRowTimeline(oPCRow1).getDragDropConfig();

			//assert
			assert.equal(oDragConfig.length, 1, "One DragInfo found");
			assert.equal(oDragConfig[0].getSourceAggregation(), "appointments", "Source aggregation is correct");
			assert.equal(oDropConfig[0].getTargetAggregation(), "_intervalPlaceholders", "Target aggregation is correct");
			assert.equal(oDragConfig[0].getGroupName(), "DragDropConfig", "Group name is correct");
			assert.equal(oDropConfig[0].getGroupName(), "DragDropConfig", "Group name is correct");

			//act
			oPCRow1.setEnableAppointmentsDragAndDrop(true);

			//assert
			assert.equal(oPCRow1.getDragDropConfig().length, 1, "One config found");
			assert.equal(_getRowTimeline(oPCRow1).getDragDropConfig().length, 1, "One config found");
			assert.equal(oPCRow2.getDragDropConfig().length, 0, "Zero configs found");
			assert.equal(_getRowTimeline(oPCRow2).getDragDropConfig().length, 0, "Zero configs found");

			//act
			oPCRow1.setEnableAppointmentsDragAndDrop(false);

			//assert
			assert.equal(oPCRow1.getDragDropConfig().length, 0, "Zero configs found");
			assert.equal(_getRowTimeline(oPCRow1).getDragDropConfig().length, 0, "Zero configs found");
			assert.equal(oPCRow2.getDragDropConfig().length, 0, "Zero configs found");
			assert.equal(_getRowTimeline(oPCRow2).getDragDropConfig().length, 0, "Zero configs found");


			//act
			oPCRow1.setEnableAppointmentsDragAndDrop(true);
			oPCRow2.setEnableAppointmentsDragAndDrop(true);

			//assert
			assert.equal(oPCRow1.getDragDropConfig().length, 1, "One config found");
			assert.equal(_getRowTimeline(oPCRow1).getDragDropConfig().length, 1, "One config found");
			assert.equal(oPCRow2.getDragDropConfig().length, 1, "One config found");
			assert.equal(_getRowTimeline(oPCRow2).getDragDropConfig().length, 1, "One config found");

			//act
			oPCRow1.setEnableAppointmentsDragAndDrop(false);
			oPCRow2.setEnableAppointmentsDragAndDrop(true);

			//assert
			assert.equal(oPCRow1.getDragDropConfig().length, 0, "Zero configs found");
			assert.equal(_getRowTimeline(oPCRow1).getDragDropConfig().length, 0, "Zero configs found");
			assert.equal(oPCRow2.getDragDropConfig().length, 1, "One config found");
			assert.equal(_getRowTimeline(oPCRow2).getDragDropConfig().length, 1, "One config found");

			//clean
			oPC.destroy();
		});

		function _getAppointmentsCount(oPC) {
			var aRows = oPC.getRows(),
				iAppointments = 0;

			aRows.forEach(function(oRow){
				iAppointments += oRow.getAppointments().length;
			});

			return iAppointments;
		}

		QUnit.module("Resize Appointments", {
			beforeEach: function () {
				this.oPCRow = new sap.m.PlanningCalendar();
			},

			afterEach: function () {
				this.oPCRow.destroy();
				this.oPCRow = null;
			}
		});

		QUnit.test("setEnableAppointmentsResize", function(assert) {
			//arrange
			var oPC = new sap.m.PlanningCalendar(),
				oPCRow1 = new sap.m.PlanningCalendarRow("row1");

			oPC.addRow(oPCRow1);

			//act
			oPCRow1.setEnableAppointmentsResize(true);

			var oDragConfig = oPCRow1.getDragDropConfig();

			//assert
			assert.equal(oDragConfig.length, 1, "One DragInfo found");
			assert.equal(oDragConfig[0].getSourceAggregation(), "appointments", "Source aggregation is correct");
			assert.equal(oDragConfig[0].getTargetAggregation(), "_intervalPlaceholders", "Source aggregation is correct");
			assert.equal(oDragConfig[0].getGroupName(), "ResizeConfig", "Group name is correct");

			//act
			oPCRow1.setEnableAppointmentsResize(false);

			//assert
			assert.equal(oPCRow1.getDragDropConfig().length, 0, "Zero configs found");

			//clean
			oPC.destroy();
		});

		QUnit.test("_calcResizeNewHoursAppPos: Calculate new size of the appointment in 'Hours' view", function (assert) {
			// arrange
			var oRowStartDate = new Date(2017, 10, 13, 0, 0, 0),
				oAppStartDate = new Date(2017, 10, 13, 1, 0, 0),
				oAppEndDate = new Date(2017, 10, 13, 2, 0, 0),
				newAppPos;

			// act - resize appointment's end with 5 hours (10 x 30 mins) from the beginning of the line
			newAppPos = this.oPCRow._calcResizeNewHoursAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 9);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 13, 5, 0, 0), "End date hour is correct");

			// act - resize appointment's if end time is less than the start time than use just 30 mins from the beggining
			newAppPos = this.oPCRow._calcResizeNewHoursAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 0);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 13, 1, 30, 0), "End date hour is correct");
		});

		QUnit.test("_calcResizeNewDaysAppPos: Calculate new size of the appointment in 'Days' view", function (assert) {
			// arrange
			var oRowStartDate = new Date(2017, 10, 13),
				oAppStartDate = new Date(2017, 10, 13),
				oAppEndDate = new Date(2017, 10, 14),
				newAppPos;

			// act - resize appointment's end with 4 days from the beginning of the line
			newAppPos = this.oPCRow._calcResizeNewDaysAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 3);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 17), "End date day is correct");

			// act - resize appointment's if end time is less than the start time than use just 1 day from the beggining
			newAppPos = this.oPCRow._calcResizeNewDaysAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 0);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 14), "End date day is correct");
		});

		QUnit.test("_calcResizeNewDaysAppPos: Calculate new size of the appointment in 'Days' view - shrink event", function (assert) {
			// arrange
			var oRowStartDate = new Date(2017, 6, 13),
				oAppStartDate = new Date(2017, 6, 13),
				oAppEndDate = new Date(2017, 6, 20),
				newAppPos;

			// act - resize appointment's end with 5 days from the beginning of the line
			newAppPos = this.oPCRow._calcResizeNewDaysAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 4);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 6, 18), "End date day is correct");
		});

		QUnit.test("_calcResizeNewMonthsAppPos: Calculate new size of the appointment in 'Months' view", function (assert) {
			// arrange
			var oRowStartDate = new Date(2017, 6, 13),
					oAppStartDate = new Date(2017, 6, 13),
					oAppEndDate = new Date(2017, 7, 13),
					newAppPos;

			// act - resize appointment's end with 4 Months from the beginning of the line
			newAppPos = this.oPCRow._calcResizeNewMonthsAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 3);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 1), "End date month is correct");

			// act - resize appointment's if end time is less than the start time than use just 1 month from the beggining
			newAppPos = this.oPCRow._calcResizeNewMonthsAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 0);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 7, 1), "End date month is correct");
		});

		QUnit.test("_calcResizeNewMonthsAppPos: Calculate new size of the appointment in 'Months' view - shrink event", function (assert) {
			// arrange
			var oRowStartDate = new Date(2017, 6, 13),
					oAppStartDate = new Date(2017, 6, 13),
					oAppEndDate = new Date(2017, 11, 13),
					newAppPos;

			// act - resize appointment's end with 4 Months from the beginning of the line
			newAppPos = this.oPCRow._calcResizeNewMonthsAppPos(oRowStartDate, oAppStartDate, oAppEndDate, 3);

			// assert
			assert.deepEqual(newAppPos.startDate, oAppStartDate, "Start date should not be changed");
			assert.deepEqual(newAppPos.endDate, new Date(2017, 10, 1), "End date month is correct");
		});

		QUnit.module("Create Appointments: setEnableAppointmentsCreate");

		QUnit.test("setEnableAppointmentsCreate", function(assert) {
			//arrange
			var oPC = new sap.m.PlanningCalendar(),
				oPCRow1 = new sap.m.PlanningCalendarRow("row1");

			oPC.addRow(oPCRow1);

			//act
			oPCRow1.setEnableAppointmentsCreate(true);

			var oDragConfig = _getRowTimeline(oPCRow1).getDragDropConfig();

			//assert
			assert.equal(oDragConfig.length, 1, "One DragInfo found");
			assert.equal(oDragConfig[0].getTargetAggregation(), "_intervalPlaceholders", "Source aggregation is correct");
			assert.equal(oDragConfig[0].getGroupName(), "CreateConfig", "Group name is correct");

			//act
			oPCRow1.setEnableAppointmentsCreate(false);

			//assert
			assert.equal(_getRowTimeline(oPCRow1).getDragDropConfig().length, 0, "Zero configs found");

			//clean
			oPC.destroy();
		});

		QUnit.module("Create Appointments: _calcCreateNewAppHours", {
			beforeEach: function () {
				this.oPCRow = new sap.m.PlanningCalendar();
				this.oRowStartDate = new Date(2017, 10, 13, 0, 0, 0);
				this.test = function (assert, iStartIndex, iEndIndex, oExpectedStartDate, oExpectedEndDate) {
					// arrange
					var oNewAppPos;

					// act
					oNewAppPos = this.oPCRow._calcCreateNewAppHours(this.oRowStartDate, iStartIndex, iEndIndex);

					// assert
					assert.deepEqual(oNewAppPos.startDate, oExpectedStartDate, "startDate is ok");
					assert.deepEqual(oNewAppPos.endDate, oExpectedEndDate, "endDate is ok");
				};
			},
			afterEach: function () {
				this.oPCRow.destroy();
				this.oPCRow = null;
			}
		});

		QUnit.test("startIndex and endIndex are the same: indexes = 0 - (30 minutes event at the beginning of the row)", function (assert) {
			this.test(assert, 0, 0, this.oRowStartDate, new Date(2017, 10, 13, 0, 30, 0));
		});

		QUnit.test("startIndex and endIndex are the same: indexes = 3 - (30 minutes event in 1 hour and 30 mins from the row's startDate)", function (assert) {
			this.test(assert, 3, 3, new Date(2017, 10, 13, 1, 30, 0), new Date(2017, 10, 13, 2, 0, 0));
		});

		QUnit.test("startIndex is lower than the endIndex: startIndex = 0, endIndex = 1 - (1h event at the beginning of the row)", function (assert) {
			this.test(assert, 0, 1, this.oRowStartDate, new Date(2017, 10, 13, 1, 0, 0));
		});

		QUnit.test("startIndex is lower than the endIndex: startIndex = 3, endIndex = 6 - (2h event in 1h and 30 mins from the row's startDate)", function (assert) {
			this.test(assert, 3, 6, new Date(2017, 10, 13, 1, 30, 0), new Date(2017, 10, 13, 3, 30, 0));
		});

		QUnit.test("startIndex is greater than the end Index: startIndex = 1, endIndex = 0 -  (30mins event at the beginning of the row)", function (assert) {
			this.test(assert, 1, 0, this.oRowStartDate, new Date(2017, 10, 13, 0, 30, 0));
		});

		QUnit.test("startIndex is greater than the end Index: startIndex = 6, endIndex = 3 - (1h and 30 mins event in 1h and 30 mins from the row's startDate)", function (assert) {
			this.test(assert, 6, 3, new Date(2017, 10, 13, 1, 30, 0), new Date(2017, 10, 13, 3, 0, 0));
		});

		QUnit.module("Create Appointments: _calcCreateNewAppDays", {
			beforeEach: function () {
				this.oPCRow = new sap.m.PlanningCalendar();
				this.oRowStartDate = new Date(2017, 10, 13, 0, 0, 0);
				this.test = function (assert, iStartIndex, iEndIndex, oExpectedStartDate, oExpectedEndDate) {
					// arrange
					var oNewAppPos;

					// act
					oNewAppPos = this.oPCRow._calcCreateNewAppDays(this.oRowStartDate, iStartIndex, iEndIndex);

					// assert
					assert.deepEqual(oNewAppPos.startDate, oExpectedStartDate, "startDate is ok");
					assert.deepEqual(oNewAppPos.endDate, oExpectedEndDate, "endDate is ok");
				};
			},
			afterEach: function () {
				this.oPCRow.destroy();
				this.oPCRow = null;
			}
		});

		QUnit.test("startIndex and endIndex are the same: indexes = 0 - (1 day event at the beginning of the row)", function (assert) {
			this.test(assert, 0, 0, this.oRowStartDate, new Date(2017, 10, 14));
		});

		QUnit.test("startIndex and endIndex are the same: indexes = 3 - (1 day event in 3 days from the row's startDate)", function (assert) {
			this.test(assert, 3, 3, new Date(2017, 10, 16), new Date(2017, 10, 17));
		});

		QUnit.test("startIndex is lower than the endIndex: startIndex = 0, endIndex = 1 - (2 day event at the beginning of the row)", function (assert) {
			this.test(assert, 0, 1, this.oRowStartDate, new Date(2017, 10, 15));
		});

		QUnit.test("startIndex is lower than the endIndex: startIndex = 3, endIndex = 6 - (4 days event in 3 days from the row's startDate)", function (assert) {
			this.test(assert, 3, 6, new Date(2017, 10, 16), new Date(2017, 10, 20));
		});

		QUnit.test("startIndex is greater than the end Index: startIndex = 1, endIndex = 0 -  (1 day event at the beginning of the row)", function (assert) {
			this.test(assert, 1, 0, this.oRowStartDate, new Date(2017, 10, 14));
		});

		QUnit.test("startIndex is greater than the end Index: startIndex = 6, endIndex = 3 - (3 days event in 3 days from the row's startDate)", function (assert) {
			this.test(assert, 6, 3, new Date(2017, 10, 16), new Date(2017, 10, 19));
		});

		QUnit.module("Create Appointments: _calcCreateNewAppMonths", {
			beforeEach: function () {
				this.oPCRow = new sap.m.PlanningCalendar();
				this.oRowStartDate = new Date(2017, 10, 13, 0, 0, 0);
				this.test = function (assert, iStartIndex, iEndIndex, oExpectedStartDate, oExpectedEndDate) {
					// arrange
					var oNewAppPos;

					// act
					oNewAppPos = this.oPCRow._calcCreateNewAppMonths(this.oRowStartDate, iStartIndex, iEndIndex);

					// assert
					assert.deepEqual(oNewAppPos.startDate, oExpectedStartDate, "startDate is ok");
					assert.deepEqual(oNewAppPos.endDate, oExpectedEndDate, "endDate is ok");
				};
			},
			afterEach: function () {
				this.oPCRow.destroy();
				this.oPCRow = null;
			}
		});

		QUnit.test("startIndex and endIndex are the same: indexes = 0 - (1 month event at the first day of beginning of the row)", function (assert) {
			this.test(assert, 0, 0, new Date(2017, 10, 1), new Date(2017, 11, 1));
		});

		QUnit.test("startIndex and endIndex are the same: indexes = 3 - (1 month event in 3 months from the row's startDate)", function (assert) {
			this.test(assert, 3, 3, new Date(2018, 1, 1), new Date(2018, 2, 1));
		});

		QUnit.test("startIndex is lower than the endIndex: startIndex = 0, endIndex = 1 - (2 months event at the first day of beginning of the row)", function (assert) {
			this.test(assert, 0, 1, new Date(2017, 10, 1), new Date(2017, 12, 1));
		});

		QUnit.test("startIndex is lower than the endIndex: startIndex = 3, endIndex = 6 - (4 months event in 3 months from the row's startDate)", function (assert) {
			this.test(assert, 3, 6, new Date(2018, 1, 1), new Date(2018, 5, 1));
		});

		QUnit.test("startIndex is greater than the end Index: startIndex = 1, endIndex = 0 -  (1 month event at the first day of beginning of the row)", function (assert) {
			this.test(assert, 1, 0, new Date(2017, 10, 1), new Date(2017, 11, 1));
		});

		QUnit.test("startIndex is greater than the end Index: startIndex = 6, endIndex = 3 - (3 months event in 3 months from the row's startDate)", function (assert) {
			this.test(assert, 6, 3, new Date(2018, 1, 1), new Date(2018, 4, 1));
		});
	</script>

</head>
<body class="sapUiBody" role="application">
<h1 id="qunit-header">QUnit tests: sap.m.PlanningCalendar</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<div id="qunit-testrunner-toolbar"></div>
<ol id="qunit-tests"></ol>
<br>
<div id="uiArea1"></div>
<div id="uiArea2"></div>
<div id="uiArea3"></div>
<div id="verySmallUiArea" class="width300"></div>
<div id="smallUiArea" class="width600"></div>
<div id="bigUiArea" class="width1024"></div>
<div id="qunit-fixture"></div>
</body>
</html>