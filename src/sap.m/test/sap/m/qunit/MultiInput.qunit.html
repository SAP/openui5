<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Test Page for sap.m.MultiInput</title>
<script src="../shared-config.js"></script>
<script id="sap-ui-bootstrap"
		data-sap-ui-noConflict="true"
		data-sap-ui-libs="sap.m" src="../../../../resources/sap-ui-core.js">
</script>

<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script src="../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- use the sinon faketimers for this test -->
<script>
	sinon.config.useFakeTimers = true;
</script>

<script>

	var oResourceBundle = sap.ui.getCore().getLibraryResourceBundle("sap.m");

	QUnit.module("Basic", {
		beforeEach : function() {
			this.multiInput1 = new sap.m.MultiInput();
			this.multiInput1.placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();
		},
		afterEach : function() {
			this.multiInput1.destroy();
		}
	});

	QUnit.test("tokens aggregation", function(assert) {
		var token1 = new sap.m.Token();
		var token2 = new sap.m.Token();
		var token3 = new sap.m.Token();
		this.multiInput1.addToken(token1);
		this.multiInput1.addToken(token2);
		this.multiInput1.addToken(token3);

		assert.equal(this.multiInput1.getTokens().length, 3, "MultiInput contains 3 tokens");

		this.multiInput1.removeToken(token1);
		assert.equal(this.multiInput1.getTokens().length, 2, "MultiInput contains 2 tokens");

		this.multiInput1.removeAllTokens();
		assert.equal(this.multiInput1.getTokens().length, 0, "MultiInput contains 0 tokens");

		this.multiInput1.addToken(token1);
		this.multiInput1.addToken(token2);
		this.multiInput1.addToken(token3);
		assert.equal(this.multiInput1.getTokens().length, 3, "MultiInput contains 3 tokens");
	});

	QUnit.test("setTokens aggregation", function(assert) {
		var token1 = new sap.m.Token();
		var token2 = new sap.m.Token();
		var token3 = new sap.m.Token();
		this.multiInput1.setTokens([token1, token2, token3]);

		assert.equal(this.multiInput1.getTokens().length, 3, "MultiInput contains 3 tokens");
	});

	QUnit.test("insertToken aggregation", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "insertToken");
		sap.ui.getCore().applyChanges();

		this.multiInput1.insertToken(new sap.m.Token({text: "Token1"}), 0);

		// assert
		assert.ok(oSpy.called, "Tokenizer's insertToken method is called");
		assert.equal(this.multiInput1.getTokens().length, 1, "then the MultiInput contains 1 tokens");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("getAggregation tokens", function(assert) {
		//arrange
		var token1 = new sap.m.Token();
		var token2 = new sap.m.Token();
		var token3 = new sap.m.Token();

		//act
		this.multiInput1.setTokens([token1, token2, token3]);

		//assert
		assert.equal(this.multiInput1.getAggregation("tokens").length, 3, "MultiInput contains 3 tokens");
		assert.equal(this.multiInput1.getAggregation("asdf"), null, "asdf is invalid aggregation");
	});

	QUnit.test("clone", function(assert) {
		//arrange
		var TEXT = "text",
			KEY = "key",
			token1 = new sap.m.Token({text : TEXT, key : KEY}),
			multiInputClone;

		this.multiInput1.addToken(token1);

		//act
		multiInputClone = this.multiInput1.clone();

		//assert
		assert.equal(multiInputClone.getTokens().length, 1, "Cloned MultiInput contains 1 token");
		assert.equal(multiInputClone.getTokens()[0].getText(), TEXT, "Cloned token has correct text");

		//clean-up
		multiInputClone.destroy();
	});

	QUnit.test("check base class prerequisites", function(assert) {
		assert.ok(this.multiInput1._$input && this.multiInput1._$input.cursorPos, "Base class can return cursor position");
		//assert.ok(multiInput1._oSuggestionPopup && multiInput1._oSuggestionPopup.isOpen, "Base class can tell if suggestion popup is open");
	});

	QUnit.test("test setEditable", function(assert) {
		var isEditable;
		this.multiInput1.setEditable(false);

		isEditable = this.multiInput1.getEditable();
		assert.equal(isEditable, false, "MultiInput editable === false");
		assert.equal(jQuery(this.multiInput1.getDomRef())
				.css("visibility"), "visible", "Input should be visible even if MultiInput is disabled");

		this.multiInput1.setEditable(false);
		isEditable = this.multiInput1.getEditable();
		assert.equal(isEditable, false, "MultiInput editable still === false");

		this.multiInput1.setEditable(true);
		isEditable = this.multiInput1.getEditable();
		assert.equal(isEditable, true, "MultiInput editable === true");
	});

	QUnit.test("max tokens", function(assert) {
		var token1 = new sap.m.Token();
		var token2 = new sap.m.Token();
		var token3 = new sap.m.Token();

		this.multiInput1.setMaxTokens(2);

		this.multiInput1.setTokens([token1, token2, token3]);
		assert.equal(this.multiInput1.getTokens().length, 2, "no more than 2 tokens can be added");
	});

	QUnit.test("token data binding", function(assert) {
		jQuery.sap.require("sap.ui.model.json.JSONModel");

		// JSON sample data
		var data = {
			modelData:[
				{lastName:"Doe",gender:"Male"},
				{lastName:"Ali",gender:"Female"}
			]};

		// create JSON model instance
		var oModel = new sap.ui.model.json.JSONModel();

		// set the data for the model
		oModel.setData(data);

		// set the model to the core
		sap.ui.getCore().setModel(oModel);

		// define the template
		var oItemTemplate = new sap.m.ColumnListItem({
			cells : [
				new sap.m.Label({
					text: "{lastName}"
				}),
				new sap.m.MultiInput({
					tokens:[
						new sap.m.Token({text:"{lastName}", key:"{lastName}"}),
						new sap.m.Token({text:"{gender}", key:"{gender}"})
					]
				})
			]
		});

		var aColumns = [
			new sap.m.Column({
				header : new sap.m.Label({
					text : "LastName"
				}),
				width: "100px"
			}),
			new sap.m.Column({
				header : new sap.m.Label({
					text : "LastName + Gender"
				})
			})
		];

		var oTable = new sap.m.Table({ columns : aColumns});
		oTable.bindItems("/modelData", oItemTemplate);
		oTable.placeAt("qunit-fixture");

		sap.ui.getCore().applyChanges();

		var oMultiInput1 = oTable.getItems()[0].getCells()[1];
		assert.equal(oMultiInput1.getTokens()[0].$().text(), "Doe", "text of token is correct");
		assert.equal(oMultiInput1.getTokens()[1].$().text(), "Male", "text of token is correct");

		var oMultiInput2 = oTable.getItems()[1].getCells()[1];
		assert.equal(oMultiInput2.getTokens()[0].$().text(), "Ali", "text of token is correct");
		assert.equal(oMultiInput2.getTokens()[1].$().text(), "Female", "text of token is correct");

		oTable.destroy();
	});

	QUnit.test("data binding when tokens have changed", function(assert) {
		jQuery.sap.require("sap.ui.model.json.JSONModel");

		// arrange
		var oldData = {
			names: [
				{firstName: "Peter"},
				{firstName: "Martin"},
				{firstName: "Thomas"},
				{firstName: "John"}
			]
		};

		var newData = {
			names: [
				{firstName: "Arnold"},
				{firstName: "Chuck"},
				{firstName: "Silvester"},
				{firstName: "Jason"}
			]
		}

		// create a Model with the data above
		var model = new sap.ui.model.json.JSONModel();
		model.setData(oldData);

		var oTokenTemplate = new sap.m.Token({text : "{firstName}"});

		this.multiInput1.setModel(model);
		this.multiInput1.bindAggregation("tokens", "/names", oTokenTemplate);

		sap.ui.getCore().applyChanges();

		var firstToken = this.multiInput1.getTokens()[0];
		firstToken.setSelected(true);

		// act
		qutils.triggerKeydown(firstToken.$(), jQuery.sap.KeyCodes.BACKSPACE);

		// assert
		assert.equal(this.multiInput1.getTokens().length, 3, "MultiInput has only 3 tokens");

		// act

		model.setData(newData);

		sap.ui.getCore().applyChanges();

		// assert
		assert.equal(this.multiInput1.getTokens().length, 4, "MultiInput has 4 tokens");
		assert.equal(this.multiInput1.getTokens()[0].getText(), "Arnold", "The data binding has been applied properly");
	});


	QUnit.test("tabindex of tokenizer in MultiInput", function(assert) {
		assert.equal(!this.multiInput1.$().find(".sapMTokenizer").attr("tabindex"), true, "tokenizer has no tabindex if it is in MultiInput");
	});

	QUnit.test("test setEditable=false MultiInput with editable tokens", function(assert) {
		var aFirstToken,
			aSecondToken;
		//arrange
		this.multiInput1.setTokens([
			new sap.m.Token({text: "Token 1", key: "0001"}),
			new sap.m.Token({text: "Token 2", key: "0002", editable: false})
		]);

		aFirstToken = this.multiInput1.getTokens()[0];
		aSecondToken = this.multiInput1.getTokens()[1];
		sap.ui.getCore().applyChanges();

		//assert
		assert.equal(aFirstToken.$('icon').css('display'), 'inline-block', 'First token icon is visible');
		assert.ok(!aSecondToken.getDomRef('icon'), 'Second token icon does not exist');

		//act
		this.multiInput1.setEditable(false);
		sap.ui.getCore().applyChanges();

		//assert
		assert.equal(aFirstToken.$('icon').css('display'), 'none', 'First token icon is invisible');
		assert.ok(!aSecondToken.getDomRef('icon'), 'Second token icon does not exist');
	});

	QUnit.test("test text validation on focus leave", function(assert) {
		//arrange
		var testTokenText = "C-Item";

		this.multiInput1.addValidator(function(args){
			return new sap.m.Token({text: args.text});
		});

		this.multiInput1.setValue(testTokenText);

		//act
		this.multiInput1.onsapfocusleave({});

		//assert
		var aTokens = this.multiInput1.getTokens();
		assert.equal(aTokens.length, 1, "MultiInput contains 1 token");
		assert.equal(aTokens[0].getText(), testTokenText, "Token text == " + testTokenText);
	});

	QUnit.test("test text validation on focus leave when duplicate token is created", function(assert) {
		//arrange
		var testTokenText = "C-Item",
			firstToken = new sap.m.Token({
				text: testTokenText,
				key: testTokenText
			});

		this.multiInput1.addValidator(function(args){
			return new sap.m.Token({text: args.text, key: args.text});
		});

		this.multiInput1.addToken(firstToken);

		//act
		this.multiInput1.onsapfocusleave({});

		//assert
		var aTokens = this.multiInput1.getTokens();
		assert.equal(aTokens.length, 1, "MultiInput contains 1 token");
		assert.equal(aTokens[0].getText(), testTokenText, "Token text == " + testTokenText);

		this.multiInput1.setValue(testTokenText);
		//act
		this.multiInput1.onsapfocusleave({});

		//assert
		var aTokens = this.multiInput1.getTokens();
		assert.equal(aTokens.length, 1, "MultiInput contains still contains 1 token, duplicate token was not added");

		this.multiInput1.setValue("B-Item");
		//act
		this.multiInput1.onsapfocusleave({});

		//assert
		var aTokens = this.multiInput1.getTokens();
		assert.equal(aTokens.length, 2, "MultiInput contains contains 2 token");

	});

	QUnit.module("Validation", {
		beforeEach: function() {
			this.multiInput1 = new sap.m.MultiInput();
			this.multiInput1.placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();
		},
		afterEach: function() {
			this.multiInput1.destroy();
		}
	});

	QUnit.test("validation via suggestion items", function(assert) {
		var i,
			AasciiCode = 65; // A == 65 in ASCII

		for (i = 0; i < 10; i++) {
			this.multiInput1.addSuggestionItem(new sap.ui.core.Item({ text : String.fromCharCode(i + AasciiCode) + "-Item"}));
		}

		assert.equal(this.multiInput1.getTokens().length, 0, "MultiInput contains 0 tokens");

		this.multiInput1.setValue("a");
		this.multiInput1._getIsSuggestionPopupOpen = function(){ return true; };
		this.multiInput1.onsapenter();

		assert.equal(this.multiInput1.getTokens().length, 1, "MultiInput contains 1 token, added via suggest");

		this.multiInput1.setValue("B");
		this.multiInput1._getIsSuggestionPopupOpen = function(){ return true; };
		this.multiInput1.onsapenter();

		assert.equal(this.multiInput1.getTokens().length, 2, "MultiInput contains 2 tokens, added via suggest ");

		this.multiInput1.setValue("C");
		this.multiInput1._getIsSuggestionPopupOpen = function(){ return false; };
		this.multiInput1.onsapenter();

		assert.equal(this.multiInput1.getTokens().length, 2, "MultiInput contains 2 tokens, no token added, suggestion list was closed");

		this.multiInput1.setValue("Z");
		this.multiInput1._getIsSuggestionPopupOpen = function(){ return true; };
		this.multiInput1.onsapenter();

		assert.equal(this.multiInput1.getTokens().length, 2, "MultiInput contains 2 tokens, no token added, value does not fit suggestion list");
	});

	QUnit.test("validate tokens using validator callback", function(assert) {
		assert.equal(this.multiInput1.getTokens().length, 0, "MultiInput contains 0 tokens");

		this.multiInput1.removeAllValidators();
		this.multiInput1.addValidator(function(args){
			return new sap.m.Token({text: args.text});
		});

		var tokenText = "TestToken1";
		this.multiInput1.setValue(tokenText);
		this.multiInput1.onsapenter();
		assert.equal(this.multiInput1.getTokens().length, 1, "MultiInput contains 1 token");
		assert.equal(this.multiInput1.getTokens()[0].getText(), tokenText, "added token contains validated text");

		var tokenText = "TestToken2";
		this.multiInput1.setValue(tokenText);
		this.multiInput1.onsapenter();
		assert.equal(this.multiInput1.getTokens().length, 2, "MultiInput contains 2 tokens");
		assert.equal(this.multiInput1.getTokens()[1].getText(), tokenText, "added token contains validated text");

		this.multiInput1.removeAllValidators();
		this.multiInput1.addValidator(function(args){
			return;
		});
		tokenText = "TestToken3";
		this.multiInput1.setValue(tokenText);
		this.multiInput1.onsapenter();
		assert.equal(this.multiInput1.getTokens().length, 2, "MultiInput contains 2 tokens, no token added as validator rejected it");



		var fAsyncValidateCallback;
		this.multiInput1.removeAllValidators();
		this.multiInput1.addValidator(function(args){
			fAsyncValidateCallback = args.asyncCallback;
			return sap.m.MultiInput.WaitForAsyncValidation;
		});
		tokenText = "TestToken4";
		this.multiInput1.setValue(tokenText);
		this.multiInput1.onsapenter();

		assert.equal(this.multiInput1.getTokens().length, 2, "MultiInput contains 2 tokens, no token added as validator runs asynchronously");

		fAsyncValidateCallback(new sap.m.Token({text: "dummy"}));

		assert.equal(this.multiInput1.getTokens().length, 3, "MultiInput contains 3 tokens");
	});

	QUnit.test("removeValidator", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "removeValidator"),
			oValidator = function(args){
				return new sap.m.Token({text: args.text});
			};

		this.multiInput1.addValidator(oValidator);

		sap.ui.getCore().applyChanges();
		this.multiInput1.removeValidator(oValidator);
		// assert
		assert.strictEqual(this.multiInput1._tokenizer._aTokenValidators.length, 0 , "then the MultiInput has no validators");
		assert.ok(oSpy.called, "Tokenizer's removeValidator is called");

		// cleanup
		oSpy.restore();
	});

	QUnit.module("KeyboardEvents", {
		beforeEach : function() {
			this.multiInput1 = new sap.m.MultiInput();
			this.multiInput1.placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();

			this.multiInput1.$().focus();
		},
		afterEach : function() {
			this.multiInput1.destroy();
		}
	});

	QUnit.test("delete tokens via backspace", function(assert) {
		assert.equal(this.multiInput1.getTokens().length, 0, "MultiInput contains 0 tokens");

		var token1 = new sap.m.Token();
		this.multiInput1.addToken(token1);

		sap.ui.getCore().applyChanges();

		this.multiInput1.onsapbackspace({preventDefault:function(){}, stopPropagation:function(){}, setMarked:function(){}});
		assert.ok(token1.getSelected(), "Token got selected");

		this.multiInput1.onsapbackspace({preventDefault:function(){}, stopPropagation:function(){}, setMarked:function(){}});
		assert.equal(this.multiInput1.getTokens().length, 0, "Token got deleted");
	});

	QUnit.test("delete tokens via backspace and prevent default", function(assert) {

		this.multiInput1.attachTokenUpdate(function (evt) {
			evt.preventDefault();
		});

		assert.equal(this.multiInput1.getTokens().length, 0, "MultiInput contains 0 tokens");

		var token1 = new sap.m.Token();
		this.multiInput1.addToken(token1);

		sap.ui.getCore().applyChanges();

		this.multiInput1.onsapbackspace({preventDefault:function(){}, stopPropagation:function(){}, setMarked:function(){}});
		assert.ok(token1.getSelected(), "Token got selected");

		this.multiInput1.onsapbackspace({preventDefault:function(){}, stopPropagation:function(){}, setMarked:function(){}});
		assert.equal(this.multiInput1.getTokens().length, 1, "Token is not deleted");
	});

	QUnit.test("test keyboard navigation", function(assert){
		var token = new sap.m.Token({selected: true}),
			that = this;
		this.multiInput1.addToken(token);
		assert.equal(this.multiInput1.getTokens().length, 1, "MultiInput contains 1 token");

		this.multiInput1.onsapnext({isMarked:function(){return false;}});

		this.multiInput1.onsapdelete();
		assert.equal(this.multiInput1.getTokens().length, 0, "MultiInput contains 0 tokens");

		token = new sap.m.Token({selected: false});
		this.multiInput1.addToken(token);

		sap.ui.getCore().applyChanges();

		this.multiInput1._getIsSuggestionPopupOpen = function(){ return true; };

		this.multiInput1.onsapprevious(new jQuery.Event("onsapprevious", {srcControl: that.multiInput1}));
		assert.equal(token.getSelected(), false, "Token not selected because popup is open");

		this.multiInput1._getIsSuggestionPopupOpen = function(){return false;};
		this.multiInput1.onsapprevious(new jQuery.Event("onsapprevious", {srcControl: that.multiInput1}));
		assert.equal(token.getSelected(), true, "Token got selected");
	});

	QUnit.test("test remove via live change", function(assert) {
		var token1 = new sap.m.Token({selected:true});
		var token2 = new sap.m.Token({selected:true});
		var token3 = new sap.m.Token({selected:true});
		this.multiInput1.setTokens([token1, token2, token3]);
		this.multiInput1.fireLiveChange();

		assert.equal(this.multiInput1.getTokens().length, 0, "MultiInput contains 0 tokens");
	});

	QUnit.test("keyboard - ctrl + A with no text", function(assert) {
		var token1 = new sap.m.Token();
		var token2 = new sap.m.Token();
		var token3 = new sap.m.Token();
		this.multiInput1.setTokens([token1, token2, token3]);

		sap.ui.getCore().applyChanges();

		this.multiInput1.focus();

		//debugger;
		qutils.triggerKeydown(this.multiInput1.$(), jQuery.sap.KeyCodes.A, false, false, true); // trigger Control key + A
		assert.equal(token1.getSelected(), true, "Token1 got selected using ctrl+a");
		assert.equal(token2.getSelected(), true, "Token2 got selected using ctrl+a");
		assert.equal(token3.getSelected(), true, "Token3 got selected using ctrl+a");
	});

	QUnit.test("keyboard - ctrl + A with text", function(assert) {
		var token1 = new sap.m.Token();
		var token2 = new sap.m.Token();
		var token3 = new sap.m.Token();
		this.multiInput1.setTokens([token1, token2, token3]);

		this.multiInput1.updateDomValue("123");
		sap.ui.test.qunit.triggerEvent("input", this.multiInput1.getFocusDomRef());

		this.multiInput1.focus();
		this.multiInput1.selectText(0, this.multiInput1.getValue().length);
		assert.equal(this.multiInput1._$input.getSelectedText(), "123", "only texts are selected");

		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.A, false, false, true); // trigger Control key + A
		assert.equal(token1.getSelected(), true, "Token1 is selected");
		assert.equal(token2.getSelected(), true, "Token2 is selected");
		assert.equal(token3.getSelected(), true, "Token3 is selected");

		this.multiInput1.ontap();
		this.clock.tick(1);

		assert.equal(token1.getSelected(), false, "Token1 is unselected");
		assert.equal(token2.getSelected(), false, "Token2 is unselected");
		assert.equal(token3.getSelected(), false, "Token3 is unselected");
	});

	QUnit.test("esc key", function(assert) {

		this.multiInput1.setValue("123");
		this.multiInput1.selectText(0, this.multiInput1.getValue().length);
		var token1 = new sap.m.Token({selected:true});
		var token2 = new sap.m.Token({selected:true});
		var token3 = new sap.m.Token({selected:true});
		this.multiInput1.setTokens([token1, token2, token3]);

		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.ESCAPE);
		assert.equal(token1.getSelected(), false, "Token1 is unselected");
		assert.equal(token2.getSelected(), false, "Token2 is unselected");
		assert.equal(token3.getSelected(), false, "Token3 is unselected");
		assert.equal(this.multiInput1._$input.getSelectedText(), "", "texts get unselected");
	});

	QUnit.test("onsaphome", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "onsaphome"),
			token1 = new sap.m.Token({text: "Token"});

		this.multiInput1.addToken(token1);
		sap.ui.getCore().applyChanges();

		this.multiInput1.getTokens()[0].focus();
		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.HOME);

		// assert
		assert.ok(oSpy.called, "Tokenizer's onsaphome is called when a token is focused");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("onsaphome when no token is focused", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "onsaphome"),
				token1 = new sap.m.Token({text: "Token"});

		this.multiInput1.addToken(token1);
		sap.ui.getCore().applyChanges();

		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.HOME);

		// assert
		assert.notOk(oSpy.called, "Tokenizer's onsaphome is not called when no token is focused");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("onsapprevious when MultiInput has no value", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "onsapprevious"),
				token1 = new sap.m.Token({text: "Token"});

		this.multiInput1.addToken(token1);
		sap.ui.getCore().applyChanges();

		this.multiInput1.getTokens()[0].focus();
		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.ARROW_LEFT);

		// assert
		assert.ok(oSpy.called, "Tokenizer's onsapprevious is called");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("onsapprevious when MultiInput has value and focus is on input", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "onsapprevious"),
			token1 = new sap.m.Token({text: "Token"});

		this.multiInput1.addToken(token1);
		this.multiInput1.setValue("text");
		this.multiInput1._$input.focus();
		this.multiInput1._$input[0].setSelectionRange(3, 3);

		sap.ui.getCore().applyChanges();

		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.ARROW_LEFT);

		// assert
		assert.notOk(oSpy.called, "Tokenizer's onsapprevious is not called");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("onsapdelete", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "onsapdelete");

		sap.ui.getCore().applyChanges();
		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.DELETE);

		// assert
		assert.ok(oSpy.called, "Tokenizer's onsapdelete is called");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("onsapdelete when MultiInput has value", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "onsapdelete");
		this.multiInput1.setValue("value");

		sap.ui.getCore().applyChanges();
		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.DELETE);

		// assert
		assert.notOk(oSpy.called, "Tokenizer's onsapdelete is not called");
		assert.equal(this.multiInput1.onsapdelete(), undefined, "then onsapdelete returns undefined");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("onsapnext when a token is focused", function(assert) {

		var oMISpy = sinon.spy(sap.m.MultiInput.prototype, "_scrollAndFocus"),
			oTokenizerSpy = sinon.spy(sap.m.Tokenizer.prototype, "scrollToEnd");

		this.multiInput1.addToken(new sap.m.Token({}));

		sap.ui.getCore().applyChanges();

		this.multiInput1.getTokens()[0].focus();

		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_RIGHT, false, false, false);

		// assert
		assert.ok(oMISpy.called, "MultiInputs's _scrollAndFocus is called");
		assert.ok(oTokenizerSpy.called, "Tokenizer's scrollToEnd is not called");

		// cleanup
		oMISpy.restore();
		oTokenizerSpy.restore();
	});

	QUnit.test("onsapnext when MultiInput in not editable", function(assert) {

		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "onsapdelete");
		this.multiInput1.setEditable(false);
		sap.ui.getCore().applyChanges();
		sap.ui.test.qunit.triggerKeydown(this.multiInput1.getDomRef(), jQuery.sap.KeyCodes.DELETE);

		// assert
		assert.equal(this.multiInput1.openMultiLine(), undefined, "then the openMultiLine returns undefined");
		assert.notOk(oSpy.called, "Tokenizer's onsapdelete is not called");

		// cleanup
		oSpy.restore();
	});


	QUnit.module("MultiLineMode", {
		beforeEach: function() {
			this.multiInput1 = new sap.m.MultiInput({
				enableMultiLineMode : true
			});

			this.multiInput1.placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();
		},
		afterEach: function() {
			this.multiInput1.destroy();
		}
	});

	QUnit.test("property EnableMultiLineMode", function(assert) {
		this.multiInput1.addToken(new sap.m.Token({key:"1",text:"MutiLineToken1"}));
		this.multiInput1.addToken(new sap.m.Token({key:"2",text:"MutiLineMutiLineMutiLineMutiLineMutiLineMutiLineMutiLineMutiLineMutiLineMutiLineMutiLineMutiLineToken2"}));
		this.multiInput1.addToken(new sap.m.Token({key:"3",text:"Token3"}));

		assert.equal(this.multiInput1.getEnableMultiLineMode(), true, "MultiLine mode is true");
		assert.equal(this.multiInput1.$().hasClass("sapMMultiInputMultiLine"), true, "MultiLine input has class sapMMultiInputMultiLine");

		this.multiInput1.setEnableMultiLineMode(false);
		sap.ui.getCore().applyChanges();
		this.clock.tick(10);

		assert.equal(this.multiInput1.getEnableMultiLineMode(), false, "set back single-line mode");
		assert.equal(this.multiInput1.$().hasClass("sapMMultiInputMultiLine"), false, "multi-line doesn't have class sapMMultiInputMultiLine");
	});

	QUnit.test("open/close multi line mode on desktop", function(assert) {
		//act
		this.multiInput1.openMultiLine();

		//assert
		assert.equal(this.multiInput1.$("border").hasClass("sapMMultiInputMultiModeBorder"), false, "MultiInput has no tokens and no class sapMMultiInputMultiModeBorder");
		assert.equal(this.multiInput1._$input.parents('.sapMMultiInputBorder').hasClass("sapMMultiInputMultiModeInputContainer"), false, "MultiInput has no tokens and no class sapMMultiInputMultiModeInputContainer");

		//arrange
		this.multiInput1.setTokens([
			new sap.m.Token({text : "Token 1"}),
			new sap.m.Token({text : "Token 2"})
		]);

		//act
		this.multiInput1.openMultiLine();

		//assert
		assert.equal(this.multiInput1.$("border").hasClass("sapMMultiInputMultiModeBorder"), true, "MultiInput is open and has class sapMMultiInputMultiModeBorder");
		assert.equal(this.multiInput1._$input.parents('.sapMMultiInputBorder').hasClass("sapMMultiInputMultiModeInputContainer"), true, "MultiInput is open and has class sapMMultiInputMultiModeInputContainer");

		//act
		this.multiInput1.closeMultiLine();

		//assert
		assert.equal(this.multiInput1.$("border").hasClass("sapMMultiInputMultiModeBorder"), false, "MultiInput closed and has no class sapMMultiInputMultiModeBorder");
		assert.equal(this.multiInput1._$input.parents('.sapMMultiInputBorder').hasClass("sapMMultiInputMultiModeInputContainer"), false, "MultiInput closed and has no class sapMMultiInputMultiModeInputContainer");
	});

	QUnit.test("open/close multi line mode using API functions", function(assert) {
		//arrange
		this.multiInput1.setTokens([
			new sap.m.Token({text : "Token 1"}),
			new sap.m.Token({text : "Token 2"}),
			new sap.m.Token({text : "Token 3"})
		]);

		//act
		this.multiInput1.openMultiLine();
		this.multiInput1.closeMultiLine();

		//assert
		assert.equal(this.multiInput1.$().find('.sapMMultiInputIndicator').length, 1, "N More indicator is displayed");
	});

	QUnit.test("open/close multi line mode using API functions when MultiInput is not editable", function(assert) {
		//arrange
		this.multiInput1.setTokens([
			new sap.m.Token({text : "Token 1"}),
			new sap.m.Token({text : "Token 2"}),
			new sap.m.Token({text : "Token 3"})
		]);
		this.multiInput1.setEditable(false);

		//assert
		assert.equal(this.multiInput1.openMultiLine(), undefined, "then the openMultiLine returns undefined");
		assert.equal(this.multiInput1.closeMultiLine(), undefined, "then the closeMultiLine returns undefined");
		assert.equal(this.multiInput1._tokenizer.$().hasClass("sapMTokenizerMultiLine"), false, "Tokenizer is not displayed multiple lines");
	});

	QUnit.test("open multi line mode on phone", function(assert) {
		//arrange
		var oSystem = {
			desktop: false,
			phone: true,
			tablet: false
		};

		this.stub(sap.ui.Device, "system", oSystem);

		var oMIMultiLineMode = new sap.m.MultiInput();

		oMIMultiLineMode.placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();

		//act
		oMIMultiLineMode._openMultiLineOnPhone();

		this.clock.tick(500);
		sap.ui.getCore().applyChanges();

		//assert
		assert.equal(oMIMultiLineMode._oSuggestionPopup.isOpen(), true, "MultiInput dialog is open");
		assert.equal(oMIMultiLineMode._tokenizer.getVisible(), true, "Tokenizer is visible");
		assert.equal(oMIMultiLineMode._tokenizer.$().hasClass("sapMTokenizerMultiLine"), true, "Tokenizer is displayed on multiple lines");

		//clean-up
		oMIMultiLineMode.destroy();
	});

	QUnit.test("open multi line mode on phone when MultiInput in not editable", function(assert) {
		//arrange
		var oSystem = {
			desktop: false,
			phone: true,
			tablet: false
		};

		this.stub(sap.ui.Device, "system", oSystem);

		//arrange
		this.multiInput1.setTokens([
			new sap.m.Token({text : "Token 1"}),
			new sap.m.Token({text : "Token 2"}),
			new sap.m.Token({text : "Token 3"})
		]);
		this.multiInput1.setEditable(false);
		//act
		this.multiInput1._openMultiLineOnPhone();

		//assert
		assert.equal(this.multiInput1.$().find('.sapMMultiInputIndicator').length, 1, "N More indicator is displayed");
	});


	QUnit.module("Events", {
		beforeEach: function() {
			this.multiInput1 = new sap.m.MultiInput();
			this.multiInput1.placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();
		},
		afterEach: function() {
			this.multiInput1.destroy();
		}
	});

	QUnit.test("tokens change event", function(assert) {
		var eventType;
		this.multiInput1.attachTokenChange(function(args){
			eventType = args.getParameter("type");
		});

		var token1 = new sap.m.Token();
		this.multiInput1.addToken(token1);
		assert.equal(eventType, sap.m.MultiInput.TokenChangeType.Added, "added event raised");

		this.multiInput1.removeToken(token1);
		assert.equal(eventType, sap.m.MultiInput.TokenChangeType.Removed, "removed event raised");

		this.multiInput1.removeAllTokens();
		assert.equal(eventType, sap.m.MultiInput.TokenChangeType.RemovedAll, "removedAll event raised");
	});

	QUnit.test("tokens change event when multiline and tokens become less than 2", function(assert) {
		this.multiInput1.setTokens([new sap.m.Token(), new sap.m.Token()]);
		this.multiInput1.setEnableMultiLineMode(true);
		var firstToken = this.multiInput1.getTokens()[0];

		sap.ui.getCore().applyChanges();

		assert.equal(this.multiInput1.$().find('.sapMMultiInputIndicator').length, 1, "N More indicator is displayed");
		this.multiInput1.removeToken(firstToken);

		assert.strictEqual(this.multiInput1.getTokens().length, 1, "then MultiInput has 1 token");
		assert.equal(this.multiInput1.$().find('.sapMMultiInputIndicator').length, 0, "N More indicator is not displayed");
	});

	QUnit.test("token update event", function(assert) {

		if (!sap.ui.Device.browser.internet_explorer) {
			//arrange
			var sPastedString = "a\nb\nc\nd\ne\nf\n\a",
					counter = 0;

			this.multiInput1.addValidator(function (args) {
				return new sap.m.Token({text: args.text, key: args.text});
			});

			this.multiInput1.attachTokenUpdate(function (args) {
				counter++;
			});

			//act
			sap.ui.test.qunit.triggerEvent("paste", this.multiInput1.getFocusDomRef(), {
				originalEvent: {
					clipboardData: {
						getData: function () {
							return sPastedString;
						}
					}
				}
			});

			this.clock.tick(10);
			sap.ui.getCore().applyChanges();

			//assert
			assert.equal(counter, 1, "tokenUpdate event should be fired once");
			assert.equal(this.multiInput1.getTokens().length, 6, "6 tokens should be added to MultiInput");
		} else {
			assert.expect(0);
		}
	});

	QUnit.test("test suggestionItemSelected event", function(assert) {
		var testTokenText = "Testtoken";
		var item = {
			getText: function(){return testTokenText;},
			getKey: function(){return "abc"}
		};

		this.multiInput1.fireSuggestionItemSelected({selectedItem: item});

		var aTokens = this.multiInput1.getTokens();
		assert.equal(aTokens.length, 1, "MultiInput contains 1 token");
		assert.equal(aTokens[0].getText(), testTokenText, "Token text == " + testTokenText);
	});

	QUnit.test("click on delete icon should not trigger Input.prototype.ontap", function(assert) {
		var spy = sinon.spy(sap.m.Input.prototype, "ontap"),
			token1 = new sap.m.Token();

		this.multiInput1.addToken(token1);
		this.multiInput1.attachTokenUpdate(function(evt){
			evt.preventDefault();
		});

		sap.ui.getCore().applyChanges();

		sap.ui.test.qunit.triggerEvent("tap", this.multiInput1.getTokens()[0]._deleteIcon.getDomRef());

		// assert
		assert.notOk(spy.called, "Input's ontap method is not called");
	});

	QUnit.test("Change event is properly fired on different interactions", function (assert) {
		//Setup
		var oChangeFireSpy = this.spy(this.multiInput1, "fireChange"),
			oValidatorSpy = this.spy(function (oParams) {
				return new sap.m.Token({
					key: oParams.text,
					text: oParams.text
				});
			});
		this.multiInput1.addValidator(oValidatorSpy);


		//Act
		//Emulate use input
		// Modify DOM's value as we don't want to go trough MultiInput's API.
		this.multiInput1.$("inner").val("Test token");
		this.multiInput1.onsapenter({});
		sap.ui.getCore().applyChanges();

		//Assert
		assert.ok(oChangeFireSpy.calledOnce, "Change is fired");
		assert.ok(oValidatorSpy.calledOnce, "Validator is fired");
		assert.ok(oChangeFireSpy.calledBefore(oValidatorSpy), "fireChange is fired before Validator");

		//Act
		//Emulate use input
		// Modify DOM's value as we don't want to go trough MultiInput's API.
		this.multiInput1.bFocusoutDueRendering = false;
		this.multiInput1.$("inner").val("Test token 2");
		this.multiInput1.onsapfocusleave({});
		sap.ui.getCore().applyChanges();

		//Assert
		assert.ok(oChangeFireSpy.calledTwice, "Change is fired");
		assert.ok(oValidatorSpy.calledTwice, "Validator is fired");
		assert.ok(oChangeFireSpy.calledBefore(oValidatorSpy), "fireChange is fired before Validator");
	});

	QUnit.test("Selecting an item should not leave a text in the input", function (assert) {
		// arrange
		var oItem = new sap.ui.core.ListItem({
			key: '1',
			text: '1 Item 1'
		});

		var oSpyChangeEvent = sinon.spy(this.multiInput1, "fireChange");

		this.multiInput1.addSuggestionItem(oItem);
		sap.ui.getCore().applyChanges();

		// act
		this.multiInput1.setSelectionItem(oItem, true);
		sap.ui.getCore().applyChanges();

		// assert
		assert.strictEqual(this.multiInput1.getValue(), "", "Value of the input should be empty");

		assert.strictEqual(oSpyChangeEvent.callCount, 1, "Change event should be fired once");
	});

	QUnit.module("Mobile", {});

	QUnit.test("token update event when on mobile", function(assert) {
		this.stub(sap.ui.Device, "system", {
			desktop: false,
			phone: true,
			tablet: false
		});

		this.multiInput1 = new sap.m.MultiInput();
		this.multiInput1.setEnableMultiLineMode(true);
		this.multiInput1.addToken(new sap.m.Token({text: "Text"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Text"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Text"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Text"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Text"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Text"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Text"}));

		this.multiInput1.placeAt("qunit-fixture");

		sap.ui.getCore().applyChanges();

		assert.ok(this.multiInput1.getVisible(), "then the MultiInput is visible");
		assert.equal(this.multiInput1.$().find('.sapMMultiInputIndicator').length, 1, "N More indicator is displayed");

		this.multiInput1.destroy();
	});

	QUnit.module("Accessibility", {
		beforeEach : function() {
			this.multiInput1 = new sap.m.MultiInput({
				value: "Value",
				tooltip: "Tooltip",
				placeholder: "Placeholder"
			});
			this.multiInput1.placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();
		},
		afterEach : function() {
			this.multiInput1.destroy();
		}
	});

	QUnit.test("getAccessibilityInfo", function(assert) {
		// assert
		assert.ok(!!this.multiInput1.getAccessibilityInfo, "MultiInput has a getAccessibilityInfo function");

		// arrange
		var oInfo = this.multiInput1.getAccessibilityInfo();

		// assert
		assert.ok(!!oInfo, "getAccessibilityInfo returns a info object");
		assert.strictEqual(oInfo.role, this.multiInput1.getRenderer().getAriaRole(), "AriaRole");
		assert.strictEqual(oInfo.type, oResourceBundle.getText("ACC_CTR_TYPE_MULTIINPUT"), "Type");
		assert.strictEqual(oInfo.description, "Value Placeholder Tooltip", "Description");
		assert.strictEqual(oInfo.focusable, true, "Focusable");
		assert.strictEqual(oInfo.enabled, true, "Enabled");
		assert.strictEqual(oInfo.editable, true, "Editable");

		// act
		this.multiInput1.setValue("");
		this.multiInput1.setEnabled(false);
		oInfo = this.multiInput1.getAccessibilityInfo();

		// assert
		assert.strictEqual(oInfo.description, "Placeholder Tooltip", "Description");
		assert.strictEqual(oInfo.focusable, false, "Focusable");
		assert.strictEqual(oInfo.enabled, false, "Enabled");
		assert.strictEqual(oInfo.editable, false, "Editable");

		// act
		this.multiInput1.setEnabled(true);
		this.multiInput1.setEditable(false);
		oInfo = this.multiInput1.getAccessibilityInfo();

		// assert
		assert.strictEqual(oInfo.focusable, true, "Focusable");
		assert.strictEqual(oInfo.enabled, true, "Enabled");
		assert.strictEqual(oInfo.editable, false, "Editable");

		// act
		this.multiInput1.setDescription("Description");
		oInfo = this.multiInput1.getAccessibilityInfo();

		// assert
		assert.strictEqual(oInfo.description, "Placeholder Tooltip Description", "Description");

		// act
		this.multiInput1.addToken(new sap.m.Token({text: "Token1"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Token2"}));
		this.multiInput1.setDescription("Description");
		oInfo = this.multiInput1.getAccessibilityInfo();

		// assert
		assert.strictEqual(oInfo.description, "Placeholder Tooltip Description Token1 Token2", "Description");
	});

	QUnit.test("_tokensInfo aggregation", function(assert) {
		// arrange
		var oInvisibleText = this.multiInput1.getAggregation("_tokensInfo");

		// assert
		assert.strictEqual(oInvisibleText.getText(), oResourceBundle.getText("MULTIINPUT_ARIA_CONTAIN_TOKEN"), "'MultiInput may contain tokens' text is set.");

		// act
		this.multiInput1.addToken(new sap.m.Token({text: "Token1"}));

		sap.ui.getCore().applyChanges();

		// assert
		assert.strictEqual(oInvisibleText.getText(), oResourceBundle.getText("MULTIINPUT_ARIA_CONTAIN_ONE_TOKEN"), "'MultiInput contains 1 token' text is set.");

		// act
		this.multiInput1.addToken(new sap.m.Token({text: "Token2"}));

		sap.ui.getCore().applyChanges();

		// assert
		assert.strictEqual(oInvisibleText.getText(), oResourceBundle.getText("MULTIINPUT_ARIA_CONTAIN_SEVERAL_TOKENS", this.multiInput1.getTokens().length), "'MultiInput contains N tokens' text is set.");
	});

	QUnit.test("Placeholder opacity", function(assert) {
		// assert
		assert.ok(!this.multiInput1.$().hasClass("sapMMultiInputNoPlaceholder"), "MultiInput placeholder shows placeholder");

		// act
		this.multiInput1.addToken(new sap.m.Token({text: "Token2"}));

		sap.ui.getCore().applyChanges();

		// assert
		assert.ok(this.multiInput1.$().hasClass("sapMMultiInputNoPlaceholder"), "MultiInput placeholder doesn't show placeholder");
	});

	QUnit.module("Copy/Cut Functionality", {
		beforeEach: function() {
			this.multiInput1 = new sap.m.MultiInput();
			this.multiInput1.placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();
		},
		afterEach: function() {
			this.multiInput1.destroy();
		}
	});

	QUnit.test("Cut", function(assert) {
		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "_cut");

		this.multiInput1.addToken(new sap.m.Token({text: "Token1"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Token2"}));

		this.multiInput1.getTokens()[0].setSelected(true);
		this.multiInput1.getTokens()[0].focus();


		sap.ui.getCore().applyChanges();

		sap.ui.test.qunit.triggerEvent("keydown", this.multiInput1.getFocusDomRef(), {
			which: jQuery.sap.KeyCodes.X,
			ctrlKey: true
		});

		// assert
		assert.ok(oSpy.called, "Tokenizer's cut method is called");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("Copy", function(assert) {
		var oSpy = sinon.spy(sap.m.Tokenizer.prototype, "_copy");

		this.multiInput1.addToken(new sap.m.Token({text: "Token1"}));
		this.multiInput1.addToken(new sap.m.Token({text: "Token2"}));

		this.multiInput1.getTokens()[0].setSelected(true);

		sap.ui.getCore().applyChanges();

		sap.ui.test.qunit.triggerEvent("keydown", this.multiInput1.getFocusDomRef(), {
			which: jQuery.sap.KeyCodes.C,
			ctrlKey: true
		});

		// assert
		assert.ok(oSpy.called, "Tokenizer's copy method is called");

		// cleanup
		oSpy.restore();
	});

	QUnit.test("_convertTextToToken", function(assert) {
		this.multiInput1.addValidator(function(args){
			return new sap.m.Token({text: args.text});
		});

		sap.ui.getCore().applyChanges();

		var result = this.multiInput1._convertTextToToken("  token");

		// assert
		assert.strictEqual(result.getText(), "token", "then the return value is correct");
	});

</script>

</head>
<body>
	<h1 id="qunit-header">QUnit page for sap.m.MultiInput</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<div id="qunit-fixture">test markup, will be hidden</div>
	<ol id="qunit-tests"></ol>
	<div id="content"></div>
</body>
</html>
