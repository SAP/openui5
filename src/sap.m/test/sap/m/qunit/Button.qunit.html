<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Test Page for sap.m.Button</title>
<script src="../shared-config.js"></script>
<script id="sap-ui-bootstrap" data-sap-ui-noConflict="true" data-sap-ui-language="en"
	data-sap-ui-libs="sap.m" src="../../../../resources/sap-ui-core.js">
</script>

<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script src="../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<style type="text/css">
.ButtonSpace {
	margin-top: 10px;
}
</style>

<script>
	sinon.config.useFakeTimers = true;
	var b1, b2, b4, b5, b6, b7, b8, b9, b10, msg;

	var sText = "Button Text",
		sButtonTypeDefault = sap.m.ButtonType.Default,
		sButtonTypeBack = sap.m.ButtonType.Back,
		sButtonTypeAccept = sap.m.ButtonType.Accept,
		sButtonTypeReject = sap.m.ButtonType.Reject,
		sButtonTypeTransparent = sap.m.ButtonType.Transparent,
		sButtonTypeUp = sap.m.ButtonType.Up,
		sButtonTypeUnstyled = sap.m.ButtonType.Unstyled,
		sWidth = "200px",
		bEnabled = true,
		bDisabled = false,
		sIcon = "../images/analytics_64.png",
		sPressMessage = "Button Tapped Event!";

	function tabEventHandler1() {
		throw sPressMessage + " - Exception"
	}

	function tabEventHandler2() {
		msg = sPressMessage
	}

	// Default Button
	var oBtnDefault = new sap.m.Button("b1");
	oBtnDefault.setText(sText);
	oBtnDefault.setType(sButtonTypeDefault);
	oBtnDefault.setEnabled(bEnabled);
	oBtnDefault.attachPress(tabEventHandler1);
	oBtnDefault.placeAt("contentBtnDefault");

	// Back Button
	var oBtnBack = new sap.m.Button("b2");
	oBtnBack.setText("Back Button");
	oBtnBack.setType(sButtonTypeBack);
	oBtnBack.setEnabled(bEnabled);
	oBtnBack.attachPress(tabEventHandler2);
	oBtnBack.placeAt("contentBtnBack");

	// Accept Button
	var oBtnAccept = new sap.m.Button("b4");
	oBtnAccept.setText("Accept Button");
	oBtnAccept.setType(sButtonTypeAccept);
	oBtnAccept.setEnabled(bEnabled);
	oBtnAccept.attachPress(tabEventHandler2);
	oBtnAccept.placeAt("contentBtnAccept");

	// Reject Button
	var oBtnReject = new sap.m.Button("b5");
	oBtnReject.setText("Reject Button");
	oBtnReject.setType(sButtonTypeReject);
	oBtnReject.setEnabled(bEnabled);
	oBtnReject.attachPress(tabEventHandler2);
	oBtnReject.placeAt("contentBtnReject");

	// Transparent Button
	var oBtnTransparent = new sap.m.Button("b6");
	oBtnTransparent.setText("Transparent Button");
	oBtnTransparent.setType(sButtonTypeTransparent);
	oBtnTransparent.setEnabled(bEnabled);
	oBtnTransparent.attachPress(tabEventHandler2);
	oBtnTransparent.placeAt("contentBtnTransparent");

	// Button Width
	var oBtnWidth = new sap.m.Button("b7");
	oBtnWidth.setText("Button with 200 pixel");
	oBtnWidth.setType(sButtonTypeDefault);
	oBtnWidth.setEnabled(bEnabled);
	oBtnWidth.setWidth(sWidth);
	oBtnWidth.attachPress(tabEventHandler2);
	oBtnWidth.placeAt("contentBtnWidth");

	// Disabled Button
	var oBtnDisabled = new sap.m.Button("b8");
	oBtnDisabled.setText("Disabled Button");
	oBtnDisabled.setType(sButtonTypeDefault);
	oBtnDisabled.setEnabled(bDisabled);
	oBtnDisabled.setWidth(sWidth);
	oBtnDisabled.attachPress(tabEventHandler2);
	oBtnDisabled.placeAt("contentBtnDisabled");

	// Icon Button
	var oBtnIcon = new sap.m.Button("b9");
	oBtnIcon.setText("Icon Button");
	oBtnIcon.setType(sButtonTypeDefault);
	oBtnIcon.setEnabled(bEnabled);
	oBtnIcon.setIcon(sIcon);
	oBtnIcon.attachPress(tabEventHandler2);
	oBtnIcon.placeAt("contentBtnIcon");

	// Up Button
	var oBtnUp = new sap.m.Button("b10");
	oBtnUp.setText("Up Button");
	oBtnUp.setType(sButtonTypeUp);
	oBtnUp.setEnabled(bEnabled);
	oBtnUp.attachPress(tabEventHandler2);
	oBtnUp.placeAt("contentBtnUp");

	// Unstyled Button
	var oBtnUp = new sap.m.Button("b11");
	oBtnUp.setText("Unstyled Button");
	oBtnUp.setType(sButtonTypeUnstyled);
	oBtnUp.setEnabled(bEnabled);
	oBtnUp.attachPress(tabEventHandler2);
	oBtnUp.placeAt("contentBtnUnstyled");

	// Invisible Button
	var oBtnUp = new sap.m.Button("b12");
	oBtnUp.setText("Invisible Button");
	oBtnUp.setVisible(false);
	oBtnUp.placeAt("contentBtnInvisible");

	// RTL Button
	var oBtnRtl = new sap.m.Button("b13");
	oBtnRtl.setText("Button TextDirection RTL");
	oBtnRtl.setIcon(sap.ui.core.IconPool.getIconURI("employee"));
	oBtnRtl.setTextDirection(sap.ui.core.TextDirection.RTL);
	oBtnRtl.placeAt("contentBtnTextDirectionRTL");

	// LTR Button
	var oBtnLtr = new sap.m.Button("b14");
	oBtnLtr.setText("Button TextDirection LTR");
	oBtnLtr.setIcon(sap.ui.core.IconPool.getIconURI("employee"));
	oBtnLtr.setTextDirection(sap.ui.core.TextDirection.LTR);
	oBtnLtr.placeAt("contentBtnTextDirectionLTR");

	qutils.delayTestStart();

	QUnit.module("Basic", {
		beforeEach : function() {
			b1 = sap.ui.getCore().byId("b1");
			b2 = sap.ui.getCore().byId("b2");
			b4 = sap.ui.getCore().byId("b4");
			b5 = sap.ui.getCore().byId("b5");
			b6 = sap.ui.getCore().byId("b6");
			b7 = sap.ui.getCore().byId("b7");
			b8 = sap.ui.getCore().byId("b8");
			b9 = sap.ui.getCore().byId("b9");
			b10 = sap.ui.getCore().byId("b10");
			b11 = sap.ui.getCore().byId("b11");
			b12 = sap.ui.getCore().byId("b12");
			b13 = sap.ui.getCore().byId("b13");
			b14 = sap.ui.getCore().byId("b14");
		},
		afterEach : function() {
			b1 = null;
			b2 = null;
			b4 = null;
			b5 = null;
			b6 = null;
			b7 = null;
			b8 = null;
			b9 = null;
			b10 = null;
			b11 = null;
			b12 = null;
			b13 = null;
			b14 = null;
		}
	});


	// test property accessor methods
	QUnit.test("TextOk", function(assert) {
		assert.equal(b1.getText(), sText, "Text - button1 is correct using 'equals()'!");
	});

	QUnit.test("TypeOk", function(assert) {
		assert.equal(b1.getType(), sButtonTypeDefault, "Button Type: Default - button1 is correct using 'equals()'!");
		assert.equal(b2.getType(), sButtonTypeBack, "Button Type: Back - button2 is correct using 'equals()'!");
		assert.equal(b4.getType(), sButtonTypeAccept, "Button Type: Accept - button4 is correct using 'equals()'!");
		assert.equal(b5.getType(), sButtonTypeReject, "Button Type: Reject - button5 is correct using 'equals()'!");
		assert.equal(b6.getType(), sButtonTypeTransparent, "Button Type: Transparent - button6 is correct using 'equals()'!");
		assert.equal(b10.getType(), sButtonTypeUp, "Button Type: Up - button10 is correct using 'equals()'!");
		assert.equal(b11.getType(), sButtonTypeUnstyled, "Button Type: Uunstyle - button11 is correct using 'equals()'!");
	});

	QUnit.test("ButtonEnabledOk", function(assert) {
		assert.equal(b1.getEnabled(), bEnabled, "Button is enabled - button1 is correct using 'equals()'!");
		assert.equal(b2.getEnabled(), bEnabled, "Button is enabled - button2 is correct using 'equals()'!");
		assert.equal(b4.getEnabled(), bEnabled, "Button is enabled - button4 is correct using 'equals()'!");
		assert.equal(b5.getEnabled(), bEnabled, "Button is enabled - button5 is correct using 'equals()'!");
		assert.equal(b6.getEnabled(), bEnabled, "Button is enabled - button6 is correct using 'equals()'!");
		assert.equal(b7.getEnabled(), bEnabled, "Button is enabled - button7 is correct using 'equals()'!");
		assert.equal(b8.getEnabled(), bDisabled, "Button is disabled - button8 is correct using 'equals()'!");
		assert.equal(b9.getEnabled(), bEnabled, "Button is enabled - button9 is correct using 'equals()'!");
		assert.equal(b10.getEnabled(), bEnabled, "Button is enabled - button10 is correct using 'equals()'!");
	});

	QUnit.test("ButtonWidthOk", function(assert) {
		assert.equal(b7.getWidth(), sWidth, "Button width - button7 is correct using 'equals()'!");
	});

	QUnit.test("IconOk", function(assert) {
		assert.equal(b9.getIcon(), sIcon, "Icon for button9 is correct using 'equals()'!");
	});

	QUnit.test("TextDirectionRtlOk", function(assert) {
		var $btnText = jQuery(b13.getDomRef()).find('.sapMBtnContent');
		assert.equal($btnText.attr("dir"), "rtl", "Control text has 'dir' property set to right-to-left");
		var $btnBDITag = document.getElementById('b13-content').firstChild.nodeName.toLowerCase() === "bdi";
		assert.ok(!$btnBDITag, "Control doesn't have bidi tag set when it has explicitly set direction");
	});

	QUnit.test("TextDirectionLtrOk", function(assert) {
		var $btnText = jQuery(b14.getDomRef()).find('.sapMBtnContent');
		assert.equal($btnText.attr("dir"), "ltr", "Control text has 'dir' property set to left-to-right");
		var $btnBDITag = document.getElementById('b14-content').firstChild.nodeName.toLowerCase() === "bdi";
		assert.ok(!$btnBDITag, "Control doesn't have bidi tag set when it has explicitly set direction");
	});

	QUnit.test("BDI set when no textdirection is given explicitly", function(assert) {
		var bIE_Edge = sap.ui.Device.browser.internet_explorer || sap.ui.Device.browser.edge;
		var $btnBDITag = document.getElementById('b1-content').firstChild.nodeName;
		if (!bIE_Edge) {
			assert.equal($btnBDITag.toLowerCase(), "bdi", "Control has bidi tag set");
		} else {
			assert.ok(!($btnBDITag.toLowerCase() == "bdi"), "Control doesn't have bidi tag set when the browser is IE or Edge, since it's not supported");
		}
	});

	QUnit.test("PressOk", function(assert) {
		try {
			b1.firePress();
			assert.ok(false,"Exception should have been thrown!");
		} catch (e) {
			assert.ok(e == sPressMessage + " - Exception","Button1 - Exception was thrown correctly!");
			assert.equal(e,sPressMessage + " - Exception","Button1 - Exception was thrown correctly!")
		}
		b2.firePress();
		assert.ok(msg == sPressMessage, "Button2 - Event was fired correctly!");
		assert.equal(msg, sPressMessage, "Button2 - Event was fired correctly!!");
		b4.firePress();
		assert.ok(msg == sPressMessage, "Button4 - Event was fired correctly!");
		assert.equal(msg, sPressMessage, "Button4 - Event was fired correctly!!");
		b5.firePress();
		assert.ok(msg == sPressMessage, "Button5 - Event was fired correctly!");
		assert.equal(msg, sPressMessage, "Button5 - Event was fired correctly!!");
		b6.firePress();
		assert.ok(msg == sPressMessage, "Button6 - Event was fired correctly!");
		assert.equal(msg, sPressMessage, "Button6 - Event was fired correctly!!");
		b7.firePress();
		assert.ok(msg == sPressMessage, "Button7 - Event was fired correctly!");
		assert.equal(msg, sPressMessage, "Button7 - Event was fired correctly!!");
	});

	QUnit.test("Visibility", function(assert) {
		assert.ok(!jQuery.sap.domById("b12"), "Button12 should not be rendered");
	});

	function hoverableTestCase (oTestDescription) {
		this.stub(sap.ui.Device, "system", { desktop : oTestDescription.desktop });

		// System under Test
		var oButton = new sap.m.Button({
			enabled : oTestDescription.enabled
		});
		oButton.placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();

		// Act
		var bHoverable = oButton._isHoverable();

		// Assert
		assert.strictEqual(bHoverable, oTestDescription.shouldBeHoverable, "The button determined wether is should be hoverable");
		assert.strictEqual(oButton.$("inner").hasClass("sapMBtnHoverable"), oTestDescription.shouldHaveCssClass, "The button determined wether is should be hoverable");
	}

	QUnit.test("Should be hoverable if the button is enabled and in desktop", function(assert) {
		hoverableTestCase.call(this, {
			enabled : true,
			desktop : true,
			shouldBeHoverable : true,
			shouldHaveCssClass : true
		});
	});

	QUnit.test("Should not be hoverable if the button is disabled and in desktop", function(assert) {
		hoverableTestCase.call(this, {
			enabled : false,
			desktop : true,
			shouldBeHoverable : false,
			shouldHaveCssClass : false
		});
	});

	QUnit.test("Should not be hoverable if the button is enabled and not desktop", function(assert) {
		hoverableTestCase.call(this, {
			enabled : true,
			desktop : false,
			shouldBeHoverable : false,
			shouldHaveCssClass : false
		});
	});

	QUnit.test("Should not be hoverable if the button is disabled and not desktop", function(assert) {
		hoverableTestCase.call(this, {
			enabled : false,
			desktop : false,
			shouldBeHoverable : false,
			shouldHaveCssClass : false
		});
	});

	QUnit.test("Should not re-render the button if the text is changed", function(assert) {
		// Arrange
		var sTextToSet = "<script>alert(\"HAACKED\");<\/script>",
			oRenderSpy,
			oResult,
			oConstructor = { text : "No empty text"};

		// System under Test
		var oButton = new sap.m.Button(oConstructor).placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();

		oRenderSpy = this.spy(oButton, "invalidate");

		// Act
		oResult = oButton.setText(sTextToSet);
		sap.ui.getCore().applyChanges();

		// Assert
		assert.strictEqual(oResult, oButton, "Should be able to chain");
		assert.strictEqual(oRenderSpy.callCount, 0, "Did not re-render");
		assert.ok(!/.*<script>.*/.test(oButton.$("content").html()), "Did not contain a unescaped script tag");
		assert.strictEqual(oButton.getText(), sTextToSet, "Did set the non encoded string as value");

		// Cleanup
		oButton.destroy();
	});


	QUnit.test("Tap event should not be fired when the button is set to invisible", function(assert) {
		// Arrange
		var oRenderSpy,
			oConstructor = { visible : false };

		// System under Test
		var oButton = new sap.m.Button(oConstructor).placeAt("qunit-fixture");

		oRenderSpy = this.spy(oButton, "fireTap");

		// Act
		oButton.ontap({ setMarked:  jQuery.noop });

		// Assert
		assert.strictEqual(oRenderSpy.callCount, 0, "Tap event not fired");

		// Cleanup
		oButton.destroy();
	});

	QUnit.test("For safari the button should gain explicitly focus on touch start", function(assert) {
		// Arrange
		// stub the browser to be only safari
		this.stub(sap.ui.Device, "browser", {
			safari: true
		});

		var oButton = new sap.m.Button({text: "MyText", icon: "sap-icon://search"}).placeAt("qunit-fixture");
		oRenderSpy = this.spy(oButton, "focus");
		sap.ui.getCore().applyChanges();

		// Act
		oButton.ontouchstart({ setMarked: jQuery.noop, preventDefault: jQuery.noop, targetTouches: { length: 1 }, originalEvent: { type: "mousedown" }});
		this.clock.tick(1000);

		// Assert
		assert.strictEqual(oRenderSpy.callCount, 1, "The button is focused on touch start");

		// Cleanup
		oButton.destroy();
	});


	QUnit.test("Check type conversation if text property is changed (non-string value)", function(assert) {
		// Arrange
		var oRenderSpy,
			oConstructor = { text : "Check type conversation (text)", enabled : true};

		// System under Test
		var oButton = new sap.m.Button(oConstructor).placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();

		oRenderSpy = this.spy(oButton, "invalidate");

		// Act
		oButton.setText(2);
		sap.ui.getCore().applyChanges();

		// Assert
		assert.strictEqual(oRenderSpy.callCount, 0, "No conversation error");

		// Cleanup
		oButton.destroy();
	});


	QUnit.test("Should not re-render the button if icon property is changed", function(assert) {
		// Arrange
		var oRenderSpy,
			oConstructor = { text : "Re-render Check (icon)", enabled : true, icon : sap.ui.core.IconPool.getIconURI("employee") , iconFirst : true};

		// System under Test
		var oButton = new sap.m.Button(oConstructor).placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();

		oRenderSpy = this.spy(oButton, "invalidate");

		// Act
		oButton.setIcon(sap.ui.core.IconPool.getIconURI("notes"));
		sap.ui.getCore().applyChanges();

		// Assert
		assert.strictEqual(oRenderSpy.callCount, 0, "Did not rerender");

		// Cleanup
		oButton.destroy();
	});


	QUnit.test("Tooltip is recognized", function(assert) {

		// Arrange
		var oButton = new sap.m.Button({text: "MyText",
			icon: "sap-icon://search"});

		assert.strictEqual(oButton._getTooltip(), undefined, "Should not return tooltip");

		// Act
		oButton.setTooltip("MyTooltip");

		// Assert
		assert.strictEqual(oButton._getTooltip(), "MyTooltip", "Should return the tooltip");

		// Cleanup
		oButton.destroy();
	});


	QUnit.test("Tooltip is derived for icon-only buttons", function(assert) {

		// Arrange
		var oButton = new sap.m.Button({tooltip: "MyTooltip",
			icon: "sap-icon://search"});

		assert.strictEqual(oButton._getTooltip(), "MyTooltip", "Should return the primary tooltip");

		// Act
		oButton.setTooltip(null);

		// Assert
		assert.strictEqual(oButton._getTooltip(), "Search", "Should return the derived tooltip");

		// Cleanup
		oButton.destroy();
	});


	QUnit.test("getAccessibilityInfo", function(assert) {
		var oButton = new sap.m.Button({tooltip: "Tooltip"});
		assert.ok(!!oButton.getAccessibilityInfo, "Button has a getAccessibilityInfo function");
		var oInfo = oButton.getAccessibilityInfo();
		assert.ok(!!oInfo, "getAccessibilityInfo returns a info object");
		assert.strictEqual(oInfo.role, "button", "AriaRole");
		assert.strictEqual(oInfo.type, sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_BUTTON"), "Type");
		assert.strictEqual(oInfo.description, "Tooltip", "Description");
		assert.strictEqual(oInfo.focusable, true, "Focusable");
		assert.strictEqual(oInfo.enabled, true, "Enabled");
		assert.ok(oInfo.editable === undefined || oInfo.editable === null, "Editable");
		oButton.setText("Text");
		oButton.setEnabled(false);
		oInfo = oButton.getAccessibilityInfo();
		assert.strictEqual(oInfo.description, "Text", "Description");
		assert.strictEqual(oInfo.focusable, false, "Focusable");
		assert.strictEqual(oInfo.enabled, false, "Enabled");
		oButton.setText(null);
		oButton.setTooltip(null);
		oButton.setIcon("sap-icon://search");
		oInfo = oButton.getAccessibilityInfo();
		assert.strictEqual(oInfo.description, "Search", "Description");
		oButton.destroy();
	});

	QUnit.test("AriaLabeledBy when the Button is associated with Label", function(assert) {
		var oLabel = new sap.m.Label("L1", {
			text:'Label'
		});
		var oButton = new sap.m.Button("B1",{
			text:'Hello World',
			ariaLabelledBy: "L1"
		});

		oLabel.placeAt("qunit-fixture");
		oButton.placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();

		assert.equal(oButton.$().attr("aria-labelledby"), "L1 B1", "Label id and Button id are written inside aria-labelledby attribute");

		oLabel.destroy();
		oButton.destroy();
	});

	QUnit.test("_activeButton _inactiveButton", function(assert) {
		//sut
		var sIconURI = 'sap-icon://slim-arrow-down',
			sActiveIconURI = 'sap-icon://slim-arrow-up',
			oButton = new sap.m.Button({
				icon: sIconURI,
				activeIcon: sActiveIconURI
			});

		oButton.placeAt("qunit-fixture");
		sap.ui.getCore().applyChanges();

		//act
		oButton._activeButton();

		//assert
		assert.ok(oButton.$("inner").hasClass("sapMBtnActive"), 'button is styled as active');
		assert.equal(oButton._image.getSrc(), sActiveIconURI);

		//act
		oButton._inactiveButton();

		//assert
		assert.ok(!oButton.$("inner").hasClass("sapMBtnActive"), 'button is styled as inactive');
		assert.equal(oButton._image.getSrc(), sIconURI);

		//clean
		oButton.destroy();
	});

	QUnit.test("tabindex", function(assert) {
		assert.equal(b1.$().attr("tabindex"), undefined, "By default the button(root) should have no tabindex");
		assert.equal(b1.$("inner").attr("tabindex"), undefined, "By default the button(inner) should have no tabindex");

		//Act
		b1._bExcludeFromTabChain = true;

		b1.invalidate();
		sap.ui.getCore().applyChanges();

		//Assert
		assert.equal(b1.$().attr("tabindex"), "-1", "Button(root) should have negative tabindex when requested via _bExcludeFromTabChain");
		assert.equal(b1.$("inner").attr("tabindex"), "-1", "Button(inner) should have negative tabindex when requested via _bExcludeFromTabChain");
	});



</script>

</head>
<body>
	<h1 id="qunit-header">QUnit page for sap.m.Button</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<div id="qunit-fixture">test markup, will be hidden</div>
	<ol id="qunit-tests"></ol>
	<div id="contentBtnDefault" class="ButtonSpace"></div>
	<div id="contentBtnBack" class="ButtonSpace"></div>
	<div id="contentBtnAccept" class="ButtonSpace"></div>
	<div id="contentBtnReject" class="ButtonSpace"></div>
	<div id="contentBtnTransparent" class="ButtonSpace"></div>
	<div id="contentBtnWidth" class="ButtonSpace"></div>
	<div id="contentBtnDisabled" class="ButtonSpace"></div>
	<div id="contentBtnIcon" class="ButtonSpace"></div>
	<div id="contentBtnUp" class="ButtonSpace"></div>
	<div id="contentBtnUnstyled" class="ButtonSpace"></div>
	<div id="contentBtnInvisible" class="ButtonSpace"></div>
	<div id="contentBtnTextDirectionRTL" class="ButtonSpace"></div>
	<div id="contentBtnTextDirectionLTR" class="ButtonSpace"></div>
</body>
</html>
