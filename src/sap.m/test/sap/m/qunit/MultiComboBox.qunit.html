<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="UTF-8">
<title>Test Page for sap.m.MultiComboBox</title>
<script id="sap-ui-bootstrap" data-sap-ui-theme="sap_bluecrystal"
	data-sap-ui-noConflict="true" data-sap-ui-libs="sap.m"
	src="../../../../resources/sap-ui-core.js">
	
</script>
<link rel="stylesheet"
	href="../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- use the sinon faketimers for this test -->
<script type="text/javascript">
	sinon.config.useFakeTimers = true;
</script>

<script>
	QUnit.config.autostart = false;
	sap.ui.test.qunit.delayTestStart();

	// =========================================================== //
	// Check UX requirements on                                    //
	// =========================================================== //

	// =========================================================== //
	// API module                                                  //
	// =========================================================== //

	module("API");

	// ------------------------------ //
	// tests for default values       //
	// ------------------------------ //    
	test("constructor - items : []", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : []
		});

		// arrange
		//oMultiComboBox.placeAt("MultiComboBox-content");
		//sap.ui.getCore().applyChanges();

		// assertions
		strictEqual(oMultiComboBox.getName(), "", 'Default name is ""');
		strictEqual(oMultiComboBox.getVisible(), true, "By default the MultiComboBox control is visible");
		strictEqual(oMultiComboBox.getEnabled(), true, "By default the MultiComboBox control is enabled");
		strictEqual(oMultiComboBox.getWidth(), "100%", 'By default the "width" of the MultiComboBox control is ""');
		strictEqual(oMultiComboBox.getValue(), "", 'By default the "value" of the MultiComboBox control is ""');
		strictEqual(oMultiComboBox.getMaxWidth(), "100%",
				'By default the "max-width" of the MultiComboBox control is "100%"');
		deepEqual(oMultiComboBox.getSelectedItems(), [],
				"By default the selected items of the MultiComboBox control is null");
		deepEqual(oMultiComboBox.getSelectedKeys(), [], 'By default the selected keys of the MultiComboBox control is ""');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - items : [aItems]", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				id : "item00000",
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				id : "my-custom-item11111",
				key : "1",
				text : "item 1",
				enabled : false
			}),

			new sap.ui.core.Item({
				id : "item11111",
				key : "2",
				text : "item 2"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		sap.ui.getCore().applyChanges();

		// assertions
		strictEqual(oMultiComboBox.getName(), "", 'Default name is ""');
		strictEqual(oMultiComboBox.getVisible(), true, "By default the MultiComboBox control is visible");
		strictEqual(oMultiComboBox.getEnabled(), true, "By default the MultiComboBox control is enabled");
		strictEqual(oMultiComboBox.getWidth(), "100%", 'By default the "width" of the MultiComboBox control is ""');
		strictEqual(oMultiComboBox.getValue(), "", 'By default the "value" of the MultiComboBox control is ""');
		strictEqual(oMultiComboBox.getMaxWidth(), "100%",
				'By default the "max-width" of the MultiComboBox control is "100%"');
		deepEqual(oMultiComboBox.getSelectedItems(), [],
				"By default the selected items of the MultiComboBox control is null");
		deepEqual(oMultiComboBox.getSelectedKeys(), [], 'By default the selected keys of the MultiComboBox control is ""');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - selectedItems : [Item]", function() {

		// system under test
		var oItem = new sap.ui.core.Item({
			key : "0",
			text : "item 0"
		});
		var oMultiComboBox = new sap.m.MultiComboBox({
			selectedItems : [oItem]
		});

		// assertions
		strictEqual(oMultiComboBox.getName(), "", 'Default name is ""');
		strictEqual(oMultiComboBox.getVisible(), true, "By default the MultiComboBox control is visible");
		strictEqual(oMultiComboBox.getEnabled(), true, "By default the MultiComboBox control is enabled");
		strictEqual(oMultiComboBox.getWidth(), "100%", 'By default the "width" of the MultiComboBox control is ""');
		strictEqual(oMultiComboBox.getValue(), "", 'By default the "value" of the MultiComboBox control is ""');
		strictEqual(oMultiComboBox.getMaxWidth(), "100%",
				'By default the "max-width" of the MultiComboBox control is "100%"');
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem],
				"By default the selected items of the MultiComboBox control is null");
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()],
				'By default the selected keys of the MultiComboBox control is ""');

		// cleanup
		oMultiComboBox.destroy();
	});
	test("constructor - items : [Item], selectedItems : [Item]", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			})],

			selectedItems : [oItem]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - selectedItems : [Id], items : [Item]", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			selectedItems : ["item00000"],
			items : [oItem = new sap.ui.core.Item({
				id : "item00000",
				key : "0",
				text : "item 0"
			})]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - selectedItems without keys: [Item1, Item2], selectedItems : [Item1, Item2]", function() {

		// system under test
		var oItem1, oItem2;
		var oMultiComboBox = new sap.m.MultiComboBox({
			selectedItems : [oItem1 = new sap.ui.core.Item({
				text : "item 1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item 2"
			})],
			items : [oItem1, oItem2]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem1, oItem2]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["", ""]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - selectedItems : [Item], items : [Item], setSelectedKey programatically - check fired events",
			function() {

				// system under test
				var oItem;
				var oMultiComboBox = new sap.m.MultiComboBox({
					selectedItems : ["item00000"],
					items : [oItem = new sap.ui.core.Item({
						id : "item00000",
						key : "0",
						text : "item 0"
					})]
				});
				var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
				var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

				// act
				oMultiComboBox.setSelectedKeys(["0"]);

				// assertions
				strictEqual(fnFireSelectionChangeSpy.callCount, 0, "The selection change event was not fired");
				strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was not fired");
				deepEqual(oMultiComboBox.getSelectedKeys(), ["0"]);
				deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);

				// cleanup
				oMultiComboBox.destroy();
			});

	test("constructor - selectedItems : [Item], items : [Item], removeSelectedKey programatically - check fired events",
			function() {

				// system under test
				var oItem;
				var oMultiComboBox = new sap.m.MultiComboBox({
					selectedItems : ["item00000"],
					items : [oItem = new sap.ui.core.Item({
						id : "item00000",
						key : "0",
						text : "item 0"
					})]
				});

				var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
				var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

				// act				
				oMultiComboBox.removeSelectedKeys(["0"]);

				// assertions
				strictEqual(fnFireSelectionChangeSpy.callCount, 0, "The change event was not fired");
				strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was not fired");
				deepEqual(oMultiComboBox.getSelectedKeys(), []);
				deepEqual(oMultiComboBox.getSelectedItems(), []);

				// cleanup
				oMultiComboBox.destroy();
			});

	test("constructor - selectedItems : [Item], items : [Item], removeSelectedKey via UI - check fired events",
			function() {

				// system under test
				var oModel = new sap.ui.model.json.JSONModel({
					"items" : [{
						"key" : "AL",
						"text" : "Algeria"
					}, {
						"key" : "AR",
						"text" : "Argentina"
					}, {
						"key" : "BH",
						"text" : "Bahrain"
					}]
				});
				var oMultiComboBox = new sap.m.MultiComboBox({
					items : {
						path : "/items",
						template : new sap.ui.core.Item({
							key : "{key}",
							text : "{text}"
						})
					}
				});
				oMultiComboBox.setModel(oModel);

				// arrange
				oMultiComboBox.placeAt("MultiComboBox-content");
				sap.ui.getCore().applyChanges();

				var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");

				// act
				sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), "Algeria");
				sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

				// assertions
				strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
				strictEqual(fnFireSelectionChangeSpy.args[0][0].changedItem, oMultiComboBox.getSelectedItems()[0],
						"The selection change event parameter was passed");

				// cleanup
				oMultiComboBox.destroy();
			});

	test("constructor, check selectedKeys - items:[Items]", function() {

		// system under test
		var oItem0, oItem1, oItem2;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [
			oItem0 = new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			oItem1 = new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			oItem2 = new sap.ui.core.Item({
				key : "2",
				text : "item 2"
			}),
			
			oItem3 = new sap.ui.core.Item({
				key : "",
				text : "item 3"
			})
			]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		oMultiComboBox.setSelectedKeys(["0"]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["0"]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0]);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), oMultiComboBox._getTokenByItem(oItem0));
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);

		oMultiComboBox.setSelectedKeys(["0", "1"]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["0", "1"]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0, oItem1]);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), oMultiComboBox._getTokenByItem(oItem0));
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), oMultiComboBox._getTokenByItem(oItem1));
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);

		oMultiComboBox.setSelectedKeys([null]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);

		oMultiComboBox.setSelectedKeys(["2", null, "1"]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["2", "1"]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem2, oItem1]);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), oMultiComboBox._getTokenByItem(oItem1));
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), oMultiComboBox._getTokenByItem(oItem2));

		oMultiComboBox.setSelectedKeys(["0"]);
		oMultiComboBox.setSelectedKeys(["dummy"]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["dummy"]);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);

		oMultiComboBox.setSelectedKeys(["0"]);
		oMultiComboBox.setSelectedKeys([""]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [""]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem3]);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);

		oMultiComboBox.setSelectedKeys(["0", "1"]);
		oMultiComboBox.removeSelectedKeys(["1"]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["0"]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0]);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), oMultiComboBox._getTokenByItem(oItem0));
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);

		oMultiComboBox.removeSelectedKeys(["dummy"]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["0"]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0]);
		deepEqual(oItem0.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), oMultiComboBox._getTokenByItem(oItem0));
		deepEqual(oItem1.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);
		deepEqual(oItem2.data(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Token"), null);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor, check selectedItems - items:[Items]", function() {

		// system under test
		var oItem0, oItem1, oItem2, oItemDummy = new sap.ui.core.Item({
			text : "dummy"
		});
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem0 = new sap.ui.core.Item({
				text : "item 0"
			}), oItem1 = new sap.ui.core.Item({
				text : "item 1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item 2"
			})]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		oMultiComboBox.setSelectedItems([oItem0]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [""]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0]);

		oMultiComboBox.setSelectedItems([oItem0, oItem1]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["", ""]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0, oItem1]);

		oMultiComboBox.setSelectedItems([null]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		oMultiComboBox.setSelectedItems([oItem2, null, oItem1]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["", ""]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem2, oItem1]);

		oMultiComboBox.setSelectedItems([oItem0]);
		oMultiComboBox.setSelectedItems([oItemDummy]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [""]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItemDummy]);

		oMultiComboBox.setSelectedItems([oItem0]);
		oMultiComboBox.setSelectedItems([""]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		oMultiComboBox.setSelectedItems([oItem0, oItem1]);
		oMultiComboBox.removeSelectedItem(oItem1);
		deepEqual(oMultiComboBox.getSelectedKeys(), [""]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0]);

		oMultiComboBox.removeSelectedKeys(["dummy"]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [""]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem0]);

		// cleanup
		oMultiComboBox.destroy();
	});

	// ------------------------------ //
	// xxxMaxWidth()                  //
	// ------------------------------ //

	test("method: xxxMaxWidth() - maxWidth", function() {

		// system under test              
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			})],
			maxWidth : "300px"
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// assertions
		strictEqual(oMultiComboBox.getMaxWidth(), "300px");
		strictEqual(oMultiComboBox.getDomRef().style.maxWidth, "300px");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: xxxMaxWidth() - maxWidth", function() {

		// system under test              
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act 
		oMultiComboBox.setMaxWidth("30%");
		sap.ui.getCore().applyChanges();

		// assertions
		strictEqual(oMultiComboBox.getMaxWidth(), "30%");
		strictEqual(oMultiComboBox.getDomRef().style.maxWidth, "30%");

		// cleanup
		oMultiComboBox.destroy();
	});

	// ------------------------------ //
	// getSelectedXXX()               //
	// ------------------------------ //

	test("method: getSelectedXXX() - items : [Item], selectedItems : [Item]", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			})],

			selectedItems : [oItem]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);

		// cleanup
		oMultiComboBox.destroy();
	});
	test("method: getSelectedXXX() - items : [Item], selectedItems : [Item] - setSelectedItems(DummyItem)", function() {

		// system under test
		var oItem, oItemDummy;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			})],
			selectedItems : [oItem]
		});
		oMultiComboBox.setSelectedItems([oItemDummy = new sap.ui.core.Item({
			key : "Dummy",
			text : "Dummy item 1"
		})]);

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItemDummy]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItemDummy.getKey()]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedXXX() - items : [Item], selectedItems : DummyId", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			})],

			selectedItems : "Dummy"
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});
	test("method: getSelectedXXX() - items : [Items], selectedItems : [Items]", function() {

		// system under test
		var oItem, oItem2;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			oItem2 = new sap.ui.core.Item({
				id : "myItem0",
				key : "2",
				text : "item 2"
			}),

			new sap.ui.core.Item({
				key : "3",
				text : "item 3"
			})],

			selectedItems : [oItem, oItem2]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem, oItem2]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey(), oItem2.getKey()]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedXXX() - selectedItems : Id, items : [Items]", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({

			selectedItems : "myItem2",

			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			oItem = new sap.ui.core.Item({
				id : "myItem2",
				key : "2",
				text : "item 2"
			}),

			new sap.ui.core.Item({
				key : "3",
				text : "item 3"
			})]
		});

		// arrange
		//oMultiComboBox.placeAt("MultiComboBox-content");
		//sap.ui.getCore().applyChanges();

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedXXX() - selectedItems : [dummy], items : [Items]", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({

			selectedItems : "dummy",

			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			oItem = new sap.ui.core.Item({
				id : "myItem2",
				key : "2",
				text : "item 2"
			}),

			new sap.ui.core.Item({
				key : "3",
				text : "item 3"
			})]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedXXX() - items : []", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : []
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedXXX() - items, selectedItems : null", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			new sap.ui.core.Item({
				key : "2",
				text : "item 2"
			})],

			selectedItems : null
		});

		// arrange
		//oMultiComboBox.placeAt("MultiComboBox-content");
		//sap.ui.getCore().applyChanges();

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test('method: getSelectedXXX() - items - addSelectedItem', function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			new sap.ui.core.Item({
				key : "2",
				text : "item 2"
			})]
		});
		oMultiComboBox.addSelectedItem(oItem);
		oMultiComboBox.addSelectedItem(oItem);

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);

		// cleanup
		oMultiComboBox.destroy();
	});

	// ------------------------------ //
	// addItem                        //
	// ------------------------------ //

	test("method: addItem() - with key and text", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnAddAggregationSpy = this.spy(oMultiComboBox, "addAggregation");
		var fnListAddAggregationSpy = this.spy(oMultiComboBox.getList(), "addAggregation");
		var fnAddItemSpy = this.spy(oMultiComboBox, "addItem");
		var oItem = new sap.ui.core.Item({
			key : "0",
			text : "item 0"
		});

		// act
		oMultiComboBox.addItem(oItem);

		// assertions
		ok(fnAddAggregationSpy.calledWith("items", oItem),
				"sap.m.MultiComboBox.addAggregation() method was called with the expected arguments");
		ok(fnListAddAggregationSpy.calledWith("items", oMultiComboBox.getListItem(oItem)),
				"sap.m.List.addAggregation() method was called with the expected arguments");
		ok(fnAddItemSpy.returned(oMultiComboBox));
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		equal(oMultiComboBox.getItems()[0].getKey(), "0", "key is not empty");
		equal(oMultiComboBox.getItems()[0].getText(), "item 0", "text is not empty");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: addItem() - with text", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnAddAggregationSpy = this.spy(oMultiComboBox, "addAggregation");
		var fnListAddAggregationSpy = this.spy(oMultiComboBox.getList(), "addAggregation");
		var fnAddItemSpy = this.spy(oMultiComboBox, "addItem");
		var oItem = new sap.ui.core.Item({
			text : "item 0"
		});

		// act
		oMultiComboBox.addItem(oItem);

		// assertions
		ok(fnAddAggregationSpy.calledWith("items", oItem),
				"sap.m.MultiComboBox.addAggregation() method was called with the expected arguments");
		ok(fnListAddAggregationSpy.calledWith("items", oMultiComboBox.getListItem(oItem)),
				"sap.m.List.addAggregation() method was called with the expected arguments");
		ok(fnAddItemSpy.returned(oMultiComboBox));
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		equal(oMultiComboBox.getItems()[0].getKey(), "", "key is empty");
		equal(oMultiComboBox.getItems()[0].getText(), "item 0", "text is not empty");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: addItem()", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnAddAggregationSpy = this.spy(oMultiComboBox, "addAggregation");
		var fnListAddAggregationSpy = this.spy(oMultiComboBox.getList(), "addAggregation");
		var fnAddItemSpy = this.spy(oMultiComboBox, "addItem");
		var oItem = new sap.ui.core.Item();

		// act
		oMultiComboBox.addItem(oItem);

		// assertions
		ok(fnAddAggregationSpy.calledWith("items", oItem),
				"sap.m.MultiComboBox.addAggregation() method was called with the expected arguments");
		ok(fnListAddAggregationSpy.calledWith("items", oMultiComboBox.getListItem(oItem)),
				"sap.m.List.addAggregation() method was called with the expected arguments");
		ok(fnAddItemSpy.returned(oMultiComboBox));
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		equal(oMultiComboBox.getItems()[0].getKey(), "", "key is empty");
		equal(oMultiComboBox.getItems()[0].getText(), "", "text is empty");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: addItem() - twice", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnAddAggregationSpy = this.spy(oMultiComboBox, "addAggregation");
		var fnListAddAggregationSpy = this.spy(oMultiComboBox.getList(), "addAggregation");
		var fnAddItemSpy = this.spy(oMultiComboBox, "addItem");
		var oItem = new sap.ui.core.Item({
			key : "0",
			text : "item 0"
		});

		// act
		oMultiComboBox.addItem(oItem);
		oMultiComboBox.addItem(oItem);

		// assertions
		ok(fnAddAggregationSpy.calledWith("items", oItem),
				"sap.m.MultiComboBox.addAggregation() method was called with the expected arguments");
		ok(fnListAddAggregationSpy.calledWith("items", oMultiComboBox.getListItem(oItem)),
				"sap.m.List.addAggregation() method was called with the expected arguments");
		ok(fnAddItemSpy.returned(oMultiComboBox));
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getItems(), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: addItem(null)", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnAddAggregationSpy = this.spy(oMultiComboBox, "addAggregation");
		var fnListAddAggregationSpy = this.spy(oMultiComboBox.getList(), "addAggregation");
		var fnAddItemSpy = this.spy(oMultiComboBox, "addItem");

		// act
		oMultiComboBox.addItem(null);

		// assertions
		ok(fnAddAggregationSpy.calledWith("items", null),
				"sap.m.MultiComboBox.addAggregation() method was called with the expected arguments");
		ok(fnListAddAggregationSpy.calledWith("items", null),
				"sap.m.List.addAggregation() method was called with the expected arguments");
		ok(fnAddItemSpy.returned(oMultiComboBox));
		deepEqual(oMultiComboBox.getAggregation("items"), null);
		deepEqual(oMultiComboBox.getItems(), []);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	// ------------------------------ //
	// removeXXX                      //
	// ------------------------------ //
	test("method: removeItem(oItem)", function() {

		// system under test
		var oItem, oItemRemoved;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oItemRemoved = oMultiComboBox.removeItem(oItem);

		// assertions
		strictEqual(oItemRemoved, oItem);
		deepEqual(oMultiComboBox.getAggregation("items"), []);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeItem(oItemDummy)", function() {

		// system under test
		var oItem, oItemRemoved, oItemDummy = new sap.ui.core.Item();
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oItemRemoved = oMultiComboBox.removeItem(oItemDummy);

		// assertions
		strictEqual(oItemRemoved, null);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), [oMultiComboBox._getTokenByItem(oItem)]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeItem(null)", function() {

		// system under test
		var oItem, oItemRemoved;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oItemRemoved = oMultiComboBox.removeItem(null);

		// assertions
		strictEqual(oItemRemoved, null);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), [oMultiComboBox._getTokenByItem(oItem)]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeAllItems()", function() {

		// system under test
		var oItem, aItems;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		aItems = oMultiComboBox.removeAllItems();

		// assertions
		deepEqual(aItems, [oItem]);
		deepEqual(oMultiComboBox.getAggregation("items"), []);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeSelectedItem(oItem)", function() {

		// system under test
		var oItem, oItemRemoved;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oItemRemoved = oMultiComboBox.removeSelectedItem(oItem);

		// assertions
		strictEqual(oItem, oItemRemoved);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeSelectedItem(oItemDummy)", function() {

		// system under test
		var oItem, oItemRemoved, oItemDummy = new sap.ui.core.Item();
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oItemRemoved = oMultiComboBox.removeSelectedItem(oItemDummy);

		// assertions
		strictEqual(oItemRemoved, null);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), [oMultiComboBox._getTokenByItem(oItem)]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeSelectedItem(null)", function() {

		// system under test
		var oItem, oItemRemoved;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oItemRemoved = oMultiComboBox.removeSelectedItem(null);

		// assertions
		strictEqual(oItemRemoved, null);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), [oMultiComboBox._getTokenByItem(oItem)]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeSelectedItem(oItem) with customer key", function() {

		// system under test
		var oItem, oItemRemoved;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedKeys : ["dummyKey"],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oItemRemoved = oMultiComboBox.removeSelectedItem(oItem);

		// assertions
		strictEqual(oItemRemoved, oItem);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["dummyKey"]);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeAllSelectedItems()", function() {

		// system under test
		var oItem, aIds;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		aIds = oMultiComboBox.removeAllSelectedItems();

		// assertions
		deepEqual(aIds, [oItem.getId()]);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: removeAllSelectedItems() with customer key", function() {

		// system under test
		var oItem, aIds;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedKeys : ["dummyKey"],
			selectedItems : [oItem]
		});

		// arrange

		// act
		aIds = oMultiComboBox.removeAllSelectedItems();

		// assertions
		deepEqual(aIds, [oItem.getId()]);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), ["dummyKey"]);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: clearSelection()", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oMultiComboBox.clearSelection();

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox.getAggregation("items"), [oItem]);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: destroyItems()", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item()],
			selectedItems : [oItem]
		});

		// arrange

		// act
		oMultiComboBox.destroyItems();

		// assertions
		deepEqual(oMultiComboBox.getItems(), []);
		deepEqual(oMultiComboBox.getAggregation("items"), []);
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		deepEqual(oMultiComboBox._oTokenizer.getTokens(), []);

		// cleanup
		oMultiComboBox.destroy();
	});
	
	// ------------------------------ //
	// insertItem                     //
	// ------------------------------ //

	test("method: insertItem()", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnInsertAggregation = this.spy(oMultiComboBox, "insertAggregation");
		var fnListInsertAggregation = this.spy(oMultiComboBox.getList(), "insertAggregation");
		var fnInsertItem = this.spy(oMultiComboBox, "insertItem");
		var oItem = new sap.ui.core.Item({
			key : "0",
			text : "item 0"
		});

		// act
		oMultiComboBox.insertItem(oItem, 0);

		// assertions
		ok(fnInsertAggregation.calledWith("items", oItem, 0),
				"oMultiComboBox.insertAggregation() method was called with the expected arguments");
		ok(fnListInsertAggregation.calledWith("items", oMultiComboBox.getListItem(oItem), 0),
				"oList.insertAggregation() method was called with the expected arguments");
		ok(fnInsertItem.returned(oMultiComboBox), 'oMultiComboBox.insertAggregation() method return the "this" reference');

		// cleanup
		oMultiComboBox.destroy();
	});

	//------------------------------ //
	// _isListInSuggestMode          //
	// ------------------------------ //

	test("method: _isListInSuggestMode - complete list", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is displayed');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("method: _isListInSuggestMode complete list with disabled item", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1",
				enabled : false
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is displayed');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("method: _isListInSuggestMode suggest list", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.getListItem(oMultiComboBox.getFirstItem()).setVisible(false);
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		ok(oMultiComboBox._isListInSuggestMode(), 'Suggest list is displayed');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("method: _isListInSuggestMode suggest list with disabled item", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2",
				enabled : false
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.getListItem(oMultiComboBox.getFirstItem()).setVisible(false);
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		ok(oMultiComboBox._isListInSuggestMode(), 'Suggest list is displayed');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	// ------------------------------ //
	// setSelectedItems()              //
	// ------------------------------ //

	test("method: setSelectedItems() - [null] : should give an warning when called with faulty parameter", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnSetPropertySpy = this.spy(oMultiComboBox, "setProperty");
		var fnSetAssociationSpy = this.spy(oMultiComboBox, "setAssociation");
		var fnErrorSpy = this.spy(jQuery.sap.log, "warning");
		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnSetSelectedItemsSpy = this.spy(oMultiComboBox, "setSelectedItems");

		// act
		oMultiComboBox.setSelectedItems([null]);

		// assertions
		strictEqual(fnErrorSpy.callCount, 1, "jQuery.sap.log.warning() method was called");
		strictEqual(fnSetPropertySpy.callCount, 0, "sap.m.MultiComboBox.prototype.setProperty() method was not called");
		strictEqual(fnSetAssociationSpy.callCount, 0,
				"sap.m.MultiComboBox.prototype.setAssociation() method was not called");
		strictEqual(fnFireChangeSpy.callCount, 0, "The change event was not fired");
		//strictEqual(oMultiComboBox.getSelectedItemId(), "");                           
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		ok(fnSetSelectedItemsSpy.returned(oMultiComboBox),
				'sap.m.MultiComboBox.prototype.setSelectedItems() method return the "this" reference');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: setSelectedItems() - [two items with same text] : should take over", function() {

		// system under test
		var oItem1, oItem2;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				key : "0",
				text : "same text"
			}),

			oItem2 = new sap.ui.core.Item({
				key : "1",
				text : "same item"
			}),

			new sap.ui.core.Item({
				key : "2",
				text : "item"
			})]
		});

		oMultiComboBox.setSelectedItems([oItem1, oItem2]);
		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// assertions
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem1, oItem2], "Should have both items");
		strictEqual(oMultiComboBox._oTokenizer.getTokens().length, 2, "should have two item");

		// cleanup
		oMultiComboBox.destroy();
	});
	test("method: setSelectedKeys() - {} : should give an warning when called with faulty parameter", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox();

		// arrange
		var fnSetPropertySpy = this.spy(oMultiComboBox, "setProperty");
		var fnSetAssociationSpy = this.spy(oMultiComboBox, "setAssociation");
		var fnErrorSpy = this.spy(jQuery.sap.log, "warning");
		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnSetSelectedKeysSpy = this.spy(oMultiComboBox, "setSelectedKeys");

		// act
		oMultiComboBox.setSelectedKeys([null]);

		// assertions
		strictEqual(fnSetPropertySpy.callCount, 0, "sap.m.MultiComboBox.prototype.setProperty() method was not called");
		strictEqual(fnSetAssociationSpy.callCount, 0,
				"sap.m.MultiComboBox.prototype.setAssociation() method was not called");
		strictEqual(fnFireChangeSpy.callCount, 0, "The change event was not fired");
		//strictEqual(oMultiComboBox.getSelectedItemId(), "");                           
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		ok(fnSetSelectedKeysSpy.returned(oMultiComboBox),
				'sap.m.MultiComboBox.prototype.setSelectedKeys() method return the "this" reference');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: setSelectedItems() - [oItem]", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			oItem = new sap.ui.core.Item({
				id : "myItem1",
				key : "1",
				text : "item 1"
			}),

			new sap.ui.core.Item({
				key : "2",
				text : "item 2",
				enabled : false
			})]
		});

		// arrange
		//var fnSetPropertySpy = this.spy(oMultiComboBox, "setProperty");
		var fnAddAssociationSpy = this.spy(oMultiComboBox, "addAssociation");
		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnSetSelectedItemsSpy = this.spy(oMultiComboBox, "setSelectedItems");

		// act
		oMultiComboBox.setSelectedItems([oItem]);

		// assertions
		//ok(fnSetPropertySpy.calledWith("selectedKeys", [ oItem.getKey() ], true));
		//ok(fnSetPropertySpy.calledWith("selectedItemId", "myItem1"));
		ok(fnAddAssociationSpy.calledWith("selectedItems", oItem));
		ok(fnSetSelectedItemsSpy.returned(oMultiComboBox),
				'sap.m.MultiComboBox.prototype.setSelectedItems() method return the "this" reference');

		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);

		strictEqual(fnFireChangeSpy.callCount, 0, "The change event was not fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: setSelectedItems() - [Id]", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			oItem = new sap.ui.core.Item({
				id : "myItem1-1",
				key : "1",
				text : "item 1"
			}),

			new sap.ui.core.Item({
				key : "2",
				text : "item 2",
				enabled : false
			})]
		});

		// arrange
		var fnAddAssociationSpy = this.spy(oMultiComboBox, "addAssociation");
		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnSetSelectedItemsSpy = this.spy(oMultiComboBox, "setSelectedItems");

		// act
		oMultiComboBox.setSelectedItems([oItem.getId()]);

		// assertions
		ok(fnAddAssociationSpy.calledWith("selectedItems", oItem));
		ok(fnSetSelectedItemsSpy.returned(oMultiComboBox),
				'sap.m.MultiComboBox.prototype.setSelectedItems() method return the "this" reference');

		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		strictEqual(fnFireChangeSpy.callCount, 0, "The change event was not fired");

		//sap.ui.getCore().applyChanges();
		//strictEqual(oMultiComboBox.getValue(), "item 1");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Firing event: setSelectedItems() set the selected item when the MultiComboBox popup menu is open", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			oItem = new sap.ui.core.Item({
				key : "2",
				text : "item 2"
			})]
		});

		// arrange
		oMultiComboBox.setSelectedKeys(["1"]);
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		oMultiComboBox.open();

		// act
		oMultiComboBox.setSelectedKeys([oItem.getKey()]);

		// assertion
		// 1. the popup should not be closed
		// 2. new selection should be took over
		deepEqual(oMultiComboBox.getSelectedKeys(), [oItem.getKey()]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedKeys()", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			})]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedKeys()", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			oItem = new sap.ui.core.Item({
				key : "2",
				text : "item 2"
			}),

			new sap.ui.core.Item({
				key : "3",
				text : "item 3"
			})],

			selectedItems : oItem.getId()
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), ["2"]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedKeys()", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			selectedItems : "myItem3",

			items : [new sap.ui.core.Item({
				key : "0",
				text : "item 0"
			}),

			new sap.ui.core.Item({
				key : "1",
				text : "item 1"
			}),

			new sap.ui.core.Item({
				key : "2",
				text : "item 2"
			}),

			new sap.ui.core.Item({
				id : "myItem3",
				key : "3",
				text : "item 3"
			})]
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), ["3"]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedKeys()", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : []
		});

		// assertions
		deepEqual(oMultiComboBox.getSelectedKeys(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("method: getSelectedKeys()", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "25",
				text : "item 25"
			}),

			new sap.ui.core.Item({
				key : "26",
				text : "item 26"
			}),

			new sap.ui.core.Item({
				key : "27",
				text : "item 27"
			})],

			selectedItems : null
		});

		// assertions        
		deepEqual(oMultiComboBox.getSelectedKeys(), []);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - items:[] selectedKeys[sKey]", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : []
		});
		oMultiComboBox.setSelectedKeys(["01"]);

		// assertions        
		deepEqual(oMultiComboBox.getSelectedKeys(), ["01"]);
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - items:[] selectedKeys[sKey] - addItem(oItem)", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : []
		});
		oMultiComboBox.setSelectedKeys(["01"]);

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.addItem(oItem = new sap.ui.core.Item({
			key : "01",
			text : "selected item"
		}));
		oMultiComboBox.addItem(new sap.ui.core.Item({
			key : "02",
			text : "item"
		}));
		sap.ui.getCore().applyChanges();

		// assertions        
		deepEqual(oMultiComboBox.getSelectedKeys(), ["01"]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);

		// cleanup 
		oMultiComboBox.destroy();
	});

	test("constructor - items:[] selectedItems[oItem] selectedKeys[sKey] - addItem(oItem)", function() {

		// system under test
		var oItem1, oItem2;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [],
			selectedItems : [oItem1 = new sap.ui.core.Item({
				key : "01",
				text : "selected item"
			})]
		});
		oMultiComboBox.addSelectedKeys(["02"]);

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.addItem(oItem1);
		oMultiComboBox.addItem(oItem2 = new sap.ui.core.Item({
			key : "02",
			text : "selected item"
		}));
		sap.ui.getCore().applyChanges();

		// assertions        
		deepEqual(oMultiComboBox.getSelectedKeys(), ["01", "02"]);
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem1, oItem2]);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("constructor - binding", function() {

		// system under test
		var oModel = new sap.ui.model.json.JSONModel({
			"selected" : ["AR", "BH"],
			"items" : [{
				"key" : "AL",
				"text" : "Algeria"
			}, {
				"key" : "AR",
				"text" : "Argentina"
			}, {
				"key" : "BH",
				"text" : "Bahrain"
			}]
		});
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : {
				path : "/items",
				template : new sap.ui.core.Item({
					key : "{key}",
					text : "{text}"
				})
			},
			selectedKeys : {
				path : "/selected"
			}
		});
		oMultiComboBox.setModel(oModel);

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), "Algeria");
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		// assertions        
		deepEqual(oModel.getData().selected, ["AR", "BH", "AL"]);

		// cleanup
		oMultiComboBox.destroy();
		oModel.destroy();
	});

	test("constructor - binding - destroyItems", function() {

		// system under test
		var oModel = new sap.ui.model.json.JSONModel({
			"selected" : ["AR", "BH"],
			"items" : [{
				"key" : "AL",
				"text" : "Algeria"
			}, {
				"key" : "AR",
				"text" : "Argentina"
			}, {
				"key" : "BH",
				"text" : "Bahrain"
			}]
		});
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : {
				path : "/items",
				template : new sap.ui.core.Item({
					key : "{key}",
					text : "{text}"
				})
			},
			selectedKeys : {
				path : "/selected"
			}
		});
		oMultiComboBox.setModel(oModel);

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.destroyItems();

		// assertions        
		deepEqual(oMultiComboBox.getSelectedKeys(), []);

		// cleanup
		oMultiComboBox.destroy();
		oModel.destroy();
	});

	test("constructor - selectedItems : [Item], items : [Item], removeSelectedKey via UI - check fired events",
			function() {

				// system under test
				var oModel = new sap.ui.model.json.JSONModel({
					"items" : [{
						"key" : "AL",
						"text" : "Algeria"
					}, {
						"key" : "AR",
						"text" : "Argentina"
					}, {
						"key" : "BH",
						"text" : "Bahrain"
					}]
				});
				var oMultiComboBox = new sap.m.MultiComboBox({
					items : {
						path : "/items",
						template : new sap.ui.core.Item({
							key : "{key}",
							text : "{text}"
						})
					}
				});
				oMultiComboBox.setModel(oModel);

				// arrange
				oMultiComboBox.placeAt("MultiComboBox-content");
				sap.ui.getCore().applyChanges();

				var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
				var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

				// act
				sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), "Algeria");
				sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

				// assertions
				strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
				strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection change event was fired");
				strictEqual(fnFireSelectionChangeSpy.args[0][0].changedItem, oMultiComboBox.getSelectedItems()[0],
						"The selection change event parameter was passed");
				strictEqual(fnFireSelectionChangeSpy.args[0][0].selected, true,
						"The selection change event parameter was passed");
				deepEqual(fnFireSelectionFinishSpy.args[0][0].selectedItems, oMultiComboBox.getSelectedItems());

				// cleanup
				oMultiComboBox.destroy();
			});

	//------------------------------ //
	// _getXXXVisibleItemOf          //
	// ----------------------------- //
	test("_getNextVisibleItemOf", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				key : "01",
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				key : "02",
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				key : "03",
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// assertions        
		deepEqual(oMultiComboBox._getNextVisibleItemOf(oItem1), oItem2);
		deepEqual(oMultiComboBox._getNextVisibleItemOf(oItem2), oItem3);
		deepEqual(oMultiComboBox._getNextVisibleItemOf(oItem3), null);
		deepEqual(oMultiComboBox._getNextVisibleItemOf(null), null);
		deepEqual(oMultiComboBox._getNextVisibleItemOf(new sap.ui.core.Item({
			key : "dummy"
		})), null);
		deepEqual(oMultiComboBox._getNextVisibleItemOf(), null);

		// cleanup
		oMultiComboBox.destroy();
	});

	test("_getPreviousVisibleItemOf", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				key : "01",
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				key : "02",
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				key : "03",
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// assertions        
		deepEqual(oMultiComboBox._getPreviousVisibleItemOf(oItem1), null);
		deepEqual(oMultiComboBox._getPreviousVisibleItemOf(oItem2), oItem1);
		deepEqual(oMultiComboBox._getPreviousVisibleItemOf(oItem3), oItem2);
		deepEqual(oMultiComboBox._getPreviousVisibleItemOf(null), null);
		deepEqual(oMultiComboBox._getPreviousVisibleItemOf(new sap.ui.core.Item({
			key : "dummy"
		})), null);
		deepEqual(oMultiComboBox._getNextVisibleItemOf(), null);

		// cleanup
		oMultiComboBox.destroy();
	});

	//------------------------------ //
	// DisabledListItem              //
	// ----------------------------- //
	test("DisabledListItem 'LIST_ITEM_VISUALISATION' - constructor",
			function() {

				// system under test
				var oItem1, oItem2, oItem3;
				var oMultiComboBox = new sap.m.MultiComboBox({
					items : [oItem1 = new sap.ui.core.Item({
						text : "item1",
						enabled : false
					}), oItem2 = new sap.ui.core.Item({
						text : "item2"
					}), oItem3 = new sap.ui.core.Item({
						text : "item3"
					})]
				});

				// arrange
				oMultiComboBox.placeAt("MultiComboBox-content");
				sap.ui.getCore().applyChanges();
				oMultiComboBox.open();
				this.clock.tick(500);

				// assertions
				equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 0,
						'The first Listitem should not be shown');
				equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
						'The second Listitem should be shown');
				equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
						'The third Listitem should be shown');
				ok(!oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).hasClass(
						"sapMComboBoxBaseItemDisabled"),
						'The third Listitem must not have the css class sapMComboBoxBaseItemDisabled');

				// cleanup
				oMultiComboBox.destroy();
				this.clock.reset();
			});

	test("DisabledListItem 'LIST_ITEM_VISUALISATION' - should not be shown in suggest list", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			value : "a",
			items : [oItem1 = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria",
				enabled : false
			}), oItem2 = new sap.ui.core.Item({
				key : "AR",
				text : "Argentina"
			}), oItem3 = new sap.ui.core.Item({
				key : "BA",
				text : "Barahin"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		sap.ui.qunit.QUnitUtils.triggerEvent("input", oMultiComboBox.getFocusDomRef());
		this.clock.tick(500);

		// assertions
		ok(oMultiComboBox._isListInSuggestMode(), 'Suggest list is open');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 0,
				'The first Listitem should not be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 0,
				'The third Listitem should not be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});
	
	test("DisabledListItem 'LIST_ITEM_VISUALISATION' - set disabled via API", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oItem1.setEnabled(false); //leads to invalidate of control
		this.clock.tick(500);
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 0,
				'The first Listitem should not be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	//------------------------------ //
	// Selectable Item             //
	// ----------------------------- //
	test("setSelectable Item 'LIST_ITEM_VISUALISATION'", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.setSelectable(oItem3, false);
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 1,
				'The first Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 0,
				'The third Listitem should not be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("setSelectable Dummy Item 'LIST_ITEM_VISUALISATION'", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.setSelectable(new sap.ui.core.Item({
			text : "Dummy"
		}), false);
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 1,
				'The first Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("setSelectable Item 'LIST_ITEM_VISUALISATION'", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.setSelectable(oItem3, false);
		oMultiComboBox.setSelectable(oItem3, true);
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 1,
				'The first Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("setSelectable Item 'LIST_ITEM_VISUALISATION' - selection is stored", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})],
			selectedItems : [oItem1]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.setSelectable(oItem1, false);
		oMultiComboBox.setSelectable(oItem1, true);
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 1,
				'The first Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	//------------------------------ //
	// clearFilter                   //
	// ----------------------------- //
	test("clearFilter", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.clearFilter();
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 1,
				'The first Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("clearFilter - after invisible", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1"
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.getListItem(oMultiComboBox.getFirstItem()).setVisible(false);
		oMultiComboBox.clearFilter();
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 1,
				'The first Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("clearFilter - disabled item", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1",
				enabled : false
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.clearFilter();
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 0,
				'The first Listitem should not be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("clearFilter - disabled item after invisible", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1",
				enabled : false
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oMultiComboBox.getListItem(oMultiComboBox.getFirstItem()).setVisible(false);
		oMultiComboBox.clearFilter();
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 0,
				'The first Listitem should not be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("clearFilter - disabled item after invisible", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				text : "item1",
				enabled : false
			}), oItem2 = new sap.ui.core.Item({
				text : "item2"
			}), oItem3 = new sap.ui.core.Item({
				text : "item3"
			})]
		});

		// arrange
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		oItem1.setEnabled(true);
		this.clock.tick(500);
		oMultiComboBox.getListItem(oMultiComboBox.getFirstItem()).setVisible(false);
		oMultiComboBox.clearFilter();
		oMultiComboBox.open();
		this.clock.tick(500);

		// assertions
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem1).getId()).length, 1,
				'The first Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem2).getId()).length, 1,
				'The second Listitem should be shown');
		equals(oMultiComboBox.getList().$().find("#" + oMultiComboBox.getListItem(oItem3).getId()).length, 1,
				'The third Listitem should be shown');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	// ------------------------------ //
	// Scenarios - specification      //
	// ------------------------------ //

	test("Scenario 'FIXED_CHAR': add invalid character.", function() {

		// system under test
		var oItem;
		var sInitValue = "Algeri";
		var oMultiComboBox = new sap.m.MultiComboBox({
			value : sInitValue,
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var oTarget = oMultiComboBox.getFocusDomRef();
		var fnOninputSpy = this.spy(oMultiComboBox, "oninput");
		var fnOnkeyupSpy = this.spy(oMultiComboBox, "onkeyup");

		// act
		sap.ui.test.qunit.triggerKeyup(oTarget, ''); // store old value
		oTarget.value = "Algeriz";
		sap.ui.qunit.QUnitUtils.triggerEvent("input", oTarget);

		// assertions
		strictEqual(fnOninputSpy.callCount, 1, "The oninput was called");
		strictEqual(fnOnkeyupSpy.callCount, 1, "The onkeyup was called");
		strictEqual(oMultiComboBox.getValue(), sInitValue,
				"Input value is returned to the inital value after wrong character was typed");
		strictEqual(oMultiComboBox.getFocusDomRef().value, oMultiComboBox.getValue(),
				"Dom value and value property are same after wrong character was typed");
		ok(oMultiComboBox.$().hasClass("sapMInputBaseError"),
				'The MultiComboBox must have the css class sapMInputBaseError');
		this.clock.tick(1100);
		ok(!oMultiComboBox.$().hasClass("sapMInputBaseError"),
				'The MultiComboBox must not have the css class sapMInputBaseError after 1000 msec');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'FIXED_CHAR': overwrite selected character with invalid one.", function() {

		// system under test
		var oItem;
		var sInitValue = "Algeri";
		var oMultiComboBox = new sap.m.MultiComboBox({
			value : sInitValue,
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.selectText(1, 2);
		var oTarget = oMultiComboBox.getFocusDomRef();
		var fnOninputSpy = this.spy(oMultiComboBox, "oninput");
		var fnOnkeyupSpy = this.spy(oMultiComboBox, "onkeyup");

		// act
		sap.ui.test.qunit.triggerKeyup(oTarget, ''); // store old value
		oTarget.value = "Azgeri";
		sap.ui.qunit.QUnitUtils.triggerEvent("input", oTarget);

		// assertions
		strictEqual(fnOninputSpy.callCount, 1, "The oninput was called");
		strictEqual(fnOnkeyupSpy.callCount, 1, "The onkeyup was called");
		strictEqual(oMultiComboBox.getValue(), sInitValue,
				"Input value is returned to the inital value after wrong character was typed");
		strictEqual(oMultiComboBox.getFocusDomRef().value, oMultiComboBox.getValue(),
				"Dom value and value property are same after wrong character was typed");
		ok(oMultiComboBox.$().hasClass("sapMInputBaseError"),
				'The MultiComboBox must have the css class sapMInputBaseError');
		this.clock.tick(1100);
		ok(!oMultiComboBox.$().hasClass("sapMInputBaseError"),
				'The MultiComboBox must not have the css class sapMInputBaseError after 1000 msec');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'TOKEN_ORDER': Order of tokens is the order how the items were selected", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			}), oItem2 = new sap.ui.core.Item({
				key : "AR",
				text : "Argentina"
			}), oItem3 = new sap.ui.core.Item({
				key : "AU",
				text : "Australia"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		// act
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem1.getText());
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem2.getText());
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem3.getText());
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		// assertions
		var aTokens = oMultiComboBox._oTokenizer.getTokens();
		strictEqual(aTokens[0].getKey(), oItem1.getKey());
		strictEqual(aTokens[1].getKey(), oItem2.getKey());
		strictEqual(aTokens[2].getKey(), oItem3.getKey());

		// arrange   
		oMultiComboBox.clearSelection();

		// act
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem3.getText());
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem2.getText());
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem1.getText());
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		// assertions
		aTokens = oMultiComboBox._oTokenizer.getTokens();
		strictEqual(aTokens[0].getKey(), oItem3.getKey());
		strictEqual(aTokens[1].getKey(), oItem2.getKey());
		strictEqual(aTokens[2].getKey(), oItem1.getKey());

		// cleanup
		oMultiComboBox.destroy();
	});

	// ------------------------------ //
	// Scenarios - event handling     //
	// ------------------------------ //

	test("Scenario 'EVENT_VALUE_ENTER': 'Algeria' + ENTER", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem.getText());
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER);

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_VALUE_DUMMY_ENTER': 'dummy' + ENTER", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), 'dummy');
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER); //onsapenter

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 0, "The selection change event was not fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was not fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_VALUE_SELECT_ENTER': 'Algeria' + select 'lgeria' + 'ustralia' + ENTER", function() {

		// system under test
		var oItem1, oItem2;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			}), oItem2 = new sap.ui.core.Item({
				key : "AU",
				text : "Australia"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem1.getText());
		oMultiComboBox.selectText(1, oMultiComboBox.getValue().length);
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), "ustralia");

		// assertions
		strictEqual(fnFireChangeSpy.callCount, 0, "The change event was not fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 0, "The selection change event was not fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was not fired");
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.ENTER);

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 0, "The selection change event was not fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was not fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_VALUE_PASTE': CTRL+V 'Algeria' ", function() {
		// IE has security settings 
		// which prompt the user if he wants to let the page access the clipboard.
		if (!sap.ui.Device.browser.internet_explorer) { 
			// system under test
			var oItem;
			var oMultiComboBox = new sap.m.MultiComboBox({
				items : [oItem = new sap.ui.core.Item({
					key : "DZ",
					text : "Algeria"
				})]
			});

			// arrange          
			oMultiComboBox.placeAt("MultiComboBox-content");
			sap.ui.getCore().applyChanges();

			var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
			var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

			// act
			sap.ui.test.qunit.triggerEvent("paste", oMultiComboBox.getFocusDomRef(), {
				originalEvent : {
					clipboardData : {
						getData : function() {
							return "Algeria";
						}
					}
				}
			});
			
			// assertions
			strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
			strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");
			
			deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
			
			// cleanup
			oMultiComboBox.destroy();
		} else {
			expect(0);
		}
	});
	
	test("Scenario 'EVENT_VALUE_LINE_BREAK_PASTE': CTRL+V 'item1 item2' ", function() {
		// IE has security settings 
		// which prompt the user if he wants to let the page access the clipboard.
		if (!sap.ui.Device.browser.internet_explorer) {
			// system under test
			var oItem;
			var oMultiComboBox = new sap.m.MultiComboBox({
				items : [oItem1 = new sap.ui.core.Item({
					key : "key1",
					text : "item1"
				}),
				oItem2 = new sap.ui.core.Item({
					key : "key2",
					text : "item2"
				})]
			});

			// arrange          
			oMultiComboBox.placeAt("MultiComboBox-content");
			sap.ui.getCore().applyChanges();

			var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
			var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

			// act
			sap.ui.test.qunit.triggerEvent("paste", oMultiComboBox.getFocusDomRef(), {
				originalEvent : {
					clipboardData : {
						getData : function() {
							return "item1\ritem2";
						}
					}
				}
			});
			
			// assertions
			strictEqual(fnFireSelectionChangeSpy.callCount, 2, "The selection change event was fired");
			strictEqual(fnFireSelectionFinishSpy.callCount, 2, "The selection finish event was fired");
			
			var selectedItems = oMultiComboBox.getSelectedItems();
			strictEqual(selectedItems[0].getKey(), oItem1.getKey(), "The first key should be 'key1'");
			strictEqual(selectedItems[1].getKey(), oItem2.getKey(), "The second key should be 'key2'");
			
			strictEqual(selectedItems[0].getText(), oItem1.getText(), "The first item text should be 'item1'");
			strictEqual(selectedItems[1].getText(), oItem2.getText(), "The second item text should be 'item2'");
			
			// cleanup
			oMultiComboBox.destroy();
		} else {
			expect(0);
		}
	});

	test("Scenario 'EVENT_VALUE_FOCUSOUT': 'Algeria' + FOCUSOUT", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), oItem.getText());
		sap.ui.test.qunit.triggerEvent("focusout", oMultiComboBox.getDomRef());

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 0, "The selection change event was not fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was not fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_TOKEN_BACKSPACE': Token 'Algeria' + BACKSPACE + BACKSPACE", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})],
			selectedItems : [oItem]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.BACKSPACE); // select last token
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.BACKSPACE); // delete selected token

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_TOKEN_DELETE': Token 'Algeria' + BACKSPACE + DELETE", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})],
			selectedItems : [oItem]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.BACKSPACE); // select last token
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.DELETE); // delete selected token

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_TOKENS_DELETE': 3 Tokens + CTRL+A + DELETE", function() {

		// system under test
		var oItem1, oItem2, oItem3;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem1 = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			}), oItem2 = new sap.ui.core.Item({
				key : "AR",
				text : "Argentina"
			}), oItem3 = new sap.ui.core.Item({
				key : "AU",
				text : "Australia"
			})],
			selectedItems : [oItem1, oItem2, oItem3]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.A, false, false, true); // select all tokens
		sap.ui.test.qunit.triggerKeydown(oMultiComboBox.getDomRef(), jQuery.sap.KeyCodes.DELETE); // delete selected tokens

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 3, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 3, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 3, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_TOKEN_DELETE_BUTTON': Token 'Algeria' + delete button on token", function() {

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})],
			selectedItems : [oItem]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act
		var oToken = jQuery.find(".sapMToken")[0];
		var oTokenIcon = jQuery.find(".sapMTokenIcon")[0];
		sap.ui.test.qunit.triggerTouchEvent("touchstart", oToken, {
			target : oTokenIcon,
			button : 0
		});
		sap.ui.test.qunit.triggerTouchEvent("touchend", oToken, {
			target : oTokenIcon,
			button : 0
		});

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_VALUE_ESCAPE': 'Algeria' change to 'Dummy' + ESCAPE", function() {

		// system under test
		var sInitValue = "Algeria";
		var oMultiComboBox = new sap.m.MultiComboBox({
			value : sInitValue,
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");
		var fnFireEventSpy = this.spy(oMultiComboBox, "fireEvent");

		// act
		oMultiComboBox.getFocusDomRef().value = "Dummy";

		// act
		sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ESCAPE);

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);

		strictEqual(oMultiComboBox.getValue(), sInitValue, "Input value is returned to the inital value after escape.");
		strictEqual(oMultiComboBox.getFocusDomRef().value, oMultiComboBox.getValue(),
				"Dom value and value property are same after escape.");
		ok(fnFireEventSpy.calledWith("liveChange"), "Private liveChange event is fired on escape");
		strictEqual(fnFireEventSpy.callCount, 1, "LiveChange event is fired once");

		strictEqual(fnFireChangeSpy.callCount, 0, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 0, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Scenario 'EVENT_VALUE_ENTER_OPENLIST': 'alg' + ALT+DOWNKEY + ENTER + ALT+UPKEY", function() {
		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act - 'alg' + OpenList + Enter
		sap.ui.test.qunit.triggerCharacterInput(oMultiComboBox.getFocusDomRef(), "alg");
		sap.ui.test.qunit
				.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN, false, true);
		sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ENTER);
		sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_UP, false, true);
		this.clock.tick(500);

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario 'EVENT_SELECTION_SPACE': ALT+DOWNKEY + SelectItem + ALT+UPKEY", function() {
		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act - 'alg' + OpenList + TAP
		sap.ui.test.qunit
				.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN, false, true);
		this.clock.tick(500);
		var oDomListItem = jQuery.find(".sapMComboBoxBaseItem")[0];
		var oListItem = sap.ui.getCore().byId(oDomListItem.id);
		sap.ui.test.qunit.triggerTouchEvent("tap", oDomListItem, {
			srcControl : oListItem
		});

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), [oItem]);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was fired");

		// act - CloseList
		sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_UP, false, true);
		this.clock.tick(500);

		// assertions
		strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario 'EVENT_DESELECTION_SPACE': SelectedItem + ALT+DOWNKEY + DeselectItem + ALT+UPKEY", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oItem;
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [oItem = new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})],
			selectedItems : [oItem]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		var fnFireChangeSpy = this.spy(oMultiComboBox, "fireChange");
		var fnFireSelectionChangeSpy = this.spy(oMultiComboBox, "fireSelectionChange");
		var fnFireSelectionFinishSpy = this.spy(oMultiComboBox, "fireSelectionFinish");

		// act - 'alg' + OpenList + TAP
		sap.ui.test.qunit
				.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN, false, true);
		this.clock.tick(500);
		var oDomListItem = jQuery.find(".sapMComboBoxBaseItem")[0];
		var oListItem = sap.ui.getCore().byId(oDomListItem.id);
		sap.ui.test.qunit.triggerTouchEvent("tap", oDomListItem, {
			srcControl : oListItem
		});

		// assertions        
		deepEqual(oMultiComboBox.getSelectedItems(), []);
		strictEqual(fnFireChangeSpy.callCount, 1, "The change event was fired");
		strictEqual(fnFireSelectionChangeSpy.callCount, 1, "The selection change event was fired");
		strictEqual(fnFireSelectionFinishSpy.callCount, 0, "The selection finish event was fired");

		// act - CloseList
		sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_UP, false, true);
		this.clock.tick(500);

		// assertions
		strictEqual(fnFireSelectionFinishSpy.callCount, 1, "The selection finish event was fired");

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario CLICK_INPUT: tap into control", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		var fnTapSpy = this.spy(oMultiComboBox, "ontap");
		var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

		// act - clicking on control
		sap.ui.test.qunit.triggerTouchEvent("tap", oMultiComboBox.getFocusDomRef(), {
			target : oMultiComboBox.getFocusDomRef()
		});
		this.clock.tick(500);

		// assertions
		strictEqual(fnTapSpy.callCount, 1, "ontap event was called exactly once on " + oMultiComboBox);
		strictEqual(fnOpenSpy.callCount, 0, "open was not called");
		strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.CLOSED, "Popup is closed");
		ok(!oMultiComboBox.isOpen(), "oMultiComboBox is closed");
		ok(!oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must not have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	// --------------------------------- //
	// Scenarios - opening dropdown list //
	// --------------------------------- // 

	test("Scenario OPEN_ALTDOWN", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnShowSpy = this.spy(oMultiComboBox, "onsapshow");
		var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

		// act
		sap.ui.test.qunit
				.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN, false, true);
		this.clock.tick(500);

		// assertions                     
		strictEqual(fnShowSpy.callCount, 1, "onsapshow was called exactly once");
		strictEqual(fnOpenSpy.callCount, 1, "openwas called exactly once");
		strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.OPEN, "Popup is open");
		ok(oMultiComboBox.isOpen(), "oMultiComboBox is open");
		ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');
		ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is open');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario OPEN_ALTUP", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnHideSpy = this.spy(oMultiComboBox, "onsaphide");
		var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

		// act
		sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_UP, false, true);
		this.clock.tick(500);

		// assertions                     
		strictEqual(fnHideSpy.callCount, 1, "onsaphide was called exactly once");
		strictEqual(fnOpenSpy.callCount, 1, "openwas called exactly once");
		strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.OPEN, "Popup is open");
		ok(oMultiComboBox.isOpen(), "oMultiComboBox is open");
		ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');
		ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is open');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario OPEN_F4", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();

		var fnShowSpy = this.spy(oMultiComboBox, "onsapshow");
		var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

		// act
		sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.F4);
		this.clock.tick(500);

		// assertions                     
		strictEqual(fnShowSpy.callCount, 1, "onsapshow was called exactly once");
		strictEqual(fnOpenSpy.callCount, 1, "open was called exactly once");
		strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.OPEN, "Popup is open");
		ok(oMultiComboBox.isOpen(), "oMultiComboBox is open");
		ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');
		ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is open');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario OPEN_ARROW: tap on arrow", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		var fnTapSpy = this.spy(oMultiComboBox, "ontap");
		var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

		// act - clicking on arrow
		sap.ui.test.qunit.triggerTouchEvent("tap", oMultiComboBox.getDomRef("arrow"), {
			target : oMultiComboBox.getDomRef("arrow")
		});
		this.clock.tick(500);

		// assertions
		strictEqual(fnTapSpy.callCount, 1, "ontap event was called exactly once on Arrow");
		strictEqual(fnOpenSpy.callCount, 1, "open was called exactly once");
		strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.OPEN, "Popup is open");
		ok(oMultiComboBox.isOpen(), "oMultiComboBox is open");
		ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');
		ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is open');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario OPEN_VALUE: Typing valid letters into InputField", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			value : "algeria",
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			}), new sap.ui.core.Item({
				key : "AR",
				text : "Argentina"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

		// act
		sap.ui.qunit.QUnitUtils.triggerEvent("input", oMultiComboBox.getFocusDomRef());
		this.clock.tick(500);

		// assertions
		strictEqual(fnOpenSpy.callCount, 1, "open was called exactly once");
		strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.OPEN, "Popup is open");
		ok(oMultiComboBox.isOpen(), "oMultiComboBox is open");
		ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');
		ok(oMultiComboBox._isListInSuggestMode(), 'Suggest list is open');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("Scenario OPEN_VALUE: Type valid letter into InputField and delete it", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test              
		var oMultiComboBox = new sap.m.MultiComboBox({
			value : "a",
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			}), new sap.ui.core.Item({
				key : "BA",
				text : "Barahin"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		sap.ui.qunit.QUnitUtils.triggerEvent("input", oMultiComboBox.getFocusDomRef());
		this.clock.tick(500);

		// assertions
		ok(oMultiComboBox._isListInSuggestMode(), 'Suggest list is open');

		// act				
		oMultiComboBox.setValue("");
		sap.ui.qunit.QUnitUtils.triggerEvent("input", oMultiComboBox.getFocusDomRef());
		this.clock.tick(500);

		// assertions
		ok(!oMultiComboBox.isOpen(), "oMultiComboBox is closed");

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test(
			"Scenario OPEN_SUGGEST_SPACE: Pushing SPACE on item in suggest list - suggest list is closing first and complete list is opening then",
			function() {

				var oSystem = {
					desktop : true,
					phone : false,
					tablet : false
				};
				this.stub(sap.ui.Device, "system", oSystem);
				this.stub(jQuery.device, "is", oSystem);

				// system under test              
				var oMultiComboBox = new sap.m.MultiComboBox({
					value : "al",
					items : [new sap.ui.core.Item({
						key : "DZ",
						text : "Algeria"
					}), new sap.ui.core.Item({
						key : "AR",
						text : "Argentina"
					})]
				});

				// arrange          
				oMultiComboBox.placeAt("MultiComboBox-content");
				sap.ui.getCore().applyChanges();
				var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

				// act
				sap.ui.qunit.QUnitUtils.triggerEvent("input", oMultiComboBox.getFocusDomRef());
				this.clock.tick(500);

				// assertions
				ok(oMultiComboBox._isListInSuggestMode(), 'Suggest list is open');

				// act
				var oDomListItem = jQuery.find(".sapMComboBoxBaseItem")[0];
				sap.ui.test.qunit.triggerKeyup(oDomListItem, jQuery.sap.KeyCodes.SPACE);
				this.clock.tick(500);

				// assertions
				strictEqual(fnOpenSpy.callCount, 2, "open was called exactly once");
				strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.OPEN, "Popup is open");
				ok(oMultiComboBox.isOpen(), "oMultiComboBox is open");
				ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
						'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');

				// cleanup
				oMultiComboBox.destroy();
				this.clock.reset();
			});

	test(
			"Scenario OPEN_SUGGEST_ARROW: Pushing twice ALT+DOWN etc. in suggest list - suggest list is closing first and complete list is opening then",
			function() {

				var oSystem = {
					desktop : true,
					phone : false,
					tablet : false
				};
				this.stub(sap.ui.Device, "system", oSystem);
				this.stub(jQuery.device, "is", oSystem);

				// system under test              
				var oMultiComboBox = new sap.m.MultiComboBox({
					value : "al",
					items : [new sap.ui.core.Item({
						key : "DZ",
						text : "Algeria"
					}), new sap.ui.core.Item({
						key : "AR",
						text : "Argentina"
					})]
				});

				// arrange          
				oMultiComboBox.placeAt("MultiComboBox-content");
				sap.ui.getCore().applyChanges();
				oMultiComboBox.focus();
				var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");

				// act
				sap.ui.qunit.QUnitUtils.triggerEvent("input", oMultiComboBox.getFocusDomRef());
				this.clock.tick(500);

				// assertions
				ok(oMultiComboBox._isListInSuggestMode(), 'Suggest list is open');

				// act
				sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_UP, false,
						true); // close list
				this.clock.tick(500);
				sap.ui.test.qunit.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_UP, false,
						true); // open list
				this.clock.tick(500);

				// assertions
				strictEqual(fnOpenSpy.callCount, 2, "open was called exactly twice");
				strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.OPEN, "Popup is open");
				ok(oMultiComboBox.isOpen(), "oMultiComboBox is open");
				ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
						'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');
				ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is open');

				// cleanup
				oMultiComboBox.destroy();
				this.clock.reset();
			});

	test("Scenario 'CLOSE_TAP': closing list via tapping on list item", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test              
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				text : "Algeria"
			}), new sap.ui.core.Item({
				text : "Argentina"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.getFocusDomRef().focus();
		oMultiComboBox.open();
		this.clock.tick(500);

		// act
		var oDomListItem = jQuery.find(".sapMComboBoxBaseItem")[0];
		var oListItem = sap.ui.getCore().byId(oDomListItem.id);
		sap.ui.test.qunit.triggerEvent("tap", oDomListItem, {
			srcControl : oListItem
		});
		this.clock.tick(500);

		// assertions		
		ok(!oMultiComboBox.isOpen(), "oMultiComboBox is closed");
		equals(oMultiComboBox.getFocusDomRef().id, document.activeElement.id, "Input field has focus");

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	// --------------------------------- //
	// Scenarios - closing dropdown list //
	// --------------------------------- // 

	/*test("Scenario CLOSE_FOCUSLEAVE", function() {

	      // system under test
	      var oMultiComboBox = new sap.m.MultiComboBox({
	             items : [ new sap.ui.core.Item({
	                    key : "DZ",
	                    text : "Algeria"
	             }) ]
	      });

	      // arrange          
	      oMultiComboBox.placeAt("MultiComboBox-content");
	      sap.ui.getCore().applyChanges();
	      oMultiComboBox.focus();

	      var fnOpenSpy = this.spy(oMultiComboBox.getPicker(), "open");
	      var fnCloseSpy = this.spy(oMultiComboBox.getPicker(), "close");

	      // act       
	      oMultiComboBox.open();
	      this.clock.tick(1000);
	      sap.ui.test.qunit.triggerEvent("focusout", oMultiComboBox.getFocusDomRef());
	      this.clock.tick(1000);

	      // assertions                                  
	      strictEqual(fnCloseSpy.callCount, 1, "close was called exactly once");
	      strictEqual(oMultiComboBox.getPicker().oPopup.getOpenState(), sap.ui.core.OpenState.CLOSED, "Popup is closed");
	      ok(!oMultiComboBox.isOpen(), "oMultiComboBox is closed");
	      ok(!oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"), 'The MultiComboBox must not have the css class “'
	                    + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');

	      // cleanup
	      oMultiComboBox.destroy();
	       this.clock.reset();
	});*/

	// --------------------------------- //
	// Arrow - pressed state             //
	// --------------------------------- // 
	test("Arrow - pressed on arrow", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		// act
		var oDomRefArrow = oMultiComboBox.getDomRef("arrow");
		sap.ui.test.qunit.triggerTouchEvent("touchstart", oDomRefArrow, {
			target : oDomRefArrow
		});

		// assertions                                  
		ok(!oMultiComboBox.isOpen(), "oMultiComboBox is closed");
		ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Arrow - pressed on control", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		// act
		var oDomRef = oMultiComboBox.getFocusDomRef();
		sap.ui.test.qunit.triggerTouchEvent("touchstart", oDomRef, {
			target : oDomRef
		});

		// assertions                                  
		ok(!oMultiComboBox.isOpen(), "oMultiComboBox is closed");
		ok(!oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must not have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("Arrow - tap on list item in suggest mode", function() {

		var oSystem = {
			desktop : true,
			phone : false,
			tablet : false
		};
		this.stub(sap.ui.Device, "system", oSystem);
		this.stub(jQuery.device, "is", oSystem);

		// system under test              
		var oMultiComboBox = new sap.m.MultiComboBox({
			value : "a",
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			}), new sap.ui.core.Item({
				key : "BA",
				text : "Barahin"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		sap.ui.qunit.QUnitUtils.triggerEvent("input", oMultiComboBox.getFocusDomRef());
		this.clock.tick(500);

		// act
		var oDomListItem = jQuery.find(".sapMComboBoxBaseItem")[0];
		var oListItem = sap.ui.getCore().byId(oDomListItem.id);
		sap.ui.test.qunit.triggerTouchEvent("tap", oDomListItem, {
			srcControl : oListItem
		});
		this.clock.tick(500);

		// assertions
		ok(oMultiComboBox.isOpen(), "oMultiComboBox is closed");
		ok(!oMultiComboBox._isListInSuggestMode(), 'Complete list is open');
		ok(oMultiComboBox.$().hasClass(sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Pressed"),
				'The MultiComboBox must have the css class “' + sap.m.ComboBoxBaseRenderer.CSS_CLASS + 'Pressed”');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});
	// --------------------------------- //
	// Focus - border                    //
	// --------------------------------- // 
	test("FocusBorder - pressed on control", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		// act
		var oDomRef = oMultiComboBox.getFocusDomRef();
		sap.ui.test.qunit.triggerTouchEvent("touchstart", oDomRef, {
			target : oDomRef
		});

		// assertions                                  
		ok(oMultiComboBox.$().hasClass(sap.m.MultiComboBoxRenderer.CSS_CLASS + "Focused"),
				'The MultiComboBox must have the css class “' + sap.m.MultiComboBoxRenderer.CSS_CLASS + 'Focused”');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("FocusBorder - pressed on arrow", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		// act
		var oDomRefArrow = oMultiComboBox.getDomRef("arrow");
		sap.ui.test.qunit.triggerTouchEvent("touchstart", oDomRefArrow, {
			target : oDomRefArrow
		});

		// assertions                                  
		ok(oMultiComboBox.$().hasClass(sap.m.MultiComboBoxRenderer.CSS_CLASS + "Focused"),
				'The MultiComboBox must have the css class “' + sap.m.MultiComboBoxRenderer.CSS_CLASS + 'Focused”');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("FocusBorder - focus on list item", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		// act
		sap.ui.test.qunit
				.triggerKeyboardEvent(oMultiComboBox.getFocusDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN, false, true);
		this.clock.tick(500);
		var oDomListItem = jQuery.find("." + sap.m.ComboBoxBaseRenderer.CSS_CLASS + "Item")[0];
		var oListItem = sap.ui.getCore().byId(oDomListItem.id);
		sap.ui.test.qunit.triggerTouchEvent("tap", oDomListItem, {
			srcControl : oListItem
		});

		// assertions                                  
		ok(oMultiComboBox.$().hasClass(sap.m.MultiComboBoxRenderer.CSS_CLASS + "Focused"),
				'The MultiComboBox must have the css class “' + sap.m.MultiComboBoxRenderer.CSS_CLASS + 'Focused”');

		// cleanup
		oMultiComboBox.destroy();
		this.clock.reset();
	});

	test("FocusBorder - arrow + leave", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		// act
		var oDomRefArrow = oMultiComboBox.getDomRef("arrow");
		sap.ui.test.qunit.triggerTouchEvent("touchstart", oDomRefArrow, {
			target : oDomRefArrow
		});
		sap.ui.test.qunit.triggerEvent("focusout", oMultiComboBox.getDomRef());

		// assertions                                  
		ok(!oMultiComboBox.$().hasClass(sap.m.MultiComboBoxRenderer.CSS_CLASS + "Focused"),
				'The MultiComboBox must not have the css class “' + sap.m.MultiComboBoxRenderer.CSS_CLASS + 'Focused”');

		// cleanup
		oMultiComboBox.destroy();
	});

	test("FocusBorder - control + leave", function() {

		// system under test
		var oMultiComboBox = new sap.m.MultiComboBox({
			items : [new sap.ui.core.Item({
				key : "DZ",
				text : "Algeria"
			})]
		});

		// arrange          
		oMultiComboBox.placeAt("MultiComboBox-content");
		sap.ui.getCore().applyChanges();
		oMultiComboBox.focus();

		// act
		var oDomRef = oMultiComboBox.getFocusDomRef();
		sap.ui.test.qunit.triggerTouchEvent("touchstart", oDomRef, {
			target : oDomRef
		});
		sap.ui.test.qunit.triggerEvent("focusout", oDomRef);

		// assertions                                  
		ok(!oMultiComboBox.$().hasClass(sap.m.MultiComboBoxRenderer.CSS_CLASS + "Focused"),
				'The MultiComboBox must not have the css class “' + sap.m.MultiComboBoxRenderer.CSS_CLASS + 'Focused”');

		// cleanup
		oMultiComboBox.destroy();
	});
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">QUnit tests: sap.m.MultiComboBox</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<ol id="qunit-tests"></ol>
	<div id="MultiComboBox-content" class="select-content"></div>
</body>
</html>


