<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Test Page for sap.m.Input</title>
<script src="../shared-config.js"></script>
<script id="sap-ui-bootstrap"
		data-sap-ui-noConflict="true"
		data-sap-ui-libs="sap.m" src="../../../../resources/sap-ui-core.js">
</script>

<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script src="../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- use the sinon faketimers for this test -->
<script>
	sinon.config.useFakeTimers = true;

	// FIXME: test doesn't work in headless PhantomJS test cycle => commented out!
	//  ==> PhantomJS fails with strange errors when evaluating setTimeout
	//      e.g.: null is not a constructor (evaluating setTimeout) as a follow
	//      up of the destroy calls of the Input control
	if (sap.ui.Device.browser.phantomJS) {
		var fnSetTimeout = window.setTimeout;
		window.setTimeout = function() {
			try {
				fnSetTimeout.apply(this, arguments);
			} catch (e) {}
		}
		var fnClearTimeout = window.clearTimeout;
		window.clearTimeout = function() {
			try {
				fnClearTimeout.apply(this, arguments);
			} catch (e) {}
		}
	}
</script>

<script>
	var i1;
	var i2;
	var value = "value";

	var oInput = new sap.m.Input("i1");
	//oInput.setMaxLength(12);
	//@TODO Write qunit for maxlength
	oInput.placeAt("content");
	oInput.setValue("ABCD");

	var oInput2 = new sap.m.Input("i2");
	oInput2.setType("Number");
	oInput2.placeAt("content");

	var oInput3 = new sap.m.Input("i3");
	oInput3.setVisible(false);
	oInput3.placeAt("content");

	var oInput4 = new sap.m.Input("i4");
	oInput4.setValueState("Error");
	oInput4.placeAt("content");

	var oInput5 = new sap.m.Input("i5");
	oInput5.setValueState("Warning");
	oInput5.placeAt("content");

	var oInput6 = new sap.m.Input("i6", {
		showSuggestion: true
	});
		oInput6.placeAt("content");

	var oInput7 = new sap.m.Input("i7", {
		showSuggestion: true
	});

	oInput7.placeAt("content");

	var oInput8 = new sap.m.Input("i8");
	oInput8.placeAt("content");

	qutils.delayTestStart();

	QUnit.module("Basic", {
		beforeEach : function() {
			i1 = sap.ui.getCore().getControl("i1");
			i2 = sap.ui.getCore().getControl("i2");
			i3 = sap.ui.getCore().getControl("i3");
			i4 = sap.ui.getCore().getControl("i4");
			i5 = sap.ui.getCore().getControl("i5");
			i8 = sap.ui.getCore().getControl("i8");
		},
		afterEach : function() {
			i1 = null;
			i2 = null;
			i3 = null;
			i4 = null;
			i5 = null;
			i8 = null;
		}
	});

	// test property accessor methods
	QUnit.test("Value", function(assert) {
		i1.setValue(value);
		assert.equal(i1.getValue(), value, "Input value is "+value);
	});

	QUnit.test("InputType", function(assert) {
		var typeDefault = "Text";
		assert.equal(i1.getType(), typeDefault, "Input Type: Default");
	});

	QUnit.test("InputEnabled", function(assert) {
		var enabled = false;
		i1.setEnabled(enabled);
		assert.equal(i1.getEnabled(), enabled, "Input is disabled");
		enabled = true;
		i1.setEnabled(enabled);
		assert.equal(i1.getEnabled(), enabled, "Input is enabled");
	});

	QUnit.test("ValueHelpOnly", function(assert) {
		assert.equal(i1.getValueHelpOnly(), false, "ValueHelpOnly Default: false");
		var helponly = true;
		i1.setValueHelpOnly(helponly);
		assert.equal(i1.getValueHelpOnly(), helponly, "ValueHelpOnly is true");
	});

	QUnit.test("Placeholder", function(assert) {
		var placeholder = "Placeholder";
		i1.setPlaceholder(placeholder);
		assert.equal(i1.getPlaceholder(), placeholder, "Placeholder for text");

		i2.setPlaceholder(placeholder);
		assert.equal(i2.getPlaceholder(), placeholder, "Placeholder for number field");
	});

	QUnit.test("Visible", function(assert) {
		assert.equal(i1.$().length, 1, "Visible input found");
		assert.equal(i3.$().length, 0, "Invisible input not found");
	});

	QUnit.test("Change", function(assert) {
		i1.setValue("new");
		sap.ui.getCore().applyChanges();
		i1.attachChange(function() {
			assert.equal(this.getValue(), "new", "New value in onChange");
		});
		i1.onChange(jQuery.Event("change"));
		assert.equal(i1.getValue(),"new", "Value after onchange");
	});

	QUnit.test("Event order", function(assert) {
		var oInput = new sap.m.Input({
				showSuggestion: true
			}),
			$Input,
			oPopup, // is lazy loaded
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i,
			bSuggestionItemSelectedEventCalled = false,
			bChangeEventCalled = false;

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();
		$Input = oInput.$();

		oInput.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});
		oInput.attachSuggestionItemSelected(function (oEvent) {
			assert.ok(!bChangeEventCalled, "Change event is not called yet when SuggestionItemSelectedEvent is called");
			assert.ok(!bSuggestionItemSelectedEventCalled, "SuggestionItemSelected event is called once");
			bSuggestionItemSelectedEventCalled = true;
		});
		oInput.attachChange(function (oEvent) {
			assert.ok(bSuggestionItemSelectedEventCalled, "SuggestionItemSelected event has been called before the change event");
			assert.ok(!bChangeEventCalled, "Change event is called once");
			bChangeEventCalled = true;
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("abc").trigger("input");
		this.clock.tick(300);
		oPopup = oInput._oSuggestionPopup;

		sap.ui.test.qunit.triggerTouchEvent("tap", oPopup.getContent()[0].getItems()[1].getDomRef());
		this.clock.tick(300);

		oInput.destroy();
	});

	QUnit.test("valueLiveUpdate", function(assert) {

		var oModel = new sap.ui.model.json.JSONModel({testValue: ""});
		oInput8.setModel(oModel);
		oInput8.bindValue("/testValue");

		var fnFireChangeSpy = this.spy(i8, "fireChange");
		i8.setValueLiveUpdate(false);
		i8.setValue("");
		i8.focus();
		sap.ui.test.qunit.triggerCharacterInput(i8.getFocusDomRef(), "a");
		sap.ui.test.qunit.triggerEvent("input", i8.getFocusDomRef());

		assert.equal(oModel.getProperty("/testValue"),"" , "no valueLiveUpdate, no model value update");
		assert.equal(i8.getValue()                   ,"a", "no valueLiveUpdate, new value");
		assert.equal(fnFireChangeSpy.callCount       , 0 , "no valueLiveUpdate, no change event");

		sap.ui.test.qunit.triggerKeydown(i8.getFocusDomRef(), "ENTER");

		assert.equal(i8.getValue()                   ,"a", "no valueLiveUpdate, Enter, same new value");
		assert.equal(oModel.getProperty("/testValue"),"a", "no valueLiveUpdate, Enter, model value update");
	    assert.equal(fnFireChangeSpy.callCount       , 1 , "no valueLiveUpdate, Enter, change event");

		i8.setValueLiveUpdate(true);
		i8.setValue("");
		fnFireChangeSpy.reset();
		sap.ui.test.qunit.triggerCharacterInput(i8.getFocusDomRef(), "a");
		sap.ui.test.qunit.triggerEvent("input", i8.getFocusDomRef());
		assert.equal(oModel.getProperty("/testValue"),"a", "valueLiveUpdate, no model value update");
		assert.equal(i8.getValue()                   ,"a", "valueLiveUpdate, new value");
		assert.equal(fnFireChangeSpy.callCount       , 0,  "valueLiveUpdate, stil no change event");

		sap.ui.test.qunit.triggerKeydown(i8.getFocusDomRef(), "ENTER");

		assert.equal(oModel.getProperty("/testValue"),"a", "valueLiveUpdate, no model value update");
		assert.equal(i8.getValue()                   ,"a", "no valueLiveUpdate, Enter, change");
		assert.equal(fnFireChangeSpy.callCount       , 1,  "no valueLiveUpdate, Enter, changeevent");

		i8.setValueLiveUpdate(false);
	});


	QUnit.test("Value States", function(assert) {

		assert.equal(i4.$().hasClass('sapMInputBaseError'), true, "Before new value state : Error");
		assert.equal(i5.$().hasClass('sapMInputBaseWarning'), true, "Before new value state : Warning");
		assert.equal(i4.$().attr("title"), undefined, "No tooltip for error state");
		assert.equal(i5.$().attr("title"), undefined, "No tooltip for warning state");

		i4.setValueState("Warning");
		i5.setValueState("Error");
		sap.ui.getCore().applyChanges();

		assert.equal(i4.$().hasClass('sapMInputBaseWarning'), true, "After new value state : Warning");
		assert.equal(i5.$().hasClass('sapMInputBaseError'), true, "After new value state : Error");

		i4.setValueState();
		i5.setValueState("None");

		assert.equal(i4.getValueState(), "None", "Last value state : None");
		assert.equal(i5.getValueState(), "None", "Last value state : None");
		assert.equal(i5.$().attr("title"), undefined, "Tooltip is empty for valueState \"None\"");
	});

	QUnit.test("Value Help Indicator", function(assert) {
		var spy = this.spy(),
			oInput = new sap.m.Input( {
				valueHelpRequest: spy
			}),
			oInputId = oInput.getId();

		// place control
		oInput.placeAt("content");

		// first check if value help indicator classes are not set by default
		assert.ok(oInput.$().children(".sapMInputValHelp").length === 0, "Has no outer value help indicator element");
		assert.ok(oInput.$().children(".sapMInputValHelpInner").length === 0, "Has no inner value help indicator element");
		assert.ok(oInput.$().hasClass("sapMInputVH") === false, "Outer div has no additional CSS class\"sapMInputVH\"");

		// set value help indicator to true
		oInput.setShowValueHelp(true);
		sap.ui.getCore().applyChanges();

		// then check if value help indicator classes are set
		assert.ok(oInput.$().children(".sapMInputValHelp").length === 1, "Has an outer value help indicator element");
		assert.ok(oInput.$().children(".sapMInputValHelp").children(".sapMInputValHelpInner").length === 1, "Has an inner value help indicator element");
		assert.ok(oInput.$().hasClass("sapMInputVH") === true, "Outer div has additional CSS class\"sapMInputVH\"");

		// screen reader announcement for F4, there should be at least one description
		var describedById = oInput.getFocusDomRef().getAttribute("aria-describedby");
		var aLabels = describedById.split(' ');
		var bLabelsExist = aLabels.every(function(id){
			return !!document.getElementById(id);
		});
		assert.ok(!!describedById, "At least one described by ID is set for screen reader");
		assert.ok(bLabelsExist, "All screen reader descriptions are rendered in DOM");

		// temporarily overwrite function to get a placeholder on all browsers

		this.stub(sap.m.InputBase.prototype, "bShowLabelAsPlaceholder", true);
		oInput.rerender();
		oInput.$().find("label").css("display","block");
		assert.strictEqual(oInput.$().find("label").css("padding-right"), "12px", "Placeholder label has right padding of 12px when value help icon is enabled");

		// event check
		oInput.getAggregation("_valueHelpIcon").firePress();
		assert.strictEqual(spy.callCount, 1, "Value Help Request has been fired and received successfully");
	});

	QUnit.test("Keyboard Handling", function(assert) {
		// F4 event check
		var evt = jQuery.Event("sapshow"),
			spy = this.spy(),
			oInput = new sap.m.Input( {
				showValueHelp: true,
				valueHelpRequest: spy
			});

		oInput.onsapshow(evt);
		assert.strictEqual(spy.callCount, 1, "The value help was requested by pressing F4");
	});

	QUnit.test("Submit Event", function(assert) {

		var sEvents = "";
		var sValue = "";
		var oInput = new sap.m.Input("hello", {
			submit: function(oEvent){
				sEvents += "E";
				sValue = oEvent.getParameter("value");
			},
			change: function(){
				sEvents += "C";
			}
		});
		oInput.placeAt("content");

		function checkSubmit(sText, bSubmitExpected, bChangeExpected, sExpectedValue) {
			var e = "";
			if (bChangeExpected) {
				e += "C";
			}
			if (bSubmitExpected) {
				e += "E";
			}

			sEvents = "";
			sValue = "";
			sap.ui.getCore().applyChanges();
			sap.ui.test.qunit.triggerKeydown(oInput.getDomRef("inner"), jQuery.sap.KeyCodes.ENTER);
			assert.equal(sEvents, e, sText + ": Correct number of events fired and order correct: " + e.length + (e.length > 0 ? "/" + e : ""));
			if (bSubmitExpected) {
				if (sExpectedValue) {
					assert.equal(sValue, sExpectedValue, sText + ": Correct parameter 'value' in enter event: " + sExpectedValue);
				} else {
					assert.ok(!sValue, sText + ": Correct parameter 'value' in enter event: Value empty");
				}
			}
		}

		checkSubmit("Enter pressed without change", true, false, "");
		oInput.$("inner").val("hello");
		checkSubmit("Enter pressed after change", true, true, "hello");
		oInput.setEnabled(false);
		checkSubmit("Enter pressed on disabled field", false, false);
		oInput.setEnabled(true);
		oInput.setEditable(false);
		checkSubmit("Enter pressed on readonly field", false, false);
		oInput.setEditable(true);
		oInput.setShowValueHelp(true);
		checkSubmit("Enter pressed on field with value help", true, false, "hello");
		oInput.setValueHelpOnly(true);
		checkSubmit("Enter pressed on field with value help only", false, false);
		oInput.setShowValueHelp(false);
		oInput.setValueHelpOnly(false);

		// Enter on Suggestions
		if (sap.ui.Device.system.desktop) {
			oInput.setShowSuggestion(true);
			var aItemsAdded = [];
			oInput.attachSuggest(function() {
				var aNames = ["abcTom", "abcPhilips", "abcAnna"];
				for (var i = 0; i < aNames.length; i++) {
					if(jQuery.inArray(aNames[i], aItemsAdded) === -1){
						oInput.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
						aItemsAdded.push(aNames[i]);
					}
				}
			});
			sap.ui.getCore().applyChanges();

			oInput.onfocusin();
			oInput._$input.focus().val("abc").trigger("input");
			this.clock.tick(300);

			assert.ok(oInput._oSuggestionPopup && oInput._oSuggestionPopup.isOpen && oInput._oSuggestionPopup.isOpen(), "Suggestion Popup is open now");
			sap.ui.test.qunit.triggerKeydown(oInput.getDomRef("inner"), jQuery.sap.KeyCodes.ARROW_DOWN);
			checkSubmit("Enter pressed on open Suggestions", true, true, "abcTom");
			assert.ok(oInput._oSuggestionPopup && oInput._oSuggestionPopup.isOpen && !oInput._oSuggestionPopup.isOpen(), "Suggestion Popup should be closed");
		}

		oInput.destroy();
	});

	QUnit.test("Value Help Only CSS Classes and event", function(assert) {
		var spy = this.spy(),
			oInputVHO = new sap.m.Input( {
				showValueHelp: true,
				valueHelpOnly: true,
				valueHelpRequest: spy
			}),
			oInputIdVHO = oInputVHO.getId();

		// place control
		oInputVHO.placeAt("content");
		sap.ui.getCore().applyChanges();

		// check if valueHelpOnly class is set in addition to ValueHelp class
		assert.ok(oInputVHO.$().hasClass("sapMInputVH") === true, "Outer div has additional CSS class\"sapMInputVH\"");
		assert.ok(oInputVHO.$().hasClass("sapMInputVHO") === true, "Outer div has additional CSS class\"sapMInputVHO\"");

		// Value help event check
		oInputVHO._$input.focus().trigger("tap");
		this.clock.tick(500);
        assert.strictEqual(spy.callCount, 1, "Value Help Request has been fired and received successfully");
	});

	QUnit.test("Conditions for Value Help Only not valid", function(assert) {
	// case1: showValueHelp is false
		var spy = this.spy(),
			oInputVHO = new sap.m.Input( {
				showValueHelp: false,
				valueHelpOnly: true,
				enabled: true,
				editable: true,
				valueHelpRequest: spy
				}),
			oInputIdVHO = oInputVHO.getId();

		// place control
		oInputVHO.placeAt("content");
		sap.ui.getCore().applyChanges();

		// check if valueHelpOnly class is set in addition to ValueHelp class
		assert.ok(oInputVHO.$().hasClass("sapMInputVH") === false, "showValueHelp = false: Outer div has no additional CSS class\"sapMInputVH\"");
		assert.ok(oInputVHO.$().hasClass("sapMInputVHO") === false, "showValueHelp = false: Outer div has no additional CSS class\"sapMInputVHO\"");

		// Value help event check
		oInputVHO._$input.focus().trigger("tap");
		this.clock.tick(500);
		assert.strictEqual(spy.callCount, 0, "showValueHelp = false: Tap has been fired and no Value Help Request is submitted");

		// case2 ValueHelpOnly is false
		var spy1 = this.spy(),
			oInputVHO1 = new sap.m.Input( {
				showValueHelp: true,
				valueHelpOnly: false,
				enabled: true,
				editable: true,
				valueHelpRequest: spy1
				}),
			oInputIdVHO1 = oInputVHO1.getId();

		// place control
		oInputVHO1.placeAt("content");
		sap.ui.getCore().applyChanges();

		// check if valueHelpOnly class is set in addition to ValueHelp class
		assert.ok(oInputVHO1.$().hasClass("sapMInputVHO") === false, "valueHelponly = false: Outer div has no additional CSS class\"sapMInputVHO\"");

		// Value help event check
		oInputVHO1._$input.focus().trigger("tap");
		this.clock.tick(500);
		assert.strictEqual(spy1.callCount, 0, "valueHelponly = false: Tap has been fired and no Value Help Request is submitted");

		// case3: Editable is false
		var spy2 = this.spy(),
			oInputVHO2 = new sap.m.Input( {
				showValueHelp: true,
				valueHelpOnly: true,
				enabled: true,
				editable: false,
				valueHelpRequest: spy2
				}),
			oInputIdVHO2 = oInputVHO2.getId();

		// place control
		oInputVHO2.placeAt("content");
		sap.ui.getCore().applyChanges();

		// check if valueHelpOnly class is set in addition to ValueHelp class
		assert.ok(oInputVHO2.$().hasClass("sapMInputVHO") === false, "editable = false: Outer div has no additional CSS class\"sapMInputVHO\"");

		// Value help event check
		oInputVHO2._$input.focus().trigger("tap");
		this.clock.tick(500);
		assert.strictEqual(spy2.callCount, 0, "editable = false: Tap has been fired and no Value Help Request is submitted");

		// case4: Enabled is false
		var spy3 = this.spy(),
			oInputVHO3 = new sap.m.Input( {
				showValueHelp: true,
				valueHelpOnly: true,
				enabled: false,
				editable: true,
				valueHelpRequest: spy3
				}),
			oInputIdVHO3 = oInputVHO3.getId();

		// place control
		oInputVHO3.placeAt("content");
		sap.ui.getCore().applyChanges();

		// check if valueHelpOnly class is set in addition to ValueHelp class
		assert.ok(oInputVHO3.$().hasClass("sapMInputVHO") === false, "enabled = false: Outer div has no additional CSS class\"sapMInputVHO\"");

		// Value help event check
		oInputVHO3._$input.focus().trigger("tap");
		this.clock.tick(500);
		assert.strictEqual(spy3.callCount, 0, "enabled = false: Tap has been fired and no Value Help Request is submitted");
	});

	QUnit.test("Keyboard Handling for ValueHelpOnly", function(assert) {
		//Event check for Enter and Space
		var evt = jQuery.Event("sapselect"),

		spy = this.spy(),
		oInput = new sap.m.Input( {
			showValueHelp: true,
			valueHelpOnly: true,
			valueHelpRequest: spy
		});
		oInput.onsapselect(evt);
		assert.strictEqual(spy.callCount, 1, "The value help was requested by pressing Enter or Space");
	});

	QUnit.module("Destroy");

	QUnit.test("Destroy DOM", function(assert) {
		var oInput = new sap.m.Input({
			showSuggestion: false
		}),
		$Input;

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();
		$Input = oInput.$();

		assert.strictEqual($Input.length, 1, "Before destroy input is rendered in DOM");
		oInput.destroy();
		$Input = oInput.$();

		assert.strictEqual($Input.length, 0, "After destroy input DOM node is removed");
	});

	QUnit.test("Destroy Suggestion List and Popup", function(assert) {
		var oInput = new sap.m.Input({
				showSuggestion: true
			}),
			$Input,
			sInputId = oInput.getId();

		var aData = [
				{name: "Dente, Al", userid: "U01"},
				{name: "Friese, Andy", userid: "U02"},
				{name: "Mann, Anita", userid: "U03"},
				{name: "Schutt, Doris", userid: "U04"},
				{name: "Open, Doris", userid: "U05"},
				{name: "Dewit, Kenya", userid: "U06"},
				{name: "Zar, Lou", userid: "U07"},
				{name: "Burr, Tim", userid: "U08"},
				{name: "Hughes, Tish", userid: "U09"},
				{name: "Town, Mo", userid: "U10"},
				{name: "Case, Justin", userid: "U11"},
				{name: "Time, Justin", userid: "U12"},
				{name: "Barr, Sandy", userid: "U13"},
				{name: "Poole, Gene", userid: "U14"},
				{name: "Ander, Corey", userid: "U15"},
				{name: "Early, Brighton", userid: "U16"},
				{name: "Noring, Constance", userid: "U17"},
				{name: "O'Lantern, Jack", userid: "U18"},
				{name: "Tress, Matt", userid: "U19"},
				{name: "Turner, Paige", userid: "U20"}
			];

		var oModel = new sap.ui.model.json.JSONModel();
		oModel.setData(aData);

		oInput.setModel(oModel);
		oInput.bindAggregation("suggestionItems", "/", new sap.ui.core.Item({text: "{name}"}));

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();
		$Input = oInput.$();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("De").trigger("input");
		this.clock.tick(300);

		oInput.destroy();

		assert.ok(oInput._oList === null || oInput._oList === undefined, "The internal list is destroyed");
		assert.ok(oInput._oSuggestionPopup === null || oInput._oSuggestionPopup === undefined, "The internal popup is destroyed");
	});

	QUnit.module("Suggestions");

	QUnit.test("Suggestions deactivated and aggregations are not filled - list and popup should not be initialized", function(assert){
		var oInput = new sap.m.Input({
				showSuggestion: false
			}),
			$Input,
			i;

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();
		$Input = oInput.$();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("abc").trigger("input");
		this.clock.tick(300);

		// suggestions are not active, list and popup should not be initialized
		assert.strictEqual(oInput._oList, undefined, "The internal list is not initialzed when suggestions are set to false");
		assert.strictEqual(oInput._oSuggestionPopup, undefined, "The internal popup is not initialzed when suggestions are set to false");

		oInput.destroy();
	});

	QUnit.test("Suggestion on Desktop", function(assert){
		var $Input = oInput6.$(),
			oPopup, // is lazy loaded
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i;

		oInput6.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput6.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput6.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput6._$input.focus().val("abc").trigger("input");

		this.clock.tick(300);

		oPopup = oInput6._oSuggestionPopup;
		assert.ok(oPopup instanceof sap.m.Popover, "Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");
		assert.equal(oPopup.getContent()[0].getItems().length, aNames.length, "Suggestions are inserted");
		assert.ok(oPopup.getContent()[0] instanceof sap.m.List, "Suggestions are list-based)");

		oInput6._$input.focus().val("abcT").trigger("input");
		this.clock.tick(400);
		assert.ok(oPopup.isOpen(), "Suggestion Popup is still open now");
		assert.equal(oPopup.getContent()[0].getItems().length, 1, "Suggestions are filtered");

		//close the popoup when nothing is typed in input
		oInput6._$input.focus().val("").trigger("input");
		this.clock.tick(300);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");
		assert.equal(oPopup.getContent()[0].getItems().length, 0, "Suggestions are destroyed");

		oInput6.destroy();
	});

	QUnit.test("Suggestion on Desktop - enter key pressed before the first suggest event", function(assert){
		var oInput = new sap.m.Input({
				showSuggestion: true
			}),
			$Input,
			oPopup, // is lazy loaded
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i,
			oSpy = this.spy();

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();
		$Input = oInput.$();

		oInput.attachSuggest(oSpy);

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("abc").trigger("input");
		// Enter key is pressed directly after typing "abc"
		sap.ui.test.qunit.triggerKeyboardEvent(oInput._$input[0], jQuery.sap.KeyCodes.ENTER);

		this.clock.tick(300);

		assert.equal(oSpy.callCount, 0, "Suggest event listener shouldn't be called")

		oInput.destroy();
	});

	QUnit.test("Suggestion on Desktop - Close with enter key", function(assert){
		var oSystem = {
				desktop: true,
				phone: false,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var oPopup, // is lazy loaded
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i;

		var oInput = new sap.m.Input({
			showSuggestion: true,
			suggest: function(){
				for(i = 0 ; i < aNames.length ; i++){
					if(jQuery.inArray(aNames[i], aItemAdded) === -1){
						oInput.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
						aItemAdded.push(aNames[i]);
					}
				}
			}
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("abc").trigger("input");

		this.clock.tick(300);

		oPopup = oInput._oSuggestionPopup;
		assert.ok(oPopup instanceof sap.m.Popover, "Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");

		sap.ui.test.qunit.triggerKeyboardEvent(oInput.getDomRef(), jQuery.sap.KeyCodes.ENTER);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup should be closed");

		oInput.destroy();
	});

	QUnit.test("Suggestion on Desktop with change event handler", function(assert){
		var fnCallback = this.spy(),
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i;

		var oInput = new sap.m.Input({
			showSuggestion: true,
			change: fnCallback
		});

		// stub the returnObject function from ObjectPool.prototype in order to trace the event parameter
		this.stub(sap.ui.base.ObjectPool.prototype, "returnObject", function(){});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("abc").trigger("input");

		this.clock.tick(300);

		oPopup = oInput._oSuggestionPopup;
		assert.ok(oPopup instanceof sap.m.Popover, "Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");

		var oItem = oInput._oSuggestionPopup.getContent()[0].getItems()[0];
		assert.ok(oItem, "Item should be created");

		oItem.focus();
		oItem.$().trigger("tap");

		this.clock.tick(50);

		assert.equal(fnCallback.callCount, 1, "change event handler only called once");
		var spyCall = fnCallback.getCall(0);
		assert.equal(spyCall.args[0].getParameter("value"), "abcTom", "change event fired with the right parameter");
		oInput.destroy();
	});

	QUnit.test("Suggestion on Desktop with change event handler (focus on next input)", function(assert){
		var fnCallback = this.spy(),
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i;

		var oInput = new sap.m.Input({
			showSuggestion: true,
			change: fnCallback
		});

		var oNextInput = new sap.m.Input();

		// stub the returnObject function from ObjectPool.prototype in order to trace the event parameter
		this.stub(sap.ui.base.ObjectPool.prototype, "returnObject", function(){});

		oInput.placeAt("content");
		oNextInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("abc").trigger("input");

		this.clock.tick(300);

		oPopup = oInput._oSuggestionPopup;
		assert.ok(oPopup instanceof sap.m.Popover, "Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");

		oNextInput.focus();

		assert.equal(fnCallback.callCount, 1, "change event handler only called once");
		var spyCall = fnCallback.getCall(0);
		assert.equal(spyCall.args[0].getParameter("value"), "abc", "change event fired with the right parameter");
		oInput.destroy();
		oNextInput.destroy();
	});

	QUnit.test("Two Value Suggestion on Desktop", function(assert){
		var $Input = oInput7.$(),
			oPopup1,
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aDescription = ["Heidelberg", "Mannheim", "Paris"],
			aItemAdded = [],
			i;

		oInput7.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput7.addSuggestionItem(new sap.ui.core.ListItem({text: aNames[i], additionalText: aDescription[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput7.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput7._$input.focus().val("abc").trigger("input");

		this.clock.tick(300);
		oPopup1 = oInput7._oSuggestionPopup;

		assert.ok(oPopup1 instanceof sap.m.Popover, "Two Value Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup1.isOpen(), "Two Value Suggestion Popup is open now");
		assert.equal(oPopup1.getContent()[0].getItems().length, aNames.length, "Suggestions are inserted");
		assert.ok(oPopup1.getContent()[0].getItems()[0] instanceof sap.m.DisplayListItem, "Suggestion item is a DisplayListItem");

		oInput7._$input.focus().val("abcT").trigger("input");
		this.clock.tick(400);
		assert.ok(oPopup1.isOpen(), "Two Value Suggestion Popup is still open now");
		assert.equal(oPopup1.getContent()[0].getItems().length, 1, "Suggestions are filtered");

		//trigger selection
		var oList = oPopup1.getContent()[0];
		var oListItem = oList.getItems()[0];
		oList.fireItemPress({
			listItem : oListItem
		});

		assert.ok(!oPopup1.isOpen(), "Two Value Suggestion Popup is closed");
		assert.equal(oInput7.getValue(), aNames[0], "Input value is set to first value of selected suggestion item");

		//close the popoup when nothing is typed in input
		oInput7._$input.focus().val("").trigger("input");
		this.clock.tick(300);
		assert.ok(!oPopup1.isOpen(), "Two Value Suggestion Popup is closed");
		assert.equal(oPopup1.getContent()[0].getItems().length, 0, "Suggestions are destroyed");

		oInput7.destroy();
	});

	QUnit.test("Two Value Suggestions with disabled items on Desktop", function(assert){
		var $Input,
			oPopup,
			aNames = ["abcTom", "abcPhilips", "abcAnna", "abcJames"],
			aDescription = ["Heidelberg", "Mannheim", "Paris", "London"],
			aEnabled = [true, false, true, false],
			aItemAdded = [],
			i;

		oInput = new sap.m.Input("input", {
			showSuggestion: true
		});
		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		$Input = oInput.$();
		oInput.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput.addSuggestionItem(new sap.ui.core.ListItem({text: aNames[i], additionalText: aDescription[i], enabled: aEnabled[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("abc").trigger("input");

		this.clock.tick(300);
		oPopup = oInput._oSuggestionPopup;

		assert.ok(oPopup instanceof sap.m.Popover, "Two Value Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Two Value Suggestion Popup is open now");
		assert.equal(oPopup.getContent()[0].getItems().length, aNames.length, "Suggestions are inserted");
		assert.ok(oPopup.getContent()[0].getItems()[0] instanceof sap.m.DisplayListItem, "Suggestion item is a DisplayListItem");

		this.clock.tick(400);
		assert.ok(oPopup.isOpen(), "Two Value Suggestion Popup is still open now");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN);
		assert.ok(oInput._oList.getItems()[0].$().hasClass("sapMLIBSelected"), "The first item is selected after pressing keyDown once");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN);
		assert.ok(oInput._oList.getItems()[2].$().hasClass("sapMLIBSelected"), "The third item is selected after pressing keyDown twice");
		assert.ok(!oInput._oList.getItems()[1].$().hasClass("sapMLIBSelected"), "The second item is not selected because it is disabled");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN);
		assert.ok(oInput._oList.getItems()[2].$().hasClass("sapMLIBSelected"), "The third item is still selected after pressing keyDown three times");
		assert.ok(!oInput._oList.getItems()[3].$().hasClass("sapMLIBSelected"), "The fourth item is not selected because it is disabled");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_UP);
		assert.ok(oInput._oList.getItems()[0].$().hasClass("sapMLIBSelected"), "The first item is now selected after pressing keyUp once");
		assert.ok(!oInput._oList.getItems()[1].$().hasClass("sapMLIBSelected"), "The second item is not selected because it is disabled");

		oInput.destroy();
	});

	// this test ensured downward compatibility: ColumnListItem has default type "Inactive" but still does need to be selected
	QUnit.test("Tabular Suggestions with type=\"Inactive\"", function(assert){
		var oInput = new sap.m.Input({
			showSuggestion: true,
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Left",
					header: new sap.m.Label({
						text: "{i18n>/Name}"
					})
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "qty",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Qty}"
					}),
					minScreenWidth : "Tablet",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "limit",
					width : "30%",
					header : new sap.m.Label({
						text : "{i18n>/Value}"
					}),
					minScreenWidth : "XXSmall",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Right",
					styleClass : "price",
					width : "30%",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Price}"
					}),
					minScreenWidth : "400px",
					demandPopin : true
				})
			]}),
			oInputId = oInput.getId();

		var oTableItemTemplate = new sap.m.ColumnListItem({
			type : "Inactive",
			vAlign : "Middle",
			cells : [
				new sap.m.Label({
					text : "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text : "{price}"
				})
			]
		});

		// data for tabular suggestions
		var oSuggestionData = {
			tabularSuggestionItems : [{
				name : "Product1",
				qty : "10 EA",
				limit : "15.00 Eur",
				price : "10.00 EUR"
			}, {
				name : "Product2",
				qty : "9 EA",
				limit : "25.00 Eur",
				price : "20.00 EUR"
			}, {
				name : "Product3",
				qty : "8 EA",
				limit : "35.00 Eur",
				price : "30.00 EUR"
			}]
		};

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		var	$Input = oInput.$(),
			oPopup, // is lazy loaded
			aAlreadyAddedProducts = [],
			i;

		oInput.attachSuggest(function() {
			oInput.destroySuggestionRows();

			assert.strictEqual(oTableItemTemplate.getType(), sap.m.ListType.Inactive, "The type of the template item is \"Inactive\" (default value)");
			for(i = 0 ; i < oSuggestionData.tabularSuggestionItems.length ; i++){
				oSuggestionRow = oTableItemTemplate.clone();
				oSuggestionRow.getCells()[0].setText(oSuggestionData.tabularSuggestionItems[i].name);
				oSuggestionRow.getCells()[1].setText(oSuggestionData.tabularSuggestionItems[i].qty);
				oSuggestionRow.getCells()[2].setText(oSuggestionData.tabularSuggestionItems[i].limit);
				oSuggestionRow.getCells()[3].setText(oSuggestionData.tabularSuggestionItems[i].price);
				oInput.addSuggestionRow(oSuggestionRow);
			}

			assert.strictEqual(oInput.getSuggestionRows()[0].getType(), sap.m.ListType.Active, "Even if the type of the suggestionRow item is \"Inactive\" it is set to active by the control");
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("Prod").trigger("input");

		this.clock.tick(300);
		oPopup = oInput._oSuggestionPopup;

		assert.ok(oPopup instanceof sap.m.Popover, "Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN);
		assert.ok(oInput._oList.getItems()[0].$().hasClass("sapMLIBSelected"), "The first item is selected after pressing keyDown once");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN);
		assert.ok(oInput._oList.getItems()[1].$().hasClass("sapMLIBSelected"), "The second item is selected after pressing keyDown twice");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_DOWN);
		assert.ok(oInput._oList.getItems()[2].$().hasClass("sapMLIBSelected"), "The third item is selected after pressing keyDown three times");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_UP);
		assert.ok(oInput._oList.getItems()[1].$().hasClass("sapMLIBSelected"), "The second item is selected after pressing keyUp once");

		sap.ui.test.qunit.triggerKeydown(oInput.getDomRef(), jQuery.sap.KeyCodes.ARROW_UP);
		assert.ok(oInput._oList.getItems()[0].$().hasClass("sapMLIBSelected"), "The first item is selected after pressing keyUp twice");

		//close the popoup when nothing is typed in input
		oInput._$input.focus().val("").trigger("input");
		this.clock.tick(300);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");

		oInput.destroy();
	});

	QUnit.test("Suggestion on Phone", function(assert){

		if (sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version < 11) {
			assert.ok(true, "Do not test phone functionality in unsupported versions of Internet Explorer");
			return;
		}

		var oSystem = {
				desktop: false,
				phone: true,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var oInput = new sap.m.Input({
				showSuggestion: true
			}),
			oPopup, // is lazy loaded
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i;

		oInput.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().trigger("click");
		this.clock.tick(500);

		oPopup = oInput._oSuggestionPopup;
		assert.ok(oPopup instanceof sap.m.Dialog, "Suggestion Popup is created and is a Dialog instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");

		oInput._oPopupInput._$input.focus().val("abc").trigger("input");
		this.clock.tick(400);
		assert.equal(oPopup.getContent()[0].getItems().length, aNames.length, "Suggestions are inserted");

		oInput._oPopupInput._$input.focus().val("abcT").trigger("input");
		this.clock.tick(400);
		assert.ok(oPopup.isOpen(), "Suggestion Popup is still open now");
		assert.equal(oPopup.getContent()[0].getItems().length, 1, "Suggestions are filtered");

		oInput._oPopupInput._$input.focus().val("").trigger("input");
		this.clock.tick(400);
		assert.ok(oPopup.isOpen(), "Suggestion Popup is still open now");
		assert.equal(oPopup.getContent()[0].getItems().length, 0, "Suggestions are destroyed");

		oInput._oPopupInput._$input.focus().val("abc").trigger("input");
		this.clock.tick(400);

		sap.ui.test.qunit.triggerTouchEvent("tap", oPopup.getContent()[0].getItems()[1].getDomRef());
		this.clock.tick(500);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");
		assert.equal(oInput.getValue(), aNames[1], "Value is set to originalInput");

		oInput.destroy();
	});

	QUnit.test("Suggestion on Phone with changing the input value in SuggestionItemSelected event handler", function(assert){

		if (sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version < 11) {
			assert.ok(true, "Do not test phone functionality in unsupported versions of Internet Explorer");
			return;
		}

		var oSystem = {
				desktop: false,
				phone: true,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var oInput = new sap.m.Input({
				showSuggestion: true,
				suggestionItemSelected: function(){
					oInput.setValue("newValue");
				}
			}),
			oPopup, // is lazy loaded
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aItemAdded = [],
			i;

		oInput.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput.addSuggestionItem(new sap.ui.core.Item({text: aNames[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().trigger("click");
		this.clock.tick(500);

		oPopup = oInput._oSuggestionPopup;

		oInput._oPopupInput._$input.focus().val("abc").trigger("input");
		this.clock.tick(400);
		sap.ui.test.qunit.triggerTouchEvent("tap", oPopup.getContent()[0].getItems()[1].getDomRef());
		this.clock.tick(500);
		assert.equal(oInput.getValue(), "newValue", "Value is last modified by the suggestionItemSelected event listener");

		oInput.destroy();
	});

	QUnit.test("Two value Suggestion on Phone", function(assert){

		if (sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version < 11) {
			assert.ok(true, "Do not test phone functionality in unsupported versions of Internet Explorer");
			return;
		}

		var oSystem = {
				desktop: false,
				phone: true,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var oInput = new sap.m.Input({
				showSuggestion: true
			}),
			oPopup,
			aNames = ["abcTom", "abcPhilips", "abcAnna"],
			aDescription = ["Heidelberg", "Mannheim", "Paris"],
			aItemAdded = [],
			i;

		oInput.attachSuggest(function(){
			for(i = 0 ; i < aNames.length ; i++){
				if(jQuery.inArray(aNames[i], aItemAdded) === -1){
					oInput.addSuggestionItem(new sap.ui.core.ListItem({text: aNames[i], additionalText: aDescription[i]}));
					aItemAdded.push(aNames[i]);
				}
			}
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput._$input.focus().trigger("click");
		this.clock.tick(500);
		oPopup = oInput._oSuggestionPopup;

		assert.ok(oPopup instanceof sap.m.Dialog, "Two value Suggestion Popup is created and is a Dialog instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");

		oInput._oPopupInput._$input.focus().val("abc").trigger("input");
		this.clock.tick(400);
		assert.equal(oPopup.getContent()[0].getItems().length, aNames.length, "Suggestions are inserted");

		oInput._oPopupInput._$input.focus().val("abcT").trigger("input");
		this.clock.tick(400);
		assert.ok(oPopup.isOpen(), "Two value Suggestion Popup is still open now");
		assert.equal(oPopup.getContent()[0].getItems().length, 1, "Suggestions are filtered");

		oInput._oPopupInput._$input.focus().val("").trigger("input");
		this.clock.tick(400);
		assert.ok(oPopup.isOpen(), "Two value Suggestion Popup is still open now");
		assert.equal(oPopup.getContent()[0].getItems().length, 0, "Suggestions are destroyed");

		oInput._oPopupInput._$input.focus().val("abc").trigger("input");
		this.clock.tick(400);

		sap.ui.test.qunit.triggerTouchEvent("tap", oPopup.getContent()[0].getItems()[1].getDomRef());
		this.clock.tick(500);
		assert.ok(!oPopup.isOpen(), "Two value Suggestion Popup is closed");
		assert.equal(oInput.getValue(), aNames[1], "Value is set to originalInput");

		oInput.destroy();
	});

	QUnit.test("Suggestion with liveChange handler on phone", function(assert){

		if (sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version < 11) {
			assert.ok(true, "Do not test phone functionality in unsupported versions of Internet Explorer");
			return;
		}

		var fnLC1 = this.spy();

		var oSystem = {
				desktop: false,
				phone: true,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var oInput = new sap.m.Input({
			showSuggestion: true,
			liveChange: fnLC1
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().trigger("click");
		this.clock.tick(500);

		oInput._oPopupInput._$input.focus().val("abc").trigger("input");;

		assert.equal(fnLC1.callCount, 1, "liveChange handler on original input is called");

		oInput.destroy();
	});

	QUnit.test("SuggestionPopup shouldn't invalidate when insert suggest item on phone", function(assert){

		if (sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version < 11) {
			assert.ok(true, "Do not test phone functionality in unsupported versions of Internet Explorer");
			return;
		}

		var oSystem = {
				desktop: false,
				phone: true,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var oInput = new sap.m.Input({
			showSuggestion: true,
			suggest: function(oEvent) {
				var sValue = oEvent.getParameter("suggestValue");
				if (sValue) {
					this.addSuggestionItem(new sap.ui.core.Item({
						text: sValue
					}));
				}
			}
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().trigger("click");
		this.clock.tick(500);

		var oSpy = this.spy(oInput._oSuggestionPopup, "invalidate");
		oInput._oPopupInput._$input.focus().val("abc").trigger("input");;
		this.clock.tick(400);

		assert.equal(oInput.getSuggestionItems().length, 1, "Suggestion Item is inserted");
		assert.equal(oSpy.callCount, 0, "invalidate isn't called on dialog instance");

		oInput.destroy();
	});

	QUnit.test("Tabular Suggestions on Desktop", function(assert){
		var oMessageBundle = sap.ui.getCore().getLibraryResourceBundle("sap.m");

		var oInput = new sap.m.Input({
			width: "100px",
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Left",
					header: new sap.m.Label({
						text: "{i18n>/Name}"
					})
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "qty",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Qty}"
					}),
					minScreenWidth : "Tablet",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "limit",
					width : "30%",
					header : new sap.m.Label({
						text : "{i18n>/Value}"
					}),
					minScreenWidth : "XXSmall",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Right",
					styleClass : "price",
					width : "30%",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Price}"
					}),
					minScreenWidth : "400px",
					demandPopin : true
				})
			]}),
			oInputId = oInput.getId();

		var oTableItemTemplate = new sap.m.ColumnListItem({
			vAlign : "Middle",
			cells : [
				new sap.m.Label({
					text : "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text : "{price}"
				})
			]
		});

		// data for tabular suggestions
		var oSuggestionData = {
			tabularSuggestionItems : [{
				name : "Product1",
				qty : "10 EA",
				limit : "15.00 Eur",
				price : "10.00 EUR"
			}, {
				name : "Product2",
				qty : "9 EA",
				limit : "25.00 Eur",
				price : "20.00 EUR"
			}, {
				name : "Product3",
				qty : "8 EA",
				limit : "35.00 Eur",
				price : "30.00 EUR"
			}]
		};

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		// this tests calling the setter of showSuggestion after input is rendered
		oInput.setShowSuggestion(true);
		sap.ui.getCore().applyChanges();

		var	$Input = oInput.$(),
			oPopup, // is lazy loaded
			aAlreadyAddedProducts = [],
			i;

		oInput.attachSuggest(function() {
			oInput.destroySuggestionRows();
			for(i = 0 ; i < oSuggestionData.tabularSuggestionItems.length ; i++){
				if(jQuery.inArray(oSuggestionData.tabularSuggestionItems[i], aAlreadyAddedProducts) === -1){
					oSuggestionRow = oTableItemTemplate.clone();
					oSuggestionRow.getCells()[0].setText(oSuggestionData.tabularSuggestionItems[i].name);
					oSuggestionRow.getCells()[1].setText(oSuggestionData.tabularSuggestionItems[i].qty);
					oSuggestionRow.getCells()[2].setText(oSuggestionData.tabularSuggestionItems[i].limit);
					oSuggestionRow.getCells()[3].setText(oSuggestionData.tabularSuggestionItems[i].price);
					oInput.addSuggestionRow(oSuggestionRow);
					aAlreadyAddedProducts.push(oSuggestionData.tabularSuggestionItems[i].name);
				}
			}
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("Prod").trigger("input");

		this.clock.tick(300);
		oPopup = oInput._oSuggestionPopup;

		assert.ok(oPopup instanceof sap.m.Popover, "Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");

		assert.ok(!oInput._oList.hasStyleClass("sapMInputSuggestionTableHidden"), "Tabular suggestions table initially has not the hidden style class");

		assert.equal(oPopup.getContent()[0].getItems().length, oSuggestionData.tabularSuggestionItems.length, "Suggestions are inserted");
		assert.strictEqual(oPopup.getContent()[0].$().length, 1, "Suggestion table is rendered");
		assert.ok(oPopup.getContent()[0] instanceof sap.m.Table, "Suggestions are tabular)");
		assert.strictEqual(oPopup.getContentWidth(), "100px", "Suggestion popup has 100px width");

		oInput._$input.focus().val("Product1").trigger("input");
		this.clock.tick(400);

		assert.ok(!oInput._oList.hasStyleClass("sapMInputSuggestionTableHidden"), "Tabular suggestions table does not have the hidden style class on desktop");

		assert.ok(oPopup.isOpen(), "Suggestion Popup is still open now");
		// FIXME: check doesn't work in headless PhantomJS test cycle => commented out!
		if (!sap.ui.Device.browser.phantomJS) {
			assert.equal(oPopup.getContent()[0].$().find("tbody").children(":visible").length, 1, "Suggestions are filtered");
		}

		// checks for the show more button (tabular suggestions only)
		assert.strictEqual(oPopup.getFooter().getContent().length, 2, "The footer has two items (spacer and button)");
		assert.strictEqual(oPopup.getFooter().getContent()[1] instanceof sap.m.Button, true, "The show more button is added to the popup");
		assert.strictEqual(oPopup.getFooter().getContent()[1].getText(), oMessageBundle.getText("INPUT_SUGGESTIONS_SHOW_ALL"), "The show more button shows the correct text from the message bundle");

		//close the popoup when nothing is typed in input
		oInput._$input.focus().val("").trigger("input");
		this.clock.tick(300);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");

		oInput.destroy();
	});

	QUnit.test("Tabular Suggestions invalidation handling", function(assert){
		var oInput = new sap.m.Input({
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Left",
					header: new sap.m.Label({
						text: "{i18n>/Name}"
					})
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "qty",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Qty}"
					}),
					minScreenWidth : "Tablet",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "limit",
					width : "30%",
					header : new sap.m.Label({
						text : "{i18n>/Value}"
					}),
					minScreenWidth : "XXSmall",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Right",
					styleClass : "price",
					width : "30%",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Price}"
					}),
					minScreenWidth : "400px",
					demandPopin : true
				})
			]}),
			oInputId = oInput.getId(),
			oInputRendererSpy;

		var oTableItemTemplate = new sap.m.ColumnListItem({
			vAlign : "Middle",
			cells : [
				new sap.m.Label({
					text : "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text : "{price}"
				})
			]
		});

		// data for tabular suggestions
		var oSuggestionData = {
			tabularSuggestionItems : [{
				name : "Product1",
				qty : "10 EA",
				limit : "15.00 Eur",
				price : "10.00 EUR"
			}, {
				name : "Product2",
				qty : "9 EA",
				limit : "25.00 Eur",
				price : "20.00 EUR"
			}, {
				name : "Product3",
				qty : "8 EA",
				limit : "35.00 Eur",
				price : "30.00 EUR"
			}]
		};

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		// this tests calling the setter of showSuggestion after input is rendered
		oInput.setShowSuggestion(true);
		sap.ui.getCore().applyChanges();

		var	$Input = oInput.$(),
			oPopup, // is lazy loaded
			aAlreadyAddedProducts = [],
			i;

		oInput.attachSuggest(function() {
			oInput.destroySuggestionRows();
			for(i = 0 ; i < oSuggestionData.tabularSuggestionItems.length ; i++){
				if(jQuery.inArray(oSuggestionData.tabularSuggestionItems[i], aAlreadyAddedProducts) === -1){
					oSuggestionRow = oTableItemTemplate.clone();
					oSuggestionRow.getCells()[0].setText(oSuggestionData.tabularSuggestionItems[i].name);
					oSuggestionRow.getCells()[1].setText(oSuggestionData.tabularSuggestionItems[i].qty);
					oSuggestionRow.getCells()[2].setText(oSuggestionData.tabularSuggestionItems[i].limit);
					oSuggestionRow.getCells()[3].setText(oSuggestionData.tabularSuggestionItems[i].price);
					oInput.addSuggestionRow(oSuggestionRow);
					aAlreadyAddedProducts.push(oSuggestionData.tabularSuggestionItems[i].name);
				}
			}
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("Prod").trigger("input");

		this.clock.tick(300);
		oPopup = oInput._oSuggestionPopup;

		// set up a spy on the dialog's renderer (the dialog should not be rerendered)
		oInputRendererSpy = sinon.spy(sap.m.InputRenderer, "render");

		assert.ok(oPopup instanceof sap.m.Popover, "Suggestion Popup is created and is a Popover instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");
		assert.equal(oPopup.getContent()[0].getItems().length, oSuggestionData.tabularSuggestionItems.length, "Suggestions are inserted");
		assert.strictEqual(oPopup.getContent()[0].$().length, 1, "Suggestion table is rendered");
		assert.ok(oPopup.getContent()[0] instanceof sap.m.Table, "Suggestions are tabular)");

		oInput._$input.focus().val("Product1").trigger("input");
		this.clock.tick(400);

		// check for re-rendering when changing the "suggestionRows" aggregation
		assert.strictEqual(oInputRendererSpy.callCount, 0, "the input field is not re-rendered when suggestions are inserted or removed");

		// check for re-rendering when changing "showTableSuggestionValueHelp" property
		oInput.setShowTableSuggestionValueHelp(false);
		assert.strictEqual(oInputRendererSpy.callCount, 0, "the input field is not re-rendered when property \"showTableSuggestionValueHelp\" is changed");
		oInput.setShowTableSuggestionValueHelp(true);
		assert.strictEqual(oInputRendererSpy.callCount, 0, "the input field is not re-rendered when property \"showTableSuggestionValueHelp\" is changed");


		assert.ok(oPopup.isOpen(), "Suggestion Popup is still open now");
		// FIXME: check doesn't work in headless PhantomJS test cycle => commented out!
		if (!sap.ui.Device.browser.phantomJS) {
			assert.equal(oPopup.getContent()[0].$().find("tbody").children(":visible").length, 1, "Suggestions are filtered");
		}

		//close the popoup when nothing is typed in input
		oInput._$input.focus().val("").trigger("input");
		this.clock.tick(300);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");

		// check for re-rendering when changing "showSuggestion" property
		oInput.setShowSuggestion(false);
		assert.strictEqual(oInputRendererSpy.callCount, 0, "the input field is not re-rendered when property \"showSuggestion\" is changed");
		oInput.setShowSuggestion(true);
		assert.strictEqual(oInputRendererSpy.callCount, 0, "the input field is not re-rendered when property \"showSuggestion\" is changed");

		oInput.destroy();
	});

	QUnit.test("Tabular Suggestion on Phone", function(assert){

		if (sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version < 11) {
			assert.ok(true, "Do not test phone functionality in unsupported versions of Internet Explorer");
			return;
		}
		var oMessageBundle = sap.ui.getCore().getLibraryResourceBundle("sap.m");

		var bPhantomJS = sap.ui.Device.browser.phantomJS;

		var oSystem = {
				desktop: false,
				phone: true,
				tablet: false
			}

		this.stub(sap.ui.Device, "system", oSystem);

		//test was failing inside ie9, because popup does special handling for this case
		this.stub(sap.ui.Device, "browser", {
			internet_explorer : false
		});

		var oInput = new sap.m.Input({
			showSuggestion: true,
			width: "100px",
			maxSuggestionWidth: "500px",
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Left",
					header: new sap.m.Label({
						text: "{i18n>/Name}"
					})
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "qty",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Qty}"
					}),
					minScreenWidth : "Tablet",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "limit",
					width : "30%",
					header : new sap.m.Label({
						text : "{i18n>/Value}"
					}),
					minScreenWidth : "XXSmall",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Right",
					styleClass : "price",
					width : "30%",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Price}"
					}),
					minScreenWidth : "400px",
					demandPopin : true
				})
			]}),
			oInputId = oInput.getId();

		var oTableItemTemplate = new sap.m.ColumnListItem({
			vAlign : "Middle",
			cells : [
				new sap.m.Label({
					text : "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text : "{price}"
				})
			]
		});

		// data for tabular suggestions
		var oSuggestionData = {
			tabularSuggestionItems : [{
				name : "Product1",
				qty : "10 EA",
				limit : "15.00 Eur",
				price : "10.00 EUR"
			}, {
				name : "Product2",
				qty : "9 EA",
				limit : "25.00 Eur",
				price : "20.00 EUR"
			}, {
				name : "Product3",
				qty : "8 EA",
				limit : "35.00 Eur",
				price : "30.00 EUR"
			}]
		};

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		var	$Input = oInput.$(),
			oPopup, // is lazy loaded
			aAlreadyAddedProducts = [],
			oDialogRendererSpy,
			i;

		oInput.attachSuggest(function() {
			oInput.destroySuggestionRows();
			for(i = 0 ; i < oSuggestionData.tabularSuggestionItems.length ; i++){
				if(jQuery.inArray(oSuggestionData.tabularSuggestionItems[i], aAlreadyAddedProducts) === -1){
					oSuggestionRow = oTableItemTemplate.clone();
					oSuggestionRow.getCells()[0].setText(oSuggestionData.tabularSuggestionItems[i].name);
					oSuggestionRow.getCells()[1].setText(oSuggestionData.tabularSuggestionItems[i].qty);
					oSuggestionRow.getCells()[2].setText(oSuggestionData.tabularSuggestionItems[i].limit);
					oSuggestionRow.getCells()[3].setText(oSuggestionData.tabularSuggestionItems[i].price);
					oInput.addSuggestionRow(oSuggestionRow);
					aAlreadyAddedProducts.push(oSuggestionData.tabularSuggestionItems[i].name);
				}
			}
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().trigger("click");
		this.clock.tick(300);

		oPopup = oInput._oSuggestionPopup;
		assert.ok(oPopup instanceof sap.m.Dialog, "Suggestion Popup is created and is a Dialog instance");
		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");


		// set up a spy on the dialog's renderer
		oDialogRendererSpy = sinon.spy(sap.m.DialogRenderer, "render");

		oInput._oPopupInput._$input.focus().val("Product").trigger("input");
		this.clock.tick(400);
		assert.equal(oPopup.getContent()[0].getItems().length, oSuggestionData.tabularSuggestionItems.length, "Suggestions are inserted");
		assert.strictEqual(oDialogRendererSpy.callCount, 1, "Dialog has been renderded after opening");
		assert.ok(!oInput._oList.hasStyleClass("sapMInputSuggestionTableHidden"), "Tabular suggestions table does not have the hidden style class when items are displayed");

		// remove input in between (to check if dialog is not re-rendered, this would cause the soft-keyboard to hide)
		oInput._oPopupInput._$input.focus().val("").trigger("input");
		this.clock.tick(400);
		assert.strictEqual(oDialogRendererSpy.callCount, 1, "Dialog is not re-rendered when changing the input value to empty string");
		assert.ok(oInput._oList.hasStyleClass("sapMInputSuggestionTableHidden"), "Tabular suggestions table has the hidden style class when no items are displayed");

		oInput._oPopupInput._$input.focus().val("Product1").trigger("input");
		this.clock.tick(400);

		assert.ok(oPopup.isOpen(), "Suggestion Popup is still open now123");
		// FIXME: check doesn't work in headless PhantomJS test cycle => commented out!
		if (!bPhantomJS) {
			assert.equal(oPopup.getContent()[0].$().find("tbody").children(":visible").length, 1, "Suggestions are filtered");
		}
		assert.strictEqual(oDialogRendererSpy.callCount, 1, "Dialog is not re-rendered when changing the input value to a another value");
		assert.ok(!oInput._oList.hasStyleClass("sapMInputSuggestionTableHidden"), "Tabular suggestions table does not have the hidden style class when items are displayed");

		// enter a string that is not found in suggestions
		oInput._oPopupInput._$input.focus().val("thisWillNotBeFound").trigger("input");
		this.clock.tick(400);

		assert.ok(oPopup.isOpen(), "Suggestion Popup is still open now");
		assert.ok(oPopup.getContent()[0].getItems().length, "There are invisible suggestion items");
		oPopup.getContent()[0].getItems().forEach(function (oItem) {
			assert.strictEqual(oItem.getVisible(), false, "Item " + oItem.getId() + " is not visible");
		});
		assert.strictEqual(oDialogRendererSpy.callCount, 1, "Dialog is not re-rendered when changing the input value to a another value");
		assert.ok(oInput._oList.hasStyleClass("sapMInputSuggestionTableHidden"), "Tabular suggestions table has the hidden style class when no items are found");

		// filter with a string that will display 3 items
		oInput._oPopupInput._$input.focus().val("Product").trigger("input");
		this.clock.tick(400);

		// FIXME: check doesn't work in headless PhantomJS test cycle => commented out!
		if (!bPhantomJS) {
			assert.equal(oPopup.getContent()[0].$().find("tbody").children().length, 3, "3 suggestions are displayed");
		}
		assert.strictEqual(oDialogRendererSpy.callCount, 1, "Dialog is not re-rendered during filtering of suggestions");
		assert.ok(!oInput._oList.hasStyleClass("sapMInputSuggestionTableHidden"), "Tabular suggestions table does not have the hidden style class when items are displayed");

		// checks for the show more button (tabular suggestions only)
		assert.strictEqual(oPopup.getEndButton() instanceof sap.m.Button, true, "The show more button is added to the popup");
		assert.strictEqual(oPopup.getEndButton().getText(), oMessageBundle.getText("INPUT_SUGGESTIONS_SHOW_ALL"), "The show more button shows the correct text from the message bundle");

		oPopup.getContent()[0].getItems()[1].$().trigger("tap");

		this.clock.tick(300);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");
		assert.equal(oInput.getValue(), oSuggestionData.tabularSuggestionItems[1].name, "Value is set to originalInput");

		oInput.destroy();
	});

	QUnit.test("Tabular Suggestions with custom filter and result fuction", function(assert){
		var oInput = new sap.m.Input({
			showSuggestion: true,
			width: "100px",
			maxSuggestionWidth: "500px",
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Left",
					header: new sap.m.Label({
						text: "{i18n>/Name}"
					})
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "qty",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Qty}"
					}),
					minScreenWidth : "Tablet",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "limit",
					width : "30%",
					header : new sap.m.Label({
						text : "{i18n>/Value}"
					}),
					minScreenWidth : "XXSmall",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Right",
					styleClass : "price",
					width : "30%",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Price}"
					}),
					minScreenWidth : "400px",
					demandPopin : true
				})
			]}),
			oInputId = oInput.getId();

		var oTableItemTemplate = new sap.m.ColumnListItem({
			vAlign : "Middle",
			cells : [
				new sap.m.Label({
					text : "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text : "{price}"
				})
			]
		});

		// data for tabular suggestions
		var oSuggestionData = {
			tabularSuggestionItems : [{
				name : "Product1",
				qty : "10 EA",
				limit : "15.00 Eur",
				price : "10.00 EUR"
			}, {
				name : "Product2",
				qty : "9 EA",
				limit : "25.00 Eur",
				price : "20.00 EUR"
			}, {
				name : "Product3",
				qty : "8 EA",
				limit : "35.00 Eur",
				price : "30.00 EUR"
			}]
		};

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		// custom filter for limit field
		oInput.setFilterFunction(function(sValue, oColumnListItem) {
			var aCells = oColumnListItem.getCells();

			return jQuery.sap.startsWithIgnoreCase(aCells[2].getText(), sValue);
		});

		// custom result function using a string and price
		oInput.setRowResultFunction(function (oColumnListItem) {
			return "You chose: " + oColumnListItem.getCells()[2].getText();
		});

		var	$Input = oInput.$(),
			oPopup, // is lazy loaded
			aAlreadyAddedProducts = [],
			i;

		oInput.attachSuggest(function() {
			oInput.destroySuggestionRows();
			for(i = 0 ; i < oSuggestionData.tabularSuggestionItems.length ; i++){
				if(jQuery.inArray(oSuggestionData.tabularSuggestionItems[i], aAlreadyAddedProducts) === -1){
					oSuggestionRow = oTableItemTemplate.clone();
					oSuggestionRow.getCells()[0].setText(oSuggestionData.tabularSuggestionItems[i].name);
					oSuggestionRow.getCells()[1].setText(oSuggestionData.tabularSuggestionItems[i].qty);
					oSuggestionRow.getCells()[2].setText(oSuggestionData.tabularSuggestionItems[i].limit);
					oSuggestionRow.getCells()[3].setText(oSuggestionData.tabularSuggestionItems[i].price);
					oInput.addSuggestionRow(oSuggestionRow);
					aAlreadyAddedProducts.push(oSuggestionData.tabularSuggestionItems[i].name);
				}
			}
		});

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("25").trigger("input");

		this.clock.tick(300);
		oPopup = oInput._oSuggestionPopup;

		assert.ok(oPopup.isOpen(), "Suggestion Popup is open now");
		// FIXME: check doesn't work in headless PhantomJS test cycle => commented out!
		if (!sap.ui.Device.browser.phantomJS) {
			assert.strictEqual(oPopup.getContent()[0].$().find("tbody").children(":visible").length, 1, "Suggestions are filtered");
		}
		assert.strictEqual(oPopup.getContent()[0].$().find("tbody").find(".name").find("label").html(), oSuggestionData.tabularSuggestionItems[1].name, "Product 2 is filtered");

		// TODO: trigger selection with pseudo-events here
		//oPopup.getContent()[0].getItems()[1].$().trigger("click");
		oPopup.getContent()[0]._fireSelectionChangeEvent([oPopup.getContent()[0].getItems()[1]]);
		this.clock.tick(300);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");
		assert.equal(oInput.getValue(), "You chose: " + oSuggestionData.tabularSuggestionItems[1].limit, "The input value has been formatted with the custom row result function");

		//close the popoup when nothing is typed in input
		oInput._$input.focus().val("").trigger("input");
		this.clock.tick(300);
		assert.ok(!oPopup.isOpen(), "Suggestion Popup is closed");

		oInput.destroy();
	});

	QUnit.test("Property startSuggestion on Desktop (non Zero)",  function(assert) {
		var oSystem = {
				desktop: true,
				phone: false,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var spy = this.spy();

		var oInput = new sap.m.Input({
			showSuggestion: true,
			startSuggestion: 4,
			suggest: spy
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput._$input.focus().val("25").trigger("input");
		this.clock.tick(400);
		assert.equal(spy.callCount, 0, "2 letters shouldn't fire suggest event");

		oInput._$input.focus().val("2524").trigger("input");
		this.clock.tick(400);
		assert.equal(spy.callCount, 1, "4 letters shouldn fire suggest event");

		oInput._$input.focus().val("25245").trigger("input");
		this.clock.tick(400);
		assert.equal(spy.callCount, 2, "5 letters should fire suggest event again");

		oInput.destroy();
	});

	QUnit.test("Property startSuggestion on Desktop (Zero)",  function(assert) {
		var oSystem = {
				desktop: true,
				phone: false,
				tablet: false
			};

		this.stub(sap.ui.Device, "system", oSystem);

		var spy = this.spy();

		var oInput = new sap.m.Input({
			showSuggestion: true,
			startSuggestion: 0,
			suggest: spy
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput._$input.focus();
		this.clock.tick(400);
		assert.equal(spy.callCount, 1, "Focus should fire suggest event");

		oInput._$input.focus().val("25").trigger("input");
		this.clock.tick(400);
		assert.equal(spy.callCount, 2, "2 letters shouldn fire suggest event");

		oInput._$input.blur();
		oInput._$input.focus();
		this.clock.tick(400);
		assert.equal(spy.callCount, 2, "Focus with text in input shouldn't fire suggest event");

		oInput._$input.focus().val("").trigger("input");
		this.clock.tick(400);
		assert.equal(spy.callCount, 3, "no text should fire suggest event again");

		oInput.destroy();
	});

	QUnit.test("The order of setting properties: showValueHelp, bindAggregation and showSuggestion", function(assert){
		var oInput = new sap.m.Input({
			width: "100px",
			maxSuggestionWidth: "500px",
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Left",
					header: new sap.m.Label({
						text: "{i18n>/Name}"
					})
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "qty",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Qty}"
					}),
					minScreenWidth : "Tablet",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "limit",
					width : "30%",
					header : new sap.m.Label({
						text : "{i18n>/Value}"
					}),
					minScreenWidth : "XXSmall",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Right",
					styleClass : "price",
					width : "30%",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Price}"
					}),
					minScreenWidth : "400px",
					demandPopin : true
				})
			]}),
			oInputId = oInput.getId();

		var oTableItemTemplate = new sap.m.ColumnListItem({
			vAlign : "Middle",
			cells : [
				new sap.m.Label({
					text : "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text : "{price}"
				})
			]
		});

		// data for tabular suggestions
		var oSuggestionData = {
			tabularSuggestionItems : [{
				name : "Product1",
				qty : "10 EA",
				limit : "15.00 Eur",
				price : "10.00 EUR"
			}, {
				name : "Product2",
				qty : "9 EA",
				limit : "25.00 Eur",
				price : "20.00 EUR"
			}, {
				name : "Product3",
				qty : "8 EA",
				limit : "35.00 Eur",
				price : "30.00 EUR"
			}]
		};

		var oModel = new sap.ui.model.json.JSONModel().setData(oSuggestionData);

		oInput.setModel(oModel);
		oInput.setShowValueHelp(true);
		oInput.bindSuggestionRows({
			path: "/tabularSuggestionItems",
			template: oTableItemTemplate
		});

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.setShowSuggestion(true);

		assert.ok(oInput._oList, "List instance is created");
		assert.ok(oInput._oSuggestionPopup, "Suggestion Popup instance is created");
		assert.ok(oInput._oSuggestionPopup.getFooter() instanceof sap.m.Toolbar, "Suggestion Popup has Toolbar footer");
		assert.ok(oInput._oSuggestionPopup.getFooter().getContent()[1] instanceof sap.m.Button, "Suggestion Popup has showMoreButton");

		oInput.destroy();
	});

	QUnit.test("The order of setting properties: showValueHelp, showSuggestion after bindAggregation", function(assert){
		var oInput = new sap.m.Input({
			width: "100px",
			maxSuggestionWidth: "500px",
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Left",
					header: new sap.m.Label({
						text: "{i18n>/Name}"
					})
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "qty",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Qty}"
					}),
					minScreenWidth : "Tablet",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Center",
					styleClass : "limit",
					width : "30%",
					header : new sap.m.Label({
						text : "{i18n>/Value}"
					}),
					minScreenWidth : "XXSmall",
					demandPopin : true
				}),
				new sap.m.Column({
					hAlign : "Right",
					styleClass : "price",
					width : "30%",
					popinDisplay : "Inline",
					header : new sap.m.Label({
						text : "{i18n>/Price}"
					}),
					minScreenWidth : "400px",
					demandPopin : true
				})
			]}),
			oInputId = oInput.getId();

		var oTableItemTemplate = new sap.m.ColumnListItem({
			vAlign : "Middle",
			cells : [
				new sap.m.Label({
					text : "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text : "{price}"
				})
			]
		});

		// data for tabular suggestions
		var oSuggestionData = {
			tabularSuggestionItems : [{
				name : "Product1",
				qty : "10 EA",
				limit : "15.00 Eur",
				price : "10.00 EUR"
			}, {
				name : "Product2",
				qty : "9 EA",
				limit : "25.00 Eur",
				price : "20.00 EUR"
			}, {
				name : "Product3",
				qty : "8 EA",
				limit : "35.00 Eur",
				price : "30.00 EUR"
			}]
		};

		var oModel = new sap.ui.model.json.JSONModel().setData(oSuggestionData);

		oInput.setModel(oModel);

		oInput.bindSuggestionRows({
			path: "/tabularSuggestionItems",
			template: oTableItemTemplate
		});
		oInput.setShowValueHelp(true);

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.setShowSuggestion(true);

		assert.ok(oInput._oList, "List instance is created");
		assert.ok(oInput._oSuggestionPopup, "Suggestion Popup instance is created");
		assert.ok(oInput._oSuggestionPopup.getFooter() instanceof sap.m.Toolbar, "Suggestion Popup has Toolbar footer");
		assert.ok(oInput._oSuggestionPopup.getFooter().getContent()[1] instanceof sap.m.Button, "Suggestion Popup has showMoreButton");

		oInput.destroy();
	});

	QUnit.test("Hightlighting", function(assert) {
		var oInput = createInputWithSuggestions();

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("It").trigger("input");

		this.clock.tick(300);

		var $labels = oInput._oSuggestionPopup.$().find('.sapMDLILabel, .sapMSLITitleOnly, .sapMDLIValue');

		assert.ok($labels[0].innerHTML.indexOf('<span') > -1, "Texts is highlighted");

		oInput.destroy();
	});

	QUnit.module("Key and Value");

	function createInputWithSuggestions () {

		var aSuggestionItems = [
			new sap.ui.core.ListItem({
				key: '1',
				text: '1 Item 1',
				additionalText: 'Desc 1'
			}),
			new sap.ui.core.ListItem({
				key: '2',
				text: 'Item 2',
				additionalText: 'Desc 2'
			}),
			new sap.ui.core.ListItem({
				key: '3',
				text: 'Item 3',
				additionalText: 'Desc 3'
			}),
			new sap.ui.core.ListItem({
				key: '4',
				text: 'Item 4',
				additionalText: 'Desc 4'
			}),
			new sap.ui.core.ListItem({
				key: '5',
				text: 'Item 5',
				additionalText: 'Desc 5'
			})
		];

		var oInput = new sap.m.Input({
			showSuggestion: true,
			suggestionItems: aSuggestionItems
		});

		return oInput;
	}

	QUnit.test("Set selection", function(assert) {
		var oInput = createInputWithSuggestions(),
				fnCallback = this.spy();

		oInput.attachSuggestionItemSelected(fnCallback);

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("It").trigger("input");

		this.clock.tick(300);

		var oItem = oInput._oSuggestionPopup.getContent()[0].getItems()[0];
		assert.ok(oItem, "Item should be created");

		oItem.focus();
		oItem.$().trigger("tap");

		this.clock.tick(50);

		assert.equal(fnCallback.callCount, 1, "change event handler only called once");
		assert.equal(oInput.getSelectedKey(), "1", "selected key is correct");

		oInput.destroy();
	});

	QUnit.test("Set selection via API", function(assert) {
		var oInput = createInputWithSuggestions(),
				fnCallback = this.spy();

		oInput.attachSuggestionItemSelected(fnCallback);

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.setSelectedItem(oInput.getSuggestionItems()[1]);

		this.clock.tick(50);

		assert.equal(fnCallback.callCount, 0, "change event is not fired");
		assert.equal(oInput.getSelectedKey(), "2", "selected key is correct");

		oInput.destroy();
	});

	QUnit.test("Display text formatting", function(assert) {
		var oInput = createInputWithSuggestions();

		oInput.setTextFormatMode(sap.m.InputTextFormatMode.ValueKey);

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.setSelectedItem(oInput.getSuggestionItems()[1]);

		var sValue = oInput.getValue();
		assert.equal(sValue, "Item 2 (2)", "value is correctly formatted");

		oInput.setTextFormatter(function (item) {
			return 'Custom: ' + item.getText() + " (" + item.getKey() + ")";
		});

		oInput.setSelectedItem(oInput.getSuggestionItems()[2]);

		var sValue = oInput.getValue();
		assert.equal(sValue, "Custom: Item 3 (3)", "custom formatting is correct");

		oInput.destroy();
	});

	function createInputWithTabularSuggestions () {

		var oSuggestionData = {
			tabularSuggestionItems: [
				{
					id: "1",
					name: "Auch ein gutes Ding",
					qty: "3 EA",
					limit: "99.00 EUR",
					price: "17.00 EUR"
				}, {
					id: "2",
					name: "Besser ist das",
					qty: "1 EA",
					limit: "20.00 EUR",
					price: "13.00 EUR"
				}, {
					id: "3",
					name: "Holter-di-polter",
					qty: "10 EA",
					limit: "15.00 EUR",
					price: "12.00 EUR"
				}, {
					id: "4",
					name: "Ha so was",
					qty: "10 EA",
					limit: "5.00 EUR",
					price: "3.00 EUR"
				}, {
					id: "5",
					name: "Hurra ein Produkt",
					qty: "8 EA",
					limit: "60.00 EUR",
					price: "45.00 EUR"
				}, {
					id: "6",
					name: "Hallo du tolles Ding",
					qty: "2 EA",
					limit: "40.00 EUR",
					price: "15.00 EUR"
				}, {
					id: "7",
					name: "Hier sollte ich zuschlagen",
					qty: "10 EA",
					limit: "90.00 EUR",
					price: "55.00 EUR"
				}, {
					id: "8",
					name: "Hohoho",
					qty: "18 EA",
					limit: "29.00 EUR",
					price: "7.00 EUR"
				}, {
					id: "9",
					name: "Holla die Waldfee",
					qty: "3 EA",
					limit: "55.00 EUR",
					price: "30.00 EUR"
				}, {
					id: "10",
					name: "Hau Ruck",
					qty: "5 EA",
					limit: "2.00 EUR",
					price: "1.00 EUR"
				}]
		};
		var tableModel = new sap.ui.model.json.JSONModel();
		tableModel.setData(oSuggestionData);

		var oTableItemTemplate = new sap.m.ColumnListItem({
			type: "Active",
			vAlign: "Middle",
			cells: [
				new sap.m.Label({
					text: "{name}"
				}),
				new sap.m.Label({
					text: "{qty}"
				}), new sap.m.Label({
					text: "{limit}"
				}), new sap.m.Label({
					text: "{price}"
				}),
				new sap.m.Label({
					text: "{id}"
				})
			]
		});

		var oInput = new sap.m.Input({
			showSuggestion: true,
			suggestionRowValidator: function (oColumnListItem) {
				var cells = oColumnListItem.getCells();

				return new sap.ui.core.Item({
					key: cells[4].getText(),
					text: cells[0].getText() + ' = ' + cells[2].getText()
				});
			},
			suggestionRows: {
				path: '/tabularSuggestionItems',
				template: oTableItemTemplate
			},
			suggestionColumns: [
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Begin",
					header: new sap.m.Label({
						text: "{Name}"
					})
				}),
				new sap.m.Column({
					hAlign: "Center",
					styleClass: "qty",
					popinDisplay: "Inline",
					header: new sap.m.Label({
						text: "{Qty}"
					}),
					minScreenWidth: "Tablet",
					demandPopin: true
				}),
				new sap.m.Column({
					hAlign: "Center",
					styleClass: "limit",
					width: "30%",
					header: new sap.m.Label({
						text: "{Value}"
					}),
					minScreenWidth: "XXSmall",
					demandPopin: true
				}),
				new sap.m.Column({
					hAlign: "End",
					styleClass: "price",
					width: "30%",
					popinDisplay: "Inline",
					header: new sap.m.Label({
						text: "{Price}"
					}),
					minScreenWidth: "400px",
					demandPopin: true
				}),
				new sap.m.Column({
					styleClass: "name",
					hAlign: "Begin",
					visible: false,
					header: new sap.m.Label({
						text: "{id}"
					})
				})
			]
		});

		oInput.setModel(tableModel);

		return oInput;
	}

	QUnit.test("Tabular Suggestions - Set selection via API", function(assert) {
		var oInput = createInputWithTabularSuggestions(),
				fnCallback = this.spy();

		oInput.attachSuggestionItemSelected(fnCallback);

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.setSelectedRow(oInput.getSuggestionRows()[1]);

		this.clock.tick(50);

		assert.equal(fnCallback.callCount, 0, "change event is not fired");
		assert.equal(oInput.getSelectedKey(), "2", "selected key is correct");
		assert.equal(oInput.getValue(), "Besser ist das = 20.00 EUR", "value is correct");

		oInput.destroy();
	});

	QUnit.test("Tabular Suggestions - Display text formatting", function(assert) {
		var oInput = createInputWithTabularSuggestions();

		oInput.setTextFormatMode(sap.m.InputTextFormatMode.ValueKey);

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.setSelectedRow(oInput.getSuggestionRows()[1]);

		var sValue = oInput.getValue();
		assert.equal(sValue, "Besser ist das = 20.00 EUR (2)", "value is correctly formatted");

		oInput.destroy();
	});

	QUnit.module("Input Description");

	QUnit.test("Input description", function(assert) {
		var oInputWithDes = new sap.m.Input({
			value: "220"
		});
		oInputWithDes.setDescription("EUR");
		oInputWithDes.placeAt("content");
		sap.ui.getCore().applyChanges();
		assert.equal(oInputWithDes.$().find(".sapMInputDescriptionText").text(), "EUR", "Input description is EUR");
 		assert.equal(oInputWithDes.$().find("input").outerWidth(), Math.round(oInputWithDes.$().width()*0.5), "input field has default width");

  		oInputWithDes.setFieldWidth("30%");
  		sap.ui.getCore().applyChanges();
  		assert.ok(Math.abs(oInputWithDes.$().find("input").outerWidth()-(oInputWithDes.$().width()*0.3)) <= 2, "input field has 30% width");

  		oInputWithDes.setFieldWidth("100px");
  		sap.ui.getCore().applyChanges();
  		assert.equal(oInputWithDes.$().find("input").outerWidth(), "100", "input field has 100px width");

  		oInputWithDes.destroy();
	});

	QUnit.module("Accessibility");

	QUnit.test("getAccessibilityInfo", function(assert) {
		var oInput = new sap.m.Input({value: "Value", tooltip: "Tooltip", placeholder: "Placeholder"});
		assert.ok(!!oInput.getAccessibilityInfo, "Input has a getAccessibilityInfo function");
		var oInfo = oInput.getAccessibilityInfo();
		assert.ok(!!oInfo, "getAccessibilityInfo returns a info object");
		assert.strictEqual(oInfo.role, oInput.getRenderer().getAriaRole(), "AriaRole");
		assert.strictEqual(oInput.getRenderer().getAriaRole(), "", "No custom ARIA role");
		assert.strictEqual(oInfo.type, sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_INPUT"), "Type");
		assert.strictEqual(oInfo.description, "Value Placeholder Tooltip", "Description");
		assert.strictEqual(oInfo.focusable, true, "Focusable");
		assert.strictEqual(oInfo.enabled, true, "Enabled");
		assert.strictEqual(oInfo.editable, true, "Editable");
		oInput.setValue("");
		oInput.setEnabled(false);
		oInfo = oInput.getAccessibilityInfo();
		assert.strictEqual(oInfo.description, "Placeholder Tooltip", "Description");
		assert.strictEqual(oInfo.focusable, false, "Focusable");
		assert.strictEqual(oInfo.enabled, false, "Enabled");
		assert.strictEqual(oInfo.editable, false, "Editable");
		oInput.setEnabled(true);
		oInput.setEditable(false);
		oInfo = oInput.getAccessibilityInfo();
		assert.strictEqual(oInfo.focusable, true, "Focusable");
		assert.strictEqual(oInfo.enabled, true, "Enabled");
		assert.strictEqual(oInfo.editable, false, "Editable");
		oInput.setDescription("Description");
		oInfo = oInput.getAccessibilityInfo();
		assert.strictEqual(oInfo.description, "Placeholder Tooltip Description", "Description");
		oInput.destroy();
	});

	QUnit.test("Popup", function(assert) {
		var oInput = createInputWithSuggestions();

		oInput.placeAt("content");
		sap.ui.getCore().applyChanges();

		oInput.onfocusin(); // for some reason this is not triggered when calling focus via API
		oInput._$input.focus().val("It").trigger("input");

		this.clock.tick(300);

		var $popover = oInput._oSuggestionPopup.$();
		assert.ok($popover.attr('aria-labelledby'), 'popup ariaLabelledBy is set');

		oInput.destroy();

	});
</script>

</head>
<body>
	<div id="content"></div>
	<h1 id="qunit-header">QUnit page for sap.m.Input</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<div id="qunit-fixture">test markup, will be hidden</div>
	<ol id="qunit-tests"></ol>
</body>
</html>
