<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="utf-8">
		<title>Test Page for sap.m.InputBase</title>
		<script src="../shared-config.js"></script>
		<script id="sap-ui-bootstrap"
				data-sap-ui-noConflict="true"
				data-sap-ui-libs="sap.m"
				src="../../../../resources/sap-ui-core.js">
		</script>
		<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
		<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script src="../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
		<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
		<script src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>
		<script>
			sinon.config.useFakeTimers = true;
			// make jQuery.now work with Sinon fake timers (since jQuery 2.x, jQuery.now caches the native Date.now)
			jQuery.now = function() {
				return Date.now();
			};

			QUnit.config.autostart = false;
			sap.ui.test.qunit.delayTestStart();

			var XSS = "~!@#$%^&*()_+{}:\"|<>?\'\"><script>alert('xss')<\/script>";

			var fnTestControlProperty = function(mOptions) {
				var sProperty = mOptions.property.charAt(0).toUpperCase() + mOptions.property.slice(1);

				QUnit.test("method: get" + sProperty + "()", function(assert) {
					assert.strictEqual(mOptions.control["get" + sProperty](), mOptions.output, mOptions.description);
				});
			};

			/* =========================================================== */
			/* API module                                                  */
			/* =========================================================== */

			QUnit.module("API");

			/* ------------------------------ */
			/* tests for default values       */
			/* ------------------------------ */

			QUnit.test("default values", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertions
				assert.strictEqual(oInput.getValue(), "", 'The default value is ""');
				assert.strictEqual(oInput.getWidth(), "", 'The default width is ""');
				assert.strictEqual(oInput.getEnabled(), true, "By default the input field is enabled");
				assert.strictEqual(oInput.getVisible(), true, "By default the input field is visible");
				assert.strictEqual(oInput.getValueState(), "None", 'By default the value state is "None"');
				assert.strictEqual(oInput.getName(), "", 'The default name is ""');
				assert.strictEqual(oInput.getPlaceholder(), "", 'The default placeholder value is ""');
				assert.strictEqual(oInput.getEditable(), true, 'By default the input field is editable');
				assert.strictEqual(oInput.getTooltip(), null);

				// cleanup
				oInput.destroy();
			});

			/* ------------------------------ */
			/* getName()                      */
			/* ------------------------------ */

			fnTestControlProperty({
				control: new sap.m.InputBase(),
				property: "name",
				output: "",
				description: 'The name is ""'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					name: "my-input"
				}),
				property: "name",
				output: "my-input",
				description: 'The name is "my-input"'
			});

			/* ------------------------------ */
			/* getVisible()                   */
			/* ------------------------------ */

			fnTestControlProperty({
				control: new sap.m.InputBase({
					visible: false
				}),
				property: "visible",
				output: false,
				description: "Is not visible"
			});

			fnTestControlProperty({
				control: new sap.m.InputBase(),
				property: "visible",
				output: true,
				description: "Is visible"
			});

			/* ------------------------------ */
			/* getEnabled()                   */
			/* ------------------------------ */

			fnTestControlProperty({
				control: new sap.m.InputBase(),
				property: "enabled",
				output: true,
				description: "Is enable"
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					enabled: false
				}),
				property: "enabled",
				output: false,
				description: "Is disabled"
			});

			/* ------------------------------ */
			/* getWidth()                     */
			/* ------------------------------ */

			fnTestControlProperty({
				control: new sap.m.InputBase({
					width: "50%"
				}),
				property: "width",
				output: "50%",
				description: 'The "width" is "50%"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					width: "13rem"
				}),
				property: "width",
				output: "13rem",
				description: 'The "width" is "13rem"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					width: "200px"
				}),
				property: "width",
				output: "200px",
				description: 'The "width" is "200px"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					width: "4em"
				}),
				property: "width",
				output: "4em",
				description: 'The "width" is "4em"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase(),
				property: "width",
				output: "",
				description: 'The "width" is "auto"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					width: "2in"
				}),
				property: "width",
				output: "2in",
				description: 'The "width" is "2in"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					width: "3cm"
				}),
				property: "width",
				output: "3cm",
				description: 'The "width" is "3cm"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					width: "125pt"
				}),
				property: "width",
				output: "125pt",
				description: 'The "width" is "125pt"'
			});

			/* ------------------------------ */
			/* getEditable()                  */
			/* ------------------------------ */

			fnTestControlProperty({
				control: new sap.m.InputBase(),
				property: "editable",
				output: true,
				description: "Is editable"
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					editable: false
				}),
				property: "editable",
				output: false,
				description: "Is not editable"
			});

			/* ------------------------------ */
			/* getTextAlign()                 */
			/* ------------------------------ */

			fnTestControlProperty({
				control: new sap.m.InputBase({
				}),
				property: "textAlign",
				output: sap.ui.core.TextAlign.Initial,
				description: '"textAlign" is "Initial"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					textAlign: sap.ui.core.TextAlign.Left
				}),
				property: "textAlign",
				output: sap.ui.core.TextAlign.Left,
				description: '"textAlign" is "Left"'
			});

			fnTestControlProperty({
				control: new sap.m.InputBase({
					textAlign: sap.ui.core.TextAlign.End
				}),
				property: "textAlign",
				output: sap.ui.core.TextAlign.End,
				description: '"textAlign" is "End"'
			});

			/* ------------------------------ */
			/* getLabels()                    */
			/* ------------------------------ */

			QUnit.test("it should return an array with one object which is the current target of the ariaLabelledBy association", function(assert) {

				// system under test
				var oLabel = sap.m.Label();
				var oInput = new sap.m.InputBase({
					ariaLabelledBy: [
						oLabel
					]
				});

				// assertions
				assert.strictEqual(oInput.getLabels().length, 1);
				assert.ok(oInput.getLabels()[0] === oLabel);

				// cleanup
				oInput.destroy();
				oLabel.destroy();
			});

			QUnit.test("it should return an array with one object which is the label referencing the text field", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();
				var oLabel = new sap.m.Label({
					labelFor: oInput
				});

				// assertions
				assert.strictEqual(oInput.getLabels().length, 1);
				assert.ok(oInput.getLabels()[0] === oLabel);

				// cleanup
				oInput.destroy();
				oLabel.destroy();
			});

			QUnit.test("it should return an array of objects which are the current targets of the ariaLabelledBy association and the labels referencing the text field", function(assert) {

				// system under test
				var oLabel1 = new sap.m.Label({
					id: "lorem-ipsum-label",
					labelFor: oInput
				});
				var oInput = new sap.m.InputBase({
					ariaLabelledBy: [
						"lorem-ipsum-label"
					]
				});
				var oLabel2 = new sap.m.Label({
					labelFor: oInput
				});

				// assertions
				assert.strictEqual(oInput.getLabels().length, 2);
				assert.ok(oInput.getLabels()[0] === oLabel1);
				assert.ok(oInput.getLabels()[1] === oLabel2);

				// cleanup
				oInput.destroy();
				oLabel1.destroy();
				oLabel2.destroy();
			});

			/* ------------------------------ */
			/* setValue()                     */
			/* ------------------------------ */

			var fnSetValueTestCase1 = function(mSettings) {
				QUnit.test("method: setValue() initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).val(), mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetValueTestCase1({
				control: new sap.m.InputBase({
					value: "Input value"
				}),
				output: "Input value"
			});

			fnSetValueTestCase1({
				control: new sap.m.InputBase({
					value: ""
				}),
				output: ""
			});

			fnSetValueTestCase1({
				control: new sap.m.InputBase({
					value: XSS
				}),
				output: XSS
			});

			var fnSetValueTestCase2 = function(mSettings) {
				QUnit.test("method: setValue() after the initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;
					var fnSetValueSpy = this.spy(oInput, "setValue");

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fnRerenderSpy = this.spy(oInput.getRenderer(), "render");

					// act
					oInput.setValue(mSettings.input);

					// assertions
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).val(), mSettings.output);
					assert.ok(fnSetValueSpy.returned(oInput), "sap.m.InputBase.prototype.setValue() method returns the correct value");
					assert.strictEqual(fnRerenderSpy.callCount, 0, "Input is not rerendered with setValue calls");

					// cleanup
					oInput.destroy();
				});
			};

			fnSetValueTestCase2({
				control: new sap.m.InputBase(),
				input: "Input value",
				output: "Input value"
			});

			fnSetValueTestCase2({
				control: new sap.m.InputBase(),
				input: "",
				output: ""
			});

			fnSetValueTestCase2({
				control: new sap.m.InputBase(),
				input: XSS,
				output: XSS
			});

			var fnSetValueTestCase3 = function(mSettings) {
				QUnit.test("method: setValue() initial rendering should respect getMaxLength", function(assert) {

					// arrange - stub for max length before rendering
					sap.m.InputBase.prototype.getMaxLength = undefined;
					this.stub(sap.m.InputBase.prototype, "getMaxLength", function() {
						return mSettings.maxLength;
					});

					// system under test
					var oInput = new sap.m.InputBase(mSettings.control || {});

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).val(), mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetValueTestCase3({
				maxLength : 0,
				control: {
					value : "Test"
				},
				output: "Test"
			});

			fnSetValueTestCase3({
				maxLength : 5,
				control: {
					value : "Test"
				},
				output: "Test"
			});

			fnSetValueTestCase3({
				maxLength : 2,
				control: {
					value : "Test"
				},
				output: "Te"
			});

			var fnSetValueTestCase4 = function(mSettings) {
				QUnit.test("method: setValue() after the initial rendering should respect getMaxLength", function(assert) {

					// stub for max length
					sap.m.InputBase.prototype.getMaxLength = undefined;
					this.stub(sap.m.InputBase.prototype, "getMaxLength", function() {
						return mSettings.maxLength;
					});

					// system under test
					var oInput = new sap.m.InputBase(mSettings.control || {});
					var fnSetValueSpy = this.spy(oInput, "setValue");

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fnRerenderSpy = this.spy(oInput.getRenderer(), "render");

					// act
					oInput.setValue(mSettings.input);

					// assertions
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).val(), mSettings.output);
					assert.ok(fnSetValueSpy.returned(oInput), "sap.m.InputBase.prototype.setValue() method returns the correct value");
					assert.strictEqual(fnRerenderSpy.callCount, 0, "Input is not rerendered with setValue calls");

					// cleanup
					oInput.destroy();
				});
			};

			fnSetValueTestCase4({
				maxLength : 0,
				input : "Test",
				output: "Test"
			});

			fnSetValueTestCase4({
				maxLength : 5,
				input : "Test",
				output: "Test"
			});

			fnSetValueTestCase4({
				maxLength : 2,
				input : "Test",
				output: "Te"
			});

			QUnit.test("setValue should not update the last value when old and new one is same", function(assert) {
				// system under test
				var sInitValue = "init";
				var sTestValue = "test";
				var oInput = new sap.m.InputBase({
					value : sInitValue
				});

				// arrange
				var sLastValue = oInput._lastValue;

				// act as twoway binding does
				oInput.setProperty("value", sTestValue, true);
				oInput.setValue(sTestValue);

				// assertions
				assert.strictEqual(sLastValue, sInitValue, "Last value did not change");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("setValue should update the dom when old and new dom value is not same", function(assert) {

				// system under test
				var sValue = "test";
				var oInput = new sap.m.InputBase({
					value : sValue
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act - set dom value
				oInput.getFocusDomRef().value = sValue + sValue;

				// assertion - before setValue
				assert.notEqual(oInput.getFocusDomRef().value, oInput.getValue(), "Before setValue call dom value and value property are not same.");

				// act - set the same value
				oInput.setValue(sValue);

				// assertion - after setValue
				assert.strictEqual(oInput.getFocusDomRef().value, sValue, "Dom value and value property are same after setValue call.");

				// cleanup
				oInput.destroy();
			});

			/* ------------------------------ */
			/* setWidth()                     */
			/* ------------------------------ */

			var fnSetWidthTestCase1 = function(mSettings) {
				QUnit.test("method: setWidth() initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(oInput.getDomRef().style.width, mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetWidthTestCase1({
				control: new sap.m.InputBase({
					width: "200px"
				}),
				output: "200px"
			});

			fnSetWidthTestCase1({
				control: new sap.m.InputBase({
					width: "100%"
				}),
				output: "100%"
			});

			fnSetWidthTestCase1({
				control: new sap.m.InputBase({
					width: "auto"
				}),
				output: "auto"
			});

			var fnSetWidthTestCase2 = function(mSettings) {
				QUnit.test("method: setWidth() after initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act
					oInput.setWidth(mSettings.input);
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(oInput.getDomRef().style.width, mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetWidthTestCase2({
				control: new sap.m.InputBase(),
				input: "200px",
				output: "200px"
			});

			fnSetWidthTestCase2({
				control: new sap.m.InputBase(),
				input: "100%",
				output: "100%"
			});

			fnSetWidthTestCase2({
				control: new sap.m.InputBase(),
				input: "auto",
				output: "auto"
			});

			/* ------------------------------ */
			/* setEnabled()                   */
			/* ------------------------------ */

			QUnit.test("method: setEnabled() initial rendering test case 1", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.setEnabled(false);
				sap.ui.getCore().applyChanges();

				// assertions
				assert.ok(oInput.$().hasClass("sapMInputBaseDisabled"), 'If the input is disabled, it should have the CSS class "sapMInputBaseDisabled"');
				assert.strictEqual(oInput.getFocusDomRef().getAttribute("aria-disabled"), "true");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("method: setEnabled() test case 2", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase({
					enabled: false
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertions
				assert.ok(oInput.$().hasClass("sapMInputBaseDisabled"), 'If the input is disabled, it should have the CSS class "sapMInputBaseDisabled"');
				assert.strictEqual(oInput.getFocusDomRef().getAttribute("aria-disabled"), "true");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("method: setEnabled() test case 3", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertions
				assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("aria-disabled"), undefined);

				// cleanup
				oInput.destroy();
			});

			/* ------------------------------ */
			/* setValueState()                */
			/* ------------------------------ */

			var fnSetValueStateTestCase1 = function(mSettings) {
				QUnit.test("method: setValueState() initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// assertions
					assert.ok(oInput.$("content").hasClass(mSettings.output));

					// cleanup
					oInput.destroy();
				});
			};

			fnSetValueStateTestCase1({
				control: new sap.m.InputBase({
					valueState: sap.ui.core.ValueState.Error
				}),
				output: "sapMInputBaseContentWrapperError"
			});

			fnSetValueStateTestCase1({
				control: new sap.m.InputBase({
					valueState: sap.ui.core.ValueState.Warning
				}),
				output: "sapMInputBaseContentWrapperWarning"
			});

			fnSetValueStateTestCase1({
				control: new sap.m.InputBase({
					valueState: sap.ui.core.ValueState.Success
				}),
				output: "sapMInputBaseContentWrapperSuccess"
			});

			fnSetValueStateTestCase1({
				control: new sap.m.InputBase({
					valueState: sap.ui.core.ValueState.Error
				}),
				output: "sapMInputBaseContentWrapperState"
			});

			var fnSetValueStateTestCase2 = function(mSettings) {
				QUnit.test("method: setValueState() after initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fnRerenderSpy = this.spy(oInput.getRenderer(), "render");

					// act
					oInput.setValueState(mSettings.input);

					// assertions
					assert.ok(oInput.$("content").hasClass(mSettings.output), "Input should have the class " + mSettings.output);
					assert.strictEqual(fnRerenderSpy.callCount, 0, "Input is not rerendered with setValueState calls");

					// cleanup
					oInput.destroy();
				});
			};

			fnSetValueStateTestCase2({
				control: new sap.m.InputBase(),
				input: sap.ui.core.ValueState.Error,
				output: "sapMInputBaseContentWrapperError"
			});

			fnSetValueStateTestCase2({
				control: new sap.m.InputBase(),
				input: sap.ui.core.ValueState.Warning,
				output: "sapMInputBaseContentWrapperWarning"
			});

			fnSetValueStateTestCase2({
				control: new sap.m.InputBase(),
				input: sap.ui.core.ValueState.Success,
				output: "sapMInputBaseContentWrapperSuccess"
			});

			QUnit.test("method: setValueState() invalid values", function(assert) {
				var oInput = new sap.m.InputBase({
					valueState : null
				}).placeAt("content");
				sap.ui.getCore().applyChanges();

				assert.strictEqual(oInput.getValueState(), sap.ui.core.ValueState.None, "Invalid value state before rendering is converted to default value.");

				oInput.setValueState(sap.ui.core.ValueState.Error);
				assert.ok(oInput.$("content").hasClass("sapMInputBaseContentWrapperError"), "Input has the state class before testing the invalid value.");

				oInput.setValueState(undefined);
				assert.strictEqual(oInput.getValueState(), sap.ui.core.ValueState.None, "Invalid value state is converted to default value.");
				assert.ok(!oInput.$().hasClass("sapMInputBaseState"), "Input's state class is removed after setting the invalid value");

				oInput.destroy();
			});

			/* ------------------------------ */
			/* setName()                      */
			/* ------------------------------ */

			QUnit.test("method: setName() initial rendering", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase({
					name: "myInput"
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertions
				assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("name"), "myInput", 'The attribute name is "myInput"');

				// cleanup
				oInput.destroy();
			});

			QUnit.test("method: setName() after initial rendering", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.setName("myInput");
				sap.ui.getCore().applyChanges();

				// assertions
				assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("name"), "myInput", 'The attribute name is "myInput"');

				// cleanup
				oInput.destroy();
			});

			/* ------------------------------ */
			/* setPlaceholder()               */
			/* ------------------------------ */

			var fnSetPlaceholderTestCase2 = function(mSettings) {
				QUnit.test("method: setPlaceholder() after initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act
					oInput.setPlaceholder(mSettings.input);
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("placeholder") || "", mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetPlaceholderTestCase2({
				control: new sap.m.InputBase(),
				input: "Input placeholder",
				output: "Input placeholder"
			});

			fnSetPlaceholderTestCase2({
				control: new sap.m.InputBase(),
				input: "",
				output: ""
			});

			fnSetPlaceholderTestCase2({
				control: new sap.m.InputBase(),
				input: XSS,
				output: XSS
			});


			/* ------------------------------ */
			/* setEditable()                  */
			/* ------------------------------ */

			var fnSetEditableTestCase1 = function(mSettings) {
				QUnit.test("method: setEditable() initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("readonly"), mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetEditableTestCase1({
				control: new sap.m.InputBase({
					editable: true
				}),
				output: undefined
			});

			fnSetEditableTestCase1({
				control: new sap.m.InputBase({
					editable: false
				}),
				output: "readonly"
			});

			var fnSetEditableTestCase2 = function(mSettings) {
				QUnit.test("method: setEditable() after the initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act
					oInput.setEditable(mSettings.input);
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("readonly"), mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetEditableTestCase2({
				control: new sap.m.InputBase(),
				input: true,
				output: undefined
			});

			fnSetEditableTestCase2({
				control: new sap.m.InputBase(),
				input: false,
				output: "readonly"
			});

			/* ------------------------------ */
			/* setVisible()                   */
			/* ------------------------------ */

			QUnit.test("method: setVisible() initial rendering", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase({
					visible: false
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertions
				assert.strictEqual(oInput.$().length, 0);

				// cleanup
				oInput.destroy();
			});

			/* ------------------------------ */
			/* setTextAlign()                 */
			/* ------------------------------ */

			var fnSetTextAlignTestCase1 = function(mSettings) {
				QUnit.test("method: setTextAlign() initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(oInput.getFocusDomRef().style.textAlign, mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetTextAlignTestCase1({
				control: new sap.m.InputBase({
					textAlign: sap.ui.core.TextAlign.Begin
				}),
				output: "left"
			});

			fnSetTextAlignTestCase1({
				control: new sap.m.InputBase({
					textAlign: sap.ui.core.TextAlign.Initial
				}),
				output: ""
			});

			var fnSetTextAlignTestCase2 = function(mSettings) {
				QUnit.test("method: setTextAlign() after the initial rendering", function(assert) {

					// system under test
					var oInput = mSettings.control;

					// arrange
					oInput.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act
					oInput.setTextAlign(mSettings.input);
					sap.ui.getCore().applyChanges();

					// assertions
					assert.strictEqual(oInput.getFocusDomRef().style.textAlign, mSettings.output);

					// cleanup
					oInput.destroy();
				});
			};

			fnSetTextAlignTestCase2({
				control: new sap.m.InputBase(),
				input: sap.ui.core.TextAlign.End,
				output: "right"
			});

			fnSetTextAlignTestCase2({
				control: new sap.m.InputBase({textAlign: sap.ui.core.TextAlign.End}),
				input: sap.ui.core.TextAlign.Initial,
				output: ""
			});

			/* ------------------------------ */
			/* destroy()                      */
			/* ------------------------------ */

			QUnit.test("method: destroy()", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.destroy();

				// assertions
				assert.strictEqual(oInput.$().length, 0);

				// cleanup
				oInput.destroy();
			});

			/* ------------------------------------- */
			/* valus state and valus state message() */
			/* ------------------------------------- */

			QUnit.test("it should open or close the value state message popup when the input gets or losses the focus event", function(assert) {

				// system under test
				var oErrorInput = new sap.m.InputBase("errorinput", {
					value: "Error InputBase Test",
					valueState: "Error",
					valueStateText: "Error Message"
				});

				var oWarningInput = new sap.m.InputBase("warninginput",{
					value: "Warning InputBase Test",
					valueState: "Warning",
					valueStateText: "Warning Message"
				});

				// arrange
				oErrorInput.placeAt("content");
				oWarningInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				oErrorInput.focus();
				this.clock.tick(500);

				// assert
				assert.ok(jQuery.sap.domById("errorinput-message"), "error message popup is open on focusin");
				assert.equal(oErrorInput.getValueStateText(), "Error Message", "error message is correct");

				oErrorInput.getFocusDomRef().blur();
				assert.ok(!jQuery.sap.domById("errorinput-message"), "error message popup is closed when focus is out");

				oWarningInput.focus();
				this.clock.tick(500);
				assert.ok(jQuery.sap.domById("warninginput-message"), "warning message popup is open when focusin");
				assert.equal(oWarningInput.getValueStateText(), "Warning Message", "warning message is correct");

				oWarningInput.getFocusDomRef().blur();
				assert.ok(!jQuery.sap.domById("warninginput-message"), "warning message popup is closed when focus is out");

				oErrorInput.setShowValueStateMessage(false);
				sap.ui.getCore().applyChanges();
				oErrorInput.focus();
				this.clock.tick(500);
				assert.ok(!jQuery.sap.domById("errorinput-message"), "no error message popup if showValueStateMessage is set to false");

				// cleanup
				oErrorInput.destroy();
				oWarningInput.destroy();
			});

			QUnit.test("it should update the value state message accordingly", function(assert) {
				var oCoreRB = sap.ui.getCore().getLibraryResourceBundle("sap.ui.core"),
						oMobileRB = sap.ui.getCore().getLibraryResourceBundle("sap.m"),
						oValueStateInput = new sap.m.Input("vsinput", {
							placeholder: "value state changes while you are typing",
							liveChange: function() {
								var i = oValueStateInput.getValue().length;

								switch (i % 4) {
									case 0:
										oValueStateInput.setValueState("None");
										break;

									case 1:
										oValueStateInput.setValueState("Warning");
										break;

									case 2:
										oValueStateInput.setValueState("Success");
										break;

									case 3:
										oValueStateInput.setValueState("Error");
										break;
								}
							}
						});

				oValueStateInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// warning state
				oValueStateInput.updateDomValue("1").focus();
				sap.ui.test.qunit.triggerEvent("input", oValueStateInput.getFocusDomRef());
				this.clock.tick(1000);
				assert.strictEqual(oValueStateInput.getValueState(), "Warning");
				assert.ok(jQuery.sap.domById("vsinput-message"), "warning message popup is open");
				assert.strictEqual(jQuery.sap.byId("vsinput-message-text").text(), oCoreRB.getText("VALUE_STATE_WARNING"));
				assert.strictEqual(jQuery.sap.byId("vsinput-message").text(), oMobileRB.getText("INPUTBASE_VALUE_STATE_WARNING") + oCoreRB.getText("VALUE_STATE_WARNING"));

				// success state
				oValueStateInput.updateDomValue("12");
				sap.ui.test.qunit.triggerEvent("input", oValueStateInput.getFocusDomRef());
				this.clock.tick(1000);
				oValueStateInput.getValueState();
				assert.strictEqual(oValueStateInput.getValueState(), "Success");
				assert.ok(jQuery.sap.domById("vsinput-message"), "Success message popup is open");
				assert.ok(jQuery.sap.byId("vsinput-message").hasClass("sapUiInvisibleText"), "Success message popup is not visible");

				// error state
				oValueStateInput.updateDomValue("123");
				sap.ui.test.qunit.triggerEvent("input", oValueStateInput.getFocusDomRef());
				this.clock.tick(1000);
				oValueStateInput.getValueState();
				assert.strictEqual(oValueStateInput.getValueState(), "Error");
				assert.ok(jQuery.sap.domById("vsinput-message"), "error message popup is open");
				assert.strictEqual(jQuery.sap.byId("vsinput-message-text").text(), oCoreRB.getText("VALUE_STATE_ERROR"));
				assert.strictEqual(jQuery.sap.byId("vsinput-message").text(), oMobileRB.getText("INPUTBASE_VALUE_STATE_ERROR") + oCoreRB.getText("VALUE_STATE_ERROR"));

				// none state
				oValueStateInput.updateDomValue("1234");
				sap.ui.test.qunit.triggerEvent("input", oValueStateInput.getFocusDomRef());
				assert.strictEqual(oValueStateInput.getValueState(), "None");
				assert.ok(!jQuery.sap.domById("vsinput-message"), "no message popup");

				// cleanup
				oValueStateInput.destroy();
			});

			/* =========================================================== */
			/* Text direction module                                       */
			/* =========================================================== */

			QUnit.module("Text direction");

			QUnit.test("textDirection set to RTL", function(assert) {

				var oInput = new sap.m.InputBase({
					placeholder: "Text direction set to RTL",
					textDirection: sap.ui.core.TextDirection.RTL
				});

				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("dir"), "rtl");

				oInput.destroy();

			});

			QUnit.test("textDirection set to LTR", function(assert) {

				var oInput = new sap.m.InputBase({
					placeholder: "Text direction set to LTR",
					textDirection: sap.ui.core.TextDirection.LTR
				});

				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				assert.strictEqual(jQuery(oInput.getFocusDomRef()).attr("dir"), "ltr");

				oInput.destroy();

			});

			QUnit.test("textDirection set to RTL and textAlign set to BEGIN", function(assert) {

				var oInput = new sap.m.InputBase({
					placeholder: "Text direction set to RTL",
					textDirection: sap.ui.core.TextDirection.RTL,
					textAlign: sap.ui.core.TextAlign.Begin
				});

				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				var $Input = jQuery(oInput.getFocusDomRef());

				assert.strictEqual($Input.attr("dir"), "rtl", "Dir attribute is set to rtl");
				assert.strictEqual($Input.css("text-align"), "right", "Text align style is shifted to right");

				oInput.destroy();

			});

			QUnit.test("textDirection set to LTR and textAlign set to END", function(assert) {

				var oInput = new sap.m.InputBase({
					placeholder: "Text direction set to LTR",
					textDirection: sap.ui.core.TextDirection.LTR,
					textAlign: sap.ui.core.TextAlign.End
				});

				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				var $Input = jQuery(oInput.getFocusDomRef());

				assert.strictEqual($Input.attr("dir"), "ltr", "Dir attribute is set to ltr");
				assert.strictEqual($Input.css("text-align"), "right", "Text align style is shifted to right");

				oInput.destroy();

			});

			/* =========================================================== */
			/* Events module                                               */
			/* =========================================================== */

			QUnit.module("Events");

			QUnit.test("method: change() event", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				var fnFireChangeSpy = this.spy(oInput, "fireChange");

				// act
				sap.ui.test.qunit.triggerCharacterInput(oInput.getFocusDomRef(), "a");
				oInput.onChange();

				// assertions
				assert.strictEqual(fnFireChangeSpy.callCount, 1, "The change event is fired");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("it should prevent the change event from being fired", function(assert) {

				// system under test
				sap.m.InputBase.extend("InputSubclass", {
					renderer: {},
					preventChangeOnFocusLeave: function() {
						return true;
					}
				});

				var oInput = new InputSubclass();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				oInput.focus();
				var fnFireChangeSpy = this.spy(oInput, "fireChange");
				sap.ui.test.qunit.triggerCharacterInput(oInput.getFocusDomRef(), "a");

				// act
				oInput.getFocusDomRef().blur();
				this.clock.tick(0);	// when a blur event occurs the "sapfocusleave" is fired async

				// assertions
				assert.strictEqual(fnFireChangeSpy.callCount, 0, "The change event should not be fired");

				// cleanup
				oInput.destroy();
				InputSubclass = null;
				delete InputSubclass;
			});

			QUnit.test("onChange should pass in additional parameters to the change event handler", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				oInput.focus();
				var fnFireChangeSpy = this.spy(oInput, "fireChange");
				sap.ui.test.qunit.triggerCharacterInput(oInput.getFocusDomRef(), "bar");

				// act
				oInput.onChange(null, {
					parameter1: true,
					parameter2: false
				});

				// assertions
				assert.strictEqual(fnFireChangeSpy.args[0][0].parameter1, true);
				assert.strictEqual(fnFireChangeSpy.args[0][0].parameter2, false);

				// cleanup
				oInput.destroy();
			});

			QUnit.test("onChange should pass in additional parameters to the change event handle", function(assert) {

				// system under test
				sap.m.InputBase.extend("InputSubclass", {
					renderer: {}
				});

				InputSubclass.prototype.getChangeEventParams = function() {
					return {
						parameter1: false,
						parameter2: true
					};
				};

				var oInput = new InputSubclass();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				oInput.focus();
				var fnFireChangeSpy = this.spy(oInput, "fireChange");
				sap.ui.test.qunit.triggerCharacterInput(oInput.getFocusDomRef(), "a");

				// act
				oInput.getFocusDomRef().blur();
				this.clock.tick(0);	// when a blur event occurs the "sapfocusleave" is fired async

				// assertions
				assert.strictEqual(fnFireChangeSpy.args[0][0].parameter1, false);
				assert.strictEqual(fnFireChangeSpy.args[0][0].parameter2, true);

				// cleanup
				oInput.destroy();
				InputSubclass = null;
				delete InputSubclass;
			});

			QUnit.test("onChange handler should fire the change event when last known and dom value are not same", function(assert) {
				// system under test
				var sInitValue = "Test";
				var oInput = new sap.m.InputBase({
					value : sInitValue
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				var oInputDomRef = oInput.getFocusDomRef();
				var fnFireChangeSpy = this.spy(oInput, "fireChange");

				// act
				sap.ui.test.qunit.triggerKeydown(oInputDomRef, "ENTER");

				// assertion
				assert.strictEqual(fnFireChangeSpy.callCount, 0, "Change event is not fired because initial value and dom value are same.");

				// change dom and cursor pos
				sap.ui.test.qunit.triggerCharacterInput(oInputDomRef, "a");

				// act
				sap.ui.test.qunit.triggerKeydown(oInputDomRef, "ENTER");

				// assertion
				assert.strictEqual(fnFireChangeSpy.callCount, 1, "Change event is fired because last known value and dom value are not same.");

				// reset spy
				fnFireChangeSpy.reset();

				// retest after change event is fired
				oInputDomRef.blur();

				// assertion
				assert.strictEqual(fnFireChangeSpy.callCount, 0, "Change event is not fired again because last known value and dom value are same");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("onChange it should fire the change event sync", function(assert) {

				// system under test
				var sExpectedValue = "lorem ipsum";
				var oInput = new sap.m.InputBase();
				var oButton = new sap.m.Button({
					text: "button"
				});

				// arrange
				oInput.placeAt("content");
				oButton.placeAt("content");
				sap.ui.getCore().applyChanges();
				oInput.focus();
				oInput.getFocusDomRef().value = sExpectedValue;
				var fnFireChangeSpy = this.spy(oInput, "fireChange");

				// act
				oButton.focus();

				// assert
				assert.strictEqual(fnFireChangeSpy.callCount, 1, 'The "change" event is fired sync');
				assert.strictEqual(oInput.getValue(), sExpectedValue);
				assert.strictEqual(oInput.getProperty("value"), sExpectedValue);

				// cleanup
				oInput.destroy();
				oButton.destroy();
			});

			QUnit.test("escape should return the last known value and fire private liveChange event", function(assert) {

				// system under test
				var sInitValue = "Test";
				var sNewValue = "SomethingThatIsNotSameWithTheInitialValue";

				var oInput = new sap.m.InputBase({
					value : sInitValue
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				var fnFireEventSpy = this.spy(oInput, "fireEvent");
				var fnOnEscapeSpy = this.spy(oInput, "onsapescape");

				// act - set dom value
				oInput.getFocusDomRef().value = sNewValue;

				// assertion - before escape
				assert.notEqual(oInput.getFocusDomRef().value, oInput.getValue(), "Before escape call dom value and value property are not same.");

				// act
				sap.ui.test.qunit.triggerKeyboardEvent(oInput.getFocusDomRef(), "ESCAPE");

				// assertion - after escape
				assert.strictEqual(oInput.getValue(), sInitValue, "Input value is returned to the inital value after escape.");
				assert.strictEqual(oInput.getFocusDomRef().value, oInput.getValue(), "Dom value and value property are same after escape.");
				assert.ok(fnFireEventSpy.calledWith("liveChange"), "Private liveChange event is fired on escape");

				// assertion - properties of liveChange event when escape is pressed
				assert.ok(fnFireEventSpy.calledWith("liveChange", sinon.match.has("escPressed", true)), "LiveChange event contains property 'escPressed' with value true.");
				assert.ok(fnFireEventSpy.calledWith("liveChange", sinon.match.has("previousValue", sNewValue)), "LiveChange event contains property 'previousValue' with value of inserted text before escape.");
				assert.ok(fnFireEventSpy.calledWith("liveChange", sinon.match.has("value", sInitValue)), "LiveChange event contains property 'value' with value of initial text.");

				assert.strictEqual(fnFireEventSpy.callCount, 1, "LiveChange event is fired once");
				assert.ok(fnOnEscapeSpy.args[0][0].isMarked(), "Escape is marked as handled");

				// reset spy
				fnFireEventSpy.reset();

				// retest while dom and value property are same
				sap.ui.test.qunit.triggerKeyboardEvent(oInput.getFocusDomRef(), "ESCAPE");

				// assertion - after 2nd escape
				assert.strictEqual(fnFireEventSpy.callCount, 0, "LiveChange event is not fired again because dom and value property are same.");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("input event delegate should be fired in IE9 when CUT / DELETE / BACKSPACE is hit", function(assert) {// TODO remove after 1.62 version

				// system under test
				var oInput = new sap.m.InputBase({
					placeholder : "Test"
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				var oInputDomRef = oInput.getFocusDomRef();
				var fnInputDelegateSpy = this.spy();
				var oInputDelegate = {
					oninput : fnInputDelegateSpy
				};

				// do it twice to test 2nd addEventDelegate removes the previous delegate
				oInput.addEventDelegate(oInputDelegate).addEventDelegate(oInputDelegate);

				// act
				oInputDomRef.focus();
				sap.ui.test.qunit.triggerCharacterInput(oInputDomRef, "a");
				sap.ui.test.qunit.triggerEvent("input", oInputDomRef);

				// assertion
				assert.strictEqual(fnInputDelegateSpy.callCount, 1, "input event delegate is called with character input");
				fnInputDelegateSpy.reset();

				// cleanup
				oInput.destroy();
			});

			/* =========================================================== */
			/* Focus And Cursor Position Module                            */
			/* =========================================================== */
			QUnit.module("FocusAndCursorPosition");

			QUnit.test("getFocusDomRef should point the input field", function(assert) {
				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertion - before escape
				assert.strictEqual(oInput.getFocusDomRef(), oInput.$().find("input")[0], "getFocusDomRef returns the input field.");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("onAfterRendering cursor position and dom values should set to the last known values", function(assert) {
				// system under test
				var sTestValue = "Test";
				var sTestCurPos = sTestValue.length / 2;
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				var fnFireChangeSpy = this.spy(oInput, "fireChange");

				// act - set dom value and change cursor position
				oInput.focus();
				oInput.updateDomValue(sTestValue);
				jQuery(oInput.getFocusDomRef()).cursorPos(sTestCurPos);

				// invalidate the control after dom value changes
				oInput.setPlaceholder("placeholder");
				sap.ui.getCore().applyChanges();

				// assertions
				assert.strictEqual(fnFireChangeSpy.callCount, 0, "Change event should not be fired during the rendering");

				// in test environment focus can leave the test page
				if (document.activeElement == oInput.getFocusDomRef()) {
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).cursorPos(), sTestCurPos, "Cursor position reverted to the last know position after rendering.");
				}

				// cleanup
				oInput.destroy();
			});


			QUnit.test("onAfterRendering last dom value should not be reverted when setProperty('value', ..) is called", function(assert) {
				// system under test
				var sTestValue = "Test";
				var sInitValue = "Initial";
				var sDomValue = "DomValue";
				var sTestCurPos = sTestValue.length / 2;
				var oInput = new sap.m.InputBase({
					value : sInitValue
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act - set dom value and set value property and change cursor position
				oInput.focus();
				oInput.updateDomValue(sDomValue);
				oInput.setProperty("value", sTestValue, true);
				jQuery(oInput.getFocusDomRef()).cursorPos(sTestCurPos);

				// invalidate the control after dom and property value changes
				oInput.setPlaceholder("placeholder");
				sap.ui.getCore().applyChanges();

				// assertion
				assert.strictEqual(jQuery(oInput.getFocusDomRef()).val(), sTestValue, "InputBase respected setProperty value call and did not revert the dom value.");

				// in test environment focus can leave the test page
				if (document.activeElement == oInput.getFocusDomRef()) {
					assert.strictEqual(jQuery(oInput.getFocusDomRef()).cursorPos(), sTestCurPos, "Cursor position reverted to the last know position after rendering.");
				}

				// cleanup
				oInput.destroy();
			});


			QUnit.test("getFocusInfo and applyFocusInfo", function(assert) {
				// system under test
				var sInitValue = "Test";
				var oInput = new sap.m.InputBase({
					value : sInitValue
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				var $Input = jQuery(oInput.getFocusDomRef());

				// act - get focus info and change cursor position of the dom element
				var oFocusInfo = oInput.getFocusInfo();
				oInput.updateDomValue("SomethingThatIsNotSameWithTheInitialValue");
				$Input.cursorPos(10);

				// act - reapply last known focus info
				oInput.applyFocusInfo(oFocusInfo);

				// assertion
				assert.strictEqual($Input.cursorPos(), oFocusInfo.cursorPos, "Cursor position is set to the correct position after apply focus.");

				// cleanup
				oInput.destroy();
			});

			// BCP 1570778270
			QUnit.test("it should correctly restore the value in case of invalidation", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				var sValue = "Lorem Ipsum";
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();
				oInput.focus();

				// act
				oInput.updateDomValue(sValue);
				oInput.setVisible(false);
				sap.ui.getCore().applyChanges();
				oInput.setVisible(true);
				sap.ui.getCore().applyChanges();

				// assert
				assert.strictEqual(oInput.getFocusDomRef().value, sValue);

				// cleanup
				oInput.destroy();
			});

			QUnit.test("getPopupAnchorDomRef should return the control's DOM reference", function(assert) {
				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertion - before escape
				assert.strictEqual(oInput.getPopupAnchorDomRef(), oInput.$()[0], "getFocusDomRef returns the control's DOM reference.");

				// cleanup
				oInput.destroy();
			});

			QUnit.module("TwowayBindingAndFormatters");
			QUnit.test("formatters should be applied for two-way binding formatters", function(assert) {
				// custom formatter
				function smile(sValue) {
					return sValue + " :)";
				}

				// custom type
				jQuery.sap.require("sap.ui.model.type.String");
				sap.ui.model.type.String.extend("my.model.types.Smile", {
					formatValue: smile
				});

				// model
				var sInitValue = "init";
				var sTestValue = "test";
				var oModel = new sap.ui.model.json.JSONModel({
					value : sInitValue
				});
				sap.ui.getCore().setModel(oModel);

				// arrange
				var oInput = new sap.m.InputBase({
					value:{
						path: "/value",
						type: new my.model.types.Smile()
					}
				});
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assertion
				assert.strictEqual(oInput.getValue(), smile(sInitValue), "Initial formatter is applied correctly");

				// in test enviroment focus can leave the test page
				if (document.activeElement != oInput.getFocusDomRef()) {
					return oInput.destroy();
				}

				// act
				oInput.getFocusDomRef().focus();
				oInput.updateDomValue(sTestValue);
				oInput.getFocusDomRef().blur();

				// assertion
				assert.strictEqual(oInput.getValue(), smile(sTestValue), "Test value formatter is applied correctly on change");

				// set the value again to check last value is correct
				oInput.getFocusDomRef().focus();
				oInput.updateDomValue(sTestValue);
				oInput.getFocusDomRef().blur();

				// assertion
				assert.strictEqual(oInput.getValue(), smile(sTestValue), "Test value formatter is applied correctly on change again");

				// cleanup
				oInput.destroy();
			});

			QUnit.module("Accessibility");
			QUnit.test("DOM aria properties", function(assert) {

				var oInput = new sap.m.InputBase().placeAt("content");
				sap.ui.getCore().applyChanges();

				var $Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("role"), "textbox", "Textbox role set correctly");
				assert.strictEqual($Input.attr("aria-invalid"), undefined, "No aria-invalid set for valueState=None");
				assert.strictEqual($Input.attr("aria-readonly"), undefined, "No aria-readonly set for editable=true");
				assert.strictEqual($Input.attr("aria-disabled"), undefined, "No aria-disabled set for enabled=true");
				assert.strictEqual($Input.attr("aria-labelledby"), undefined, "No aria-labelledby set by default");

				oInput.setValueState(sap.ui.core.ValueState.Warning);
				assert.strictEqual($Input.attr("aria-invalid"), undefined, "valueState=Warning does not make control invalid");

				oInput.setValueState(sap.ui.core.ValueState.Success);
				assert.strictEqual($Input.attr("aria-invalid"), undefined, "valueState=Success does not make control invalid");

				oInput.setValueState(sap.ui.core.ValueState.Error);
				assert.strictEqual($Input.attr("aria-invalid"), "true", "valueState=Error makes control invalid");

				oInput.rerender();
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-invalid"), "true", "valueState=Error is at the dom after rendering");

				oInput.setEditable(false);
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-readonly"), "true", "aria-readonly set for editable=false");

				oInput.setEnabled(false);
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-disabled"), "true", "aria-disabled set for enabled=false");

				var oText = new sap.m.Text("text");
				oInput.addAriaLabelledBy(oText);
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-labelledby"), "text", "aria-labelledby set for assosiation");

				// cleanup
				oInput.destroy();
				oText.destroy();
			});

			QUnit.test("Placeholder should be in labelledby", function(assert) {
				var $HiddenLabel;
				var sPlaceholder = "placeholder";
				var oInput = new sap.m.InputBase({
					placeholder: sPlaceholder
				}).placeAt("content");
				sap.ui.getCore().applyChanges();
				$HiddenLabel = oInput.$("labelledby");

				var $Input = jQuery(oInput.getFocusDomRef());
				assert.ok($HiddenLabel.is("span"), "The hidden reference element is of a correct type");
				var $Reference = jQuery.sap.byId($Input.attr("aria-labelledby"));
				assert.strictEqual($Reference.text(), sPlaceholder, "Placeholder is added into aria-labelledby");

				var oText = new sap.m.Text("text");
				oInput.addAriaLabelledBy(oText);
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-labelledby"), "text " + oInput.getId() + "-labelledby", "aria-labelledby is set for assosiation and placeholder together");

				oInput.removeAriaLabelledBy(oText);
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-labelledby"), oInput.getId() + "-labelledby", "aria-labelledby is set only for placeholder");

				oInput.setPlaceholder("");
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-labelledby"), undefined, "no placeholder so aria-labelledby is removed");

				oInput.destroy();
				oText.destroy();
			});

			QUnit.test("Tooltip should be in describedby", function(assert) {
				var sTooltip = "tooltip";
				var oInput = new sap.m.InputBase({
					tooltip: sTooltip
				}).placeAt("content");
				sap.ui.getCore().applyChanges();

				var $Input = jQuery(oInput.getFocusDomRef());
				var $Reference = jQuery.sap.byId($Input.attr("aria-describedby"));
				assert.strictEqual($Reference.text(), sTooltip, "Tooltip is added into aria-describedby");

				oInput.destroy();
			});

			QUnit.test("it should render the tooltip and the invisible element with the same value (test case 1)", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase({
					tooltip: "tooltip"
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// assert
				assert.strictEqual(oInput.$().attr("title"), "tooltip");
				assert.strictEqual(oInput.$("describedby").text(), "tooltip");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("it should render the tooltip and the invisible element with the same value (test case 2)", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.setTooltip("tooltip");

				// assert
				assert.strictEqual(oInput.$().attr("title"), "tooltip");
				assert.strictEqual(oInput.$("describedby").text(), "tooltip");
				assert.strictEqual(oInput.getFocusDomRef().getAttribute("aria-describedby"), oInput.getId() + "-describedby");

				// cleanup
				oInput.destroy();
			});

			QUnit.test("it should not render the tooltip and the invisible element", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase();

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.setTooltip("");

				// assert
				assert.strictEqual(oInput.$().attr("title"), undefined);
				assert.strictEqual(oInput.$("describedby").length, 0);

				// cleanup
				oInput.destroy();
			});

			QUnit.test("it should not render the tooltip and the invisible element (test case 2)", function(assert) {

				// system under test
				var oInput = new sap.m.InputBase({
					tooltip: "tooltip"
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.setTooltip("");

				// assert
				assert.ok(oInput.$().attr("title") === undefined);
				assert.strictEqual(oInput.$("describedby").length, 0);

				// cleanup
				oInput.destroy();
			});

			// BCP 1580094855
			QUnit.test("it should not render the tooltip (test case 3)", function(assert) {

				// arrange
				sap.m.InputBase.extend("CustomInput", {
					renderer: {
						getDescribedByAnnouncement: function() {
							return "lorem ipsum";
						}
					}
				});

				// system under test
				var oInput = new CustomInput({
					tooltip: "tooltip"
				});

				// arrange
				oInput.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.setTooltip("");

				// assert
				assert.ok(oInput.$().attr("title") === undefined);

				// cleanup
				oInput.destroy();
				CustomInput = null;
				delete CustomInput;
			});

			QUnit.test("it should keep other describedby associations when the tooltip is set to empty string", function(assert) {
				sap.m.InputBase.extend("CustomInput", {
					metadata: {
						associations: {
							ariaDescribedBy: {
								type: "sap.ui.core.Control",
								multiple: true,
								singularName: "ariaDescribedBy"
							}
						}
					},
					renderer: {}
				});

				// system under test
				var oText = new sap.m.Text("text");
				var oInput = new CustomInput({
					tooltip: "tooltip",
					ariaDescribedBy: oText
				});

				// arrange
				oInput.placeAt("content");
				oText.placeAt("content");
				sap.ui.getCore().applyChanges();

				// act
				oInput.setTooltip("");

				// assert
				assert.strictEqual(oInput.getFocusDomRef().getAttribute("aria-describedby"), "text");

				// cleanup
				oText.destroy();
				oInput.destroy();
				CustomInput = null;
				delete CustomInput;
			});

			QUnit.test("Renderer Hooks", function(assert) {
				sap.m.InputBase.extend("my.TextField", {
					metadata: {
						associations: {
							ariaDescribedBy: {type: "sap.ui.core.Control", multiple: true, singularName: "ariaDescribedBy"}
						}
					},
					renderer: {
						getAriaRole: function() {
							return "combobox";
						},
						getAriaLabelledBy: function(oControl) {
							return "internal_labelledby_id";
						},
						getLabelledByAnnouncement: function(oControl) {
							return "my labelledby text";
						},
						getAriaDescribedBy: function(oControl) {
							return "internal_describedby_id";
						},
						getDescribedByAnnouncement: function(oControl) {
							return "my describedby text";
						},
						getAccessibilityState: function(oControl) {
							var mBaseAccessibilityState = sap.m.InputBaseRenderer.getAccessibilityState.call(this, oControl);
							return jQuery.extend(mBaseAccessibilityState, {
								autocomplete: true
							});
						}
					}
				});

				var oInput = new my.TextField({
					valueState: sap.ui.core.ValueState.Error
				}).placeAt("content");
				sap.ui.getCore().applyChanges();

				var $Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("role"), "combobox", "Control role set correctly");
				assert.strictEqual($Input.attr("aria-invalid"), "true", "Base functionality still works");
				assert.strictEqual($Input.attr("aria-labelledby"), "internal_labelledby_id", "Internal aria labelledby is set");
				assert.strictEqual($Input.attr("aria-describedby"), "internal_describedby_id", "Internal aria describedby is set");
				assert.strictEqual($Input.attr("aria-autocomplete"), "true", "autocomplete aria attribute is set");
				assert.strictEqual(oInput.$("labelledby").text(), "my labelledby text", "labelledby announcement is set");
				assert.strictEqual(oInput.$("describedby").text(), "my describedby text", "describedby announcement is set");

				var oText = new sap.m.Text("text");
				oInput.addAriaLabelledBy(oText);
				oInput.addAriaDescribedBy(oText);
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-labelledby"), "text internal_labelledby_id", "aria-labelledby is set for assosiation and internal together");
				assert.strictEqual($Input.attr("aria-describedby"), "text internal_describedby_id", "aria-describedby is set for assosiation and internal together");

				oInput.removeAriaLabelledBy(oText);
				oInput.removeAriaDescribedBy(oText);
				sap.ui.getCore().applyChanges();
				$Input = jQuery(oInput.getFocusDomRef());
				assert.strictEqual($Input.attr("aria-labelledby"), "internal_labelledby_id", "aria-labelledby is set only for internal");
				assert.strictEqual($Input.attr("aria-describedby"), "internal_describedby_id", "aria-describedby is set only for internal");

				oInput.destroy();
				oText.destroy();
			});

			QUnit.test("getAccessibilityInfo", function(assert) {
				var oInput = new sap.m.InputBase({value: "Value", tooltip: "Tooltip", placeholder: "Placeholder"});
				assert.ok(!!oInput.getAccessibilityInfo, "InputBase has a getAccessibilityInfo function");
				var oInfo = oInput.getAccessibilityInfo();
				assert.ok(!!oInfo, "getAccessibilityInfo returns a info object");
				assert.strictEqual(oInfo.role, oInput.getRenderer().getAriaRole(), "AriaRole");
				assert.strictEqual(oInfo.type, sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_INPUT"), "Type");
				assert.strictEqual(oInfo.description, "Value Placeholder Tooltip", "Description");
				assert.strictEqual(oInfo.focusable, true, "Focusable");
				assert.strictEqual(oInfo.enabled, true, "Enabled");
				assert.strictEqual(oInfo.editable, true, "Editable");
				oInput.setValue("");
				oInput.setEnabled(false);
				oInfo = oInput.getAccessibilityInfo();
				assert.strictEqual(oInfo.description, "Placeholder Tooltip", "Description");
				assert.strictEqual(oInfo.focusable, false, "Focusable");
				assert.strictEqual(oInfo.enabled, false, "Enabled");
				assert.strictEqual(oInfo.editable, false, "Editable");
				oInput.setEnabled(true);
				oInput.setEditable(false);
				oInfo = oInput.getAccessibilityInfo();
				assert.strictEqual(oInfo.focusable, true, "Focusable");
				assert.strictEqual(oInfo.enabled, true, "Enabled");
				assert.strictEqual(oInfo.editable, false, "Editable");
				oInput.destroy();
			});


		QUnit.module("invalid input event");
		QUnit.test("iE10+ should mark event invalid when an input field with a native placeholder is focused", function(assert) {// TODO remove after 1.62 version
			this.stub(sap.m.InputBase.prototype, "bShowLabelAsPlaceholder", false);
			var fnOnInputSpy = this.spy(sap.m.InputBase.prototype, "oninput");
			this.stub(sap.ui.Device, "browser", {
				msie: true,
				version: 10
			});

			var oInput = new sap.m.InputBase({
				placeholder : "Test"
			}).placeAt("content");
			sap.ui.getCore().applyChanges();

			var oInputDomRef = oInput.getFocusDomRef();
			oInputDomRef.focus();
			sap.ui.test.qunit.triggerEvent("input", oInputDomRef);

			// This fix should be valid only for input tag elements
			assert.strictEqual(oInput._getInputElementTagName(), "INPUT", "Input tag element is used");
			assert.strictEqual(fnOnInputSpy.callCount, 1, "input event is triggered");
			assert.ok(fnOnInputSpy.args[0][0].isMarked("invalid"), 1, "input event is marked as invalid");

			// cleanup
			oInput.destroy();
		});

		QUnit.test("iE11 should mark event invalid when an readonly input field fires input event", function(assert) {// TODO remove after 1.62 version
			var fnOnInputSpy = this.spy(sap.m.InputBase.prototype, "oninput");
			this.stub(sap.ui.Device, "browser", {
				msie: true,
				version: 11
			});

			var oInput = new sap.m.InputBase({
				editable : false
			}).placeAt("content");
			sap.ui.getCore().applyChanges();

			var oInputDomRef = oInput.getFocusDomRef();
			oInputDomRef.focus();
			sap.ui.test.qunit.triggerEvent("input", oInputDomRef);

			assert.strictEqual(fnOnInputSpy.callCount, 1, "input event is triggered");
			assert.ok(fnOnInputSpy.args[0][0].isMarked("invalid"), 1, "input event is marked as invalid");

			// cleanup
			oInput.destroy();
		});

		QUnit.module("Renderer hooks");
		QUnit.test("writeInnerId() is called", function(assert) {
			var oInputBase = new sap.m.InputBase({}),
				oRenderer = oInputBase.getRenderer();

			//spy writeInnerId()
			var fnOnInputBaseSpy = this.spy(oRenderer, "writeInnerId");

			oInputBase.placeAt("content");
			sap.ui.getCore().applyChanges();

			assert.strictEqual(fnOnInputBaseSpy.callCount, 1, "writeInnerId() is called");

			// cleanup
			oInputBase.destroy();
		});

		</script>
	</head>
	<body id="body" class="sapUiBody">
		<h1 id="qunit-header">QUnit tests: sap.m.InputBase</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<ol id="qunit-tests"></ol>
		<div id="content"></div>
	</body>
</html>