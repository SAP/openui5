<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8" />
<title>FacetFilter - sap.m</title>

<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />

<!-- UI5 Bootstrap -->
<script id="sap-ui-bootstrap" type="text/javascript" src="../../../../resources/sap-ui-core.js" data-sap-ui-theme="sap_bluecrystal" data-sap-ui-libs="sap.m"></script>

<!-- QUnit libraries -->
<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript">
	
	
	if(navigator.userAgent.indexOf("MSIE") === -1) {
		
	
	module("Control Design");
		
	test("Aggregations", function() {
		
		// The aggregations below are created programatically by FacetFilter when it is initialized, so make sure they are created.
		var oFF = new sap.m.FacetFilter("someid");
		oFF.setShowPersonalization(true);
		oFF.addList(new sap.m.FacetFilterList("list1"));		
		oFF.addList(new sap.m.FacetFilterList("list2"));
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		equal(oFF.getLists().length, 2, "There should be two lists in the 'lists' aggregation");
		ok(oFF.getAggregation("addFacetButton"), "Add facet button aggregation should be created");
		equal(oFF.getAggregation("buttons").length, 2, "There should be two buttons in the 'buttons' aggregation");
		equal(oFF.getAggregation("removeFacetIcons").length, 2, "There should be two remove icons in the aggregation");
		ok(oFF.getAggregation("summaryBar"), "The summary bar aggregation should be created");
		
		destroyFF(oFF);
		
		// Now make sure we can create a new FF using the same IDs.  This will fail if any of the aggregated controls are is not destroyed properly.
		var oFF = new sap.m.FacetFilter("someid");
		oFF.setShowPersonalization(true);
		oFF.addList(new sap.m.FacetFilterList("list1"));		
		oFF.addList(new sap.m.FacetFilterList("list2"));
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		destroyFF(oFF);
	});	
	
	test("Default Property Values & Override", function() {
				
		var oFF = new sap.m.FacetFilter();
		strictEqual(oFF.getVisible(), true, "Visibility should be enabled by default");
		strictEqual(oFF.getShowPersonalization(), false, "Personalization should disabled by default");
		strictEqual(oFF.getShowSummaryBar(), false, "Show summary bar should disabled by default");
		strictEqual(oFF.getShowReset(), true, "Show reset should enabled by default");
		strictEqual(oFF.getShowPopoverOKButton(), false, "Show popover ok should disabled by default");
		strictEqual(oFF.getType(), sap.m.FacetFilterType.Simple, "Type should be Simple by default");
		strictEqual(oFF.getLiveSearch(), true, "Live search should be enabled by default");
		oFF.destroy();
		
		var oFFL1 = new sap.m.FacetFilterList();
		strictEqual(oFFL1.getActive(), true, "List active should be enabled by default");
		strictEqual(oFFL1.getMultiSelect(), true, "List multi select should be enabled by default");		
		strictEqual(oFFL1.getMode(), sap.m.ListMode.MultiSelect, "List mode should be multi select by default");
		strictEqual(oFFL1.getGrowing(), true, 'Growing is enabled by default');
        strictEqual(oFFL1.getShowRemoveFacetIcon(), true, "Remove icon should be shown by default");
        strictEqual(oFFL1.getRetainListSequence(), false, "List sequence should not be retained by default when list is inactive and made active again"); 
		strictEqual(oFFL1.getDataType(), sap.m.FacetFilterListDataType.String, 'Data Type is String by default');
        oFFL1.destroy();
		
		// Test overrides
		var oFFL2 = new sap.m.FacetFilterList({
			active: false,
			multiSelect: false,
			growing: false,
			mode: sap.m.ListMode.SingleSelectMaster
		});
        strictEqual(oFFL2.getActive(), false, "List active should be disabled");
		strictEqual(oFFL2.getMultiSelect(), false, "List multi select should be disabled");			
		strictEqual(oFFL2.getMode(), sap.m.ListMode.SingleSelectMaster, "List mode should be single select master");
		strictEqual(oFFL2.getGrowing(), false, 'Growing should be disabled');
		oFFL2.destroy();
	});
	
	
	module("Private API");
	
	test("FacetFilter.init", function() {
		
		var oFF = new sap.m.FacetFilter();
		
		// Verify the add facet button is created
		var oAddFacetButton = oFF.getAggregation("addFacetButton");
		ok(oAddFacetButton, "The add facet button is created");
		
		// Verify the summary bar is created
		var oSummaryBar = oFF.getAggregation("summaryBar");
		ok(oSummaryBar, "The summary bar is created");
		oFF.destroy();
	});
	
	test("FacetFilter._getPopover", function() {
		
		var oFF = new sap.m.FacetFilter();
		oFF._getPopover();
		
		var oPopover = oFF.getAggregation("popover");
		ok(oPopover, "The popover is created");
		equal(oPopover.getPlacement(), sap.m.PlacementType.Bottom, "Popover placement should be bottom");
		strictEqual(oPopover.getHorizontalScrolling(), false, "Horizontal scrolling should be disabled");
		strictEqual(oPopover, oFF._getPopover(), "There should only be one instance of Popover created while the popover aggregation is still valid");
		ok(!oPopover.getFooter(), "Popover should not contain the OK button in the footer");
		
		oFF.setShowPopoverOKButton(true);
		oPopover = oFF._getPopover();
		ok(oPopover.getFooter(), "Popover should contain the OK button in the footer");
		oFF.destroy();
	});
	
	asyncTest("FacetFilter._openPopover", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oFFL = new sap.m.FacetFilterList();
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		var oPopover = oFF._getPopover();
		oPopover.attachEventOnce("afterOpen", function() {
			
			start();
			ok(oPopover.isOpen(), "Popover should be open");		
			destroyFF(oFF);
		});
		
		var oButton = oFF._getButtonForList(oFFL);
		oFF._openPopover(oPopover, oButton);
	});
	
	asyncTest("FacetFilter._closePopover", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oFFL = new sap.m.FacetFilterList();
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		var oPopover = oFF._getPopover();
		oPopover.attachEventOnce("afterOpen", function() {
			
			oPopover.attachEventOnce("afterClose", function() {

				start();
				ok(!oPopover.isOpen(), "Popover should be closed");		
				ok(!oPopover.getSubHeader(), "Popover subheader should be destroyed");
				equal(oPopover.getContent().length, 0, "Popover content should be destroyed");
				destroyFF(oFF);				
			});
			oFF._closePopover();
		});
		openPopover(oFF, 0);
	});	
	
	test("FacetFilter._moveListToDisplayContainer, _restoreListFromDisplayContainer", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oFFL1 = new sap.m.FacetFilterList()
		var oFFL2 = new sap.m.FacetFilterList()
		var oFFL3 = new sap.m.FacetFilterList()
		oFF.addList(oFFL1);		
		oFF.addList(oFFL2);
		oFF.addList(oFFL3);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		equal(oFF.indexOfAggregation("lists", oFFL1), 0, "List 1 should be at index 0");
		equal(oFF.indexOfAggregation("lists", oFFL2), 1, "List 2 should be at index 1");
		equal(oFF.indexOfAggregation("lists", oFFL3), 2, "List 3 should be at index 2");
		
		var oContainer = new sap.m.Popover();
		var fnMoveAndTest = function(oFFL, iIndex) {
			
			oFF._moveListToDisplayContainer(oFFL, oContainer);
			
			equal(oFFL.getAssociation("facetFilter"), oFF.getId(), "The list should have an association back to the FacetFilter after it is moved");
			strictEqual(oFF._displayedList, oFFL, "_displayedList should point to the moved list");
			equal(oFF._listAggrIndex, iIndex, "Index of the displayed list within the FacetFilter lists aggregation should be " + iIndex);
			strictEqual(oContainer.getContent()[0], oFFL, "The displayed list should be set into the content of the container");
			equal(oFF.getLists().length, 3, "All lists should still be returned from getList()");
			
			oFF._restoreListFromDisplayContainer(oContainer);
			
			ok(!oFF.getAggregation("popover"), "The popover aggregation should be destroyed");
			
			equal(oFF.indexOfAggregation("lists", oFFL1), 0, "List 1 should be at index 0");
			equal(oFF.indexOfAggregation("lists", oFFL2), 1, "List 2 should be at index 1");
			equal(oFF.indexOfAggregation("lists", oFFL3), 2, "List 3 should be at index 2");

			strictEqual(oFF._displayedList, null, "_displayedList should be reset to null");
			equal(oFF._listAggrIndex, -1, "Displayed list index should be reset to -1");
			strictEqual(oContainer.getContent().length, 0, "The container control should no longer contain the list");
			equal(oFF.getLists().length, 3, "All lists should still be returned from getList()");
		};
		
		fnMoveAndTest(oFFL1, 0);
		fnMoveAndTest(oFFL2, 1);
		fnMoveAndTest(oFFL3, 2);

		oContainer.destroy();
		destroyFF(oFF);
	});
	
	test("FacetFilter._getFacetDialog", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oDialog = oFF.getAggregation("dialog");
		ok(!oDialog, "Dialog should be created lazily");
		
		oDialog = oFF._getFacetDialog();
		ok(oDialog instanceof sap.m.Dialog, "Should be an instance of sap.m.Dialog");
		ok(oDialog, "Dialog should not be null");
		ok(oFF.getAggregation("dialog"), "Dialog aggregation should be created");
		
		ok(oDialog.getBeginButton(), "Dialog begin button should be created");
		strictEqual(oDialog.getShowHeader(), false, "Dialog header should not be shown");
		strictEqual(oDialog.getStretch(), sap.ui.Device.system.phone ? true : false, "Dialog stretch should be false on desktop and true on phone");
		
		if(sap.ui.Device.system.desktop) {
			equal(oDialog.getContentHeight(), "500px", "Dialog height should be fixed on desktop");
		}
		
		equals(oFF._getFacetDialog(), oDialog, "There should be only one dialog instance created");
		oFF.destroy();
	});
	
	asyncTest("FacetFilter._closeDialog", function() {
		
		var oListCloseEvent = null;
		var oFF = new sap.m.FacetFilter();
		var oFFL = new sap.m.FacetFilterList({title: "List"});
		var oFFI = new sap.m.FacetFilterItem({text: "Val"});
		oFFL.addItem(oFFI);
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		oFFL.attachListClose(function(oEvent) {
			oListCloseEvent = oEvent;
		});
		var oDialog = oFF._getFacetDialog();
		
		oFF.openFilterDialog();
		var oNavContainer = oDialog.getContent()[0];
		oNavContainer.attachEventOnce("afterNavigate", function(oEvent) {
			
			oDialog.attachEventOnce("afterClose", function(oEvent) {
				
				start();
				ok(oListCloseEvent, "List close event should have been fired");
				ok(!oDialog.isOpen(), "Dialog should be closed");
				equal(oDialog.getContent().length, 0, "Dialog nav container should be destroyed");
				
				destroyFF(oFF);
			});		
			oFF._closeDialog();
		});
		
		oFF._navToFilterItemsPage(oNavContainer.getPages()[0].getContent()[0].getItems()[0]);
	});
	
	test("FacetFilter._createFacetList", function() {
		
		var sFacet1 = "Facet1", sFacet2 = "Facet2", iFacet1AllCount = 4, iFacet2AllCount = 7;
		var oFF = new sap.m.FacetFilter();
		var oFFL1 = new sap.m.FacetFilterList({title: sFacet1,allCount: iFacet1AllCount});
		var oFFL2 = new sap.m.FacetFilterList({title: sFacet2,allCount: iFacet2AllCount});
		oFF.addList(oFFL1);		
		oFF.addList(oFFL2);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();

		var oList = oFF._createFacetList();
		ok(oList, "List should not be null");
		oList.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		
		equal(oList.getMode(), sap.m.ListMode.None, "The facet list mode should be None");
		equal(oList.getItems().length, 2, "There should be two list items");
		equal(oList.getItems()[0].getType(), sap.m.ListType.Navigation, "List item type should be Navigation");
		equal(oList.getItems()[0].getTitle(), sFacet1, "The first facet should be " + sFacet1);
		equal(oList.getItems()[0].getCounter(), iFacet1AllCount, "The first facet all count should be " + iFacet1AllCount);
		equal(oList.getItems()[0].getTooltip(), sFacet1,"The first facet should have tooltip same as title");
		equal(oList.getItems()[1].getTitle(), sFacet2, "The second facet should be " + sFacet2);
		equal(oList.getItems()[1].getCounter(), iFacet2AllCount, "The second facet all count should be " + iFacet2AllCount);
		equal(oList.getItems()[1].getTooltip(), sFacet2,"The second facet should have tooltip same as title");
		for(var i=0; i < oList.getItems().length; i++) {
			
			var aCustomData1 = oList.getItems()[i].getCustomData();
			equal(aCustomData1.length, 1, "There should be one custom data in the list item to hold its index");
			equal(aCustomData1[0].getValue(), i, "Index should be " + i);			
		}
		
		oList.destroy();
		destroyFF(oFF);
	});
	
	test("FacetFilter._createFacetPage", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oPage = oFF._createFacetPage();
		
		ok(oPage.getEnableScrolling(), "Page scrolling should be enabled");
		
		var oPageSubHeader = oPage.getSubHeader();
		ok(oPageSubHeader, "Page should have a sub header");
		ok(oPageSubHeader instanceof sap.m.Bar, "Page sub header should be a Bar");
		
		var oPageSubHeaderSearchField = oPageSubHeader.getContentMiddle()[0];
		ok(oPageSubHeaderSearchField, "Page sub header should have content");
		ok(oPageSubHeaderSearchField instanceof sap.m.SearchField, "Page sub header should be a SearchField");
		equal(oPageSubHeaderSearchField.getWidth(), "100%", "Page search field width should be 100%");
		
		var oFacetList = oPage.getContent()[0];
		ok(oFacetList, "Page should have content");
		ok(oFacetList instanceof sap.m.List, "Page content should be a List");			
		oFF.destroy();
	});
	
	test("FacetFilter._createFilterItemsPage", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oPage = oFF._createFilterItemsPage();
		
		ok(oPage.getEnableScrolling(), "Page scrolling should be enabled");
		ok(oPage.getShowNavButton(), "Filter items page should show the navigation button");
		oFF.destroy();
	});
	
	test("FacetFilter._createFilterItemsSearchFieldBar", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oFFL1 = new sap.m.FacetFilterList();
		oFF.addList(oFFL1);
		var oBar = oFF._createFilterItemsSearchFieldBar(oFFL1);
		ok(oBar, "Bar should be created");
		var oSearchField = oBar.getContentMiddle()[0];
		ok(oSearchField, "Bar should contain a search field placed in middle content");
		ok(oSearchField.getTooltip(), "Search field has tooltip");
		equal(oSearchField.getWidth(), "100%", "Search field width should be 100%");	
		
		equal(oFFL1.getAssociation("search"), oSearchField.getId(), "The list should have an association with the search field");
		equal(oSearchField.getEnabled(), true, "the search field is enabled");
		var oFFL2 = new sap.m.FacetFilterList();
		oFFL2.setDataType(sap.m.FacetFilterListDataType.Date);
		oFF.addList(oFFL2);
		var oBar2 = oFF._createFilterItemsSearchFieldBar(oFFL2);
		var oSearchField2 = oBar2.getContentMiddle()[0];
		equal(oSearchField2.getEnabled(), false, "the search field is not enabled");
		oFF.destroy();
	});	
	
	test("FacetFilter._createSelectAllCheckboxBar", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oFFL1 = new sap.m.FacetFilterList();
		oFFL1.addItem(new sap.m.FacetFilterItem());
		var oCheckboxBar1 = oFF._createSelectAllCheckboxBar(oFFL1);		
		ok(oCheckboxBar1, "The checkbox bar is created");
		ok(oCheckboxBar1 instanceof sap.m.Bar, "The checkbox bar should be a Bar");
		var oCheckBox1 = oCheckboxBar1.getContentLeft()[0];
		ok(oCheckBox1, "A control is contained in the left content of the bar");
		ok(oCheckBox1 instanceof sap.m.CheckBox, "The bar contains a CheckBox");
		ok(oCheckBox1.getTooltip(),"CheckBox contain tooltip");
		ok(oCheckBox1.getSelected(), "Checkbox should be initially checked when the list is active and contains no selections");
		oFFL1.destroy();
		
		var oFFL2 = new sap.m.FacetFilterList();
		oFFL2.addItem(new sap.m.FacetFilterItem({selected: true}));
		var oCheckboxBar2 = oFF._createSelectAllCheckboxBar(oFFL2);
		var oCheckBox2 = oCheckboxBar2.getContentLeft()[0];
		ok(!oCheckBox2.getSelected(), "Checkbox should not be initially checked when the list contains selections");
		oFFL2.destroy();
		
		var oFFL3 = new sap.m.FacetFilterList({active: false});
		var oCheckboxBar3 = oFF._createSelectAllCheckboxBar(oFFL3);
		var oCheckBox3 = oCheckboxBar3.getContentLeft()[0];
		ok(!oCheckBox3.getSelected(), "Checkbox should not be initially checked when the list is inactive");
		oFFL3.destroy();
		
		var oFFL4 = new sap.m.FacetFilterList({multiSelect: false});
		ok(!oFF._createSelectAllCheckboxBar(oFFL4), "Checkbox bar should not be created when the list is not multi select");
		oFFL4.destroy();
		
		oFF.destroy();
	});
	
	
	test("FacetFilter._getFacetDialogNavContainer", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oNavContainer = oFF._getFacetDialogNavContainer();
		ok(oNavContainer instanceof sap.m.NavContainer, "Should be an instance of sap.m.NavContainer");
		ok(oNavContainer, "NavContainer should not be null");
		
		equal(oNavContainer.getPages().length, 1, "Nav container should contain one pages");
		oFF.destroy();
	});	
	
	
	asyncTest("FacetFilter._navToFilterItemsPage", function() {
		
		var sList1Title = "List1", sList2Title = "List2", sItem1 = "List1 Val1", sItem2 = "List2 Val1";
		
		var oFFL1 = new sap.m.FacetFilterList({title: sList1Title});
		oFFL1.addItem(new sap.m.FacetFilterItem({text: sItem1}));		
		var oFFL2 = new sap.m.FacetFilterList({title: sList2Title});
		oFFL2.addItem(new sap.m.FacetFilterItem({text: sItem2}));
		var oFF = new sap.m.FacetFilter( {
			lists: [oFFL1, oFFL2]
		});
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();		
		
		oFF.openFilterDialog();
		
		var oNavContainer = oFF.getAggregation("dialog").getContent()[0];
		var oFacetPage = sap.ui.getCore().byId(oNavContainer.getInitialPage());
		var oFacetList = oFacetPage.getContent()[0];
		var oFacetListItem1 = oFacetList.getItems()[0];
		
		oNavContainer.attachEventOnce("afterNavigate", function() {

			start();
			var oFacetFilterListPage = oNavContainer.getPages()[1];
			var oCurrentPage = oNavContainer.getCurrentPage();
			strictEqual(oFacetFilterListPage, oCurrentPage, "The current page should be the facet filter item page");
			
			var oPageSubHeader = oCurrentPage.getSubHeader();
			ok(oPageSubHeader, "Page should have a sub header");
			ok(oPageSubHeader instanceof sap.m.Bar, "Page sub header should be a Bar");
			
			var oPageSubHeaderSearchField = oPageSubHeader.getContentMiddle()[0];
			ok(oPageSubHeaderSearchField, "Page sub header should have content");
			ok(oPageSubHeaderSearchField instanceof sap.m.SearchField, "Page sub header should be a SearchField");			
			equal(sList1Title, oCurrentPage.getTitle(), "Current page should display the first facet filter list");
			ok(oFFL1.getItems()[0].getDomRef(), "Facet filter item should be rendered");
			
			destroyFF(oFF);
		});
		oFF._navToFilterItemsPage(oFacetListItem1);
	});
	
	asyncTest("FacetFilter._navToFilterItemsPage after search", function() {
		
		var sList1Title = "List1", sList2Title = "List2", sItem1 = "List1 Val1", sItem2 = "List2 Val1";
		
		var oFFL1 = new sap.m.FacetFilterList({title: sList1Title});
		oFFL1.addItem(new sap.m.FacetFilterItem({text: sItem1}));		
		var oFFL2 = new sap.m.FacetFilterList({title: sList2Title});
		oFFL2.addItem(new sap.m.FacetFilterItem({text: sItem2}));
		var oFF = new sap.m.FacetFilter( {
			lists: [oFFL1, oFFL2]
		});
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();		
		
		oFF.openFilterDialog();
		
		var oNavContainer = oFF.getAggregation("dialog").getContent()[0];
		var oFacetPage = sap.ui.getCore().byId(oNavContainer.getInitialPage());
		
		var oSearchField = getDialogFacetSearchField(oFacetPage);
		
		oSearchField.attachLiveChange(function(oEvent) {
			
			oNavContainer.attachEventOnce("afterNavigate", function() {

				start();
				var oFacetFilterListPage = oNavContainer.getPages()[1];
				var oCurrentPage = oNavContainer.getCurrentPage();
				strictEqual(oFacetFilterListPage, oCurrentPage, "The current page should be the facet filter item page");
				equal(sList2Title, oCurrentPage.getTitle(), "Current page should display the second facet filter list");
				ok(oFFL2.getItems()[0].getDomRef(), "Facet filter item should be rendered");
				
				destroyFF(oFF);
			});
			
			var oFacetList = oFacetPage.getContent()[0];
			var oFacetListItem = oFacetList.getItems()[0];
			oFF._navToFilterItemsPage(oFacetListItem);			
		});
		
		oSearchField.fireLiveChange({
			newValue: "List2"
		});
	});
	
	asyncTest("FacetFilter._navFromFilterItemsPage", function() {
		
		var iAllCount = 54;
		var oFF = new sap.m.FacetFilter();
		var oFFL = new sap.m.FacetFilterList({title: "List"});
		oFFL.addItem(new sap.m.FacetFilterItem({text: "Val1"}));		
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();		
		
		oFF.openFilterDialog();
		
		var oNavContainer = oFF.getAggregation("dialog").getContent()[0];
		var oFacetPage = sap.ui.getCore().byId(oNavContainer.getInitialPage());
		var oFacetList = oFacetPage.getContent()[0];
		var oFacetListItem1 = oFacetList.getItems()[0];
		
		oNavContainer.attachEventOnce("afterNavigate", function() {

			oNavContainer.attachEventOnce("afterNavigate", function() {

				start();
				var oCurrentPage = oNavContainer.getCurrentPage();
				strictEqual(oFacetPage, oCurrentPage, "The current page should be the facet page");
				
				var oContent = oNavContainer.getPages()[1].getContent();
				equal(oContent.length, 0, "Filter items page content should be destroyed");
				
				var oFacetList = getDialogFacetList(oFF);
				equal(oFacetList.getItems()[0].getCounter(), iAllCount, "Facet allCount should be set");
				
				destroyFF(oFF);
			});	
			oFFL.setAllCount(iAllCount);
			
			oFF._navFromFilterItemsPage(oNavContainer);
		});	
		var oOldItemsPage = oNavContainer.getPages()[1];
		oFF._navToFilterItemsPage(oFacetListItem1);
		notEqual(oNavContainer.getPages()[1].getId(), oOldItemsPage && oOldItemsPage.getId(), 'New items page has been created');
	});
		
	test("FacetFilter._getSequencedLists", function() {
	
		var oFF = new sap.m.FacetFilter();
		var aSequencedLists = oFF._getSequencedLists();
		
		equal(aSequencedLists.length, 0, "There should be no sequenced lists");
		
		oFF.addList(new sap.m.FacetFilterList());
		
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 1, "There should be one sequenced list");
		equal(aSequencedLists[0].getSequence(), 0, "Sequence should be 0");
		
		oFF.removeAllLists();
		
		// Check when a list has a sequence less than -1
		oFF.addList(new sap.m.FacetFilterList({sequence: -2}));
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 1, "There should be one sequenced list");
		equal(aSequencedLists[0].getSequence(), 0, "Sequence should be 0");
		
		oFF.removeAllLists();
		
		// Verify initial ordering is preserved if all lists have the default sequence
		oFF.addList(new sap.m.FacetFilterList());
		oFF.addList(new sap.m.FacetFilterList());
		oFF.addList(new sap.m.FacetFilterList());
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 3, "There should be three sequenced lists");
		equal(aSequencedLists[0].getSequence(), 0, "Sequence of the first list should be 0");		
		equal(aSequencedLists[1].getSequence(), 1, "Sequence of the second list should be 1");
		equal(aSequencedLists[2].getSequence(), 2, "Sequence of the third list should be 2");
		strictEqual(oFF.getLists()[0], aSequencedLists[0], "Initial list order should be preserved");
		strictEqual(oFF.getLists()[1], aSequencedLists[1], "Initial list order should be preserved");
		strictEqual(oFF.getLists()[2], aSequencedLists[2], "Initial list order should be preserved");
		
		oFF.removeAllLists();
		
		// Verify that a list with sequence -1 is placed after a list with sequence 0
		oFF.addList(new sap.m.FacetFilterList());
		oFF.addList(new sap.m.FacetFilterList({sequence: 0}));
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 2, "There should be two sequenced lists");
		equal(aSequencedLists[0].getSequence(), 0, "Sequence of the first list should be 0");		
		equal(aSequencedLists[1].getSequence(), 1, "Sequence of the second list should be 1");
		strictEqual(oFF.getLists()[0], aSequencedLists[1], "The list with initial sequence of -1 should be moved after the list with 0 sequence");
		strictEqual(oFF.getLists()[1], aSequencedLists[0], "The list with initial sequence of 0 should be before the list with sequence -1");
		
		oFF.removeAllLists();
		
		// Verify sequencing remains as-is for lists that are already ordered
		oFF.addList(new sap.m.FacetFilterList({sequence: 3}));
		oFF.addList(new sap.m.FacetFilterList({sequence: 5}));
		oFF.addList(new sap.m.FacetFilterList({sequence: 9}));
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 3, "There should be three sequenced lists");
		equal(aSequencedLists[0].getSequence(), 3, "Sequence of the first list should be 3");		
		equal(aSequencedLists[1].getSequence(), 5, "Sequence of the second list should be 5");
		equal(aSequencedLists[2].getSequence(), 9, "Sequence of the third list should be 9");
		
		oFF.removeAllLists();
		
		// Verify sequencing is correct if all lists start in the reverse order
		oFF.addList(new sap.m.FacetFilterList({sequence: 9}));
		oFF.addList(new sap.m.FacetFilterList({sequence: 5}));
		oFF.addList(new sap.m.FacetFilterList({sequence: 3}));
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 3, "There should be three sequenced lists");
		equal(aSequencedLists[0].getSequence(), 3, "Sequence of the first list should be 3");		
		equal(aSequencedLists[1].getSequence(), 5, "Sequence of the second list should be 5");
		equal(aSequencedLists[2].getSequence(), 9, "Sequence of the third list should be 9");
		
		oFF.removeAllLists();
				
		// Verify that active/inactive behavior
		oFF.addList(new sap.m.FacetFilterList({active: false, sequence: 9}));
		oFF.addList(new sap.m.FacetFilterList({sequence: 5}));
		oFF.addList(new sap.m.FacetFilterList({active: false, sequence: 3}));
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 1, "There should be one sequenced list");
		equal(aSequencedLists[0].getSequence(), 5, "Sequence of the list should be 5");		
		
		
		oFF.getLists()[0].setActive(true);
		aSequencedLists = oFF._getSequencedLists();
		equal(aSequencedLists.length, 2, "There should be two sequenced lists");
		equal(aSequencedLists[0].getSequence(), 5, "Sequence of the first list should be 5");		
        equal(aSequencedLists[1].getSequence(), 6, "Sequence of the second list should be 6");
		
		oFF.destroy();
	});	
	
	test("FacetFilter._getButtonForList", function() {
		
		var sListTitle = "List";
		var oFF = new sap.m.FacetFilter();
		var oFFL = new sap.m.FacetFilterList({title: sListTitle});
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges(); //_getButtonForList is implicitly called upon rendering
		
		var oButton = oFF.getAggregation("buttons")[0];
		strictEqual(oFF._getButtonForList(oFFL), oButton, "There should be only one button instance created per list");
		equal(oButton.getText().indexOf(sListTitle), 0, "Button text should contain the list title");
		equal(oButton.getAssociation("list"), oFFL.getId(), "Button should be associated with the list");
		
		destroyFF(oFF);
	});
	
	test("FacetFilter._getFacetRemoveIcon", function() {   
		
		var oFF = new sap.m.FacetFilter({
			showPersonalization: true
		});
		var oFFL = new sap.m.FacetFilterList({title: "List"});
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges(); //_getFacetRemoveIcon is implicitly called upon rendering
		
		var oIcon = oFF.getAggregation("removeFacetIcons")[0];
		strictEqual(oFF._getFacetRemoveIcon(oFFL), oIcon, "There should be only one icon instance created per list");
		ok(oIcon.getTooltip(),"Facet Remove icon has tooltip");
		destroyFF(oFF);
	});
	
	asyncTest("FacetFilter._displayRemoveIcon", function() {
		
		var oFF = new sap.m.FacetFilter({
			showPersonalization: true
		});
		var oFFL = new sap.m.FacetFilterList({title: "List"});
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		var oPopover = oFF._getPopover();
		
		oPopover.attachEventOnce("afterOpen", function(oEvent) {
			
			start();
			
			oFF._displayRemoveIcon(false, oFFL);
			ok(getRemoveIconCtrl(oFF, 0).$().hasClass("sapMFFLHiddenRemoveIcon"), "The remove icon should not be displayed.");
			oFF._displayRemoveIcon(true, oFFL);
			ok(getRemoveIconCtrl(oFF, 0).$().hasClass("sapMFFLVisibleRemoveIcon"), "The remove icon should be displayed.");
			
			destroyFF(oFF);
		});
		openPopover(oFF, 0);
	});	

  asyncTest("FacetFilter RemoveIcon should be displayed", function() {
         var oFF = new sap.m.FacetFilter({
         showPersonalization: true
         });
         var oFFL = new sap.m.FacetFilterList({title: "List",showRemoveFacetIcon:true});
         oFF.addList(oFFL);
         oFF.placeAt("content");
         sap.ui.getCore().applyChanges();
         var oPopover = oFF._getPopover();
         oPopover.attachEventOnce("afterOpen", function(oEvent) {
             start();
             ok(getRemoveIconCtrl(oFF, 0).$().hasClass("sapMFFLVisibleRemoveIcon"), "The remove icon should  be displayed.");
             destroyFF(oFF);
         });
         openPopover(oFF, 0);
  });

    asyncTest("FacetFilter RemoveIcon should not be displayed", function() {
         var oFF = new sap.m.FacetFilter({
         showPersonalization: true
         });
         var oFFL = new sap.m.FacetFilterList({title: "List",showRemoveFacetIcon:false});
         oFF.addList(oFFL);
         oFF.placeAt("content");
         sap.ui.getCore().applyChanges();
         var oPopover = oFF._getPopover();
         oPopover.attachEventOnce("afterOpen", function(oEvent) {
             start();
             ok(getRemoveIconCtrl(oFF, 0).$().hasClass("sapMFFLHiddenRemoveIcon"), "The remove icon should not be displayed.");
             destroyFF(oFF);
         });
         openPopover(oFF, 0);
  });

   
	test("FacetFilter._getAddFacetButton", function() {
		var oFF = new sap.m.FacetFilter();
		var oAddFacetButton = oFF.getAggregation("addFacetButton");
		strictEqual(oAddFacetButton, oFF._getAddFacetButton(), "There should only be one instance of the add facet button created for the lifetime of the FacetFilter");
		equal(oAddFacetButton.getIcon(), sap.ui.core.IconPool.getIconURI("add-filter"), "Button should have the add-filter icon URI");
		equal(oAddFacetButton.getType(), sap.m.ButtonType.Transparent, "Button type should be Transparent");
		ok(oAddFacetButton.getTooltip(),"Add facet Button has tooltip");
		destroyFF(oFF);
	});
	
	test("FacetFilter._createResetButton", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oResetButton = oFF._createResetButton();
		notStrictEqual(oResetButton, oFF._createResetButton(), "A new button should be created with each call");
		
		equal(oResetButton.getIcon(), sap.ui.core.IconPool.getIconURI("undo"), "Button should have the undo icon URI");
		equal(oResetButton.getType(), sap.m.ButtonType.Transparent, "Button type should be Transparent");
		ok(oResetButton.getTooltip(),"Reset Button has tooltip");
		
		destroyFF(oFF);
	});	
	
	test("FacetFilter._addOKButtonToPopover", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oPopover = oFF._getPopover();
		
		oFF._addOKButtonToPopover(oPopover);
		var oButton = oPopover.getFooter();
		ok(oButton, "Popover OK button should be created and added to the popover footer");
		equal(oButton.getWidth(), "100%", "Popover OK button width should be 100%");
		ok(oButton.getText(), "Button text should be set");
		ok(oButton.getTooltip(), "Button tooltip should be set");
		
		destroyFF(oFF);
	});
	
	test("FacetFilter._getSummaryBar", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oSummaryBar = oFF.getAggregation("summaryBar");
		strictEqual(oSummaryBar, oFF._getSummaryBar(), "There should only be one instance of the summary bar created for the lifetime of the FacetFilter");
		
		equal(oSummaryBar.getContent().length, 1, "Summary bar should have one control in its content");
		var oText = oSummaryBar.getContent()[0];
		ok(oText instanceof sap.m.Text, "Summary bar should have a Text control as its contents");
		ok(!oSummaryBar.getActive(), "Summary bar should be inactive");
		equal(oSummaryBar.getDesign(), sap.m.ToolbarDesign.Info, "Summary bar design should be Info");
		equal(oSummaryBar.getHeight(), "auto", "Toolbar height should be auto");
		destroyFF(oFF);
	});
	
	test("FacetFilter._getSelectedItemsText", function() {
	    var oFF = new sap.m.FacetFilter();
	    var oFFL = new sap.m.FacetFilterList({
	           title : "List1",
	           items : [
	                 new sap.m.FacetFilterItem({text: "Val1"}),
	                 new sap.m.FacetFilterItem({key: "2", text: "Val2"}),
	                 new sap.m.FacetFilterItem({text: "Val3"}),
	                 new sap.m.FacetFilterItem({text: "Val4"})
	           ]
	    });
	    oFF.addList(oFFL);

	    oFFL.setSelectedKeys({"2" : "Val2"});
	    oFFL.getItems()[0].setSelected(true);
	    
	    var aText = oFF._getSelectedItemsText(oFFL);
	    equal(aText.length, 2, "There are two texts from selected items");
	    equal(aText[0], "Val1", "Check that value matches the text of selected item");
	    equal(aText[1], "Val2", "Check that value matches the text of selected item");
	    
	    destroyFF(oFF);
	});

	test("FacetFilter._getSummaryText", function() {
		
	    var oFF = oSCHelper.createFFWithModel();
	    var oFFL = oFF.getLists()[0];
	    oFF.placeAt("content");
	    
	    oFFL.setSelectedKeys({"4" : "Val4"});
	    oFFL.getItems()[2].setSelected(true);	    
	    
	    ok(oFF._getSummaryText().indexOf("Val3") > -1, "Summary text contains the selected item");
	    ok(oFF._getSummaryText().indexOf("Val4") > -1, "Summary text contains the selected item");
	    
	    destroyFF(oFF);
	});
	
	
	test("FacetFilter._addResetToSummary, _removeResetFromSummary", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oSummaryBar = oFF._getSummaryBar();
		
		oFF._addResetToSummary(oSummaryBar);
		equal(oSummaryBar.getContent().length, 3, "The summary bar should contain three controls");
		oFF._addResetToSummary(oSummaryBar);
		equal(oSummaryBar.getContent().length, 3, "The summary bar should still contain three controls");
		
		oFF._removeResetFromSummary(oSummaryBar);
		equal(oSummaryBar.getContent().length, 1, "The summary bar should contain one control");
		oFF._removeResetFromSummary(oSummaryBar);
		equal(oSummaryBar.getContent().length, 1, "The summary bar should still contain one control");
		destroyFF(oFF);
	});
	
	test("FacetFilter._setButtonText", function() {
		
		var sItemText1 = "Val1", sItemText2 = "Val2"; 
		var oFF = new sap.m.FacetFilter();
		var oFFL = new sap.m.FacetFilterList({
			title: "List",
			multiSelect: false // Turn off multi select otherwise the FacetFilter will expect the select all checkbox to exist
		});
		oFFL.addItem(new sap.m.FacetFilterItem({text: sItemText1}));
		oFFL.addItem(new sap.m.FacetFilterItem({text: sItemText2}));
		oFF.addList(oFFL);
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		var oButton = oFF._getButtonForList(oFFL);
		oFFL.getItems()[0].setSelected(true);
		oFF._setButtonText(oFFL);
		ok(oButton.getText().indexOf(sItemText1) !== -1, "Button should be updated with text for the first list item");	
		ok(oButton.getTooltip().indexOf(sItemText1) !== -1, "Button tooltip should be updated  for the first list item");	
		destroyFF(oFF);
	});		
	
	test("FacetFilterList.init", function() {
		
		var oFFL = new sap.m.FacetFilterList();
		strictEqual(oFFL.getMultiSelect(), true, "List multiSelect should be enabled by default");
		strictEqual(oFFL.getMode(), sap.m.ListMode.MultiSelect, "List mode should be MultiSelect by default");
		strictEqual(oFFL.getIncludeItemInSelection(), true, "List item selection should include the whole item by default");				
		
		oFFL.destroy();
	});	
	
	asyncTest("FacetFilterList._updateActiveState", function() {
		
		var oFF = new sap.m.FacetFilter();
		var oFFL1 = new sap.m.FacetFilterList({
			active: false,
			title: "List1"
		});
		oFFL1.addItem(new sap.m.FacetFilterItem());
		oFF.addList(oFFL1);		
		var oFFL2 = new sap.m.FacetFilterList({
			active: false,
			title: "List2"
		});
		oFFL2.addItem(new sap.m.FacetFilterItem());
		oFF.addList(oFFL2);
		var oFFL3 = new sap.m.FacetFilterList({
			active: false,
			title: "List3",
			items: {
				path: "/values",
				template: new sap.m.FacetFilterItem( {
					text: "{text}",
					key: "{key}"
				})
			}
		});
		oFFL3.setModel(new sap.ui.model.json.JSONModel({
			values: [{key: "1", text: "Val1"},{key: "2", text: "Val2"},{key: "3", text: "Val3"}]
		}));
		oFF.addList(oFFL3);		
		
		oFF.placeAt("content");
		sap.ui.getCore().applyChanges();
		
		var oDialog = oFF._getFacetDialog();
		oDialog.attachEventOnce("afterOpen", function(oEvent) {
			
			var oFacetListItem = getDialogFacetList(oFF).getItems()[0];
			var oNavContainer = oDialog.getContent()[0];
			oNavContainer.attachEventOnce("afterNavigate", function(oEvent) {

				// Verify the active state when an item is selected and then deselected
				var oList = getDialogFilterItemsList(oFF);
				strictEqual(oList.getActive(), false, "The list should be inactive initially");
				strictEqual(oList.getSelectedItems().length, 0, "The list should not contain any selections initially");
				oList.getItems()[0].setSelected(true);				
				oList._updateActiveState();
				strictEqual(oList.getActive(), true, "List should be active after selecting item");
				oList.getItems()[0].setSelected(false);
				oList._updateActiveState();
				strictEqual(oList.getActive(), true, "List should remain active after deselecting item (once active it does not become inactive, rather all selected is assumed)");
				
				oNavContainer.attachEventOnce("afterNavigate", function(oEvent) {

					var oFacetListItem = getDialogFacetList(oFF).getItems()[1];
					
					oNavContainer.attachEventOnce("afterNavigate", function(oEvent) {
						
						// Verify the active state when the select all checkbox is checked
						var oList = getDialogFilterItemsList(oFF);
						strictEqual(oList.getActive(), false, "The list should be inactive initially");
						strictEqual(oList.getSelectedItems().length, 0, "The list should not contain any selections initially");
						
						var oFilterItemsPage = getDialogFilterItemsPage(oFF);
						var oCheckboxBar = oFilterItemsPage.getContent()[0];
						var oCheckBox = oCheckboxBar.getContentLeft()[0];
						strictEqual(oCheckBox.getSelected(), false, "Select all checkbox should be deselected initially");
						
						oCheckBox.setSelected(true);
						oList._updateActiveState();
						strictEqual(oList.getActive(), true, "List should be active after selecting the select all checkbox");
						
						oCheckBox.setSelected(false); //Checkbox will not allow deselection once the list is active and there are no selections
						oList._updateActiveState();
						strictEqual(oList.getActive(), true, "List should still be active after attempting to deselect the select all checkbox");
						
						oNavContainer.attachEventOnce("afterNavigate", function(oEvent) {
						
							var oFacetListItem = getDialogFacetList(oFF).getItems()[2];
							oNavContainer.attachEventOnce("afterNavigate", function(oEvent) {
							
								start();
								
								// Verify active state when the selected item is filtered from the list
								var oList = getDialogFilterItemsList(oFF);
								strictEqual(oList.isBound("items"), true, "Items should be bound when test requires filtering");
								strictEqual(oList.getActive(), false, "The list should be inactive initially");
								strictEqual(oList.getSelectedItems().length, 0, "The list should not contain any selections initially");								
								oList.getItems()[0].setSelected(true);
								oList._search("Val2");
								oList._updateActiveState();
								strictEqual(oList.getActive(), true, "List should be active after filtering out selected item");
								
								destroyFF(oFF);
							});
							
							// Navigate to the third list
							oFF._navToFilterItemsPage(oFacetListItem);
						});
						oFF._navFromFilterItemsPage(oNavContainer);
					});
					
					// Navigate to the second list
					oFF._navToFilterItemsPage(oFacetListItem);
				});
				oFF._navFromFilterItemsPage(oNavContainer);
			});
			
			// Navigate to the first list
			oFF._navToFilterItemsPage(oFacetListItem);
		});
		oFF.openFilterDialog();
	});		


	test("FacetFilterList._search, _getSearchValue", function() {

		var aValues = [{text : "a"}, {text : "ba"}, {text : "c"}, {text: ''}, {text: ' '}, {text: null}, {}];
		var oModel = new sap.ui.model.json.JSONModel({
			values : aValues
		})

		var oFFL = new sap.m.FacetFilterList();
		oFFL.bindAggregation("items", {
			path : "/values",
			template : new sap.m.FacetFilterItem({
				text : "{text}"
			})
		});
		oFFL.setModel(oModel);

		oFFL._search("x");
		strictEqual(oFFL.getItems().length, 0, "No items should match");
		equal(oFFL._getSearchValue(), "x", "Search value should be set correctly");
		oFFL._search("");
		strictEqual(oFFL.getItems().length, aValues.length, "Filter should be cleared and all items displayed");
		equal(oFFL._getSearchValue(), "", "Search value should be set correctly");
		oFFL._search("c");
		strictEqual(oFFL.getItems().length, 1, "One item should match");
		oFFL._search("");
		strictEqual(oFFL.getItems().length, aValues.length, "Filter should be cleared");
		oFFL._search("a");
		strictEqual(oFFL.getItems().length, 2, "Two items should match");

		oFFL.destroy();
	});


	asyncTest("FacetFilterList._updateSelectAllCheckBox", function() {

			var aValues = [{key : 'k1',text : "a"}, {key : 'k2',text : "ba"}, {key : 'k3',text : "c"}];
			oModel = new sap.ui.model.json.JSONModel({
				values : aValues
			})

			var oFFL = new sap.m.FacetFilterList();
			oFFL.bindAggregation("items", {
				path : "/values",
				template : new sap.m.FacetFilterItem({
					text : "{text}",
					key : "{key}"
				})
			});
			oFFL.setModel(oModel);
			var oFF = new sap.m.FacetFilter();
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();
			var oButton = oFF._getButtonForList(oFFL);
			oPopover.attachEventOnce("afterOpen", function(oEvent) {

				start();
				var oCheckBox = getPopoverSelectAllCheckBox(oPopover);
				ok(oCheckBox.getTooltip(),"Select All Checkbox for popover has tooltip");
				strictEqual(oCheckBox.getSelected(), true, "Select all checkbox should be selected");
				var oList = getPopoverFilterItemsList(oPopover);

				oFFL.getItems()[0].setSelected(true); // _updateSelectAllCheckBox called implicitly when list selection changes
				strictEqual(oCheckBox.getSelected(), false, "Select all checkbox should not be selected");

				// All items selected
				oFFL.getItems()[1].setSelected(true);
				strictEqual(oCheckBox.getSelected(), false, "Select all checkbox should not be selected");

				// Remove all selections
				oFFL.getItems()[0].setSelected(false);
				oFFL.getItems()[1].setSelected(false);
				strictEqual(oCheckBox.getSelected(), true, "Select all checkbox should be selected");

				// Verify the select all checkbox state is set correctly after search
				oFFL._search("c");
				oFFL.getItems()[0].setSelected(true);
				strictEqual(oCheckBox.getSelected(), false, "Select all checkbox should not be selected");
				oFFL._search("");
				strictEqual(oCheckBox.getSelected(), false, "Select all checkbox should not be selected");

				// Verify the select all checkbox state remains unchanged after search
				oFFL._search("a");
				oFFL.getItems()[0].setSelected(false);
				strictEqual(oCheckBox.getSelected(), false, "Select all checkbox should not be selected");
				oFFL._search("");
				strictEqual(oCheckBox.getSelected(), false, "Select all checkbox should not be selected");

				destroyFF(oFF);
			});
			openPopover(oFF, 0);
		});
	
		test("FacetFilterList._resetItemsBinding", function() {
			
			var oFFL = new sap.m.FacetFilterList();
			oFFL.setSelectedKeys({"val1": "Val1", "val2": "Val2"});
			
			oFFL.bindAggregation("items", {
				path: "/values",
				template: new sap.m.FacetFilterItem({
					text: "{text}",
					key: "{key}"
				})
			});
			
			equal(oFFL.getSelectedItems().length, 2, "Selected items should not have been removed");
			
			oFFL._searchValue = "x";
			
			oFFL.setModel(new sap.ui.model.json.JSONModel({
				values: [{text: "Val1", key: "val1"}, {text: "Val2", key: "val3"}]
			}));
			
			strictEqual(oFFL._searchValue, null, "Search value is cleared after items binding is reset");
			
			equal(oFFL.getSelectedItems().length, 2, "Selected items should not have been removed");
			
			oFFL.setModel(new sap.ui.model.json.JSONModel({
				values: [{text: "Val1", key: "val1"}, {text: "Val2", key: "val3"}]
			}));	
			
			equal(oFFL.getSelectedItems().length, 2, "Selected items should not have been removed after binding again");
			
			oFFL.destroy();
		});
		
		test("FacetFilterList._getScrollingArrow", function() {
		
			var oFF = new sap.m.FacetFilter();
			
			var oArrow = oFF._getScrollingArrow();
			ok(!oArrow, "Arrow control is null if an invalid name is given");
			oArrow = oFF._getScrollingArrow("left");
			ok(oArrow, "Arrow control is created");
			ok(oArrow instanceof sap.ui.core.Icon, "Arrow is an Icon");
			equal(oArrow.getId(), oFF.getId() + "-arrowScrollLeft", "Icon id is correct");
			ok(oArrow.hasStyleClass("sapMPointer"), "Style class is set");
			ok(oArrow.hasStyleClass("sapMFFArrowScroll"), "Style class is set");
			ok(oArrow.hasStyleClass("sapMFFArrowScrollLeft"), "Style class is set");
			ok(oFF.getAggregation("arrowLeft"), "arrowLeft aggregation is set");
            ok(oArrow.getTooltip(), "arrowLeft has tooltip");
			strictEqual(oFF._getScrollingArrow("left"), oArrow, "Icon is created only once");
			
			
			oArrow = oFF._getScrollingArrow("right");
			ok(oArrow, "Arrow control is created");
			ok(oArrow instanceof sap.ui.core.Icon, "Arrow is an Icon");
			equal(oArrow.getId(), oFF.getId() + "-arrowScrollRight", "Icon id is correct");
			ok(oArrow.hasStyleClass("sapMPointer"), "Style class is set");
			ok(oArrow.hasStyleClass("sapMFFArrowScroll"), "Style class is set");
			ok(oArrow.hasStyleClass("sapMFFArrowScrollRight"), "Style class is set");
			ok(oFF.getAggregation("arrowRight"), "arrowLeft aggregation is set");
            ok(oArrow.getTooltip(), "arrowRight has tooltip");
			strictEqual(oFF._getScrollingArrow("right"), oArrow, "Icon is created only once");
			
			destroyFF(oFF);
		});

		test("FacetFilterItem.init", function() {
			var oItem = new sap.m.FacetFilterItem();

			ok(oItem.hasStyleClass("sapMFFLI"), "sapMFFLI style class set");
			oItem.destroy();
		});

		
		
		module("Public API");

		test("FacetFilterItem.setCount", function() {

			var iCount1 = 14, iCount2 = 67;
			var oItem = new sap.m.FacetFilterItem();

			oItem.setCount(iCount1);
			equal(oItem.getCount(), iCount1, "Item count should be set");
			equal(oItem.getCounter(), iCount1, "Item counter should be set to the same value");

			oItem.setCount(iCount2);
			equal(oItem.getCount(), iCount2, "Item count should be set");
			equal(oItem.getCounter(), iCount2, "Item counter should be set to the same value");
			
			oItem.destroy();
		});

		test("FacetFilterItem.setCounter", function() {

			var iCount1 = 14, iCount2 = 67;
			var oItem = new sap.m.FacetFilterItem();

			oItem.setCounter(iCount1);
			equal(oItem.getCount(), iCount1, "Item count should be set");
			equal(oItem.getCounter(), iCount1, "Item counter should be set to the same value");

			oItem.setCounter(iCount2);
			equal(oItem.getCount(), iCount2, "Item count should be set");
			equal(oItem.getCounter(), iCount2, "Item counter should be set to the same value");
			
			oItem.destroy();
		});

		test("FacetFilter.openFilterDialog", function() {

			var oFF = new sap.m.FacetFilter();
			oFF.openFilterDialog();

			var oDialog = oFF.getAggregation("dialog")
			ok(oDialog.isOpen(), "Dialog should be opened");
			var aContent = oDialog.getContent();
			equal(aContent.length, 1, "Dialog contains one control in its content");
			ok(aContent[0] instanceof sap.m.NavContainer, "The dialog content is a NavContainer");

			destroyFF(oFF);
		});

		test("FacetFilter.removeList, removeAggregation", function() {

			var oFF = new sap.m.FacetFilter({
				showPersonalization : true
			});
			oFF.addList(new sap.m.FacetFilterList());
			oFF.addList(new sap.m.FacetFilterList());
			oFF.addList(new sap.m.FacetFilterList());
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var fnGetButtonRefs = function() {
				var aButtonRefs = [];
				for ( var sRef in oFF._buttons) {
					aButtonRefs.push(sRef);
				}
				return aButtonRefs;
			}
			var fnGetIconRefs = function() {

				var aIconRefs = [];
				for ( var sRef in oFF._removeFacetIcons) {
					aIconRefs.push(sRef);
				}
				return aIconRefs;
			}
			var fnTestAggregations = function(iExpected, sRemoveListId) {

				equal(fnGetButtonRefs().length, iExpected, "The buttons map should have " + iExpected + " buttons");
				equal(oFF.getAggregation("buttons").length, iExpected, "The buttons aggregation should have " + iExpected
						+ " buttons");
				equal(fnGetIconRefs().length, iExpected, "The remove icon map should have" + iExpected + "icons");
				equal(oFF.getAggregation("removeFacetIcons").length, iExpected, "The removeFacetIcons aggregation should have "
						+ iExpected + " icons");

				if (sRemoveListId) {
					strictEqual(oFF._buttons[sRemoveListId], undefined, "Button entry in buttons map should be deleted");
					strictEqual(oFF._removeFacetIcons[sRemoveListId], undefined,
							"Icon entry in removeFacetIcons map should be deleted");
				}
			}

			// Establish baseline conditions
			fnTestAggregations(3);

			// Now incrementally remove all lists
			var sRemoveListId = oFF.getLists()[0].getId();
			oFF.removeList(oFF.getLists()[0]);
			fnTestAggregations(2, sRemoveListId);

			var sRemoveListId = oFF.getLists()[0].getId();
			oFF.removeList(oFF.getLists()[0]);
			fnTestAggregations(1, sRemoveListId);

			var sRemoveListId = oFF.getLists()[0].getId();
			oFF.removeAggregation("lists", oFF.getLists()[0]);
			fnTestAggregations(0, sRemoveListId);

			destroyFF(oFF);
		});
		
		
		test("FacetFilterList.removeSelections model inherited from core, binding in listOpen", function() {
						
			var aItemsData = [{key: "1", text: "Val1"},{key: "2", text: "Val2"},{key: "3", text: "Val3"}];
			var oModel = new sap.ui.model.json.JSONModel({
				values: aItemsData
			});
			sap.ui.getCore().setModel(oModel);
			
			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title: "List",
				listOpen: function(oEvent) {
					
					this.bindAggregation("items", {
						path: "/values",
						template: new sap.m.FacetFilterItem({
							text: "{text}",
							key: "{key}"
						})
					});		
					this.removeSelections(true);
					equal(this.getSelectedItems().length, 0, "All items should be deselected");
					destroyFF(oFF);
				}
			});
			oFF.addList(oFFL);		
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();
			
			oFFL.setSelectedKeys({"1": "Val1", "2": "Val2"});
			oFFL.fireListOpen();
		});		
		
		test("FacetFilterList.removeSelections model set directly on list (not inherited)", function() {
			
			var aItemsData = [{key: "1", text: "Val1"},{key: "2", text: "Val2"},{key: "3", text: "Val3"}];
			
			var oFF = new sap.m.FacetFilter();
			var oFFL1 = new sap.m.FacetFilterList({
				items: {
					path: "/values",
					template: new sap.m.FacetFilterItem( {
						text: "{text}",
						key: "{key}"
					})
				}
			});
			oFFL1.setModel(new sap.ui.model.json.JSONModel({
				values: aItemsData
			}));
			oFF.addList(oFFL1);		
			
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();
			
			oFFL1.setSelectedKeys({"1": "Val1", "2": "Val2"});
			
			oFFL1.removeSelections(false);		
			var aKeys = Object.getOwnPropertyNames(oFFL1.getSelectedKeys());
			equal(aKeys.length, 2, "All keys should be returned");
			oFFL1.removeSelections(); // no parameter
			aKeys = Object.getOwnPropertyNames(oFFL1.getSelectedKeys());
			equal(aKeys.length, 2, "All keys should be returned");
			oFFL1.removeSelections(true); 
			aKeys = Object.getOwnPropertyNames(oFFL1.getSelectedKeys());
			equal(aKeys.length, 0, "No keys should be returned");
			
			destroyFF(oFF);
		});
		
		test("FacetFilterList.removeSelections no model and no binding", function() {
			var oFFL = new sap.m.FacetFilterList();			
			oFFL.setSelectedKeys({"1": "Val1", "2": "Val2"});
			oFFL.removeSelections(true); 
			var aKeys = Object.getOwnPropertyNames(oFFL.getSelectedKeys());
			equal(aKeys.length, 0, "No keys should be returned");			
			oFFL.destroy();
		});
		
		test("FacetFilterList.getSelectedItems", function() {
			
			var aItemsData = [{key: "1", text: "Val1"},{key: "2", text: "Val2"},{key: "3", text: "Val3"}];
			
			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				growingThreshold: 2, // Make sure the third item is not actually created so that we can test selection
				items: {
					path: "/values",
					template: new sap.m.FacetFilterItem( {
						text: "{text}",
						key: "{key}"
					})
				}
			});
			
			var oModel = new sap.ui.model.json.JSONModel({
				values: aItemsData
			})
			oFFL.setModel(oModel);
			equal(oFFL.getItems().length, 2, "Only two items should be created");
			oFF.addList(oFFL);		
			
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();	
			
			var aSelectedItems = oFFL.getSelectedItems();
			equal(aSelectedItems.length, 0, "Empty array should be returned when nothing is selected");
			
			oFFL.setSelectedKeys({"1": "Val1", "3": "Val3"});			
			
			var aKeys = Object.getOwnPropertyNames(oFFL.getSelectedKeys());
			aSelectedItems = oFFL.getSelectedItems();
			equal(aSelectedItems.length, aKeys.length, "Number of selected keys should match the number of selected items");
			equal(aSelectedItems.length, 2, "All items selected via keys should be returned");
			equal(aSelectedItems[0].getKey(), "1", "First item key should be correct");
			equal(aSelectedItems[1].getKey(), "3", "Second item key should be correct");
			
			destroyFF(oFF);
		});
		
		test("FacetFilterList.getSelectedItem", function() {
		
			var aItemsData = [{key: "1", text: "Val1"},{key: "2", text: "Val2"},{key: "3", text: "Val3"}];
			
			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				mode: sap.m.ListMode.SingleSelectMaster,
				growingThreshold: 2, // Make sure the third item is not actually created so that we can test selection
				items: {
					path: "/values",
					template: new sap.m.FacetFilterItem( {
						text: "{text}",
						key: "{key}"
					})
				}
			});
			
			var oModel = new sap.ui.model.json.JSONModel({
				values: aItemsData
			});
			oFFL.setModel(oModel);
			oFF.addList(oFFL);		
			
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();	
			
			strictEqual(oFFL.getSelectedItem(), null, "No item should be selected");
			
			oFFL.setSelectedKeys({"1": "Val1"});
			
			equal(oFFL.getSelectedItem().getKey(), "1", "Item should be selected");
			
			oFFL.setSelectedKeys({"3": "Val3"});
			ok(oFFL.getSelectedItem(), "Item should be selected");
			oFFL.getSelectedItem() && equal(oFFL.getSelectedItem().getKey(), "3", "The correct item should be selected");
			
			// Now the multi-select case
			oFFL = new sap.m.FacetFilterList({
				items: {
					path: "/values",
					template: new sap.m.FacetFilterItem( {
						text: "{text}",
						key: "{key}"
					})
				}
			});
			
			var oModel = new sap.ui.model.json.JSONModel({
				values: aItemsData
			});
			oFFL.setModel(oModel);
			oFF.addList(oFFL);	
			
			oFFL.setSelectedKeys({"35": "Val35", "23": "Val23", "67": "Val16", "16": "Val16"});
			ok(oFFL.getSelectedItem(), "Item should be selected");
			oFFL.getSelectedItem() && equal(oFFL.getSelectedItem().getKey(), "16", "The last added item should be selected when the list is multi-select");
			
			destroyFF(oFF);
		});
		
		test("FacetFilterList.removeItem", function() {
			
			var oFFL = new sap.m.FacetFilterList();
			var oFFI1 = new sap.m.FacetFilterItem({text: "Val1", key: "1"});
			var oFFI2 = new sap.m.FacetFilterItem({text: "Val2", key: "2", selected: true});
			oFFL.addItem(oFFI1);
			oFFL.addItem(oFFI2);
			
			var oItem = oFFL.removeItem(oFFI2);
			strictEqual(oItem, oFFI2, "The returned item should match the removed item");
			var aSelectedKeys = Object.getOwnPropertyNames(oFFL.getSelectedKeys());
			equal(aSelectedKeys.length, 0, "There should be no selected keys");
			
			oFFL.destroy();
		});
		
		test("FacetFilterList.removeSelectedKey, _removeSelectedKey", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];

			// No errors appear when method is called first time
			oFFL.removeSelectedKey();

			oFFL._addSelectedKey("key1");
			oFFL._addSelectedKey("key2", "text");

			oFFL.removeSelectedKey("key1");
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 1, "1 item removed from _oSelectedKeys");

			oFFL.removeSelectedKey("key1");
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 1,
					"Removal of the same item does not remove another item");

			oFFL.removeSelectedKey("key2");
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 0,
					"The last item removed from _oSelectedKeys");

			// No error appear when removing from empty object
			oFFL.removeSelectedKey("key2");
			oFFL.removeSelectedKey(undefined, "key2");
			
			var sItemText = "Graphics Card";
			oFFL._addSelectedKey(undefined, sItemText);
			oFFL.removeSelectedKey(undefined, sItemText);
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 0, "item removed from _oSelectedKeys");
			
			oFFL.addItem(new sap.m.FacetFilterItem({key: "addedItem", text: "Memory Module", selected: true}));
			var iNumItems = oFFL.getItems().length;
			equal(oFFL.getSelectedItems()[0].getKey(), "addedItem", "Added item is selected");
			oFFL.removeSelectedKey("addedItem");
			equal(oFFL.getItems()[iNumItems - 1].getSelected(), false, "Added item is not selected");

			destroyFF(oFF);
		});		
		
		test("FacetFilterList.removeSelectedKeys", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];
			
			oFFL.setSelectedKeys({"1": "Val1", "2": "Val2", "3": "Val3"});
			oFFL.removeSelectedKeys();

			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 0, "All keys are removed");
			strictEqual(oFFL.getSelectedItems().length, 0, "All items are deselected");

			destroyFF(oFF);
		});		
		
		

		module("Events");

		asyncTest("FacetFilterList.listOpen", function() {

			var oListOpenEvent = null;
			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});
			oFFL.attachEventOnce("listOpen", function(oEvent) {

				start();
				ok(oEvent, "List open event should exist");
				oFF._closePopover();
			});
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();
			oPopover.attachEventOnce("afterOpen", function(oEvent) {

				destroyFF(oFF);
			});

			openPopover(oFF, 0);
		});

		asyncTest("FacetFilterList.listClose - none selected", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});
			oFFL.attachListClose(function(oEvent) {

				start();
				ok(oEvent, "Event should exist");
				var aSelectedItems = oEvent.getParameter("selectedItems");
				equal(aSelectedItems.length, 0, "No items should be selected");
				var oSelectedKeys = oEvent.getParameter("selectedKeys");
				equal(Object.getOwnPropertyNames(oSelectedKeys).length, 0, "No items should be selected");
				var bAllSelected = oEvent.getParameter("allSelected");
				equal(bAllSelected, true, "allSelected parameter should be true");
				destroyFF(oFF);
			});
			oFFL.addItem(new sap.m.FacetFilterItem({
				selected : false
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				selected : false
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				selected : false
			}));
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();
			oPopover.attachEventOnce("afterOpen", function() {

				oFF._closePopover();
			});
			openPopover(oFF, 0);
		});

		asyncTest("FacetFilterList.listClose - some selected", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});
			oFFL.attachListClose(function(oEvent) {

				start();
				ok(oEvent, "Event should exist");
				var aSelectedItems = oEvent.getParameter("selectedItems");
				equal(aSelectedItems.length, 2, "Two items should be selected");
				strictEqual(aSelectedItems[0].getKey(), oFFL.getItems()[0].getKey(), "The first item should be present in the event");
				strictEqual(aSelectedItems[1].getKey(), oFFL.getItems()[2].getKey(), "The last item should be present in the event");
				ok(aSelectedItems[0].getSelected(), "The item should be selected");
				ok(aSelectedItems[1].getSelected(), "The item should be selected");
				
				var oSelectedKeys = oEvent.getParameter("selectedKeys");
				equal(Object.getOwnPropertyNames(oSelectedKeys).length, 2, "Two items should be selected");
				
				var bAllSelected = oEvent.getParameter("allSelected");
				strictEqual(bAllSelected, false, "allSelected parameter should be false");

				destroyFF(oFF);
			});
			oFFL.addItem(new sap.m.FacetFilterItem({
				selected : true,
				key: "1",
				text: "Val1"
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				selected : false,
				key: "2",
				text: "Val2"				
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				selected : true,
				key: "3",
				text: "Val3"
			}));
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();
			oPopover.attachEventOnce("afterOpen", function() {

				oFF._closePopover();
			});
			openPopover(oFF, 0);
		});

		asyncTest("FacetFilterList.listClose - all selected", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});
			oFFL.attachListClose(function(oEvent) {

				start();
				ok(oEvent, "Event should exist");
				var aSelectedItems = oEvent.getParameter("selectedItems");
				equal(aSelectedItems.length, 3, "All items should be selected");
				strictEqual(aSelectedItems[0].getKey(), oFFL.getItems()[0].getKey(), "The first item should be present in the event");
				strictEqual(aSelectedItems[1].getKey(), oFFL.getItems()[1].getKey(), "The second item should be present in the event");
				strictEqual(aSelectedItems[2].getKey(), oFFL.getItems()[2].getKey(), "The last item should be present in the event");
				ok(aSelectedItems[0].getSelected(), "The item should be selected");
				ok(aSelectedItems[1].getSelected(), "The item should be selected");
				ok(aSelectedItems[2].getSelected(), "The item should be selected");
				var bAllSelected = oEvent.getParameter("allSelected");
				strictEqual(bAllSelected, false, "allSelected parameter should be false");

				destroyFF(oFF);
			});
			oFFL.addItem(new sap.m.FacetFilterItem({
				key: "1",
				selected : true
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				key: "2",
				selected : true
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				key: "3",
				selected : true
			}));
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();
			oPopover.attachEventOnce("afterOpen", function() {

				oFF._closePopover();
			});
			openPopover(oFF, 0);
		});

		asyncTest("FacetFilter.reset (no summary bar)", function() {

			var oResetEvent = null;
			var oFF = new sap.m.FacetFilter();

			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			oFF.attachEventOnce("reset", function(oEvent) {

				start();
				ok(oEvent, "Filter reset event triggered");
				destroyFF(oFF);
			});

			var oResetButton = oFF.getAggregation("resetButton");
			oResetButton.firePress();
		});

		asyncTest("FacetFilter.reset (summary bar)", function() {

			var oResetEvent = null;
			var oFF = new sap.m.FacetFilter({
				showSummaryBar : true
			});

			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			oFF.attachEventOnce("reset", function(oEvent) {

				start();
				ok(oEvent, "Filter reset event triggered");
				destroyFF(oFF);
			});

			var oSummaryBar = oFF.getAggregation("summaryBar");
			var oResetButton = oSummaryBar.getContent()[2];
			oResetButton.firePress();
		});
		
		asyncTest("FacetFilter click another button when popover is opened", function() {
			var oFFL1ListCloseEvent = null, oFFL2ListOpenEvent=null;
			var oFF = new sap.m.FacetFilter();
			var oFFL1 = new sap.m.FacetFilterList({
				title : "List1"
			});
			var oFFL2 = new sap.m.FacetFilterList({
				title : "List2"
			});
			oFF.addList(oFFL1);
			oFF.addList(oFFL2);
			
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();
			// click another button after the first popover is opened
			oPopover.attachEventOnce("afterOpen", function(oEvent) {
				
				openPopover(oFF, 1);
				oFF._closePopover();
			});
			
			// timeout error will appear if oFFL2.listOpen is not called 
			
			// mark the listClose event is called
			oFFL1.attachEventOnce("listClose", function(oEvent) {
				// fail if the oFFL2.listOpen was called before
				ok(!oFFL2ListOpenEvent, 'oFFL2.listOpen should not be called before oFFL1.listClose');
				if (oFFL2ListOpenEvent) {
					start();
					destroyFF(oFF);
				} else {
					oFFL1ListCloseEvent = oEvent;
				}
			});
			
			// check that the prevoius list was closed before
			oFFL2.attachEventOnce("listOpen", function(oEvent) {
				// fail if the oFFL1.listClose wasn't called
				ok(oFFL1ListCloseEvent, "oFFL1.listClose should be called before oFFL2.listOpen");
				if (oFFL1ListCloseEvent) {					
					var oPopover = oFF._getPopover();
					oPopover.attachEventOnce("afterOpen", function(oEvent) {
						start();
						destroyFF(oFF);
					});
				} else {
					oFFL2ListOpenEvent = oEvent;
				}
			});
			
			openPopover(oFF, 0);
		});

		module("List Container Rendering");

		asyncTest("Popover rendering", function() {

			var oFF = new sap.m.FacetFilter({
				showPopoverOKButton : true
			});
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});
			var oFFI = new sap.m.FacetFilterItem({
				text : "val"
			});
			oFF.addList(oFFL);
			oFFL.addItem(oFFI);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();
			oPopover.attachEventOnce("afterOpen", function(oEvent) {
				start();
				ok(oPopover.getDomRef(), "Popover should be rendered");
				ok(oPopover.$().hasClass("sapMFFPop"), "Popover is rendered with the correct CSS class");

				ok(oFFL.getDomRef(), "List should be rendered");
				ok(oFFI.getDomRef(), "List item should be rendered");

				// Search field bar
				var oSearchFieldBar = oPopover.getCustomHeader();
				ok(oSearchFieldBar.getDomRef(), "Popover custom header bar should be rendered");
				var oSearchField = oSearchFieldBar.getContentMiddle()[0];
				ok(oSearchField.getDomRef(), "Popover search field should be rendered");

				// Select all checkbox bar
				var oCheckboxBar = oPopover.getSubHeader();
				ok(oCheckboxBar.getDomRef(), "Popover subheader bar should be rendered");
				var oCheckbox = oCheckboxBar.getContentLeft()[0];
				ok(oCheckbox.getDomRef(), "Select all checkbox should be rendered");

				// Popover ok button
				ok(oPopover.getFooter().getDomRef(), "Popover OK button should be rendered");
				destroyFF(oFF);
			});
			openPopover(oFF, 0);
		});

		asyncTest("Dialog rendering", function() {

			var oFF = new sap.m.FacetFilter({
				showPersonalization : true
			});
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});
			var oFFI = new sap.m.FacetFilterItem({
				text : "val"
			});
			oFF.addList(oFFL);
			oFFL.addItem(oFFI);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oDialog = oFF._getFacetDialog();
			oDialog.attachEventOnce("afterOpen", function(oEvent) {

				start();

				ok(oDialog.getDomRef(), "Dialog should be rendered");
				ok(oDialog.$().hasClass("sapMFFDialog"), "Dialog is rendered with the correct CSS class");

				// Facet list page
				var oSearchField = getDialogFacetSearch(oFF);
				ok(oSearchField instanceof sap.m.SearchField, "Control should be an instance of SearchField");
				ok(oSearchField.getTooltip(), "Dialog search field has tooltip");
				ok(oSearchField.getDomRef(), "Facet search field should be rendered");
				var oFacetList = getDialogFacetList(oFF);
				ok(oFacetList instanceof sap.m.List, "Control should be an instance of List");
				ok(oFacetList.getDomRef(), "Dialog facet list should be rendered");
				var oFacetListItem = oFacetList.getItems()[0];
				ok(oFacetListItem.getDomRef(), "Facet list item should be rendered");

				oFF._navToFilterItemsPage(oFacetListItem);

				// Filter items page
				var oFilterItemsPage = getDialogFilterItemsPage(oFF);
				ok(oFilterItemsPage.getDomRef(), "Filter items page is rendered");

				var oSearchFieldBar = oFilterItemsPage.getSubHeader();
				ok(oSearchFieldBar.getDomRef(), "Filter items page subheader bar should be rendered");
				var oSearchField = oSearchFieldBar.getContentMiddle()[0];
				ok(oSearchField.getDomRef(), "Filter items page search field should be rendered");

				var oCheckboxBar = oFilterItemsPage.getContent()[0];
				ok(oCheckboxBar.getDomRef(), "Filter items page select all checkbox bar should be rendered");
				var oCheckbox = oCheckboxBar.getContentLeft()[0];
				ok(oCheckbox.getDomRef(), "Select all checkbox should be rendered");

				var oFilterItemsList = getDialogFilterItemsList(oFF);
				ok(oFilterItemsList instanceof sap.m.FacetFilterList, "Control should be an instance of FacetFilterList");
				ok(oFilterItemsList.getDomRef(), "Filter items list is rendered");

				ok(oFilterItemsList.getItems()[0].getDomRef(), "Filter item is rendered");

				destroyFF(oFF);
			});
			openDialogFromAddFacet(oFF);
		});

		module("Properties");

		test("FacetFilter.visible", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList();
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			strictEqual(oFF.getVisible(), true, "Visibility should be enabled by default");
			ok(getButtonCtrl(oFF, 0).getDomRef(), "Button should be rendered");

			oFF.setVisible(false);
			sap.ui.getCore().applyChanges();

			ok(!getButtonCtrl(oFF, 0).getDomRef(), "Button should not be rendered");

			destroyFF(oFF);
		});
			
				
       
	test("FacetFilter.retainListSequence", function() {
			var oFF = new sap.m.FacetFilter();

						
			// Verify that retainListSequence behavior when inactive and made active again.

			oFF.addList(new sap.m.FacetFilterList({
				active : false,
				sequence : 9,
				retainListSequence : true
			}));
			oFF.addList(new sap.m.FacetFilterList({
				sequence : 5
			}));
			oFF.addList(new sap.m.FacetFilterList({
				active : false,
				sequence : 3,
				retainListSequence : false
			}));
			aSequencedLists = oFF._getSequencedLists();
			equal(aSequencedLists.length, 1, "There should be one sequenced list");
			strictEqual(aSequencedLists[0].getRetainListSequence(), false,"List sequence should not be retained by default when list is inactive and made active again");
			equal(aSequencedLists[0].getSequence(), 5, "Sequence of the list should be 5");

			oFF.getLists()[0].setActive(true);
			aSequencedLists = oFF._getSequencedLists();
			equal(aSequencedLists.length, 2, "There should be two sequenced lists");
			equal(aSequencedLists[0].getSequence(), 5, "Sequence of the first list should be 5");
			equal(aSequencedLists[1].getSequence(), 9, "Sequence of the second list should be 9");

			oFF.getLists()[2].setActive(true);
			aSequencedLists = oFF._getSequencedLists();
			equal(aSequencedLists.length, 3, "There should be three sequenced lists");
			equal(aSequencedLists[0].getSequence(), 5, "Sequence of the first list should be 5");
			equal(aSequencedLists[1].getSequence(), 9, "Sequence of the second list should be 9");
			equal(aSequencedLists[2].getSequence(), 10, "Sequence of the second list should be 10");

			oFF.removeAllLists();

			oFF.destroy();
		});

		
		asyncTest("FacetFilter.showPersonalization", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList();
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			strictEqual(oFF.getShowPersonalization(), false, "Personalization should be disabled by default");

			oFF.setShowPersonalization(true);
			sap.ui.getCore().applyChanges();

			ok(getAddFacetCtrl(oFF).getDomRef(), "Add button should be displayed");
			equal(getAddFacetCtrl(oFF).$().find(".sapUiIcon").attr("data-sap-ui-icon-content").charCodeAt(0), 57430,
					"The add icon should be the add-filter icon font.");

			var oPopover = oFF._getPopover();
			oPopover.attachEventOnce("afterOpen", function(oEvent) {

				start();
				ok(getRemoveIconCtrl(oFF, 0).getDomRef(), "Facet filter remove icon should be rendered");
				equal(getRemoveIconCtrl(oFF, 0).$().attr("data-sap-ui-icon-content").charCodeAt(0), 57799,
						"The remove icon should be the sys-cancel icon font.");
				ok(getRemoveIconCtrl(oFF, 0).$().hasClass("sapMFFLVisibleRemoveIcon"), "The remove icon should be displayed.");

				destroyFF(oFF);
			});

			openPopover(oFF, 0);
		});

		test("FacetFilter.type", function() {

			// Verify Simple type
			var sFFL1Title = "List1", sFFL2Title = "List2";
			var oFFSimple = new sap.m.FacetFilter();
			oFFSimple.setShowPersonalization(true);
			oFFSimple.addList(new sap.m.FacetFilterList({
				title : sFFL1Title
			}));
			oFFSimple.addList(new sap.m.FacetFilterList({
				title : sFFL2Title
			}));
			oFFSimple.placeAt("content");
			sap.ui.getCore().applyChanges();

			var fnTestSimple = function(oFF) {

				if (!sap.ui.Device.system.phone) {

					var oFFL1 = oFF.getLists()[0];
					var oFFL2 = oFF.getLists()[1];

					// Main facet filter container
					ok(oFF.getDomRef(), "Facet filter container should be rendered");
					ok(oFF.$().hasClass("sapMFF"), "Facet filter container is rendered with the correct CSS class");

					// Popover buttons
					ok(getButtonCtrl(oFF, 0).getDomRef(), "Facet filter button should be rendered");
					ok(getButtonCtrl(oFF, 1).getDomRef(), "Facet filter button should be rendered");
					ok(getButtonCtrl(oFF, 0).$().text().indexOf(oFFL1.getTitle()) !== -1,
							"Facet filter button text should be rendered");
					ok(getButtonCtrl(oFF, 1).$().text().indexOf(oFFL2.getTitle()) !== -1,
							"Facet filter button text should be rendered");

					// Personalization, add facet icon
					ok(getAddFacetCtrl(oFF).getDomRef(), "The add facet button should be rendered");
					equal(getAddFacetCtrl(oFF).$().find(".sapUiIcon").attr("data-sap-ui-icon-content").charCodeAt(0), 57430,
							"The add icon should be the add-filter icon font.");

					// Personalization, remove facet icons 
					ok(getRemoveIconCtrl(oFF, 0).getDomRef(), "Facet filter remove icon should be rendered");
					ok(getRemoveIconCtrl(oFF, 1).getDomRef(), "Facet filter remove icon should be rendered");
					equal(getRemoveIconCtrl(oFF, 0).$().attr("data-sap-ui-icon-content").charCodeAt(0), 57799,
							"The remove icon should be the sys-cancel icon font.");
					ok(getRemoveIconCtrl(oFF, 0).$().hasClass("sapMFFLHiddenRemoveIcon"), "The remove icon should be hidden.");
					equal(getRemoveIconCtrl(oFF, 1).$().attr("data-sap-ui-icon-content").charCodeAt(0), 57799,
							"The remove icon should be the sys-cancel icon font.");
					ok(getRemoveIconCtrl(oFF, 1).$().hasClass("sapMFFLHiddenRemoveIcon"), "The remove icon should be hidden.");
				}
			};

			fnTestSimple(oFFSimple);

			// Verify Light type
			var oFFLight = new sap.m.FacetFilter({
				type : sap.m.FacetFilterType.Light
			});
			oFFLight.setShowPersonalization(true);
			oFFLight.addList(new sap.m.FacetFilterList({
				title : sFFL1Title
			}));
			oFFLight.addList(new sap.m.FacetFilterList({
				title : sFFL2Title
			}));

			oFFLight.placeAt("content");
			sap.ui.getCore().applyChanges();

			var fnTestLight = function(oFF) {

				var oSummaryBar = oFF.getAggregation("summaryBar");
				ok(oSummaryBar.getDomRef(), "Summary bar should be rendered");
				ok(oSummaryBar.getActive(), "Summary bar should be active when type is Light");
				var oSummaryBarText = oSummaryBar.getContent()[0];
				ok(oSummaryBarText.getDomRef(), "Summary bar text should be rendered");
				ok(oSummaryBarText.getText(), "There should be text in the summary bar");
				ok(oSummaryBarText.getTooltip(), "There should be tooltip for the text in the summary bar");

				testResetInSummaryBar(oFF, true);
			};
			fnTestLight(oFFLight);

			// Switch from simple to light		
			oFFSimple.setType(sap.m.FacetFilterType.Light);
			sap.ui.getCore().applyChanges();
			fnTestLight(oFFSimple);

			// Switch from light to simple		
			oFFLight.setType(sap.m.FacetFilterType.Simple);
			sap.ui.getCore().applyChanges();
			fnTestSimple(oFFLight);

			oFFSimple.destroy();
			oFFLight.destroy();

			// If running on the phone then test behavior if type is explicitly set to Simple
			if (sap.ui.Device.system.phone) {

				var oFFPhone = new sap.m.FacetFilter({
					type : sap.m.FacetFilterType.Simple
				});
				oFFPhone.setShowPersonalization(true);
				oFFPhone.placeAt("content");
				sap.ui.getCore().applyChanges();
				fnTestLight(oFFPhone);
			}
		});

		asyncTest("FacetFilter.liveSearch", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "Live Search",
				items : {
					path : "/values",
					template : new sap.m.FacetFilterItem({
						text : "{text}"
					})
				}
			});

			oFF.addList(oFFL);

			// Need a model and binding to test search
			var oListModel = new sap.ui.model.json.JSONModel({

				values : [{
					text : "Val1"
				}, {
					text : "Val2"
				}, {
					text : "Val10"
				}]
			});
			oFFL.setModel(oListModel);

			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();

			oPopover.attachEventOnce("afterOpen", function(oEvent) {

				var oSearchField = getPopoverFilterItemsSearchField(oPopover);

				oFFL.attachEventOnce("updateFinished", function(oEvent) {

					var aFilteredItems = oFFL.getItems();
					equal(aFilteredItems.length, 2, "There should be two items left after live search");
					equal(aFilteredItems[0].getText(), "Val1");
					equal(aFilteredItems[1].getText(), "Val10");

					// Now disable live search
					ok(oFF.setLiveSearch(false), "setLiveSearch should support method chaining");

					oFFL.attachEventOnce("updateFinished", function(oEvent) {

						start();
						ok(false, "Live search should not have triggered a search");
						destroyFF(oFF);
					});

					oSearchField.fireLiveChange({
						newValue : "x"
					});

					setTimeout(function() {
						// Start the test runner and destroy the FF after the search has completed
						start();
						destroyFF(oFF);
					});
				});

				oSearchField.fireLiveChange({
					newValue : "Val1"
				});
			});
			openPopover(oFF, 0);
		});

		test(
				"FacetFilter.showReset",
				function() {

					var oFF = new sap.m.FacetFilter();
					oFF.placeAt("content");
					sap.ui.getCore().applyChanges();

					// First test the reset button with a FacetFilter of Simple type
					ok(
							oFF.$().hasClass("sapMFFResetSpacer"),
							"FacetFilter container should have spacer class to insure reset button does not overlay facet buttons when type is Simple");

					var $div = oFF.$().find(".sapMFFResetDiv");
					equal($div.length, 1,
							"There should be a container element around the reset button having the correct style class");
					ok($div.is("div"), "The container is a div");
					var $button = $div.find("button");
					ok($button, "There should be a button element within the container element");
					oFF.setShowReset(false);
					sap.ui.getCore().applyChanges();

					ok(
							!oFF.$().hasClass("sapMFFResetSpacer"),
							"FacetFilter container should not have spacer class to insure reset button does not overlay facet buttons when type is Simple");
					equal(oFF.$().find(".sapMFFResetDiv").length, 0, "There should not be a div container");
					equal(oFF.$().find(".sapMFF > button").length, 0, "There should not be a button");

					destroyFF(oFF);

					// Now test when the reset button is displayed in the summary bar
					var oFF = new sap.m.FacetFilter({
						showSummaryBar : true
					});
					oFF.placeAt("content");
					sap.ui.getCore().applyChanges();

					testResetInSummaryBar(oFF, true);

					oFF.setShowReset(false);
					sap.ui.getCore().applyChanges();

					testResetInSummaryBar(oFF, false);

					destroyFF(oFF);
				});

		test("FacetFilter.showSummaryBar", function() {

			var oFF = new sap.m.FacetFilter();
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			ok(!oFF.getAggregation("summaryBar").getDomRef(), "Summary bar should not be displayed");

			oFF.setShowSummaryBar(true);
			sap.ui.getCore().applyChanges();

			var oSummaryBar = oFF.getAggregation("summaryBar");
			ok(oSummaryBar.getDomRef(), "Summary bar should be displayed");
			ok(!oSummaryBar.getActive(), "Summary bar should be inactive when type is Simple");
			testResetInSummaryBar(oFF, true);

			oFF.setShowSummaryBar(false);
			sap.ui.getCore().applyChanges();

			oFF.setShowSummaryBar(true);
			oFF.setShowReset(false);
			sap.ui.getCore().applyChanges();

			testResetInSummaryBar(oFF, false);

			destroyFF(oFF);
		});

		test("FacetFilterList.active", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList();
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			strictEqual(oFFL.getActive(), true, "List active should be enabled by default");
			ok(getButtonCtrl(oFF, 0).getDomRef(), "Button should be rendered");

			oFFL.setActive(false);
			sap.ui.getCore().applyChanges();

			strictEqual(oFFL.getActive(), false, "List active should be disabled");
			ok(!getButtonCtrl(oFF, 0).getDomRef(), "Button should not be rendered");

			destroyFF(oFF);
		});

		test("FacetFilterList.multiSelect", function() {

			var oFFL = new sap.m.FacetFilterList();

			ok(oFFL.setMultiSelect(false), "setMultiSelect should support method chaining");
			strictEqual(oFFL.getMultiSelect(), false, "List multiSelect should be changed to false");
			strictEqual(oFFL.getMode(), sap.m.ListMode.SingleSelectMaster,
					"List mode should be changed to SingleSelectMaster");
			oFFL.destroy();
		});

		test("FacetFilterList.mode", function() {

			var oFFL = new sap.m.FacetFilterList();

			ok(oFFL.setMode(sap.m.ListMode.SingleSelectMaster), "setMode should support method chaining");
			strictEqual(oFFL.getMode(), sap.m.ListMode.SingleSelectMaster, "List mode should be SingleSelectMaster");
			strictEqual(oFFL.getMultiSelect(), false, "List multiSelect should be changed to false");

			oFFL.setMode(sap.m.ListMode.None);
			oFFL.setMode(sap.m.ListMode.SingleSelect);
			oFFL.setMode(sap.m.ListMode.Delete);
			oFFL.setMode(sap.m.ListMode.SingleSelectLeft);
			strictEqual(oFFL.getMode(), sap.m.ListMode.SingleSelectMaster,
					"Current list mode should be retained after attempting to set invalid modes");
			oFFL.destroy();
		});

		test("FacetFilterList.title", function() {

			var initialTitle = "a", changedTitle = "b";
			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : initialTitle
			});
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			equal(oFFL.getTitle(), initialTitle, "List title should be set to the initial value");
			ok(getButtonCtrl(oFF, 0).$().text().indexOf(oFFL.getTitle()) !== -1,
					"Button label should be set to the initial value");

			ok(oFFL.setTitle(changedTitle), "setTitle should support method chaining");
			sap.ui.getCore().applyChanges();

			equal(oFFL.getTitle(), changedTitle, "List title should be set to the changed value");
			ok(getButtonCtrl(oFF, 0).$().text().indexOf(oFFL.getTitle()) !== -1,
					"Button label should be set to the changed value");

			destroyFF(oFF);
		});

		test("FacetFilter should be shrinkable", function() {
			var oFF = new sap.m.FacetFilter();
			ok(oFF.getMetadata().isInstanceOf("sap.ui.core.IShrinkable"), "Facet filter is shrinkable");
			oFF.destroy();
		});

		module("Selection Text Update");

		asyncTest("Selection button text updated after popover close", function() {

			var sItem1Text = "Val1";
			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});

			// Need to have more than one item otherwise selecting the only item in the list
			// is interpreted as all items selected and there will be no change in the button text		
			oFFL.addItem(new sap.m.FacetFilterItem({
				text : sItem1Text
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				text : "Val2"
			}));
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oPopover = oFF._getPopover();

			oPopover.attachEventOnce("afterOpen", function(oEvent) {

				var oList = getPopoverFilterItemsList(oPopover);
				oList.getItems()[0].setSelected(true);

				oPopover.attachEventOnce("afterClose", function(oEvent) {

					start();
					sap.ui.getCore().applyChanges();
					var oButton = getButtonCtrl(oFF, 0);
					ok(oButton.getText().indexOf(sItem1Text) !== -1, "Button text should be updated with the selected value");
					destroyFF(oFF);
				});
				oFF._closePopover();
			});
			openPopover(oFF, 0);
		});

		asyncTest("Selection button text updated after dialog close", function() {

			var sItem1Text = "Val1";
			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "List"
			});

			// Need to have more than one item otherwise selecting the only item in the list
			// is interpreted as all items selected and there will be no change in the button text
			oFFL.addItem(new sap.m.FacetFilterItem({
				text : sItem1Text
			}));
			oFFL.addItem(new sap.m.FacetFilterItem({
				text : "Val2"
			}));
			oFF.addList(oFFL);
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oDialog = oFF._getFacetDialog();

			oDialog.attachEventOnce("afterOpen", function(oEvent) {

				var oNavContainer = oDialog.getContent()[0];
				oNavContainer.attachEventOnce("afterNavigate", function(oEvent) {

					var oList = getDialogFilterItemsList(oFF);
					oList.getItems()[0].setSelected(true);

					oDialog.attachEventOnce("afterClose", function(oEvent) {

						start();
						sap.ui.getCore().applyChanges();
						var oButton = getButtonCtrl(oFF, 0);
						ok(oButton.getText().indexOf(sItem1Text) !== -1, "Button text should be updated with the selected value");
						ok(oButton.getTooltip().indexOf(sItem1Text) !== -1,
								"Button tooltip should be updated with the selected value");
						destroyFF(oFF);
					});

					oFF._closeDialog();
				});
				oFF._navToFilterItemsPage(oNavContainer.getPages()[0].getContent()[0].getItems()[0]);
			});
			oFF.openFilterDialog();
		});

		module("Selected keys");

		/* Helper functions for the module */
		var oSCHelper = {

			createFFWithBinding : function() {
				var oFF = new sap.m.FacetFilter({
					showPersonalization : true
				});
				var oFFL = new sap.m.FacetFilterList({
					title : "List1",
					growing : true,
					growingThreshold : 3,
					items : {
						path : "/values",
						template : new sap.m.FacetFilterItem({
							text : "{text}",
							key : "{key}"
						})
					}
				});

				oFF.addList(oFFL);
				return oFF;
			},

			createModel : function() {
				return new sap.ui.model.json.JSONModel({
					values : [{
						text : "Val1",
						key : "1"
					}, {
						text : "Val2",
						key : "2"
					}, {
						text : "Val3",
						key : "3"
					}, {
						text : "Val4",
						key : "4"
					}, {
						text : "Val5",
						key : "5"
					}, {
						text : "Val6",
						key : "6"
					}]
				});
			},

			createFFWithModel : function() {
				// Need a model and binding to test search
				var oFF = oSCHelper.createFFWithBinding();
				oFF.getLists()[0].setModel(oSCHelper.createModel())
				return oFF;
			}
		}
		/* END Helper functions for the module */

		test("FacetFilterList._addSelectedKey", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];

			oFFL.setMode(sap.m.ListMode.SingleSelectMaster);

			oFFL._addSelectedKey();
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 0, "Undefined item is not added");

			oFFL._addSelectedKey(undefined, "test");
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 1, "Items without the keys are added");

			oFFL._addSelectedKey("key1");
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 1, "Item without text is added");
			strictEqual(oFFL._oSelectedKeys["key1"], "key1", "If item has no text then key is used as a text");

			oFFL._addSelectedKey("key1", "text1");
			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 1, "Items with text is added");
			strictEqual(oFFL._oSelectedKeys["key1"], "text1", "Key/text pair is stored in the object");

			oFFL._addSelectedKey("key2", "text2");

			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 1, "Only one item isstored");
			strictEqual(oFFL._oSelectedKeys["key2"], "text2", "Key/text pair is stored in the object");

			// Switch to mult select and verify more than one key is added
			oFFL.setMode(sap.m.ListMode.MultiSelect);
			oFFL._addSelectedKey("key1", "text1");

			strictEqual(Object.getOwnPropertyNames(oFFL._oSelectedKeys).length, 2, "Items with text is added");
			strictEqual(oFFL._oSelectedKeys["key1"], "text1", "Key/text pair is stored in the object");
			strictEqual(oFFL._oSelectedKeys["key2"], "text2", "Key/text pair is stored in the object");
			destroyFF(oFF);
		});

		test("FacetFilterList._isItemSelected",
				function() {
					var oFF = oSCHelper.createFFWithModel();
					var oFFL = oFF.getLists()[0];

					// No errors appear when method is called first time
					oFFL._addSelectedKey("key1");
					oFFL._addSelectedKey("key2", "text2");
					oFFL._addSelectedKey("", "text3");

					strictEqual(oFFL._isItemSelected(new sap.m.FacetFilterItem({
						key : 'key1'
					})), true, 'Item with key only is selected');
					strictEqual(oFFL._isItemSelected(new sap.m.FacetFilterItem({
						key : 'key2'
					})), true, 'Item with key and text is selected');
					strictEqual(oFFL._isItemSelected(new sap.m.FacetFilterItem({
						text : 'text2'
					})), false, 'Item cannot be selected by text if the key is specified');
					strictEqual(oFFL._isItemSelected(new sap.m.FacetFilterItem({
						text : 'text3'
					})), true, 'Item with text only is selected');
					strictEqual(oFFL._isItemSelected(new sap.m.FacetFilterItem()), false,
							'Item with no text and key is not selected');
					strictEqual(oFFL._isItemSelected(), false, '"undefined" item is not selected');

					destroyFF(oFF);
				});

		test("Getting selected keys", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];

			var oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 0, "There are no keys selected");

			oFFL.getItems()[1].setSelected(true);
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 1, "There is one key selected");
			strictEqual(oKeys["2"], "Val2", "Key '2' is selected");

			oKeys["3"] = "Val3";
			equal(Object.getOwnPropertyNames(oFFL.getSelectedKeys()).length, 1,
					"Changing the result of getSelectedKeys does not change selected keys in FacetFilterList");

			destroyFF(oFF);
		});

		test("Setting selected keys", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];
			var oSelectedKeys = {
				"2" : "Val2"
			};

			var oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 0, "There are no keys selected");

			oFFL.getItems()[2].setSelected(true);
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 1, "There is one key selected");
			strictEqual(oKeys["3"], "Val3", "Key '3' is selected");

			oFFL.setActive(false);
			oFFL.setSelectedKeys(oSelectedKeys);
			strictEqual(oFFL.getActive(), true, 'FacetFilterList is set to "active" when key is added');

			oKeys = oFFL.getSelectedKeys();
			strictEqual(oFFL.getItems()[1].getSelected(), true, "FacetFilterItem with key '2' is selected");
			equal(Object.getOwnPropertyNames(oKeys).length, 1, "There is one key selected");
			strictEqual(oKeys["2"], "Val2", "Key '2' is selected");

			// Empty, null, undefined clears the list
			oFFL.setSelectedKeys({});
			oKeys = oFFL.getSelectedKeys();
			strictEqual(oFFL.getItems()[1].getSelected(), false, "FacetFilterItem with key '2' is not selected");
			equal(Object.getOwnPropertyNames(oKeys).length, 0, "Empty object clears selected keys");

			oFFL.setSelectedKeys(oSelectedKeys);
			oFFL.setSelectedKeys(null);
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 0, "null clears selected keys");

			oFFL.setSelectedKeys(oSelectedKeys);
			oFFL.setSelectedKeys();
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 0, "undefined clears selected keys");

			destroyFF(oFF);
		});

		test("Setting selected keys with binding aggregation", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];

			oFFL.setSelectedKeys({
				"2" : "Val2"
			});
			oFFL.setModel(oFFL.getModel());

			oKeys = oFFL.getSelectedKeys();
			strictEqual(oFFL.getItems()[1].getSelected(), true, "FacetFilterItem with key '2' is selected");
			equal(Object.getOwnPropertyNames(oKeys).length, 1, "There is one key selected");
			strictEqual(oKeys["2"], "Val2", "Key '2' is selected");

			destroyFF(oFF);
		});

		test("Filter model after selection", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];
			oFFL.setSelectedKeys({
				"3" : null
			});

			oFFL._search("Val2");
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 1, "There is one key selected");
			strictEqual(oKeys["3"], "Val3", "Key '3' is selected");

			oFFL._search("");
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 1, "There is one key selected");
			strictEqual(oFFL.getItems()[2].getSelected(), true, "FacetFilterItem with key '3' is selected")
			strictEqual(oKeys["3"], "Val3", "Key '3' is selected");

			destroyFF(oFF);
		});

		test("FacetFilterList.onItemSetSelected", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];
			oFFL.setActive(false);
			oFFL.setMultiSelect(false);

			var oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 0, "There are no keys selected");

			oFFL.getItems()[1].setSelected(true);

			strictEqual(oFFL.getActive(), true, 'FacetFilterList is set to "active" when key is added');
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 1, "There is one key selected");
			strictEqual(oKeys["2"], "Val2", "Key '2' is selected");

			oFFL.getItems()[1].setSelected(false);
			oKeys = oFFL.getSelectedKeys();
			equal(Object.getOwnPropertyNames(oKeys).length, 0, "There are no keys selected");

			var oItem = oFFL.getItems()[0];
			oItem.setSelected(true);
			strictEqual(oFFL._oSelectedItem, oItem,
					"ListBase.onItemSetSelected should have been called so that single selection state is maintained");

			destroyFF(oFF);
		});

		asyncTest("Preselected items on growing list", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];

			oFFL.setSelectedKeys({
				"4" : "Val4"
			});
			equal(oFFL.getItems().length, 3, "There are only three items in the list");

			oFFL.attachEventOnce("updateFinished", function(oEvent) {

				start();
				equal(oFFL.getItems().length, 6, "There are six items in the list");
				strictEqual(oFFL.getItems()[3].getSelected(), true, "Item in the growing part was selected");

				destroyFF(oFF);
			});
			//TODO change this to actually display the popover
			oFFL._oGrowingDelegate.requestNewPage();
		});

		test("Items in non-growing list are preselected before the model is assigned", function() {

			var oFF = oSCHelper.createFFWithBinding();
			var oFFL = oFF.getLists()[0];
			oFFL.setGrowing(false);
			oFF.placeAt("content");
			oFFL.setSelectedKeys({
				"1" : "Val1"
			});
			oFFL.setModel(oSCHelper.createModel());
			ok(!!Object.getOwnPropertyNames(oFFL.getSelectedKeys()).length, "Selected keys are present");
			ok(oFFL.getItems()[0].getSelected(), "Item is selected");

			oFFL.removeSelections(true);
			equal(Object.getOwnPropertyNames(oFFL.getSelectedKeys()).length, 0, "Selected keys are removed");
			strictEqual(oFFL.getItems()[0].getSelected(), false, "Item is not selected");

			destroyFF(oFF);
		});

		test("Items in non-growing list are preselected before items binding", function() {

			var oFF = new sap.m.FacetFilter();
			var oFFL = new sap.m.FacetFilterList({
				title : "List",
				growing : false
			});
			oFF.addList(oFFL);
			oFF.placeAt("content");
			oFFL.setModel(oSCHelper.createModel());

			oFFL.setSelectedKeys({
				"1" : "Val1"
			});
			oFFL.bindAggregation("items", {
				path : "/values",
				template : new sap.m.FacetFilterItem({
					text : "{text}",
					key : "{key}"
				})
			});

			ok(!!Object.getOwnPropertyNames(oFFL.getSelectedKeys()).length, "Selected keys are present");
			ok(oFFL.getItems()[0].getSelected(), "Item is selected");

			oFFL.removeSelections(true);
			equal(Object.getOwnPropertyNames(oFFL.getSelectedKeys()).length, 0, "Selected keys are removed");
			strictEqual(oFFL.getItems()[0].getSelected(), false, "Item is not selected");

			destroyFF(oFF);
		});

		test("Update button text when items are preselected", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];

			oFFL.setSelectedKeys({
				"4" : "Val4"
			});

			oFF.placeAt("content");
			sap.ui.getCore().applyChanges();

			var oButton = oFF._getButtonForList(oFFL);
			strictEqual(oButton.getText().indexOf("Val4") > -1, true,
					"Selected item is not in the model but is displayed on the button");

			oFFL.setSelectedKeys({
				"4" : "Val4",
				"2" : "Val4"
			});
			// rerendering required to display selected keys
			oFF.rerender();
			sap.ui.getCore().applyChanges();
			strictEqual(oButton.getText().indexOf("2") > -1, true, "Two items are displayed on the button");

			oFFL.setSelectedKeys({
				"4" : "Val4"
			});
			oFFL._search("Val2");
			oFF.rerender();
			sap.ui.getCore().applyChanges();
			strictEqual(oButton.getText().indexOf("Val4") > -1, true,
					"Selected item is not in the model and the model is filtered to another item");

			oFFL.setGrowing(false);
			oFF.rerender();
			sap.ui.getCore().applyChanges();
			strictEqual(oButton.getText().indexOf("Val4") > -1, true,
					"Selected item is not in the model and the model is filtered to another item");

			destroyFF(oFF);
		});

		test("'All' checkbox to be unchecked when items are preselected and model is assigned later", function() {
			var oFF = oSCHelper.createFFWithBinding();
			var oFFL = oFF.getLists()[0];

			oFFL.setSelectedKeys({
				"4" : "Val4"
			});

			var oCheckbox = oFF._createSelectAllCheckboxBar(oFFL).getContentLeft()[0];

			oFFL.setModel(oSCHelper.createModel());

			ok(!oCheckbox.getSelected(), "Select all checkbox should be unchecked because of preselected items");

			oCheckbox.fireSelect({
				selected : true
			});
			ok(!Object.getOwnPropertyNames(oFFL.getSelectedKeys()).length,
					"Selected keys should be cleared by selecting 'All' checkbox");

			destroyFF(oFF);
		});

		test("The selected keys are cleared when the list is made inactive", function() {
			var oFF = oSCHelper.createFFWithModel();
			var oFFL = oFF.getLists()[0];
			oFF.placeAt("content");
			sap.ui.getCore().applyChanges(); //_getFacetRemoveIcon is implicitly called upon rendering

			oFFL.setSelectedKeys({
				"4" : "Val4"
			});
			var oIcon = oFF.getAggregation("removeFacetIcons")[0];

			oIcon.firePress({
				selected : true
			});
			ok(!Object.getOwnPropertyNames(oFFL.getSelectedKeys()).length,
					"Selected keys should be cleared by making list inactive");

			destroyFF(oFF);
		});

		// Helper functions

		function getButtonCtrl(oFF, iIndex) {
			return oFF._buttons[oFF.getLists()[iIndex].getId()];
		}

		function getRemoveIconCtrl(oFF, iIndex) {
			return oFF._removeFacetIcons[oFF.getLists()[iIndex].getId()];
		}

		function getAddFacetCtrl(oFF) {
			return sap.ui.getCore().byId(oFF.getId() + "-add");
		}

		function openPopover(oFF, iIndex) {

			qutils.triggerMouseEvent(getButtonCtrl(oFF, iIndex), "tap");
		}

		function openDialogFromAddFacet(oFF) {

			qutils.triggerMouseEvent(getAddFacetCtrl(oFF), "tap");
		}

		function getDialogFacetSearchField(oFacetPage) {

			return oFacetPage.getSubHeader().getContentMiddle()[0];
		}

		function getDialogFilterItemsSearchField(oFilterItemsPage) {

			return oFilterItemsPage.getSubHeader().getContentMiddle()[0];
		}

		function getPopoverFilterItemsSearchField(oPopover) {

			return oPopover.getCustomHeader().getContentMiddle()[0];
		}

		function getPopoverSelectAllCheckBox(oPopover) {

			var oBar = oPopover.getSubHeader();
			return oBar.getContentLeft()[0];
		}

		function getPopoverFilterItemsList(oPopover) {
			return oPopover.getContent()[0];
		}

		function getDialogFacetList(oFF) {

			var oFacetPage = getDialogFacetPage(oFF);
			var oList = oFacetPage.getContent()[0];
			return oList;
		}

		function getDialogFilterItemsPage(oFF) {

			var oDialog = oFF.getAggregation("dialog");
			var oNavCont = oDialog.getContent()[0];
			return oNavCont.getPages()[1];
		}

		function getDialogFilterItemsList(oFF) {

			var oPage = getDialogFilterItemsPage(oFF);
			var oList = oPage.getContent()[0];
			if (!(oList instanceof sap.m.List)) { //May need to skip the select all checkbox bar if the list is multi select
				oList = oPage.getContent()[1];
			}
			return oList;
		}

		function getDialogFacetPage(oFF) {

			var oDialog = oFF.getAggregation("dialog");
			var oNavCont = oDialog.getContent()[0];
			return oNavCont.getPages()[0];
		}

		function getDialogFacetSearch(oFF) {

			var oFacetPage = getDialogFacetPage(oFF);
			var oSearchField = oFacetPage.getSubHeader().getContentMiddle()[0];
			return oFacetPage.getSubHeader().getContentMiddle()[0];
		}

		function testResetInSummaryBar(oFF, bDisplayed) {

			var oSummaryBar = oFF.getAggregation("summaryBar");
			if (bDisplayed) {
				equal(oSummaryBar.getContent().length, 3,
						"The summary bar should have 3 controls in its content when the reset button is displayed");
				var oToolbarSpacer = oSummaryBar.getContent()[1];
				ok(
						oToolbarSpacer instanceof sap.m.ToolbarSpacer,
						"The second control in the summary bar content should be a spacer so that the reset button is displayed on the right side of the toolbar");
				var oResetButton = oSummaryBar.getContent()[2];
				ok(oResetButton instanceof sap.m.Button, "The third control in the summary bar content should be a button");
			} else {

				equal(oSummaryBar.getContent().length, 1,
						"The summary bar should have 1 control in its content when the reset button is not displayed");
			}
		}

		/*
		 * Make sure the popover and dialog are closed before destroying, otherwise popover/dialog
		 * timers still run and then find their object is destroyed, causing an error to be logged after a few seconds.
		 */
		function destroyFF(oFF, bAsync) { //TODO: see if this helps with ie9 qunit failures

			var oPopover = oFF.getAggregation("popover");
			if (oPopover) {
				if (oPopover.isOpen()) {
					oPopover.attachEventOnce("afterClose", function(oEvent) {
						destroyFF(oFF);
					});

					oFF._closePopover();
					return;
				}
			}

			oFF.destroy();
		}

	}
</script>
</head>

<body class="sapUiBody">
	<div id="content"></div>
	<h1 id="qunit-header">qUnit Page for sap.m.FacetFilter</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol></div>
</body>
</html>

