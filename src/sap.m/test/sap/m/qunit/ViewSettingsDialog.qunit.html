<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>qUnit Page for sap.m.ViewSettingsDialog</title>

		<script id="sap-ui-bootstrap"
			type="text/javascript"
			src="../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.m">
		</script>

		<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript" src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script type="text/javascript" src="../../../../resources/sap/ui/thirdparty/sinon.js"></script>
		<script type="text/javascript" src="../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
		<script type="text/javascript" src="../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>
		<script type="text/javascript" src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>

		<script language="javascript">

			jQuery.sap.require("sap.ui.model.FilterOperator");
			sinon.config.useFakeTimers = false;

			/* definition of a custom control */

			var customPriceFilter = new sap.m.VBox({
				items: [
					new sap.m.Label("minLabel", {
						design: sap.m.LabelDesign.Bold,
						text: "Minimum price:"
					}),
					new sap.m.Slider("minSlider", {
						value: 0,
						min: 0,
						max: 100,
						step: 10,
						progress: true,
						liveChange: function (oEvent) {
							oEvent.getSource().getParent().getItems()[0].setText("Minimum price >= " + oEvent.getParameter("value"));
						}
					}),
					new sap.m.Label("maxLabel", {
						design: sap.m.LabelDesign.Bold,
						text: "Maximum price:"
					}),
					new sap.m.Slider("maxSlider", {
						value: 100,
						min: 0,
						max: 100,
						step: 10,
						progress: true,
						liveChange: function (oEvent) {
							oEvent.getSource().getParent().getItems()[2].setText("Maximum price <= " + oEvent.getParameter("value"));
						}
					})
				]
			}).addStyleClass("customPriceFilter");

			/* helper function to compare the filter state */

			var compareFilterKeys = function(o1, o2) {
				var sKey = "",
					result = true;

				for(sKey in o1) {
					if (o1.hasOwnProperty(sKey)) {
						if (!o2[sKey] || o2[sKey] !== o1[sKey]) {
							result = false;
						}
					}
				}
				for(sKey in o2) {
					if (o2.hasOwnProperty(sKey)) {
						if (!o1[sKey] || o1[sKey] !== o2[sKey]) {
							result = false;
						}
					}
				}
				return result;
			};

			var model = new sap.ui.model.json.JSONModel();
			model.setData({
				customTabData : {
					checkbox_label : "lorem ipsum checkbox label"
				}
			});
			sap.ui.getCore().setModel(model);

			var oVsdConfig = {
				// Factory for the 'content' aggregation for custom tabs - with or without items in it.
				customTabsFactory: function (sId, bEmptyContent) {
					var oInst = new sap.m.ViewSettingsCustomTab({
						id	 	: sId,
						title	: sId,
						content : []
					});
					if (!bEmptyContent) {
						oInst.addContent( new sap.m.Button({
							text: 'test'
						}));
						oInst.addContent( new sap.m.CheckBox({
							name: 'test',
							text: '{/customTabData/checkbox_label}'
						}));
					}
					return oInst;
				},

				addSortItems: function (oVsdInst) {
					oVsdInst.addSortItem(new sap.m.ViewSettingsItem({
						key: "myNameSorter",
						text: "Name"
					}));
					oVsdInst.addSortItem(new sap.m.ViewSettingsItem({
						key: "myStatusSorter",
						text: "Status"
					}));
					oVsdInst.addSortItem(new sap.m.ViewSettingsItem({
						key: "myValueSorter",
						text: "Value"
					}));
					oVsdInst.addSortItem(new sap.m.ViewSettingsItem({
						key: "myPriceSorter",
						text: "Price"
					}));
				},

				addFilterItems: function (oVsdInst) {
					oVsdInst.addFilterItem(new sap.m.ViewSettingsFilterItem({
						key: "myNameFilter",
						text: "Name",
						items: [
							new sap.m.ViewSettingsItem({
								key: "name1",
								text: "Headphone"
							}),
							new sap.m.ViewSettingsItem({
								key: "name2",
								text: "Mousepad"
							}),
							new sap.m.ViewSettingsItem({
								key: "name3",
								text: "Monitor"
							}),
							new sap.m.ViewSettingsItem({
								key: "name4",
								text: "Backpack"
							}),
							new sap.m.ViewSettingsItem({
								key: "name5",
								text: "Printer"
							}),
							new sap.m.ViewSettingsItem({
								key: "name6",
								text: "Optic Mouse"
							}),
							new sap.m.ViewSettingsItem({
								key: "name7",
								text: "Dock Station"
							})
						]
					}));

					oVsdInst.addFilterItem(new sap.m.ViewSettingsFilterItem({
						key: "myStatusFilter",
						text: "Status",
						items: [
							new sap.m.ViewSettingsItem({
								key: "status1",
								text: "Approved"
							}),
							new sap.m.ViewSettingsItem({
								key: "status2",
								text: "Open"
							}),
							new sap.m.ViewSettingsItem({
								key: "status3",
								text: "Denied"
							})
						]
					}));

					oVsdInst.addFilterItem(new sap.m.ViewSettingsFilterItem({
						key: "myValueFilter",
						text: "Value",
						items: [
							new sap.m.ViewSettingsItem({
								key: "value1",
								text: "< 10 EUR"
							}),
							new sap.m.ViewSettingsItem({
								key: "value2",
								text: "10 - 30 EUR"
							}),
							new sap.m.ViewSettingsItem({
								key: "value3",
								text: "30 - 50 EUR"
							}),
							new sap.m.ViewSettingsItem({
								key: "value4",
								text: "50 - 70 EUR"
							}),
							new sap.m.ViewSettingsItem({
								key: "value5",
								text: "> 70 EUR"
							})
						]
					}));

					// custom price control filter
					oVsdInst.addFilterItem(new sap.m.ViewSettingsCustomItem({
						key: "myPriceFilter",
						text: "Price",
						customControl: customPriceFilter.clone()
					}));
				},

				addPresetFilterItems: function(oVsdInst) {
					// preset filters
					oVsdInst.addPresetFilterItem(new sap.m.ViewSettingsItem({
						key: "myPresetFilter1",
						text: "A very complex filter"
					}));
					oVsdInst.addPresetFilterItem(new sap.m.ViewSettingsItem({
						key: "myPresetFilter2",
						text: "Ridiculously complex filter"
					}));
					oVsdInst.addPresetFilterItem(new sap.m.ViewSettingsItem({
						key: "myPresetFilter3",
						text: "Expensive stuff"
					}));
				},

				addGroupItems: function (oVsdInst) {
					// init grouping (some simple sorters with default grouping and some with a custom grouping)
					oVsdInst.addGroupItem(new sap.m.ViewSettingsItem({
						key: "myNameGrouper",
						text: "Name"
					}));
					oVsdInst.addGroupItem(new sap.m.ViewSettingsItem({
						key: "myStatusGrouper",
						text: "Status"
					}));
					oVsdInst.addGroupItem(new sap.m.ViewSettingsItem({
						key: "myValueGrouper",
						text: "Value"
					}));
					oVsdInst.addGroupItem(new sap.m.ViewSettingsItem({
						key: "myPriceGrouper",
						text: "Price"
					}));

				}
			};

			module("Initial Check", {
				setup : function () {
					this.oResourceBundle = sap.ui.getCore().getLibraryResourceBundle("sap.m");
					this.oVSD = new sap.m.ViewSettingsDialog();
					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

			test("Initialization", function () {
				ok(!jQuery.sap.domById(this.oVSD.getId()), "Dialog is not rendered before it's ever opened.");
				strictEqual(this.oVSD.getTitle(), "", 'The default title is empty and will be filled by "' + this.oResourceBundle.getText("VIEWSETTINGS_TITLE") + '" later');
				strictEqual(this.oVSD.getSortDescending(), false, 'The default value for sortDescending should be "false"');
				strictEqual(this.oVSD.getGroupDescending(), false, 'The default value for groupDescending should be "false"');
				strictEqual(this.oVSD.getSelectedSortItem(), null, 'The default value for selectedSortItem should be "null"');
				strictEqual(this.oVSD.getSelectedGroupItem(), null, 'The default value for selectedGroupItem should be "null"');
				strictEqual(this.oVSD.getSelectedPresetFilterItem(), null, 'The default value for selectedPresetFilterItem should be "null"');
			});

			module ("getter/setter", {
				setup : function () {
					this.oVSD = new sap.m.ViewSettingsDialog();
					this.oFilterState = {
						"name1": true,
						"name2": true,
						"name5": true,
						"name6": true,
						"status1": true,
						"status2": true,
						"status3": true,
						"value3": true
					};

					oVsdConfig.addSortItems(this.oVSD);
					oVsdConfig.addFilterItems(this.oVSD);
					oVsdConfig.addPresetFilterItems(this.oVSD);
					oVsdConfig.addGroupItems(this.oVSD);

					this.oSelectedSortItem = this.oVSD.getSortItems()[0];
					this.oSelectedGroupItem = this.oVSD.getGroupItems()[1];
					this.oSelectedPresetFilterItem = this.oVSD.getPresetFilterItems()[1];

					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

			test("set dialog state via API", function () {
				var oCore = sap.ui.getCore();

				/* set dialog state (solely by API instead of selected flag) */
				this.oVSD.setTitle("TestTitle");
				this.oVSD.setSelectedSortItem(this.oSelectedSortItem);
				this.oVSD.setSortDescending(true);
				this.oVSD.setSelectedGroupItem(this.oSelectedGroupItem);
				this.oVSD.setGroupDescending(true);
				this.oVSD.setSelectedPresetFilterItem(this.oSelectedPresetFilterItem);

				// title
				strictEqual(this.oVSD.getTitle(), "TestTitle", "The title should be 'TestTitle'");

				// sort / group / preset filter
				strictEqual(this.oVSD.getSelectedSortItem(), this.oSelectedSortItem.getId(), "The selected sort item should be '"+ this.oSelectedSortItem.getId() +"'");
				strictEqual(oCore.byId(this.oVSD.getSelectedSortItem()).getSelected(), true, "The selected sort item should have the selected flag set to true");
				strictEqual(this.oVSD.getSortDescending(), true, "sort descending should now be true");
				strictEqual(this.oVSD.getSelectedGroupItem(), this.oSelectedGroupItem.getId(), "The selected group item should be '"+ this.oSelectedGroupItem.getId() +"'");
				strictEqual(oCore.byId(this.oVSD.getSelectedGroupItem()).getSelected(), true, "The selected group item should have the selected flag set to true");
				strictEqual(this.oVSD.getGroupDescending(), true, "group descending should now be true");
				strictEqual(this.oVSD.getSelectedPresetFilterItem(), this.oSelectedPresetFilterItem.getId(), "The selected preset filter item should be '"+ this.oSelectedPresetFilterItem.getId() +"'");
				strictEqual(oCore.byId(this.oVSD.getSelectedPresetFilterItem()).getSelected(), true, "The selected preset filter item should have the selected flag set to true");

				// filters
				this.oVSD.setSelectedFilterKeys(this.oFilterState);
				ok(compareFilterKeys(this.oFilterState, this.oVSD.getSelectedFilterKeys()), "The computed filter keys should have the same structure as the passed one");
			});

			module("Performance", {
				setup : function () {
					this.oVSD = new sap.m.ViewSettingsDialog();
					this.oFilterState = {
						"name1": true,
						"name2": true,
						"name5": true,
						"name6": true,
						"status1": true,
						"status2": true,
						"status3": true,
						"value3": true
					};

					oVsdConfig.addSortItems(this.oVSD);
					oVsdConfig.addFilterItems(this.oVSD);
					oVsdConfig.addPresetFilterItems(this.oVSD);
					oVsdConfig.addGroupItems(this.oVSD);

					this.oSelectedSortItem = this.oVSD.getSortItems()[0];
					this.oSelectedGroupItem = this.oVSD.getGroupItems()[1];
					this.oSelectedPresetFilterItem = this.oVSD.getPresetFilterItems()[1];

					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

			test("The control is not invalidated on setting sort, group or filter Items", function () {

				sinon.spy(this.oVSD, "invalidate");

				this.oVSD.setSelectedSortItem(this.oSelectedSortItem);

				assert.ok(!this.oVSD.invalidate.called, "The control is not invalidated on setting selected Sort Item");

				this.oVSD.setSelectedGroupItem(this.oSelectedGroupItem);
				assert.ok(!this.oVSD.invalidate.called, "The control is not invalidated on setting selected Group Item");

				this.oVSD.setSelectedPresetFilterItem(this.oSelectedPresetFilterItem);
				assert.ok(!this.oVSD.invalidate.called, "The control is not invalidated on setting preset Filter Item");

				this.oVSD.setSelectedFilterKeys(this.oFilterState);
				assert.ok(!this.oVSD.invalidate.called, "The control is not invalidated on setting Filter keys");

				this.oVSD.invalidate.restore();
			});

			module("Open and Close", {
				setup : function () {
					this.oVSD = new sap.m.ViewSettingsDialog();

					oVsdConfig.addSortItems(this.oVSD);
					oVsdConfig.addFilterItems(this.oVSD);
					oVsdConfig.addPresetFilterItems(this.oVSD);

					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

			test("Open ViewSettingsDialog", function (){
				var sId = this.oVSD.getId();
				this.oVSD.open();

				ok(jQuery.sap.domById(sId + "-dialog"), "Dialog should be rendered");
				ok(jQuery.sap.domById(sId + "-navcontainer"), "Nav container should be rendered");
				ok(jQuery.sap.domById(sId + "-page1-cont"), "Page 1 (sort/group/filter content) should be rendered");
				ok(!jQuery.sap.domById(sId + "-page2-cont"), "Page 2 (filter detail content) should not be rendered");
				ok(jQuery.sap.byId(sId + "-sortbutton").hasClass("sapMSegBBtnSel"), "Segmented 'sort' button should be selected");
			});

			test("Open predefined tab", function() {
				this.oVSD.open("filter");

				ok(jQuery.sap.byId(this.oVSD.getId() + "-filterbutton").hasClass("sapMSegBBtnSel"), "Segmented 'filter' button should be selected");
			});

			test("Close ViewSettingsDialog", function (assert){
				var done = assert.async(),
					that = this;

				this.oVSD.open();
				this.oVSD._dialog.close();
				setTimeout(function() {
					ok(!that.oVSD._dialog.isOpen(), "Dialog should be in closed state");
					done();
				}, 1000);
			});

			test("Last Opened Page is correct on Cancel on second opening of the filter detail view", function () {
				this.oVSD.open();

				this.oVSD._switchToPage(2);
				jQuery.sap.delayedCall(0, this.oVSD._navContainer, "to", [this.oVSD.getId() + '-page2', "show"]);
				this.oVSD._switchToPage(3,this.oVSD.getFilterItems()[0]); // name details page

				this.oVSD._dialog.getBeginButton().firePress();

				this.oVSD.open();

				jQuery.sap.delayedCall(0, this.oVSD._navContainer, "to", [this.oVSD.getId() + '-page2', "show"]);
				this.oVSD._switchToPage(3,this.oVSD.getFilterItems()[0]); // name details page

				this.oVSD._dialog.getEndButton().firePress();

				equal(this.oVSD._navContainer.getCurrentPage(), this.oVSD._getPage1(), "NavContainer should be on the first page");

				this.oVSD.destroy();
			});

			module ("Events", {
				setup : function () {
					this.oVSD = new sap.m.ViewSettingsDialog();
					this.oFilterState = {
						"name1": true,
						"name2": true,
						"name5": true,
						"name6": true,
						"status1": true,
						"status2": true,
						"status3": true,
						"value3": true
					};

					oVsdConfig.addSortItems(this.oVSD);
					oVsdConfig.addFilterItems(this.oVSD);
					oVsdConfig.addPresetFilterItems(this.oVSD);
					oVsdConfig.addGroupItems(this.oVSD);

					this.oSelectedSortItem = this.oVSD.getSortItems()[0];
					this.oSelectedGroupItem = this.oVSD.getGroupItems()[1];
					this.oSelectedPresetFilterItem = this.oVSD.getPresetFilterItems()[1];

					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

			if (sap.ui.Device.browser.name == "ie" && sap.ui.Device.browser.versionStr == "9") {
				//do not run this tests on IE9 because of a timeout issue which need to be fixed
			} else {
				test("Cancel on cancel button press event", function (assert) {
					var core = sap.ui.getCore(),
							done = assert.async(),
							that = this,
							fnChecks = function () {
								// check if dialog is still in the previous state
								ok(true, "Event cancel was fired");
								strictEqual(this.getSelectedSortItem(), that.oSelectedSortItem.getId(), "The selected sort item should be '" + that.oSelectedSortItem.getId() + "'");
								strictEqual(core.byId(this.getSelectedSortItem()).getSelected(), true, "The selected sort item should have the selected flag set to true");
								strictEqual(this.getSortDescending(), true, "sort descending should now be true");
								strictEqual(this.getSelectedGroupItem(), that.oSelectedGroupItem.getId(), "The selected group item should be '" + that.oSelectedGroupItem.getId() + "'");
								strictEqual(core.byId(this.getSelectedGroupItem()).getSelected(), true, "The selected group item should have the selected flag set to true");
								strictEqual(this.getGroupDescending(), true, "group descending should now be true");
								ok(compareFilterKeys(that.oFilterState, this.getSelectedFilterKeys()), "The computed filter keys should have the same structure as the passed one");
								this.detachCancel(fnChecks);
								done();
							};

					this.oVSD.setSelectedSortItem(this.oSelectedSortItem);
					this.oVSD.setSelectedGroupItem(this.oSelectedGroupItem);
					this.oVSD.setSortDescending(true);
					this.oVSD.setGroupDescending(true);
					this.oVSD.setSelectedFilterKeys(this.oFilterState);

					// open dialog to store previous state
					this.oVSD.open();
					this.oVSD.attachCancel(fnChecks);

					// set everything to unselected / false and fire cancel request
					this.oVSD.setSelectedSortItem();
					this.oVSD.setSortDescending(false);
					this.oVSD.setSelectedGroupItem();
					this.oVSD.setGroupDescending(false);
					this.oVSD.setSelectedFilterKeys([]);
					//press cancel
					this.oVSD._dialog.getEndButton().firePress();
				});
			}

			if (sap.ui.Device.browser.name == "ie" && sap.ui.Device.browser.versionStr == "9") {
				//do not run this tests on IE9 because of a timeout issue which need to be fixed
			} else {
				test("Cancel on key ESCAPE event", function (assert) {
					var core = sap.ui.getCore(),
						that = this,
						done = assert.async(),
						fnChecks = function () {
							// check if dialog is still in the previous state
							ok(true, "Event cancel was fired");
							strictEqual(this.getSelectedSortItem(), that.oSelectedSortItem.getId(), "The selected sort item should be '"+ that.oSelectedSortItem.getId() +"'");
							strictEqual(core.byId(this.getSelectedSortItem()).getSelected(), true, "The selected sort item should have the selected flag set to true");
							strictEqual(this.getSortDescending(), true, "sort descending should now be true");
							strictEqual(this.getSelectedGroupItem(), that.oSelectedGroupItem.getId(), "The selected group item should be '"+ that.oSelectedGroupItem.getId() +"'");
							strictEqual(core.byId(this.getSelectedGroupItem()).getSelected(), true, "The selected group item should have the selected flag set to true");
							strictEqual(this.getGroupDescending(), true, "group descending should now be true");
							ok(compareFilterKeys(that.oFilterState, this.getSelectedFilterKeys()), "The computed filter keys should have the same structure as the passed one");
							this.detachCancel(fnChecks);
							done();
						};

					this.oVSD.setSelectedSortItem(this.oSelectedSortItem);
					this.oVSD.setSelectedGroupItem(this.oSelectedGroupItem);
					this.oVSD.setSortDescending(true);
					this.oVSD.setGroupDescending(true);
					this.oVSD.setSelectedFilterKeys(this.oFilterState);

					// open dialog to store previous state
					this.oVSD.open();
					this.oVSD.attachCancel(fnChecks);

					// set everything to unselected / false and fire ESC key
					this.oVSD.setSelectedSortItem();
					this.oVSD.setSortDescending(false);
					this.oVSD.setSelectedGroupItem();
					this.oVSD.setGroupDescending(false);
					this.oVSD.setSelectedFilterKeys([]);
					sap.ui.test.qunit.triggerKeydown(this.oVSD._getDialog().getDomRef(), jQuery.sap.KeyCodes.ESCAPE);
				});
			}

			test("Back on key [SHIFT]+[ENTER] event", function () {
				this.oVSD.open();

				this.oVSD._switchToPage(0);
				this.oVSD._switchToPage(1);
				this.oVSD._switchToPage(2);
				jQuery.sap.delayedCall(0, this.oVSD._navContainer, "to", [this.oVSD.getId() + '-page2', "show"]);
				this.oVSD._switchToPage(3,this.oVSD.getFilterItems()[0]); // name details page

				sap.ui.test.qunit.triggerKeyboardEvent(this.oVSD._getDialog().getDomRef(), jQuery.sap.KeyCodes.ENTER, true, false, false);
				equal(this.oVSD._vContentPage, 2, "Internal page state should be on the second page");
				equal(this.oVSD._navContainer.getCurrentPage(), this.oVSD._getPage1(), "NavContainer should be on the first page");
			});

			if (sap.ui.Device.browser.name == "ie" && sap.ui.Device.browser.versionStr == "9") {
				//do not run this tests on IE9 because of a timeout issue which need to be fixed
			} else {
				test("Confirm event", function (assert) {
					var done = assert.async(),
						that = this;

					this.oVSD.setSelectedSortItem(this.oSelectedSortItem);
					this.oVSD.setSelectedGroupItem(this.oSelectedGroupItem);
					this.oVSD.setSortDescending(true);
					this.oVSD.setGroupDescending(true);
					this.oVSD.setSelectedFilterKeys(this.oFilterState);

					// open dialog to store previous state
					this.oVSD.open();
					this.oVSD.attachConfirm(function(oEvent) {
						var oParams = oEvent.getParameters();
						ok(oParams, "Event applySettings was fired and has event parameters");
						ok(oParams.sortItem, "Event has a sort item");
						ok(oParams.groupItem, "Event has a group item");
						ok(oParams.sortDescending, "Event has sort order true");
						strictEqual(oParams.sortItem.getId(), that.oSelectedSortItem.getId(), "The selected sort item should be '"+ that.oSelectedSortItem.getId() +"'");
						strictEqual(oParams.sortDescending, true, "Sort descending should be true");
						strictEqual(oParams.groupItem.getId(), that.oSelectedGroupItem.getId(), "The selected group item should be '"+ that.oSelectedGroupItem.getId() +"'");
						strictEqual(oParams.groupDescending, true, "group descending should be true");
						strictEqual(oParams.selectedPresetFilterItem, undefined, "The selected preset filter item should be 'undefined'");
						ok(compareFilterKeys(that.oFilterState, oParams.filterKeys), "The event filter keys should have the same structure as the passed one");
						ok(oParams.filterString.length > 0, "The filter string is not empty");
						strictEqual(oParams.filterItems.length, 8, "There are 8 selected filters");
						done();
					});

					//Act
					this.oVSD._dialog.getBeginButton().firePress();
				});
			}

			test("Reset event", function () {
				this.oVSD.setSelectedFilterKeys(this.oFilterState);

				strictEqual(this.oVSD.getSelectedFilterItems().length, 8, "Selected filters are 8 before reset event");

				this.oVSD.open();
				this.oVSD.attachResetFilters(function(oEvent) {
					strictEqual(this.getSelectedFilterItems().length, 0, "Selected filters are empty after reset event");
					strictEqual(this.getSelectedPresetFilterItem(), null, "Preset filter item is null after reset event");
				});

				this.oVSD._resetButton.firePress();
			});

			module ("Construction/Destruction", {
				setup : function () {
					this.oVSD = new sap.m.ViewSettingsDialog();
					this.oFilterState = {
						"name1": true,
						"name2": true,
						"name5": true,
						"name6": true,
						"status1": true,
						"status2": true,
						"status3": true,
						"value3": true
					};

					oVsdConfig.addSortItems(this.oVSD);
					oVsdConfig.addFilterItems(this.oVSD);
					oVsdConfig.addPresetFilterItems(this.oVSD);
					oVsdConfig.addGroupItems(this.oVSD);

					this.oSelectedSortItem = this.oVSD.getSortItems()[0];
					this.oSelectedGroupItem = this.oVSD.getGroupItems()[1];
					this.oSelectedPresetFilterItem = this.oVSD.getPresetFilterItems()[1];

					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

			test("Destroy ViewSettingsDialog after all pages have been visited", function (assert) {
				var done = assert.async(),
					that = this;

				// open
				this.oVSD.open();

				// go to all pages again to init controls
				this.oVSD._switchToPage(0);
				this.oVSD._switchToPage(1);
				this.oVSD._switchToPage(2);
				jQuery.sap.delayedCall(0, this.oVSD._navContainer, "to", [this.oVSD.getId() + '-page2', "show"]);
				this.oVSD._switchToPage(3,this.oVSD.getFilterItems()[0]); // name details page

				setTimeout(function () {
					// store poiners to internal controls
					var sortList = that.oVSD._sortList,
						ariaSortListInvisibleText = that.oVSD._ariaSortListInvisibleText,
						sortOrderList = that.oVSD._sortOrderList,
						ariaSortOrderInvisibleText = that.oVSD._ariaSortOrderInvisibleText,
						groupList = that.oVSD._groupList,
						ariaGroupListInvisibleText = that.oVSD._ariaGroupListInvisibleText,
						groupOrderList = that.oVSD._groupOrderList,
						ariaGroupOrderInvisibleText = that.oVSD._ariaGroupOrderInvisibleText, 
						presetFilterList = that.oVSD._presetFilterList,
						filterList = that.oVSD._filterList,
						filterDetailList = that.oVSD._filterDetailList,
						titleLabel = that.oVSD._titleLabel,
						detailTitleLabel = that.oVSD._detailTitleLabel,
						resetButton = that.oVSD._resetButton,
						header = that.oVSD._header,
						sortButton = that.oVSD._sortButton,
						groupButton = that.oVSD._groupButton,
						filterButton = that.oVSD._filterButton,
						segmentedButton = that.oVSD._segmentedButton,
						page1 = that.oVSD._page1,
						page2 = that.oVSD._page2,
						navContainer = that.oVSD._navContainer,
						dialog = that.oVSD._dialog,
						subHeader = that.oVSD._subHeader;

					that.oVSD.destroy();

					// check if internal controls are destroyed correctly (when initialized they must be destroyed)
					strictEqual(that.oVSD.$().length, 0, "There is no Domref for ViewSettingsDialog");

					// check if all internal controls are destroyed successfully
					strictEqual(sortList.bIsDestroyed, true, "sort list is destroyed successfully");
					strictEqual(ariaSortListInvisibleText.bIsDestroyed, true, "sort list aria label is destroyed successfully");
					strictEqual(sortOrderList.bIsDestroyed, true, "sort order list is destroyed successfully");
					strictEqual(ariaSortOrderInvisibleText.bIsDestroyed, true, "sort order list aria label is destroyed successfully");
					strictEqual(groupList.bIsDestroyed, true, "group list is destroyed successfully");
					strictEqual(ariaGroupListInvisibleText.bIsDestroyed, true, "group list aria label is destroyed successfully");
					strictEqual(groupOrderList.bIsDestroyed, true, "group order list is destroyed successfully");
					strictEqual(ariaGroupOrderInvisibleText.bIsDestroyed, true, "group order list aria label is destroyed successfully");
					strictEqual(presetFilterList.bIsDestroyed, true, "preset filter list is destroyed successfully");
					strictEqual(filterList.bIsDestroyed, true, "filter list is destroyed successfully");
					strictEqual(filterDetailList.bIsDestroyed, true, "filter detail list is destroyed successfully");
					strictEqual(titleLabel.bIsDestroyed, true, "title label is destroyed successfully");
					strictEqual(detailTitleLabel.bIsDestroyed, true, "detail title label is destroyed successfully");
					strictEqual(resetButton.bIsDestroyed, true, "reset button is destroyed successfully");
					strictEqual(header.bIsDestroyed, true, "header is destroyed successfully");
					strictEqual(sortButton.bIsDestroyed, true, "sortButton is destroyed successfully");
					strictEqual(groupButton.bIsDestroyed, true, "groupButton is destroyed successfully");
					strictEqual(filterButton.bIsDestroyed, true, "filterButton is destroyed successfully");
					strictEqual(segmentedButton.bIsDestroyed, true, "segmentedButton is destroyed successfully");
					strictEqual(page1.bIsDestroyed, true, "page1 is destroyed successfully");
					strictEqual(page2.bIsDestroyed, true, "page2 is destroyed successfully");
					strictEqual(navContainer.bIsDestroyed, true, "navContainer is destroyed successfully");
					strictEqual(dialog.bIsDestroyed, true, "dialog is destroyed successfully");
					strictEqual(subHeader.bIsDestroyed, true, "subHeader is destroyed successfully");

					// check if all controls are set to null correctly
					strictEqual(that.oVSD._sortList, null, "sort list is null");
					strictEqual(that.oVSD._ariaSortListInvisibleText, null, "sort list aria text is null");
					strictEqual(that.oVSD._sortOrderList, null, "sort order list is null");
					strictEqual(that.oVSD._ariaSortOrderInvisibleText, null, "sort order list aria text is null");
					strictEqual(that.oVSD._groupList, null, "group list is null");
					strictEqual(that.oVSD._ariaGroupListInvisibleText, null, "group list aria text is null");
					strictEqual(that.oVSD._groupOrderList, null, "group order list is null");
					strictEqual(that.oVSD._ariaGroupOrderInvisibleText, null, "group order list aria text is null");
					strictEqual(that.oVSD._presetFilterList, null, "preset filter list is null");
					strictEqual(that.oVSD._filterList, null, "filter list is null");
					strictEqual(that.oVSD._filterDetailList, null, "filter detail list is null");
					strictEqual(that.oVSD._titleLabel, null, "title label is null");
					strictEqual(that.oVSD._detailTitleLabel, null, "detail title label is null");
					strictEqual(that.oVSD._resetButton, null, "reset button is null");
					strictEqual(that.oVSD._header, null, "header is null");
					strictEqual(that.oVSD._sortButton, null, "sortButton is null");
					strictEqual(that.oVSD._groupButton, null, "groupButton is null");
					strictEqual(that.oVSD._filterButton, null, "filterButton is null");
					strictEqual(that.oVSD._segmentedButton, null, "segmentedButton is null");
					strictEqual(that.oVSD._page1, null, "page1 is null");
					strictEqual(that.oVSD._page2, null, "page2 is null");
					strictEqual(that.oVSD._navContainer, null, "navContainer is null");
					strictEqual(that.oVSD._dialog, null, "dialog is null");
					strictEqual(that.oVSD._subHeader, null, "subHeader is null");
					done();
				}, 1000);
			});

			test("Destroy ViewSettingsDialog that has never been opened/rendered", function () {
				// store poiners to internal controls
				var sortList = this.oVSD._sortList,
					ariaSortListInvisibleText = this.oVSD._ariaSortListInvisibleText,
					sortOrderList = this.oVSD._sortOrderList,
					ariaSortOrderInvisibleText = this.oVSD._ariaSortOrderInvisibleText,
					groupList = this.oVSD._groupList,
					ariaGroupListInvisibleText = this.oVSD._ariaGroupListInvisibleText,
					groupOrderList = this.oVSD._groupOrderList,
					ariaGroupOrderInvisibleText = this.oVSD._ariaGroupOrderInvisibleText,
					presetFilterList = this.oVSD._presetFilterList,
					filterList = this.oVSD._filterList,
					filterDetailList = this.oVSD._filterDetailList
					titleLabel = this.oVSD._titleLabel,
					detailTitleLabel = this.oVSD._detailTitleLabel,
					resetButton = this.oVSD._resetButton,
					header = this.oVSD._header,
					sortButton = this.oVSD._sortButton,
					groupButton = this.oVSD._groupButton
					filterButton = this.oVSD._filterButton,
					segmentedButton = this.oVSD._segmentedButton,
					page1 = this.oVSD._page1,
					page2 = this.oVSD._page2,
					navContainer = this.oVSD._navContainer,
					dialog = this.oVSD._dialog,
					subHeader = this.oVSD._subHeader;

				// check if all internal controls are not initialized yet
				strictEqual(sortList, undefined, "sort list is not initialized yet");
				strictEqual(ariaSortListInvisibleText, undefined, "sort list aria label is not initialized yet");
				strictEqual(sortOrderList, undefined, "sort order list is not initialized yet");
				strictEqual(ariaSortOrderInvisibleText, undefined, "sort order list aria label is not initialized yet");
				strictEqual(groupList, undefined, "group list is not initialized yet");
				strictEqual(ariaGroupListInvisibleText, undefined, "group list aria label is not initialized yet");
				strictEqual(groupOrderList, undefined, "group order list is not initialized yet");
				strictEqual(ariaGroupOrderInvisibleText, undefined, "group order list aria label is not initialized yet");
				strictEqual(presetFilterList, undefined, "preset filter list is not initialized yet");
				strictEqual(filterList, undefined, "filter list is not initialized yet");
				strictEqual(filterDetailList, undefined, "filter detail list is not initialized yet");
				strictEqual(titleLabel, undefined, "title label is not initialized yet");
				strictEqual(detailTitleLabel, undefined, "detail title label is not initialized yet");
				strictEqual(resetButton, undefined, "reset button is not initialized yet");
				strictEqual(header, undefined, "header is not initialized yet");
				strictEqual(sortButton, undefined, "sortButton is not initialized yet");
				strictEqual(groupButton, undefined, "groupButton is not initialized yet");
				strictEqual(filterButton, undefined, "filterButton is not initialized yet");
				strictEqual(segmentedButton, undefined, "segmentedButton is not initialized yet");
				strictEqual(page1, undefined, "page1 is not initialized yet");
				strictEqual(page2, undefined, "page2 is not initialized yet");
				strictEqual(navContainer, undefined, "navContainer is not initialized yet");
				strictEqual(dialog, undefined, "dialog is not initialized yet");
				strictEqual(subHeader, undefined, "subHeader is not initialized yet");

				this.oVSD.destroy();

				// check if internal controls are destroyed correctly (when initialized they must be destroyed)
				strictEqual(this.oVSD.$().length, 0, "There is no Domref for ViewSettingsDialog");
			});

			module ("Sort tab only checks", {
				setup : function () {
					this.oVSD = new sap.m.ViewSettingsDialog({
						sortItems: [
							new sap.m.ViewSettingsItem({
								key: "myNameSorter",
								text: "Name",
								selected: true
							}),
							new sap.m.ViewSettingsItem({
								key: "myStatusSorter",
								text: "Status",
								selected: true
							}),
							new sap.m.ViewSettingsItem({
								key: "myValueSorter",
								text: "Value",
								selected: false
							}),
							new sap.m.ViewSettingsItem({
								key: "myPriceSorter",
								text: "Price",
								selected: false
							})
						]
					});
					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

			test("Check sort tab only mode", function  () {
				this.oVSD.open();
				strictEqual(this.oVSD.getSelectedSortItem(), this.oVSD.getSortItems()[1].getId(), "Second selected sort item is set successfully by selected flag");
				strictEqual(this.oVSD.getSelectedGroupItem(), null, "Selected group item is null");
				strictEqual(this.oVSD.getSelectedPresetFilterItem(), null, "Selected preset filter item is null");
				strictEqual(this.oVSD._sortContent.length, 4, "Sort content is initialized and has two items");
				strictEqual(this.oVSD._groupContent, undefined, "Group content is not initialized");
				strictEqual(this.oVSD._filterContent, undefined, "Filter content is not initialized");
				strictEqual(this.oVSD._page1.getSubHeader(), null, "Subheader with segmented button is not set on first page");
			
				// Aria sort list and sort order list labels and ariaLabelledBy 
				ok(jQuery.sap.domById(this.oVSD.getId() + "-sortOrderLabel"), "Sort order list aria label should be rendered");
				ok(jQuery.sap.domById(this.oVSD.getId() + "-sortListLabel"), "Sort list aria label should be rendered");
				strictEqual(this.oVSD._sortOrderList.getAriaLabelledBy().length, 1, "Sort order list should have aria ariaLabelledBy set");
				strictEqual(this.oVSD._sortList.getAriaLabelledBy().length, 1, "Sort list should have aria ariaLabelledBy set");
				
				ok(!jQuery.sap.domById(this.oVSD.getId() + "-resetbutton"), "Filter reset button should not be rendered");
		});

		module ("Group tab only checks", {
				setup : function () {
					this.oVSD = new sap.m.ViewSettingsDialog({
						groupItems: [
							new sap.m.ViewSettingsItem({
								key: "myNameGrouper",
								text: "Name",
								selected: true
							}),
							new sap.m.ViewSettingsItem({
								key: "myStatusGrouper",
								text: "Status",
								selected: true
							}),
							new sap.m.ViewSettingsItem({
								key: "myValueGrouper",
								text: "Value",
								selected: false
							}),
							new sap.m.ViewSettingsItem({
								key: "myPriceGrouper",
								text: "Price",
								selected: false
							})
						]
					});
					this.oVSD.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();
				},
				teardown : function () {
					this.oVSD.destroy();
					this.oVSD = null;
				}
			});

		test("Check group tab only mode", function  () {
			this.oVSD.open();
			strictEqual(this.oVSD.getSelectedSortItem(), null, "Selected sort item is null");
			strictEqual(this.oVSD.getSelectedGroupItem(), this.oVSD.getGroupItems()[1].getId(), "Second selected group item is set successfully by selected flag");
			strictEqual(this.oVSD.getSelectedPresetFilterItem(), null, "Selected preset filter item is null");
			strictEqual(this.oVSD._sortContent, undefined, "Group content is not initialized");
			strictEqual(this.oVSD._groupContent.length, 4, "Group content is initialized and has two items");
			strictEqual(this.oVSD._filterContent, undefined, "Filter content is not initialized");
			strictEqual(this.oVSD._page1.getSubHeader(), null, "Subheader with segmented button is not set on first page");

			// Aria sort list and sort order list labels and ariaLabelledBy 
			ok(jQuery.sap.domById(this.oVSD.getId() + "-groupOrderLabel"), "Group order list aria label should be rendered");
			ok(jQuery.sap.domById(this.oVSD.getId() + "-groupListLabel"), "Group list aria label should be rendered");
			strictEqual(this.oVSD._groupOrderList.getAriaLabelledBy().length, 1, "Group order list should have aria ariaLabelledBy set");
			strictEqual(this.oVSD._groupList.getAriaLabelledBy().length, 1, "Group list should have aria ariaLabelledBy set");
			
			ok(!jQuery.sap.domById(this.oVSD.getId() + "-resetbutton"), "Filter reset button should not be rendered");
		});

		module ("Preset Filter only checks", {
			setup : function () {
				this.oVSD = new sap.m.ViewSettingsDialog({
					presetFilterItems: [
						new sap.m.ViewSettingsItem({
							key: "myPresetFilter1",
							text: "A very complex filter",
							selected: true
						}),
						new sap.m.ViewSettingsItem({
							key: "myPresetFilter2",
							text: "Ridiculously complex filter",
							selected: true
						}),
						new sap.m.ViewSettingsItem({
							key: "myPresetFilter3",
							text: "Expensive stuff",
							selected: false
						})
					]
				});
				this.oVSD.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();
			},
			teardown : function () {
				this.oVSD.destroy();
				this.oVSD = null;
			}
		});

		test("Check preset filter only mode", function  () {
			this.oVSD.open();
			strictEqual(this.oVSD.getSelectedSortItem(), null, "Selected sort item is null");
			strictEqual(this.oVSD.getSelectedGroupItem(), null, "Selected group item is null");
			strictEqual(this.oVSD.getSelectedPresetFilterItem(), this.oVSD.getPresetFilterItems()[1].getId(), "Second preset filter item is set successfully by selected flag");
			strictEqual(this.oVSD._sortContent, undefined, "Group content is not initialized");
			strictEqual(this.oVSD._groupContent, undefined, "Group content is not initialized");
			strictEqual(this.oVSD._filterContent.length, 2, "Filter content is initalized and has two items");
			strictEqual(this.oVSD._page1.getSubHeader(), null, "Subheader with segmented button is not set on first page");
			strictEqual(this.oVSD.getSelectedFilterItems().length, 0, "There are no selected filter items");
			ok(!jQuery.sap.domById(this.oVSD.getId() + "-resetbutton"), "Filter reset button should not be rendered");
		});

		module ("Filter details rendering", {
			setup : function () {
				this.oVSD = new sap.m.ViewSettingsDialog();

				this.oFilterState = {
					"name1": true,
					"name2": true,
					"name5": true,
					"name6": true,
					"status1": true,
					"status2": true,
					"status3": true,
					"value3": true
				};

				oVsdConfig.addFilterItems(this.oVSD);

				this.oVSD.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();
			},
			teardown : function () {
				this.oVSD.destroy();
				this.oVSD = null;
			}
		});

		test("Check filter detail page and buttons render correctly", function  (assert) {
			var done = assert.async(),
					that = this;

			this.oVSD.setSelectedFilterKeys(this.oFilterState);

			this.oVSD.open();

			jQuery.sap.delayedCall(0, this.oVSD._navContainer, "to", [this.oVSD.getId() + '-page2', "show"]);
			this.oVSD._switchToPage(3, this.oVSD.getFilterItems()[0]); // name details page

			setTimeout(function() {
				ok(jQuery.sap.domById(that.oVSD.getId() + "-page2"), "Page 2 is rendered");
				ok(jQuery.sap.domById(that.oVSD.getId() + "-detailresetbutton"), "Filter detail reset button should be rendered");
				ok(jQuery.sap.domById(that.oVSD.getId() + "-backbutton"), "Back button should be rendered");
				done();
			}, 1000);

		});

		module ("Filter only checks", {
			setup : function () {
				this.oVSD = new sap.m.ViewSettingsDialog();

				this.oFilterState = {
					"name1": true,
					"name2": true,
					"name5": true,
					"name6": true,
					"status1": true,
					"status2": true,
					"status3": true,
					"value3": true
				};

				this.oVSD.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();
			},
			teardown : function () {
				this.oVSD.destroy();
				this.oVSD = null;
			}
		});

		test("Check filter only mode", function  () {
			var	sId = this.oVSD.getId();

			oVsdConfig.addFilterItems(this.oVSD);
			oVsdConfig.addPresetFilterItems(this.oVSD);
			this.oVSD.getFilterItems()[2].setMultiSelect(false);
			this.oVSD.setSelectedFilterKeys(this.oFilterState);

			this.oVSD.open();

			// overview page
			strictEqual(this.oVSD.getSelectedSortItem(), null, "Selected sort item is null");
			strictEqual(this.oVSD.getSelectedGroupItem(), null, "Selected group item is null");
			strictEqual(this.oVSD.getSelectedPresetFilterItem(), null, "Selected preset filter item is null");
			strictEqual(this.oVSD._sortContent, undefined, "Group content is not initialized");
			strictEqual(this.oVSD._groupContent, undefined, "Group content is not initialized");
			strictEqual(this.oVSD._filterContent.length, 2, "Filter content is initialized and has two items");
			strictEqual(this.oVSD._page1.getSubHeader(), null, "Sub-header with segmented button is not set on first page");
			ok(compareFilterKeys(this.oFilterState, this.oVSD.getSelectedFilterKeys()), "The computed filter keys should have the same structure as the passed one");
			ok(jQuery.sap.domById(sId + "-resetbutton"), "Filter reset button should be rendered");
			strictEqual(this.oVSD._filterList.getItems()[0].getCounter(), 4, "Filter counter for name is 4");

			this.oVSD._switchToPage(3,this.oVSD.getFilterItems()[2]); // value details page
			strictEqual(this.oVSD._filterDetailList.getMode(), sap.m.ListMode.SingleSelectLeft, "The value detail list is in single select left mode");
			strictEqual(this.oVSD._filterDetailList.getSelectedItem().data("item"), this.oVSD.getFilterItems()[2].getItems()[2], "The item 'value3' is selected");
		});

		test("Check add/remove/toggle/hasStyleClass methods", function () {
			var	sCustomStyleClass = "myStyleClass";

			// add + has
			this.oVSD.addStyleClass(sCustomStyleClass);
			this.oVSD.open();
			ok(this.oVSD._dialog.hasStyleClass(sCustomStyleClass), 'The internal Dialog now has style class "' + sCustomStyleClass + '"');
			ok(this.oVSD.hasStyleClass(sCustomStyleClass), 'The ViewSettingsDialog now has style class "' + sCustomStyleClass + '"');

			// remove
			this.oVSD.removeStyleClass(sCustomStyleClass);
			ok(!this.oVSD._dialog.hasStyleClass(sCustomStyleClass), 'The internal Dialog does not have style class "' + sCustomStyleClass + '" after remove');
			ok(!this.oVSD.hasStyleClass(sCustomStyleClass), 'The ViewSettingsDialog does not have style class "' + sCustomStyleClass + '" after remove');

			// toggle
			this.oVSD.toggleStyleClass(sCustomStyleClass);
			ok(this.oVSD._dialog.hasStyleClass(sCustomStyleClass), 'The internal Dialog has style class "' + sCustomStyleClass + '" after toggle');
			ok(this.oVSD.hasStyleClass(sCustomStyleClass), 'The ViewSettingsDialog has style class "' + sCustomStyleClass + '" after toggle');
		});

		test("Check $ and getDomRef methods", function () {
			this.oVSD.open();
			ok(this.oVSD.$().length === 1, "The inner dialogs jQuery object is returned");
			ok(this.oVSD.getDomRef().id === this.oVSD.getId() + "-dialog", "The inner dialogs DOM reference is returned");
		});

		module("Custom tabs", {
			setup : function () {
				this.oVSD = new sap.m.ViewSettingsDialog();
				this.oVSD.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();
			},
			teardown : function () {
				this.oVSD.destroy();
				this.oVSD = null;
			}
		});

		test("Buttons for all custom tabs should be rendered", function () {
			var sId = this.oVSD.getId();

			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory('taxi-settings'));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory('other-tab'));
			this.oVSD.open();
			ok(jQuery.sap.domById(sId + "-custom-button-taxi-settings"), "Button is rendered custom tab.");
			ok(jQuery.sap.domById(sId + "-custom-button-other-tab"), "Button is rendered custom tab.");
		});

		test("Check if all tabs contents are rendered when tab is focused.", function () {
			this.oVSD.insertAggregation('customTabs', new sap.m.ViewSettingsCustomTab({
				id	 	: 'taxi-settings',
				content : [
					new sap.m.Button({
						id	: 'taxi-settings-button-content2',
						text: 'test'
					}),
					new sap.m.CheckBox({
						name: 'test',
						text: 'test4'
					})
				]

			}));

			this.oVSD.open();
			ok(jQuery.sap.domById('taxi-settings-button-content2'), "Custom page contents are rendered.");
		});

		test("Make sure 'reset' and 'back' buttons is not rendered when on custom page.", function () {
			var sId = this.oVSD.getId();

			oVsdConfig.addSortItems(this.oVSD);
			oVsdConfig.addFilterItems(this.oVSD);
			oVsdConfig.addPresetFilterItems(this.oVSD);
			oVsdConfig.addGroupItems(this.oVSD);

			this.oVSD.open();
			ok(!jQuery.sap.domById(sId + "-resetbutton"), "Filter reset button should not be rendered");
		});

		/* [start]  Actual unit tests of custom tabs */
		test("Check the _isValidPredefinedPageId method for correctly invalidating page ids.", function () {
			var	sFirstCustomTabId	= 'taxi-settings5',
				sSecondCustomTabId 	= 'other-tab5',
				sSuccessMsg,
				sPageId,
				sSuccessMsgPrefix;

			var bEmptyContent = true;
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId, bEmptyContent));

			sPageId 			= 'sort';
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is NOT a valid predefined page id when no ' + sPageId + ' items are added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , false, sSuccessMsgPrefix + sSuccessMsg);

			sPageId 			= 'filter';
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is NOT a valid predefined page id when no ' + sPageId + ' items are added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , false, sSuccessMsgPrefix + sSuccessMsg);

			sPageId 			= 'group';
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is NOT a valid predefined page id when no custom tabs are added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , false, sSuccessMsgPrefix + sSuccessMsg);

			sPageId 			= sFirstCustomTabId;
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is NOT a valid predefined page id when no custom tabs are added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , false, sSuccessMsgPrefix + sSuccessMsg);

			sPageId 			= sSecondCustomTabId;
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is NOT a valid predefined page id.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , false, sSuccessMsgPrefix + sSuccessMsg);
		});

		test("Check the _isValidPredefinedPageId method for correctly validating page ids.", function () {
			var sFirstCustomTabId	= 'taxi-settings5',
				sSuccessMsg,
				sPageId,
				sSuccessMsgPrefix;

			oVsdConfig.addSortItems(this.oVSD);
			sPageId 			= 'sort';
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is a valid predefined page id after ' + sPageId + ' items are added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , true, sSuccessMsgPrefix + sSuccessMsg);

			oVsdConfig.addFilterItems(this.oVSD);
			sPageId 			= 'filter';
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is a valid predefined page id after ' + sPageId + ' items are added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , true, sSuccessMsgPrefix + sSuccessMsg);


			oVsdConfig.addGroupItems(this.oVSD);
			sPageId 			= 'group';
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is a valid predefined page id after ' + sPageId + ' items are added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , true, sSuccessMsgPrefix + sSuccessMsg);


			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));

			sPageId 			= sFirstCustomTabId;
			sSuccessMsgPrefix 	= '"' + sPageId + '"';
			sSuccessMsg 		= ' is a valid predefined page id after it was added.';
			strictEqual(this.oVSD._isValidPredefinedPageId(sPageId) , false, sSuccessMsgPrefix + sSuccessMsg);
		});

		test("Check the _fetchValidPagesIds method for correctness.", function () {
			var	sFirstCustomTabId	= 'taxi-settings6',
				sSecondCustomTabId 	= 'other-tab6',
				bEmptyContent 		= true,
				sSuccessMsg;

			var aVsd10ValidPageIds 	= [];
			sSuccessMsg 			= 'No valid page ids correctly determined.';
			deepEqual(this.oVSD._fetchValidPagesIds(), aVsd10ValidPageIds, sSuccessMsg);


			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId, bEmptyContent));
			aVsd10ValidPageIds 	= [sFirstCustomTabId].sort();
			sSuccessMsg 		= 'Only one custom tab valid page id correctly determined.';
			deepEqual(this.oVSD._fetchValidPagesIds().sort(), aVsd10ValidPageIds, sSuccessMsg);
			this.oVSD.destroyAggregation('customTabs');

			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId));
			aVsd10ValidPageIds 	= [sFirstCustomTabId, sSecondCustomTabId].sort();
			sSuccessMsg			= 'All custom tabs valid page ids correctly determined.';
			deepEqual(this.oVSD._fetchValidPagesIds().sort(), aVsd10ValidPageIds, sSuccessMsg);
			this.oVSD.destroyAggregation('customTabs');

			oVsdConfig.addSortItems(this.oVSD);
			oVsdConfig.addFilterItems(this.oVSD);
			oVsdConfig.addPresetFilterItems(this.oVSD);
			oVsdConfig.addGroupItems(this.oVSD);
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId));
			aVsd10ValidPageIds 	= ['sort', 'group', 'filter', sFirstCustomTabId, sSecondCustomTabId].sort();
			sSuccessMsg			= 'All valid page ids are correctly determined.';
			deepEqual(this.oVSD._fetchValidPagesIds().sort(), aVsd10ValidPageIds, sSuccessMsg);
		});

		test("Check the _determineValidPageId method for correctness.", function () {
			var	sFirstCustomTabId	= 'taxi-settings6',
				sSecondCustomTabId 	= 'other-tab6',
				bEmptyContent 		= true,
				sSuccessMsg,
				sPageId,
				sSuccessMsgPrefix,
				sExpectedPageId;

			// give nothing, expect sort
			sExpectedPageId 	= 'sort';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);


			// give filter, expect sort (no filter items yet)
			sExpectedPageId 	= 'sort';
			sPageId				= 'filter';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);


			// give random string, expect sort
			sExpectedPageId 	= 'sort';
			sPageId				= 'invalidstring';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);


			// add custom tab, give nothing, expect custom tab
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			sExpectedPageId 	=
			sPageId				= sFirstCustomTabId;
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when nothing given.';
			equal(this.oVSD._determineValidPageId(), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
			this.oVSD.destroyAggregation('customTabs');

			// add custom tab, give custom tab id, expect custom tab id
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			sExpectedPageId 	=
			sPageId				= sFirstCustomTabId;
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
			this.oVSD.destroyAggregation('customTabs');



			// 6
			oVsdConfig.addSortItems(this.oVSD);
			sExpectedPageId 	=
			sPageId 			= 'sort';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
			this.oVSD.destroyAggregation('sortItems');

			//7
			sExpectedPageId 	= 'sort';
			sPageId 			= 'filter';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);


			//8
			oVsdConfig.addFilterItems(this.oVSD);
			sExpectedPageId 	=
			sPageId 			= 'filter';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);

			// 9
			sExpectedPageId 	= 'filter';
			sPageId 			= 'sort';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
			this.oVSD.destroyAggregation('filterItems');


			// 10
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			sExpectedPageId 	=
			sPageId 			= sFirstCustomTabId;
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
			this.oVSD.destroyAggregation('customTabs');


			// 11 first custom tab has empty content
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId, bEmptyContent));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId));
			sExpectedPageId 	= sSecondCustomTabId;
			sPageId 			= sSecondCustomTabId;
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
			this.oVSD.destroyAggregation('customTabs');


			// 12
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId));
			sExpectedPageId 	= sSecondCustomTabId;
			sPageId 			= sSecondCustomTabId;
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
			this.oVSD.destroyAggregation('customTabs');



			// 13
			oVsdConfig.addSortItems(this.oVSD);
			oVsdConfig.addFilterItems(this.oVSD);
			oVsdConfig.addGroupItems(this.oVSD);
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId));
			sExpectedPageId 	= sSecondCustomTabId;
			sPageId 			= sSecondCustomTabId;
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);


			// 14
			sExpectedPageId 	=
			sPageId 			= 'taxi-settings6';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);


			// 15
			this.oVSD.destroyAggregation('sortItems');
			sExpectedPageId 	= 'filter';
			sPageId 			= 'sort';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);


			// 16
			this.oVSD.destroy();
			this.oVSD 			= new sap.m.ViewSettingsDialog("vsdCustomTabs");
			oVsdConfig.addGroupItems(this.oVSD);
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sFirstCustomTabId));
			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sSecondCustomTabId));
			sExpectedPageId 	= 'group';
			sPageId 			= 'sort';
			sSuccessMsgPrefix 	= '"' + sExpectedPageId + '"';
			sSuccessMsg			= '" is correctly resolved as the valid page id when "' + sPageId + '" given.';
			equal(this.oVSD._determineValidPageId(sPageId), sExpectedPageId, sSuccessMsgPrefix + sSuccessMsg);
		});

		test("Check if reserved tab ids are properly handled.", function () {
			var oTab = new sap.m.ViewSettingsCustomTab('sort');
			var hasError = false;
			try {
				this.oVSD.addCustomTab(oTab);
			} catch (e) {
				hasError = true;
			}

			equal(hasError, true, 'Error is properly thrown when reserved tab id is used.');
		});

		test("Back button on filter detail should work after reopen.", function (assert) {
			var delay = 1000,
				done = assert.async(),
				sId = this.oVSD.getId(),
				that = this;

			oVsdConfig.addSortItems(this.oVSD);
			oVsdConfig.addFilterItems(this.oVSD);
			oVsdConfig.addPresetFilterItems(this.oVSD);
			oVsdConfig.addGroupItems(this.oVSD);

			setTimeout(function () {
				that.oVSD.open();
				that.oVSD._switchToPage(3, that.oVSD.getFilterItems()[0]); // name details page
				jQuery.sap.delayedCall(0, that.oVSD._navContainer, "to", [sId + '-page2', "show"]);
				that.oVSD._onConfirm();
			}, 0);

			setTimeout(function () {
				that.oVSD.open();
				ok(jQuery.sap.domById(sId + "-page2-cont"), "Page 2 (filter detail content) should be rendered");

				setTimeout(function () {
					that.oVSD._pressBackButton();

					setTimeout(function () {
						ok(jQuery.sap.byId(sId + "-filterbutton").hasClass("sapMSegBBtnSel"), "Segmented 'filter' button should be selected after 'back' is pressed.");
						done();
					}, delay);
				}, delay);
			}, delay);
		});

		// this test is important because the 'content' aggregation of custom tabs is
		// being set to the vsd page instance and then back to the custom tab
		test("Make sure right content is loaded upon reopening a dialog with single custom tab.", function (assert) {
			var delay = 1000,
				done = assert.async(),
				sTitle = 'taxi-settings',
				that = this;

			this.oVSD.insertAggregation('customTabs', oVsdConfig.customTabsFactory(sTitle));

			setTimeout(function () {
				that.oVSD.open();

				setTimeout(function () {
					that.oVSD._dialog.getEndButton().firePress();

					setTimeout(function () {
						that.oVSD.open();
						strictEqual(jQuery('#' + that.oVSD.getId() + '-title').text(), sTitle, "The title should be " + sTitle);
						done();
					}, delay);
				}, delay);
			}, delay);
		});

		test("Test model data binding", function (assert) {
			var delay = 1000,
				done = assert.async(),
				that = this;

			var oCheckboxTemplate = new sap.m.CheckBox({
				name : "test",
				text : "{/customTabData/checkbox_label}"
			});

			var oCustomTab = new sap.m.ViewSettingsCustomTab({
				id: "taxi-settings",
				content: {
					path: '/customTabData',
					template: oCheckboxTemplate
				}
			});

			var oCustomTab2 = new sap.m.ViewSettingsCustomTab({
				id: "taxi-settings2",
				content: {
					path: '/customTabData',
					template: oCheckboxTemplate
				}
			});

			this.oVSD.addAggregation("customTabs", oCustomTab);
			this.oVSD.addAggregation("customTabs", oCustomTab2);

			setTimeout(function () {
				that.oVSD.open();
				that.oVSD._switchToPage('taxi-settings2');
				// the text of the second control on the page is binded to a model
				strictEqual(that.oVSD._getPage1().getContent()[0].getText(), 'lorem ipsum checkbox label');
				setTimeout(function () {
					that.oVSD._switchToPage('taxi-settings');
					// the text of the second control on the page is binded to a model
					strictEqual(that.oVSD._getPage1().getContent()[0].getText(), 'lorem ipsum checkbox label');
					done();
				}, delay);
			}, delay);
		});

		module("Re-rendering after changing selections", {
			setup : function () {
				this.oVSD = new sap.m.ViewSettingsDialog();

				this.oVSD.addSortItem(new sap.m.ViewSettingsItem({
					key: "myStatusSorter",
					text: "Status"
				}));

				this.oVSD.addSortItem(new sap.m.ViewSettingsItem({
					key: "myOtherSorter",
					text: "Other"
				}));

				this.oVSD.addGroupItem(new sap.m.ViewSettingsItem({
					key: "myGrouper",
					text: "Grouping"
				}));

				this.oVSD.addGroupItem(new sap.m.ViewSettingsItem({
					key: "myOtherGrouper",
					text: "Other"
				}));

				this.oVSD.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();
			}
		});

		test("Test for re-rendering after changing selections", function (assert) {
			var delay = 1000,
					done1 = assert.async(),
					that = this;

			this.oVSD.open();
			setTimeout(function () {
				var list 						= that.oVSD._getPage1().getContent()[1];
				var listOfSortItems 			= list.getItems()[1];
				var listOfSortDirectionItems	= that.oVSD._getPage1().getContent()[3];
				
				var vsdSortItem 				= that.oVSD.getSortItems()[1];
				var vsdSortDirectionDesc 		= listOfSortDirectionItems.getItems()[1];
				var spySortItem 				= sinon.spy(vsdSortItem, "setProperty");
				var spyVsd 					    = sinon.spy(that.oVSD, "setProperty");

				listOfSortItems._oSingleSelectControl.fireSelect({selected : true});
				vsdSortDirectionDesc._oSingleSelectControl.fireSelect({selected : true});

				ok(spySortItem.calledWithExactly('selected', true, true), "Set sort item as selected should be called with suppress Invalidation flag=true");
				ok(spySortItem.calledOnce, "setSelected should be called only once");

				ok(spyVsd.calledWithExactly('sortDescending', true, true), "Set sort item as as selected should be called with suppress Invalidation flag=true");

				ok(spyVsd.calledOnce, "setSelected should be called only once");

				that.oVSD._switchToPage(1);
				setTimeout(function () {
					var list 						= that.oVSD._getPage1().getContent()[1];
					var listOfGroupItems 			= list.getItems()[1];
					var listOfGroupDirectionItems	= that.oVSD._getPage1().getContent()[3];
					var vsdGroupDirectionDesc 		= listOfGroupDirectionItems.getItems()[1];
					var vsdGroupItem 				= that.oVSD.getGroupItems()[1];
					var spyGroupItem 				= sinon.spy(vsdGroupItem, "setProperty");

					listOfGroupItems._oSingleSelectControl.fireSelect({selected : true});
					vsdGroupDirectionDesc._oSingleSelectControl.fireSelect({selected : true});

					ok(spyGroupItem.calledWithExactly('selected', true, true), "Set group item as selected should be called with suppress Invalidation flag=true");
					ok(spyGroupItem.calledOnce, "setSelected should be called only once");

					ok(spyVsd.calledWithExactly('groupDescending', true, true), "Set group item as as selected should be called with suppress Invalidation flag=true");

					ok(spyVsd.calledTwice, "setSelected should be called twice");

					done1();

					that.oVSD.destroy();
					delete that.oVSD;

				}, delay);
			}, delay);
		});

		module("Changing items after open", {
			setup : function () {
				this.oVSD = new sap.m.ViewSettingsDialog();

				this.oVSD.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();
			},
			teardown : function () {
				this.oVSD.destroy();
				this.oVSD = null;
			},
			getFirstModelData: function() {
				return {
					sortData: [
						{
							myKey: "key1",
							myText: "Sort text 1"
						}],
					groupData: [
						{
							myKey: "groupKey1",
							myText: "Group text 1"
						}],
					filterData: [
						{
							myKey: "filterKey1",
							myText: "Filter text 1",
							myItems: [
								{
									myKey: 'item1',
									myText: 'item2'
								}
							]
						},
						{
							myKey: "filterKey2",
							myText: "Filter text 2"
						},
						{
							myKey: "filterKey3",
							myText: "Filter text 3"
						}]
				};
			},
			getSecondModelData: function() {
				return{
					sortData: [
						{
							myKey: "key1",
							myText: "2 Sort text 1"
						}],
					groupData: [
						{
							myKey: "groupKey1",
							myText: "2 Group text 1"
						}],
					filterData: [
						{
							myKey: "filterKey22",
							myText: "2 Filter text 2"
						}]
				}
			},
			bindAggregations: function(oVsdInst) {
				var template1 = new sap.m.ViewSettingsItem({
					key: "{myKey}",
					text: "{myText}"
				});
				var template2 = new sap.m.ViewSettingsItem({
					key: "{myKey}",
					text: "{myText}"
				});
				var template3 = new sap.m.ViewSettingsFilterItem({
					key: "{myKey}",
					text: "{myText}",
					items: [
						new sap.m.ViewSettingsItem({
							key: "{myItems/0/myKey}",
							text: "{myItems/0/myText}"
						})
					]
				});
				oVsdInst.bindAggregation("sortItems", "/sortData", template1);
				oVsdInst.bindAggregation("groupItems", "/groupData", template2);
				oVsdInst.bindAggregation("filterItems", "/filterData", template3);
			}
		});

		test("Reopening filter detail page of a removed detail", function (assert) {
			var delay = 1000,
				done = assert.async(),
				that = this;

			var filter = new sap.m.ViewSettingsFilterItem({
				key: "myGFilter",
				text: "Filtering",
				items: [
					new sap.m.ViewSettingsItem({
						key: "test",
						text: "2"
					})
				]
			});
			this.oVSD.addFilterItem(filter);

			this.oVSD.addFilterItem(new sap.m.ViewSettingsFilterItem({
				key: "myOtherFilter",
				text: "Other"
			}));
			this.oVSD.open();

			setTimeout(function () {
				var vsdFilterItem = that.oVSD.getFilterItems()[0];
				that.oVSD._switchToPage(3, vsdFilterItem);
				jQuery.sap.delayedCall(0, that.oVSD._getNavContainer(), "to", [ that.oVSD.getId() + '-page2', "slide" ]);
				setTimeout(function () {
					that.oVSD._dialog.getBeginButton().firePress();
					that.oVSD.removeFilterItem(vsdFilterItem);
					that.oVSD.open();
					setTimeout(function () {
						strictEqual(that.oVSD._vContentPage, 2, "Once filter details item is removed, " +
							"the filter parent page should be the current page");
						done();
					}, delay);
				}, delay);
			}, delay);
		});

		test("Reopening filter detail page after all filters are removed", function (assert) {
			var delay = 1000,
				done = assert.async(),
				that = this;

			var filter = new sap.m.ViewSettingsFilterItem({
				key: "myGFilter",
				text: "Filtering",
				items: [
					new sap.m.ViewSettingsItem({
						key: "test",
						text: "2"
					})
				]
			});
			this.oVSD.addFilterItem(filter);

			this.oVSD.addFilterItem(new sap.m.ViewSettingsFilterItem({
				key: "myOtherFilter",
				text: "Other"
			}));
			this.oVSD.open();

			setTimeout(function () {
				var vsdFilterItem = that.oVSD.getFilterItems()[0];
				that.oVSD._switchToPage(3, vsdFilterItem);
				jQuery.sap.delayedCall(0, that.oVSD._getNavContainer(), "to", [ that.oVSD.getId() + '-page2', "slide" ]);
				setTimeout(function () {
					that.oVSD._dialog.getBeginButton().firePress();
					that.oVSD.removeAllFilterItems();
					that.oVSD.open();
					setTimeout(function () {
						strictEqual(that.oVSD._vContentPage, 0, "If all filter items are removed, the first available" +
						" page should be current(in that case 'Sort/0')");
						done();
					}, delay);
				}, delay);
			}, delay);
		});



		test("Reopening filter detail page of a removed detail with model change - remove single filter", function (assert) {
			var delay = 1000,
				done = assert.async(),
				that = this;

			this.oVSD.setSortDescending(false);
			this.oVSD.setGroupDescending(true);
			var modelData = this.getFirstModelData();
			var modelData2 = this.getSecondModelData();
			var oModel = new sap.ui.model.json.JSONModel();
			oModel.setData(modelData);
			var model2 = new sap.ui.model.json.JSONModel();
			model2.setData(modelData2);
			this.oVSD.setModel(oModel);

			this.bindAggregations(this.oVSD);
			this.oVSD.open();

			setTimeout(function () {
				var vsdFilterItem = that.oVSD.getFilterItems()[0];
				that.oVSD._switchToPage(3, vsdFilterItem);
				jQuery.sap.delayedCall(0, that.oVSD._getNavContainer(), "to", [ that.oVSD.getId() + '-page2', "slide" ]);
				setTimeout(function () {
					that.oVSD._dialog.getBeginButton().firePress();
					that.oVSD.setModel(model2);
					that.oVSD.open();
					setTimeout(function () {
						strictEqual(that.oVSD._vContentPage, 2, "If no given 'filter details item' exists in a model, " +
							"the current page should be the parent filters page.");
						done();
					}, delay);
				}, delay);
			}, delay);
		});


		test("Reopening filter detail page of a removed detail with model change - remove all filters", function (assert) {
			var delay = 1000,
				done = assert.async(),
				that = this;

			this.oVSD.setSortDescending(false);
			this.oVSD.setGroupDescending(true);
			var modelData = this.getFirstModelData();
			var modelData2 = this.getSecondModelData();
			delete modelData2.filterData
			var oModel = new sap.ui.model.json.JSONModel();
			oModel.setData(modelData);
			var model2 = new sap.ui.model.json.JSONModel();
			model2.setData(modelData2);
			this.oVSD.setModel(oModel);

			this.bindAggregations(this.oVSD);
			this.oVSD.open();

			setTimeout(function () {
				var vsdFilterItem = that.oVSD.getFilterItems()[0];
				that.oVSD._switchToPage(3, vsdFilterItem);
				jQuery.sap.delayedCall(0, that.oVSD._getNavContainer(), "to", [ that.oVSD.getId() + '-page2', "slide" ]);
				setTimeout(function () {
					that.oVSD._dialog.getBeginButton().firePress();
					that.oVSD.setModel(model2);
					that.oVSD.open();
					setTimeout(function () {
						strictEqual(that.oVSD._vContentPage, 0, "If no filters item inside the new model, the first" +
							" available page should be current(in that case 'Sort/0')");
						done();
					}, delay);
				}, delay);
			}, delay);
		});

		test("Reset Button is availabe on second open of the ViewSettinsDialog", function () {
			var modelData = this.getFirstModelData();
			var modelData2 = this.getSecondModelData();
			var oModel = new sap.ui.model.json.JSONModel();
			oModel.setData(modelData);
			var model2 = new sap.ui.model.json.JSONModel();
			model2.setData(modelData2);
			this.oVSD.setModel(oModel);

			this.bindAggregations(this.oVSD);

			this.oVSD.open();
			this.oVSD._switchToPage(2);
			jQuery.sap.delayedCall(0, this.oVSD._navContainer, "to", [this.oVSD.getId() + '-page2', "show"]);
			this.oVSD._switchToPage(3,this.oVSD.getFilterItems()[0]);

			strictEqual(this.oVSD._getSubHeader().getContentRight().length, 0, "Reset Button should be removed from page1 on going to filter details view");

			this.oVSD._dialog.getBeginButton().firePress();

			this.oVSD.setModel(model2);
			this.oVSD.open();
			strictEqual(this.oVSD._getSubHeader().getContentRight().length, 1, "Reset Button should be available on page1 when the dialog is opened again");
		});
		</script>
	</head>
	<body id="body" class="sapUiBody">
		<h1 id="qunit-header">qUnit Page for sap.m.ViewSettingsDialog</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="content"></div>
		<div id="qunit-fixture"></div>
	</body>
</html>
